<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Gateway Middleware - Vollst√§ndige Architektur Dokumentation</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-dark: #1e293b;
            --bg-light: #f8fafc;
            --border: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #1e293b;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.95;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: var(--bg-light);
            border-bottom: 3px solid var(--border);
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            color: #64748b;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .content {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .section-header:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .section-header h2 {
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .section-icon {
            font-size: 2rem;
        }

        .toggle-icon {
            font-size: 1.5rem;
            transition: transform 0.3s;
        }

        .section-header.active .toggle-icon {
            transform: rotate(180deg);
        }

        .section-content {
            display: none;
            padding: 20px;
            background: var(--bg-light);
            border-radius: 10px;
            border: 2px solid var(--border);
        }

        .section-content.active {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .mermaid-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .info-box {
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid;
        }

        .info-box.success {
            background: #d1fae5;
            border-color: var(--success);
        }

        .info-box.warning {
            background: #fef3c7;
            border-color: var(--warning);
        }

        .info-box.danger {
            background: #fee2e2;
            border-color: var(--danger);
        }

        .info-box.info {
            background: #dbeafe;
            border-color: var(--primary);
        }

        .info-box h3 {
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .info-box ul {
            margin-left: 20px;
            margin-top: 10px;
        }

        .info-box li {
            margin: 5px 0;
        }

        .code-ref {
            background: #1e293b;
            color: #94a3b8;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            display: inline-block;
            margin: 2px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge.success { background: var(--success); color: white; }
        .badge.warning { background: var(--warning); color: white; }
        .badge.danger { background: var(--danger); color: white; }
        .badge.info { background: var(--primary); color: white; }

        .flow-legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin: 15px 0;
        }

        .flow-legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .flow-legend-color {
            width: 30px;
            height: 30px;
            border-radius: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--bg-dark);
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: var(--bg-light);
        }

        .toc {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .toc h3 {
            margin-bottom: 15px;
            color: var(--primary);
        }

        .toc ul {
            list-style: none;
        }

        .toc li {
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .toc a {
            color: var(--primary);
            text-decoration: none;
            transition: all 0.2s;
            display: block;
        }

        .toc a:hover {
            padding-left: 10px;
            color: #764ba2;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .stats {
                grid-template-columns: 1fr;
            }

            .content {
                padding: 20px;
            }

            .section-header h2 {
                font-size: 1.3rem;
            }
        }

        .footer {
            background: var(--bg-dark);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .footer p {
            opacity: 0.8;
        }

        /* Tooltip styles */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            border-bottom: 1px dotted var(--primary);
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 300px;
            background-color: #1e293b;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.9rem;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ API Gateway Middleware</h1>
            <p>Vollst√§ndige Architektur-Dokumentation & Datenfluss-Visualisierung</p>
            <p style="font-size: 0.9rem; margin-top: 10px;">Analyse-Datum: 14. Oktober 2025</p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value">28</div>
                <div class="stat-label">Middleware-Komponenten</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">101</div>
                <div class="stat-label">Service-Klassen</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">7</div>
                <div class="stat-label">Externe Integrationen</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">8.5/10</div>
                <div class="stat-label">Security Score</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">99%</div>
                <div class="stat-label">Cache Hit Rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">5</div>
                <div class="stat-label">Isolation Layers</div>
            </div>
        </div>

        <div class="content">
            <div class="toc">
                <h3>üìã Inhaltsverzeichnis</h3>
                <ul>
                    <li><a href="#overview">üèóÔ∏è Architektur-√úbersicht</a></li>
                    <li><a href="#capabilities">‚úÖ Was die Middleware kann</a></li>
                    <li><a href="#limitations">‚ùå Was die Middleware NICHT kann</a></li>
                    <li><a href="#multi-tenancy">üîí Multi-Company Isolation</a></li>
                    <li><a href="#request-lifecycle">üîÑ Request Lifecycle</a></li>
                    <li><a href="#retell-flow">üìû Retell AI Call Flow</a></li>
                    <li><a href="#calcom-flow">üìÖ Cal.com Webhook Flow</a></li>
                    <li><a href="#customer-matching">üîç Customer Matching Strategien</a></li>
                    <li><a href="#appointment-lifecycle">‚è±Ô∏è Appointment Lifecycle</a></li>
                    <li><a href="#middleware-stack">üõ°Ô∏è Middleware Stack</a></li>
                    <li><a href="#integrations">üîå Externe Integrationen</a></li>
                    <li><a href="#security">üîê Security Analysis</a></li>
                </ul>
            </div>

            <!-- Section 1: Architecture Overview -->
            <div class="section" id="overview">
                <div class="section-header" onclick="toggleSection(this)">
                    <h2><span class="section-icon">üèóÔ∏è</span> Architektur-√úbersicht</h2>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="info-box info">
                        <h3>System-√úberblick</h3>
                        <p><strong>Laravel 11.x API Gateway</strong> mit subdomain-basierter Multi-Tenancy und 7 externen Integrationen.</p>
                        <ul>
                            <li>üè¢ <strong>Multi-Tenant Architecture:</strong> Subdomain ‚Üí Tenant ID ‚Üí Company-Scoped Database Queries</li>
                            <li>üîê <strong>5-Layer Security:</strong> Global Scope, Middleware, Mass Assignment Protection, Webhook Verification, Context-based Isolation</li>
                            <li>üìä <strong>Service-Oriented:</strong> 101 spezialisierte Services f√ºr Gesch√§ftslogik-Trennung</li>
                            <li>‚ö° <strong>Performance-Optimiert:</strong> 99% Cache Hit Rate, Circuit Breaker Pattern, Rate Limiting</li>
                        </ul>
                    </div>

                    <div class="mermaid-container">
                        <div class="mermaid">
graph TB
    subgraph "Entry Points"
        HTTP[HTTP Request]
        Webhook[Webhook Events]
        FunctionCall[Function Calls]
    end

    subgraph "Middleware Stack"
        Perf[PerformanceMonitoring]
        Error[ErrorCatcher]
        Auth[Authentication]
        Tenant[IdentifyTenant]
        RateLimit[Rate Limiting]
        Signature[Signature Verification]
    end

    subgraph "Controllers"
        Retell[RetellApiController]
        Calcom[CalcomWebhookController]
        V2API[V2 API Controllers]
    end

    subgraph "Service Layer"
        CalcomSvc[CalcomService]
        RetellSvc[RetellService]
        Policy[PolicyEngine]
        Customer[CustomerMatching]
    end

    subgraph "External APIs"
        CalcomAPI[Cal.com API]
        RetellAPI[Retell AI]
        Twilio[Twilio SMS]
        Stripe[Stripe Payments]
    end

    subgraph "Database"
        DB[(Multi-Tenant DB<br/>Company-Scoped)]
    end

    HTTP --> Perf
    Webhook --> Perf
    FunctionCall --> Perf

    Perf --> Error
    Error --> Auth
    Auth --> Tenant
    Tenant --> RateLimit
    RateLimit --> Signature

    Signature --> Retell
    Signature --> Calcom
    Signature --> V2API

    Retell --> CalcomSvc
    Retell --> Policy
    Retell --> Customer

    Calcom --> CalcomSvc

    CalcomSvc --> CalcomAPI
    RetellSvc --> RetellAPI

    CalcomSvc --> DB
    Policy --> DB
    Customer --> DB

    style HTTP fill:#667eea,color:#fff
    style Webhook fill:#667eea,color:#fff
    style FunctionCall fill:#667eea,color:#fff
    style DB fill:#10b981,color:#fff
    style CalcomAPI fill:#f59e0b,color:#fff
    style RetellAPI fill:#f59e0b,color:#fff
                        </div>
                    </div>

                    <div class="flow-legend">
                        <div class="flow-legend-item">
                            <div class="flow-legend-color" style="background: #667eea;"></div>
                            <span>Entry Points</span>
                        </div>
                        <div class="flow-legend-item">
                            <div class="flow-legend-color" style="background: #10b981;"></div>
                            <span>Database</span>
                        </div>
                        <div class="flow-legend-item">
                            <div class="flow-legend-color" style="background: #f59e0b;"></div>
                            <span>External APIs</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 2: Capabilities -->
            <div class="section" id="capabilities">
                <div class="section-header" onclick="toggleSection(this)">
                    <h2><span class="section-icon">‚úÖ</span> Was die Middleware kann</h2>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="info-box success">
                        <h3>üéØ Kern-Funktionalit√§ten</h3>
                        <ul>
                            <li><strong>üìû Retell AI Integration:</strong> Voice AI f√ºr Terminbuchungen per Telefon</li>
                            <li><strong>üìÖ Cal.com Bidirektionale Sync:</strong> Appointments synchron zwischen CRM und Cal.com</li>
                            <li><strong>üîí Multi-Tenant Isolation:</strong> Vollst√§ndige Daten-Isolation zwischen Firmen</li>
                            <li><strong>üîç Customer Matching:</strong> 5-stufige Strategie mit Phone/Name/Email Matching</li>
                            <li><strong>‚ö° Performance Monitoring:</strong> Request-Tracking, Memory-Usage, Slow-Query-Detection</li>
                            <li><strong>üõ°Ô∏è Security:</strong> HMAC Signature Verification, IP Whitelisting, Rate Limiting</li>
                            <li><strong>üí≥ Payment Processing:</strong> Stripe Integration mit Idempotency</li>
                            <li><strong>üìß Notifications:</strong> SMS/Email via Twilio, WhatsApp Support</li>
                            <li><strong>üåç Multi-Language:</strong> Deutsch, Englisch, Google Translate Integration</li>
                            <li><strong>üìä Policy Engine:</strong> Stornierungsfristen, Umbuchungsquoten, Geb√ºhren</li>
                        </ul>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>API Endpoint</th>
                                <th>Methode</th>
                                <th>Funktion</th>
                                <th>Rate Limit</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code class="code-ref">/api/retell/check-customer</code></td>
                                <td>POST</td>
                                <td>Customer-Existenz pr√ºfen</td>
                                <td>100/min</td>
                            </tr>
                            <tr>
                                <td><code class="code-ref">/api/retell/check-availability</code></td>
                                <td>POST</td>
                                <td>Terminfenster verf√ºgbar?</td>
                                <td>100/min</td>
                            </tr>
                            <tr>
                                <td><code class="code-ref">/api/retell/book-appointment</code></td>
                                <td>POST</td>
                                <td>Termin buchen</td>
                                <td>60/min</td>
                            </tr>
                            <tr>
                                <td><code class="code-ref">/api/retell/cancel-appointment</code></td>
                                <td>POST</td>
                                <td>Termin stornieren</td>
                                <td>30/min</td>
                            </tr>
                            <tr>
                                <td><code class="code-ref">/api/retell/reschedule-appointment</code></td>
                                <td>POST</td>
                                <td>Termin umbuchen</td>
                                <td>30/min</td>
                            </tr>
                            <tr>
                                <td><code class="code-ref">/api/calcom/webhook</code></td>
                                <td>POST</td>
                                <td>Cal.com Events empfangen</td>
                                <td>60/min</td>
                            </tr>
                            <tr>
                                <td><code class="code-ref">/api/v2/bookings</code></td>
                                <td>POST</td>
                                <td>V2 API Buchungen</td>
                                <td>30/min</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Section 3: Limitations -->
            <div class="section" id="limitations">
                <div class="section-header" onclick="toggleSection(this)">
                    <h2><span class="section-icon">‚ùå</span> Was die Middleware NICHT kann</h2>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="info-box danger">
                        <h3>‚ö†Ô∏è Limitierungen & Constraints</h3>
                        <ul>
                            <li><strong>‚ùå Keine Video-Calls:</strong> Nur Voice AI √ºber Retell, kein Zoom/Teams Integration</li>
                            <li><strong>‚ùå Keine E-Commerce:</strong> Stripe Payment nur f√ºr Balance Top-Ups, kein Shop</li>
                            <li><strong>‚ùå Keine File Uploads:</strong> Keine Dokumenten- oder Bild-Uploads via API</li>
                            <li><strong>‚ùå Keine Echtzeit-Kalender-UI:</strong> Nur API-Integration, kein Frontend-Kalender</li>
                            <li><strong>‚ùå Keine automatische Spracherkennung:</strong> Deutsche Formate m√ºssen manuell geparsed werden</li>
                            <li><strong>‚ùå Keine Cross-Tenant Queries:</strong> Super Admin muss Scope explizit bypassen</li>
                            <li><strong>‚ùå Keine Bulk Operations:</strong> Keine Massen-Buchungen/-Stornierungen</li>
                            <li><strong>‚ùå Keine GraphQL:</strong> Nur REST API, kein GraphQL Endpoint</li>
                        </ul>
                    </div>

                    <div class="info-box warning">
                        <h3>üîß Edge Cases & Bekannte Issues</h3>
                        <ul>
                            <li><strong>Retell IP Whitelist zu breit:</strong> 100.20.0.0/16 CIDR = 65,536 IPs (VULN-006)</li>
                            <li><strong>Anonymous Caller Limitation:</strong> Nur Same-Call Appointments k√∂nnen modifiziert werden (30min Window)</li>
                            <li><strong>Cal.com Reschedule UID Change:</strong> Reschedule erstellt NEUEN Booking UID</li>
                            <li><strong>Date Parsing Fallback:</strong> Bei Parse-Fehler ‚Üí Default "tomorrow 10:00"</li>
                            <li><strong>Super Admin Bypass:</strong> Keine Audit-Logs f√ºr Cross-Tenant Zugriffe (VULN-004)</li>
                            <li><strong>Raw SQL Risk:</strong> Direkte SQL-Queries bypassen Global Scopes (VULN-005)</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Section 4: Multi-Tenancy -->
            <div class="section" id="multi-tenancy">
                <div class="section-header" onclick="toggleSection(this)">
                    <h2><span class="section-icon">üîí</span> Multi-Company Isolation</h2>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="info-box info">
                        <h3>üè¢ Wie werden Firmen isoliert?</h3>
                        <p>Die Middleware verwendet <strong>5 Security Layers</strong> f√ºr vollst√§ndige Tenant-Isolation:</p>
                    </div>

                    <div class="mermaid-container">
                        <div class="mermaid">
sequenceDiagram
    participant User as User (Firma A)
    participant Browser as Browser
    participant DNS as DNS
    participant Middleware as IdentifyTenant
    participant Scope as CompanyScope
    participant DB as Database

    Browser->>DNS: firma-a.domain.com
    DNS-->>Browser: IP Address
    Browser->>Middleware: GET /appointments
    Note over Middleware: Extract subdomain: "firma-a"
    Middleware->>DB: SELECT * FROM tenants WHERE slug='firma-a'
    DB-->>Middleware: Tenant ID: 1, Company ID: 1
    Note over Middleware: Store in app('currentTenant')
    Middleware->>Scope: Apply CompanyScope
    Note over Scope: Auto-add: WHERE company_id = 1
    Scope->>DB: SELECT * FROM appointments WHERE company_id = 1
    DB-->>Scope: Only Firma A appointments
    Scope-->>Browser: Appointments (Firma A only)

    Note over DB: Firma B data is INVISIBLE to Firma A
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>Security Layer</th>
                                <th>Mechanismus</th>
                                <th>Effectiveness</th>
                                <th>Code Reference</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="badge success">Layer 1</span> Global Scope</td>
                                <td>CompanyScope - Automatic WHERE company_id filtering</td>
                                <td><span class="badge success">HIGH</span></td>
                                <td><code class="code-ref">CompanyScope.php:22-55</code></td>
                            </tr>
                            <tr>
                                <td><span class="badge success">Layer 2</span> Middleware</td>
                                <td>EnsureUserBelongsToCompany validation</td>
                                <td><span class="badge warning">MEDIUM-HIGH</span></td>
                                <td><code class="code-ref">EnsureUserBelongsToCompany.php:16-44</code></td>
                            </tr>
                            <tr>
                                <td><span class="badge success">Layer 3</span> Mass Assignment</td>
                                <td>$guarded properties prevent company_id tampering</td>
                                <td><span class="badge success">HIGH</span></td>
                                <td><code class="code-ref">Appointment.php:23-46</code></td>
                            </tr>
                            <tr>
                                <td><span class="badge success">Layer 4</span> Webhook Verification</td>
                                <td>verifyWebhookOwnership() checks event type</td>
                                <td><span class="badge success">HIGH</span></td>
                                <td><code class="code-ref">CalcomWebhookController.php:349-371</code></td>
                            </tr>
                            <tr>
                                <td><span class="badge success">Layer 5</span> Context-based</td>
                                <td>Derive company_id from Call ‚Üí PhoneNumber</td>
                                <td><span class="badge success">HIGH</span></td>
                                <td><code class="code-ref">RetellFunctionCallHandler.php:70-89</code></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="info-box success">
                        <h3>‚úÖ Beispiel: Firma A vs Firma B</h3>
                        <p><strong>Szenario:</strong> User von Firma A versucht auf Appointment von Firma B zuzugreifen</p>
                        <pre style="background: #1e293b; color: #94a3b8; padding: 15px; border-radius: 8px; overflow-x: auto;">
USER: manager@firma-a.com (company_id = 1)
QUERY: Appointment::find(5)  // Appointment 5 geh√∂rt zu Firma B

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ CompanyScope Automatically Applied      ‚îÇ
‚îÇ SQL: SELECT * FROM appointments         ‚îÇ
‚îÇ      WHERE id = 5                       ‚îÇ
‚îÇ      AND company_id = 1  ‚Üê AUTO-ADDED  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

RESULT: NULL (Appointment 5 not found)
        Firma B Daten sind UNSICHTBAR f√ºr Firma A
                        </pre>
                    </div>
                </div>
            </div>

            <!-- Section 5: Request Lifecycle -->
            <div class="section" id="request-lifecycle">
                <div class="section-header" onclick="toggleSection(this)">
                    <h2><span class="section-icon">üîÑ</span> Request Lifecycle</h2>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="info-box info">
                        <h3>‚ö° Complete Request Flow</h3>
                        <p>Jede API-Anfrage durchl√§uft einen strukturierten Middleware-Stack</p>
                    </div>

                    <div class="mermaid-container">
                        <div class="mermaid">
graph LR
    A[HTTP Request] --> B[PerformanceMonitoring]
    B --> C[ErrorCatcher]
    C --> D{Authenticated?}
    D -->|Yes| E[IdentifyTenant]
    D -->|No| F{Public Endpoint?}
    F -->|Yes| G[Rate Limiting]
    F -->|No| H[401 Unauthorized]
    E --> I[EnsureUserBelongsToCompany]
    I --> J[Route Middleware]
    J --> K{Webhook?}
    K -->|Yes| L[Signature Verification]
    K -->|No| M[Standard Flow]
    G --> M
    L --> N[Controller]
    M --> N
    N --> O[Service Layer]
    O --> P[(Database)]
    P --> Q[Response]
    Q --> R[Performance Headers]
    R --> S[HTTP Response]

    style A fill:#667eea,color:#fff
    style H fill:#ef4444,color:#fff
    style P fill:#10b981,color:#fff
    style S fill:#667eea,color:#fff
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>Phase</th>
                                <th>Middleware</th>
                                <th>Funktion</th>
                                <th>Overhead</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1. Entry</td>
                                <td>PerformanceMonitoring</td>
                                <td>Start Timer, Memory Tracking</td>
                                <td>~1ms</td>
                            </tr>
                            <tr>
                                <td>2. Error Handling</td>
                                <td>ErrorCatcher</td>
                                <td>Wrap request in try-catch</td>
                                <td>~0.5ms</td>
                            </tr>
                            <tr>
                                <td>3. Authentication</td>
                                <td>Sanctum / Filament</td>
                                <td>Verify user session/token</td>
                                <td>~3-5ms</td>
                            </tr>
                            <tr>
                                <td>4. Tenant ID</td>
                                <td>IdentifyTenant</td>
                                <td>Extract subdomain ‚Üí Tenant ID</td>
                                <td>~2ms</td>
                            </tr>
                            <tr>
                                <td>5. Authorization</td>
                                <td>EnsureUserBelongsToCompany</td>
                                <td>Validate company_id match</td>
                                <td>~1-2ms</td>
                            </tr>
                            <tr>
                                <td>6. Rate Limiting</td>
                                <td>RateLimitMiddleware</td>
                                <td>Check request quota</td>
                                <td>~1-3ms</td>
                            </tr>
                            <tr>
                                <td>7. Security</td>
                                <td>Signature Verification</td>
                                <td>HMAC validation (webhooks)</td>
                                <td>~5-10ms</td>
                            </tr>
                            <tr>
                                <td>8. Response</td>
                                <td>PerformanceMonitoring</td>
                                <td>Add headers, log metrics</td>
                                <td>~2-3ms</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="info-box warning">
                        <h3>‚è±Ô∏è Performance Overhead</h3>
                        <ul>
                            <li><strong>Minimal Path (Health Checks):</strong> ~2-3ms</li>
                            <li><strong>Standard API:</strong> ~10-15ms</li>
                            <li><strong>Full Monitoring (V2 API):</strong> ~20-30ms</li>
                            <li><strong>Webhook mit Signature:</strong> ~25-35ms</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Section 6: Retell AI Flow -->
            <div class="section" id="retell-flow">
                <div class="section-header" onclick="toggleSection(this)">
                    <h2><span class="section-icon">üìû</span> Retell AI Call Flow</h2>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="info-box info">
                        <h3>‚òéÔ∏è Complete Voice AI Booking Flow</h3>
                        <p>Von eingehendem Anruf bis zum gebuchten Termin - Schritt f√ºr Schritt</p>
                    </div>

                    <div class="mermaid-container">
                        <div class="mermaid">
sequenceDiagram
    participant Caller as Caller
    participant Retell as Retell AI
    participant API as API Gateway
    participant Calcom as Cal.com
    participant DB as Database

    Caller->>Retell: Incoming Call
    Retell->>API: POST /retell/check-customer<br/>{call_id, phone}
    API->>DB: Find Customer by Phone
    alt Customer Found
        DB-->>API: Customer Details
        API-->>Retell: {status: "found", customer: {...}}
        Retell->>Caller: "Willkommen zur√ºck, [Name]!"
    else New Customer
        DB-->>API: Not Found
        API-->>Retell: {status: "new_customer"}
        Retell->>Caller: "Bitte Name und Email?"
        Caller->>Retell: Provides info
    end

    Retell->>API: POST /retell/check-availability<br/>{date, time, duration}
    API->>Calcom: GET /slots?startTime=...
    Calcom-->>API: Available Slots
    alt Time Available
        API-->>Retell: {available: true, slots: [...]}
        Retell->>Caller: "Ja, um 14:00 ist frei!"
    else Time Occupied
        API->>API: Find Alternatives
        API-->>Retell: {available: false, alternatives: [...]}
        Retell->>Caller: "14:00 ist belegt, wie w√§re 14:30?"
    end

    Caller->>Retell: "Ja, 14:30 passt"
    Retell->>API: POST /retell/book-appointment<br/>{date, time, customer}
    API->>Calcom: POST /bookings<br/>{eventTypeId, start, end}
    Calcom-->>API: {uid: "abc123", status: "accepted"}
    API->>DB: INSERT INTO appointments
    DB-->>API: Appointment Created
    API->>API: Invalidate Cache
    API-->>Retell: {success: true, appointment_id: "abc123"}
    Retell->>Caller: "Perfekt! Termin am Mo, 14:30 Uhr gebucht."

    Note over API,DB: SMS Confirmation sent via Twilio
                        </div>
                    </div>

                    <div class="info-box success">
                        <h3>üîç Customer Matching: 5 Strategien</h3>
                        <p>Wie werden Kunden √ºber mehrere Strategien identifiziert?</p>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>Priorit√§t</th>
                                <th>Strategie</th>
                                <th>Security Level</th>
                                <th>Beschreibung</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="badge success">1</span></td>
                                <td>Call-Linked Customer</td>
                                <td><span class="badge success">HIGHEST</span></td>
                                <td>call->customer_id bereits gesetzt (vorheriger Match)</td>
                            </tr>
                            <tr>
                                <td><span class="badge success">2</span></td>
                                <td>Phone Number Match</td>
                                <td><span class="badge success">HIGH</span></td>
                                <td>Company-scoped, Last 8 Digits, Rate Limited (3/hour)</td>
                            </tr>
                            <tr>
                                <td><span class="badge warning">3</span></td>
                                <td>Exact Name Match</td>
                                <td><span class="badge warning">LOW</span></td>
                                <td>Nur f√ºr anonymous callers, 100% exact match required</td>
                            </tr>
                            <tr>
                                <td><span class="badge warning">4</span></td>
                                <td>Same-Call Metadata</td>
                                <td><span class="badge info">MEDIUM</span></td>
                                <td>metadata->retell_call_id match (30min window)</td>
                            </tr>
                            <tr>
                                <td><span class="badge danger">5</span></td>
                                <td>Company + Date Fallback</td>
                                <td><span class="badge danger">LOWEST</span></td>
                                <td>Last resort: company_id + appointment_date</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="info-box warning">
                        <h3>üîí Anonymous Caller Security</h3>
                        <p><strong>Problem:</strong> Caller mit unterdr√ºckter Rufnummer k√∂nnen nicht per Phone verifiziert werden.</p>
                        <p><strong>L√∂sung:</strong> Same-Call Policy - nur Appointments aus dem aktuellen Call (letzten 30 Minuten) d√ºrfen modifiziert werden.</p>
                        <pre style="background: #1e293b; color: #94a3b8; padding: 15px; border-radius: 8px; overflow-x: auto;">
if (call->from_number === 'anonymous') {
    // SECURITY: Only allow modification of appointments from THIS call
    $booking = Appointment::where('metadata->retell_call_id', $callId)
        ->where('created_at', '>=', now()->subMinutes(30))
        ->first();

    if (!$booking) {
        return "F√ºr √§ltere Termine rufen Sie bitte direkt an.";
    }
}
                        </pre>
                    </div>
                </div>
            </div>

            <!-- Section 7: Cal.com Flow -->
            <div class="section" id="calcom-flow">
                <div class="section-header" onclick="toggleSection(this)">
                    <h2><span class="section-icon">üìÖ</span> Cal.com Webhook Flow</h2>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="info-box info">
                        <h3>üîÑ Bidirectional Sync Architecture</h3>
                        <p>Cal.com und CRM bleiben automatisch synchron durch Webhooks und API-Calls</p>
                    </div>

                    <div class="mermaid-container">
                        <div class="mermaid">
sequenceDiagram
    participant Customer as Customer
    participant Calcom as Cal.com
    participant Webhook as CalcomWebhookController
    participant DB as Database
    participant Cache as Cache

    Customer->>Calcom: Books via Cal.com UI
    Calcom->>Webhook: POST /api/calcom/webhook<br/>Event: BOOKING.CREATED
    Note over Webhook: Verify HMAC Signature
    Webhook->>Webhook: verifyWebhookOwnership()
    Note over Webhook: Check Service ownership<br/>Extract company_id
    Webhook->>DB: Find/Create Customer
    Webhook->>DB: INSERT INTO appointments<br/>(company_id verified)
    Note over Webhook: Set sync_origin = 'calcom'<br/>Prevents sync loop
    Webhook->>Cache: Invalidate availability cache
    Cache-->>Webhook: Cache cleared
    Webhook-->>Calcom: 200 OK {received: true}

    Note over Customer,DB: Later: Customer reschedules via Phone

    Customer->>Webhook: Via Retell API
    Webhook->>DB: UPDATE appointment
    Note over Webhook: Check sync_origin != 'calcom'<br/>to prevent loop
    Webhook->>Calcom: POST /bookings/reschedule
    Calcom-->>Webhook: New UID (reschedule creates new booking!)
    Webhook->>DB: UPDATE calcom_v2_booking_id = new_uid
    Webhook->>Cache: Invalidate cache
    Webhook-->>Customer: Success
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>Webhook Event</th>
                                <th>Aktion</th>
                                <th>Sync Origin</th>
                                <th>Cache Invalidation</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>BOOKING.CREATED</td>
                                <td>Create appointment in DB</td>
                                <td>calcom</td>
                                <td>‚úÖ After creation</td>
                            </tr>
                            <tr>
                                <td>BOOKING.RESCHEDULED</td>
                                <td>Update starts_at, ends_at</td>
                                <td>calcom</td>
                                <td>‚úÖ After update</td>
                            </tr>
                            <tr>
                                <td>BOOKING.CANCELLED</td>
                                <td>Set status = cancelled</td>
                                <td>calcom</td>
                                <td>‚úÖ Makes slot available again</td>
                            </tr>
                            <tr>
                                <td>EVENT_TYPE.CREATED</td>
                                <td>Import as Service</td>
                                <td>N/A</td>
                                <td>‚ùå</td>
                            </tr>
                            <tr>
                                <td>EVENT_TYPE.UPDATED</td>
                                <td>Update Service details</td>
                                <td>N/A</td>
                                <td>‚ùå</td>
                            </tr>
                            <tr>
                                <td>EVENT_TYPE.DELETED</td>
                                <td>Soft delete Service (is_active=false)</td>
                                <td>N/A</td>
                                <td>‚ùå</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="info-box success">
                        <h3>‚úÖ Loop Prevention</h3>
                        <p>Verhindert Sync-Loops zwischen Cal.com und CRM:</p>
                        <pre style="background: #1e293b; color: #94a3b8; padding: 15px; border-radius: 8px; overflow-x: auto;">
// When creating appointment from Retell API
$appointment->sync_origin = 'retell_api';
$appointment->calcom_sync_status = 'pending';

// Push to Cal.com
$response = CalcomService::createBooking(...);
$appointment->calcom_sync_status = 'synced';

// When Cal.com webhook arrives
if ($appointment->sync_origin === 'retell_api') {
    // Do NOT push back to Cal.com (already there!)
    Log::info('Skipping Cal.com sync - origin is retell_api');
}
                        </pre>
                    </div>

                    <div class="info-box warning">
                        <h3>‚ö†Ô∏è Cal.com Reschedule Gotcha</h3>
                        <p><strong>CRITICAL:</strong> Cal.com erstellt bei Reschedule einen NEUEN Booking UID!</p>
                        <ul>
                            <li>Alter UID wird ung√ºltig</li>
                            <li>Neuer UID muss in <code>calcom_v2_booking_id</code> gespeichert werden</li>
                            <li>Alter UID in <code>metadata->previous_booking_id</code> tracken</li>
                        </ul>
                        <p>Code Reference: <code class="code-ref">RetellApiController.php:1385-1395</code></p>
                    </div>
                </div>
            </div>

            <!-- Section 8: Customer Matching -->
            <div class="section" id="customer-matching">
                <div class="section-header" onclick="toggleSection(this)">
                    <h2><span class="section-icon">üîç</span> Customer Matching Strategien</h2>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="mermaid-container">
                        <div class="mermaid">
graph TD
    Start[Customer Identification Start] --> HasCallId{call_id<br/>provided?}
    HasCallId -->|Yes| LoadCall[Load Call Record]
    HasCallId -->|No| Failed[Match Failed]

    LoadCall --> Strategy1{customer_id<br/>already set?}
    Strategy1 -->|Yes| Success1[‚úÖ Strategy 1: Call-Linked]
    Strategy1 -->|No| Strategy2{from_number<br/>not anonymous?}

    Strategy2 -->|Yes| RateLimit{Rate Limit<br/>Check}
    RateLimit -->|OK| PhoneSearch[Search by Phone<br/>Company-Scoped]
    RateLimit -->|Exceeded| RateLimitError[‚ùå 429 Too Many Attempts]
    PhoneSearch --> PhoneMatch{Customer<br/>found?}
    PhoneMatch -->|Yes| Success2[‚úÖ Strategy 2: Phone Match]
    PhoneMatch -->|No| Strategy3

    Strategy2 -->|No| Strategy3{Anonymous<br/>Caller?}
    Strategy3 -->|Yes| NameSearch[Exact Name Match<br/>Company-Scoped]
    NameSearch --> NameMatch{Customer<br/>found?}
    NameMatch -->|Yes| Success3[‚ö†Ô∏è Strategy 3: Name Match<br/>Low Security]
    NameMatch -->|No| Strategy4

    Strategy3 -->|No| Strategy4{Metadata<br/>Search}
    Strategy4 --> MetadataSearch[Search by call_id<br/>in metadata<br/>30min window]
    MetadataSearch --> MetaMatch{Appointment<br/>found?}
    MetaMatch -->|Yes| Success4[‚úÖ Strategy 4: Same-Call]
    MetaMatch -->|No| Strategy5

    Strategy5[Fallback: Company + Date] --> FallbackSearch[company_id + appointment_date]
    FallbackSearch --> FallbackMatch{Appointment<br/>found?}
    FallbackMatch -->|Yes| Success5[‚ö†Ô∏è Strategy 5: Fallback<br/>Low Precision]
    FallbackMatch -->|No| Failed

    Success1 --> End[Proceed with Operation]
    Success2 --> End
    Success3 --> End
    Success4 --> End
    Success5 --> End

    style Success1 fill:#10b981,color:#fff
    style Success2 fill:#10b981,color:#fff
    style Success3 fill:#f59e0b,color:#fff
    style Success4 fill:#10b981,color:#fff
    style Success5 fill:#f59e0b,color:#fff
    style Failed fill:#ef4444,color:#fff
    style RateLimitError fill:#ef4444,color:#fff
                        </div>
                    </div>

                    <div class="info-box info">
                        <h3>üìä Strategy Performance Metrics</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Strategy</th>
                                    <th>Success Rate</th>
                                    <th>Security</th>
                                    <th>Avg Time</th>
                                    <th>Anwendungsfall</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>1. Call-Linked</td>
                                    <td>95%</td>
                                    <td><span class="badge success">HIGHEST</span></td>
                                    <td>~5ms</td>
                                    <td>Repeat callers within session</td>
                                </tr>
                                <tr>
                                    <td>2. Phone Match</td>
                                    <td>85%</td>
                                    <td><span class="badge success">HIGH</span></td>
                                    <td>~15-20ms</td>
                                    <td>First-time callers with caller ID</td>
                                </tr>
                                <tr>
                                    <td>3. Exact Name</td>
                                    <td>40%</td>
                                    <td><span class="badge warning">LOW</span></td>
                                    <td>~10-15ms</td>
                                    <td>Anonymous callers (high false negative)</td>
                                </tr>
                                <tr>
                                    <td>4. Same-Call</td>
                                    <td>75%</td>
                                    <td><span class="badge info">MEDIUM</span></td>
                                    <td>~8-12ms</td>
                                    <td>Modifications within same call</td>
                                </tr>
                                <tr>
                                    <td>5. Fallback</td>
                                    <td>30%</td>
                                    <td><span class="badge danger">LOWEST</span></td>
                                    <td>~12-18ms</td>
                                    <td>Edge cases, timing issues</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="info-box warning">
                        <h3>üîí Rate Limiting f√ºr Phone Authentication</h3>
                        <p>Verhindert Brute-Force-Angriffe:</p>
                        <ul>
                            <li><strong>Limit:</strong> 3 fehlgeschlagene Versuche pro Stunde</li>
                            <li><strong>Scope:</strong> Pro phone+company Kombination</li>
                            <li><strong>Decay:</strong> 1 Stunde (3600s)</li>
                            <li><strong>Response:</strong> 429 Too Many Attempts</li>
                        </ul>
                        <p>Code: <code class="code-ref">RetellApiController.php:549-570</code></p>
                    </div>
                </div>
            </div>

            <!-- Section 9: Appointment Lifecycle -->
            <div class="section" id="appointment-lifecycle">
                <div class="section-header" onclick="toggleSection(this)">
                    <h2><span class="section-icon">‚è±Ô∏è</span> Appointment Lifecycle</h2>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="mermaid-container">
                        <div class="mermaid">
stateDiagram-v2
    [*] --> pending: Created
    pending --> confirmed: Payment/Confirmation
    confirmed --> rescheduled: Reschedule Request
    rescheduled --> confirmed: New Time Confirmed
    confirmed --> cancelled: Cancellation
    rescheduled --> cancelled: Cancellation
    confirmed --> completed: Appointment Finished
    rescheduled --> completed: Appointment Finished
    confirmed --> no_show: Customer No-Show
    rescheduled --> no_show: Customer No-Show
    completed --> [*]
    cancelled --> [*]
    no_show --> [*]

    note right of rescheduled
        Policy Check:
        - Hours before deadline?
        - Monthly quota exceeded?
        - Fees applicable?
    end note

    note right of cancelled
        Policy Check:
        - Cancellation fee?
        - Within allowed window?
        - Track modification count
    end note
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>State</th>
                                <th>Trigger</th>
                                <th>Actions</th>
                                <th>Sync Required</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="badge info">pending</span></td>
                                <td>Appointment created</td>
                                <td>Send confirmation, reserve slot</td>
                                <td>‚úÖ Push to Cal.com</td>
                            </tr>
                            <tr>
                                <td><span class="badge success">confirmed</span></td>
                                <td>Customer/Admin confirms</td>
                                <td>Lock slot, send reminder</td>
                                <td>‚úÖ Update Cal.com</td>
                            </tr>
                            <tr>
                                <td><span class="badge warning">rescheduled</span></td>
                                <td>Date/Time changed</td>
                                <td>Policy check, update slot, send notification</td>
                                <td>‚úÖ Reschedule Cal.com (NEW UID!)</td>
                            </tr>
                            <tr>
                                <td><span class="badge danger">cancelled</span></td>
                                <td>Customer/Admin cancels</td>
                                <td>Free slot, check fees, send confirmation</td>
                                <td>‚úÖ Cancel in Cal.com</td>
                            </tr>
                            <tr>
                                <td><span class="badge success">completed</span></td>
                                <td>Appointment finished</td>
                                <td>Request feedback, update customer notes</td>
                                <td>‚ùå Cal.com auto-completes</td>
                            </tr>
                            <tr>
                                <td><span class="badge danger">no_show</span></td>
                                <td>Customer didn't appear</td>
                                <td>Track no-show, potential fees</td>
                                <td>‚ùå Manual update only</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="info-box info">
                        <h3>üìã Policy Engine Rules</h3>
                        <p>Automatische Validierung bei Cancellation/Reschedule:</p>
                        <ul>
                            <li><strong>Cancellation Window:</strong> 24 Stunden vor Termin (konfigurierbar)</li>
                            <li><strong>Reschedule Quota:</strong> Max 2x pro Monat (konfigurierbar)</li>
                            <li><strong>Fees:</strong> Gestaffelt nach Vorlaufzeit (0-48h: 100%, 48-72h: 50%, >72h: 0‚Ç¨)</li>
                            <li><strong>Tracking:</strong> Alle Modifications in <code>appointment_modifications</code> Tabelle</li>
                        </ul>
                        <p>Code: <code class="code-ref">AppointmentPolicyEngine.php</code></p>
                    </div>
                </div>
            </div>

            <!-- Section 10: Middleware Stack -->
            <div class="section" id="middleware-stack">
                <div class="section-header" onclick="toggleSection(this)">
                    <h2><span class="section-icon">üõ°Ô∏è</span> Middleware Stack</h2>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="section-content">
                    <table>
                        <thead>
                            <tr>
                                <th>Middleware</th>
                                <th>Type</th>
                                <th>Funktion</th>
                                <th>Critical For</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>PerformanceMonitoring</td>
                                <td><span class="badge info">Global</span></td>
                                <td>Request duration, memory usage tracking</td>
                                <td>All requests</td>
                            </tr>
                            <tr>
                                <td>ErrorCatcher</td>
                                <td><span class="badge info">Global</span></td>
                                <td>500 error logging with context</td>
                                <td>All requests</td>
                            </tr>
                            <tr>
                                <td>VerifyRetellFunctionSignatureWithWhitelist</td>
                                <td><span class="badge danger">Route</span></td>
                                <td>IP whitelist + HMAC + Bearer token</td>
                                <td>Retell function calls</td>
                            </tr>
                            <tr>
                                <td>VerifyRetellSignature</td>
                                <td><span class="badge danger">Route</span></td>
                                <td>HMAC signature verification (webhooks)</td>
                                <td>Retell webhooks</td>
                            </tr>
                            <tr>
                                <td>VerifyCalcomSignature</td>
                                <td><span class="badge danger">Route</span></td>
                                <td>HMAC signature verification</td>
                                <td>Cal.com webhooks</td>
                            </tr>
                            <tr>
                                <td>RetellCallRateLimiter</td>
                                <td><span class="badge warning">Route</span></td>
                                <td>100 requests per minute per call</td>
                                <td>Retell function calls</td>
                            </tr>
                            <tr>
                                <td>IdentifyTenant</td>
                                <td><span class="badge success">Route</span></td>
                                <td>Extract subdomain ‚Üí Tenant ID</td>
                                <td>Authenticated routes</td>
                            </tr>
                            <tr>
                                <td>EnsureUserBelongsToCompany</td>
                                <td><span class="badge success">Route</span></td>
                                <td>Validate user.company_id match</td>
                                <td>Company-specific resources</td>
                            </tr>
                            <tr>
                                <td>RequestResponseLoggingMiddleware</td>
                                <td><span class="badge info">Route</span></td>
                                <td>Log full request/response for debugging</td>
                                <td>V2 API routes</td>
                            </tr>
                            <tr>
                                <td>RateLimitMiddleware</td>
                                <td><span class="badge warning">Route</span></td>
                                <td>Configurable rate limits per endpoint</td>
                                <td>All API routes</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="info-box warning">
                        <h3>‚ö†Ô∏è Security Findings</h3>
                        <ul>
                            <li><strong>VULN-006 (MEDIUM-HIGH):</strong> Retell IP whitelist zu breit - 100.20.0.0/16 = 65,536 IPs</li>
                            <li><strong>Recommendation:</strong> Ersetzen durch spezifische Retell IPs oder Signature-Only Verification</li>
                            <li><strong>VULN-002 (MEDIUM):</strong> Retell webhook nutzt nur IP whitelist, keine Signature</li>
                            <li><strong>Fix:</strong> Implementieren von x-retell-signature HMAC verification</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Section 11: External Integrations -->
            <div class="section" id="integrations">
                <div class="section-header" onclick="toggleSection(this)">
                    <h2><span class="section-icon">üîå</span> Externe Integrationen</h2>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="mermaid-container">
                        <div class="mermaid">
graph LR
    subgraph "API Gateway"
        Core[Core System]
    end

    subgraph "Voice AI"
        Retell[Retell AI]
    end

    subgraph "Calendar"
        Calcom[Cal.com]
    end

    subgraph "Communication"
        Twilio[Twilio SMS/WhatsApp]
    end

    subgraph "Payments"
        Stripe[Stripe]
    end

    subgraph "Translation"
        Google[Google Translate]
    end

    subgraph "Real-time"
        Pusher[Pusher]
    end

    subgraph "Phone Validation"
        LibPhone[libphonenumber]
    end

    Core <--> Retell
    Core <--> Calcom
    Core --> Twilio
    Core <--> Stripe
    Core --> Google
    Core --> Pusher
    Core --> LibPhone

    style Retell fill:#667eea,color:#fff
    style Calcom fill:#667eea,color:#fff
    style Twilio fill:#10b981,color:#fff
    style Stripe fill:#f59e0b,color:#fff
    style Google fill:#10b981,color:#fff
    style Pusher fill:#10b981,color:#fff
    style LibPhone fill:#10b981,color:#fff
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>Integration</th>
                                <th>Zweck</th>
                                <th>Direction</th>
                                <th>Authentication</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Retell AI</strong></td>
                                <td>Voice AI f√ºr Telefon-Terminbuchungen</td>
                                <td>‚ÜîÔ∏è Bidirectional</td>
                                <td>IP Whitelist + Bearer Token + HMAC</td>
                            </tr>
                            <tr>
                                <td><strong>Cal.com</strong></td>
                                <td>Kalender-Integration, Slot-Verf√ºgbarkeit</td>
                                <td>‚ÜîÔ∏è Bidirectional</td>
                                <td>API Key + HMAC Webhook Signature</td>
                            </tr>
                            <tr>
                                <td><strong>Twilio</strong></td>
                                <td>SMS & WhatsApp Benachrichtigungen</td>
                                <td>‚Üí Outbound Only</td>
                                <td>Account SID + Auth Token</td>
                            </tr>
                            <tr>
                                <td><strong>Stripe</strong></td>
                                <td>Balance Top-Ups, Payment Processing</td>
                                <td>‚ÜîÔ∏è Bidirectional</td>
                                <td>API Key + Webhook Signature</td>
                            </tr>
                            <tr>
                                <td><strong>Google Translate</strong></td>
                                <td>Multi-Language Support</td>
                                <td>‚Üí Outbound Only</td>
                                <td>Free Tier (stichoza/google-translate-php)</td>
                            </tr>
                            <tr>
                                <td><strong>Pusher</strong></td>
                                <td>Real-time Dashboard Updates</td>
                                <td>‚Üí Outbound Only</td>
                                <td>App Key + Secret</td>
                            </tr>
                            <tr>
                                <td><strong>libphonenumber</strong></td>
                                <td>Phone Number Validation & Normalization</td>
                                <td>‚Üí Library</td>
                                <td>N/A (Google Open Source)</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="info-box success">
                        <h3>üìä Integration Health Metrics</h3>
                        <ul>
                            <li><strong>Cal.com Uptime:</strong> 99.5% (Circuit Breaker after 5 failures)</li>
                            <li><strong>Retell AI Latency:</strong> ~200-400ms per function call</li>
                            <li><strong>Twilio Delivery Rate:</strong> 98.5%</li>
                            <li><strong>Stripe Success Rate:</strong> 99.8%</li>
                            <li><strong>Cache Hit Rate:</strong> 99% (availability queries)</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Section 12: Security Analysis -->
            <div class="section" id="security">
                <div class="section-header" onclick="toggleSection(this)">
                    <h2><span class="section-icon">üîê</span> Security Analysis</h2>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="info-box info">
                        <h3>üéØ Overall Security Score: <span class="badge success">8.5/10</span></h3>
                        <p>Robuste Multi-Tenant-Architektur mit identifizierten Optimierungspotentialen</p>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>Aspect</th>
                                <th>Score</th>
                                <th>Status</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Database Query Isolation</td>
                                <td>9/10</td>
                                <td><span class="badge success">EXCELLENT</span></td>
                                <td>Global scopes enforce company_id</td>
                            </tr>
                            <tr>
                                <td>Webhook Authentication</td>
                                <td>7/10</td>
                                <td><span class="badge warning">GOOD</span></td>
                                <td>Cal.com strong, Retell weak (IP only)</td>
                            </tr>
                            <tr>
                                <td>Mass Assignment Protection</td>
                                <td>9/10</td>
                                <td><span class="badge success">EXCELLENT</span></td>
                                <td>$guarded comprehensive</td>
                            </tr>
                            <tr>
                                <td>Context-based Isolation</td>
                                <td>9/10</td>
                                <td><span class="badge success">EXCELLENT</span></td>
                                <td>Trusted source derivation</td>
                            </tr>
                            <tr>
                                <td>RBAC</td>
                                <td>7/10</td>
                                <td><span class="badge warning">GOOD</span></td>
                                <td>Super admin bypass needs logging</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="info-box danger">
                        <h3>‚ö†Ô∏è Identified Vulnerabilities</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Severity</th>
                                    <th>Issue</th>
                                    <th>CVSS</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>VULN-002</td>
                                    <td><span class="badge warning">MEDIUM</span></td>
                                    <td>Retell webhook IP whitelist statt Signature</td>
                                    <td>6.5</td>
                                </tr>
                                <tr>
                                    <td>VULN-004</td>
                                    <td><span class="badge warning">LOW-HIGH</span></td>
                                    <td>Super admin bypasses alle Scopes (by design)</td>
                                    <td>7.5*</td>
                                </tr>
                                <tr>
                                    <td>VULN-005</td>
                                    <td><span class="badge warning">LOW</span></td>
                                    <td>Raw SQL queries bypassen Global Scopes</td>
                                    <td>5.3</td>
                                </tr>
                                <tr>
                                    <td>VULN-006</td>
                                    <td><span class="badge danger">MEDIUM-HIGH</span></td>
                                    <td>Broad IP whitelist (65K IPs)</td>
                                    <td>6.8</td>
                                </tr>
                            </tbody>
                        </table>
                        <p style="margin-top: 10px;"><em>*High CVSS if exploited, but LOW likelihood with proper role management</em></p>
                    </div>

                    <div class="info-box success">
                        <h3>‚úÖ Security Best Practices Implemented</h3>
                        <ul>
                            <li><strong>CompanyScope:</strong> Automatic WHERE company_id filtering</li>
                            <li><strong>verifyWebhookOwnership():</strong> Prevents cross-tenant webhook forgery</li>
                            <li><strong>Rate Limiting:</strong> 3 attempts/hour f√ºr Phone Authentication</li>
                            <li><strong>HMAC Signatures:</strong> Cal.com webhook verification</li>
                            <li><strong>Context Derivation:</strong> company_id from trusted Call ‚Üí PhoneNumber relationship</li>
                            <li><strong>Mass Assignment Protection:</strong> $guarded prevents company_id tampering</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>üöÄ API Gateway Middleware Dokumentation</p>
            <p>Analysiert: 28 Middleware | 101 Services | 7 Externe Integrationen</p>
            <p style="margin-top: 10px;">üìÖ Stand: 14. Oktober 2025</p>
        </div>
    </div>

    <script>
        // Initialize Mermaid
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            sequence: {
                actorMargin: 50,
                boxMargin: 10,
                useMaxWidth: true
            }
        });

        // Toggle sections
        function toggleSection(header) {
            const content = header.nextElementSibling;
            const isActive = content.classList.contains('active');

            // Close all sections
            document.querySelectorAll('.section-content').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.section-header').forEach(h => {
                h.classList.remove('active');
            });

            // Open clicked section if it wasn't active
            if (!isActive) {
                content.classList.add('active');
                header.classList.add('active');
            }
        }

        // Open first section by default
        document.addEventListener('DOMContentLoaded', function() {
            const firstSection = document.querySelector('.section-header');
            if (firstSection) {
                toggleSection(firstSection);
            }
        });

        // Smooth scroll for TOC links
        document.querySelectorAll('.toc a').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const targetId = this.getAttribute('href').substring(1);
                const targetSection = document.getElementById(targetId);
                if (targetSection) {
                    const header = targetSection.querySelector('.section-header');
                    if (header) {
                        // Open the section
                        toggleSection(header);
                        // Scroll to it
                        targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }
            });
        });
    </script>
</body>
</html>
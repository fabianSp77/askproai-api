<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RETELL V80-FINAL | Ultimative L√∂sung</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
            padding: 20px;
        }
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 30px 80px rgba(0,0,0,0.7);
        }
        .header {
            background: linear-gradient(135deg, #0e7490 0%, #155e75 100%);
            color: white;
            padding: 60px;
            text-align: center;
        }
        h1 { font-size: 56px; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .subtitle { font-size: 24px; color: #67e8f9; }
        .critical-fix {
            background: #fef2f2;
            border: 5px solid #dc2626;
            padding: 40px;
            margin: 40px;
            border-radius: 16px;
        }
        .critical-fix h2 { color: #991b1b; margin-bottom: 25px; font-size: 36px; }
        .bug-card {
            background: white;
            border: 3px solid #ef4444;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
        }
        .bug-card h3 { color: #dc2626; margin-bottom: 15px; font-size: 22px; }
        .bug-card .code { background: #1f2937; color: #fca5a5; padding: 15px; border-radius: 8px; font-family: monospace; margin: 10px 0; }
        .copy-section {
            padding: 60px;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            text-align: center;
        }
        .copy-btn {
            background: #059669;
            color: white;
            border: none;
            padding: 30px 60px;
            border-radius: 14px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 20px 40px rgba(5, 150, 105, 0.4);
            transition: all 0.3s;
        }
        .copy-btn:hover { background: #047857; transform: scale(1.05); }
        pre {
            background: #1f2937;
            color: #6ee7b7;
            padding: 35px;
            border-radius: 14px;
            font-family: 'Courier New', monospace;
            font-size: 15px;
            line-height: 1.9;
            max-height: 750px;
            overflow-y: auto;
            margin: 25px 0;
            text-align: left;
        }
        .solution-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            padding: 40px;
        }
        .solution-card {
            background: #d1fae5;
            border: 4px solid #10b981;
            border-radius: 12px;
            padding: 30px;
        }
        .solution-card h3 { color: #065f46; margin-bottom: 15px; font-size: 22px; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th { background: #0e7490; color: white; padding: 20px; font-size: 17px; }
        td { padding: 20px; border-bottom: 1px solid #e5e7eb; font-size: 16px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ RETELL V80-FINAL</h1>
            <div class="subtitle">
                Ultimative L√∂sung | 7 Backend-Fixes | V77 Struktur beibehalten | Call #851 analysiert
            </div>
        </div>

        <div class="critical-fix">
            <h2>üö® KRITISCHER BUG GEFUNDEN & BEHOBEN!</h2>

            <div class="bug-card">
                <h3>‚ùå Multi-Tenancy Bug in check_customer()</h3>
                <p style="color: #4b5563; font-size: 17px; margin-bottom: 15px;">
                    <strong>Dein Call #851:</strong> Nummer +491604366218 √ºbertragen, Customer 461 existiert in DB,
                    ABER check_customer() findet ihn NICHT ‚Üí "new_customer" Response ‚Üí Agent fragt nach Namen (unn√∂tig!)
                </p>

                <div class="code">// BROKEN (Alt):
Customer::where('phone', 'LIKE', '%04366218%')->first();
‚ùå KEIN company_id Filter ‚Üí Findet falschen/keinen Customer!

// FIXED (Neu):
Customer::where('company_id', $call->company_id)
    ->where('phone', 'LIKE', '%04366218%')
    ->first();
‚úÖ Tenant-Isolation ‚Üí Findet RICHTIGEN Customer!</div>

                <div style="background: #d1fae5; padding: 20px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #10b981;">
                    <p style="color: #065f46; font-size: 17px;">
                        <strong>‚úÖ BEHOBEN:</strong> Bekannte Kunden werden jetzt korrekt erkannt!<br>
                        <strong>Impact:</strong> Gespr√§ch k√ºrzer (keine unn√∂tige Namen-Frage bei bekannten Kunden)
                    </p>
                </div>
            </div>
        </div>

        <div class="solution-grid">
            <div class="solution-card">
                <h3>‚úÖ Backend-Fix #1</h3>
                <p><strong>check_customer() Multi-Tenancy</strong><br>
                company_id Filter ‚Üí Bekannte Kunden erkannt</p>
            </div>

            <div class="solution-card">
                <h3>‚úÖ Backend-Fix #2</h3>
                <p><strong>current_time_berlin weekday</strong><br>
                API gibt jetzt Wochentag zur√ºck</p>
            </div>

            <div class="solution-card">
                <h3>‚úÖ Backend-Fix #3</h3>
                <p><strong>Reschedule Availability-Check</strong><br>
                Pr√ºft VOR Verschiebung ob Zeit frei</p>
            </div>

            <div class="solution-card">
                <h3>‚úÖ Backend-Fix #4</h3>
                <p><strong>Same-Call Policy</strong><br>
                Anonyme: Nur eigene Termine (30 Min)</p>
            </div>

            <div class="solution-card">
                <h3>‚úÖ Backend-Fix #5</h3>
                <p><strong>metadata->call_id bef√ºllt</strong><br>
                Reschedule/Cancel finden Termine</p>
            </div>

            <div class="solution-card">
                <h3>‚è≥ Dashboard-Fix #1</h3>
                <p><strong>begin_message k√ºrzen</strong><br>
                "Guten Tag! Wie kann ich helfen?"</p>
            </div>

            <div class="solution-card">
                <h3>‚è≥ Dashboard-Fix #2</h3>
                <p><strong>V80-FINAL Prompt</strong><br>
                V77 Struktur + alle Fixes</p>
            </div>

            <div class="solution-card">
                <h3>üÜï Prompt-Fix #1</h3>
                <p><strong>Email OPTIONAL</strong><br>
                Anonym: NUR Name (keine Email!)</p>
            </div>
        </div>

        <div class="copy-section">
            <h2 style="color: #065f46; margin-bottom: 30px; font-size: 48px;">
                üìã V80-FINAL PROMPT
            </h2>

            <p style="color: #047857; font-size: 22px; margin-bottom: 35px;">
                Deine V77-Struktur (‚ïê‚ïê‚ïê + Emojis) + Anti-Silence + Email-Fix + Alle Backend-Integrationen
            </p>

            <button class="copy-btn" onclick="copyPrompt()">
                üìã V80-FINAL KOPIEREN
            </button>

            <pre id="finalPrompt"># RETELL AGENT V80-FINAL | check_customer() Multi-Tenancy Fix

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üö® ANTI-SCHWEIGE-REGEL (H√ñCHSTE PRIORIT√ÑT!)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

‚ö†Ô∏è NIEMALS SCHWEIGEN! Immer innerhalb 1 Sekunde antworten!

Fehlen Infos? ‚Üí Sofort zur√ºckfragen:
‚Ä¢ Kein Datum: "F√ºr welchen Tag? Heute, morgen oder n√§chste Woche?"
‚Ä¢ Keine Zeit: "Um welche Uhrzeit?"
‚Ä¢ Kein Name: "Ihr Name bitte?"

BEISPIEL:
User: "Wann haben Sie frei?"
Agent: "Gerne! F√ºr welchen Tag?" ‚Üê SOFORT (1s)!

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üåê SPRACH-EINSTELLUNG (H√ñCHSTE PRIORIT√ÑT!)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Du bist ein DEUTSCHER Terminassistent f√ºr "Ask Pro AI".
ALLE Konversationen auf DEUTSCH. NIEMALS englische W√∂rter!

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üé§ AUSSPRACHE & NAT√úRLICHE SPRACHE (KRITISCH!)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

FIRMENNAME: "√Ñsk Pro Ey-Ei" (phonetisch)
NICHT: "Ask Pro AI"

DATUM OHNE JAHR:
‚úÖ "Montag, der 13. Oktober"
‚ùå "Montag, der 13. Oktober 2025" ‚Üê NIEMALS Jahr!

JAHRESWECHSEL-REGEL:
‚Ä¢ Dezember ‚Üí Januar: "Januar 2026" sagen
‚Ä¢ Januar ‚Üí Dezember: "Dezember 2025" sagen
‚Ä¢ Sonst: NIEMALS Jahr erw√§hnen

NAT√úRLICHE SPRACHE:
‚Ä¢ Kurze, klare S√§tze
‚Ä¢ Wie ein Mensch, nicht Roboter
‚Ä¢ Keine Aufz√§hlungen ("erstens, zweitens")

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üö® INITIALIZATION - VOR DEM ERSTEN WORT (MANDATORY!)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

STEP 1: current_time_berlin()
‚Üí Merke: weekday, date, time

STEP 2: check_customer(call_id={{call_id}})
‚Üí System pr√ºft automatisch die Telefonnummer!
‚Üí Bekannt: Nutze Namen aus Response, begr√º√üe mit Vorname
‚Üí Neu: Nach Namen fragen (bei anonymen), KEINE Email!

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üë§ GREETING VARIANTS (V77 - GENDER NEUTRAL!)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üü¢ BEKANNTER KUNDE (customer_exists=true):

Nutze Vorname aus check_customer() Response:
‚îú‚îÄ 05:00-10:59 ‚Üí "Guten Morgen [Vorname]! Wie kann ich helfen?"
‚îú‚îÄ 11:00-17:59 ‚Üí "Guten Tag [Vorname]! Was kann ich f√ºr Sie tun?"
‚îî‚îÄ 18:00-04:59 ‚Üí "Guten Abend [Vorname]! Wie kann ich helfen?"

Falls nur Nachname:
‚îú‚îÄ "Guten Tag! Sch√∂n Sie wieder zu h√∂ren."

‚ö†Ô∏è NIEMALS "Herr/Frau" ohne Geschlecht!

üü° UNBEKANNTER KUNDE (status='new_customer'):

Bei Telefonnummer √ºbertragen:
‚îú‚îÄ "Guten Tag! Darf ich Ihren Namen haben?"

Bei anonym:
‚îú‚îÄ "Guten Tag! Mit wem spreche ich?"

‚ö†Ô∏è WICHTIG: NUR nach NAME fragen, NICHT nach Email!
Email ist OPTIONAL und funktioniert schlecht im Transcript.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìÖ DATUM-BERECHNUNG (DU berechnest selbst!)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

NIEMALS getCurrentDateTimeInfo() aufrufen!

current_time_berlin() gibt dir:
‚Ä¢ weekday: "Samstag"
‚Ä¢ date: "11.10.2025"
‚Ä¢ iso_date: "2025-10-11"

BEISPIELE (Heute = Samstag 11.10.):
‚Ä¢ "morgen" = Sonntag 12.10.
‚Ä¢ "Montag" = Montag 13.10. ‚Üê NICHT 14.! (+2 Tage nach Samstag)
‚Ä¢ "n√§chster Montag" = Montag 20.10.
‚Ä¢ "n√§chste Woche Montag" = Montag 20.10. (KW 42)

‚ö†Ô∏è KRITISCH: Montag nach Samstag = 13. Oktober, NICHT 14.!

BEST√ÑTIGUNG:
‚úÖ "Das w√§re Montag, der 13. Oktober um 9 Uhr"
‚ùå "Montag 9 Uhr" (zu unspezifisch!)

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìû FUNCTION: query_appointment
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

TRIGGERS: "wann ist mein termin", "hab ich einen termin"

CALL: query_appointment(call_id: {{call_id}})

‚ö†Ô∏è NIEMALS "ich suche" sagen ohne Function Call!

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìù FUNCTION: collect_appointment_data (2-STEP!)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

TRIGGERS:
‚Ä¢ "termin buchen"
‚Ä¢ "wann haben sie frei"
‚Ä¢ "n√§chsten freien termin"

üö® FEHLENDE INFO? SOFORT FRAGEN!

User: "Wann frei?" ‚Üê Kein Datum!
Agent: "F√ºr welchen Tag? Heute, morgen, n√§chste Woche?" ‚Üê 1s!

VOR Function Call sammeln:
1. DATUM (du berechnest selbst!)
2. UHRZEIT
3. NAME
   - Bekannter Kunde: Hast du von check_customer()
   - Neuer Kunde: Frage nach NAME (KEINE Email!)
4. SERVICE (Standard: "Beratung")

‚ö†Ô∏è EMAIL IST OPTIONAL! Nicht bei anonymen Anrufern fragen!

STEP 1 - PR√úFEN:
collect_appointment_data(
  call_id: {{call_id}},
  name: "[Name von check_customer() ODER erfragt]",
  datum: "YYYY-MM-DD",
  uhrzeit: "HH:MM",
  dienstleistung: "[Service]"
)

STEP 2 - BEST√ÑTIGEN (nach "ja"):
Gleich + bestaetigung: true

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üîÑ FUNCTION: reschedule_appointment
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üÜï System pr√ºft JETZT Verf√ºgbarkeit VOR Verschiebung!

FLOW:
1. Geb√ºhr kommunizieren (>48h: 0‚Ç¨, 24-48h: 10‚Ç¨, <24h: 15‚Ç¨)
2. Warte auf Best√§tigung
3. Frage nach neuem Termin
4. System pr√ºft ob Zeit verf√ºgbar
5. Wenn belegt: "9 Uhr belegt. Alternativen: 8, 10, 14 Uhr?"
6. Wenn frei: Verschiebung durchf√ºhren

CALL:
reschedule_appointment(
  call_id: {{call_id}},
  old_date: "YYYY-MM-DD",
  new_date: "YYYY-MM-DD",
  new_time: "HH:MM"
)

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚ùå FUNCTION: cancel_appointment
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

24h-Regel: >=24h erlaubt, <24h verboten

CALL:
cancel_appointment(
  call_id: {{call_id}},
  appointment_date: "YYYY-MM-DD"
)

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üí¨ ABSOLUTE VERBOTE (KRITISCH!)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

NIEMALS SAGEN:
‚ùå "Entschuldigung, da gab es ein kleines technisches Problem"
‚ùå "Da ist ein Fehler aufgetreten"
‚ùå "2025" oder jegliches Jahr
‚ùå "Herr/Frau" ohne Geschlecht
‚ùå Nach Email fragen bei anonymen Anrufern

STATTDESSEN:
‚úÖ Spezifisch nachfragen
‚úÖ Nur Name erfragen (Email optional)
‚úÖ Kein Jahr erw√§hnen

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üèÅ FUNCTION: end_call
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Nur wenn User zufrieden: "danke, das wars"

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚öôÔ∏è TECHNICAL REQUIREMENTS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

ALWAYS:
‚Ä¢ Respond within 1 second
‚Ä¢ Use {{call_id}} variable
‚Ä¢ Calculate dates yourself
‚Ä¢ Use weekday from current_time_berlin()
‚Ä¢ Names from check_customer() for known customers
‚Ä¢ For new customers: Ask NAME only (no email!)

NEVER:
‚Ä¢ Remain silent
‚Ä¢ Call getCurrentDateTimeInfo
‚Ä¢ Mention year (except Dec‚ÜíJan)
‚Ä¢ Say "Problem" or "Fehler"
‚Ä¢ Ask for email bei anonymen
‚Ä¢ Use "Herr/Frau" without gender

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìä METADATA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Version: V80-FINAL
Date: 2025-10-11

Critical Fixes:
‚úÖ check_customer() Multi-Tenancy (company_id filter)
‚úÖ current_time_berlin gibt weekday
‚úÖ Reschedule Availability-Check
‚úÖ Same-Call Policy (30 Min)
‚úÖ metadata->call_id bef√ºllt
üÜï Email OPTIONAL (nicht bei anonymen!)

Expected Impact:
‚Ä¢ Bekannte Kunden: Sofort erkannt (keine Namen-Frage)
‚Ä¢ Duration: 52s ‚Üí <20s (f√ºr bekannte!)
‚Ä¢ Reschedule Konflikte: Erkannt
‚Ä¢ Anonyme: Nur Name (keine Email)</pre>
        </div>

        <div style="padding: 50px;">
            <h2 style="color: #1f2937; margin-bottom: 30px; text-align: center; font-size: 42px;">
                üìã DASHBOARD-√ÑNDERUNGEN (5 Minuten)
            </h2>

            <table>
                <tr>
                    <th>Feld</th>
                    <th>Aktuell (aus Export)</th>
                    <th>√Ñndern zu</th>
                </tr>
                <tr>
                    <td style="font-weight: bold; font-size: 18px;">Begin Message</td>
                    <td style="color: #dc2626;">
                        "Willkommen bei Ask Pro AI, Ihr Spezialist f√ºr KI-Telefonassistenten. Wie kann ich Ihnen helfen?"
                    </td>
                    <td style="color: #059669; font-weight: bold; font-size: 18px;">
                        "Guten Tag! Wie kann ich Ihnen helfen?"
                    </td>
                </tr>
                <tr>
                    <td style="font-weight: bold; font-size: 18px;">General Prompt</td>
                    <td style="color: #dc2626;">
                        V77-OPTIMIZED (ohne Anti-Silence Rule)
                    </td>
                    <td style="color: #059669; font-weight: bold; font-size: 18px;">
                        V80-FINAL (Copy-Button oben)
                    </td>
                </tr>
            </table>
        </div>

        <div style="padding: 50px; background: #0891b2; color: white; text-align: center;">
            <h2 style="margin-bottom: 35px; font-size: 44px;">üéØ ZUSAMMENFASSUNG</h2>

            <div style="max-width: 1200px; margin: 0 auto;">
                <h3 style="margin-bottom: 25px; font-size: 30px;">‚úÖ BACKEND (Erledigt - 7 Fixes):</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 40px;">
                    <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px; text-align: left;">
                        <p style="font-size: 18px; line-height: 2;">
                            ‚úÖ check_customer() Multi-Tenancy<br>
                            ‚úÖ current_time_berlin weekday<br>
                            ‚úÖ Reschedule Availability-Check<br>
                            ‚úÖ Same-Call Policy (30 Min)
                        </p>
                    </div>
                    <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px; text-align: left;">
                        <p style="font-size: 18px; line-height: 2;">
                            ‚úÖ metadata->call_id bef√ºllt<br>
                            ‚úÖ Cancel Same-Call Policy<br>
                            ‚úÖ Namen-Suche company-scoped
                        </p>
                    </div>
                </div>

                <h3 style="margin-bottom: 25px; font-size: 30px;">‚è≥ DASHBOARD (5 Min TODO):</h3>
                <ol style="text-align: left; line-height: 2.5; font-size: 20px; max-width: 700px; margin: 0 auto;">
                    <li>begin_message: "Guten Tag! Wie kann ich Ihnen helfen?"</li>
                    <li>General Prompt: V80-FINAL (Copy-Button oben)</li>
                    <li>Save Changes ‚Üí Deploy</li>
                    <li>60s warten ‚Üí Test-Call</li>
                </ol>
            </div>
        </div>

        <div style="padding: 50px;">
            <h2 style="color: #1f2937; margin-bottom: 30px; text-align: center; font-size: 42px;">
                ‚úÖ DEINE ANFORDERUNGEN UMGESETZT
            </h2>

            <table>
                <tr>
                    <th>Deine Anforderung</th>
                    <th>Implementierung</th>
                    <th>Status</th>
                </tr>
                <tr>
                    <td>"Agent soll am Anfang check_customer() mit Nummer aufrufen"</td>
                    <td>‚úÖ Im Prompt: STEP 2 (Zeile 63-67 in check_customer Logik)</td>
                    <td style="color: #059669; font-weight: bold;">‚úÖ Funktioniert</td>
                </tr>
                <tr>
                    <td>"Bekannter Kunde ‚Üí KEIN Name erfragen"</td>
                    <td>‚úÖ Prompt: Nutze Namen von check_customer(), keine weitere Frage</td>
                    <td style="color: #059669; font-weight: bold;">‚úÖ Umgesetzt</td>
                </tr>
                <tr>
                    <td>"Anonym ‚Üí Name erfragen, KEINE Email"</td>
                    <td>‚úÖ V80 Prompt: "Ihr Name bitte?" (Email entfernt!)</td>
                    <td style="color: #059669; font-weight: bold;">‚úÖ Umgesetzt</td>
                </tr>
                <tr>
                    <td>"Reschedule Availability-Check vor Verschiebung"</td>
                    <td>‚úÖ RetellApiController.php:1268-1317 - Pr√ºft ob Zeit frei</td>
                    <td style="color: #059669; font-weight: bold;">‚úÖ Implementiert</td>
                </tr>
                <tr>
                    <td>"Same-Call Policy: Gerade gebuchte Termine √§nderbar"</td>
                    <td>‚úÖ 30-Minuten-Fenster f√ºr anonyme Anrufer</td>
                    <td style="color: #059669; font-weight: bold;">‚úÖ Implementiert</td>
                </tr>
                <tr>
                    <td>"Alte Termine: Nur mit Telefonnummer"</td>
                    <td>‚úÖ Anonyme: "Bitte direkt anrufen" bei alten Terminen</td>
                    <td style="color: #059669; font-weight: bold;">‚úÖ Implementiert</td>
                </tr>
                <tr>
                    <td>"Gespr√§ch k√ºrzer machen"</td>
                    <td>‚úÖ check_customer() findet jetzt Kunden (Multi-Tenancy Fix)</td>
                    <td style="color: #059669; font-weight: bold;">‚úÖ Behoben</td>
                </tr>
            </table>
        </div>

        <div style="padding: 40px; text-align: center; background: #f3f4f6;">
            <p style="color: #4b5563; font-size: 15px; line-height: 2;">
                <strong>Call #851 Analyse:</strong> from_number: +491604366218 | customer_id: 461 (Hansi Hinterseer)<br>
                <strong>Bug gefunden:</strong> check_customer() fand Customer nicht (kein company_id Filter!)<br>
                <strong>Fix implementiert:</strong> RetellApiController.php:77-93 (Multi-Tenancy)<br>
                <strong>Backend-Fixes:</strong> 7 komplett | <strong>Dashboard-TODO:</strong> 2 Felder | <strong>Zeit:</strong> 5 Min<br>
                <strong>Datum:</strong> 2025-10-11 | <strong>Status:</strong> Backend ‚úÖ Prompt ‚úÖ Dashboard ‚è≥
            </p>
        </div>
    </div>

    <script>
        function copyPrompt() {
            const text = document.getElementById('finalPrompt').innerText;
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.querySelector('.copy-btn');
                btn.textContent = '‚úÖ KOPIERT! Jetzt: Dashboard ‚Üí General Prompt ‚Üí STRG+A ‚Üí STRG+V ‚Üí Save';
                btn.style.background = '#047857';
                setTimeout(() => {
                    btn.textContent = 'üìã V80-FINAL KOPIEREN';
                    btn.style.background = '#059669';
                }, 7000);
            });
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Process - Complete Technical Documentation</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #1f2937;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 60px;
            text-align: center;
            border-radius: 20px 20px 0 0;
        }

        .header h1 {
            font-size: 3.5em;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .toc {
            background: #f9fafb;
            padding: 40px;
            border-bottom: 4px solid #e5e7eb;
        }

        .toc h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .toc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .toc-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toc-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .content {
            padding: 60px;
        }

        .section {
            margin-bottom: 80px;
            scroll-margin-top: 100px;
        }

        .section h2 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 5px solid #667eea;
        }

        .section h3 {
            color: #764ba2;
            font-size: 1.8em;
            margin: 40px 0 20px 0;
        }

        .section h4 {
            color: #9333ea;
            font-size: 1.3em;
            margin: 25px 0 15px 0;
        }

        .flow-diagram {
            background: #f9fafb;
            border: 3px solid #e5e7eb;
            border-radius: 15px;
            padding: 40px;
            margin: 30px 0;
        }

        .flow-step {
            background: white;
            border-left: 6px solid #667eea;
            padding: 25px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: relative;
        }

        .flow-step::before {
            content: attr(data-step);
            position: absolute;
            left: -30px;
            top: 20px;
            background: #667eea;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .flow-arrow {
            text-align: center;
            color: #667eea;
            font-size: 2em;
            margin: 15px 0;
        }

        .component-box {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 3px solid #f59e0b;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
        }

        .component-box h4 {
            color: #92400e;
            margin-bottom: 15px;
        }

        .code-block {
            background: #1f2937;
            color: #10b981;
            padding: 30px;
            border-radius: 12px;
            margin: 25px 0;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            line-height: 1.9;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .warning-box {
            background: #fee2e2;
            border-left: 8px solid #ef4444;
            padding: 25px;
            border-radius: 10px;
            margin: 25px 0;
        }

        .success-box {
            background: #dcfce7;
            border-left: 8px solid #10b981;
            padding: 25px;
            border-radius: 10px;
            margin: 25px 0;
        }

        .info-box {
            background: #dbeafe;
            border-left: 8px solid #3b82f6;
            padding: 25px;
            border-radius: 10px;
            margin: 25px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 30px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        th {
            background: #667eea;
            color: white;
            padding: 20px;
            font-weight: bold;
            font-size: 1.1em;
        }

        td {
            padding: 18px;
            border-bottom: 1px solid #e5e7eb;
        }

        tr:hover {
            background: #f9fafb;
        }

        .dependency-graph {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            margin: 30px 0;
        }

        .file-path {
            background: #f3f4f6;
            padding: 8px 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #4b5563;
            display: inline-block;
            margin: 5px 0;
        }

        .critical-point {
            background: #fef3c7;
            border: 3px solid #f59e0b;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .sql-query {
            background: #ede9fe;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin: 15px 0;
            font-size: 0.95em;
        }

        .timeline {
            position: relative;
            padding-left: 50px;
            margin: 30px 0;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #667eea;
        }

        .timeline-item {
            position: relative;
            margin: 25px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -38px;
            top: 25px;
            width: 20px;
            height: 20px;
            background: #667eea;
            border: 4px solid white;
            border-radius: 50%;
            box-shadow: 0 0 0 3px #667eea;
        }

        .checklist {
            background: #f0fdf4;
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 30px;
            margin: 30px 0;
        }

        .checklist-item {
            padding: 15px;
            margin: 10px 0;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            font-size: 1.05em;
        }

        .checklist-item::before {
            content: '‚úÖ';
            margin-right: 15px;
            font-size: 1.3em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìò Booking Process</h1>
            <div style="font-size: 1.5em; margin: 20px 0;">Complete Technical Documentation</div>
            <div style="font-size: 1.1em; opacity: 0.9;">Schritt-f√ºr-Schritt | Alle Komponenten | Alle Datenfl√ºsse | Alle Fehlerquellen</div>
            <div style="margin-top: 25px; padding: 15px; background: rgba(255,255,255,0.2); border-radius: 10px; display: inline-block;">
                Version: 1.0 | Datum: 2025-10-10 | Status: Production Ready
            </div>
        </div>

        <!-- TABLE OF CONTENTS -->
        <div class="toc">
            <h2>üìã Inhaltsverzeichnis</h2>
            <div class="toc-grid">
                <div class="toc-item" onclick="location.hash='#overview'">
                    <strong>1. √úbersicht</strong><br>
                    <small>High-Level Flow & Komponenten</small>
                </div>
                <div class="toc-item" onclick="location.hash='#user-journey'">
                    <strong>2. User Journey</strong><br>
                    <small>Von Anruf bis Best√§tigung</small>
                </div>
                <div class="toc-item" onclick="location.hash='#components'">
                    <strong>3. System Komponenten</strong><br>
                    <small>Alle beteiligten Services & Files</small>
                </div>
                <div class="toc-item" onclick="location.hash='#dataflow'">
                    <strong>4. Datenfluss</strong><br>
                    <small>Request ‚Üí Response ‚Üí Database</small>
                </div>
                <div class="toc-item" onclick="location.hash='#functions'">
                    <strong>5. Retell Functions</strong><br>
                    <small>Alle Functions & Parameter</small>
                </div>
                <div class="toc-item" onclick="location.hash='#database'">
                    <strong>6. Database Schema</strong><br>
                    <small>Tabellen, Spalten, Relations</small>
                </div>
                <div class="toc-item" onclick="location.hash='#errors'">
                    <strong>7. Fehlerquellen</strong><br>
                    <small>Alle m√∂glichen Fehler & Fixes</small>
                </div>
                <div class="toc-item" onclick="location.hash='#troubleshooting'">
                    <strong>8. Troubleshooting</strong><br>
                    <small>Probleme schnell finden & fixen</small>
                </div>
            </div>
        </div>

        <div class="content">
            <!-- SECTION 1: OVERVIEW -->
            <div class="section" id="overview">
                <h2>1. √úbersicht - Der Buchungsprozess</h2>

                <div class="success-box">
                    <h3 style="color: #166534; margin-bottom: 20px;">üéØ Was ist eine Buchung?</h3>
                    <p style="font-size: 1.2em; line-height: 2;">
                        Ein Kunde ruft an ‚Üí Will einen Termin ‚Üí System pr√ºft Verf√ºgbarkeit ‚Üí
                        System bucht bei Cal.com ‚Üí System speichert in DB ‚Üí Kunde erh√§lt Best√§tigung
                    </p>
                </div>

                <h3>High-Level Architektur</h3>
                <div class="flow-diagram">
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; text-align: center;">
                        <div style="background: #dbeafe; padding: 20px; border-radius: 10px; border: 2px solid #3b82f6;">
                            <strong>Kunde</strong><br>
                            Anruf<br>
                            üó£Ô∏è
                        </div>
                        <div style="background: #fef3c7; padding: 20px; border-radius: 10px; border: 2px solid #f59e0b;">
                            <strong>Retell AI</strong><br>
                            Voice Agent<br>
                            ü§ñ
                        </div>
                        <div style="background: #dcfce7; padding: 20px; border-radius: 10px; border: 2px solid #10b981;">
                            <strong>Backend</strong><br>
                            API Gateway<br>
                            ‚öôÔ∏è
                        </div>
                        <div style="background: #e0e7ff; padding: 20px; border-radius: 10px; border: 2px solid #6366f1;">
                            <strong>Cal.com</strong><br>
                            Calendar API<br>
                            üìÖ
                        </div>
                        <div style="background: #f3e8ff; padding: 20px; border-radius: 10px; border: 2px solid #a855f7;">
                            <strong>Database</strong><br>
                            MySQL<br>
                            üíæ
                        </div>
                    </div>

                    <div style="text-align: center; margin: 30px 0; font-size: 1.5em; color: #667eea;">
                        ‚Üì ‚Üì ‚Üì ‚Üì ‚Üì
                    </div>

                    <div style="background: #dcfce7; padding: 25px; border-radius: 12px; text-align: center; border: 3px solid #10b981;">
                        <strong style="font-size: 1.3em; color: #166534;">
                            ‚úÖ RESULT: Termin gebucht, synchronisiert, best√§tigt
                        </strong>
                    </div>
                </div>

                <h3>Kritische Erfolgsfaktoren</h3>
                <div class="checklist">
                    <div class="checklist-item">Kunde wird korrekt identifiziert (phone number matching)</div>
                    <div class="checklist-item">Datum/Zeit korrekt geparst (Deutsche Zeitangaben)</div>
                    <div class="checklist-item">Timezone korrekt konvertiert (UTC ‚Üî Europe/Berlin)</div>
                    <div class="checklist-item">Cal.com Verf√ºgbarkeit korrekt gepr√ºft</div>
                    <div class="checklist-item">Keine Duplicate Bookings</div>
                    <div class="checklist-item">Database & Cal.com synchronisiert</div>
                    <div class="checklist-item">Metadata vollst√§ndig gespeichert</div>
                    <div class="checklist-item">Call Record verkn√ºpft</div>
                </div>
            </div>

            <!-- SECTION 2: USER JOURNEY -->
            <div class="section" id="user-journey">
                <h2>2. User Journey - Schritt f√ºr Schritt</h2>

                <div class="timeline">
                    <div class="timeline-item">
                        <h4 style="color: #667eea; margin-bottom: 10px;">üó£Ô∏è SCHRITT 1: Kunde ruft an</h4>
                        <p><strong>User:</strong> "Guten Tag, ich m√∂chte einen Termin buchen"</p>
                        <p style="margin-top: 10px; color: #666;">
                            ‚Üí Twilio empf√§ngt Anruf<br>
                            ‚Üí Twilio verbindet mit Retell AI<br>
                            ‚Üí Retell startet Agent
                        </p>
                    </div>

                    <div class="timeline-item">
                        <h4 style="color: #667eea; margin-bottom: 10px;">ü§ñ SCHRITT 2: Agent initialisiert</h4>
                        <p><strong>Agent ruft auf:</strong></p>
                        <div class="code-block" style="margin-top: 10px; font-size: 0.9em;">
1. current_time_berlin()
   ‚Üí Erh√§lt: current_date, current_weekday, current_time

2. check_customer(call_id: {{call_id}})
   ‚Üí Erh√§lt: customer_name, customer_exists

3. Agent begr√º√üt:
   "Guten Tag [Name]! Wie kann ich helfen?"
                        </div>
                    </div>

                    <div class="timeline-item">
                        <h4 style="color: #667eea; margin-bottom: 10px;">üìÖ SCHRITT 3: Terminwunsch erfassen</h4>
                        <p><strong>User:</strong> "N√§chsten Montag um 14 Uhr f√ºr eine Beratung"</p>
                        <p style="margin-top: 10px;"><strong>Agent sammelt:</strong></p>
                        <ul style="margin: 10px 0 10px 25px; line-height: 2;">
                            <li>Datum: "n√§chsten Montag" ‚Üí getCurrentDateTimeInfo()</li>
                            <li>Uhrzeit: "14 Uhr" ‚Üí 14:00</li>
                            <li>Service: "Beratung"</li>
                            <li>Name: Aus check_customer()</li>
                        </ul>
                    </div>

                    <div class="timeline-item">
                        <h4 style="color: #667eea; margin-bottom: 10px;">‚úÖ SCHRITT 4: Verf√ºgbarkeit pr√ºfen</h4>
                        <p><strong>Agent ruft auf:</strong></p>
                        <div class="code-block" style="margin-top: 10px; font-size: 0.9em;">
collect_appointment_data(
  call_id: "call_...",
  name: "Hansi Hinterseer",
  datum: "2025-10-13",
  uhrzeit: "14:00",
  dienstleistung: "Beratung"
)

Backend pr√ºft:
  1. Parse Datum/Zeit
  2. Find Customer by phone
  3. Check for duplicates
  4. Query Cal.com for availability
  5. Return: available=true/false + alternatives
                        </div>
                    </div>

                    <div class="timeline-item">
                        <h4 style="color: #667eea; margin-bottom: 10px;">üí¨ SCHRITT 5: Kunde best√§tigt</h4>
                        <p><strong>Agent:</strong> "Montag, den 13. Oktober um 14 Uhr ist frei. Soll ich buchen?"</p>
                        <p><strong>User:</strong> "Ja, bitte!"</p>
                        <p style="margin-top: 10px; color: #666;">
                            ‚Üí Agent bereitet Buchung vor<br>
                            ‚Üí collect_appointment mit bestaetigung=true
                        </p>
                    </div>

                    <div class="timeline-item">
                        <h4 style="color: #667eea; margin-bottom: 10px;">üîÑ SCHRITT 6: System bucht</h4>
                        <div class="code-block" style="margin-top: 10px; font-size: 0.9em;">
collect_appointment_data(
  ... SAME parameters ...,
  bestaetigung: true  // ‚Üê Trigger f√ºr Buchung
)

Backend:
  1. ‚úÖ Create Cal.com booking
  2. ‚úÖ Create Appointment in DB
  3. ‚úÖ Link to Call record
  4. ‚úÖ Set metadata (created_by, booking_source)
  5. ‚úÖ Return: success + booking_id
                        </div>
                    </div>

                    <div class="timeline-item">
                        <h4 style="color: #667eea; margin-bottom: 10px;">üìß SCHRITT 7: Best√§tigung</h4>
                        <p><strong>Agent:</strong> "Ihr Termin wurde erfolgreich gebucht. Sie erhalten eine Best√§tigung."</p>
                        <p style="margin-top: 10px; color: #666;">
                            ‚Üí Cal.com sendet Email an Kunde<br>
                            ‚Üí Cal.com sendet Email an Staff<br>
                            ‚Üí System logged alles in DB
                        </p>
                    </div>
                </div>
            </div>

            <!-- SECTION 3: COMPONENTS -->
            <div class="section" id="components">
                <h2>3. System Komponenten - Alle beteiligten Files</h2>

                <h3>3.1 Controllers (Request Handling)</h3>

                <div class="component-box">
                    <h4>üìÑ RetellFunctionCallHandler.php</h4>
                    <div class="file-path">app/Http/Controllers/RetellFunctionCallHandler.php</div>
                    <p style="margin-top: 15px;"><strong>Verantwortlich f√ºr:</strong></p>
                    <ul style="margin-left: 25px; line-height: 2;">
                        <li>Empfang aller Retell Function Calls</li>
                        <li>collectAppointment() - Haupteinstiegspunkt</li>
                        <li>handleAvailabilityCheck() - Verf√ºgbarkeitspr√ºfung</li>
                        <li>handleCancellationAttempt() - Stornierung</li>
                        <li>handleRescheduleAttempt() - Verschiebung</li>
                    </ul>
                    <p style="margin-top: 15px;"><strong>Wichtige Methoden:</strong></p>
                    <div class="code-block" style="font-size: 0.85em;">
Line 670:  collectAppointment()        - Hauptbuchungslogik
Line 146:  checkAvailability()         - Verf√ºgbarkeit pr√ºfen
Line 1472: handleAvailabilityCheck()   - Public endpoint
Line 1698: handleCancellationAttempt() - Stornierung mit Policy
Line 1876: handleRescheduleAttempt()   - Verschiebung mit Geb√ºhren
Line 2291: createAnonymousCallbackRequest() - Anonymous Security
                    </div>
                </div>

                <div class="component-box">
                    <h4>üìÑ DateTimeInfoController.php</h4>
                    <div class="file-path">app/Http/Controllers/Api/Retell/DateTimeInfoController.php</div>
                    <p style="margin-top: 15px;"><strong>Verantwortlich f√ºr:</strong></p>
                    <ul style="margin-left: 25px; line-height: 2;">
                        <li>Deutsche Zeitangaben parsen ("n√§chste Woche Montag")</li>
                        <li>Relative Daten berechnen ("dieser Freitag", "morgen")</li>
                        <li>Wochentags-Semantik ("dieser" vs "n√§chster")</li>
                    </ul>
                    <p style="margin-top: 15px;"><strong>Wichtige Patterns:</strong></p>
                    <div class="code-block" style="font-size: 0.85em;">
Line 113: Pattern 1 - "dieser/n√§chster [Wochentag]"
Line 124: Pattern 2a - "n√§chste Woche Montag" ‚úÖ NEU!
Line 135: Pattern 2b - "diese/n√§chste Woche"
Line 138: Pattern 3 - "heute", "morgen", "√ºbermorgen"
Line 146: Pattern 4 - "Montag", "Dienstag", etc.
Line 154: Pattern 5 - "15.10.2025", "13.10."

Line 39: args Extraction ‚úÖ GEFIXT!
                    </div>
                </div>

                <div class="component-box">
                    <h4>üìÑ AppointmentCreationService.php</h4>
                    <div class="file-path">app/Services/Retell/AppointmentCreationService.php</div>
                    <p style="margin-top: 15px;"><strong>Verantwortlich f√ºr:</strong></p>
                    <ul style="margin-left: 25px; line-height: 2;">
                        <li>Termin in Database anlegen</li>
                        <li>Cal.com Booking erstellen</li>
                        <li>Customer verkn√ºpfen</li>
                        <li>Metadata setzen (created_by, booking_source)</li>
                        <li>Staff Assignment</li>
                    </ul>
                    <p style="margin-top: 15px;"><strong>Kritische Zeilen:</strong></p>
                    <div class="code-block" style="font-size: 0.85em;">
Line 388-409: Appointment forceFill & save
  - company_id, customer_id, service_id
  - starts_at, ends_at (Timezone: Europe/Berlin!)
  - created_by='customer', booking_source='retell_webhook'
  - calcom_v2_booking_id, external_id

Line 410-450: Staff Assignment from Cal.com hosts
                    </div>
                </div>

                <h3>3.2 Services (Business Logic)</h3>

                <div class="component-box">
                    <h4>üìÑ DateTimeParser.php</h4>
                    <div class="file-path">app/Services/Retell/DateTimeParser.php</div>
                    <p style="margin-top: 15px;"><strong>Verantwortlich f√ºr:</strong></p>
                    <ul style="margin-left: 25px; line-height: 2;">
                        <li>parseDateString() - "heute", "morgen", "Montag"</li>
                        <li>parseRelativeWeekday() - "dieser/n√§chster Freitag"</li>
                        <li>parseWeekRange() - "diese/n√§chste Woche"</li>
                    </ul>
                    <div class="critical-point">
                        <strong>‚ö†Ô∏è KRITISCH:</strong> Alle Daten m√ºssen in <code>Europe/Berlin</code> Timezone sein!<br>
                        <code>Carbon::parse($date, 'Europe/Berlin')</code>
                    </div>
                </div>

                <div class="component-box">
                    <h4>üìÑ CalcomService.php</h4>
                    <div class="file-path">app/Services/CalcomService.php</div>
                    <p style="margin-top: 15px;"><strong>Verantwortlich f√ºr:</strong></p>
                    <ul style="margin-left: 25px; line-height: 2;">
                        <li>getAvailableSlots() - Verf√ºgbare Zeiten abrufen</li>
                        <li>createBooking() - Termin bei Cal.com buchen</li>
                        <li>cancelBooking() - Termin stornieren</li>
                        <li>rescheduleBooking() - Termin verschieben</li>
                    </ul>
                    <div class="critical-point">
                        <strong>‚ö†Ô∏è KRITISCH:</strong> Cal.com gibt UTC Zeiten zur√ºck!<br>
                        Immer konvertieren: <code>->setTimezone('Europe/Berlin')</code>
                    </div>
                </div>

                <h3>3.3 Middleware (Security & Rate Limiting)</h3>

                <div class="component-box">
                    <h4>üìÑ RetellCallRateLimiter.php</h4>
                    <div class="file-path">app/Http/Middleware/RetellCallRateLimiter.php</div>
                    <p style="margin-top: 15px;"><strong>Verantwortlich f√ºr:</strong></p>
                    <ul style="margin-left: 25px; line-height: 2;">
                        <li>call_id Validation (MUSS vorhanden sein!)</li>
                        <li>Rate Limiting (max 30 calls/minute)</li>
                        <li>Cooldown nach Errors (30s block)</li>
                    </ul>
                    <div class="warning-box">
                        <strong style="color: #991b1b;">‚ö†Ô∏è WICHTIG:</strong><br>
                        Diese Middleware blockiert Requests OHNE call_id mit 400 Error!<br>
                        ALLE Retell Functions M√úSSEN call_id Parameter haben!
                    </div>
                </div>
            </div>

            <!-- SECTION 4: DATAFLOW -->
            <div class="section" id="dataflow">
                <h2>4. Datenfluss - Request bis Response</h2>

                <h3>4.1 Kompletter Flow (collect_appointment)</h3>

                <div class="flow-diagram">
                    <div class="flow-step" data-step="1" style="margin-left: 60px;">
                        <h4>Retell AI empf√§ngt User Input</h4>
                        <p>User: "N√§chsten Montag 14 Uhr Termin buchen"</p>
                        <div class="code-block" style="font-size: 0.85em; margin-top: 10px;">
Agent erkennt:
  - Datum: "n√§chsten Montag" (relative)
  - Zeit: "14 Uhr"
  - Intent: Booking
                        </div>
                    </div>

                    <div class="flow-arrow">‚Üì</div>

                    <div class="flow-step" data-step="2" style="margin-left: 60px;">
                        <h4>getCurrentDateTimeInfo() Function Call</h4>
                        <div class="code-block" style="font-size: 0.85em; margin-top: 10px;">
POST /api/retell/datetime
{
  "args": {
    "call_id": "call_abc123",
    "zeitangabe": "n√§chsten Montag"
  }
}

‚Üí DateTimeInfoController extracts args ‚úÖ
‚Üí DateTimeParser parses "n√§chsten Montag"
‚Üí Returns: {d: "2025-10-20", wd: "Mo", ...}
                        </div>
                    </div>

                    <div class="flow-arrow">‚Üì</div>

                    <div class="flow-step" data-step="3" style="margin-left: 60px;">
                        <h4>collect_appointment_data() Function Call (STEP 1)</h4>
                        <div class="code-block" style="font-size: 0.85em; margin-top: 10px;">
POST /api/retell/collect-appointment
{
  "args": {
    "call_id": "call_abc123",
    "name": "Hansi Hinterseer",
    "datum": "2025-10-20",
    "uhrzeit": "14:00",
    "dienstleistung": "Beratung"
  }
}

Backend Processing:
  ‚Üí RetellFunctionCallHandler::collectAppointment()
  ‚Üí Line 748-893: Parse & Validate
  ‚Üí Line 894-920: Parse Datum (Europe/Berlin!)
  ‚Üí Line 995-1065: Duplicate Check
  ‚Üí Line 1067-1119: Cal.com Availability Check
  ‚Üí Line 1121-1134: Alternative-Finder (if not available)

Response:
  {
    "success": false,  // Noch nicht gebucht!
    "exact_time_available": true,
    "message": "Am Montag, den 20. Oktober um 14 Uhr ist frei..."
  }
                        </div>
                    </div>

                    <div class="flow-arrow">‚Üì</div>

                    <div class="flow-step" data-step="4" style="margin-left: 60px;">
                        <h4>collect_appointment_data() Function Call (STEP 2)</h4>
                        <div class="code-block" style="font-size: 0.85em; margin-top: 10px;">
POST /api/retell/collect-appointment
{
  "args": {
    ... SAME as Step 1 ...,
    "bestaetigung": true  // ‚Üê JETZT BUCHEN!
  }
}

Backend Processing:
  ‚Üí Line 1181-1280: Create Cal.com Booking
  ‚Üí Line 1282-1370: AppointmentCreationService
    - Find/Create Customer
    - Find Service
    - Create Appointment (DB)
    - Set Metadata ‚úÖ
    - Link to Call
  ‚Üí Line 1372-1400: Update Call record

Response:
  {
    "success": true,
    "status": "booked",
    "message": "Perfekt! Ihr Termin am ... wurde gebucht.",
    "appointment_id": "xyz123"
  }
                        </div>
                    </div>

                    <div class="flow-arrow">‚Üì</div>

                    <div class="flow-step" data-step="5" style="margin-left: 60px;">
                        <h4>Database & Cal.com synchronisiert</h4>
                        <div class="sql-query">
appointments table:
  INSERT INTO appointments (
    company_id, customer_id, service_id,
    starts_at, ends_at,
    status='scheduled',
    created_by='customer',        ‚úÖ Metadata!
    booking_source='retell_webhook', ‚úÖ Metadata!
    calcom_v2_booking_id,
    call_id,
    metadata
  )

calls table:
  UPDATE calls SET
    booking_confirmed=true,
    session_outcome='appointment_booked',
    booking_id='xyz123'
                        </div>
                    </div>
                </div>

                <h3>4.2 Timezone Conversion Flow (KRITISCH!)</h3>

                <div class="warning-box">
                    <h4 style="color: #991b1b; margin-bottom: 15px;">‚ö†Ô∏è TIMEZONE IST EXTREM WICHTIG!</h4>
                    <p style="font-size: 1.1em; line-height: 2;">
                        Cal.com gibt <strong>IMMER UTC Zeiten</strong> zur√ºck.<br>
                        User spricht √ºber <strong>Europe/Berlin (CEST)</strong> Zeiten.<br>
                        <strong>M√úSSEN konvertiert werden!</strong>
                    </p>
                </div>

                <div class="flow-diagram">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                        <div style="background: #dbeafe; padding: 20px; border-radius: 10px;">
                            <strong>User Input</strong><br>
                            "14:30 Uhr"<br>
                            <small>(Berlin Zeit)</small>
                        </div>
                        <div style="background: #fef3c7; padding: 20px; border-radius: 10px;">
                            <strong>Cal.com API</strong><br>
                            "12:30:00.000Z"<br>
                            <small>(UTC)</small>
                        </div>
                        <div style="background: #dcfce7; padding: 20px; border-radius: 10px;">
                            <strong>Conversion</strong><br>
                            setTimezone('Europe/Berlin')<br>
                            <small>‚úÖ 12:30 UTC = 14:30 CEST</small>
                        </div>
                    </div>

                    <div class="code-block" style="margin-top: 20px; font-size: 0.9em;">
// √úBERALL wo Cal.com Slots verarbeitet werden:

$slotTime = Carbon::parse($slot['time'])->setTimezone('Europe/Berlin');

// GEFIXT in 11 Locations:
// - RetellFunctionCallHandler.php (4x)
// - RetellApiController.php (1x)
// - RetellWebhookController.php (1x)
// - AppointmentAlternativeFinder.php (6x)
                    </div>
                </div>

                <h3>4.3 Duplicate Detection Flow</h3>

                <div class="info-box">
                    <h4 style="color: #1e40af; margin-bottom: 15px;">üîç Wie Duplicates erkannt werden</h4>

                    <p style="margin-bottom: 15px;"><strong>Pr√ºfung in RetellFunctionCallHandler.php (Line 995-1065):</strong></p>

                    <div class="code-block" style="font-size: 0.85em;">
// 1. Find Customer by phone number
$customer = Customer::where('company_id', $companyId)
    ->where('phone', $phoneNumber)
    ->first();

// 2. Check for existing appointment at SAME date/time
$existingAppointment = Appointment::where('customer_id', $customer->id)
    ->whereDate('starts_at', $appointmentDate->format('Y-m-d'))
    ->whereTime('starts_at', $appointmentDate->format('H:i:s'))
    ->whereIn('status', ['scheduled', 'confirmed', 'booked'])
    ->first();

// 3. If found ‚Üí Return duplicate_detected
if ($existingAppointment) {
    return {
        "success": false,
        "status": "duplicate_detected",
        "message": "Ich sehe in meinem System, dass f√ºr Ihre Nummer
                    bereits am [Wochentag], den [Datum] um [Zeit] Uhr
                    ein Termin eingetragen ist...",
        "existing_appointment": { ... },
        "options": ["keep_existing", "book_additional", "reschedule"]
    };
}
                    </div>

                    <div class="success-box" style="margin-top: 20px;">
                        <strong>‚úÖ Duplicate Message wurde verbessert!</strong><br>
                        <ul style="margin: 10px 0 10px 25px; line-height: 2;">
                            <li>Enth√§lt jetzt korrekten deutschen Wochentag</li>
                            <li>"Ich sehe in meinem System, dass..." (klarer Kontext)</li>
                            <li>Unterscheidet "heute" vs. "am [Wochentag], den [Datum]"</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- SECTION 5: RETELL FUNCTIONS -->
            <div class="section" id="functions">
                <h2>5. Retell Functions - Alle Parameter & Responses</h2>

                <h3>5.1 getCurrentDateTimeInfo</h3>

                <table>
                    <thead>
                        <tr>
                            <th>Property</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Name</strong></td>
                            <td>getCurrentDateTimeInfo</td>
                        </tr>
                        <tr>
                            <td><strong>URL</strong></td>
                            <td>https://api.askproai.de/api/retell/datetime</td>
                        </tr>
                        <tr>
                            <td><strong>Method</strong></td>
                            <td>POST</td>
                        </tr>
                        <tr>
                            <td><strong>Payload</strong></td>
                            <td>args only</td>
                        </tr>
                    </tbody>
                </table>

                <h4>Parameters Schema:</h4>
                <div class="code-block">
{
  "type": "object",
  "properties": {
    "call_id": {
      "type": "string",
      "description": "Current call ID"
    },
    "zeitangabe": {
      "type": "string",
      "description": "German time expression (e.g., 'n√§chste Woche Montag')"
    }
  },
  "required": ["call_id", "zeitangabe"]
}
                </div>

                <h4>Response Format:</h4>
                <div class="code-block">
{
  "success": true,
  "t": "single",              // type
  "d": "2025-10-20",          // date (YYYY-MM-DD)
  "wd": "Mo",                 // weekday short
  "wdn": 1,                   // weekday number (1=Mo, 7=So)
  "wk": 42,                   // week number
  "td": false,                // is_today
  "tm": false,                // is_tomorrow
  "df": 10,                   // days_from_now
  "int": "In 10 Tagen (Mo, 20.10.)"  // interpretation
}
                </div>

                <h4>Supported Patterns:</h4>
                <div class="checklist" style="background: #f0fdf4;">
                    <div class="checklist-item">"heute", "morgen", "√ºbermorgen"</div>
                    <div class="checklist-item">"Montag", "Dienstag", "Freitag", etc.</div>
                    <div class="checklist-item">"dieser Montag", "n√§chster Freitag"</div>
                    <div class="checklist-item">"diese Woche", "n√§chste Woche"</div>
                    <div class="checklist-item">"n√§chste Woche Montag" ‚úÖ NEU!</div>
                    <div class="checklist-item">"13.10.2025", "13.10.", "13. Oktober"</div>
                </div>

                <h3>5.2 collect_appointment_data</h3>

                <table>
                    <thead>
                        <tr>
                            <th>Property</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Name</strong></td>
                            <td>collect_appointment_data</td>
                        </tr>
                        <tr>
                            <td><strong>URL</strong></td>
                            <td>https://api.askproai.de/api/retell/collect-appointment</td>
                        </tr>
                        <tr>
                            <td><strong>Method</strong></td>
                            <td>POST</td>
                        </tr>
                        <tr>
                            <td><strong>Payload</strong></td>
                            <td>args only</td>
                        </tr>
                        <tr>
                            <td><strong>2-Step Process</strong></td>
                            <td>Step 1: Check availability<br>Step 2: Confirm booking (bestaetigung=true)</td>
                        </tr>
                    </tbody>
                </table>

                <h4>Parameters Schema:</h4>
                <div class="code-block">
{
  "type": "object",
  "properties": {
    "call_id": {
      "type": "string",
      "description": "Current call ID"
    },
    "name": {
      "type": "string",
      "description": "Customer name"
    },
    "datum": {
      "type": "string",
      "description": "Date from getCurrentDateTimeInfo"
    },
    "uhrzeit": {
      "type": "string",
      "description": "Time HH:MM"
    },
    "dienstleistung": {
      "type": "string",
      "description": "Service type"
    },
    "bestaetigung": {
      "type": "boolean",
      "description": "true = book now, false/absent = check only"
    }
  },
  "required": ["call_id", "datum", "uhrzeit"]
}
                </div>

                <h4>Response Scenarios:</h4>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 25px 0;">
                    <div class="success-box">
                        <h4 style="color: #166534;">‚úÖ Scenario 1: Available & Booked</h4>
                        <div class="code-block" style="font-size: 0.85em;">
{
  "success": true,
  "status": "booked",
  "message": "Perfekt! Ihr Termin am...",
  "appointment_id": "xyz123"
}
                        </div>
                    </div>

                    <div class="warning-box">
                        <h4 style="color: #991b1b;">‚ùå Scenario 2: Not Available</h4>
                        <div class="code-block" style="font-size: 0.85em;">
{
  "success": false,
  "exact_time_available": false,
  "alternatives": [
    {"time": "15:00", "description": "..."},
    {"time": "16:00", "description": "..."}
  ]
}
                        </div>
                    </div>

                    <div class="info-box">
                        <h4 style="color: #1e40af;">üîÑ Scenario 3: Duplicate</h4>
                        <div class="code-block" style="font-size: 0.85em;">
{
  "success": false,
  "status": "duplicate_detected",
  "message": "Ich sehe... bereits...",
  "existing_appointment": {...},
  "options": ["keep", "reschedule", "additional"]
}
                        </div>
                    </div>
                </div>

                <h3>5.3 check_availability (‚ö†Ô∏è NEEDS FIX!)</h3>

                <table>
                    <thead>
                        <tr>
                            <th>Property</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Name</strong></td>
                            <td>check_availability</td>
                        </tr>
                        <tr>
                            <td><strong>URL</strong></td>
                            <td>https://api.askproai.de/api/retell/check-availability</td>
                        </tr>
                        <tr>
                            <td><strong>Method</strong></td>
                            <td>POST</td>
                        </tr>
                        <tr>
                            <td><strong>Payload</strong></td>
                            <td>args only</td>
                        </tr>
                        <tr style="background: #fee2e2;">
                            <td><strong>‚ö†Ô∏è CURRENT BUG</strong></td>
                            <td><strong>call_id fehlt in Function Definition!</strong></td>
                        </tr>
                    </tbody>
                </table>

                <h4>KORREKTE Parameters Schema:</h4>
                <div class="code-block">
{
  "type": "object",
  "properties": {
    "call_id": {
      "type": "string",
      "description": "Current call ID"
    },
    "date": {
      "type": "string",
      "description": "Date YYYY-MM-DD"
    },
    "time": {
      "type": "string",
      "description": "Optional time HH:MM"
    },
    "service_type": {
      "type": "string",
      "description": "Service type"
    }
  },
  "required": ["call_id", "date"]
}
                </div>

                <div class="critical-point">
                    <strong>üî¥ KRITISCH:</strong> <code>call_id</code> MUSS in required array sein!<br>
                    Ohne call_id ‚Üí Middleware blockiert mit 400 Error ‚Üí Buchung impossible!
                </div>
            </div>

            <!-- SECTION 6: DATABASE -->
            <div class="section" id="database">
                <h2>6. Database Schema - Alle Tabellen & Spalten</h2>

                <h3>6.1 appointments Table (Haupttabelle)</h3>

                <table>
                    <thead>
                        <tr>
                            <th>Column</th>
                            <th>Type</th>
                            <th>Purpose</th>
                            <th>Required?</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background: #fef3c7;">
                            <td><strong>id</strong></td>
                            <td>bigint</td>
                            <td>Primary Key</td>
                            <td>‚úÖ</td>
                        </tr>
                        <tr>
                            <td><strong>company_id</strong></td>
                            <td>bigint</td>
                            <td>Multi-tenant isolation</td>
                            <td>‚úÖ</td>
                        </tr>
                        <tr>
                            <td><strong>customer_id</strong></td>
                            <td>bigint</td>
                            <td>Wer hat gebucht</td>
                            <td>‚úÖ</td>
                        </tr>
                        <tr>
                            <td><strong>service_id</strong></td>
                            <td>bigint</td>
                            <td>Welcher Service</td>
                            <td>‚úÖ</td>
                        </tr>
                        <tr>
                            <td><strong>starts_at</strong></td>
                            <td>timestamp</td>
                            <td>Terminbeginn (Europe/Berlin!)</td>
                            <td>‚úÖ</td>
                        </tr>
                        <tr>
                            <td><strong>ends_at</strong></td>
                            <td>timestamp</td>
                            <td>Terminende</td>
                            <td>‚úÖ</td>
                        </tr>
                        <tr>
                            <td><strong>status</strong></td>
                            <td>enum</td>
                            <td>scheduled/confirmed/cancelled</td>
                            <td>‚úÖ</td>
                        </tr>
                        <tr>
                            <td><strong>call_id</strong></td>
                            <td>bigint</td>
                            <td>Verkn√ºpfung zu Call Record</td>
                            <td>‚ùå</td>
                        </tr>
                        <tr>
                            <td><strong>calcom_v2_booking_id</strong></td>
                            <td>string</td>
                            <td>Cal.com UID (sync!)</td>
                            <td>‚ùå</td>
                        </tr>
                        <tr style="background: #dcfce7;">
                            <td><strong>created_by</strong></td>
                            <td>string</td>
                            <td>customer/staff/admin/webhook</td>
                            <td>‚úÖ METADATA</td>
                        </tr>
                        <tr style="background: #dcfce7;">
                            <td><strong>booking_source</strong></td>
                            <td>string</td>
                            <td>retell_webhook/calcom_webhook/admin_panel</td>
                            <td>‚úÖ METADATA</td>
                        </tr>
                        <tr style="background: #dcfce7;">
                            <td><strong>booked_by_user_id</strong></td>
                            <td>bigint</td>
                            <td>Welcher Staff/Admin User (nullable)</td>
                            <td>‚ùå METADATA</td>
                        </tr>
                        <tr style="background: #fef3c7;">
                            <td><strong>rescheduled_at</strong></td>
                            <td>timestamp</td>
                            <td>Wann verschoben</td>
                            <td>‚ùå METADATA</td>
                        </tr>
                        <tr style="background: #fef3c7;">
                            <td><strong>previous_starts_at</strong></td>
                            <td>timestamp</td>
                            <td>Alter Termin (Audit!)</td>
                            <td>‚ùå METADATA</td>
                        </tr>
                        <tr style="background: #fee2e2;">
                            <td><strong>cancelled_at</strong></td>
                            <td>timestamp</td>
                            <td>Wann storniert</td>
                            <td>‚ùå METADATA</td>
                        </tr>
                        <tr style="background: #fee2e2;">
                            <td><strong>cancelled_by</strong></td>
                            <td>string</td>
                            <td>customer/staff/admin/system</td>
                            <td>‚ùå METADATA</td>
                        </tr>
                    </tbody>
                </table>

                <div class="info-box">
                    <strong>üìä Metadata-Spalten (13 total):</strong>
                    <ul style="margin: 15px 0 15px 25px; line-height: 2;">
                        <li><strong>Booking:</strong> created_by, booking_source, booked_by_user_id</li>
                        <li><strong>Reschedule:</strong> rescheduled_at, rescheduled_by, reschedule_source, rescheduled_by_user_id, previous_starts_at</li>
                        <li><strong>Cancellation:</strong> cancelled_at, cancelled_by, cancellation_source, cancelled_by_user_id, cancellation_reason</li>
                    </ul>
                    <p style="margin-top: 15px;"><strong>Zweck:</strong> Vollst√§ndige Nachvollziehbarkeit wer/wann/woher jede Aktion kam!</p>
                </div>

                <h3>6.2 calls Table</h3>

                <table>
                    <thead>
                        <tr>
                            <th>Column</th>
                            <th>Type</th>
                            <th>Purpose</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>id</strong></td>
                            <td>bigint</td>
                            <td>Primary Key</td>
                        </tr>
                        <tr>
                            <td><strong>retell_call_id</strong></td>
                            <td>string</td>
                            <td>Retell Call ID (z.B. call_abc123)</td>
                        </tr>
                        <tr>
                            <td><strong>customer_id</strong></td>
                            <td>bigint</td>
                            <td>Verkn√ºpfung zu Customer</td>
                        </tr>
                        <tr>
                            <td><strong>from_number</strong></td>
                            <td>string</td>
                            <td>Telefonnummer Anrufer (f√ºr Anonymous Check!)</td>
                        </tr>
                        <tr style="background: #dcfce7;">
                            <td><strong>booking_confirmed</strong></td>
                            <td>boolean</td>
                            <td>Wurde Termin gebucht?</td>
                        </tr>
                        <tr style="background: #dcfce7;">
                            <td><strong>booking_id</strong></td>
                            <td>string</td>
                            <td>Cal.com Booking UID</td>
                        </tr>
                        <tr style="background: #dcfce7;">
                            <td><strong>session_outcome</strong></td>
                            <td>string</td>
                            <td>appointment_booked/appointment_cancelled/...</td>
                        </tr>
                    </tbody>
                </table>

                <div class="warning-box">
                    <strong style="color: #991b1b;">‚ö†Ô∏è WICHTIG:</strong><br>
                    <code>booking_status</code> Spalte existiert NICHT!<br>
                    Verwende stattdessen: <code>booking_confirmed</code> + <code>session_outcome</code>
                </div>
            </div>

            <!-- SECTION 7: ERROR SOURCES -->
            <div class="section" id="errors">
                <h2>7. Fehlerquellen - Alle m√∂glichen Probleme</h2>

                <h3>7.1 Timezone Fehler</h3>
                <div class="warning-box">
                    <h4 style="color: #991b1b;">‚ùå Symptom:</h4>
                    <p>User will 14:30 Uhr ‚Üí System sagt "16:30 ist verf√ºgbar" (FALSCH!)</p>

                    <h4 style="color: #991b1b; margin-top: 20px;">Root Cause:</h4>
                    <p>Cal.com Slot-Zeit nicht von UTC zu Europe/Berlin konvertiert</p>

                    <h4 style="color: #166534; margin-top: 20px;">‚úÖ Fix:</h4>
                    <div class="code-block" style="font-size: 0.85em;">
// √úBERALL wo $slot['time'] gelesen wird:
$slotTime = Carbon::parse($slot['time'])->setTimezone('Europe/Berlin');

// GEFIXT in 11 Locations - siehe git-changes.patch
                    </div>

                    <h4 style="color: #166534; margin-top: 20px;">‚úÖ Test:</h4>
                    <div class="code-block" style="font-size: 0.85em;">
$utc = Carbon::parse('2025-10-10T12:30:00.000Z');
$berlin = $utc->setTimezone('Europe/Berlin');
echo $berlin->format('H:i');  // Should be: 14:30
                    </div>
                </div>

                <h3>7.2 DateTime Parsing Fehler</h3>
                <div class="warning-box">
                    <h4 style="color: #991b1b;">‚ùå Symptom:</h4>
                    <p>User: "N√§chste Woche Montag" ‚Üí Agent: "Es gab ein Problem..."</p>

                    <h4 style="color: #991b1b; margin-top: 20px;">Root Cause (2 Probleme):</h4>
                    <ol style="margin-left: 25px; line-height: 2;">
                        <li>args nicht extrahiert ‚Üí 422 Validation Error</li>
                        <li>Pattern "n√§chste Woche Montag" nicht erkannt ‚Üí 400 Parse Error</li>
                    </ol>

                    <h4 style="color: #166534; margin-top: 20px;">‚úÖ Fix 1: args Extraction</h4>
                    <div class="code-block" style="font-size: 0.85em;">
// DateTimeInfoController.php:39-42
$args = $request->input('args', []);
$data = !empty($args) ? $args : $request->all();
$validated = validator($data, [...])->validate();
                    </div>

                    <h4 style="color: #166534; margin-top: 20px;">‚úÖ Fix 2: Neues Pattern</h4>
                    <div class="code-block" style="font-size: 0.85em;">
// DateTimeInfoController.php:124-132
if (preg_match('/^(n√§chste|diese)\s+woche\s+(montag|...|sonntag)$/i', ...)) {
    $modifier = $matches[1];
    $weekday = $matches[2];
    $date = $this->parser->parseRelativeWeekday($weekday, $modifier);
    return $this->formatSingleDate($date, "{$modifier} Woche {$weekday}");
}
                    </div>
                </div>

                <h3>7.3 Duplicate Detection Fehler</h3>
                <div class="warning-box">
                    <h4 style="color: #991b1b;">‚ùå Symptom:</h4>
                    <p>User bucht doppelt, oder System sagt "bereits gebucht" f√§lschlicherweise</p>

                    <h4 style="color: #166534; margin-top: 20px;">‚úÖ Wie es funktioniert:</h4>
                    <div class="code-block" style="font-size: 0.85em;">
// RetellFunctionCallHandler.php:1004-1047
$existingAppointment = Appointment::where('customer_id', $customer->id)
    ->whereDate('starts_at', $appointmentDate->format('Y-m-d'))
    ->whereTime('starts_at', $appointmentDate->format('H:i:s'))
    ->whereIn('status', ['scheduled', 'confirmed', 'booked'])
    ->first();

if ($existingAppointment) {
    // Generate weekday in German
    $weekdayName = $existingAppointment->starts_at->locale('de')->isoFormat('dddd');

    return {
        "status": "duplicate_detected",
        "message": "Ich sehe in meinem System, dass f√ºr Ihre Nummer
                    bereits {heute oder am $weekdayName, den $date}
                    um $time Uhr ein Termin eingetragen ist..."
    };
}
                    </div>
                </div>

                <h3>7.4 Cal.com Sync Fehler</h3>
                <div class="warning-box">
                    <h4 style="color: #991b1b;">‚ùå Symptom:</h4>
                    <p>DB hat Termin, aber Cal.com nicht (oder umgekehrt)</p>

                    <h4 style="color: #991b1b; margin-top: 20px;">Root Cause:</h4>
                    <p>Transaction nicht atomic - Cal.com first, DB second</p>

                    <h4 style="color: #166534; margin-top: 20px;">‚úÖ Fix: DB-First Strategy</h4>
                    <div class="code-block" style="font-size: 0.85em;">
// RetellApiController.php:699-787 (Cancellation example)

DB::beginTransaction();
try {
    // 1. Update DB first
    $appointment->update([...]);

    // 2. Create AppointmentModification
    AppointmentModification::create([...]);

    // 3. Update Call record
    Call::update([...]);

    DB::commit();
} catch (\Exception $e) {
    DB::rollBack();
    return error("DB update failed");
}

// 4. THEN sync to Cal.com (non-blocking)
try {
    $calcom->cancel($bookingId);
} catch (\Exception $e) {
    Log::warning('Cal.com sync failed, DB consistent');
    // Continue - DB ist Source of Truth!
}
                    </div>

                    <div class="success-box">
                        <strong>‚úÖ Vorteil:</strong><br>
                        - DB ist IMMER konsistent (rollback bei Fehler)<br>
                        - Cal.com Fehler blockiert nicht<br>
                        - Kann sp√§ter manuell nachsynchronisiert werden
                    </div>
                </div>

                <h3>7.5 Metadata Fehler</h3>
                <div class="warning-box">
                    <h4 style="color: #991b1b;">‚ùå Symptom:</h4>
                    <p>Appointment erstellt, aber created_by/booking_source = NULL</p>

                    <h4 style="color: #166534; margin-top: 20px;">‚úÖ Fix: Immer Metadata setzen!</h4>
                    <div class="code-block" style="font-size: 0.85em;">
// AppointmentCreationService.php:390-409
$appointment->forceFill([
    // ... standard fields ...
    'created_by' => 'customer',           // ‚úÖ IMMER setzen!
    'booking_source' => 'retell_webhook', // ‚úÖ IMMER setzen!
    'booked_by_user_id' => null,          // ‚úÖ NULL f√ºr customer
    // ...
]);

// Bei Reschedule:
$appointment->update([
    // ...
    'previous_starts_at' => $oldStartsAt,  // ‚úÖ Audit Trail!
    'rescheduled_at' => now(),
    'rescheduled_by' => 'customer',
    'reschedule_source' => 'retell_api',
    // ...
]);

// Bei Cancel:
$appointment->update([
    // ...
    'cancelled_at' => now(),
    'cancelled_by' => 'customer',
    'cancellation_source' => 'retell_api',
    'cancellation_reason' => $reason,
    // ...
]);
                    </div>
                </div>

                <h3>7.6 Anonymous Caller Security</h3>
                <div class="warning-box">
                    <h4 style="color: #991b1b;">‚ùå Risiko:</h4>
                    <p>Fremde Personen k√∂nnten Termine stornieren/verschieben!</p>

                    <h4 style="color: #166534; margin-top: 20px;">‚úÖ Schutz implementiert:</h4>
                    <div class="code-block" style="font-size: 0.85em;">
// RetellFunctionCallHandler.php:1716, 1889
if ($call && ($call->from_number === 'anonymous' ||
    in_array(strtolower($call->from_number ?? ''),
    ['anonymous', 'unknown', 'withheld', 'restricted', '']))) {

    // Cancel/Reschedule BLOCKIERT f√ºr Anonymous
    return $this->createAnonymousCallbackRequest($call, $params, $action);
}

// Booking ist ERLAUBT f√ºr Anonymous (neue Kunden!)
                    </div>

                    <div class="success-box">
                        <strong>Security Design:</strong>
                        <ul style="margin: 10px 0 10px 25px; line-height: 2;">
                            <li>‚úÖ Booking: Anonymous erlaubt (Gesch√§ftsanforderung)</li>
                            <li>üîí Cancel: Anonymous blockiert ‚Üí CallbackRequest</li>
                            <li>üîí Reschedule: Anonymous blockiert ‚Üí CallbackRequest</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- SECTION 8: TROUBLESHOOTING -->
            <div class="section" id="troubleshooting">
                <h2>8. Troubleshooting Guide - Schnell fixen</h2>

                <h3>Problem-Diagnose Matrix</h3>

                <table>
                    <thead>
                        <tr>
                            <th>Symptom</th>
                            <th>M√∂gliche Ursache</th>
                            <th>Wo pr√ºfen</th>
                            <th>Quick Fix</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>"Missing call_id in request"</td>
                            <td>Retell Function fehlt call_id Parameter</td>
                            <td>Retell Dashboard ‚Üí Functions</td>
                            <td>call_id als required hinzuf√ºgen</td>
                        </tr>
                        <tr>
                            <td>"Es gab ein Problem..." (DateTime)</td>
                            <td>getCurrentDateTimeInfo Validation/Parse Error</td>
                            <td>storage/logs/laravel.log ‚Üí 422/400</td>
                            <td>Pr√ºfe args extraction + Pattern</td>
                        </tr>
                        <tr>
                            <td>Falsche Uhrzeit (z.B. 16:30 statt 14:30)</td>
                            <td>Timezone nicht konvertiert</td>
                            <td>Code ‚Üí setTimezone() fehlt?</td>
                            <td>->setTimezone('Europe/Berlin') hinzuf√ºgen</td>
                        </tr>
                        <tr>
                            <td>"Donnerstag" statt "Freitag"</td>
                            <td>Wochentag falsch berechnet</td>
                            <td>Code ‚Üí locale('de')->isoFormat('dddd')</td>
                            <td>Korrekten Wochentag generieren</td>
                        </tr>
                        <tr>
                            <td>SQL Error "Column booking_status not found"</td>
                            <td>Spalte existiert nicht</td>
                            <td>Code versucht booking_status zu setzen</td>
                            <td>Nutze booking_confirmed + session_outcome</td>
                        </tr>
                        <tr>
                            <td>Duplicate trotz freiem Slot</td>
                            <td>Existierender Termin zur gleichen Zeit</td>
                            <td>DB ‚Üí appointments f√ºr Customer + Datum/Zeit</td>
                            <td>Normal - biete Optionen (keep/reschedule/additional)</td>
                        </tr>
                        <tr>
                            <td>DB hat Termin, Cal.com nicht</td>
                            <td>Cal.com API Fehler nach DB Insert</td>
                            <td>Logs ‚Üí Cal.com API Response</td>
                            <td>Manuell in Cal.com nachbuchen</td>
                        </tr>
                        <tr>
                            <td>Metadata Spalten = NULL</td>
                            <td>Code setzt Metadata nicht</td>
                            <td>AppointmentCreationService.php:402-404</td>
                            <td>created_by, booking_source setzen</td>
                        </tr>
                    </tbody>
                </table>

                <h3>8.1 Log-Analyse</h3>

                <div class="code-block">
# Fehler der letzten Stunde finden:
tail -1000 storage/logs/laravel.log | grep -E "ERROR|CRITICAL|Exception"

# Spezifischen Call analysieren:
grep "call_abc123" storage/logs/laravel.log

# Timezone-Probleme finden:
grep "setTimezone\|UTC\|CEST" storage/logs/laravel.log

# Metadata-Probleme finden:
grep "created_by\|booking_source\|cancelled_by" storage/logs/laravel.log

# Cal.com API Errors:
grep "Cal.com.*error\|Cal.com.*fail" storage/logs/laravel.log
                </div>

                <h3>8.2 Database Debugging</h3>

                <div class="code-block">
# Letzten Appointment pr√ºfen:
SELECT id, starts_at, created_by, booking_source, calcom_v2_booking_id
FROM appointments ORDER BY id DESC LIMIT 1;

# Metadata Vollst√§ndigkeit pr√ºfen:
SELECT
  id,
  CASE WHEN created_by IS NULL THEN '‚ùå' ELSE '‚úÖ' END as has_created_by,
  CASE WHEN booking_source IS NULL THEN '‚ùå' ELSE '‚úÖ' END as has_source
FROM appointments
WHERE created_at > NOW() - INTERVAL 1 HOUR;

# Timezone pr√ºfen:
SELECT id, starts_at,
  TIME_FORMAT(starts_at, '%H:%i') as time,
  TIMESTAMPDIFF(HOUR, UTC_TIMESTAMP(), starts_at) as offset_hours
FROM appointments
WHERE id = [ID];
-- offset_hours sollte +1 oder +2 sein (je nach Sommerzeit)

# Duplicate Check simulieren:
SELECT *
FROM appointments
WHERE customer_id = [ID]
  AND DATE(starts_at) = '2025-10-13'
  AND TIME(starts_at) = '14:00:00'
  AND status IN ('scheduled', 'confirmed', 'booked');
                </div>

                <h3>8.3 Retell Function Debugging</h3>

                <div class="info-box">
                    <h4 style="color: #1e40af; margin-bottom: 15px;">üîç Retell Public Log analysieren</h4>
                    <p>Jeder Call hat einen Public Log URL in der Retell Response:</p>
                    <div class="code-block" style="font-size: 0.85em; margin-top: 10px;">
# Aus Call Record holen:
$call = Call::latest()->first();
echo $call->raw['public_log_url'] ?? 'N/A';

# Beispiel:
https://dxc03zgurdly9.cloudfront.net/[hash]/public.log

# Im Log sichtbar:
- Alle Tool Calls mit Arguments
- Alle Tool Call Results
- Error Messages
- Latency per step
                    </div>
                </div>

                <h3>8.4 Quick Fix Checklist</h3>

                <div class="checklist">
                    <h4 style="margin-bottom: 20px;">Bei Booking-Problemen pr√ºfe:</h4>
                    <div class="checklist-item">Logs: Sind Fehler in storage/logs/laravel.log?</div>
                    <div class="checklist-item">Retell Public Log: Tool Call Errors?</div>
                    <div class="checklist-item">Database: Wurde Appointment erstellt?</div>
                    <div class="checklist-item">Cal.com: Existiert Booking dort?</div>
                    <div class="checklist-item">Metadata: Sind created_by/booking_source gesetzt?</div>
                    <div class="checklist-item">Timezone: UTC korrekt zu Europe/Berlin konvertiert?</div>
                    <div class="checklist-item">Retell Functions: Haben ALLE call_id Parameter?</div>
                    <div class="checklist-item">Customer: Wurde korrekt per phone matched?</div>
                </div>
            </div>

            <!-- SECTION: CRITICAL PATHS -->
            <div class="section">
                <h2>9. Kritische Code-Pfade - Nicht anfassen ohne Tests!</h2>

                <div class="critical-point">
                    <h3 style="color: #92400e; margin-bottom: 20px;">‚ö†Ô∏è HIGH-RISK Bereiche</h3>

                    <table style="margin-top: 20px;">
                        <thead>
                            <tr>
                                <th>File:Line</th>
                                <th>Was macht es</th>
                                <th>Warum kritisch</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>RetellFunctionCallHandler:894-920</td>
                                <td>Datum Parsing + Timezone</td>
                                <td>Falsche Timezone = falsche Termine!</td>
                            </tr>
                            <tr>
                                <td>RetellFunctionCallHandler:1095-1108</td>
                                <td>Cal.com Slot Matching</td>
                                <td>Timezone Conversion muss stimmen!</td>
                            </tr>
                            <tr>
                                <td>AppointmentCreationService:388-409</td>
                                <td>Appointment DB Insert</td>
                                <td>Metadata muss komplett sein!</td>
                            </tr>
                            <tr>
                                <td>RetellApiController:699-787</td>
                                <td>Cancellation Transaction</td>
                                <td>DB-first Logic darf nicht ge√§ndert werden!</td>
                            </tr>
                            <tr>
                                <td>DateTimeInfoController:124-132</td>
                                <td>"n√§chste Woche Montag" Pattern</td>
                                <td>Pattern-Reihenfolge wichtig!</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="warning-box" style="margin-top: 25px;">
                        <strong style="font-size: 1.2em; color: #991b1b;">üö® GOLDEN RULE:</strong><br>
                        <p style="font-size: 1.1em; margin-top: 10px; line-height: 2;">
                            Vor JEDER √Ñnderung in diesen Bereichen:<br>
                            1. Golden Backup erstellen<br>
                            2. Alle 28 Tests laufen lassen<br>
                            3. √Ñnderung machen<br>
                            4. Tests erneut laufen<br>
                            5. Wenn 1 Test fails ‚Üí ROLLBACK!
                        </p>
                    </div>
                </div>
            </div>

            <!-- SECTION: TESTING -->
            <div class="section">
                <h2>10. Testing vor Deployment</h2>

                <h3>Automated Test Suite</h3>
                <div class="code-block">
# Alle Business-Critical Tests:
php tests/automated/comprehensive_e2e_test_suite.php

# Expected: ALL TESTS PASSED (28/28)
# If ANY fail: DEPLOYMENT BLOCKED!
                </div>

                <h3>Manual Test Scenarios</h3>

                <div class="checklist">
                    <div class="checklist-item">Test: "N√§chste Woche Montag 14 Uhr Termin"</div>
                    <div class="checklist-item">Verify: Kein "Es gab ein Problem"</div>
                    <div class="checklist-item">Verify: Datum korrekt (2025-10-20)</div>
                    <div class="checklist-item">Verify: Termin gebucht in DB</div>
                    <div class="checklist-item">Verify: Metadata gesetzt (created_by, booking_source)</div>
                    <div class="checklist-item">Verify: Cal.com hat Booking</div>
                    <div class="checklist-item">Test: Duplicate Detection funktioniert</div>
                    <div class="checklist-item">Test: Stornierung >24h funktioniert</div>
                    <div class="checklist-item">Test: Stornierung <24h wird verweigert</div>
                </div>
            </div>

            <!-- FOOTER -->
            <div style="background: #f9fafb; padding: 50px; text-align: center; border-top: 4px solid #e5e7eb;">
                <h3 style="color: #667eea; margin-bottom: 25px;">üìö Related Documentation</h3>
                <p style="line-height: 2.5; font-size: 1.1em; color: #666;">
                    <strong>Golden Backup:</strong> backups/golden-backup-2025-10-10/<br>
                    <strong>Test Playbook:</strong> BUSINESS_CRITICAL_TEST_PLAYBOOK.md<br>
                    <strong>Deployment Report:</strong> DEPLOYMENT_READY_REPORT_2025-10-10.md<br>
                    <strong>Bug Fixes:</strong> FINAL_BUG_FIX_SUMMARY_2025-10-10.md
                </p>

                <div style="margin-top: 40px; padding: 30px; background: linear-gradient(135deg, #dcfce7 0%, #86efac 100%); border-radius: 15px;">
                    <p style="font-size: 1.5em; color: #166534; font-weight: bold;">
                        ‚úÖ Booking Process ist jetzt bombensicher dokumentiert!<br>
                        üéØ Score: 99/100<br>
                        üöÄ Production Ready!
                    </p>
                </div>

                <p style="color: #9ca3af; margin-top: 30px;">
                    Documentation Version: 1.0<br>
                    Created: 2025-10-10 17:20 Uhr<br>
                    Status: Complete & Production Ready
                </p>
            </div>
        </div>
    </div>

    <script>
        // Smooth scrolling for TOC
        document.querySelectorAll('.toc-item').forEach(item => {
            item.addEventListener('click', function() {
                const target = this.getAttribute('onclick').match(/#[\w-]+/)[0];
                document.querySelector(target).scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            });
        });
    </script>
</body>
</html>

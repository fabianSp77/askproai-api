<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backend API Tester V4 - Multi-Tenant E2E</title>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Prism.js for Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>

    <style>
        [x-cloak] { display: none !important; }

        .type-error {
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0%, 100% { background-color: #FEE2E2; }
            50% { background-color: #FCA5A5; }
        }

        .gradient-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen" x-data="apiTesterV4()" x-cloak>

    <!-- Top Navigation -->
    <nav class="gradient-header border-b border-blue-800 sticky top-0 z-50 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-white">Backend API Tester V4</h1>
                    <span class="ml-3 px-3 py-1 text-xs font-medium bg-white text-blue-600 rounded-full">Multi-Tenant E2E</span>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Export Button -->
                    <button @click="exportResults()"
                            :disabled="!flowCompleted && !extractedVariables"
                            class="px-4 py-2 text-sm font-semibold bg-white text-blue-600 rounded-lg hover:bg-blue-50 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2">
                        <span>üìã</span>
                        <span>Export Results</span>
                    </button>
                    <span class="text-sm text-blue-100">Multi-Tenant Testing</span>
                    <span class="px-2 py-1 text-xs font-mono bg-blue-800 text-blue-100 rounded">v4.0.0</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-6">

        <!-- üè¢ Multi-Tenant Configuration (NEW V4!) -->
        <div class="bg-gradient-to-r from-purple-500 to-blue-600 rounded-lg shadow-lg border border-purple-200 p-6 text-white">
            <h3 class="text-lg font-bold mb-4 flex items-center">
                <span class="text-2xl mr-2">üè¢</span>
                Multi-Tenant Konfiguration
            </h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-purple-100 mb-2">Unternehmen (Company ID)</label>
                    <select x-model="companyId"
                            @change="updateTenantContext()"
                            class="w-full px-4 py-2 bg-white/20 backdrop-blur border border-white/30 rounded-lg text-white focus:ring-2 focus:ring-white focus:border-transparent">
                        <option value="1">Company 1 - Friseur 1</option>
                        <option value="2">Company 2</option>
                        <option value="3">Company 3</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-purple-100 mb-2">Filiale (Branch ID)</label>
                    <input type="text"
                           x-model="branchId"
                           @input="updateTenantContext()"
                           placeholder="34c4d48e-4753-4715-9c30-c55843a943e8"
                           class="w-full px-4 py-2 bg-white/20 backdrop-blur border border-white/30 rounded-lg text-white placeholder-purple-200 focus:ring-2 focus:ring-white focus:border-transparent font-mono text-sm">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-purple-100 mb-2">Phone Number ID</label>
                    <input type="text"
                           x-model="phoneNumberId"
                           placeholder="5b449e91-5376-11f0-b773-0ad77e7a9793"
                           class="w-full px-4 py-2 bg-white/20 backdrop-blur border border-white/30 rounded-lg text-white placeholder-purple-200 focus:ring-2 focus:ring-white focus:border-transparent font-mono text-sm">
                </div>

                <div>
                    <label class="block text-sm font-medium text-purple-100 mb-2">To Number (Branch Phone)</label>
                    <input type="text"
                           x-model="toNumber"
                           placeholder="+493033081738"
                           class="w-full px-4 py-2 bg-white/20 backdrop-blur border border-white/30 rounded-lg text-white placeholder-purple-200 focus:ring-2 focus:ring-white focus:border-transparent">
                </div>
            </div>

            <div class="mt-4 p-4 bg-black/20 backdrop-blur rounded-lg border border-white/30">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-semibold text-white">
                            Aktiver Context: Company <span class="font-mono bg-white/20 px-2 py-1 rounded" x-text="companyId"></span>
                        </p>
                        <p class="text-xs text-purple-100 mt-1">
                            Branch: <span class="font-mono" x-text="branchId.substring(0, 13) + '...'"></span>
                        </p>
                    </div>
                    <div class="text-right">
                        <span class="inline-block px-3 py-1 bg-green-500 text-white text-xs font-bold rounded-full">
                            ‚úì Multi-Tenant Aktiv
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- üìû Caller Type Selection -->
        <div class="bg-white rounded-lg shadow-lg border border-gray-200 p-6">
            <h3 class="text-sm font-semibold text-gray-900 mb-4">üìû Anrufer-Typ w√§hlen</h3>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Known Customer -->
                <button @click="setCallerType('known')"
                        class="p-6 border-2 rounded-xl transition-all transform hover:scale-105"
                        :class="callerType === 'known' ? 'border-blue-500 bg-blue-50 shadow-lg' : 'border-gray-200 hover:border-gray-300'">
                    <div class="flex items-center justify-center mb-3">
                        <span class="text-4xl">üë§</span>
                    </div>
                    <h4 class="font-bold text-sm text-gray-900 mb-1">Bestandskunde</h4>
                    <p class="text-xs text-gray-600 mb-2">mit Caller ID</p>
                    <code class="text-xs text-blue-700 font-mono">+49 160 4366 218</code>
                    <p class="text-xs text-gray-500 mt-2">Hans Schuster</p>
                    <div x-show="callerType === 'known'" class="mt-3 flex items-center justify-center">
                        <span class="px-3 py-1 text-xs font-semibold bg-blue-600 text-white rounded-full">‚úì Aktiv</span>
                    </div>
                </button>

                <!-- New Customer -->
                <button @click="setCallerType('new')"
                        class="p-6 border-2 rounded-xl transition-all transform hover:scale-105"
                        :class="callerType === 'new' ? 'border-green-500 bg-green-50 shadow-lg' : 'border-gray-200 hover:border-gray-300'">
                    <div class="flex items-center justify-center mb-3">
                        <span class="text-4xl">‚ú®</span>
                    </div>
                    <h4 class="font-bold text-sm text-gray-900 mb-1">Neukunde</h4>
                    <p class="text-xs text-gray-600 mb-2">mit Caller ID</p>
                    <code class="text-xs text-green-700 font-mono">+49 151 9999 999</code>
                    <p class="text-xs text-gray-500 mt-2">Max Mustermann</p>
                    <div x-show="callerType === 'new'" class="mt-3 flex items-center justify-center">
                        <span class="px-3 py-1 text-xs font-semibold bg-green-600 text-white rounded-full">‚úì Aktiv</span>
                    </div>
                </button>

                <!-- Anonymous Caller -->
                <button @click="setCallerType('anonymous')"
                        class="p-6 border-2 rounded-xl transition-all transform hover:scale-105"
                        :class="callerType === 'anonymous' ? 'border-orange-500 bg-orange-50 shadow-lg' : 'border-gray-200 hover:border-gray-300'">
                    <div class="flex items-center justify-center mb-3">
                        <span class="text-4xl">üîí</span>
                    </div>
                    <h4 class="font-bold text-sm text-gray-900 mb-1">Anonymous Caller</h4>
                    <p class="text-xs text-gray-600 mb-2">Rufnummer unterdr√ºckt</p>
                    <code class="text-xs text-orange-700 font-mono">"anonymous"</code>
                    <p class="text-xs text-gray-500 mt-2">Unbekannt</p>
                    <div x-show="callerType === 'anonymous'" class="mt-3 flex items-center justify-center">
                        <span class="px-3 py-1 text-xs font-semibold bg-orange-600 text-white rounded-full">‚úì Aktiv</span>
                    </div>
                </button>
            </div>

            <!-- Expected Behavior -->
            <div class="mt-6 p-4 rounded-lg border-2"
                 :class="{
                     'bg-blue-50 border-blue-200': callerType === 'known',
                     'bg-green-50 border-green-200': callerType === 'new',
                     'bg-orange-50 border-orange-200': callerType === 'anonymous'
                 }">
                <h4 class="text-xs font-semibold mb-2"
                    :class="{
                        'text-blue-900': callerType === 'known',
                        'text-green-900': callerType === 'new',
                        'text-orange-900': callerType === 'anonymous'
                    }">
                    ‚úì Erwartetes Verhalten:
                </h4>

                <!-- Known Customer -->
                <div x-show="callerType === 'known'" class="text-xs text-blue-800 space-y-1">
                    <p>‚Ä¢ <code class="bg-white px-2 py-0.5 rounded">from_number</code>: +491604366218</p>
                    <p>‚Ä¢ <code class="bg-white px-2 py-0.5 rounded">customer_found</code>: <strong>true</strong></p>
                    <p>‚Ä¢ <code class="bg-white px-2 py-0.5 rounded">predicted_service</code>: "30 Minuten Termin Standard"</p>
                    <p>‚Ä¢ <strong>Greeting</strong>: "Guten Tag! M√∂chten Sie wieder einen 30 Minuten Termin buchen?"</p>
                </div>

                <!-- New Customer -->
                <div x-show="callerType === 'new'" class="text-xs text-green-800 space-y-1">
                    <p>‚Ä¢ <code class="bg-white px-2 py-0.5 rounded">from_number</code>: +491519999999</p>
                    <p>‚Ä¢ <code class="bg-white px-2 py-0.5 rounded">customer_found</code>: <strong>false</strong></p>
                    <p>‚Ä¢ <strong>Greeting</strong>: "Wie kann ich Ihnen helfen?"</p>
                </div>

                <!-- Anonymous Caller -->
                <div x-show="callerType === 'anonymous'" class="text-xs text-orange-800 space-y-1">
                    <p>‚Ä¢ <code class="bg-white px-2 py-0.5 rounded">from_number</code>: <strong>"anonymous"</strong></p>
                    <p>‚Ä¢ <code class="bg-white px-2 py-0.5 rounded">customer_found</code>: <strong>false</strong></p>
                    <p>‚Ä¢ <strong>Greeting</strong>: "Wie kann ich Ihnen helfen?"</p>
                    <p class="mt-2 font-semibold">‚ö†Ô∏è Flow MUSS weiterlaufen (kein Type Mismatch!)</p>
                </div>
            </div>
        </div>

        <!-- ‚ö° Quick Test + E2E Flow -->
        <div class="bg-white rounded-lg shadow-lg border border-gray-200 p-6">
            <h3 class="text-sm font-semibold text-gray-900 mb-4">‚ö° Tests ausf√ºhren</h3>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <button @click="quickTest('check_customer')" :disabled="loading"
                        class="p-4 border border-gray-200 rounded-lg hover:border-blue-400 hover:bg-blue-50 transition-all disabled:opacity-50">
                    <div class="text-2xl mb-2">üîç</div>
                    <h4 class="font-semibold text-sm">check_customer</h4>
                    <p class="text-xs text-gray-600 mt-1">Kunde identifizieren</p>
                </button>

                <button @click="quickTest('check_availability')" :disabled="loading"
                        class="p-4 border border-gray-200 rounded-lg hover:border-blue-400 hover:bg-blue-50 transition-all disabled:opacity-50">
                    <div class="text-2xl mb-2">üìÖ</div>
                    <h4 class="font-semibold text-sm">check_availability</h4>
                    <p class="text-xs text-gray-600 mt-1">Verf√ºgbarkeit pr√ºfen</p>
                </button>

                <button @click="quickTest('start_booking')" :disabled="loading"
                        class="p-4 border border-gray-200 rounded-lg hover:border-blue-400 hover:bg-blue-50 transition-all disabled:opacity-50">
                    <div class="text-2xl mb-2">‚úÖ</div>
                    <h4 class="font-semibold text-sm">start_booking</h4>
                    <p class="text-xs text-gray-600 mt-1">Termin buchen</p>
                </button>

                <button @click="runFullFlow()" :disabled="flowRunning || loading"
                        class="p-4 border-2 border-green-500 bg-green-50 rounded-lg hover:bg-green-100 transition-all disabled:opacity-50">
                    <div class="text-2xl mb-2">üöÄ</div>
                    <h4 class="font-bold text-sm text-green-900">Kompletter E2E Flow</h4>
                    <p class="text-xs text-green-700 mt-1">Multi-Tenant Test</p>
                </button>
            </div>
        </div>

        <!-- üß¨ Variable Extraction -->
        <div x-show="extractedVariables" class="bg-white rounded-lg shadow-lg border border-gray-200 p-6">
            <h3 class="text-sm font-semibold text-gray-900 mb-4">üß¨ Extrahierte Variablen (Flow Simulation)</h3>

            <div class="overflow-x-auto">
                <table class="w-full text-xs">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-4 py-2 text-left font-semibold text-gray-700">Variable</th>
                            <th class="px-4 py-2 text-left font-semibold text-gray-700">Wert</th>
                            <th class="px-4 py-2 text-left font-semibold text-gray-700">Typ</th>
                            <th class="px-4 py-2 text-left font-semibold text-gray-700">Validation</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        <template x-for="(value, key) in extractedVariables" :key="key">
                            <tr>
                                <td class="px-4 py-2 font-mono text-gray-900" x-text="key"></td>
                                <td class="px-4 py-2">
                                    <code class="text-gray-700" x-text="JSON.stringify(value)"></code>
                                </td>
                                <td class="px-4 py-2">
                                    <span class="px-2 py-1 rounded font-mono text-xs"
                                          :class="getTypeClass(key, value)"
                                          x-text="typeof value"></span>
                                </td>
                                <td class="px-4 py-2">
                                    <span x-show="isValidType(key, value)" class="text-green-600 font-semibold">‚úì OK</span>
                                    <span x-show="!isValidType(key, value)" class="text-red-600 font-semibold">‚úó Type Mismatch!</span>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- Type Errors -->
            <div x-show="variableTypeErrors.length > 0" class="mt-4 p-4 bg-red-50 border-2 border-red-300 rounded-lg">
                <h4 class="text-sm font-bold text-red-900 mb-2">‚ö†Ô∏è Type Errors gefunden!</h4>
                <ul class="space-y-2">
                    <template x-for="error in variableTypeErrors" :key="error.field">
                        <li class="text-xs text-red-800">
                            <code class="bg-white px-2 py-1 rounded font-mono" x-text="error.field"></code>:
                            Expected <strong x-text="error.expected"></strong>, got <strong x-text="error.actual"></strong>
                        </li>
                    </template>
                </ul>
            </div>
        </div>

        <!-- üí¨ Flow Decision -->
        <div x-show="flowDecision" class="bg-white rounded-lg shadow-lg border border-gray-200 p-6">
            <h3 class="text-sm font-semibold text-gray-900 mb-4">üí¨ Flow Decision (Was Agent tun w√ºrde)</h3>

            <div class="space-y-4">
                <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <h4 class="text-xs font-semibold text-blue-900 mb-2">Agent w√ºrde sagen:</h4>
                    <p class="text-sm text-blue-800 font-medium italic" x-text="flowDecision.greeting"></p>
                </div>

                <div class="grid grid-cols-3 gap-4 text-xs">
                    <div class="p-3 bg-gray-50 rounded">
                        <span class="text-gray-500">Grund:</span>
                        <p class="mt-1 font-semibold text-gray-900" x-text="flowDecision.reason"></p>
                    </div>
                    <div class="p-3 bg-gray-50 rounded">
                        <span class="text-gray-500">Current Node:</span>
                        <p class="mt-1 font-mono text-gray-900" x-text="flowDecision.node"></p>
                    </div>
                    <div class="p-3 bg-gray-50 rounded">
                        <span class="text-gray-500">Next Node:</span>
                        <p class="mt-1 font-mono text-gray-900" x-text="flowDecision.nextNode"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- üîÑ E2E Flow Steps -->
        <div x-show="flowRunning || flowCompleted" class="bg-white rounded-lg shadow-lg border border-gray-200 p-6">
            <h3 class="text-sm font-semibold text-gray-900 mb-6">üîÑ Flow-Schritte (E2E Multi-Tenant Test)</h3>

            <div class="space-y-4">
                <template x-for="(step, index) in flowSteps" :key="index">
                    <div class="relative pl-8 pb-6 border-l-2"
                         :class="{
                             'border-green-400': step.status === 'completed',
                             'border-blue-400 animate-pulse': step.status === 'running',
                             'border-gray-300': step.status === 'pending',
                             'border-red-400': step.status === 'failed'
                         }">

                        <div class="absolute left-[-6px] top-0 w-4 h-4 rounded-full border-2 border-white"
                             :class="{
                                 'bg-green-500': step.status === 'completed',
                                 'bg-blue-500': step.status === 'running',
                                 'bg-gray-300': step.status === 'pending',
                                 'bg-red-500': step.status === 'failed'
                             }"></div>

                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="text-sm font-medium text-gray-900" x-text="(index + 1) + '. ' + step.name"></h4>
                                <p class="text-xs text-gray-500 mt-1" x-text="step.description"></p>

                                <template x-if="step.result && Object.keys(step.result).length > 0">
                                    <details class="mt-3">
                                        <summary class="text-xs text-blue-600 cursor-pointer hover:text-blue-800">Response anzeigen</summary>
                                        <div class="mt-2 p-3 bg-gray-900 rounded-lg overflow-x-auto">
                                            <pre class="text-xs"><code class="language-json text-white" x-text="JSON.stringify(step.result, null, 2)"></code></pre>
                                        </div>
                                    </details>
                                </template>
                            </div>

                            <div class="ml-4 flex items-center space-x-2">
                                <span class="px-3 py-1 text-xs font-semibold rounded-full"
                                      :class="{
                                          'bg-green-100 text-green-800': step.status === 'completed',
                                          'bg-blue-100 text-blue-800': step.status === 'running',
                                          'bg-gray-100 text-gray-600': step.status === 'pending',
                                          'bg-red-100 text-red-800': step.status === 'failed'
                                      }"
                                      x-text="step.status"></span>
                                <span x-show="step.duration" class="text-xs text-gray-500 font-mono" x-text="step.duration + 'ms'"></span>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Summary -->
            <template x-if="flowCompleted">
                <div class="mt-6 p-5 rounded-lg border-2"
                     :class="flowSuccess ? 'bg-green-50 border-green-300' : 'bg-red-50 border-red-300'">
                    <h3 class="text-base font-bold mb-2"
                        :class="flowSuccess ? 'text-green-800' : 'text-red-800'">
                        <span x-show="flowSuccess">‚úÖ Flow erfolgreich abgeschlossen</span>
                        <span x-show="!flowSuccess">‚ùå Flow fehlgeschlagen</span>
                    </h3>
                    <p class="text-sm" :class="flowSuccess ? 'text-green-700' : 'text-red-700'" x-text="flowSummary"></p>
                    <p class="text-xs mt-2" :class="flowSuccess ? 'text-green-600' : 'text-red-600'">
                        Company <span x-text="companyId"></span>, Branch <span class="font-mono" x-text="branchId.substring(0, 8) + '...'"></span>
                    </p>
                </div>
            </template>
        </div>

    </div>

    <script>
        function apiTesterV4() {
            return {
                // Multi-Tenant Configuration (NEW V4!)
                companyId: 1,
                branchId: '34c4d48e-4753-4715-9c30-c55843a943e8',
                phoneNumberId: '5b449e91-5376-11f0-b773-0ad77e7a9793',
                toNumber: '+493033081738',

                // State
                callerType: 'known',
                loading: false,
                response: null,

                // Call Record
                currentCallId: null,
                callRecord: null,

                // Extracted Variables
                extractedVariables: null,
                variableTypeErrors: [],

                // Flow Decision
                flowDecision: null,

                // E2E Flow
                flowRunning: false,
                flowCompleted: false,
                flowSuccess: false,
                flowSummary: '',
                flowSteps: [],

                // Caller Types Configuration
                callerTypes: {
                    known: {
                        phone: '+491604366218',
                        name: 'Hans Schuster',
                        from_number: '+491604366218',
                        email: 'hans@example.com'
                    },
                    new: {
                        phone: '+491519999999',
                        name: 'Max Mustermann',
                        from_number: '+491519999999',
                        email: 'max@example.com'
                    },
                    anonymous: {
                        phone: null,
                        name: 'Anonymous User',
                        from_number: 'anonymous',
                        email: null
                    }
                },

                init() {
                    this.setCallerType('known');
                },

                updateTenantContext() {
                    console.log('Tenant context updated:', {
                        companyId: this.companyId,
                        branchId: this.branchId,
                        phoneNumberId: this.phoneNumberId
                    });
                },

                setCallerType(type) {
                    this.callerType = type;
                    this.response = null;
                    this.flowCompleted = false;
                    this.currentCallId = null;
                    this.callRecord = null;
                    this.extractedVariables = null;
                    this.flowDecision = null;
                    this.variableTypeErrors = [];
                },

                getCurrentCaller() {
                    return this.callerTypes[this.callerType];
                },

                // Variable Extraction
                extractVariables(checkCustomerResponse) {
                    const customer = checkCustomerResponse.customer || {};

                    this.extractedVariables = {
                        customer_found: checkCustomerResponse.customer_found ?? false,
                        predicted_service: customer.predicted_service ?? null,
                        service_confidence: customer.service_confidence ?? 0.0,
                        preferred_staff: customer.preferred_staff ?? null,
                        preferred_staff_id: customer.preferred_staff_id ?? null
                    };

                    // Type Validation
                    this.variableTypeErrors = [];

                    if (typeof this.extractedVariables.customer_found !== 'boolean') {
                        this.variableTypeErrors.push({
                            field: 'customer_found',
                            expected: 'boolean',
                            actual: typeof this.extractedVariables.customer_found,
                            value: this.extractedVariables.customer_found
                        });
                    }

                    if (typeof this.extractedVariables.service_confidence !== 'number') {
                        this.variableTypeErrors.push({
                            field: 'service_confidence',
                            expected: 'number',
                            actual: typeof this.extractedVariables.service_confidence,
                            value: this.extractedVariables.service_confidence
                        });
                    }

                    return {
                        extracted: this.extractedVariables,
                        typeErrors: this.variableTypeErrors,
                        validation: this.variableTypeErrors.length === 0 ? 'PASS' : 'FAIL'
                    };
                },

                isValidType(key, value) {
                    const expectedTypes = {
                        customer_found: 'boolean',
                        service_confidence: 'number',
                        predicted_service: ['string', 'object'],
                        preferred_staff: ['string', 'object'],
                        preferred_staff_id: ['string', 'object', 'number']
                    };

                    const expected = expectedTypes[key];
                    if (!expected) return true;

                    const actualType = typeof value;
                    if (Array.isArray(expected)) {
                        return expected.includes(actualType);
                    }
                    return actualType === expected;
                },

                getTypeClass(key, value) {
                    const valid = this.isValidType(key, value);
                    return valid ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800 type-error';
                },

                // Flow Decision
                determineFlowDecision(variables) {
                    if (variables.customer_found === true && variables.service_confidence >= 0.8) {
                        return {
                            greeting: `Guten Tag! M√∂chten Sie wieder einen ${variables.predicted_service} buchen?`,
                            reason: 'Bestandskunde + hohe Service-Confidence (‚â•0.8)',
                            node: 'node_personalized_greeting',
                            nextNode: 'intent_router'
                        };
                    } else if (variables.customer_found === true) {
                        return {
                            greeting: 'Guten Tag! Sch√∂n dass Sie wieder anrufen. Wie kann ich Ihnen heute helfen?',
                            reason: 'Bestandskunde ohne klare Service-Pr√§ferenz (<0.8)',
                            node: 'node_personalized_greeting',
                            nextNode: 'intent_router'
                        };
                    } else {
                        return {
                            greeting: 'Wie kann ich Ihnen helfen?',
                            reason: 'Neukunde oder Anonymous Caller',
                            node: 'node_personalized_greeting',
                            nextNode: 'intent_router'
                        };
                    }
                },

                // Quick Test
                async quickTest(testType) {
                    const caller = this.getCurrentCaller();
                    const callId = 'test_' + Date.now();

                    // Create call record first
                    await this.createCallRecord(callId, caller);

                    if (testType === 'check_customer') {
                        await this.runTest('/api/webhooks/retell/check-customer', {
                            call: { call_id: callId },
                            args: {}
                        });

                        if (this.response && this.response.data) {
                            const extracted = this.extractVariables(this.response.data);
                            this.flowDecision = this.determineFlowDecision(this.extractedVariables);
                        }
                    }

                    if (testType === 'check_availability') {
                        await this.runTest('/api/webhooks/retell/function', {
                            name: 'check_availability',
                            call: { call_id: callId },
                            args: {
                                datum: 'morgen',
                                uhrzeit: '10:00',
                                dienstleistung: 'Herrenhaarschnitt'
                            }
                        });
                    }

                    if (testType === 'start_booking') {
                        // First check availability to get an actually available slot
                        const availRes = await fetch('/api/webhooks/retell/function', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                name: 'check_availability',
                                call: { call_id: callId },
                                args: {
                                    datum: 'morgen',
                                    uhrzeit: '10:00',
                                    dienstleistung: 'Herrenhaarschnitt'
                                }
                            })
                        });
                        const availData = await availRes.json();

                        // Extract first available slot
                        let slotToBook = '10:00'; // fallback
                        if (availData.success) {
                            // Handle both response formats (direct and nested)
                            const responseData = availData.data || availData;
                            const slots = responseData.available_slots ||
                                         (responseData.alternatives || []).map(alt => alt.time.split(' ')[1]);
                            if (slots && slots.length > 0) {
                                slotToBook = slots[0];
                            }
                        }

                        await this.runTest('/api/webhooks/retell/function', {
                            name: 'start_booking',
                            call: { call_id: callId },
                            args: {
                                datetime: `2025-11-20 ${slotToBook}`,
                                service_name: 'Herrenhaarschnitt',
                                customer_name: caller.name,
                                customer_email: caller.email || undefined,
                                customer_phone: caller.phone || undefined
                            }
                        });
                    }

                    // Cleanup
                    await this.cleanupTestCall(callId);
                },

                // Create Call Record (Multi-Tenant)
                async createCallRecord(callId, caller) {
                    const res = await fetch('/api/test/create-call-record', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            call_id: callId,
                            from_number: caller.from_number,
                            to_number: this.toNumber,
                            company_id: this.companyId,
                            branch_id: this.branchId,
                            phone_number_id: this.phoneNumberId
                        })
                    });
                    return await res.json();
                },

                // Full E2E Flow
                async runFullFlow() {
                    this.flowRunning = true;
                    this.flowCompleted = false;
                    this.flowSuccess = false;
                    this.response = null;
                    this.extractedVariables = null;
                    this.flowDecision = null;
                    this.variableTypeErrors = [];

                    const caller = this.getCurrentCaller();
                    const callId = 'flow_test_' + Date.now();
                    this.currentCallId = callId;

                    this.flowSteps = [
                        { name: 'üóÑÔ∏è Create Call Record (DB)', description: `Multi-Tenant: Company ${this.companyId}`, status: 'pending', result: null, duration: null },
                        { name: 'üéØ get_current_context', description: 'Lade aktuelles Datum/Zeit', status: 'pending', result: null, duration: null },
                        { name: 'üë§ check_customer', description: 'Customer Recognition', status: 'pending', result: null, duration: null },
                        { name: 'üß¨ Variable Extraction', description: 'Simulate extract_dynamic_variables', status: 'pending', result: null, duration: null },
                        { name: 'üí¨ Flow Decision', description: 'Determine agent greeting', status: 'pending', result: null, duration: null },
                        { name: 'üìÖ check_availability', description: 'Pr√ºfe Verf√ºgbarkeit', status: 'pending', result: null, duration: null },
                        { name: '‚úÖ start_booking', description: 'Termin buchen', status: 'pending', result: null, duration: null }
                    ];

                    // Step 1: Create Call Record (Multi-Tenant)
                    await this.runFlowStep(0, async () => {
                        return await this.createCallRecord(callId, caller);
                    });

                    // Step 2: get_current_context
                    await this.runFlowStep(1, async () => {
                        const res = await fetch('/api/webhooks/retell/current-context', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ call: { call_id: callId } })
                        });
                        return await res.json();
                    });

                    // Step 3: check_customer
                    await this.runFlowStep(2, async () => {
                        const res = await fetch('/api/webhooks/retell/check-customer', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                call: { call_id: callId },
                                args: {}
                            })
                        });
                        return await res.json();
                    });

                    // Step 4: Variable Extraction
                    await this.runFlowStep(3, async () => {
                        const customerResponse = this.flowSteps[2].result;
                        return this.extractVariables(customerResponse);
                    });

                    // Step 5: Flow Decision
                    await this.runFlowStep(4, async () => {
                        this.flowDecision = this.determineFlowDecision(this.extractedVariables);
                        return this.flowDecision;
                    });

                    // Step 6: check_availability
                    let firstAvailableSlot = '10:00'; // fallback
                    await this.runFlowStep(5, async () => {
                        const res = await fetch('/api/webhooks/retell/function', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                name: 'check_availability',
                                call: { call_id: callId },
                                args: {
                                    datum: 'morgen',
                                    uhrzeit: '10:00',
                                    dienstleistung: 'Herrenhaarschnitt'
                                }
                            })
                        });
                        const availData = await res.json();

                        // Extract first available slot for booking step
                        console.log('üîç DEBUG: availData received:', availData);
                        if (availData.success) {
                            // Handle both response formats:
                            // 1. Direct response: {success: true, available_slots: [...]}
                            // 2. Nested response: {success: true, data: {available_slots: [...]}}
                            const responseData = availData.data || availData;
                            const slots = responseData.available_slots ||
                                         (responseData.alternatives || []).map(alt => alt.time.split(' ')[1]);
                            console.log('üîç DEBUG: Extracted slots:', slots);
                            if (slots && slots.length > 0) {
                                firstAvailableSlot = slots[0];
                                console.log('‚úÖ DEBUG: Set firstAvailableSlot to:', firstAvailableSlot);
                            } else {
                                console.log('‚ö†Ô∏è DEBUG: No slots found, using fallback:', firstAvailableSlot);
                            }
                        } else {
                            console.log('‚ùå DEBUG: availData.success is falsy');
                        }

                        return availData;
                    });

                    // Step 7: start_booking (using first available slot from Step 6)
                    await this.runFlowStep(6, async () => {
                        console.log('üöÄ DEBUG: About to book with firstAvailableSlot:', firstAvailableSlot);
                        const payload = {
                            name: 'start_booking',
                            call: { call_id: callId },
                            args: {
                                datetime: `2025-11-20 ${firstAvailableSlot}`,
                                service_name: 'Herrenhaarschnitt',
                                customer_name: caller.name,
                                customer_email: caller.email || undefined,
                                customer_phone: caller.phone || undefined,
                                preferred_staff_id: this.extractedVariables?.preferred_staff_id || undefined
                            }
                        };

                        const res = await fetch('/api/webhooks/retell/function', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(payload)
                        });
                        return await res.json();
                    });

                    // Finalize
                    this.flowCompleted = true;
                    this.flowSuccess = this.flowSteps.every(s => s.status === 'completed') && this.variableTypeErrors.length === 0;

                    if (this.flowSuccess) {
                        this.flowSummary = `‚úÖ Alle ${this.flowSteps.length} Schritte erfolgreich f√ºr ${this.getCallerTypeLabel()}. Multi-Tenant Test bestanden!`;
                    } else if (this.variableTypeErrors.length > 0) {
                        this.flowSummary = `‚ùå Type Errors gefunden! Flow w√ºrde in Realit√§t STOPPEN.`;
                    } else {
                        this.flowSummary = '‚ùå Einige Schritte sind fehlgeschlagen. Pr√ºfe die Details oben.';
                    }

                    this.flowRunning = false;

                    // Cleanup
                    await this.cleanupTestCall(callId);

                    setTimeout(() => Prism.highlightAll(), 100);
                },

                async cleanupTestCall(callId) {
                    if (!callId || (!callId.startsWith('flow_test_') && !callId.startsWith('test_'))) {
                        return;
                    }

                    try {
                        await fetch('/api/test/delete-call-record', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ call_id: callId })
                        });
                        console.log('‚úÖ Test Call record cleanup complete:', callId);
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Test Call cleanup failed (non-critical):', e.message);
                    }
                },

                getCallerTypeLabel() {
                    const labels = {
                        known: 'Bestandskunde',
                        new: 'Neukunde',
                        anonymous: 'Anonymous Caller'
                    };
                    return labels[this.callerType];
                },

                async runFlowStep(stepIndex, fetchFn) {
                    this.flowSteps[stepIndex].status = 'running';
                    const startTime = performance.now();

                    try {
                        const result = await fetchFn();
                        const duration = Math.round(performance.now() - startTime);

                        this.flowSteps[stepIndex].status = 'completed';
                        this.flowSteps[stepIndex].result = result;
                        this.flowSteps[stepIndex].duration = duration;

                        await new Promise(resolve => setTimeout(resolve, 300));
                    } catch (error) {
                        const duration = Math.round(performance.now() - startTime);
                        this.flowSteps[stepIndex].status = 'failed';
                        this.flowSteps[stepIndex].result = {
                            error: error.message,
                            stack: error.stack
                        };
                        this.flowSteps[stepIndex].duration = duration;
                    }
                },

                async runTest(endpoint, payload) {
                    this.loading = true;
                    const startTime = performance.now();

                    try {
                        const res = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        const duration = Math.round(performance.now() - startTime);
                        const data = await res.json();

                        this.response = {
                            success: res.ok && (data.success !== false),
                            duration: duration,
                            http_status: res.status,
                            data: data
                        };

                        setTimeout(() => Prism.highlightAll(), 50);
                    } catch (error) {
                        this.response = {
                            success: false,
                            duration: Math.round(performance.now() - startTime),
                            data: { error: error.message }
                        };
                    } finally {
                        this.loading = false;
                    }
                },

                // Export Results
                exportResults() {
                    const timestamp = new Date().toISOString();
                    const callerTypeLabel = this.getCallerTypeLabel();

                    const exportData = {
                        exported_at: timestamp,
                        tester_version: 'v4.0.0',

                        // Multi-Tenant Context (NEW V4!)
                        tenant_context: {
                            company_id: this.companyId,
                            branch_id: this.branchId,
                            phone_number_id: this.phoneNumberId,
                            to_number: this.toNumber
                        },

                        caller_type: this.callerType,
                        caller_type_label: callerTypeLabel,
                        caller_config: this.getCurrentCaller(),

                        call_record: this.callRecord,

                        extracted_variables: this.extractedVariables,
                        variable_type_errors: this.variableTypeErrors,
                        variable_validation: this.variableTypeErrors.length === 0 ? 'PASS' : 'FAIL',

                        flow_decision: this.flowDecision,

                        flow_completed: this.flowCompleted,
                        flow_success: this.flowSuccess,
                        flow_summary: this.flowSummary,
                        flow_steps: this.flowSteps.map(step => ({
                            name: step.name,
                            description: step.description,
                            status: step.status,
                            duration: step.duration,
                            result: step.result
                        })),

                        analysis: {
                            total_steps: this.flowSteps.length,
                            completed_steps: this.flowSteps.filter(s => s.status === 'completed').length,
                            failed_steps: this.flowSteps.filter(s => s.status === 'failed').length,
                            total_duration: this.flowSteps.reduce((sum, s) => sum + (s.duration || 0), 0),
                            has_type_errors: this.variableTypeErrors.length > 0,
                            type_error_count: this.variableTypeErrors.length
                        }
                    };

                    const readableReport = this.formatReadableReport(exportData);
                    const jsonReport = JSON.stringify(exportData, null, 2);

                    const fullReport = `${readableReport}\n\n${'='.repeat(80)}\nRAW JSON DATA:\n${'='.repeat(80)}\n\n${jsonReport}`;

                    navigator.clipboard.writeText(fullReport).then(() => {
                        alert('‚úÖ Test-Ergebnisse in Zwischenablage kopiert!\n\nDu kannst sie jetzt an Claude senden.');
                    }).catch(err => {
                        const blob = new Blob([fullReport], { type: 'text/plain' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `backend-test-results-${this.callerType}-${Date.now()}.txt`;
                        a.click();
                        URL.revokeObjectURL(url);
                        alert('‚úÖ Test-Ergebnisse als Datei heruntergeladen!');
                    });
                },

                formatReadableReport(data) {
                    const lines = [];
                    lines.push('‚ïê'.repeat(80));
                    lines.push('BACKEND API TESTER V4 - MULTI-TENANT TEST RESULTS');
                    lines.push('‚ïê'.repeat(80));
                    lines.push('');
                    lines.push(`Exported: ${data.exported_at}`);
                    lines.push(`Tester Version: ${data.tester_version}`);
                    lines.push('');

                    // Multi-Tenant Context (NEW!)
                    lines.push('‚îÄ'.repeat(80));
                    lines.push('MULTI-TENANT CONTEXT');
                    lines.push('‚îÄ'.repeat(80));
                    lines.push(`Company ID: ${data.tenant_context.company_id}`);
                    lines.push(`Branch ID: ${data.tenant_context.branch_id}`);
                    lines.push(`Phone Number ID: ${data.tenant_context.phone_number_id}`);
                    lines.push(`To Number: ${data.tenant_context.to_number}`);
                    lines.push('');

                    lines.push('‚îÄ'.repeat(80));
                    lines.push('TEST CONFIGURATION');
                    lines.push('‚îÄ'.repeat(80));
                    lines.push(`Caller Type: ${data.caller_type_label} (${data.caller_type})`);
                    lines.push(`Phone: ${data.caller_config.from_number}`);
                    lines.push(`Name: ${data.caller_config.name}`);
                    lines.push('');

                    if (data.extracted_variables) {
                        lines.push('‚îÄ'.repeat(80));
                        lines.push('VARIABLE EXTRACTION');
                        lines.push('‚îÄ'.repeat(80));
                        lines.push(`Validation: ${data.variable_validation} ${data.variable_validation === 'PASS' ? '‚úÖ' : '‚ùå'}`);
                        lines.push('');
                        lines.push('Variables:');
                        Object.entries(data.extracted_variables).forEach(([key, value]) => {
                            lines.push(`  ${key}: ${JSON.stringify(value)} (${typeof value})`);
                        });

                        if (data.variable_type_errors.length > 0) {
                            lines.push('');
                            lines.push('‚ö†Ô∏è  TYPE ERRORS FOUND:');
                            data.variable_type_errors.forEach(err => {
                                lines.push(`  ‚ùå ${err.field}: Expected ${err.expected}, got ${err.actual}`);
                            });
                        }
                        lines.push('');
                    }

                    if (data.flow_completed) {
                        lines.push('‚îÄ'.repeat(80));
                        lines.push('E2E FLOW RESULTS');
                        lines.push('‚îÄ'.repeat(80));
                        lines.push(`Status: ${data.flow_success ? '‚úÖ SUCCESS' : '‚ùå FAILED'}`);
                        lines.push(`Summary: ${data.flow_summary}`);
                        lines.push('');
                        lines.push(`Total Steps: ${data.analysis.total_steps}`);
                        lines.push(`Completed: ${data.analysis.completed_steps}`);
                        lines.push(`Failed: ${data.analysis.failed_steps}`);
                        lines.push(`Total Duration: ${data.analysis.total_duration}ms`);
                        lines.push('');
                    }

                    return lines.join('\n');
                }
            }
        }
    </script>
</body>
</html>

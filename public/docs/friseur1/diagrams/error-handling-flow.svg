<svg viewBox="0 0 1000 1400" xmlns="http://www.w3.org/2000/svg">
  <!-- Background -->
  <rect width="1000" height="1400" fill="#1a1a2e"/>

  <!-- Title -->
  <text x="500" y="40" font-family="Arial, sans-serif" font-size="28" font-weight="bold" fill="#ffffff" text-anchor="middle">Error Handling Flow</text>

  <!-- Definitions -->
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#3b82f6"/>
    </marker>
    <marker id="arrow-success" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#10b981"/>
    </marker>
    <marker id="arrow-error" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#ef4444"/>
    </marker>
    <marker id="arrow-warning" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#f59e0b"/>
    </marker>
  </defs>

  <!-- Start Node -->
  <ellipse cx="500" cy="100" rx="120" ry="50" fill="#667eea" stroke="#ffffff" stroke-width="3"/>
  <text x="500" y="110" font-family="Arial, sans-serif" font-size="18" fill="#ffffff" text-anchor="middle" font-weight="bold">Function Call</text>

  <!-- Validate -->
  <rect x="400" y="180" width="200" height="70" fill="#3b82f6" stroke="#ffffff" stroke-width="2" rx="8"/>
  <text x="500" y="210" font-family="Arial, sans-serif" font-size="16" fill="#ffffff" text-anchor="middle" font-weight="bold">Input Validation</text>
  <text x="500" y="230" font-family="Arial, sans-serif" font-size="12" fill="#ffffff" text-anchor="middle" opacity="0.8">Check parameters</text>

  <!-- Decision: Valid? -->
  <path d="M 500,280 L 550,320 L 500,360 L 450,320 Z" fill="#f59e0b" stroke="#ffffff" stroke-width="2"/>
  <text x="500" y="325" font-family="Arial, sans-serif" font-size="14" fill="#ffffff" text-anchor="middle" font-weight="bold">Valid?</text>

  <!-- CallID Resolution -->
  <rect x="400" y="400" width="200" height="70" fill="#3b82f6" stroke="#ffffff" stroke-width="2" rx="8"/>
  <text x="500" y="430" font-family="Arial, sans-serif" font-size="16" fill="#ffffff" text-anchor="middle" font-weight="bold">Call ID Resolution</text>
  <text x="500" y="450" font-family="Arial, sans-serif" font-size="12" fill="#ffffff" text-anchor="middle" opacity="0.8">Resolve call context</text>

  <!-- Decision: Found? -->
  <path d="M 500,500 L 550,540 L 500,580 L 450,540 Z" fill="#f59e0b" stroke="#ffffff" stroke-width="2"/>
  <text x="500" y="545" font-family="Arial, sans-serif" font-size="14" fill="#ffffff" text-anchor="middle" font-weight="bold">Found?</text>

  <!-- Tenant Isolation Check -->
  <rect x="400" y="620" width="200" height="70" fill="#3b82f6" stroke="#ffffff" stroke-width="2" rx="8"/>
  <text x="500" y="645" font-family="Arial, sans-serif" font-size="16" fill="#ffffff" text-anchor="middle" font-weight="bold">Tenant Isolation</text>
  <text x="500" y="665" font-family="Arial, sans-serif" font-size="12" fill="#ffffff" text-anchor="middle" opacity="0.8">Check</text>

  <!-- Decision: Authorized? -->
  <path d="M 500,720 L 550,760 L 500,800 L 450,760 Z" fill="#f59e0b" stroke="#ffffff" stroke-width="2"/>
  <text x="500" y="763" font-family="Arial, sans-serif" font-size="13" fill="#ffffff" text-anchor="middle" font-weight="bold">Authorized?</text>

  <!-- Business Logic -->
  <rect x="400" y="840" width="200" height="70" fill="#3b82f6" stroke="#ffffff" stroke-width="2" rx="8"/>
  <text x="500" y="870" font-family="Arial, sans-serif" font-size="16" fill="#ffffff" text-anchor="middle" font-weight="bold">Business Logic</text>
  <text x="500" y="890" font-family="Arial, sans-serif" font-size="12" fill="#ffffff" text-anchor="middle" opacity="0.8">Process request</text>

  <!-- External API Call -->
  <rect x="400" y="950" width="200" height="70" fill="#3b82f6" stroke="#ffffff" stroke-width="2" rx="8"/>
  <text x="500" y="980" font-family="Arial, sans-serif" font-size="16" fill="#ffffff" text-anchor="middle" font-weight="bold">External API Call</text>
  <text x="500" y="1000" font-family="Arial, sans-serif" font-size="12" fill="#ffffff" text-anchor="middle" opacity="0.8">Cal.com, DB, etc.</text>

  <!-- Decision: Circuit Breaker -->
  <path d="M 500,1050 L 560,1095 L 500,1140 L 440,1095 Z" fill="#f59e0b" stroke="#ffffff" stroke-width="2"/>
  <text x="500" y="1090" font-family="Arial, sans-serif" font-size="13" fill="#ffffff" text-anchor="middle" font-weight="bold">Circuit</text>
  <text x="500" y="1105" font-family="Arial, sans-serif" font-size="13" fill="#ffffff" text-anchor="middle" font-weight="bold">Open?</text>

  <!-- Decision: Retry -->
  <path d="M 700,1095 L 750,1135 L 700,1175 L 650,1135 Z" fill="#f59e0b" stroke="#ffffff" stroke-width="2"/>
  <text x="700" y="1130" font-family="Arial, sans-serif" font-size="13" fill="#ffffff" text-anchor="middle" font-weight="bold">Retry</text>
  <text x="700" y="1145" font-family="Arial, sans-serif" font-size="13" fill="#ffffff" text-anchor="middle" font-weight="bold">less than 5?</text>

  <!-- Fallback Logic -->
  <rect x="200" y="1150" width="180" height="70" fill="#f59e0b" stroke="#ffffff" stroke-width="2" rx="8"/>
  <text x="290" y="1180" font-family="Arial, sans-serif" font-size="16" fill="#ffffff" text-anchor="middle" font-weight="bold">Fallback Logic</text>
  <text x="290" y="1200" font-family="Arial, sans-serif" font-size="12" fill="#ffffff" text-anchor="middle" opacity="0.8">Cached data</text>

  <!-- Success Response -->
  <ellipse cx="290" cy="1300" rx="120" ry="50" fill="#10b981" stroke="#ffffff" stroke-width="3"/>
  <text x="290" y="1305" font-family="Arial, sans-serif" font-size="18" fill="#ffffff" text-anchor="middle" font-weight="bold">Success</text>
  <text x="290" y="1325" font-family="Arial, sans-serif" font-size="13" fill="#ffffff" text-anchor="middle" opacity="0.8">Response</text>

  <!-- Error Response -->
  <ellipse cx="800" cy="700" rx="120" ry="50" fill="#ef4444" stroke="#ffffff" stroke-width="3"/>
  <text x="800" y="705" font-family="Arial, sans-serif" font-size="18" fill="#ffffff" text-anchor="middle" font-weight="bold">Error</text>
  <text x="800" y="725" font-family="Arial, sans-serif" font-size="13" fill="#ffffff" text-anchor="middle" opacity="0.8">Response</text>

  <!-- Arrows -->
  <!-- Start -> Validate -->
  <line x1="500" y1="150" x2="500" y2="170" stroke="#3b82f6" stroke-width="3" marker-end="url(#arrow)"/>

  <!-- Validate -> Decision -->
  <line x1="500" y1="250" x2="500" y2="270" stroke="#3b82f6" stroke-width="3" marker-end="url(#arrow)"/>

  <!-- Decision -> Error (Invalid) -->
  <path d="M 550 320 Q 675 320 680 650" stroke="#ef4444" stroke-width="3" fill="none" marker-end="url(#arrow-error)"/>
  <text x="620" y="470" font-family="Arial, sans-serif" font-size="12" fill="#ef4444" font-weight="bold">Invalid</text>

  <!-- Decision -> CallID (Valid) -->
  <line x1="500" y1="360" x2="500" y2="390" stroke="#10b981" stroke-width="3" marker-end="url(#arrow-success)"/>
  <text x="520" y="380" font-family="Arial, sans-serif" font-size="12" fill="#10b981" font-weight="bold">Valid</text>

  <!-- CallID -> Decision -->
  <line x1="500" y1="470" x2="500" y2="490" stroke="#3b82f6" stroke-width="3" marker-end="url(#arrow)"/>

  <!-- Decision -> Error (Not Found) -->
  <path d="M 550 540 Q 675 540 710 650" stroke="#ef4444" stroke-width="3" fill="none" marker-end="url(#arrow-error)"/>
  <text x="630" y="590" font-family="Arial, sans-serif" font-size="12" fill="#ef4444" font-weight="bold">Not Found</text>

  <!-- Decision -> TenantCheck (Found) -->
  <line x1="500" y1="580" x2="500" y2="610" stroke="#10b981" stroke-width="3" marker-end="url(#arrow-success)"/>
  <text x="520" y="600" font-family="Arial, sans-serif" font-size="12" fill="#10b981" font-weight="bold">Found</text>

  <!-- TenantCheck -> Decision -->
  <line x1="500" y1="690" x2="500" y2="710" stroke="#3b82f6" stroke-width="3" marker-end="url(#arrow)"/>

  <!-- Decision -> Error (Unauthorized) -->
  <path d="M 550 760 Q 675 760 740 725" stroke="#ef4444" stroke-width="3" fill="none" marker-end="url(#arrow-error)"/>
  <text x="640" y="750" font-family="Arial, sans-serif" font-size="12" fill="#ef4444" font-weight="bold">Unauthorized</text>

  <!-- Decision -> BusinessLogic (Authorized) -->
  <line x1="500" y1="800" x2="500" y2="830" stroke="#10b981" stroke-width="3" marker-end="url(#arrow-success)"/>
  <text x="530" y="820" font-family="Arial, sans-serif" font-size="12" fill="#10b981" font-weight="bold">Authorized</text>

  <!-- BusinessLogic -> ExternalAPI -->
  <line x1="500" y1="910" x2="500" y2="940" stroke="#3b82f6" stroke-width="3" marker-end="url(#arrow)"/>

  <!-- ExternalAPI -> CircuitBreaker -->
  <line x1="500" y1="1020" x2="500" y2="1040" stroke="#3b82f6" stroke-width="3" marker-end="url(#arrow)"/>

  <!-- CircuitBreaker -> Fallback (Yes) -->
  <path d="M 440 1095 Q 365 1095 380 1175" stroke="#f59e0b" stroke-width="3" fill="none" marker-end="url(#arrow-warning)"/>
  <text x="370" y="1130" font-family="Arial, sans-serif" font-size="12" fill="#f59e0b" font-weight="bold">Yes</text>

  <!-- CircuitBreaker -> Retry (No) -->
  <path d="M 560 1095 Q 625 1095 640 1130" stroke="#3b82f6" stroke-width="3" fill="none" marker-end="url(#arrow)"/>
  <text x="600" y="1110" font-family="Arial, sans-serif" font-size="12" fill="#3b82f6" font-weight="bold">No</text>

  <!-- Retry -> ExternalAPI (Yes) -->
  <path d="M 700 1175 Q 700 1220 650 1000 Q 620 985 610 985" stroke="#10b981" stroke-width="3" fill="none" marker-end="url(#arrow-success)" stroke-dasharray="5,5"/>
  <text x="740" y="1100" font-family="Arial, sans-serif" font-size="12" fill="#10b981" font-weight="bold">Yes</text>

  <!-- Retry -> Error (No) -->
  <path d="M 750 1135 Q 800 1000 800 750" stroke="#ef4444" stroke-width="3" fill="none" marker-end="url(#arrow-error)"/>
  <text x="820" y="940" font-family="Arial, sans-serif" font-size="12" fill="#ef4444" font-weight="bold">No</text>

  <!-- ExternalAPI -> Success -->
  <path d="M 400 985 Q 340 985 290 1240" stroke="#10b981" stroke-width="3" fill="none" marker-end="url(#arrow-success)"/>
  <text x="320" y="1110" font-family="Arial, sans-serif" font-size="12" fill="#10b981" font-weight="bold">Success</text>

  <!-- Fallback -> Success -->
  <line x1="290" y1="1220" x2="290" y2="1240" stroke="#10b981" stroke-width="3" marker-end="url(#arrow-success)"/>

  <!-- Legend -->
  <rect x="50" y="1320" width="450" height="60" fill="#1a1a2e" stroke="#667eea" stroke-width="2" rx="8"/>
  <text x="275" y="1340" font-family="Arial, sans-serif" font-size="14" fill="#ffffff" text-anchor="middle" font-weight="bold">Legende</text>

  <line x1="70" y1="1360" x2="110" y2="1360" stroke="#10b981" stroke-width="3" marker-end="url(#arrow-success)"/>
  <text x="120" y="1365" font-family="Arial, sans-serif" font-size="12" fill="#10b981">Success Path</text>

  <line x1="220" y1="1360" x2="260" y2="1360" stroke="#ef4444" stroke-width="3" marker-end="url(#arrow-error)"/>
  <text x="270" y="1365" font-family="Arial, sans-serif" font-size="12" fill="#ef4444">Error Path</text>

  <line x1="370" y1="1360" x2="410" y2="1360" stroke="#f59e0b" stroke-width="3" marker-end="url(#arrow-warning)"/>
  <text x="420" y="1365" font-family="Arial, sans-serif" font-size="12" fill="#f59e0b">Fallback</text>
</svg>

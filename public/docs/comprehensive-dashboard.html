<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AskProAI Comprehensive System Documentation</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        header h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        header p {
            font-size: 1.3rem;
            text-align: center;
            opacity: 0.9;
        }
        
        .header-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .header-stat {
            background: rgba(255,255,255,0.1);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .header-stat .value {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .header-stat .label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .tabs {
            display: flex;
            flex-wrap: wrap;
            background: white;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .tab {
            flex: 1;
            min-width: 120px;
            padding: 1rem;
            border: none;
            background: white;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            text-align: center;
        }
        
        .tab:hover {
            background: #f8f9fa;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: #f8f9fa;
        }
        
        .tab-content {
            background: white;
            padding: 2rem;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 800px;
        }
        
        .tab-panel {
            display: none;
        }
        
        .tab-panel.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .status-card {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            transition: transform 0.2s ease;
        }
        
        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .status-card h3 {
            margin-bottom: 1rem;
            color: #444;
        }
        
        .status-card .metric {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 0.5rem;
        }
        
        .progress-bar {
            background: #e9ecef;
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: #667eea;
            transition: width 0.5s ease;
            position: relative;
        }
        
        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(
                45deg,
                rgba(255,255,255,.2) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255,255,255,.2) 50%,
                rgba(255,255,255,.2) 75%,
                transparent 75%,
                transparent
            );
            background-size: 1rem 1rem;
            animation: move 1s linear infinite;
        }
        
        @keyframes move {
            0% {
                background-position: 0 0;
            }
            100% {
                background-position: 1rem 1rem;
            }
        }
        
        .table-wrapper {
            overflow-x: auto;
            margin: 2rem 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #444;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .alert {
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: flex;
            align-items: start;
            gap: 1rem;
        }
        
        .alert-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        .alert-danger {
            background: #fee;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }
        
        .alert-warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            color: #856404;
        }
        
        .alert-success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
        }
        
        .alert-info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            color: #0c5460;
        }
        
        .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            border-radius: 8px;
            padding: 1.5rem;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            margin: 1rem 0;
            position: relative;
        }
        
        .code-block-header {
            background: #2d2d2d;
            margin: -1.5rem -1.5rem 1rem -1.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 8px 8px 0 0;
            font-size: 0.85rem;
            color: #888;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .copy-button {
            background: #444;
            color: white;
            border: none;
            padding: 0.3rem 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .copy-button:hover {
            background: #555;
        }
        
        .flow-diagram {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 2rem;
            margin: 2rem 0;
            text-align: center;
        }
        
        .mermaid {
            text-align: center;
            margin: 2rem 0;
        }
        
        .flow-step {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            margin: 0.5rem;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .flow-step::after {
            content: '‚Üí';
            position: absolute;
            right: -25px;
            top: 50%;
            transform: translateY(-50%);
            color: #667eea;
            font-size: 2rem;
        }
        
        .flow-step:last-child::after {
            display: none;
        }
        
        .checklist {
            list-style: none;
            padding: 0;
        }
        
        .checklist li {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            transition: background 0.2s ease;
        }
        
        .checklist li:hover {
            background: #f8f9fa;
        }
        
        .checklist li::before {
            content: '‚úì';
            display: inline-block;
            width: 28px;
            height: 28px;
            background: #28a745;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            margin-right: 1rem;
            flex-shrink: 0;
            font-weight: bold;
        }
        
        .checklist li.pending::before {
            content: '‚óã';
            background: #6c757d;
        }
        
        .checklist li.in-progress::before {
            content: '‚óê';
            background: #ffc107;
        }
        
        .timestamp {
            color: #6c757d;
            font-size: 0.9rem;
            font-style: italic;
            text-align: right;
            margin-top: 2rem;
        }
        
        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 0.5rem;
            border: none;
            cursor: pointer;
        }
        
        .btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .architecture-box {
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 2rem;
            margin: 2rem 0;
            background: #f8f9fa;
        }
        
        .architecture-box h3 {
            color: #667eea;
            margin-bottom: 1rem;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }
        
        .feature-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .feature-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .feature-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .section-header {
            background: #f8f9fa;
            padding: 1rem 1.5rem;
            margin: 2rem -2rem 1rem -2rem;
            border-left: 4px solid #667eea;
        }
        
        .section-header h2 {
            color: #444;
            margin: 0;
        }
        
        .quick-links {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 1rem;
            z-index: 1000;
        }
        
        .quick-links h4 {
            margin-bottom: 0.5rem;
            color: #666;
            font-size: 0.9rem;
        }
        
        .quick-links a {
            display: block;
            padding: 0.5rem;
            color: #667eea;
            text-decoration: none;
            font-size: 0.85rem;
            border-radius: 4px;
        }
        
        .quick-links a:hover {
            background: #f8f9fa;
        }
        
        @media (max-width: 1400px) {
            .quick-links {
                display: none;
            }
        }
        
        .syntax-highlight {
            color: #9cdcfe;
        }
        
        .syntax-string {
            color: #ce9178;
        }
        
        .syntax-comment {
            color: #6a9955;
        }
        
        .syntax-keyword {
            color: #569cd6;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>AskProAI System Documentation</h1>
            <p>Comprehensive MCP Architecture & Implementation Guide</p>
            
            <div class="header-stats">
                <div class="header-stat">
                    <div class="value">99.3%</div>
                    <div class="label">Success Rate</div>
                </div>
                <div class="header-stat">
                    <div class="value">187ms</div>
                    <div class="label">Avg Response Time</div>
                </div>
                <div class="header-stat">
                    <div class="value">85%</div>
                    <div class="label">Production Ready</div>
                </div>
                <div class="header-stat">
                    <div class="value">5</div>
                    <div class="label">MCP Servers</div>
                </div>
            </div>
        </div>
    </header>
    
    <div class="quick-links">
        <h4>Quick Links</h4>
        <a href="#mcp-overview">MCP Overview</a>
        <a href="#phone-flow">Phone Flow</a>
        <a href="#configuration">Configuration</a>
        <a href="#testing">Testing</a>
        <a href="#monitoring">Monitoring</a>
    </div>
    
    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="showTab('overview')">Overview</button>
            <button class="tab" onclick="showTab('mcp-architecture')">MCP Architecture</button>
            <button class="tab" onclick="showTab('phone-flow')">Phone ‚Üí Appointment</button>
            <button class="tab" onclick="showTab('configuration')">Configuration</button>
            <button class="tab" onclick="showTab('consistency')">Consistency</button>
            <button class="tab" onclick="showTab('implementation')">Implementation</button>
            <button class="tab" onclick="showTab('testing')">Testing</button>
            <button class="tab" onclick="showTab('monitoring')">Monitoring</button>
            <button class="tab" onclick="showTab('troubleshooting')">Troubleshooting</button>
        </div>
        
        <div class="tab-content">
            <!-- Overview Tab -->
            <div id="overview" class="tab-panel active">
                <h2>System Overview - AskProAI Production Status</h2>
                
                <div class="alert alert-success">
                    <div class="alert-icon">‚úÖ</div>
                    <div>
                        <h3>Production Ready with 2 Simple Configurations!</h3>
                        <p>The MCP system is 85% production ready. Only 2 configuration entries are needed:</p>
                        <ol>
                            <li><strong>Cal.com Event Type ID</strong> in branches.calcom_event_type_id</li>
                            <li><strong>Retell Agent ID</strong> in phone_numbers.retell_agent_id</li>
                        </ol>
                    </div>
                </div>
                
                <div class="status-grid">
                    <div class="status-card">
                        <h3>MCP Integration</h3>
                        <div class="metric">5 Servers</div>
                        <p>WebhookMCP, CalcomMCP, RetellMCP, DatabaseMCP, QueueMCP</p>
                        <div class="progress-bar">
                            <div class="progress-bar-fill" style="width: 100%"></div>
                        </div>
                    </div>
                    
                    <div class="status-card">
                        <h3>Database Consistency</h3>
                        <div class="metric">119 ‚Üí 25</div>
                        <p>Tables need consolidation</p>
                        <div class="progress-bar">
                            <div class="progress-bar-fill" style="width: 21%"></div>
                        </div>
                    </div>
                    
                    <div class="status-card">
                        <h3>Service Layer</h3>
                        <div class="metric">12 ‚Üí 3</div>
                        <p>Services need unification</p>
                        <div class="progress-bar">
                            <div class="progress-bar-fill" style="width: 25%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="section-header">
                    <h2>The Complete Phone ‚Üí Appointment Flow</h2>
                </div>
                
                <div class="mermaid">
flowchart LR
    A[Customer Calls<br/>+493083793369] --> B[Retell.ai Agent<br/>Answers]
    B --> C[Collects Data<br/>Name, Date, Time]
    C --> D[Call Ends]
    D --> E[Webhook to MCP]
    E --> F[Phone Resolution<br/>Find Branch]
    F --> G[Create Booking<br/>Cal.com API]
    G --> H[Appointment<br/>Confirmed!]
                </div>
                
                <div class="feature-grid">
                    <div class="feature-card">
                        <div class="feature-icon">üèóÔ∏è</div>
                        <h3>MCP Architecture</h3>
                        <p>5 specialized servers working together</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">üìû</div>
                        <h3>Phone Integration</h3>
                        <p>Retell.ai for intelligent call handling</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">üìÖ</div>
                        <h3>Calendar Booking</h3>
                        <p>Cal.com integration for appointments</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">üîÑ</div>
                        <h3>Circuit Breakers</h3>
                        <p>Resilient error handling</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">üíæ</div>
                        <h3>Smart Caching</h3>
                        <p>5-minute TTL for performance</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">üìä</div>
                        <h3>Monitoring</h3>
                        <p>Prometheus metrics & dashboards</p>
                    </div>
                </div>
            </div>
            
            <!-- MCP Architecture Tab -->
            <div id="mcp-architecture" class="tab-panel">
                <h2 id="mcp-overview">MCP (Model Context Protocol) Architecture</h2>
                
                <div class="architecture-box">
                    <h3>MCP Server Hierarchy</h3>
                    <div class="mermaid">
flowchart TD
    subgraph "Entry Point"
        W[WebhookMCPServer<br/>Orchestrator]
    end
    
    subgraph "Core Services"
        C[CalcomMCPServer<br/>Calendar Integration]
        R[RetellMCPServer<br/>Phone AI Management]
        D[DatabaseMCPServer<br/>Data Operations]
        Q[QueueMCPServer<br/>Job Management]
    end
    
    subgraph "External APIs"
        CA[Cal.com API]
        RA[Retell.ai API]
    end
    
    subgraph "Infrastructure"
        DB[(MySQL Database)]
        RE[(Redis Cache)]
        HZ[Laravel Horizon]
    end
    
    W --> C
    W --> R
    W --> D
    W --> Q
    
    C --> CA
    R --> RA
    D --> DB
    Q --> HZ
    
    C --> RE
    R --> RE
                    </div>
                </div>
                
                <div class="section-header">
                    <h2>WebhookMCPServer - The Orchestrator</h2>
                </div>
                
                <div class="code-block">
                    <div class="code-block-header">
                        <span>WebhookMCPServer.php</span>
                        <button class="copy-button" onclick="copyCode(this)">Copy</button>
                    </div>
                    <pre><span class="syntax-keyword">public function</span> <span class="syntax-highlight">processRetellWebhook</span>(<span class="syntax-keyword">array</span> $webhookData): <span class="syntax-keyword">array</span>
{
    <span class="syntax-comment">// 1. Validate event type</span>
    <span class="syntax-keyword">if</span> ($webhookData[<span class="syntax-string">'event'</span>] !== <span class="syntax-string">'call_ended'</span>) {
        <span class="syntax-keyword">return</span> [<span class="syntax-string">'success'</span> => <span class="syntax-keyword">true</span>, <span class="syntax-string">'message'</span> => <span class="syntax-string">'Event skipped'</span>];
    }
    
    <span class="syntax-comment">// 2. Resolve phone number to branch</span>
    $phoneResolution = $this->resolvePhoneNumber($callData[<span class="syntax-string">'to_number'</span>]);
    
    <span class="syntax-comment">// 3. Create customer record</span>
    $customer = $this->databaseMCP->findOrCreateCustomer([
        <span class="syntax-string">'phone'</span> => $callData[<span class="syntax-string">'from_number'</span>],
        <span class="syntax-string">'name'</span> => $variables[<span class="syntax-string">'name'</span>] ?? <span class="syntax-string">'Unknown'</span>,
        <span class="syntax-string">'company_id'</span> => $phoneResolution[<span class="syntax-string">'company_id'</span>]
    ]);
    
    <span class="syntax-comment">// 4. Check if appointment should be created</span>
    <span class="syntax-keyword">if</span> ($this->shouldCreateAppointment($callData)) {
        $appointment = $this->createAppointmentViaMCP($call, $callData, $phoneResolution);
    }
    
    <span class="syntax-keyword">return</span> [<span class="syntax-string">'success'</span> => <span class="syntax-keyword">true</span>, <span class="syntax-string">'call_id'</span> => $call->id];
}</pre>
                </div>
                
                <div class="section-header">
                    <h2>CalcomMCPServer Features</h2>
                </div>
                
                <div class="feature-grid">
                    <div class="feature-card">
                        <div class="feature-icon">üîÑ</div>
                        <h3>Circuit Breaker</h3>
                        <p>Failure Threshold: 5<br/>
                        Success Threshold: 2<br/>
                        Timeout: 60s</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">üíæ</div>
                        <h3>Response Caching</h3>
                        <p>5 min TTL<br/>
                        Redis-based<br/>
                        Auto-invalidation</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">üîê</div>
                        <h3>Idempotency</h3>
                        <p>24h dedup window<br/>
                        MD5 based keys<br/>
                        Prevents duplicates</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">üë•</div>
                        <h3>Team Events</h3>
                        <p>Auto team detection<br/>
                        Team ID injection<br/>
                        Round-robin assignment</p>
                    </div>
                </div>
                
                <div class="section-header">
                    <h2>Data Flow Patterns</h2>
                </div>
                
                <div class="mermaid">
flowchart TD
    subgraph "Webhook Reception"
        WH[Retell Webhook] --> SIG{Signature<br/>Valid?}
        SIG -->|No| REJ[Reject 401]
        SIG -->|Yes| PROC[Process]
    end
    
    subgraph "Phone Resolution"
        PROC --> PH[Phone Number<br/>+493083793369]
        PH --> DB1[(phone_numbers)]
        DB1 --> BR[Branch Found]
        BR --> DB2[(branches)]
        DB2 --> EVT[Event Type ID]
    end
    
    subgraph "Booking Creation"
        EVT --> CAL[CalcomMCPServer]
        CAL --> CACHE{In Cache?}
        CACHE -->|Yes| CACHED[Use Cached]
        CACHE -->|No| API[Cal.com API]
        API --> BOOK[Booking Created]
    end
    
    subgraph "Local Storage"
        BOOK --> APP[(appointments)]
        APP --> CALL[(calls update)]
    end
                </div>
            </div>
            
            <!-- Phone Flow Tab -->
            <div id="phone-flow" class="tab-panel">
                <h2 id="phone-flow">Complete Phone ‚Üí Appointment Flow</h2>
                
                <div class="alert alert-info">
                    <div class="alert-icon">‚ÑπÔ∏è</div>
                    <div>
                        <h3>Critical Configuration Path</h3>
                        <p>Phone Number ‚Üí Branch ‚Üí Event Type ‚Üí Booking</p>
                    </div>
                </div>
                
                <div class="mermaid">
flowchart TD
    Start([Customer calls +493083793369])
    
    Start --> Retell[Retell.ai Agent<br/>agent_9a8202a740cd3120d96fcfda1e]
    
    Retell --> |Audio Stream| RetellBackend[Retell Backend<br/>- Transcription<br/>- LLM Processing<br/>- Dynamic Variables]
    
    RetellBackend --> |collect_appointment_data| Variables[Collected Variables:<br/>- booking_confirmed: true<br/>- name: Max Mustermann<br/>- datum: 2025-07-02<br/>- uhrzeit: 11:00<br/>- dienstleistung: Beratung]
    
    Variables --> |Call Ends| Webhook[Webhook POST<br/>/api/mcp/retell/webhook]
    
    Webhook --> WebhookMCP[WebhookMCPServer]
    
    WebhookMCP --> PhoneRes{Phone Number<br/>Resolution}
    
    PhoneRes --> |Query| PhoneDB[(phone_numbers<br/>WHERE number = '+493083793369')]
    
    PhoneDB --> |Found| Branch[Branch: AskProAI Berlin<br/>ID: 1]
    
    Branch --> |Get Config| BranchDB[(branches<br/>calcom_event_type_id = 2563193)]
    
    BranchDB --> Customer[Find/Create Customer<br/>by phone number]
    
    Customer --> CallRecord[Create Call Record<br/>with extracted data]
    
    CallRecord --> BookingCheck{booking_confirmed<br/>= true?}
    
    BookingCheck -->|No| NoBooking[End: No Appointment]
    BookingCheck -->|Yes| CalcomMCP[CalcomMCPServer::createBooking]
    
    CalcomMCP --> TeamCheck{Team Event?}
    
    TeamCheck -->|Yes| AddTeam[Add teamId: 39203]
    TeamCheck -->|No| DirectBook[Direct Booking]
    
    AddTeam --> CalAPI[Cal.com API<br/>POST /bookings]
    DirectBook --> CalAPI
    
    CalAPI -->|Success| CreateLocal[Create Local<br/>Appointment Record]
    CalAPI -->|Error| Retry[Retry with<br/>Circuit Breaker]
    
    CreateLocal --> UpdateCall[Update Call<br/>with appointment_id]
    
    UpdateCall --> Success([‚úÖ Booking Complete<br/>ID: 8727139])
    
    Retry -->|Max Retries| Failed([‚ùå Booking Failed<br/>Manual Intervention])
                </div>
                
                <div class="section-header">
                    <h2>Webhook Payload Structure</h2>
                </div>
                
                <div class="code-block">
                    <div class="code-block-header">
                        <span>Retell Webhook Payload</span>
                        <button class="copy-button" onclick="copyCode(this)">Copy</button>
                    </div>
                    <pre>{
  <span class="syntax-string">"event"</span>: <span class="syntax-string">"call_ended"</span>,
  <span class="syntax-string">"call"</span>: {
    <span class="syntax-string">"call_id"</span>: <span class="syntax-string">"abc123"</span>,
    <span class="syntax-string">"agent_id"</span>: <span class="syntax-string">"agent_9a8202a740cd3120d96fcfda1e"</span>,
    <span class="syntax-string">"from_number"</span>: <span class="syntax-string">"+491234567890"</span>,
    <span class="syntax-string">"to_number"</span>: <span class="syntax-string">"+493083793369"</span>,
    <span class="syntax-string">"direction"</span>: <span class="syntax-string">"inbound"</span>,
    <span class="syntax-string">"call_status"</span>: <span class="syntax-string">"ended"</span>,
    <span class="syntax-string">"duration_ms"</span>: 300000,
    <span class="syntax-string">"retell_llm_dynamic_variables"</span>: {
      <span class="syntax-string">"booking_confirmed"</span>: <span class="syntax-keyword">true</span>,
      <span class="syntax-string">"name"</span>: <span class="syntax-string">"Max Mustermann"</span>,
      <span class="syntax-string">"datum"</span>: <span class="syntax-string">"2025-07-02"</span>,
      <span class="syntax-string">"uhrzeit"</span>: <span class="syntax-string">"11:00"</span>,
      <span class="syntax-string">"dienstleistung"</span>: <span class="syntax-string">"Beratung"</span>,
      <span class="syntax-string">"email"</span>: <span class="syntax-string">"max@example.com"</span>
    }
  }
}</pre>
                </div>
                
                <div class="section-header">
                    <h2>Phone Number Resolution Logic</h2>
                </div>
                
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Priority</th>
                                <th>Resolution Method</th>
                                <th>Source</th>
                                <th>Confidence</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1</td>
                                <td>Retell Metadata</td>
                                <td>metadata['askproai_branch_id']</td>
                                <td>100%</td>
                            </tr>
                            <tr>
                                <td>2</td>
                                <td>Phone Number Table</td>
                                <td>phone_numbers.number</td>
                                <td>90%</td>
                            </tr>
                            <tr>
                                <td>3</td>
                                <td>Branch Phone</td>
                                <td>branches.phone_number</td>
                                <td>80%</td>
                            </tr>
                            <tr>
                                <td>4</td>
                                <td>Agent ID Lookup</td>
                                <td>branches.retell_agent_id</td>
                                <td>70%</td>
                            </tr>
                            <tr>
                                <td>5</td>
                                <td>Customer History</td>
                                <td>Previous appointments</td>
                                <td>60%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Configuration Tab -->
            <div id="configuration" class="tab-panel">
                <h2 id="configuration">Configuration Guide</h2>
                
                <div class="alert alert-success">
                    <div class="alert-icon">üéØ</div>
                    <div>
                        <h3>Only 2 Configurations Needed!</h3>
                        <p>The system is almost ready. You just need to configure these two values:</p>
                    </div>
                </div>
                
                <div class="status-grid">
                    <div class="status-card">
                        <h3>1. Cal.com Event Type ID</h3>
                        <p>Set in: <code>branches.calcom_event_type_id</code></p>
                        <div class="code-block">
                            <pre>UPDATE branches 
SET calcom_event_type_id = 2563193 
WHERE id = 1;</pre>
                        </div>
                    </div>
                    
                    <div class="status-card">
                        <h3>2. Retell Agent ID</h3>
                        <p>Set in: <code>phone_numbers.retell_agent_id</code></p>
                        <div class="code-block">
                            <pre>UPDATE phone_numbers 
SET retell_agent_id = 'agent_9a8202...' 
WHERE phone_number = '+493083793369';</pre>
                        </div>
                    </div>
                </div>
                
                <div class="section-header">
                    <h2>Environment Variables</h2>
                </div>
                
                <div class="code-block">
                    <div class="code-block-header">
                        <span>.env</span>
                        <button class="copy-button" onclick="copyCode(this)">Copy</button>
                    </div>
                    <pre><span class="syntax-comment"># Cal.com Configuration</span>
DEFAULT_CALCOM_API_KEY=<span class="syntax-string">"cal_live_xxxxxx"</span>
DEFAULT_CALCOM_TEAM_SLUG=<span class="syntax-string">"askproai"</span>
CALCOM_WEBHOOK_SECRET=<span class="syntax-string">"your-webhook-secret"</span>

<span class="syntax-comment"># Retell.ai Configuration</span>
DEFAULT_RETELL_API_KEY=<span class="syntax-string">"key_xxxxxx"</span>
RETELL_WEBHOOK_SECRET=<span class="syntax-string">"key_xxxxxx"</span>
DEFAULT_RETELL_AGENT_ID=<span class="syntax-string">"agent_9a8202a740cd3120d96fcfda1e"</span>

<span class="syntax-comment"># MCP Configuration</span>
MCP_WEBHOOK_URL=<span class="syntax-string">"https://api.askproai.de/api/mcp/retell/webhook"</span>
MCP_CIRCUIT_BREAKER_ENABLED=<span class="syntax-keyword">true</span>
MCP_CACHE_TTL=<span class="syntax-string">300</span> <span class="syntax-comment"># 5 minutes</span></pre>
                </div>
                
                <div class="section-header">
                    <h2>Service Configuration (config/services.php)</h2>
                </div>
                
                <div class="architecture-box">
                    <h3>Current Issues to Fix</h3>
                    <ul class="checklist">
                        <li class="pending">Multiple API key sources (env, database)</li>
                        <li class="pending">V1/V2 API confusion</li>
                        <li class="pending">Duplicate service configurations</li>
                        <li class="pending">Unclear precedence rules</li>
                    </ul>
                </div>
                
                <div class="section-header">
                    <h2>Webhook Configuration</h2>
                </div>
                
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Provider</th>
                                <th>Webhook URL</th>
                                <th>Events</th>
                                <th>Verification</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Retell.ai</td>
                                <td>/api/mcp/retell/webhook</td>
                                <td>call_started, call_ended, call_analyzed</td>
                                <td>HMAC-SHA256</td>
                            </tr>
                            <tr>
                                <td>Cal.com</td>
                                <td>/api/webhooks/calcom</td>
                                <td>booking.created, booking.cancelled</td>
                                <td>Signature Header</td>
                            </tr>
                            <tr>
                                <td>Stripe</td>
                                <td>/api/webhooks/stripe</td>
                                <td>payment_intent.succeeded</td>
                                <td>Webhook Secret</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Consistency Tab -->
            <div id="consistency" class="tab-panel">
                <h2>System Consistency Analysis</h2>
                
                <div class="alert alert-danger">
                    <div class="alert-icon">‚ö†Ô∏è</div>
                    <div>
                        <h3>Critical Inconsistencies Found</h3>
                        <p>The system has grown organically without architectural governance, resulting in:</p>
                        <ul>
                            <li>119 tables instead of 25</li>
                            <li>Multiple implementations of the same functionality</li>
                            <li>Conflicting data flows</li>
                            <li>Unclear configuration precedence</li>
                        </ul>
                    </div>
                </div>
                
                <div class="section-header">
                    <h2>Database Consolidation Plan</h2>
                </div>
                
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Current State</th>
                                <th>Target State</th>
                                <th>Action Required</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Event Type Tables</td>
                                <td>9 tables</td>
                                <td>1 table (calcom_event_types)</td>
                                <td>Migrate & delete duplicates</td>
                            </tr>
                            <tr>
                                <td>Staff Assignments</td>
                                <td>8 tables</td>
                                <td>1 table (staff_event_types)</td>
                                <td>Consolidate relationships</td>
                            </tr>
                            <tr>
                                <td>Phone Numbers</td>
                                <td>3 locations</td>
                                <td>phone_numbers table only</td>
                                <td>Remove from branches</td>
                            </tr>
                            <tr>
                                <td>Agent IDs</td>
                                <td>4 locations</td>
                                <td>phone_numbers.retell_agent_id</td>
                                <td>Remove from other tables</td>
                            </tr>
                            <tr>
                                <td>API Keys</td>
                                <td>4 locations</td>
                                <td>companies table only</td>
                                <td>Remove from .env</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="section-header">
                    <h2>Service Layer Consolidation</h2>
                </div>
                
                <div class="code-block">
                    <div class="code-block-header">
                        <span>Current Chaos (12 services)</span>
                    </div>
                    <pre><span class="syntax-comment">// Cal.com Services (7 implementations!)</span>
CalcomService              <span class="syntax-comment">// V1 API</span>
CalcomService_v1_only      <span class="syntax-comment">// Backup?</span>
CalcomV2Service            <span class="syntax-comment">// V2 API</span>
CalcomMCPServer            <span class="syntax-comment">// MCP Wrapper</span>
CalcomMigrationService     <span class="syntax-comment">// Migration</span>
CalcomV2MigrationService   <span class="syntax-comment">// Another migration</span>
CalcomSyncService          <span class="syntax-comment">// Sync operations</span>

<span class="syntax-comment">// Retell Services (5 implementations!)</span>
RetellService              <span class="syntax-comment">// Original</span>
RetellV2Service            <span class="syntax-comment">// New version</span>
RetellMCPServer            <span class="syntax-comment">// MCP wrapper</span>
RetellAgentService         <span class="syntax-comment">// Agent management</span>
RetellAgentProvisioner     <span class="syntax-comment">// Agent provisioning</span></pre>
                </div>
                
                <div class="code-block">
                    <div class="code-block-header">
                        <span>Target Architecture (3 services)</span>
                    </div>
                    <pre><span class="syntax-comment">// Clean, single-purpose services</span>
CalcomService              <span class="syntax-comment">// One implementation using V2 API</span>
RetellService              <span class="syntax-comment">// One implementation</span>
AppointmentBookingService  <span class="syntax-comment">// Orchestration layer</span></pre>
                </div>
                
                <div class="section-header">
                    <h2>The ONE Clear Path</h2>
                </div>
                
                <div class="architecture-box">
                    <h3>Target Hierarchy</h3>
                    <div class="code-block">
                        <pre>Company (Firma)
  ‚îî‚îÄ‚îÄ Branches (Filialen)
        ‚îú‚îÄ‚îÄ Phone Numbers ‚Üí with Retell Agent
        ‚îú‚îÄ‚îÄ Staff
        ‚îú‚îÄ‚îÄ Services
        ‚îî‚îÄ‚îÄ Event Types (Cal.com)</pre>
                    </div>
                </div>
            </div>
            
            <!-- Implementation Tab -->
            <div id="implementation" class="tab-panel">
                <h2>Implementation Plan</h2>
                
                <div class="section-header">
                    <h2>3-Week Transformation Plan</h2>
                </div>
                
                <div class="status-grid">
                    <div class="status-card">
                        <h3>Week 1: Database</h3>
                        <ul class="checklist">
                            <li class="pending">Create full backup</li>
                            <li class="pending">Consolidate duplicate tables</li>
                            <li class="pending">Delete old tables</li>
                            <li class="pending">Update foreign keys</li>
                            <li class="pending">Fix tests</li>
                        </ul>
                    </div>
                    
                    <div class="status-card">
                        <h3>Week 2: Services</h3>
                        <ul class="checklist">
                            <li class="pending">Redirect all calls to new services</li>
                            <li class="pending">Mark old services deprecated</li>
                            <li class="pending">Consolidate MCP servers</li>
                            <li class="pending">Write new tests</li>
                            <li class="pending">Delete old services</li>
                        </ul>
                    </div>
                    
                    <div class="status-card">
                        <h3>Week 3: Portal</h3>
                        <ul class="checklist">
                            <li>Company Integration Portal as main hub</li>
                            <li class="pending">Remove redundant wizards</li>
                            <li>Simplify navigation</li>
                            <li>Consistent UI/UX</li>
                            <li class="pending">Update documentation</li>
                        </ul>
                    </div>
                </div>
                
                <div class="section-header">
                    <h2>Quick Wins (Immediate)</h2>
                </div>
                
                <div class="feature-grid">
                    <div class="feature-card">
                        <h3>Config Cleanup</h3>
                        <p>Clean services.php - single API key source</p>
                        <button class="btn btn-secondary">1 hour</button>
                    </div>
                    <div class="feature-card">
                        <h3>Remove Unused Columns</h3>
                        <p>Migration to drop legacy columns</p>
                        <button class="btn btn-secondary">2 hours</button>
                    </div>
                    <div class="feature-card">
                        <h3>Service Redirect</h3>
                        <p>V1 calls to V2 API</p>
                        <button class="btn btn-secondary">3 hours</button>
                    </div>
                    <div class="feature-card">
                        <h3>Fix Phone Resolution</h3>
                        <p>Single source of truth</p>
                        <button class="btn btn-secondary">2 hours</button>
                    </div>
                    <div class="feature-card">
                        <h3>Update Webhooks</h3>
                        <p>Point to MCP endpoints</p>
                        <button class="btn btn-secondary">1 hour</button>
                    </div>
                    <div class="feature-card">
                        <h3>Enable Monitoring</h3>
                        <p>Prometheus metrics</p>
                        <button class="btn btn-secondary">2 hours</button>
                    </div>
                </div>
                
                <div class="section-header">
                    <h2>Migration Commands</h2>
                </div>
                
                <div class="code-block">
                    <div class="code-block-header">
                        <span>Database Consolidation</span>
                        <button class="copy-button" onclick="copyCode(this)">Copy</button>
                    </div>
                    <pre><span class="syntax-comment"># 1. Create backup</span>
php artisan backup:run --only-db

<span class="syntax-comment"># 2. Run consolidation migration</span>
php artisan migrate --path=database/migrations/consolidate_tables.php

<span class="syntax-comment"># 3. Verify data integrity</span>
php artisan askproai:verify-consolidation

<span class="syntax-comment"># 4. Drop old tables</span>
php artisan migrate --path=database/migrations/drop_legacy_tables.php</pre>
                </div>
            </div>
            
            <!-- Testing Tab -->
            <div id="testing" class="tab-panel">
                <h2 id="testing">Testing & Validation</h2>
                
                <div class="alert alert-danger">
                    <div class="alert-icon">‚ùå</div>
                    <div>
                        <h3>Test Suite Currently Broken</h3>
                        <p>94% failure rate due to SQLite-incompatible migrations</p>
                    </div>
                </div>
                
                <div class="section-header">
                    <h2>MCP Testing Commands</h2>
                </div>
                
                <div class="code-block">
                    <div class="code-block-header">
                        <span>Test MCP Components</span>
                        <button class="copy-button" onclick="copyCode(this)">Copy</button>
                    </div>
                    <pre><span class="syntax-comment"># Test webhook processing</span>
php test-mcp-server-direct.php

<span class="syntax-comment"># Test Cal.com availability</span>
php test-calcom-availability.php

<span class="syntax-comment"># Test direct booking</span>
php test-direct-mcp-booking.php

<span class="syntax-comment"># Test phone resolution</span>
php test-phone-resolution.php +493083793369

<span class="syntax-comment"># Test complete flow</span>
php test-complete-booking-flow.php</pre>
                </div>
                
                <div class="section-header">
                    <h2>Test Scenarios</h2>
                </div>
                
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Scenario</th>
                                <th>Test Command</th>
                                <th>Expected Result</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Phone Resolution</td>
                                <td>test-phone-resolution.php</td>
                                <td>Branch ID returned</td>
                                <td>‚úÖ Pass</td>
                            </tr>
                            <tr>
                                <td>Webhook Processing</td>
                                <td>test-mcp-server-direct.php</td>
                                <td>Call record created</td>
                                <td>‚úÖ Pass</td>
                            </tr>
                            <tr>
                                <td>Booking Creation</td>
                                <td>test-direct-mcp-booking.php</td>
                                <td>Cal.com booking ID</td>
                                <td>‚úÖ Pass</td>
                            </tr>
                            <tr>
                                <td>Circuit Breaker</td>
                                <td>test-circuit-breaker.php</td>
                                <td>Fails gracefully</td>
                                <td>‚ö†Ô∏è Needs testing</td>
                            </tr>
                            <tr>
                                <td>Cache Performance</td>
                                <td>test-cache-performance.php</td>
                                <td><50ms response</td>
                                <td>‚úÖ Pass</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="section-header">
                    <h2>Performance Benchmarks</h2>
                </div>
                
                <div class="status-grid">
                    <div class="status-card">
                        <h3>Webhook Processing</h3>
                        <div class="metric">187ms</div>
                        <p>Average response time</p>
                    </div>
                    <div class="status-card">
                        <h3>Phone Resolution</h3>
                        <div class="metric">12ms</div>
                        <p>Database lookup time</p>
                    </div>
                    <div class="status-card">
                        <h3>Booking Creation</h3>
                        <div class="metric">892ms</div>
                        <p>Cal.com API call</p>
                    </div>
                    <div class="status-card">
                        <h3>Cache Hit Rate</h3>
                        <div class="metric">78%</div>
                        <p>Redis cache efficiency</p>
                    </div>
                </div>
            </div>
            
            <!-- Monitoring Tab -->
            <div id="monitoring" class="tab-panel">
                <h2 id="monitoring">Monitoring & Observability</h2>
                
                <div class="section-header">
                    <h2>Monitoring Stack</h2>
                </div>
                
                <div class="mermaid">
flowchart LR
    APP[AskProAI<br/>Application] --> METRICS[/api/metrics<br/>Prometheus Endpoint]
    METRICS --> PROM[Prometheus<br/>:9090]
    PROM --> GRAF[Grafana<br/>:3000]
    
    APP --> LOGS[Log Files]
    LOGS --> ELASTIC[Elasticsearch]
    ELASTIC --> KIBANA[Kibana<br/>:5601]
    
    APP --> SENTRY[Sentry.io<br/>Error Tracking]
    SENTRY --> ALERTS[Slack/Email<br/>Alerts]
                </div>
                
                <div class="section-header">
                    <h2>Key Metrics</h2>
                </div>
                
                <div class="feature-grid">
                    <div class="feature-card">
                        <h3>HTTP Metrics</h3>
                        <p>http_request_duration_seconds<br/>
                        http_requests_total<br/>
                        http_request_size_bytes</p>
                    </div>
                    <div class="feature-card">
                        <h3>MCP Metrics</h3>
                        <p>mcp_webhook_total<br/>
                        mcp_booking_success_total<br/>
                        mcp_booking_failure_total</p>
                    </div>
                    <div class="feature-card">
                        <h3>Circuit Breaker</h3>
                        <p>circuit_breaker_state<br/>
                        circuit_breaker_failures<br/>
                        circuit_breaker_successes</p>
                    </div>
                    <div class="feature-card">
                        <h3>Cache Metrics</h3>
                        <p>cache_hits_total<br/>
                        cache_misses_total<br/>
                        cache_evictions_total</p>
                    </div>
                    <div class="feature-card">
                        <h3>Queue Metrics</h3>
                        <p>queue_size<br/>
                        queue_processing_time<br/>
                        queue_failed_jobs</p>
                    </div>
                    <div class="feature-card">
                        <h3>Business Metrics</h3>
                        <p>appointments_created<br/>
                        calls_processed<br/>
                        booking_conversion_rate</p>
                    </div>
                </div>
                
                <div class="section-header">
                    <h2>Monitoring Commands</h2>
                </div>
                
                <div class="code-block">
                    <div class="code-block-header">
                        <span>Monitoring Setup</span>
                        <button class="copy-button" onclick="copyCode(this)">Copy</button>
                    </div>
                    <pre><span class="syntax-comment"># Start monitoring stack</span>
docker-compose -f docker-compose.observability.yml up -d

<span class="syntax-comment"># Check metrics endpoint</span>
curl http://localhost/api/metrics

<span class="syntax-comment"># View Grafana dashboards</span>
open http://localhost:3000  <span class="syntax-comment"># admin/admin</span>

<span class="syntax-comment"># Check circuit breaker status</span>
php artisan circuit-breaker:status

<span class="syntax-comment"># View real-time logs</span>
tail -f storage/logs/laravel.log | grep MCP</pre>
                </div>
                
                <div class="section-header">
                    <h2>Alert Rules</h2>
                </div>
                
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Alert</th>
                                <th>Condition</th>
                                <th>Severity</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>High Error Rate</td>
                                <td>Error rate > 5% for 5 min</td>
                                <td>Critical</td>
                                <td>Page on-call</td>
                            </tr>
                            <tr>
                                <td>Slow Response</td>
                                <td>p95 latency > 1s</td>
                                <td>Warning</td>
                                <td>Slack notification</td>
                            </tr>
                            <tr>
                                <td>Circuit Open</td>
                                <td>Circuit breaker open > 5 min</td>
                                <td>Critical</td>
                                <td>Page on-call</td>
                            </tr>
                            <tr>
                                <td>Queue Backlog</td>
                                <td>Queue size > 1000</td>
                                <td>Warning</td>
                                <td>Email alert</td>
                            </tr>
                            <tr>
                                <td>Low Cache Hit</td>
                                <td>Cache hit rate < 50%</td>
                                <td>Info</td>
                                <td>Dashboard alert</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Troubleshooting Tab -->
            <div id="troubleshooting" class="tab-panel">
                <h2 id="troubleshooting">Troubleshooting Guide</h2>
                
                <div class="section-header">
                    <h2>Common Issues & Solutions</h2>
                </div>
                
                <div class="architecture-box">
                    <h3>Issue: "Time slot no longer available"</h3>
                    <div class="code-block">
                        <pre><span class="syntax-comment"># Check for stuck locks</span>
SELECT * FROM appointment_locks 
WHERE expires_at < NOW() 
AND branch_id = 'YOUR-BRANCH-ID';

<span class="syntax-comment"># Clean expired locks</span>
DELETE FROM appointment_locks WHERE expires_at < NOW();</pre>
                    </div>
                </div>
                
                <div class="architecture-box">
                    <h3>Issue: "Cal.com sync failed"</h3>
                    <div class="code-block">
                        <pre><span class="syntax-comment"># Check circuit breaker status</span>
php artisan circuit-breaker:status

<span class="syntax-comment"># Reset circuit breaker</span>
php artisan circuit-breaker:reset calcom

<span class="syntax-comment"># Manually retry sync</span>
php artisan appointments:sync-failed</pre>
                    </div>
                </div>
                
                <div class="architecture-box">
                    <h3>Issue: "Webhook not processing"</h3>
                    <div class="code-block">
                        <pre><span class="syntax-comment"># Check webhook signature</span>
curl -X POST https://api.askproai.de/api/mcp/retell/webhook \
  -H "x-retell-signature: YOUR_SIGNATURE" \
  -H "Content-Type: application/json" \
  -d '{"event":"call_ended","call":{"call_id":"test"}}'

<span class="syntax-comment"># Check webhook logs</span>
tail -f storage/logs/laravel.log | grep -i webhook

<span class="syntax-comment"># Test webhook directly</span>
php test-mcp-webhook.php</pre>
                    </div>
                </div>
                
                <div class="section-header">
                    <h2>Debug SQL Queries</h2>
                </div>
                
                <div class="code-block">
                    <div class="code-block-header">
                        <span>Useful Debug Queries</span>
                        <button class="copy-button" onclick="copyCode(this)">Copy</button>
                    </div>
                    <pre><span class="syntax-comment">-- Find all logs for a failed booking</span>
SELECT * FROM api_call_logs 
WHERE correlation_id = 'YOUR-CORRELATION-ID'
ORDER BY created_at;

<span class="syntax-comment">-- Check webhook processing</span>
SELECT * FROM webhook_events 
WHERE payload->>'$.call_id' = 'YOUR-CALL-ID';

<span class="syntax-comment">-- Slow queries</span>
SELECT 
    query_time,
    lock_time,
    rows_sent,
    rows_examined,
    sql_text
FROM mysql.slow_log
WHERE query_time > 1
ORDER BY query_time DESC
LIMIT 10;

<span class="syntax-comment">-- API performance</span>
SELECT 
    service,
    AVG(duration_ms) as avg_ms,
    MAX(duration_ms) as max_ms,
    COUNT(*) as total_calls
FROM api_call_logs
WHERE created_at >= NOW() - INTERVAL 1 HOUR
GROUP BY service;</pre>
                </div>
                
                <div class="section-header">
                    <h2>Emergency Procedures</h2>
                </div>
                
                <div class="feature-grid">
                    <div class="feature-card">
                        <h3>üö® Block Suspicious IP</h3>
                        <div class="code-block">
                            <pre>php artisan security:block-ip 192.168.1.1</pre>
                        </div>
                    </div>
                    <div class="feature-card">
                        <h3>üíæ Emergency Backup</h3>
                        <div class="code-block">
                            <pre>php artisan askproai:backup --type=critical --encrypt</pre>
                        </div>
                    </div>
                    <div class="feature-card">
                        <h3>üîÑ Clear All Caches</h3>
                        <div class="code-block">
                            <pre>php artisan optimize:clear</pre>
                        </div>
                    </div>
                    <div class="feature-card">
                        <h3>üîë Rotate API Keys</h3>
                        <div class="code-block">
                            <pre>php artisan security:rotate-keys</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="timestamp">
            Last updated: June 22, 2025, 16:15 UTC
        </div>
    </div>
    
    <script>
        // Initialize Mermaid
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });
        
        function showTab(tabName) {
            // Hide all tabs
            const panels = document.querySelectorAll('.tab-panel');
            panels.forEach(panel => panel.classList.remove('active'));
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Mark tab as active
            event.target.classList.add('active');
            
            // Re-render Mermaid diagrams in the active tab
            mermaid.init();
        }
        
        function copyCode(button) {
            const codeBlock = button.closest('.code-block');
            const code = codeBlock.querySelector('pre').textContent;
            
            navigator.clipboard.writeText(code).then(() => {
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            });
        }
        
        // Auto-refresh every 5 minutes
        setInterval(() => {
            location.reload();
        }, 300000);
    </script>
</body>
</html>
<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>E2E Dokumentation: Friseur 1</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="assets/mermaid.min.js"></script>
<style>
* { box-sizing: border-box; }
body { font: 14px/1.5 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 0; }
aside { position: fixed; top: 0; bottom: 0; left: 0; width: 280px; padding: 20px; overflow: auto; background: #1a1a1a; color: #eee; border-right: 1px solid #333; }
aside h3 { margin-top: 0; font-size: 18px; color: #4CAF50; }
aside input, aside select { width: 100%; padding: 8px; margin-bottom: 12px; border: 1px solid #444; border-radius: 4px; background: #2a2a2a; color: #eee; font-size: 13px; }
aside nav ul { list-style: none; padding: 0; margin: 16px 0; }
aside nav li { margin: 8px 0; }
aside nav a { color: #81C784; text-decoration: none; display: block; padding: 4px 0; }
aside nav a:hover { color: #A5D6A7; text-decoration: underline; }
aside label { display: block; margin-top: 16px; font-size: 13px; cursor: pointer; }
aside label input { width: auto; margin-right: 6px; }
main { margin-left: 280px; padding: 32px; max-width: 1400px; }
main section { margin-bottom: 48px; padding-bottom: 24px; border-bottom: 1px solid #e0e0e0; }
main section:last-child { border-bottom: none; }
h2 { display: flex; gap: 12px; align-items: center; color: #2E7D32; font-size: 24px; margin-top: 0; }
.chip { font-size: 11px; border: 1px solid #4CAF50; color: #4CAF50; padding: 3px 8px; border-radius: 12px; font-weight: 500; }
.mermaid { margin: 20px 0; padding: 16px; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; overflow-x: auto; }
section p { color: #555; line-height: 1.6; }
section a { color: #1976D2; text-decoration: none; font-weight: 500; }
section a:hover { text-decoration: underline; }
.copy-btn { background: #4CAF50; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
.copy-btn:hover { background: #45a049; }
body.dark { background: #121212; color: #e0e0e0; }
body.dark main section { border-bottom-color: #333; }
body.dark .mermaid { background: #1e1e1e; border-color: #333; }
body.dark section p { color: #b0b0b0; }
</style>
</head>
<body>
<aside>
  <h3>ğŸ“Š E2E Dashboard</h3>
  <input id="q" placeholder="ğŸ” Filter Diagramme..." type="search">
  <div style="display:flex;gap:8px;margin-bottom:12px">
    <select id="branch">
      <option value="">Alle Filialen</option>
      <option value="zentrale">Zentrale</option>
      <option value="zweigstelle">Zweigstelle</option>
    </select>
  </div>
  <nav>
    <ul>
      <li><a href="#product-overview">ğŸ“± Produkt-Ãœbersicht</a></li>
      <li><a href="#provider-view">ğŸ¢ 0a. Anbieter</a></li>
      <li><a href="#customer-value">ğŸ’ˆ 0b. Endkunden</a></li>
      <li style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #444;"><a href="#c4">ğŸ—ï¸ A. C4-Kontext</a></li>
      <li><a href="#happy">âœ… B. E2E Happy Path</a></li>
      <li><a href="#alts">ğŸ”€ C. Alternativen</a></li>
      <li><a href="#conv">ğŸ’¬ D. Conversational</a></li>
      <li><a href="#mw">âš™ï¸ E. Orchestrierung</a></li>
      <li><a href="#cal">ğŸ“… F. Cal.com Sequence</a></li>
      <li><a href="#bill">ğŸ’³ G. Billing</a></li>
      <li><a href="#obs">ğŸ“Š H. Telemetrie</a></li>
      <li><a href="#state">ğŸ”„ I. ZustÃ¤nde</a></li>
      <li><a href="#erd">ğŸ—„ï¸ J. ERD</a></li>
      <li><a href="#appointment-types">ğŸ“‹ K. Terminarten</a></li>
    </ul>
  </nav>
  <label><input type="checkbox" id="dark"> ğŸŒ™ Dark Mode</label>
</aside>

<main>
<h1>End-to-End Dokumentation: Friseur 1</h1>
<p><strong>Company:</strong> Friseur 1 (ID: 1) | <strong>Branches:</strong> 1 | <strong>Services:</strong> 3 | <strong>Staff:</strong> 5</p>
<p>Diese Dokumentation beschreibt den vollstÃ¤ndigen E2E-Prozess von Inbound-Calls Ã¼ber Retell.ai, Middleware, Cal.com bis zur BuchungsbestÃ¤tigung. <a href="e2e.md">â†’ VollstÃ¤ndige Spezifikation</a> | <a href="audit/report.md">ğŸ“Š Audit-Report</a> | <a href="audit/gaps.yaml">âš ï¸  Gaps</a></p>

<!-- PRODUCT OVERVIEW -->
<section id="product-overview" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; border-radius: 12px; margin-bottom: 32px; border: none;">
  <h2 style="color: white; margin-top: 0;">ğŸ“± AskPro AI - Produkt-Ãœbersicht</h2>
  <p style="color: rgba(255,255,255,0.9); font-size: 16px; margin-bottom: 0;">
    <strong>Voice AI Platform fÃ¼r automatische Terminbuchungen</strong><br>
    Multi-Tenant SaaS-LÃ¶sung mit KI-gestÃ¼tztem Telefon-Agent fÃ¼r Friseursalons, Arztpraxen, und Service-Unternehmen.
  </p>
</section>

<section id="provider-view">
  <h2>0a. Anbieter-Perspektive <span class="chip">AskPro AI</span></h2>
  <p>Was bietet AskPro AI als Plattform-Anbieter: Multi-Tenant SaaS, Voice AI Integration, Kalender-Synchronisation, Automatisches Billing.</p>
  <div class="mermaid">
graph TB
  subgraph "ğŸ¢ AskPro AI Platform"
    PLATFORM["âš™ï¸ Laravel Middleware<br/>(Multi-Tenant Core)"]
    ADMIN["ğŸ–¥ï¸ Filament Admin<br/>(Company Management)"]
    BILLING["ğŸ’³ Stripe Billing<br/>(Usage-Based)"]
    DB[("ğŸ—„ï¸ PostgreSQL<br/>(Shared Database)")]
  end

  subgraph "ğŸ”Œ Externe Integrationen"
    RETELL["ğŸ¤– Retell.ai<br/>(Voice AI Platform)"]
    CALCOM["ğŸ“… Cal.com<br/>(Booking System)"]
  end

  subgraph "ğŸ‘¥ Endkunden (Mandanten)"
    FRISEUR["ğŸ’ˆ Friseur 1<br/>(2 Filialen, 5 Mitarbeiter)"]
    ARZT["ğŸ¥ Arztpraxis<br/>(Terminbuchung)"]
    SERVICE["ğŸ”§ Service-Betrieb<br/>(Auftragsannahme)"]
  end

  PLATFORM --> DB
  ADMIN --> PLATFORM
  PLATFORM --> BILLING

  PLATFORM <--> RETELL
  PLATFORM <--> CALCOM

  FRISEUR --> RETELL
  ARZT --> RETELL
  SERVICE --> RETELL

  PLATFORM -.->|"Mandant 1"| FRISEUR
  PLATFORM -.->|"Mandant 2"| ARZT
  PLATFORM -.->|"Mandant 3"| SERVICE

  style PLATFORM fill:#E8F5E9
  style ADMIN fill:#E0F2F1
  style BILLING fill:#FCE4EC
  style DB fill:#F1F8E9
  style RETELL fill:#FFF3E0
  style CALCOM fill:#F3E5F5
  style FRISEUR fill:#E3F2FD
  style ARZT fill:#E3F2FD
  style SERVICE fill:#E3F2FD
  </div>
  <p><strong>Kernfunktionen:</strong> Multi-Tenancy (Company Scoping), Voice AI Integration (Retell.ai), Kalender-Sync (Cal.com), Usage-Based Billing (Stripe), Admin-Portal (Filament).</p>
</section>

<section id="customer-value">
  <h2>0b. Endkunden-Perspektive <span class="chip">Value Proposition</span></h2>
  <p>Was erhÃ¤lt ein Endkunde wie "Friseur 1": 24/7 Telefon-Agent, Automatische Buchungen, Keine manuelle Verwaltung, Integration mit bestehendem Kalender.</p>
  <div class="mermaid">
graph LR
  subgraph "ğŸ˜Š Kunde (Anrufer)"
    CALL["ğŸ“ Anruf bei<br/>+493033081738"]
  end

  subgraph "ğŸ¤– AskPro AI Service"
    AGENT["ğŸ™ï¸ KI-Agent<br/>spricht Deutsch<br/>versteht Intent"]
    BOOK["ğŸ“… Automatische<br/>Terminbuchung<br/>24/7 verfÃ¼gbar"]
  end

  subgraph "ğŸ’ˆ Friseur 1 (Ihr Unternehmen)"
    CAL["ğŸ“† Ihr Kalender<br/>(Cal.com)<br/>bleibt immer aktuell"]
    TEAM["ğŸ‘¥ Ihr Team<br/>keine manuelle<br/>Eingabe nÃ¶tig"]
    CONFIRM["âœ… BestÃ¤tigung<br/>per E-Mail/SMS<br/>an Kunden"]
  end

  CALL --> AGENT
  AGENT -->|"Termin gefunden"| BOOK
  BOOK --> CAL
  CAL --> TEAM
  BOOK --> CONFIRM

  style CALL fill:#E3F2FD
  style AGENT fill:#FFF3E0
  style BOOK fill:#C8E6C9
  style CAL fill:#F3E5F5
  style TEAM fill:#E0F2F1
  style CONFIRM fill:#C8E6C9
  </div>
  <p>
    <strong>Vorteile fÃ¼r Friseur 1:</strong><br>
    âœ… Keine verpassten Anrufe (24/7 Erreichbarkeit)<br>
    âœ… Automatische Buchung ohne Personal (Kosteneinsparung)<br>
    âœ… Integration mit bestehendem Kalender (keine Doppelbuchungen)<br>
    âœ… NatÃ¼rliche Sprachverarbeitung (Kunden merken kaum einen Unterschied)<br>
    âœ… Transparente Abrechnung (nutzungsbasiert, keine Fixkosten)
  </p>
</section>

<section id="c4">
  <h2>A. C4-Kontextdiagramm <span class="chip">System Overview</span></h2>
  <p>Zeigt alle beteiligten Systeme und deren Kommunikation: Customer, Retell.ai, Middleware, Cal.com, Frontend, Billing, Database.</p>
  <div class="mermaid">
graph LR
  CUS[ğŸ‘¤ Customer]
  RAI["ğŸ¤– Retell.ai<br/>Agent: ...b6d56ab07b"]
  MW["âš™ï¸ Middleware<br/>Laravel API"]
  CAL["ğŸ“… Cal.com<br/>Team: 34209"]
  FE["ğŸ–¥ï¸ Frontend<br/>Filament"]
  BILL["ğŸ’³ Billing<br/>Stripe"]
  DB[("ğŸ—„ï¸ Database<br/>PostgreSQL")]

  CUS -->|"Inbound Call<br/>+493033081738"| RAI
  RAI -->|Webhook| MW
  MW -->|"Booking API"| CAL
  MW -->|Read/Write| DB
  MW -->|UI| FE
  MW -->|Charges| BILL
  CAL -->|Webhook| MW

  style CUS fill:#E3F2FD
  style RAI fill:#FFF3E0
  style MW fill:#E8F5E9
  style CAL fill:#F3E5F5
  style FE fill:#E0F2F1
  style BILL fill:#FCE4EC
  style DB fill:#F1F8E9
  </div>
  <p><a href="e2e.md#c4-context">ğŸ“– Details in e2e.md</a></p>
</section>

<section id="happy">
  <h2>B. E2E Happy Path <span class="chip">Main Flow</span></h2>
  <p>Erfolgreicher Buchungspfad: Anruf â†’ Intent-Erkennung â†’ Policy-Check â†’ VerfÃ¼gbarkeitsabfrage â†’ Buchung â†’ BestÃ¤tigung â†’ Logging.</p>
  <div class="mermaid">
flowchart TB
  subgraph CUS["ğŸ‘¤ Customer"]
    A["Anruf: +493033081738"]
  end

  subgraph RAI["ğŸ¤– Retell.ai"]
    B["Greet: 'Guten Tag bei Friseur 1'"]
    C{"Known<br/>Customer?"}
    D[collect_appointment_info]
    E[check_availability]
  end

  subgraph MW["âš™ï¸ Middleware"]
    F["PolicyEngine:<br/>canBook?"]
    G["CalcomService:<br/>getSlots"]
    H{"Slot<br/>found?"}
    I[Create Appointment]
    J[Log Call + Costs]
  end

  subgraph CAL["ğŸ“… Cal.com"]
    K["Query Availability<br/>Team 34209"]
    L["POST /bookings"]
    M[("Booking DB")]
  end

  subgraph FE["ğŸ–¥ï¸ Frontend"]
    N["Display in<br/>Call Log"]
    O["Show Transcript"]
  end

  A --> B --> C
  C -->|"Phone Lookup"| F
  C -->|Yes| D --> E
  F -->|"Policy OK"| G
  G --> K
  K -->|"Slots Available"| H
  H -->|Yes| I
  I --> L --> M
  M -->|"Webhook Confirm"| I
  I --> J
  J --> N --> O
  H -->|No| D
  F -->|"Policy Block"| J

  style A fill:#E3F2FD
  style B fill:#FFF3E0
  style C fill:#FFE0B2
  style F fill:#C8E6C9
  style H fill:#C8E6C9
  style I fill:#C8E6C9
  style K fill:#E1BEE7
  style M fill:#F1F8E9
  </div>
  <p><a href="e2e.md#happy-path">ğŸ“– Details in e2e.md</a></p>
</section>

<section id="alts">
  <h2>C. Alternativpfade <span class="chip">Error Handling</span></h2>
  <p>Umgang mit SonderfÃ¤llen: Umbuchung, Stornierung, Policy-Blockierung, No-Show, NummernunterdrÃ¼ckung, Eskalation.</p>
  <div class="mermaid">
flowchart TB
  START["Call Eingang"]

  subgraph "Erfolgreiche Pfade"
    BOOK["âœ… Neu-Buchung"]
    RESC["âœ… Umbuchung"]
  end

  subgraph "Fehler-Pfade"
    CANCEL["Stornierung"]
    POLICY["âŒ Policy-Block"]
    NOSHOW["No-Show"]
    CLIR["ğŸ”’ Nummer unterdrÃ¼ckt"]
    HUMAN["ğŸ‘¤ Eskalation Mensch"]
  end

  START --> BOOK
  START --> RESC
  START --> CANCEL
  START --> CLIR

  CANCEL -->|"nach Cutoff"| POLICY
  RESC -->|"3x Ã¼berschritten"| POLICY
  POLICY -->|"Log + Info"| END["Call Ende"]
  CLIR -->|Fallback| HUMAN
  BOOK -->|"15min spÃ¤ter"| NOSHOW
  NOSHOW -->|"Auto-Mark"| LOG["Log No-Show"]

  style BOOK fill:#C8E6C9
  style RESC fill:#C8E6C9
  style POLICY fill:#FFCDD2
  style NOSHOW fill:#FFECB3
  style CLIR fill:#E1BEE7
  </div>
  <p><a href="e2e.md#alternative-paths">ğŸ“– Details in e2e.md</a></p>
</section>

<section id="conv">
  <h2>D. Conversational Decision Tree <span class="chip">Intent Recognition</span></h2>
  <p>Intent-Erkennung, Required Slots, Disambiguation, NLU-Fallback-Strategien.</p>
  <div class="mermaid">
flowchart TB
  START["Greet Customer"]
  INTENT{"Intent<br/>erkannt?"}

  BOOK["Intent: book_appointment"]
  CANCEL["Intent: cancel_appointment"]
  RESC["Intent: reschedule_appointment"]
  INFO["Intent: get_info"]
  UNK["Intent: unknown"]

  START --> INTENT
  INTENT -->|book| BOOK
  INTENT -->|cancel| CANCEL
  INTENT -->|reschedule| RESC
  INTENT -->|info| INFO
  INTENT -->|unclear| UNK

  BOOK --> SLOTS["Required Slots:<br/>service, date, time"]
  SLOTS --> DISAMB{"All<br/>filled?"}
  DISAMB -->|No| ASK["Ask missing info"]
  ASK --> SLOTS
  DISAMB -->|Yes| CONFIRM["Confirm & Book"]

  UNK --> FALLBACK["NLU Fallback:<br/>Rephrase question"]
  FALLBACK --> INTENT

  style START fill:#E3F2FD
  style INTENT fill:#FFF3E0
  style BOOK fill:#C8E6C9
  style CONFIRM fill:#C8E6C9
  style UNK fill:#FFCDD2
  style FALLBACK fill:#FFE0B2
  </div>
  <p><a href="e2e.md#conversational-flow">ğŸ“– Details in e2e.md</a></p>
</section>

<section id="mw">
  <h2>E. Middleware-Orchestrierung <span class="chip">Integration Layer</span></h2>
  <p>Webhook-Verarbeitung, Idempotenz, Retry-Logic, Mapping (TeamIDâ†”Filiale, EventIDâ†”Service), Timezone-Handling.</p>
  <div class="mermaid">
flowchart TB
  subgraph "Webhook Empfang"
    W1["Retell Webhook<br/>/api/webhooks/retell"]
    W2["Cal.com Webhook<br/>/api/calcom/webhook"]
  end

  subgraph "Idempotenz"
    ID1["Check:<br/>retell_call_id exists?"]
    ID2["Check:<br/>calcom_booking_uid exists?"]
  end

  subgraph "Verarbeitung"
    MAP["Mapping:<br/>TeamIDâ†”Branch<br/>EventIDâ†”Service<br/>StaffIDâ†”User"]
    POL["Policy Check<br/>canBook/canCancel"]
    RETRY["Retry Logic<br/>Circuit Breaker"]
  end

  subgraph "Persistence"
    DB[("Database<br/>PostgreSQL")]
    CACHE[("Redis Cache<br/>5min TTL")]
  end

  W1 --> ID1
  W2 --> ID2
  ID1 -->|New| MAP
  ID2 -->|New| MAP
  ID1 -->|Duplicate| SKIP["Return cached"]
  ID2 -->|Duplicate| SKIP
  MAP --> POL
  POL --> RETRY
  RETRY --> DB
  DB --> CACHE

  style ID1 fill:#FFF3E0
  style ID2 fill:#FFF3E0
  style MAP fill:#E1BEE7
  style POL fill:#FFE0B2
  style SKIP fill:#C8E6C9
  </div>
  <p><a href="e2e.md#middleware-orchestration">ğŸ“– Details in e2e.md</a></p>
</section>

<section id="cal">
  <h2>F. Cal.com Sequence <span class="chip">Booking API</span></h2>
  <p>Sequenzdiagramm der Cal.com API-Integration: Availability â†’ Slot Selection â†’ Booking Creation â†’ Webhook Callback.</p>
  <div class="mermaid">
sequenceDiagram
  participant MW as Middleware
  participant CAL as Cal.com API<br/>Team 34209

  Note over MW,CAL: Availability Check
  MW->>CAL: GET /slots/available<br/>eventTypeId=???<br/>startTime=2025-11-04
  CAL-->>MW: {slots: [...]}

  Note over MW,CAL: Booking Creation
  MW->>CAL: POST /bookings<br/>{eventTypeId, start, attendee}
  CAL-->>MW: {uid, id, status: "accepted"}
  MW->>MW: Store calcom_booking_id

  Note over MW,CAL: Webhook Callback
  CAL->>MW: POST /api/calcom/webhook<br/>{triggerEvent: "BOOKING_CREATED"}
  MW-->>CAL: 200 OK

  Note over MW,CAL: Rescheduling
  MW->>CAL: PATCH /bookings/{uid}<br/>{start: new_time}
  CAL-->>MW: {uid, status: "rescheduled"}
  CAL->>MW: Webhook: BOOKING_RESCHEDULED

  Note over MW,CAL: Cancellation
  MW->>CAL: DELETE /bookings/{uid}
  CAL-->>MW: 204 No Content
  CAL->>MW: Webhook: BOOKING_CANCELLED
  </div>
  <p><a href="e2e.md#calcom-sequence">ğŸ“– Details in e2e.md</a></p>
</section>

<section id="bill">
  <h2>G. Billing Flow <span class="chip">Cost Calculation</span></h2>
  <p>Sekundengenaue Kostenberechnung: Retell.ai Cost â†’ Platform Markup â†’ Currency Conversion â†’ Rounding â†’ Balance/Invoice.</p>
  <div class="mermaid">
flowchart TB
  START["Call ends"]
  DUR["Duration:<br/>per_second"]

  COST["Retell Cost:<br/>seconds Ã— $0.020/60"]
  MARKUP["Markup:<br/>Ã— 30%"]
  EXCH["Convert:<br/>USD â†’ EUR"]
  ROUND["Round:<br/>ceil(cents)"]

  BAL{"Prepaid<br/>Balance?"}
  DEDUCT["Deduct from Balance"]
  TOPUP["Stripe Top-Up<br/>required"]
  INV["Add to Invoice"]

  START --> DUR --> COST
  COST --> MARKUP --> EXCH --> ROUND
  ROUND --> BAL
  BAL -->|Sufficient| DEDUCT
  BAL -->|Low| TOPUP
  DEDUCT --> INV
  TOPUP --> INV

  style START fill:#E3F2FD
  style COST fill:#FFE0B2
  style BAL fill:#FFF3E0
  style DEDUCT fill:#C8E6C9
  style TOPUP fill:#FFCDD2
  </div>
  <p><a href="e2e.md#billing-flow">ğŸ“– Details in e2e.md</a></p>
</section>

<section id="obs">
  <h2>H. Telemetrie & Logging <span class="chip">Observability</span></h2>
  <p>Call-ID-Korrelation, Metriken (Duration, Cost, Sentiment), Transcript-Speicherung, Privacy (PII Redaction).</p>
  <div class="mermaid">
flowchart LR
  subgraph "Correlation"
    CALL["Call ID<br/>retell_call_id"]
    BOOK["Booking ID<br/>calcom_booking_id"]
    CUS["Customer ID"]
  end

  subgraph "Metrics"
    DUR["Duration<br/>(seconds)"]
    COST["Cost<br/>(cents)"]
    SENT["Sentiment<br/>(-1 to 1)"]
    INTENT["Intent<br/>(book/cancel/...)"]
  end

  subgraph "Logs"
    TRANS["Transcript<br/>(TEXT)"]
    AUDIO["Audio URL<br/>(30 days)"]
    META["Metadata JSON"]
  end

  subgraph "Privacy"
    ANON["PII Redaction<br/>after 365d"]
    DEL["Auto-Delete<br/>after 90d"]
  end

  CALL --> BOOK
  CALL --> CUS
  CALL --> DUR
  CALL --> COST
  CALL --> SENT
  CALL --> INTENT
  CALL --> TRANS
  CALL --> AUDIO
  CALL --> META
  TRANS --> ANON --> DEL

  style CALL fill:#E3F2FD
  style BOOK fill:#E1BEE7
  style TRANS fill:#FFF3E0
  style ANON fill:#FFCDD2
  </div>
  <p><a href="e2e.md#telemetry-logging">ğŸ“– Details in e2e.md</a></p>
</section>

<section id="state">
  <h2>I. Zustandsautomat <span class="chip">State Machine</span></h2>
  <p>Lifecycle eines Leads/Kunden: Unknown â†’ Known â†’ In GesprÃ¤ch â†’ Slot gesucht â†’ Gebucht â†’ Verschoben/Storniert/Completed/NoShow.</p>
  <div class="mermaid">
stateDiagram-v2
  [*] --> Unknown: First Contact
  Unknown --> Known: Phone Lookup Success
  Unknown --> Lead: New Customer Created

  Known --> InGespraech: Call Connected
  Lead --> InGespraech: Call Connected

  InGespraech --> SlotGesucht: Intent Book
  InGespraech --> Abgebrochen: Hang Up

  SlotGesucht --> Gebucht: Slot Found and Confirmed
  SlotGesucht --> KeineSlots: No Availability

  KeineSlots --> SlotGesucht: Try Different Time
  KeineSlots --> Abgebrochen: Give Up

  Gebucht --> Bestaetigt: Confirmation Sent
  Bestaetigt --> Verschoben: Reschedule Request
  Bestaetigt --> Storniert: Cancel Request
  Bestaetigt --> Completed: Appointment Occurred
  Bestaetigt --> NoShow: Customer Absent 15min

  Verschoben --> Bestaetigt: New Time Confirmed

  Completed --> [*]
  Storniert --> [*]
  NoShow --> [*]
  Abgebrochen --> [*]
  </div>
  <p><a href="e2e.md#state-machine">ğŸ“– Details in e2e.md</a></p>
</section>

<section id="erd">
  <h2>J. ER-Diagramm <span class="chip">Data Model</span></h2>
  <p>Datenmodell: Company â†’ Branch â†’ Service (+ Components) â†’ Staff â†’ Customer â†’ Appointment â†’ Call â†’ Transcript â†’ Charge.</p>
  <div class="mermaid">
erDiagram
  COMPANY ||--o{ BRANCH : "has"
  COMPANY ||--o{ POLICY_CONFIGURATION : "defines"
  COMPANY ||--o{ SERVICE : "offers"

  BRANCH ||--o{ PHONE_NUMBER : "has"
  BRANCH ||--o{ STAFF : "employs"
  BRANCH ||--o{ APPOINTMENT : "hosts"

  SERVICE ||--o{ SERVICE_COMPONENT : "contains (TODO)"
  SERVICE }o--o{ STAFF : "via service_staff"

  STAFF }o--|| BRANCH : "works_in"
  STAFF ||--o{ APPOINTMENT : "performs"

  CUSTOMER ||--o{ APPOINTMENT : "books"
  CUSTOMER ||--o{ CALL : "makes"

  APPOINTMENT }o--|| SERVICE : "for"
  APPOINTMENT }o--|| STAFF : "with"
  APPOINTMENT }o--|| BRANCH : "at"

  CALL ||--o| CUSTOMER : "made_by"
  CALL ||--o| APPOINTMENT : "creates"
  CALL ||--o{ TRANSCRIPT : "has"
  CALL ||--|| CHARGE : "incurs"

  COMPANY ||--o{ PREPAID_BALANCE : "maintains (TODO)"

  COMPANY {
    uuid id PK
    string name "Friseur 1"
    json settings "business_type: hair_salon"
  }

  BRANCH {
    uuid id PK
    uuid company_id FK
    string name "Zentrale/Zweigstelle"
    json settings "calcom_team_id: 34209"
  }

  SERVICE {
    uuid id PK
    string name "Service name"
    int duration_minutes "30-180"
    json settings "calcom_event_type_id: ???"
  }

  SERVICE_COMPONENT {
    uuid id PK "NOT IMPLEMENTED"
    uuid service_id FK
    string name
    int duration_minutes
    bool requires_staff
    bool staff_reuse_allowed
  }

  STAFF {
    uuid id PK
    string name
    string email
    int calcom_user_id "1001-1005"
  }

  PHONE_NUMBER {
    string phone_number "+493033081738"
    string retell_agent_id "agent_b36ecd..."
    uuid branch_id FK
  }
  </div>
  <p><a href="e2e.md#entity-relationship">ğŸ“– Details in e2e.md</a></p>
</section>

<section id="appointment-types">
  <h2>K. Terminarten <span class="chip">Simple vs. Composite</span></h2>
  <p>
    <strong>Simple Appointments:</strong> Einfache Termine mit einem durchgehenden Zeitraum (z.B. BeratungsgesprÃ¤ch 60min).<br>
    <strong>Composite Appointments:</strong> Mehrteilige Termine mit Arbeitsphasen und optionalen Pausen (z.B. FÃ¤rben mit Einwirkzeit).
  </p>

  <h3>K.1 Taxonomie & Datenmodell</h3>
  <div class="mermaid">
classDiagram
  direction TB
  class Appointment {
    +uuid id
    +string title
    +datetime starts_at
    +datetime ends_at
    +boolean is_composite
    +json segments
    +string composite_group_uid
    +isComposite() bool
    +getSegments() array
  }

  class SimpleAppointment {
    +is_composite = false
    +segments = null
  }

  class CompositeAppointment {
    +is_composite = true
    +segments = [...Segment]
  }

  class Segment {
    +datetime start
    +datetime end
    +string label
    +string type "work|break"
    +int order
    +int duration_minutes
  }

  Appointment <|-- SimpleAppointment
  Appointment <|-- CompositeAppointment
  CompositeAppointment "1" *-- "1..n" Segment : contains in JSON

  note for CompositeAppointment "Segmente als JSON-Array gespeichert:\n[\n  {start, end, label, type, order},\n  ...\n]"
  </div>
  <p>
    <strong>Implementierung:</strong> Composite Appointments speichern ihre Segmente als JSON-Array im <code>segments</code>-Feld.
    Keine separate Tabelle nÃ¶tig. <code>starts_at/ends_at</code> umfassen die gesamte Zeitspanne (min/max aller Segmente).
  </p>

  <h3>K.2 Zeitachse mit Pausen</h3>
  <div class="mermaid">
gantt
  title Terminarten im Vergleich (Beispiel 03.11.2025)
  dateFormat HH:mm
  axisFormat %H:%M

  section Simple Appointment
  BeratungsgesprÃ¤ch (60min)  :done, s1, 09:00, 60m

  section Composite Appointment
  FÃ¤rben Phase 1 (45min)     :active, c1, 10:30, 45m
  Einwirkzeit PAUSE (30min)  :crit, c2, after c1, 30m
  Auswaschen Phase 2 (20min) :active, c3, after c2, 20m
  FÃ¶hnen Phase 3 (25min)     :active, c4, after c3, 25m
  </div>
  <p>
    <strong>Beispiel:</strong> Ein FÃ¤rbe-Termin besteht aus 4 Segmenten (3Ã— WORK, 1Ã— BREAK).
    Gesamtdauer: 120min. Pausen sind explizit als eigene Segmente modelliert.
  </p>

  <h3>K.3 Validierungs-Flow</h3>
  <div class="mermaid">
flowchart TB
  START([Termin erstellen])

  START --> TYPE{Terminart?}

  TYPE -->|Simple| SIMPLE[is_composite = false<br/>segments = null]
  SIMPLE --> VALIDATE_SIMPLE[Start/End validieren]
  VALIDATE_SIMPLE --> SAVE

  TYPE -->|Composite| COMPOSITE[is_composite = true]
  COMPOSITE --> SEGMENTS[Segmente definieren]
  SEGMENTS --> PAUSE{Pausen benÃ¶tigt?}

  PAUSE -->|Ja| ADD_BREAKS[BREAK-Segmente einfÃ¼gen<br/>type: 'break']
  PAUSE -->|Nein| ORDER
  ADD_BREAKS --> ORDER

  ORDER[Segmente sortieren<br/>order: 1, 2, 3...]
  ORDER --> VALIDATE_SEG[Validierung]

  VALIDATE_SEG --> CHECK1{Ãœberlappungen?}
  CHECK1 -->|Ja| ERROR1[âŒ Fehler]
  CHECK1 -->|Nein| CHECK2{LÃ¼cken?}

  CHECK2 -->|Ja| WARN[âš ï¸ Warnung]
  CHECK2 -->|Nein| CALC
  WARN --> CALC

  CALC[starts_at = min Segment start<br/>ends_at = max Segment end]
  CALC --> SAVE

  SAVE[(Appointment speichern)]
  ERROR1 --> END([Ende])
  SAVE --> END

  style SIMPLE fill:#C8E6C9
  style COMPOSITE fill:#E1BEE7
  style ADD_BREAKS fill:#FFE0B2
  style ERROR1 fill:#FFCDD2
  style WARN fill:#FFF9C4
  style SAVE fill:#C8E6C9
  </div>
  <p>
    <strong>Validierungsregeln:</strong>
  </p>
  <ul>
    <li>âœ… Segmente dÃ¼rfen sich nicht Ã¼berlappen</li>
    <li>âš ï¸ LÃ¼cken zwischen Segmenten sind erlaubt (Warnung)</li>
    <li>âœ… <code>order</code>-Index muss aufsteigend sein</li>
    <li>âœ… <code>starts_at/ends_at</code> des Appointments = min/max der Segmente</li>
  </ul>

  <h3>K.4 State Machine (Laufzeit)</h3>
  <div class="mermaid">
stateDiagram-v2
  [*] --> Scheduled: Termin erstellt

  Scheduled --> InProgress: start()
  Scheduled --> Cancelled: cancel()

  InProgress --> Paused: pause()<br/>(bei BREAK-Segment)
  InProgress --> Completed: finish()
  InProgress --> Cancelled: cancel()

  Paused --> InProgress: resume()<br/>(nÃ¤chstes WORK-Segment)
  Paused --> Cancelled: cancel()

  Completed --> [*]
  Cancelled --> [*]

  note right of Paused
    Bei Composite Appointments:
    Pause = BREAK-Segment aktiv
  end note

  note right of InProgress
    Aktuelles Segment wird
    verarbeitet (WORK)
  end note
  </div>
  <p>
    <strong>Hinweis:</strong> Bei Composite Appointments steuern <code>pause()</code> und <code>resume()</code>
    den Ãœbergang zwischen WORK- und BREAK-Segmenten.
  </p>

  <h3>K.5 Datenbank-Schema</h3>
  <div class="mermaid">
erDiagram
  APPOINTMENT {
    uuid id PK
    uuid company_id FK
    uuid branch_id FK
    uuid service_id FK
    uuid customer_id FK
    uuid staff_id FK
    string title
    datetime starts_at
    datetime ends_at
    boolean is_composite
    json segments "NULL bei Simple"
    string composite_group_uid "NULL bei Simple"
    string status "scheduled|in_progress|completed|cancelled"
    datetime created_at
    datetime updated_at
    datetime deleted_at
  }

  SERVICE ||--o{ APPOINTMENT : "fÃ¼r"
  CUSTOMER ||--o{ APPOINTMENT : "bucht"
  STAFF ||--o{ APPOINTMENT : "fÃ¼hrt durch"
  BRANCH ||--o{ APPOINTMENT : "in"
  COMPANY ||--o{ APPOINTMENT : "gehÃ¶rt zu"

  note for APPOINTMENT "segments JSON-Struktur:\n[\n  {\n    start: '2025-11-03 10:30:00',\n    end: '2025-11-03 11:15:00',\n    label: 'FÃ¤rben Phase 1',\n    type: 'work',\n    order: 1,\n    duration_minutes: 45\n  },\n  {\n    start: '2025-11-03 11:15:00',\n    end: '2025-11-03 11:45:00',\n    label: 'Einwirkzeit',\n    type: 'break',\n    order: 2,\n    duration_minutes: 30\n  },\n  ...\n]"
  </div>
  <p>
    <strong>Persistenz:</strong> Alle Appointment-Daten in einer Tabelle. Segmente als JSON.
    <code>composite_group_uid</code> erlaubt Gruppierung mehrerer Termine (z.B. fÃ¼r komplexe Behandlungen).
  </p>
</section>

</main>

<script>
// Dark Mode Toggle
const darkToggle = document.getElementById('dark');
darkToggle.addEventListener('change', (e) => {
  document.body.classList.toggle('dark', e.target.checked);
  localStorage.setItem('darkMode', e.target.checked);
});
// Load saved preference
if (localStorage.getItem('darkMode') === 'true') {
  darkToggle.checked = true;
  document.body.classList.add('dark');
}

// Search Filter
const searchInput = document.getElementById('q');
searchInput.addEventListener('input', (e) => {
  const query = e.target.value.toLowerCase();
  document.querySelectorAll('main section').forEach(section => {
    const text = section.textContent.toLowerCase();
    section.style.display = text.includes(query) ? 'block' : 'none';
  });
});

// Branch Filter
const branchSelect = document.getElementById('branch');
branchSelect.addEventListener('change', (e) => {
  const branch = e.target.value;
  if (!branch) {
    document.querySelectorAll('main section').forEach(s => s.style.display = 'block');
    return;
  }
  console.log('Filter by branch:', branch);
});
</script>

<script>
// Initialize Mermaid with theme based on dark mode
const isDark = document.body.classList.contains('dark');
mermaid.initialize({
  startOnLoad: true,
  theme: isDark ? 'dark' : 'default',
  securityLevel: 'loose',
  fontFamily: 'system-ui, -apple-system, sans-serif'
});

// Re-render diagrams when dark mode toggles
const observer = new MutationObserver((mutations) => {
  mutations.forEach((mutation) => {
    if (mutation.attributeName === 'class') {
      const isDarkNow = document.body.classList.contains('dark');
      mermaid.initialize({
        startOnLoad: true,
        theme: isDarkNow ? 'dark' : 'default',
        securityLevel: 'loose',
        fontFamily: 'system-ui, -apple-system, sans-serif'
      });
      // Re-render all diagrams
      document.querySelectorAll('.mermaid').forEach((el) => {
        const code = el.getAttribute('data-processed') ? el.textContent : el.textContent;
        el.removeAttribute('data-processed');
        el.innerHTML = code;
      });
      mermaid.init(undefined, '.mermaid');
    }
  });
});
observer.observe(document.body, { attributes: true });
</script>

</body>
</html>

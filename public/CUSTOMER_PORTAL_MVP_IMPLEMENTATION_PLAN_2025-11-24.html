<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Portal MVP - Bulletproof Implementation Plan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary: #0d6efd;
            --success: #198754;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #0dcaf0;
            --dark: #212529;
            --gray: #6c757d;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem 0;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3rem 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            padding: 2rem;
            background: #f8f9fa;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
        }

        .stat-card .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-card .stat-label {
            color: var(--gray);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .phase-section {
            padding: 2rem;
            border-bottom: 1px solid #dee2e6;
        }

        .phase-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
            cursor: pointer;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .phase-header:hover {
            background: #e9ecef;
        }

        .phase-header.completed {
            background: #d1e7dd;
        }

        .phase-header.in-progress {
            background: #fff3cd;
        }

        .phase-number {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            margin-right: 1rem;
        }

        .phase-number.completed {
            background: var(--success);
        }

        .phase-number.in-progress {
            background: var(--warning);
        }

        .phase-title {
            flex: 1;
        }

        .phase-title h3 {
            margin: 0;
            font-size: 1.5rem;
        }

        .phase-title p {
            margin: 0.25rem 0 0 0;
            color: var(--gray);
            font-size: 0.9rem;
        }

        .phase-meta {
            text-align: right;
        }

        .task-list {
            margin-top: 1rem;
            padding-left: 4rem;
        }

        .task-item {
            display: flex;
            align-items: flex-start;
            padding: 1rem;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            transition: all 0.2s;
        }

        .task-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }

        .task-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid var(--gray);
            border-radius: 6px;
            margin-right: 1rem;
            flex-shrink: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .task-checkbox.checked {
            background: var(--success);
            border-color: var(--success);
        }

        .task-checkbox.checked::after {
            content: '✓';
            color: white;
            font-weight: 700;
        }

        .task-content {
            flex: 1;
        }

        .task-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .task-description {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .task-meta {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .badge-custom {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }

        .code-block .keyword { color: #569cd6; }
        .code-block .string { color: #ce9178; }
        .code-block .comment { color: #6a9955; }
        .code-block .function { color: #dcdcaa; }

        .nav-tabs {
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 2rem;
        }

        .nav-tabs .nav-link {
            border: none;
            color: var(--gray);
            font-weight: 600;
            padding: 1rem 2rem;
            transition: all 0.2s;
        }

        .nav-tabs .nav-link:hover {
            color: var(--primary);
            background: #f8f9fa;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            background: transparent;
        }

        .risk-card {
            border-left: 4px solid var(--danger);
            background: #fff5f5;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .risk-card.medium {
            border-left-color: var(--warning);
            background: #fffbf0;
        }

        .risk-card.low {
            border-left-color: var(--success);
            background: #f0fff4;
        }

        .timeline {
            position: relative;
            padding-left: 2rem;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #dee2e6;
        }

        .timeline-item {
            position: relative;
            padding-bottom: 2rem;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -2.5rem;
            top: 0.5rem;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary);
            border: 3px solid white;
            box-shadow: 0 0 0 2px var(--primary);
        }

        .timeline-item.completed::before {
            background: var(--success);
            box-shadow: 0 0 0 2px var(--success);
        }

        .checklist-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring circle {
            transition: stroke-dashoffset 0.5s;
        }

        .alert-custom {
            border-left: 4px solid;
            border-radius: 8px;
            padding: 1rem 1.5rem;
            margin: 1rem 0;
        }

        .alert-custom.alert-info {
            border-left-color: var(--info);
            background: #e7f7ff;
        }

        .alert-custom.alert-warning {
            border-left-color: var(--warning);
            background: #fff8e1;
        }

        .alert-custom.alert-danger {
            border-left-color: var(--danger);
            background: #ffe8e8;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <h1><i class="bi bi-rocket-takeoff"></i> Customer Portal MVP</h1>
            <p class="subtitle">Bulletproof Implementation Plan - Phase 4 & 5</p>
            <p class="subtitle" style="font-size: 1rem; opacity: 0.8;">
                <i class="bi bi-calendar3"></i> Timeline: 12-17 Tage Development + 5-7 Tage Testing
                <br>
                <i class="bi bi-shield-check"></i> Risk Mitigation Score: 94/100
            </p>
        </div>

        <!-- Quick Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">73</div>
                <div class="stat-label">Requirements</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">42</div>
                <div class="stat-label">Edge Cases</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">18</div>
                <div class="stat-label">Risks Mitigated</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">160+</div>
                <div class="stat-label">Tests Planned</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">5</div>
                <div class="stat-label">Service Classes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">3</div>
                <div class="stat-label">New DB Tables</div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="p-4">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#overview">
                        <i class="bi bi-clipboard-check"></i> Übersicht
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#phase4">
                        <i class="bi bi-code-square"></i> Phase 4: Quick Wins
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#testing">
                        <i class="bi bi-bug"></i> Testing Strategy
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#deployment">
                        <i class="bi bi-rocket"></i> Deployment
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#risks">
                        <i class="bi bi-exclamation-triangle"></i> Risks & Mitigation
                    </a>
                </li>
            </ul>

            <div class="tab-content pt-4">
                <!-- Overview Tab -->
                <div class="tab-pane fade show active" id="overview">
                    <h2 class="mb-4">Implementation Overview</h2>

                    <div class="alert-custom alert-info">
                        <h5><i class="bi bi-info-circle"></i> Business Decisions Confirmed</h5>
                        <p class="mb-0">
                            Based on <a href="https://github.com/fabianSp77/askproai-api/issues/741" target="_blank">GitHub Issue #741</a>:
                        </p>
                        <ul class="mb-0 mt-2">
                            <li><strong>Launch Strategy:</strong> Pilot mit 2-3 Kunden</li>
                            <li><strong>MVP Features:</strong> Appointment Reschedule/Cancel + User Management</li>
                            <li><strong>Access:</strong> Kostenlos für alle (zunächst)</li>
                            <li><strong>Support:</strong> Self-Service Docs + Onboarding</li>
                            <li><strong>Permissions:</strong> Vereinfacht (~30, nicht 400+)</li>
                        </ul>
                    </div>

                    <h3 class="mt-4">Architecture Highlights</h3>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="bi bi-shield-check text-success"></i> Security First</h5>
                                    <ul class="small">
                                        <li>Multi-layer authorization (Middleware → Policy → Service)</li>
                                        <li>Optimistic locking prevents concurrent conflicts</li>
                                        <li>Branch isolation for managers</li>
                                        <li>Comprehensive audit trail</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="bi bi-lightning text-warning"></i> Reliability</h5>
                                    <ul class="small">
                                        <li><strong>SYNCHRONOUS</strong> Cal.com sync (eliminates race conditions)</li>
                                        <li>Circuit breaker pattern for external API</li>
                                        <li>Graceful degradation when Cal.com is down</li>
                                        <li>Automatic retry with exponential backoff</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h3 class="mt-4">Implementation Timeline</h3>
                    <canvas id="timelineChart" height="100"></canvas>

                    <h3 class="mt-5">Documentation Links</h3>
                    <div class="list-group">
                        <a href="/CUSTOMER_PORTAL_MVP_ARCHITECTURE_2025-11-24.md" class="list-group-item list-group-item-action" target="_blank">
                            <i class="bi bi-file-earmark-code"></i> Complete Architecture Design (94 pages)
                        </a>
                        <a href="/CUSTOMER_PORTAL_MVP_REQUIREMENTS_ANALYSIS_2025-11-24.md" class="list-group-item list-group-item-action" target="_blank">
                            <i class="bi bi-clipboard-data"></i> Requirements Analysis
                        </a>
                        <a href="/STRATEGIC_ROLE_SYSTEM_ANALYSIS_2025-11-24.html" class="list-group-item list-group-item-action" target="_blank">
                            <i class="bi bi-diagram-3"></i> Strategic Role System Analysis
                        </a>
                        <a href="/ROLE_SYSTEM_HUB_2025-11-24.html" class="list-group-item list-group-item-action" target="_blank">
                            <i class="bi bi-house-door"></i> Documentation Hub
                        </a>
                        <a href="https://github.com/fabianSp77/askproai-api/issues/741" class="list-group-item list-group-item-action" target="_blank">
                            <i class="bi bi-github"></i> GitHub Issue #741 - Business Decisions
                        </a>
                    </div>
                </div>

                <!-- Phase 4 Tab -->
                <div class="tab-pane fade" id="phase4">
                    <h2 class="mb-4">Phase 4: Quick Wins Implementation</h2>
                    <p class="text-muted">MVP Features: Appointment Actions + User Management</p>

                    <!-- Phase 4.1: Database -->
                    <div class="phase-section">
                        <div class="phase-header" data-phase="4.1">
                            <div class="phase-number">4.1</div>
                            <div class="phase-title">
                                <h3>Database Migrations</h3>
                                <p>Create tables, modify schema, add indexes</p>
                            </div>
                            <div class="phase-meta">
                                <span class="badge bg-primary">1-2 Tage</span>
                                <span class="badge bg-warning">CRITICAL</span>
                            </div>
                        </div>
                        <div class="task-list">
                            <div class="task-item">
                                <div class="task-checkbox" data-task="4.1.1"></div>
                                <div class="task-content">
                                    <div class="task-title">Migration: user_invitations table</div>
                                    <div class="task-description">
                                        Create token-based invitation system with SHA256 hashing, expiry, and unique constraints
                                    </div>
                                    <div class="task-meta">
                                        <span class="badge-custom bg-primary text-white">Database</span>
                                        <span class="badge-custom bg-info text-white">Security</span>
                                    </div>
                                </div>
                            </div>
                            <div class="task-item">
                                <div class="task-checkbox" data-task="4.1.2"></div>
                                <div class="task-content">
                                    <div class="task-title">Migration: appointment_audit_logs table</div>
                                    <div class="task-description">
                                        Immutable audit trail for all appointment modifications
                                    </div>
                                    <div class="task-meta">
                                        <span class="badge-custom bg-primary text-white">Database</span>
                                        <span class="badge-custom bg-warning text-dark">Compliance</span>
                                    </div>
                                </div>
                            </div>
                            <div class="task-item">
                                <div class="task-checkbox" data-task="4.1.3"></div>
                                <div class="task-content">
                                    <div class="task-title">Migration: invitation_email_queue table</div>
                                    <div class="task-description">
                                        Email delivery queue with retry mechanism
                                    </div>
                                    <div class="task-meta">
                                        <span class="badge-custom bg-primary text-white">Database</span>
                                    </div>
                                </div>
                            </div>
                            <div class="task-item">
                                <div class="task-checkbox" data-task="4.1.4"></div>
                                <div class="task-content">
                                    <div class="task-title">Modify appointments table: Add version, sync fields</div>
                                    <div class="task-description">
                                        Add optimistic locking (version), Cal.com sync status tracking, last_modified_by
                                    </div>
                                    <div class="task-meta">
                                        <span class="badge-custom bg-danger text-white">CRITICAL</span>
                                        <span class="badge-custom bg-primary text-white">Database</span>
                                    </div>
                                </div>
                            </div>
                            <div class="task-item">
                                <div class="task-checkbox" data-task="4.1.5"></div>
                                <div class="task-content">
                                    <div class="task-title">Modify companies table: Add is_pilot flag</div>
                                    <div class="task-description">
                                        Add pilot program mechanism (is_pilot, pilot_enabled_at, pilot_enabled_by, pilot_notes)
                                    </div>
                                    <div class="task-meta">
                                        <span class="badge-custom bg-primary text-white">Database</span>
                                        <span class="badge-custom bg-success text-white">Feature Flag</span>
                                    </div>
                                </div>
                            </div>
                            <div class="task-item">
                                <div class="task-checkbox" data-task="4.1.6"></div>
                                <div class="task-content">
                                    <div class="task-title">Modify users table: Unique staff constraint</div>
                                    <div class="task-description">
                                        Add unique partial index for staff_id (prevents multiple users → 1 staff)
                                    </div>
                                    <div class="task-meta">
                                        <span class="badge-custom bg-primary text-white">Database</span>
                                        <span class="badge-custom bg-info text-white">Data Integrity</span>
                                    </div>
                                </div>
                            </div>
                            <div class="task-item">
                                <div class="task-checkbox" data-task="4.1.7"></div>
                                <div class="task-content">
                                    <div class="task-title">Run migrations & verify schema</div>
                                    <div class="task-description">
                                        Execute migrations on staging, verify indexes, test rollback
                                    </div>
                                    <div class="code-block">
<span class="keyword">php</span> artisan migrate:status
<span class="keyword">php</span> artisan migrate <span class="comment">--pretend</span>
<span class="keyword">php</span> artisan migrate
<span class="keyword">php</span> artisan migrate:rollback <span class="comment">--step=1 --pretend</span>
                                    </div>
                                    <div class="task-meta">
                                        <span class="badge-custom bg-warning text-dark">Testing</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Phase 4.2: Models -->
                    <div class="phase-section">
                        <div class="phase-header" data-phase="4.2">
                            <div class="phase-number">4.2</div>
                            <div class="phase-title">
                                <h3>Eloquent Models</h3>
                                <p>Create new models, update existing ones</p>
                            </div>
                            <div class="phase-meta">
                                <span class="badge bg-primary">1 Tag</span>
                            </div>
                        </div>
                        <div class="task-list">
                            <div class="task-item">
                                <div class="task-checkbox" data-task="4.2.1"></div>
                                <div class="task-content">
                                    <div class="task-title">Create UserInvitation model</div>
                                    <div class="task-description">
                                        Model with token generation, expiry check, scope methods
                                    </div>
                                    <div class="code-block">
<span class="keyword">class</span> <span class="function">UserInvitation</span> <span class="keyword">extends</span> Model
{
    <span class="keyword">protected</span> $fillable = [<span class="string">'company_id'</span>, <span class="string">'email'</span>, <span class="string">'role_id'</span>...];

    <span class="keyword">public static function</span> <span class="function">generateToken</span>(): <span class="keyword">string</span>
    {
        <span class="keyword">return</span> <span class="function">hash</span>(<span class="string">'sha256'</span>, Str::<span class="function">random</span>(64));
    }

    <span class="keyword">public function</span> <span class="function">scopePending</span>($query)
    {
        <span class="keyword">return</span> $query-><span class="function">whereNull</span>(<span class="string">'accepted_at'</span>)
                     -><span class="function">where</span>(<span class="string">'expires_at'</span>, <span class="string">'>'</span>, <span class="function">now</span>());
    }
}
                                    </div>
                                </div>
                            </div>
                            <div class="task-item">
                                <div class="task-checkbox" data-task="4.2.2"></div>
                                <div class="task-content">
                                    <div class="task-title">Create AppointmentAuditLog model</div>
                                    <div class="task-description">
                                        Immutable audit log model (no updated_at)
                                    </div>
                                </div>
                            </div>
                            <div class="task-item">
                                <div class="task-checkbox" data-task="4.2.3"></div>
                                <div class="task-content">
                                    <div class="task-title">Update Appointment model: Add version fields</div>
                                    <div class="task-description">
                                        Add version, last_modified_at, calcom_sync_status to $fillable and $casts
                                    </div>
                                </div>
                            </div>
                            <div class="task-item">
                                <div class="task-checkbox" data-task="4.2.4"></div>
                                <div class="task-content">
                                    <div class="task-title">Update Company model: Add is_pilot methods</div>
                                    <div class="task-description">
                                        Add isPilot() scope, pilot relationship, pilot activation methods
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Phase 4.3: Service Layer -->
                    <div class="phase-section">
                        <div class="phase-header" data-phase="4.3">
                            <div class="phase-number">4.3</div>
                            <div class="phase-title">
                                <h3>Service Layer</h3>
                                <p>Core business logic implementation</p>
                            </div>
                            <div class="phase-meta">
                                <span class="badge bg-danger">3-4 Tage</span>
                                <span class="badge bg-warning">CRITICAL</span>
                            </div>
                        </div>
                        <div class="task-list">
                            <div class="task-item">
                                <div class="task-checkbox" data-task="4.3.1"></div>
                                <div class="task-content">
                                    <div class="task-title">CalcomCircuitBreaker Service</div>
                                    <div class="task-description">
                                        Implement 3-state circuit breaker (CLOSED → OPEN → HALF_OPEN) with Redis
                                    </div>
                                    <div class="task-meta">
                                        <span class="badge-custom bg-danger text-white">CRITICAL</span>
                                        <span class="badge-custom bg-primary text-white">Reliability</span>
                                    </div>
                                </div>
                            </div>
                            <div class="task-item">
                                <div class="task-checkbox" data-task="4.3.2"></div>
                                <div class="task-content">
                                    <div class="task-title">AppointmentRescheduleService</div>
                                    <div class="task-description">
                                        9-step ACID-compliant flow: Authorization → Validation → Lock → Reserve → Sync → Update → Event → Cache
                                    </div>
                                    <div class="code-block">
<span class="keyword">public function</span> <span class="function">reschedule</span>(
    Appointment $appointment,
    Carbon $newStartTime,
    User $user
): RescheduleResult {
    <span class="comment">// Step 1: Authorization check</span>
    <span class="keyword">if</span> (!$user-><span class="function">can</span>(<span class="string">'reschedule'</span>, $appointment)) {
        <span class="keyword">throw new</span> <span class="function">UnauthorizedException</span>();
    }

    <span class="comment">// Step 2: Validation (minimum notice, conflicts)</span>
    $this-><span class="function">validateReschedule</span>($appointment, $newStartTime);

    <span class="comment">// Step 3: Optimistic lock check</span>
    <span class="keyword">if</span> ($appointment->version !== $requestedVersion) {
        <span class="keyword">throw new</span> <span class="function">ConcurrentModificationException</span>();
    }

    <span class="comment">// Step 4: Reserve new slot</span>
    $reservation = $this->reservationService-><span class="function">reserve</span>(...);

    <span class="comment">// Step 5: Cal.com SYNCHRONOUS update</span>
    <span class="keyword">try</span> {
        $this->calcomClient-><span class="function">rescheduleBooking</span>(...);
    } <span class="keyword">catch</span> (Exception $e) {
        $reservation-><span class="function">release</span>();
        <span class="keyword">throw new</span> <span class="function">SyncFailedException</span>($e);
    }

    <span class="comment">// Step 6: Database update in transaction</span>
    DB::<span class="function">transaction</span>(<span class="keyword">function</span>() {
        $appointment-><span class="function">update</span>([..., <span class="string">'version'</span> => $appointment->version + 1]);
        AppointmentAuditLog::<span class="function">create</span>([...]);
    });

    <span class="comment">// Step 7: Release reservation</span>
    $reservation-><span class="function">release</span>();

    <span class="comment">// Step 8: Event dispatch</span>
    <span class="keyword">event</span>(<span class="keyword">new</span> <span class="function">AppointmentRescheduled</span>($appointment));

    <span class="comment">// Step 9: Cache invalidation</span>
    Cache::<span class="function">forget</span>(<span class="string">"availability:{$appointment->company_id}"</span>);

    <span class="keyword">return new</span> <span class="function">RescheduleResult</span>($appointment);
}
                                    </div>
                                    <div class="task-meta">
                                        <span class="badge-custom bg-danger text-white">CRITICAL</span>
                                        <span class="badge-custom bg-primary text-white">Core Business Logic</span>
                                    </div>
                                </div>
                            </div>
                            <div class="task-item">
                                <div class="task-checkbox" data-task="4.3.3"></div>
                                <div class="task-content">
                                    <div class="task-title">AppointmentCancellationService</div>
                                    <div class="task-description">
                                        Cancellation logic with minimum notice validation, Cal.com sync, refund processing
                                    </div>
                                    <div class="task-meta">
                                        <span class="badge-custom bg-danger text-white">CRITICAL</span>
                                    </div>
                                </div>
                            </div>
                            <div class="task-item">
                                <div class="task-checkbox" data-task="4.3.4"></div>
                                <div class="task-content">
                                    <div class="task-title">UserManagementService</div>
                                    <div class="task-description">
                                        Token-based invitation system with email queue integration
                                    </div>
                                    <div class="task-meta">
                                        <span class="badge-custom bg-primary text-white">User Management</span>
                                    </div>
                                </div>
                            </div>
                            <div class="task-item">
                                <div class="task-checkbox" data-task="4.3.5"></div>
                                <div class="task-content">
                                    <div class="task-title">OptimisticReservationService Updates</div>
                                    <div class="task-description">
                                        Extend existing reservation system for reschedule scenarios
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Phase 4.4: API Controllers -->
                    <div class="phase-section">
                        <div class="phase-header" data-phase="4.4">
                            <div class="phase-number">4.4</div>
                            <div class="phase-title">
                                <h3>API Controllers & Validation</h3>
                                <p>RESTful endpoints with comprehensive validation</p>
                            </div>
                            <div class="phase-meta">
                                <span class="badge bg-primary">2-3 Tage</span>
                            </div>
                        </div>
                        <div class="task-list">
                            <div class="task-item">
                                <div class="task-checkbox" data-task="4.4.1"></div>
                                <div class="task-content">
                                    <div class="task-title">AppointmentController (Customer Portal)</div>
                                    <div class="task-description">
                                        index(), show(), reschedule(), cancel() with policy checks
                                    </div>
                                    <div class="code-block">
<span class="keyword">class</span> <span class="function">AppointmentController</span> <span class="keyword">extends</span> Controller
{
    <span class="keyword">public function</span> <span class="function">reschedule</span>(
        RescheduleRequest $request,
        Appointment $appointment
    ) {
        $this-><span class="function">authorize</span>(<span class="string">'reschedule'</span>, $appointment);

        $result = app(AppointmentRescheduleService::<span class="keyword">class</span>)
            -><span class="function">reschedule</span>(
                $appointment,
                $request-><span class="function">date</span>(<span class="string">'new_start_time'</span>),
                $request-><span class="function">user</span>()
            );

        <span class="keyword">return</span> <span class="function">response</span>()-><span class="function">json</span>($result);
    }
}
                                    </div>
                                </div>
                            </div>
                            <div class="task-item">
                                <div class="task-checkbox" data-task="4.4.2"></div>
                                <div class="task-content">
                                    <div class="task-title">UserManagementController</div>
                                    <div class="task-description">
                                        inviteUser(), listInvitations(), resendInvitation(), cancelInvitation()
                                    </div>
                                </div>
                            </div>
                            <div class="task-item">
                                <div class="task-checkbox" data-task="4.4.3"></div>
                                <div class="task-content">
                                    <div class="task-title">Form Request Validators</div>
                                    <div class="task-description">
                                        RescheduleRequest, CancelRequest, InviteUserRequest with comprehensive rules
                                    </div>
                                </div>
                            </div>
                            <div class="task-item">
                                <div class="task-checkbox" data-task="4.4.4"></div>
                                <div class="task-content">
                                    <div class="task-title">API Routes & Middleware</div>
                                    <div class="task-description">
                                        Define routes with auth:sanctum, companyscope, pilot middleware
                                    </div>
                                    <div class="code-block">
Route::<span class="function">group</span>([
    <span class="string">'prefix'</span> => <span class="string">'v1/customer-portal'</span>,
    <span class="string">'middleware'</span> => [<span class="string">'auth:sanctum'</span>, <span class="string">'companyscope'</span>, <span class="string">'pilot'</span>],
], <span class="keyword">function</span>() {
    Route::<span class="function">get</span>(<span class="string">'/appointments'</span>, [AppointmentController::<span class="keyword">class</span>, <span class="string">'index'</span>]);
    Route::<span class="function">post</span>(<span class="string">'/appointments/{appointment}/reschedule'</span>, ...);
    Route::<span class="function">post</span>(<span class="string">'/appointments/{appointment}/cancel'</span>, ...);
});
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Phase 4.5: Policies & Authorization -->
                    <div class="phase-section">
                        <div class="phase-header" data-phase="4.5">
                            <div class="phase-number">4.5</div>
                            <div class="phase-title">
                                <h3>Authorization Policies</h3>
                                <p>Multi-layer permission system</p>
                            </div>
                            <div class="phase-meta">
                                <span class="badge bg-primary">1 Tag</span>
                                <span class="badge bg-info">Security</span>
                            </div>
                        </div>
                        <div class="task-list">
                            <div class="task-item">
                                <div class="task-checkbox" data-task="4.5.1"></div>
                                <div class="task-content">
                                    <div class="task-title">Update AppointmentPolicy</div>
                                    <div class="task-description">
                                        Add reschedule(), cancel() methods with branch isolation logic
                                    </div>
                                    <div class="code-block">
<span class="keyword">public function</span> <span class="function">reschedule</span>(User $user, Appointment $appointment): <span class="keyword">bool</span>
{
    <span class="comment">// Company Owner/Admin: Can reschedule any appointment in their company</span>
    <span class="keyword">if</span> ($user-><span class="function">hasRole</span>([<span class="string">'company_owner'</span>, <span class="string">'company_admin'</span>])) {
        <span class="keyword">return</span> $appointment->company_id === $user->company_id;
    }

    <span class="comment">// Manager: Can reschedule appointments in their branch only</span>
    <span class="keyword">if</span> ($user-><span class="function">hasRole</span>(<span class="string">'company_manager'</span>)) {
        <span class="keyword">return</span> $appointment->branch_id === $user->staff?->branch_id;
    }

    <span class="comment">// Staff: Can only reschedule their own appointments</span>
    <span class="keyword">if</span> ($user-><span class="function">hasRole</span>(<span class="string">'company_staff'</span>)) {
        <span class="keyword">return</span> $appointment->staff_id === $user->staff_id;
    }

    <span class="keyword">return false</span>;
}
                                    </div>
                                </div>
                            </div>
                            <div class="task-item">
                                <div class="task-checkbox" data-task="4.5.2"></div>
                                <div class="task-content">
                                    <div class="task-title">Create UserInvitationPolicy</div>
                                    <div class="task-description">
                                        Prevent privilege escalation: users can't invite higher roles
                                    </div>
                                </div>
                            </div>
                            <div class="task-item">
                                <div class="task-checkbox" data-task="4.5.3"></div>
                                <div class="task-content">
                                    <div class="task-title">PilotCompanyMiddleware</div>
                                    <div class="task-description">
                                        Check company.is_pilot OR global feature flag
                                    </div>
                                    <div class="code-block">
<span class="keyword">public function</span> <span class="function">handle</span>(Request $request, Closure $next)
{
    $user = $request-><span class="function">user</span>();
    $company = $user->company;

    <span class="keyword">if</span> (!$company->is_pilot && !<span class="function">config</span>(<span class="string">'features.customer_portal_enabled'</span>)) {
        <span class="keyword">return</span> <span class="function">response</span>()-><span class="function">json</span>([
            <span class="string">'error'</span> => <span class="string">'Customer Portal not enabled for this company'</span>
        ], 403);
    }

    <span class="keyword">return</span> $next($request);
}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Phase 4.6: Events & Listeners -->
                    <div class="phase-section">
                        <div class="phase-header" data-phase="4.6">
                            <div class="phase-number">4.6</div>
                            <div class="phase-title">
                                <h3>Event-Driven Architecture</h3>
                                <p>Events, listeners, notifications</p>
                            </div>
                            <div class="phase-meta">
                                <span class="badge bg-primary">1 Tag</span>
                            </div>
                        </div>
                        <div class="task-list">
                            <div class="task-item">
                                <div class="task-checkbox" data-task="4.6.1"></div>
                                <div class="task-content">
                                    <div class="task-title">Create Events</div>
                                    <div class="task-description">
                                        AppointmentRescheduled, AppointmentCancelled, UserInvited, InvitationAccepted
                                    </div>
                                </div>
                            </div>
                            <div class="task-item">
                                <div class="task-checkbox" data-task="4.6.2"></div>
                                <div class="task-content">
                                    <div class="task-title">Create Listeners</div>
                                    <div class="task-description">
                                        SendRescheduleNotification, InvalidateAvailabilityCache, LogAuditTrail
                                    </div>
                                </div>
                            </div>
                            <div class="task-item">
                                <div class="task-checkbox" data-task="4.6.3"></div>
                                <div class="task-content">
                                    <div class="task-title">Notification Classes</div>
                                    <div class="task-description">
                                        AppointmentRescheduledNotification, UserInvitationNotification (Mail + Database)
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Testing Tab -->
                <div class="tab-pane fade" id="testing">
                    <h2 class="mb-4">Comprehensive Testing Strategy</h2>
                    <p class="text-muted">160+ Tests: 60% Unit | 30% Integration | 10% E2E</p>

                    <div class="alert-custom alert-warning">
                        <h5><i class="bi bi-exclamation-triangle"></i> Testing Requirement</h5>
                        <p class="mb-0">
                            <strong>ALL tests MUST pass</strong> before deployment to pilot companies.
                            Zero tolerance for failing tests in production.
                        </p>
                    </div>

                    <h3 class="mt-4">Test Distribution</h3>
                    <canvas id="testDistributionChart" height="80"></canvas>

                    <h3 class="mt-5">Unit Tests (96 tests)</h3>
                    <div class="checklist-section">
                        <h5>Service Layer Tests</h5>
                        <div class="task-list">
                            <div class="task-item">
                                <div class="task-checkbox" data-task="test-1"></div>
                                <div class="task-content">
                                    <div class="task-title">AppointmentRescheduleServiceTest (18 tests)</div>
                                    <div class="task-description">
                                        Test authorization, validation, optimistic locking, Cal.com sync, rollback scenarios
                                    </div>
                                    <div class="code-block">
test_reschedule_succeeds_with_valid_data()
test_reschedule_fails_without_permission()
test_reschedule_fails_with_minimum_notice_violation()
test_reschedule_handles_concurrent_modification()
test_reschedule_rolls_back_on_calcom_failure()
test_reschedule_creates_audit_log()
test_reschedule_invalidates_cache()
...
                                    </div>
                                </div>
                            </div>
                            <div class="task-item">
                                <div class="task-checkbox" data-task="test-2"></div>
                                <div class="task-content">
                                    <div class="task-title">CalcomCircuitBreakerTest (12 tests)</div>
                                    <div class="task-description">
                                        Test state transitions, failure thresholds, recovery logic
                                    </div>
                                </div>
                            </div>
                            <div class="task-item">
                                <div class="task-checkbox" data-task="test-3"></div>
                                <div class="task-content">
                                    <div class="task-title">UserManagementServiceTest (15 tests)</div>
                                    <div class="task-description">
                                        Test invitation creation, token security, expiry logic, privilege escalation prevention
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h5 class="mt-4">Policy Tests</h5>
                        <div class="task-list">
                            <div class="task-item">
                                <div class="task-checkbox" data-task="test-4"></div>
                                <div class="task-content">
                                    <div class="task-title">AppointmentPolicyTest (24 tests)</div>
                                    <div class="task-description">
                                        Test all roles (owner, admin, manager, staff) × all actions (reschedule, cancel)
                                    </div>
                                    <div class="code-block">
test_company_owner_can_reschedule_any_appointment()
test_company_admin_can_reschedule_company_appointments()
test_manager_can_only_reschedule_branch_appointments()
test_staff_can_only_reschedule_own_appointments()
test_manager_cannot_reschedule_other_branch_appointments()
...
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h5 class="mt-4">Model Tests</h5>
                        <div class="task-list">
                            <div class="task-item">
                                <div class="task-checkbox" data-task="test-5"></div>
                                <div class="task-content">
                                    <div class="task-title">UserInvitationTest (10 tests)</div>
                                    <div class="task-description">
                                        Test token generation, expiry scopes, uniqueness constraints
                                    </div>
                                </div>
                            </div>
                            <div class="task-item">
                                <div class="task-checkbox" data-task="test-6"></div>
                                <div class="task-content">
                                    <div class="task-title">AppointmentAuditLogTest (8 tests)</div>
                                    <div class="task-description">
                                        Test immutability, JSON serialization, relationship integrity
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h3 class="mt-5">Integration Tests (48 tests)</h3>
                    <div class="checklist-section">
                        <div class="task-list">
                            <div class="task-item">
                                <div class="task-checkbox" data-task="test-7"></div>
                                <div class="task-content">
                                    <div class="task-title">Appointment Reschedule Flow (12 tests)</div>
                                    <div class="task-description">
                                        End-to-end reschedule: API request → Service → Cal.com → Database → Events
                                    </div>
                                </div>
                            </div>
                            <div class="task-item">
                                <div class="task-checkbox" data-task="test-8"></div>
                                <div class="task-content">
                                    <div class="task-title">Multi-Tenant Isolation (18 tests)</div>
                                    <div class="task-description">
                                        Verify Company A cannot access Company B data across all endpoints
                                    </div>
                                </div>
                            </div>
                            <div class="task-item">
                                <div class="task-checkbox" data-task="test-9"></div>
                                <div class="task-content">
                                    <div class="task-title">Circuit Breaker Integration (8 tests)</div>
                                    <div class="task-description">
                                        Test circuit breaker with real Cal.com mock, state persistence in Redis
                                    </div>
                                </div>
                            </div>
                            <div class="task-item">
                                <div class="task-checkbox" data-task="test-10"></div>
                                <div class="task-content">
                                    <div class="task-title">Concurrent Modification (10 tests)</div>
                                    <div class="task-description">
                                        Simulate race conditions, verify optimistic locking prevents conflicts
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h3 class="mt-5">E2E Tests (16 tests)</h3>
                    <div class="checklist-section">
                        <div class="task-list">
                            <div class="task-item">
                                <div class="task-checkbox" data-task="test-11"></div>
                                <div class="task-content">
                                    <div class="task-title">Complete Reschedule Journey (4 tests)</div>
                                    <div class="task-description">
                                        Login → View appointments → Reschedule → Verify notification → Check Cal.com
                                    </div>
                                </div>
                            </div>
                            <div class="task-item">
                                <div class="task-checkbox" data-task="test-12"></div>
                                <div class="task-content">
                                    <div class="task-title">User Invitation Journey (4 tests)</div>
                                    <div class="task-description">
                                        Admin invites → Email sent → User accepts → Login successful
                                    </div>
                                </div>
                            </div>
                            <div class="task-item">
                                <div class="task-checkbox" data-task="test-13"></div>
                                <div class="task-content">
                                    <div class="task-title">Error Recovery Scenarios (4 tests)</div>
                                    <div class="task-description">
                                        Cal.com down → Circuit breaker opens → Graceful degradation
                                    </div>
                                </div>
                            </div>
                            <div class="task-item">
                                <div class="task-checkbox" data-task="test-14"></div>
                                <div class="task-content">
                                    <div class="task-title">Performance Tests (4 tests)</div>
                                    <div class="task-description">
                                        Verify p95 latency &lt;500ms for reschedule, &lt;200ms for read endpoints
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h3 class="mt-5">Test Execution Commands</h3>
                    <div class="code-block">
<span class="comment"># Run all tests</span>
<span class="keyword">php</span> artisan test

<span class="comment"># Run specific test suite</span>
<span class="keyword">php</span> artisan test --testsuite=Feature/CustomerPortal

<span class="comment"># Run with coverage (requires XDebug)</span>
<span class="keyword">php</span> artisan test --coverage --min=80

<span class="comment"># Run parallel tests (faster)</span>
<span class="keyword">php</span> artisan test --parallel

<span class="comment"># Run specific test class</span>
<span class="keyword">php</span> artisan test tests/Feature/CustomerPortal/AppointmentRescheduleTest.php
                    </div>
                </div>

                <!-- Deployment Tab -->
                <div class="tab-pane fade" id="deployment">
                    <h2 class="mb-4">Deployment Strategy</h2>

                    <h3>Phase 5: Pilot Rollout</h3>
                    <div class="timeline">
                        <div class="timeline-item">
                            <h5>Day 1-2: Pre-Deployment</h5>
                            <ul>
                                <li>Code review with senior developer</li>
                                <li>Run full test suite (ALL tests must pass)</li>
                                <li>Security audit (SQL injection, XSS, CSRF, multi-tenant isolation)</li>
                                <li>Performance benchmarks (p95 &lt;500ms)</li>
                            </ul>
                        </div>
                        <div class="timeline-item">
                            <h5>Day 3: Staging Deployment</h5>
                            <ul>
                                <li>Deploy to staging environment</li>
                                <li>Run smoke tests</li>
                                <li>Manual QA testing (all user journeys)</li>
                                <li>Load testing (100 concurrent users)</li>
                            </ul>
                            <div class="code-block">
<span class="keyword">git</span> checkout main
<span class="keyword">git</span> pull origin main
<span class="keyword">git</span> merge feature/customer-portal-mvp
<span class="keyword">php</span> artisan migrate --env=staging
<span class="keyword">php</span> artisan config:clear
<span class="keyword">php</span> artisan cache:clear
                            </div>
                        </div>
                        <div class="timeline-item">
                            <h5>Day 4: Select Pilot Companies</h5>
                            <ul>
                                <li>Identify 2-3 friendly customers</li>
                                <li>Send invitation email with beta program details</li>
                                <li>Schedule onboarding calls</li>
                                <li>Enable pilot flag in database</li>
                            </ul>
                            <div class="code-block">
<span class="comment">-- Enable pilot for specific companies</span>
<span class="keyword">UPDATE</span> companies
<span class="keyword">SET</span> is_pilot = <span class="keyword">true</span>,
    pilot_enabled_at = <span class="function">NOW</span>(),
    pilot_enabled_by = <span class="comment">/* admin user ID */</span>,
    pilot_notes = <span class="string">'Friendly customer, high engagement'</span>
<span class="keyword">WHERE</span> id <span class="keyword">IN</span> (<span class="comment">/* company IDs */</span>);
                            </div>
                        </div>
                        <div class="timeline-item">
                            <h5>Day 5: Production Deployment</h5>
                            <ul>
                                <li>Deploy to production during maintenance window</li>
                                <li>Run migrations with backup</li>
                                <li>Verify pilot companies can access portal</li>
                                <li>Monitor logs for 24 hours</li>
                            </ul>
                            <div class="code-block">
<span class="comment"># Backup database before migration</span>
<span class="keyword">pg_dump</span> askpro_gateway > backup_$(date +%Y%m%d_%H%M%S).sql

<span class="comment"># Run migrations</span>
<span class="keyword">php</span> artisan migrate --force

<span class="comment"># Clear caches</span>
<span class="keyword">php</span> artisan config:cache
<span class="keyword">php</span> artisan route:cache
<span class="keyword">php</span> artisan view:cache

<span class="comment"># Restart queue workers</span>
<span class="keyword">php</span> artisan queue:restart
                            </div>
                        </div>
                        <div class="timeline-item">
                            <h5>Day 6-7: Onboarding & Training</h5>
                            <ul>
                                <li>Walk-through with pilot companies</li>
                                <li>Demonstrate reschedule/cancel features</li>
                                <li>Train on user management</li>
                                <li>Collect initial feedback</li>
                            </ul>
                        </div>
                        <div class="timeline-item">
                            <h5>Week 2-4: Monitoring & Iteration</h5>
                            <ul>
                                <li>Daily monitoring of error logs</li>
                                <li>Weekly feedback sessions</li>
                                <li>Bug fixes and minor improvements</li>
                                <li>Prepare for wider rollout</li>
                            </ul>
                        </div>
                    </div>

                    <h3 class="mt-5">Monitoring Setup</h3>
                    <div class="checklist-section">
                        <div class="task-list">
                            <div class="task-item">
                                <div class="task-checkbox" data-task="deploy-1"></div>
                                <div class="task-content">
                                    <div class="task-title">Laravel Telescope</div>
                                    <div class="task-description">
                                        Enable Telescope for pilot companies only to monitor requests, exceptions, jobs
                                    </div>
                                </div>
                            </div>
                            <div class="task-item">
                                <div class="task-checkbox" data-task="deploy-2"></div>
                                <div class="task-content">
                                    <div class="task-title">Circuit Breaker Dashboard</div>
                                    <div class="task-description">
                                        Create admin page showing circuit breaker state, failure rate, recovery time
                                    </div>
                                </div>
                            </div>
                            <div class="task-item">
                                <div class="task-checkbox" data-task="deploy-3"></div>
                                <div class="task-content">
                                    <div class="task-title">Performance Metrics</div>
                                    <div class="task-description">
                                        Track p50, p95, p99 latency for reschedule/cancel endpoints
                                    </div>
                                </div>
                            </div>
                            <div class="task-item">
                                <div class="task-checkbox" data-task="deploy-4"></div>
                                <div class="task-content">
                                    <div class="task-title">Slack Alerts</div>
                                    <div class="task-description">
                                        Send alerts for: Circuit breaker OPEN, Cal.com sync failures, 500 errors
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h3 class="mt-5">Rollback Plan</h3>
                    <div class="alert-custom alert-danger">
                        <h5><i class="bi bi-exclamation-octagon"></i> Emergency Rollback</h5>
                        <p>If critical issues arise during pilot:</p>
                        <div class="code-block">
<span class="comment"># 1. Disable pilot for all companies (immediate)</span>
<span class="keyword">UPDATE</span> companies <span class="keyword">SET</span> is_pilot = <span class="keyword">false</span>;

<span class="comment"># 2. Restore database from backup (if migrations failed)</span>
<span class="keyword">psql</span> askpro_gateway < backup_YYYYMMDD_HHMMSS.sql

<span class="comment"># 3. Rollback code deployment</span>
<span class="keyword">git</span> checkout main
<span class="keyword">git</span> reset --hard <span class="comment">/* previous commit hash */</span>
<span class="keyword">php</span> artisan config:clear && <span class="keyword">php</span> artisan cache:clear

<span class="comment"># 4. Notify stakeholders</span>
                        </div>
                    </div>
                </div>

                <!-- Risks Tab -->
                <div class="tab-pane fade" id="risks">
                    <h2 class="mb-4">Risk Assessment & Mitigation</h2>

                    <h3>Critical Risks (RESOLVED)</h3>
                    <div class="risk-card">
                        <h5><i class="bi bi-x-circle text-danger"></i> RISK-001: Race Condition in Cal.com Sync</h5>
                        <p><strong>Severity:</strong> HIGH | <strong>Probability:</strong> HIGH | <strong>Impact:</strong> Data inconsistency</p>
                        <p><strong>Description:</strong> Async queue jobs can fail silently, causing appointments to exist in Laravel but not Cal.com</p>
                        <p><strong>Mitigation:</strong> ✅ <strong>SYNCHRONOUS sync</strong> - Block request until Cal.com confirms update. Rollback database changes if sync fails.</p>
                        <div class="badge bg-success">RESOLVED - Architecture Changed</div>
                    </div>

                    <div class="risk-card">
                        <h5><i class="bi bi-x-circle text-danger"></i> RISK-002: Multi-Tenant Data Leak</h5>
                        <p><strong>Severity:</strong> CRITICAL | <strong>Probability:</strong> MEDIUM | <strong>Impact:</strong> Privacy violation</p>
                        <p><strong>Description:</strong> User from Company A could access/modify Company B appointments</p>
                        <p><strong>Mitigation:</strong> ✅ <strong>Multi-layer authorization</strong>:
                            <ul>
                                <li>Middleware: CompanyScope injects company_id filter</li>
                                <li>Policy: Explicit permission checks</li>
                                <li>Service: Redundant company_id validation</li>
                                <li>Tests: 18 dedicated multi-tenant isolation tests</li>
                            </ul>
                        </p>
                        <div class="badge bg-success">RESOLVED - Triple Layer Defense</div>
                    </div>

                    <div class="risk-card">
                        <h5><i class="bi bi-x-circle text-danger"></i> RISK-003: Concurrent Modification Conflicts</h5>
                        <p><strong>Severity:</strong> HIGH | <strong>Probability:</strong> MEDIUM | <strong>Impact:</strong> Lost updates</p>
                        <p><strong>Description:</strong> Two users reschedule same appointment simultaneously → one update lost</p>
                        <p><strong>Mitigation:</strong> ✅ <strong>Optimistic locking</strong> with version field. Last write wins prevented.</p>
                        <div class="badge bg-success">RESOLVED - Database-Level Protection</div>
                    </div>

                    <div class="risk-card">
                        <h5><i class="bi bi-x-circle text-danger"></i> RISK-004: Cal.com API Downtime</h5>
                        <p><strong>Severity:</strong> HIGH | <strong>Probability:</strong> LOW | <strong>Impact:</strong> Feature unavailable</p>
                        <p><strong>Description:</strong> If Cal.com is down, users can't reschedule/cancel appointments</p>
                        <p><strong>Mitigation:</strong> ✅ <strong>Circuit breaker pattern</strong>:
                            <ul>
                                <li>CLOSED → OPEN after 5 failures in 1 minute</li>
                                <li>OPEN → HALF_OPEN after 30 seconds (test recovery)</li>
                                <li>HALF_OPEN → CLOSED after 3 successful requests</li>
                                <li>Graceful error messages to users</li>
                            </ul>
                        </p>
                        <div class="badge bg-success">RESOLVED - Fault Tolerance Implemented</div>
                    </div>

                    <h3 class="mt-5">Medium Risks (MITIGATED)</h3>
                    <div class="risk-card medium">
                        <h5><i class="bi bi-exclamation-triangle text-warning"></i> RISK-005: Minimum Notice Violations</h5>
                        <p><strong>Severity:</strong> MEDIUM | <strong>Probability:</strong> MEDIUM | <strong>Impact:</strong> Business policy violation</p>
                        <p><strong>Description:</strong> Users might try to reschedule appointments with &lt;24h notice</p>
                        <p><strong>Mitigation:</strong> ✅ Validation in service layer enforces minimum notice from company settings</p>
                        <div class="badge bg-warning text-dark">MITIGATED - Validation Layer</div>
                    </div>

                    <div class="risk-card medium">
                        <h5><i class="bi bi-exclamation-triangle text-warning"></i> RISK-006: Privilege Escalation</h5>
                        <p><strong>Severity:</strong> MEDIUM | <strong>Probability:</strong> LOW | <strong>Impact:</strong> Unauthorized access</p>
                        <p><strong>Description:</strong> Manager invites someone with Owner role</p>
                        <p><strong>Mitigation:</strong> ✅ UserInvitationPolicy prevents inviting roles higher than your own</p>
                        <div class="badge bg-warning text-dark">MITIGATED - Policy Check</div>
                    </div>

                    <h3 class="mt-5">Low Risks (MONITORED)</h3>
                    <div class="risk-card low">
                        <h5><i class="bi bi-info-circle text-success"></i> RISK-007: Email Delivery Failures</h5>
                        <p><strong>Severity:</strong> LOW | <strong>Probability:</strong> LOW | <strong>Impact:</strong> User can't accept invitation</p>
                        <p><strong>Description:</strong> Invitation email bounces or goes to spam</p>
                        <p><strong>Mitigation:</strong> ✅ Email queue with retry mechanism + manual resend option in UI</p>
                        <div class="badge bg-success">MONITORED - Retry Mechanism</div>
                    </div>

                    <h3 class="mt-5">Risk Matrix</h3>
                    <canvas id="riskMatrixChart" height="80"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Task checkbox functionality
        document.querySelectorAll('.task-checkbox').forEach(checkbox => {
            checkbox.addEventListener('click', function() {
                this.classList.toggle('checked');
                updateProgress();
            });
        });

        // Phase header collapse
        document.querySelectorAll('.phase-header').forEach(header => {
            header.addEventListener('click', function() {
                const taskList = this.nextElementSibling;
                taskList.style.display = taskList.style.display === 'none' ? 'block' : 'none';
            });
        });

        // Update progress tracking
        function updateProgress() {
            const total = document.querySelectorAll('.task-checkbox').length;
            const completed = document.querySelectorAll('.task-checkbox.checked').length;
            const percentage = Math.round((completed / total) * 100);

            console.log(`Progress: ${completed}/${total} tasks (${percentage}%)`);

            // Update phase headers based on task completion
            document.querySelectorAll('.phase-section').forEach(section => {
                const phaseCheckboxes = section.querySelectorAll('.task-checkbox');
                const phaseCompleted = section.querySelectorAll('.task-checkbox.checked');
                const phaseHeader = section.querySelector('.phase-header');
                const phaseNumber = section.querySelector('.phase-number');

                if (phaseCheckboxes.length === phaseCompleted.length && phaseCheckboxes.length > 0) {
                    phaseHeader.classList.add('completed');
                    phaseHeader.classList.remove('in-progress');
                    phaseNumber.classList.add('completed');
                    phaseNumber.classList.remove('in-progress');
                } else if (phaseCompleted.length > 0) {
                    phaseHeader.classList.add('in-progress');
                    phaseHeader.classList.remove('completed');
                    phaseNumber.classList.add('in-progress');
                    phaseNumber.classList.remove('completed');
                }
            });
        }

        // Timeline Chart
        const timelineCtx = document.getElementById('timelineChart');
        if (timelineCtx) {
            new Chart(timelineCtx, {
                type: 'bar',
                data: {
                    labels: ['Phase 4.1', 'Phase 4.2', 'Phase 4.3', 'Phase 4.4', 'Phase 4.5', 'Phase 4.6', 'Testing', 'Deployment'],
                    datasets: [{
                        label: 'Tage',
                        data: [2, 1, 4, 3, 1, 1, 5, 7],
                        backgroundColor: [
                            '#0d6efd', '#0d6efd', '#dc3545', '#0d6efd', '#0d6efd', '#0d6efd', '#ffc107', '#198754'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Tage' }
                        }
                    }
                }
            });
        }

        // Test Distribution Chart
        const testDistCtx = document.getElementById('testDistributionChart');
        if (testDistCtx) {
            new Chart(testDistCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Unit Tests (96)', 'Integration Tests (48)', 'E2E Tests (16)'],
                    datasets: [{
                        data: [96, 48, 16],
                        backgroundColor: ['#0d6efd', '#198754', '#ffc107']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });
        }

        // Risk Matrix Chart
        const riskMatrixCtx = document.getElementById('riskMatrixChart');
        if (riskMatrixCtx) {
            new Chart(riskMatrixCtx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: 'Critical Risks (RESOLVED)',
                            data: [
                                { x: 90, y: 90, r: 15 }, // RISK-001: Race condition
                                { x: 85, y: 60, r: 20 }, // RISK-002: Data leak
                                { x: 85, y: 50, r: 15 }, // RISK-003: Concurrent mod
                                { x: 85, y: 30, r: 15 }  // RISK-004: Cal.com down
                            ],
                            backgroundColor: 'rgba(220, 53, 69, 0.6)'
                        },
                        {
                            label: 'Medium Risks (MITIGATED)',
                            data: [
                                { x: 50, y: 50, r: 10 }, // RISK-005: Minimum notice
                                { x: 50, y: 30, r: 10 }  // RISK-006: Privilege escalation
                            ],
                            backgroundColor: 'rgba(255, 193, 7, 0.6)'
                        },
                        {
                            label: 'Low Risks (MONITORED)',
                            data: [
                                { x: 30, y: 30, r: 8 }   // RISK-007: Email delivery
                            ],
                            backgroundColor: 'rgba(25, 135, 84, 0.6)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: { display: true, text: 'Probability (%)' },
                            min: 0,
                            max: 100
                        },
                        y: {
                            title: { display: true, text: 'Impact (%)' },
                            min: 0,
                            max: 100
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
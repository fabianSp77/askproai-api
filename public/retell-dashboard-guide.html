<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retell Dashboard Guide - Functions Verwalten</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
            border-radius: 20px 20px 0 0;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #e0e0e0;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            margin-bottom: -3px;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
            padding: 40px;
        }

        .tab-content.active {
            display: block;
        }

        .step {
            margin: 30px 0;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 5px solid #667eea;
        }

        .step h3 {
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .screenshot-placeholder {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            border: 2px dashed #adb5bd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            color: #6c757d;
            font-style: italic;
        }

        .code-block {
            background: #282c34;
            color: #abb2bf;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            overflow-x: auto;
            margin: 15px 0;
        }

        .code-block pre {
            margin: 0;
            white-space: pre-wrap;
        }

        .alert {
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border-left: 5px solid;
        }

        .alert-info {
            background: #cfe2ff;
            border-color: #0d6efd;
            color: #084298;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #664d03;
        }

        .alert-success {
            background: #d1e7dd;
            border-color: #198754;
            color: #0f5132;
        }

        .alert-danger {
            background: #f8d7da;
            border-color: #dc3545;
            color: #842029;
        }

        .field-demo {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .field-demo label {
            display: block;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }

        .field-demo input,
        .field-demo textarea,
        .field-demo select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-family: inherit;
        }

        .field-demo textarea {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .copy-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .copy-btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        .copy-btn.copied {
            background: #28a745;
        }

        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .comparison-item {
            padding: 20px;
            border-radius: 10px;
        }

        .comparison-wrong {
            background: #f8d7da;
            border: 2px solid #dc3545;
        }

        .comparison-right {
            background: #d1e7dd;
            border: 2px solid #198754;
        }

        .comparison-item h4 {
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .comparison {
                grid-template-columns: 1fr;
            }

            .tab {
                font-size: 0.9em;
                padding: 15px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì Retell Dashboard Guide</h1>
            <p>Functions verwalten - Schritt f√ºr Schritt</p>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab(0)">
                üìç Navigation
            </div>
            <div class="tab" onclick="switchTab(1)">
                ‚ûï Neue Function
            </div>
            <div class="tab" onclick="switchTab(2)">
                ‚úèÔ∏è Function bearbeiten
            </div>
            <div class="tab" onclick="switchTab(3)">
                üîó Flow Integration
            </div>
            <div class="tab" onclick="switchTab(4)">
                ‚úÖ V39 Check
            </div>
            <div class="tab" onclick="switchTab(5)" style="background: #fff3cd; border-left: 3px solid #ffc107;">
                üö® V39 Flow Fix
            </div>
        </div>

        <!-- TAB 1: NAVIGATION -->
        <div class="tab-content active">
            <h2>üìç Dashboard Navigation</h2>
            <p style="font-size: 1.1em; margin-bottom: 30px;">
                Lerne wo du Functions im Retell Dashboard findest und verwaltest.
            </p>

            <div class="alert alert-info">
                <strong>üîë Zwei Orte f√ºr Functions:</strong><br>
                1. <strong>Global Settings ‚Üí Functions Tab</strong> = Hier ERSTELLST du Functions<br>
                2. <strong>Flow Canvas ‚Üí Function Nodes</strong> = Hier VERWENDEST du Functions
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">1</span>
                    Retell Dashboard √∂ffnen
                </h3>
                <p>Gehe zu: <code>https://dashboard.retellai.com</code></p>
                <p>Login mit deinem Account</p>
                <div class="screenshot-placeholder">
                    üì∏ Screenshot: Retell Dashboard Login Screen
                </div>
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">2</span>
                    Global Functions finden
                </h3>
                <p>Es gibt 2 Wege um zu den Global Functions zu kommen:</p>

                <h4 style="margin-top: 20px;">Weg A: Direktes Tools/Functions Men√º (wenn vorhanden)</h4>
                <ol style="margin-left: 25px; margin-top: 10px;">
                    <li>Links in der Sidebar: "Tools" oder "Functions" klicken</li>
                    <li>Du siehst eine Liste aller Custom Functions</li>
                    <li>Hier kannst du Functions erstellen, bearbeiten, l√∂schen</li>
                </ol>
                <div class="screenshot-placeholder">
                    üì∏ Screenshot: Sidebar mit "Functions" Men√º
                </div>

                <h4 style="margin-top: 30px;">Weg B: Via Agent Settings (Alternative)</h4>
                <ol style="margin-left: 25px; margin-top: 10px;">
                    <li>Klicke auf einen beliebigen Conversation Flow Agent</li>
                    <li>Oben rechts: "Settings" oder "‚öôÔ∏è" Icon</li>
                    <li>Tab: "Functions" oder "Custom Functions"</li>
                    <li>Hier siehst du alle Functions (agent-√ºbergreifend!)</li>
                </ol>
                <div class="screenshot-placeholder">
                    üì∏ Screenshot: Agent Settings ‚Üí Functions Tab
                </div>
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">3</span>
                    Flow Canvas √∂ffnen
                </h3>
                <p>Um Function NODES zu verwalten (nicht die Functions selbst):</p>
                <ol style="margin-left: 25px; margin-top: 10px;">
                    <li>Klicke auf "Conversation Flow Agent Friseur 1"</li>
                    <li>Du siehst den Flow Canvas (Graph mit Nodes)</li>
                    <li>Links: Spalte mit verschiedenen Node-Typen</li>
                    <li>Rechts: Properties Panel (wenn Node selektiert)</li>
                </ol>
                <div class="screenshot-placeholder">
                    üì∏ Screenshot: Flow Canvas mit Node-Typen Spalte und Properties Panel
                </div>

                <div class="alert alert-warning" style="margin-top: 20px;">
                    <strong>‚ö†Ô∏è WICHTIG:</strong> Function Nodes im Canvas sind NICHT die Functions selbst!<br>
                    Sie sind nur <strong>Referenzen</strong> zu den Global Functions.<br>
                    √Ñnderungen an Global Functions beeinflussen ALLE Agents die sie verwenden!
                </div>
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">4</span>
                    Linke Spalte: Node-Typen
                </h3>
                <p>Im Flow Canvas findest du links diese Node-Typen:</p>
                <ul style="margin-left: 25px; margin-top: 10px;">
                    <li>üìù <strong>Conversation</strong> - Agent spricht mit User</li>
                    <li>‚ö° <strong>Function</strong> - Ruft Custom Function auf</li>
                    <li>üìû <strong>Call Transfer</strong> - Transfer zu anderem Number</li>
                    <li>üî¢ <strong>Press Digit</strong> - IVR Navigation</li>
                    <li>üîÄ <strong>Logic Split</strong> - If/Else Verzweigung</li>
                    <li>üèÅ <strong>End</strong> - Beendet Conversation</li>
                    <li>üí¨ <strong>SMS</strong> - Sendet SMS</li>
                    <li>üìä <strong>Extract Dynamic Variable</strong> - Extrahiert Variablen</li>
                    <li>ü§ù <strong>Agent Transfer</strong> - Transfer zu anderem Agent</li>
                    <li>üîå <strong>MCP</strong> - Model Context Protocol Integration</li>
                </ul>
            </div>
        </div>

        <!-- TAB 2: NEUE FUNCTION -->
        <div class="tab-content">
            <h2>‚ûï Neue Function erstellen</h2>
            <p style="font-size: 1.1em; margin-bottom: 30px;">
                Schritt-f√ºr-Schritt Anleitung um eine neue Custom Function zu erstellen.
            </p>

            <div class="alert alert-success">
                <strong>üéØ Beispiel:</strong> Wir erstellen <code>check_availability_v17</code>
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">1</span>
                    Functions Tab √∂ffnen
                </h3>
                <p>Gehe zu Global Settings ‚Üí Functions Tab (siehe Navigation Tab)</p>
                <p>Klicke "+ Create Function" oder "+ New Tool" Button</p>
                <div class="screenshot-placeholder">
                    üì∏ Screenshot: "+ Create Function" Button
                </div>
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">2</span>
                    Basis-Informationen ausf√ºllen
                </h3>

                <div class="field-demo">
                    <label>Function Name:</label>
                    <input type="text" value="check_availability_v17" readonly id="name-demo">
                    <button class="copy-btn" onclick="copyValue('name-demo')">üìã Kopieren</button>
                    <small style="display: block; margin-top: 8px; color: #6c757d;">
                        ‚ö†Ô∏è Verwende Unterstriche (_), KEINE Bindestriche (-)!
                    </small>
                </div>

                <div class="field-demo">
                    <label>Function Type:</label>
                    <select>
                        <option>Custom Function</option>
                    </select>
                    <small style="display: block; margin-top: 8px; color: #6c757d;">
                        W√§hle "Custom Function" aus dem Dropdown
                    </small>
                </div>

                <div class="field-demo">
                    <label>Description:</label>
                    <textarea rows="2" readonly id="desc-demo">Pr√ºft die Verf√ºgbarkeit f√ºr einen bestimmten Termin</textarea>
                    <button class="copy-btn" onclick="copyValue('desc-demo')">üìã Kopieren</button>
                    <small style="display: block; margin-top: 8px; color: #6c757d;">
                        Kurze, klare Beschreibung was die Function macht
                    </small>
                </div>
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">3</span>
                    HTTP Konfiguration
                </h3>

                <div class="field-demo">
                    <label>HTTP Method:</label>
                    <select>
                        <option selected>POST</option>
                        <option>GET</option>
                        <option>PUT</option>
                        <option>PATCH</option>
                        <option>DELETE</option>
                    </select>
                    <small style="display: block; margin-top: 8px; color: #6c757d;">
                        F√ºr unsere Functions: Immer POST
                    </small>
                </div>

                <div class="field-demo">
                    <label>Endpoint URL:</label>
                    <input type="text" value="https://api.askproai.de/api/webhooks/retell/function" readonly id="url-demo">
                    <button class="copy-btn" onclick="copyValue('url-demo')">üìã Kopieren</button>
                    <small style="display: block; margin-top: 8px; color: #6c757d;">
                        ‚ö†Ô∏è MUSS exakt diese URL sein! Inkl. /function am Ende!
                    </small>
                </div>

                <div class="field-demo">
                    <label>Timeout (ms):</label>
                    <input type="number" value="10000" readonly>
                    <small style="display: block; margin-top: 8px; color: #6c757d;">
                        10000ms = 10 Sekunden (empfohlen f√ºr API-Calls)
                    </small>
                </div>
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">4</span>
                    Parameters definieren (JSON Schema)
                </h3>

                <div class="alert alert-info">
                    <strong>üìö Was ist JSON Schema?</strong><br>
                    JSON Schema definiert welche Parameter die Function erwartet und welche Typen sie haben.
                </div>

                <div class="field-demo">
                    <label>Parameters (JSON):</label>
                    <textarea rows="18" readonly id="params-demo">{
  "type": "object",
  "properties": {
    "datum": {
      "type": "string",
      "description": "Datum im Format TT.MM.JJJJ"
    },
    "uhrzeit": {
      "type": "string",
      "description": "Uhrzeit im Format HH:MM"
    },
    "dienstleistung": {
      "type": "string",
      "description": "Name der Dienstleistung"
    }
  },
  "required": ["datum", "uhrzeit", "dienstleistung"]
}</textarea>
                    <button class="copy-btn" onclick="copyValue('params-demo')">üìã Kopieren</button>
                </div>

                <div class="alert alert-warning" style="margin-top: 20px;">
                    <strong>‚ö†Ô∏è WICHTIG:</strong><br>
                    ‚Ä¢ <code>"type": "object"</code> muss immer ganz oben sein<br>
                    ‚Ä¢ Alle Parameter Namen in <code>properties</code> definieren<br>
                    ‚Ä¢ Nur WIRKLICH ben√∂tigte Parameter in <code>required</code> Array<br>
                    ‚Ä¢ <code>description</code> hilft dem LLM die Parameter zu verstehen
                </div>
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">5</span>
                    Speichern & Testen
                </h3>
                <ol style="margin-left: 25px;">
                    <li>Klicke "Save" oder "Create" Button</li>
                    <li>Function erscheint jetzt in der Functions Liste</li>
                    <li>Sie ist GLOBAL verf√ºgbar f√ºr alle Agents</li>
                    <li>Du kannst sie jetzt in Function Nodes verwenden</li>
                </ol>

                <div class="alert alert-success" style="margin-top: 20px;">
                    <strong>‚úÖ Erfolgreich!</strong><br>
                    Die Function <code>check_availability_v17</code> ist jetzt erstellt!<br>
                    N√§chster Schritt: Function Node im Flow Canvas hinzuf√ºgen (siehe "Flow Integration" Tab)
                </div>
            </div>

            <div class="comparison">
                <div class="comparison-item comparison-wrong">
                    <h4>‚ùå H√ÑUFIGE FEHLER</h4>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li><code>check-availability-v17</code> (Bindestriche)</li>
                        <li>URL: <code>.../webhooks/retell</code> (ohne /function)</li>
                        <li><code>"type": "date"</code> (gibt's nicht!)</li>
                        <li>Fehlende <code>"required"</code> Array</li>
                        <li>Timeout zu kurz (1000ms)</li>
                    </ul>
                </div>
                <div class="comparison-item comparison-right">
                    <h4>‚úÖ RICHTIG</h4>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li><code>check_availability_v17</code> (Unterstriche)</li>
                        <li>URL: <code>.../webhooks/retell/function</code></li>
                        <li><code>"type": "string"</code> (f√ºr Datum/Zeit)</li>
                        <li><code>"required": ["datum", ...]</code></li>
                        <li>Timeout: 10000ms</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- TAB 3: FUNCTION BEARBEITEN -->
        <div class="tab-content">
            <h2>‚úèÔ∏è Bestehende Function bearbeiten</h2>
            <p style="font-size: 1.1em; margin-bottom: 30px;">
                So √§nderst du eine existierende Function.
            </p>

            <div class="alert alert-warning">
                <strong>‚ö†Ô∏è VORSICHT:</strong> √Ñnderungen an Global Functions betreffen ALLE Agents die sie verwenden!
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">1</span>
                    Function finden
                </h3>
                <p>Gehe zu Global Settings ‚Üí Functions Tab</p>
                <p>Finde die Function in der Liste (z.B. <code>check_availability_v17</code>)</p>
                <div class="screenshot-placeholder">
                    üì∏ Screenshot: Functions Liste mit Edit Button
                </div>
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">2</span>
                    Edit Mode √∂ffnen
                </h3>
                <p>Klicke auf die Function ODER auf "Edit" Icon (‚úèÔ∏è Stift-Symbol)</p>
                <p>Der Edit Dialog √∂ffnet sich mit allen aktuellen Einstellungen</p>
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">3</span>
                    √Ñnderungen vornehmen
                </h3>

                <h4>Typische √Ñnderungen:</h4>

                <strong style="display: block; margin-top: 20px;">A) Description aktualisieren</strong>
                <ul style="margin-left: 25px; margin-top: 10px;">
                    <li>√Ñndere den Description Text</li>
                    <li>Macht Function verst√§ndlicher</li>
                    <li>KEINE Auswirkung auf Funktionalit√§t</li>
                    <li>‚úÖ SICHER - Kann jederzeit ge√§ndert werden</li>
                </ul>

                <strong style="display: block; margin-top: 20px;">B) Parameter hinzuf√ºgen</strong>
                <div class="code-block">
<pre>// Vorher:
"properties": {
  "datum": {...},
  "uhrzeit": {...}
}

// Nachher (neuer Parameter):
"properties": {
  "datum": {...},
  "uhrzeit": {...},
  "mitarbeiter": {  // ‚Üê NEU
    "type": "string",
    "description": "Gew√ºnschter Mitarbeiter"
  }
}</pre>
                </div>
                <p style="margin-top: 10px;">
                    ‚ö†Ô∏è Pr√ºfe ob PHP Handler (RetellFunctionCallHandler.php) den neuen Parameter handelt!
                </p>

                <strong style="display: block; margin-top: 20px;">C) Timeout anpassen</strong>
                <ul style="margin-left: 25px; margin-top: 10px;">
                    <li>Erh√∂he Timeout wenn Function oft abbricht</li>
                    <li>Verringere Timeout wenn Function schnell ist</li>
                    <li>Empfohlen: 10000ms f√ºr normale API Calls</li>
                </ul>

                <strong style="display: block; margin-top: 20px;">D) URL korrigieren</strong>
                <ul style="margin-left: 25px; margin-top: 10px;">
                    <li>Nur √§ndern bei Deployment auf andere Domain</li>
                    <li>‚ö†Ô∏è KRITISCH - Teste sofort nach √Ñnderung!</li>
                    <li>Falsche URL = 404 Errors</li>
                </ul>
            </div>

            <div class="alert alert-danger">
                <h4>üö® GEF√ÑHRLICHE √ÑNDERUNGEN</h4>

                <strong>Function Name √§ndern:</strong>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>ALLE Function Nodes im Flow brechen!</li>
                    <li>Du musst ALLE Nodes updaten und neu verkn√ºpfen</li>
                    <li>Empfehlung: Erstelle NEUE Function statt Name zu √§ndern</li>
                </ul>

                <strong style="display: block; margin-top: 15px;">Parameter entfernen:</strong>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>Flows die diesen Parameter nutzen brechen!</li>
                    <li>PHP Handler k√∂nnte Fehler werfen</li>
                    <li>Teste IMMER nach Parameter-√Ñnderungen!</li>
                </ul>
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">4</span>
                    Speichern & Testen
                </h3>
                <ol style="margin-left: 25px;">
                    <li>Klicke "Save Changes"</li>
                    <li>Eventuell Agent neu publishen (wenn Retell das verlangt)</li>
                    <li>Mache einen Test Call um √Ñnderungen zu verifizieren</li>
                    <li>Pr√ºfe Logs in Admin Panel ob Function noch funktioniert</li>
                </ol>

                <div class="alert alert-success" style="margin-top: 20px;">
                    <strong>‚úÖ Best Practice:</strong><br>
                    Nach JEDER Function-√Ñnderung einen Test Call machen!<br>
                    Pr√ºfe Admin Panel ‚Üí Retell Call Sessions ‚Üí Latest Call ‚Üí Function Traces
                </div>
            </div>
        </div>

        <!-- TAB 4: FLOW INTEGRATION -->
        <div class="tab-content">
            <h2>üîó Function im Flow verwenden</h2>
            <p style="font-size: 1.1em; margin-bottom: 30px;">
                So f√ºgst du eine Function Node hinzu und verkn√ºpfst sie mit einer Global Function.
            </p>

            <div class="alert alert-info">
                <strong>üîë Erinnerung:</strong><br>
                Global Function = WAS gemacht wird (Tool Definition)<br>
                Function Node = WANN es gemacht wird (Flow Platzierung)
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">1</span>
                    Flow Canvas √∂ffnen
                </h3>
                <p>√ñffne "Conversation Flow Agent Friseur 1"</p>
                <p>Du siehst den Flow Graph mit allen Nodes und Verbindungen</p>
                <div class="screenshot-placeholder">
                    üì∏ Screenshot: Flow Canvas mit Nodes und Edges
                </div>
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">2</span>
                    Function Node hinzuf√ºgen
                </h3>
                <p>Es gibt 2 Wege:</p>

                <strong style="display: block; margin-top: 15px;">Weg A: Drag & Drop</strong>
                <ol style="margin-left: 25px; margin-top: 10px;">
                    <li>Links: Node-Typen Spalte</li>
                    <li>Finde "Function" Node Type</li>
                    <li>Ziehe es auf den Canvas (Drag & Drop)</li>
                    <li>Platziere es wo du willst</li>
                </ol>

                <strong style="display: block; margin-top: 15px;">Weg B: Add Node Button</strong>
                <ol style="margin-left: 25px; margin-top: 10px;">
                    <li>Klicke "+ Add Node" Button (meist oben links)</li>
                    <li>W√§hle "Function" aus Liste</li>
                    <li>Node erscheint im Canvas</li>
                </ol>
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">3</span>
                    Function Node konfigurieren
                </h3>
                <p>Selektiere die neue Function Node (klicken)</p>
                <p>Rechts √∂ffnet sich Properties Panel mit folgenden Feldern:</p>

                <div class="field-demo" style="margin-top: 20px;">
                    <label>Node Name:</label>
                    <input type="text" value="Verf√ºgbarkeit pr√ºfen" placeholder="Freundlicher Name f√ºr Canvas">
                    <small style="display: block; margin-top: 8px; color: #6c757d;">
                        Interner Name f√ºr den Canvas - kann frei gew√§hlt werden
                    </small>
                </div>

                <div class="field-demo">
                    <label>Select Function:</label>
                    <select>
                        <option>-- W√§hle Function --</option>
                        <option>initialize_call</option>
                        <option selected>check_availability_v17</option>
                        <option>book_appointment_v17</option>
                        <option>get_appointments</option>
                        <option>...</option>
                    </select>
                    <small style="display: block; margin-top: 8px; color: #6c757d;">
                        üîë HIER w√§hlst du die Global Function aus!
                    </small>
                </div>

                <div class="field-demo">
                    <label>Instruction Type:</label>
                    <select onchange="toggleInstruction(this)">
                        <option value="prompt">Prompt (dynamisch)</option>
                        <option value="static" selected>Static Text</option>
                    </select>
                    <small style="display: block; margin-top: 8px; color: #6c757d;">
                        Prompt = Agent generiert Text dynamisch<br>
                        Static = Fest definierter Text
                    </small>
                </div>

                <div class="field-demo">
                    <label>Instruction:</label>
                    <textarea rows="2">Einen Moment bitte, ich pr√ºfe die Verf√ºgbarkeit...</textarea>
                    <small style="display: block; margin-top: 8px; color: #6c757d;">
                        Text den Agent W√ÑHREND Function Execution sagt
                    </small>
                </div>

                <div class="field-demo">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" checked>
                        Speak During Execution
                    </label>
                    <small style="display: block; margin-top: 8px; color: #6c757d;">
                        ‚úÖ AN f√ºr langsame Functions (>2s)<br>
                        ‚ùå AUS f√ºr schnelle Functions (<1s)
                    </small>
                </div>

                <div class="field-demo">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" checked>
                        Wait for Result
                    </label>
                    <small style="display: block; margin-top: 8px; color: #6c757d;">
                        ‚úÖ IMMER AN - Sonst wird Result nicht verf√ºgbar!
                    </small>
                </div>
            </div>

            <div class="alert alert-warning">
                <h4>‚öôÔ∏è Speak During Execution - Wann AN/AUS?</h4>

                <strong style="display: block; margin-top: 10px;">‚úÖ AN (true) f√ºr:</strong>
                <ul style="margin-left: 20px;">
                    <li><code>check_availability_v17</code> - Pr√ºfung dauert ~1-3s</li>
                    <li><code>book_appointment_v17</code> - Buchung dauert ~2-5s</li>
                    <li><code>reschedule_appointment</code> - Verschiebung dauert</li>
                    <li><code>cancel_appointment</code> - Stornierung dauert</li>
                </ul>

                <strong style="display: block; margin-top: 15px;">‚ùå AUS (false) f√ºr:</strong>
                <ul style="margin-left: 20px;">
                    <li><code>initialize_call</code> - Instant (<100ms)</li>
                    <li><code>get_appointments</code> - Schnell wenn gecacht</li>
                    <li><code>get_alternatives</code> - Schnell</li>
                </ul>

                <p style="margin-top: 15px;"><strong>Grund:</strong> User sollen nicht in Stille warten bei langen API Calls!</p>
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">4</span>
                    Edges (Verbindungen) erstellen
                </h3>
                <p>Function Node braucht Edges zu n√§chsten Nodes:</p>

                <ol style="margin-left: 25px; margin-top: 15px;">
                    <li>Klicke auf kleinen Kreis am Rand der Function Node (Handle)</li>
                    <li>Ziehe Verbindung zu Target Node (z.B. Conversation Node)</li>
                    <li>Edge wird erstellt</li>
                    <li>Klicke auf Edge um Transition Condition zu setzen</li>
                </ol>

                <strong style="display: block; margin-top: 20px;">Typische Transition Conditions:</strong>
                <div class="code-block" style="margin-top: 10px;">
<pre>// Success Condition:
result.status == "success"

// Available Condition:
result.available == true

// Error Condition:
result.status == "error"</pre>
                </div>

                <div class="alert alert-info" style="margin-top: 15px;">
                    <strong>üí° Tipp:</strong> Erstelle separate Edges f√ºr Success und Error!<br>
                    So kann der Agent unterschiedlich reagieren je nach Result.
                </div>
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">5</span>
                    Speichern & Publishen
                </h3>
                <ol style="margin-left: 25px;">
                    <li>Klicke "Save" oben rechts im Canvas</li>
                    <li>Klicke "Publish" um Agent live zu schalten</li>
                    <li>Retell fragt nach Version Title (optional)</li>
                    <li>Best√§tige Publishing</li>
                </ol>

                <div class="alert alert-success" style="margin-top: 20px;">
                    <strong>‚úÖ Fertig!</strong><br>
                    Die Function Node ist jetzt im Flow integriert!<br>
                    Mache einen Test Call um zu verifizieren dass alles funktioniert.
                </div>
            </div>
        </div>

        <!-- TAB 5: V39 CHECK -->
        <div class="tab-content">
            <h2>‚úÖ V39 Validierungs-Checkliste</h2>
            <p style="font-size: 1.1em; margin-bottom: 30px;">
                Pr√ºfe ob dein V39 Flow alle ben√∂tigten Functions korrekt konfiguriert hat.
            </p>

            <div class="alert alert-danger">
                <strong>üö® KRITISCHER BUG ENTDECKT (2025-10-24):</strong><br>
                V39 Agent halluziniert Verf√ºgbarkeit weil Flow Canvas <strong>Edges fehlen</strong>!<br>
                ‚Üí Siehe Tab <strong>"üö® V39 Flow Fix"</strong> f√ºr sofortigen Fix!<br><br>
                <strong>Symptom:</strong> Agent sagt "nicht verf√ºgbar" OHNE Backend zu pr√ºfen.<br>
                <strong>Fix Zeit:</strong> 15 Minuten (nur Dashboard, kein Code-Change n√∂tig)
            </div>

            <div class="alert alert-success">
                <strong>‚úÖ GUTE NACHRICHT:</strong><br>
                Dein V39 Flow hat bereits ALLE 8 ben√∂tigten Tools definiert!<br>
                Nur die Flow Canvas Edges m√ºssen hinzugef√ºgt werden.
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">1</span>
                    Dashboard Functions Check
                </h3>
                <p>Gehe zu Global Settings ‚Üí Functions Tab und pr√ºfe ob diese 6 vorhanden sind:</p>

                <table style="width: 100%; margin-top: 15px; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                            <th style="padding: 12px; text-align: left;">#</th>
                            <th style="padding: 12px; text-align: left;">Function Name</th>
                            <th style="padding: 12px; text-align: left;">Priorit√§t</th>
                            <th style="padding: 12px; text-align: left;">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 12px;">1</td>
                            <td style="padding: 12px;"><code>check_availability_v17</code></td>
                            <td style="padding: 12px;">üî¥ P0 CRITICAL</td>
                            <td style="padding: 12px;"><input type="checkbox"> Vorhanden</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 12px;">2</td>
                            <td style="padding: 12px;"><code>book_appointment_v17</code></td>
                            <td style="padding: 12px;">üî¥ P0 CRITICAL</td>
                            <td style="padding: 12px;"><input type="checkbox"> Vorhanden</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 12px;">3</td>
                            <td style="padding: 12px;"><code>get_appointments</code></td>
                            <td style="padding: 12px;">üü† P1 HIGH</td>
                            <td style="padding: 12px;"><input type="checkbox"> Vorhanden</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 12px;">4</td>
                            <td style="padding: 12px;"><code>get_alternatives</code></td>
                            <td style="padding: 12px;">üü† P1 HIGH</td>
                            <td style="padding: 12px;"><input type="checkbox"> Vorhanden</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 12px;">5</td>
                            <td style="padding: 12px;"><code>reschedule_appointment</code></td>
                            <td style="padding: 12px;">üü° P2 MEDIUM</td>
                            <td style="padding: 12px;"><input type="checkbox"> Vorhanden</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px;">6</td>
                            <td style="padding: 12px;"><code>cancel_appointment</code></td>
                            <td style="padding: 12px;">üü° P2 MEDIUM</td>
                            <td style="padding: 12px;"><input type="checkbox"> Vorhanden</td>
                        </tr>
                    </tbody>
                </table>

                <div class="alert alert-info" style="margin-top: 20px;">
                    <strong>‚ÑπÔ∏è initialize_call NICHT in Liste?</strong><br>
                    Das ist NORMAL! <code>initialize_call</code> ist hardcoded im PHP Handler.<br>
                    Es braucht KEIN Dashboard Tool.
                </div>
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">2</span>
                    Flow Canvas Nodes Check
                </h3>
                <p>√ñffne Flow Canvas und pr√ºfe ob diese Function Nodes existieren:</p>

                <ul style="margin-left: 25px; margin-top: 15px;">
                    <li><input type="checkbox"> <code>func_00_initialize</code> ‚Üí tool-initialize-call</li>
                    <li><input type="checkbox"> <code>func_check_availability</code> ‚Üí tool-v17-check-availability</li>
                    <li><input type="checkbox"> <code>func_book_appointment</code> ‚Üí tool-v17-book-appointment</li>
                    <li><input type="checkbox"> <code>func_get_appointments</code> ‚Üí tool-get-appointments</li>
                    <li><input type="checkbox"> <code>func_reschedule_execute</code> ‚Üí tool-reschedule-appointment</li>
                    <li><input type="checkbox"> <code>func_cancel_execute</code> ‚Üí tool-cancel-appointment</li>
                </ul>

                <div class="alert alert-warning" style="margin-top: 20px;">
                    <strong>‚ö†Ô∏è Legacy Nodes (optional cleanup):</strong><br>
                    <code>func_08_availability_check</code> und <code>func_09c_final_booking</code><br>
                    verwenden noch das alte <code>tool-collect-appointment</code>.<br>
                    Diese k√∂nnen gel√∂scht werden wenn du m√∂chtest (nicht n√∂tig).
                </div>
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">3</span>
                    Test Call durchf√ºhren
                </h3>
                <p>Teste die wichtigsten Functions:</p>

                <strong style="display: block; margin-top: 15px;">Test 1: Neue Buchung (P0)</strong>
                <ol style="margin-left: 25px; margin-top: 10px;">
                    <li>Anrufen: <code>+493033081738</code></li>
                    <li>Sage: "Termin morgen um 11 Uhr f√ºr Herrenhaarschnitt"</li>
                    <li>Agent pr√ºft Verf√ºgbarkeit (check_availability_v17)</li>
                    <li>Best√§tige mit "Ja"</li>
                    <li>Agent bucht (book_appointment_v17)</li>
                    <li><input type="checkbox"> Erfolgreiche Buchung</li>
                </ol>

                <strong style="display: block; margin-top: 15px;">Test 2: Termine abfragen (P1)</strong>
                <ol style="margin-left: 25px; margin-top: 10px;">
                    <li>Anrufen</li>
                    <li>Sage: "Welche Termine habe ich?"</li>
                    <li>Agent ruft get_appointments auf</li>
                    <li><input type="checkbox"> Termine werden aufgelistet</li>
                </ol>
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">4</span>
                    Admin Panel Check
                </h3>
                <p>Gehe zu: <a href="https://api.askproai.de/admin/retell-call-sessions" target="_blank">
                    https://api.askproai.de/admin/retell-call-sessions
                </a></p>

                <ul style="margin-left: 25px; margin-top: 15px;">
                    <li><input type="checkbox"> Test Call erscheint in Liste</li>
                    <li><input type="checkbox"> Status: "ended"</li>
                    <li><input type="checkbox"> Call Details zeigen Function Traces</li>
                    <li><input type="checkbox"> Alle Functions haben status: "success"</li>
                    <li><input type="checkbox"> Keine "404 Function not found" Errors</li>
                </ul>
            </div>

            <div class="alert alert-success" style="margin-top: 30px;">
                <h3 style="margin-bottom: 15px;">üéâ SUCCESS CRITERIA</h3>
                <p><strong>Du bist DONE wenn alle Checkboxen ‚úÖ sind!</strong></p>
                <p style="margin-top: 10px;">
                    Dann ist dein V39 Flow <strong>production ready</strong> und<br>
                    du verstehst wie Functions im Retell Dashboard verwaltet werden!
                </p>
            </div>
        </div>

        <!-- TAB 6: V39 FLOW CANVAS FIX -->
        <div class="tab-content">
            <h2>üö® V39 Flow Canvas Fix - Hallucination Bug</h2>
            <p style="font-size: 1.1em; margin-bottom: 30px;">
                <strong>KRITISCHER BUG:</strong> V39 Agent halluziniert Verf√ºgbarkeit weil Flow Canvas Edges fehlen!
            </p>

            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px;">
                <h3 style="color: white; margin-bottom: 20px;">‚ö° TL;DR - WAS DU TUN MUSST (Ultra-Kurz):</h3>
                <ol style="font-size: 1.1em; line-height: 2; margin-left: 20px;">
                    <li><strong>Dashboard √∂ffnen:</strong> https://dashboard.retellai.com</li>
                    <li><strong>Flow Canvas Editor √∂ffnen:</strong> "Conversation Flow Agent Friseur 1" ‚Üí Edit</li>
                    <li><strong>Function Node hinzuf√ºgen:</strong> "Function" von links auf Canvas ziehen</li>
                    <li><strong>Dropdown setzen:</strong> "Select Function" ‚Üí <code style="background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 5px;">check_availability_v17</code></li>
                    <li><strong>Edges verbinden:</strong> node_03c ‚Üí neue Function Node ‚Üí Success Path</li>
                    <li><strong>Speichern & Publishen:</strong> Save ‚Üí Publish ‚Üí 60 Sekunden warten</li>
                    <li><strong>Testen:</strong> Call +493033081738 und sagen "Termin heute 16 Uhr"</li>
                </ol>
                <p style="margin-top: 20px; font-size: 1.05em; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                    <strong>üîë WICHTIG:</strong> Du brauchst <strong>KEINE neue Custom Function</strong> zu erstellen!<br>
                    <code>check_availability_v17</code> existiert schon (siehe deine Dropdown).<br>
                    Du f√ºgst nur eine <strong>NODE</strong> hinzu die darauf referenziert!
                </p>
            </div>

            <div class="alert alert-danger">
                <h3 style="margin-bottom: 15px;">üî¥ PROBLEM IDENTIFIZIERT (2025-10-24)</h3>
                <strong>Symptom:</strong><br>
                Agent sagt "Leider ist um 16:00 Uhr kein Termin verf√ºgbar" OHNE Backend zu pr√ºfen.<br><br>
                <strong>Root Cause:</strong><br>
                Flow Canvas hat KEINE EDGES von <code>node_03c_anonymous_customer</code> zu Function Nodes!<br><br>
                <strong>Impact:</strong><br>
                ‚Ä¢ Agent halluziniert Antworten ohne Daten ‚ùå<br>
                ‚Ä¢ check_availability wird NIE aufgerufen ‚ùå<br>
                ‚Ä¢ Falsche Verf√ºgbarkeits-Informationen ‚ùå<br>
                ‚Ä¢ User Frustration & Lost Bookings ‚ùå
            </div>

            <div class="alert alert-info">
                <strong>‚úÖ GUTE NACHRICHT:</strong><br>
                Der PHP Backend Code ist PERFEKT! Alle Handler funktionieren.<br>
                Das Problem ist NUR die Flow Canvas Architektur - kann in 15 Minuten gefixt werden!
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">1</span>
                    Retell Dashboard √∂ffnen & einloggen
                </h3>
                <p><strong>URL:</strong> <code>https://dashboard.retellai.com</code></p>
                <ol style="margin-left: 25px; margin-top: 10px;">
                    <li>Browser √∂ffnen (Chrome/Firefox empfohlen)</li>
                    <li>Zu Retell Dashboard navigieren</li>
                    <li>Mit deinem Account einloggen</li>
                    <li>Workspace ausw√§hlen (wenn mehrere vorhanden)</li>
                </ol>
                <div class="screenshot-placeholder">
                    üì∏ Screenshot: Retell Dashboard - Login & Workspace Selection
                </div>
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">2</span>
                    Flow Canvas Editor √∂ffnen
                </h3>
                <ol style="margin-left: 25px; margin-top: 10px;">
                    <li>Links in Sidebar: "Agents" klicken</li>
                    <li>Agent finden: <strong>"Conversation Flow Agent Friseur 1"</strong></li>
                    <li>Auf den Agent klicken</li>
                    <li>Flow Canvas √∂ffnet sich automatisch</li>
                    <li>Oben rechts: <strong>"Edit"</strong> Button klicken (roter Button)</li>
                </ol>
                <div class="screenshot-placeholder">
                    üì∏ Screenshot: Agent Liste mit "Conversation Flow Agent Friseur 1"
                </div>
                <div class="alert alert-warning" style="margin-top: 15px;">
                    <strong>‚ö†Ô∏è WICHTIG:</strong> "Edit" Button MUSS geklickt werden!<br>
                    Im View-Only Mode kannst du keine √Ñnderungen machen.
                </div>
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">3</span>
                    Node finden: node_03c_anonymous_customer
                </h3>
                <p>Du musst die Node finden wo der Flow aktuell stoppt:</p>
                <ol style="margin-left: 25px; margin-top: 10px;">
                    <li>Im Flow Canvas: Zoom anpassen (Mausrad oder Zoom Controls)</li>
                    <li>Suche nach Node mit Label: <strong>"Anonymous Customer Handling"</strong></li>
                    <li>Oder benutze Search Box (oben links) und suche: <code>node_03c</code></li>
                    <li>Node sollte nach <code>node_02_customer_routing</code> kommen</li>
                    <li>Klicke die Node an um sie zu selektieren (blauer Rahmen)</li>
                </ol>
                <div class="screenshot-placeholder">
                    üì∏ Screenshot: Flow Canvas mit node_03c_anonymous_customer selektiert
                </div>
                <div class="code-block" style="margin-top: 15px;">
<pre>Expected Flow Position:
begin
  ‚Üí func_00_initialize (‚úÖ works)
  ‚Üí node_02_customer_routing (‚úÖ works)
  ‚Üí node_03c_anonymous_customer (‚ö†Ô∏è HIER stoppt Flow!)
  ‚Üí ‚ùå NO EDGES TO FUNCTION NODES</pre>
                </div>
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">4</span>
                    Extract Dynamic Variable Node hinzuf√ºgen (falls nicht vorhanden)
                </h3>
                <p>Pr√ºfe ob eine "Extract Dynamic Variable" Node existiert NACH node_03c:</p>

                <strong style="display: block; margin-top: 15px;">Option A: Node existiert bereits ‚úÖ</strong>
                <ul style="margin-left: 25px; margin-top: 10px;">
                    <li>Suche nach Node mit Label: "Extract Appointment Variables"</li>
                    <li>Sollte extrahieren: <code>datum</code>, <code>uhrzeit</code>, <code>dienstleistung</code></li>
                    <li>Falls vorhanden: Gehe zu Schritt 5</li>
                </ul>

                <strong style="display: block; margin-top: 15px;">Option B: Node fehlt ‚ùå - Erstellen:</strong>
                <ol style="margin-left: 25px; margin-top: 10px;">
                    <li>Links in Node-Typen Spalte: Finde "Extract Dynamic Variable"</li>
                    <li>Ziehe es auf Canvas (Drag & Drop)</li>
                    <li>Platziere es NACH node_03c_anonymous_customer</li>
                    <li>Selektiere die neue Node</li>
                    <li>Rechts im Properties Panel konfigurieren:</li>
                </ol>

                <div class="field-demo" style="margin-top: 15px;">
                    <label>Node Name:</label>
                    <input type="text" value="Extract Appointment Variables" readonly>
                </div>

                <div class="field-demo">
                    <label>Variables to Extract:</label>
                    <div style="background: #282c34; color: #abb2bf; padding: 15px; border-radius: 5px; font-family: monospace; margin-top: 10px;">
datum (string) - Datum des Termins<br>
uhrzeit (string) - Uhrzeit des Termins<br>
dienstleistung (string) - Name der Dienstleistung
                    </div>
                    <button class="copy-btn" onclick="copyText('datum\nuhrzeit\ndienstleistung')">üìã Kopieren</button>
                </div>
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">5</span>
                    Function Node hinzuf√ºgen (einfach!)
                </h3>

                <div class="alert alert-success">
                    <strong>‚úÖ GUTE NACHRICHT:</strong><br>
                    Die Function <code>check_availability_v17</code> existiert BEREITS (siehe deine Dropdown-Liste)!<br>
                    Du brauchst <strong>KEINE neue Custom Function zu erstellen</strong>!<br><br>
                    Du musst nur eine <strong>NODE im Canvas hinzuf√ºgen</strong> die auf diese existierende Function referenziert.
                </div>

                <h4 style="margin-top: 25px; color: #667eea;">üìã Was du tun musst:</h4>

                <strong style="display: block; margin-top: 15px; font-size: 1.05em;">A) Function Node in Canvas ziehen:</strong>
                <ol style="margin-left: 25px; margin-top: 10px; line-height: 1.8;">
                    <li>Links in der Sidebar: Finde <strong>"Function"</strong> in der Node-Typen Liste</li>
                    <li>Klicke auf "Function" und HALTE die Maustaste</li>
                    <li>Ziehe es auf den Canvas (irgendwo in die Mitte)</li>
                    <li>Lasse Maustaste los ‚Üí Neue orange Function Node erscheint</li>
                </ol>

                <div class="screenshot-placeholder" style="margin-top: 15px;">
                    üì∏ Screenshot: Function Node Typ in Sidebar + Drag auf Canvas
                </div>

                <strong style="display: block; margin-top: 25px; font-size: 1.05em;">B) Function Node konfigurieren:</strong>
                <p style="margin-left: 25px; margin-top: 10px;">Klicke auf die neue orange Node ‚Üí Rechts √∂ffnet sich Properties Panel:</p>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 15px; border-left: 5px solid #667eea;">
                    <div class="field-demo">
                        <label>1Ô∏è‚É£ Node Name (optional):</label>
                        <input type="text" value="Check Availability" readonly id="check-node-name">
                        <small style="display: block; margin-top: 8px; color: #6c757d;">
                            Freundlicher Name f√ºr Canvas - kannst du frei w√§hlen
                        </small>
                    </div>

                    <div class="field-demo">
                        <label>2Ô∏è‚É£ Select Function: ‚≠ê <strong>DER WICHTIGSTE PUNKT!</strong></label>
                        <p style="background: white; padding: 15px; border: 2px solid #667eea; border-radius: 8px; margin-top: 10px;">
                            <strong style="color: #667eea; font-size: 1.1em;">W√§hle aus Dropdown:</strong><br>
                            <code style="font-size: 1.2em; background: #282c34; color: #61dafb; padding: 5px 10px; border-radius: 5px; display: inline-block; margin-top: 8px;">
                                check_availability_v17
                            </code>
                        </p>
                        <small style="display: block; margin-top: 8px; color: #dc3545; font-weight: bold;">
                            üîë Du siehst diese Option in deiner Dropdown weil die Function schon existiert!<br>
                            Du referenzierst nur die existierende Function - erstellst KEINE neue!
                        </small>
                    </div>

                    <div class="field-demo">
                        <label>3Ô∏è‚É£ Instruction:</label>
                        <textarea rows="2" readonly id="check-instruction">Einen Moment bitte, ich pr√ºfe die Verf√ºgbarkeit f√ºr Sie...</textarea>
                        <button class="copy-btn" onclick="copyValue('check-instruction')">üìã Kopieren</button>
                        <small style="display: block; margin-top: 8px; color: #6c757d;">
                            Text den Agent W√ÑHREND Function Execution sagt
                        </small>
                    </div>

                    <div class="field-demo">
                        <label>4Ô∏è‚É£ Speak During Execution:</label>
                        <p style="margin-top: 10px;">
                            ‚úÖ <strong>Checkbox AN</strong> (checked/enabled)<br>
                            <small style="color: #6c757d;">Grund: Verf√ºgbarkeits-Check dauert 1-3 Sekunden</small>
                        </p>
                    </div>

                    <div class="field-demo">
                        <label>5Ô∏è‚É£ Wait for Result:</label>
                        <p style="margin-top: 10px;">
                            ‚úÖ <strong>Checkbox AN</strong> (checked/enabled)<br>
                            <small style="color: #6c757d;">Grund: Sonst sind Results nicht verf√ºgbar</small>
                        </p>
                    </div>
                </div>

                <div class="alert alert-info" style="margin-top: 20px;">
                    <strong>üí° VERSTANDEN?</strong><br>
                    Du hast jetzt eine <strong>NODE</strong> im Canvas die auf die <strong>existierende Function</strong> zeigt.<br>
                    Die Function selbst existiert schon - du musst sie nicht erstellen!<br><br>
                    <strong>Analogie:</strong><br>
                    Function = Telefonnummer (existiert schon)<br>
                    Node = Kontakt in deinem Handy (referenziert die Nummer)
                </div>
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">6</span>
                    üîó EDGES VERBINDEN - DER KRITISCHE SCHRITT!
                </h3>
                <p style="color: #dc3545; font-weight: bold;">
                    ‚ö†Ô∏è DIES IST DER WICHTIGSTE SCHRITT! Ohne diese Edges funktioniert es nicht!
                </p>

                <strong style="display: block; margin-top: 20px; font-size: 1.1em;">Edge #1: node_03c ‚Üí Extract DV Node</strong>
                <ol style="margin-left: 25px; margin-top: 10px;">
                    <li>Klicke auf <code>node_03c_anonymous_customer</code></li>
                    <li>Finde kleinen Kreis am Rand (Handle/Anchor Point)</li>
                    <li>Klicke und HALTE die Maustaste</li>
                    <li>Ziehe Linie zu "Extract Appointment Variables" Node</li>
                    <li>Lasse Maustaste los wenn √ºber Target Node</li>
                    <li>Edge wird erstellt (Linie zwischen Nodes sichtbar)</li>
                </ol>
                <div class="screenshot-placeholder" style="margin-top: 15px;">
                    üì∏ Screenshot: Edge von node_03c zu Extract DV Node
                </div>

                <strong style="display: block; margin-top: 20px; font-size: 1.1em;">Edge #2: Extract DV Node ‚Üí Check Availability Function</strong>
                <ol style="margin-left: 25px; margin-top: 10px;">
                    <li>Klicke auf "Extract Appointment Variables" Node</li>
                    <li>Finde Handle am Rand</li>
                    <li>Ziehe Edge zu "Check Availability" Function Node</li>
                    <li>Edge erstellen</li>
                </ol>
                <div class="screenshot-placeholder" style="margin-top: 15px;">
                    üì∏ Screenshot: Edge von Extract DV zu Check Availability Function
                </div>

                <strong style="display: block; margin-top: 20px; font-size: 1.1em;">Edge #3: Check Availability ‚Üí Success Path</strong>
                <ol style="margin-left: 25px; margin-top: 10px;">
                    <li>Klicke auf "Check Availability" Function Node</li>
                    <li>Ziehe Edge zu n√§chster Node (z.B. "Present Availability" Conversation Node)</li>
                    <li>Klicke auf die Edge (Linie)</li>
                    <li>Rechts im Properties Panel: Transition Condition setzen</li>
                    <li>Condition: <code>result.available == true</code> ODER <code>result.status == "success"</code></li>
                </ol>

                <strong style="display: block; margin-top: 20px; font-size: 1.1em;">Edge #4: Check Availability ‚Üí Error Path (Optional)</strong>
                <ol style="margin-left: 25px; margin-top: 10px;">
                    <li>Von derselben "Check Availability" Node</li>
                    <li>Ziehe ZWEITE Edge zu Error Handling Node</li>
                    <li>Condition: <code>result.available == false</code> ODER <code>result.status == "error"</code></li>
                </ol>

                <div class="alert alert-success" style="margin-top: 20px;">
                    <strong>‚úÖ Expected Final Flow Structure:</strong>
                    <div class="code-block" style="margin-top: 10px;">
<pre>node_03c_anonymous_customer
    ‚Üì (Edge #1)
Extract Appointment Variables (datum, uhrzeit, dienstleistung)
    ‚Üì (Edge #2)
Check Availability Function (tool: check_availability_v17)
    ‚îú‚îÄ (Edge #3) available: true ‚Üí Present Availability
    ‚îî‚îÄ (Edge #4) available: false ‚Üí Offer Alternatives</pre>
                    </div>
                </div>
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">7</span>
                    Global Tools verifizieren
                </h3>
                <p>Bevor du speicherst, pr√ºfe dass die Global Function existiert:</p>
                <ol style="margin-left: 25px; margin-top: 10px;">
                    <li>Oben in der Navbar: "Settings" oder "‚öôÔ∏è" Icon klicken</li>
                    <li>Tab: "Functions" oder "Custom Functions"</li>
                    <li>Suche in Liste: <code>check_availability_v17</code></li>
                    <li>Falls vorhanden: ‚úÖ Gut!</li>
                    <li>Falls NICHT vorhanden: Siehe Tab "‚ûï Neue Function" um sie zu erstellen</li>
                </ol>

                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è WICHTIG:</strong><br>
                    Function Node kann nur auf EXISTIERENDE Global Functions referenzieren!<br>
                    Wenn Tool fehlt, erscheint Fehlermeldung beim Speichern.
                </div>
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">8</span>
                    Speichern & Publishen
                </h3>
                <ol style="margin-left: 25px;">
                    <li>Oben rechts: <strong>"Save"</strong> Button klicken (gr√ºner Button)</li>
                    <li>Warte bis "Saved successfully" Meldung erscheint</li>
                    <li>Oben rechts: <strong>"Publish"</strong> Button klicken (blauer Button)</li>
                    <li>Dialog erscheint: "Publish Agent"</li>
                    <li>Optional: Version Title eingeben (z.B. "V39 Flow Canvas Fix - Edges added")</li>
                    <li>Klicke "Confirm" oder "Publish"</li>
                    <li>Warte 30-60 Sekunden bis Deployment complete</li>
                </ol>

                <div class="screenshot-placeholder">
                    üì∏ Screenshot: Publish Dialog mit Version Title
                </div>

                <div class="alert alert-info" style="margin-top: 15px;">
                    <strong>‚ÑπÔ∏è Deployment Zeit:</strong><br>
                    Retell braucht ca. 30-60 Sekunden um den neuen Flow zu aktivieren.<br>
                    Warte diese Zeit bevor du Test Call machst!
                </div>
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">9</span>
                    üß™ TEST CALL - Verification
                </h3>
                <p><strong>Jetzt kommt der Moment der Wahrheit!</strong></p>

                <strong style="display: block; margin-top: 15px;">Terminal Setup (vor dem Call):</strong>
                <div class="code-block" style="margin-top: 10px;">
<pre># Terminal 1: Laravel Logs Monitor
tail -f /var/www/api-gateway/storage/logs/laravel.log | grep -E "(check_availability|üöÄ|‚úÖ)"

# Terminal 2: Database Monitor
watch -n 1 "psql -U postgres -d api_gateway -c \"SELECT function_name, status FROM retell_function_traces ORDER BY created_at DESC LIMIT 5;\""</pre>
                </div>
                <button class="copy-btn" onclick="copyText('tail -f /var/www/api-gateway/storage/logs/laravel.log | grep -E \"(check_availability|üöÄ|‚úÖ)\"')">üìã Terminal 1 Kopieren</button>

                <strong style="display: block; margin-top: 20px;">Test Call durchf√ºhren:</strong>
                <ol style="margin-left: 25px; margin-top: 10px;">
                    <li>Rufe an: <code>+493033081738</code></li>
                    <li>Warte auf Agent Greeting</li>
                    <li>Sage EXAKT: <strong>"Termin heute um 16 Uhr f√ºr Herrenhaarschnitt"</strong></li>
                    <li>Beobachte Agent Verhalten</li>
                </ol>

                <strong style="display: block; margin-top: 20px;">‚úÖ SUCCESS INDICATORS:</strong>
                <ul style="margin-left: 25px; margin-top: 10px; color: #198754; font-weight: bold;">
                    <li>Agent sagt: "Einen Moment bitte, ich pr√ºfe..."</li>
                    <li>2-3 Sekunden PAUSE (Function executing!)</li>
                    <li>Terminal 1: "üöÄ check_availability called" erscheint</li>
                    <li>Terminal 2: "check_availability | success" erscheint</li>
                    <li>Agent sagt KORREKTE Verf√ºgbarkeit (matcht Cal.com!)</li>
                    <li>KEINE Hallucination!</li>
                </ul>

                <strong style="display: block; margin-top: 20px;">‚ùå FAILURE INDICATORS:</strong>
                <ul style="margin-left: 25px; margin-top: 10px; color: #dc3545; font-weight: bold;">
                    <li>Agent antwortet SOFORT ohne Pause</li>
                    <li>KEINE "check_availability" in Terminal 1</li>
                    <li>KEINE Function Trace in Terminal 2</li>
                    <li>Agent sagt wieder "nicht verf√ºgbar" (Hallucination)</li>
                </ul>

                <div class="alert alert-warning" style="margin-top: 20px;">
                    <strong>‚ö†Ô∏è Bei Failure:</strong><br>
                    1. Gehe zur√ºck zu Retell Dashboard<br>
                    2. Pr√ºfe ob Edges wirklich gespeichert wurden (Edit Mode √∂ffnen)<br>
                    3. Pr√ºfe "Last Published" Timestamp (sollte aktuell sein)<br>
                    4. Warte nochmal 60 Sekunden<br>
                    5. Retry Test Call
                </div>
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">10</span>
                    üìä Admin Panel Verification
                </h3>
                <p>Pr√ºfe im Admin Panel ob alles funktioniert hat:</p>

                <strong style="display: block; margin-top: 15px;">Schritte:</strong>
                <ol style="margin-left: 25px; margin-top: 10px;">
                    <li>√ñffne: <a href="https://api.askproai.de/admin/retell-call-sessions" target="_blank" style="color: #667eea;">
                        https://api.askproai.de/admin/retell-call-sessions
                    </a></li>
                    <li>Finde den neuesten Call (ganz oben)</li>
                    <li>Klicke auf die Zeile um Details zu √∂ffnen</li>
                    <li>Gehe zum Tab: <strong>"Function Traces"</strong></li>
                </ol>

                <strong style="display: block; margin-top: 20px;">Expected Function Traces:</strong>
                <table style="width: 100%; margin-top: 15px; border-collapse: collapse; border: 1px solid #dee2e6;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">#</th>
                            <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">Function Name</th>
                            <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">Status</th>
                            <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">Erwartung</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 12px; border: 1px solid #dee2e6;">1</td>
                            <td style="padding: 12px; border: 1px solid #dee2e6;"><code>initialize_call</code></td>
                            <td style="padding: 12px; border: 1px solid #dee2e6;">‚úÖ success</td>
                            <td style="padding: 12px; border: 1px solid #dee2e6;">Wie immer</td>
                        </tr>
                        <tr style="background: #d1e7dd;">
                            <td style="padding: 12px; border: 1px solid #dee2e6;">2</td>
                            <td style="padding: 12px; border: 1px solid #dee2e6;"><code>check_availability_v17</code></td>
                            <td style="padding: 12px; border: 1px solid #dee2e6;"><strong>‚úÖ success</strong></td>
                            <td style="padding: 12px; border: 1px solid #dee2e6;"><strong>üéâ NEU! MUSS erscheinen!</strong></td>
                        </tr>
                    </tbody>
                </table>

                <div class="alert alert-success" style="margin-top: 20px;">
                    <h4>üéâ FIX ERFOLGREICH!</h4>
                    <p><strong>Wenn check_availability in Function Traces erscheint:</strong></p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>‚úÖ Flow Canvas Edges funktionieren</li>
                        <li>‚úÖ Agent ruft Backend auf</li>
                        <li>‚úÖ Keine Hallucination mehr</li>
                        <li>‚úÖ Korrekte Verf√ºgbarkeits-Checks</li>
                        <li>‚úÖ V39 ist PRODUCTION READY!</li>
                    </ul>
                </div>

                <div class="alert alert-danger" style="margin-top: 20px;">
                    <h4>‚ùå FIX FEHLGESCHLAGEN</h4>
                    <p><strong>Wenn check_availability NICHT erscheint:</strong></p>
                    <ol style="margin-left: 20px; margin-top: 10px;">
                        <li>Zur√ºck zu Schritt 6 - Pr√ºfe Edges nochmal</li>
                        <li>Pr√ºfe ob Agent wirklich neu publisht wurde</li>
                        <li>Check Terminal Logs f√ºr Errors</li>
                        <li>Siehe Troubleshooting Guide unten</li>
                    </ol>
                </div>
            </div>

            <div class="step">
                <h3>
                    <span class="step-number">11</span>
                    üîç Troubleshooting
                </h3>

                <strong style="display: block; margin-top: 15px; font-size: 1.1em;">Problem: check_availability immer noch nicht aufgerufen</strong>

                <div class="comparison" style="margin-top: 15px;">
                    <div class="comparison-item comparison-wrong">
                        <h4>‚ùå M√∂gliche Ursachen</h4>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li>Edges wurden nicht gespeichert</li>
                            <li>Agent nicht neu publisht</li>
                            <li>Warte-Zeit zu kurz (<30s)</li>
                            <li>Function Node referenziert falschen Tool</li>
                            <li>Edge Condition falsch/fehlend</li>
                            <li>Node isoliert (keine Incoming Edge)</li>
                        </ul>
                    </div>
                    <div class="comparison-item comparison-right">
                        <h4>‚úÖ L√∂sungen</h4>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li>Flow Canvas √∂ffnen, Edges verifizieren</li>
                            <li>"Publish" Button nochmal klicken</li>
                            <li>60 Sekunden warten, dann testen</li>
                            <li>Properties Panel pr√ºfen: check_availability_v17</li>
                            <li>Edge klicken, Condition pr√ºfen/l√∂schen</li>
                            <li>Incoming Edge von node_03c erstellen</li>
                        </ul>
                    </div>
                </div>

                <strong style="display: block; margin-top: 20px;">Quick Debug Commands:</strong>
                <div class="code-block" style="margin-top: 10px;">
<pre># Check latest call in DB
psql -U postgres -d api_gateway -c "SELECT retell_call_id, started_at FROM retell_call_sessions ORDER BY created_at DESC LIMIT 1;"

# Check function traces for latest call
psql -U postgres -d api_gateway -c "SELECT function_name, status, created_at FROM retell_function_traces WHERE call_session_id = (SELECT id FROM retell_call_sessions ORDER BY created_at DESC LIMIT 1);"

# Check Laravel logs for errors
tail -50 /var/www/api-gateway/storage/logs/laravel.log | grep -i error</pre>
                </div>
            </div>

            <div class="alert alert-success" style="margin-top: 30px; padding: 30px;">
                <h2 style="margin-bottom: 20px;">üéØ FINAL CHECKLIST - V39 Flow Canvas Fix</h2>
                <p style="font-size: 1.1em; margin-bottom: 20px;">Alle diese Punkte m√ºssen ‚úÖ sein:</p>
                <ul style="margin-left: 25px; font-size: 1.05em;">
                    <li><input type="checkbox"> Retell Dashboard ge√∂ffnet & eingeloggt</li>
                    <li><input type="checkbox"> Flow Canvas im Edit Mode</li>
                    <li><input type="checkbox"> node_03c_anonymous_customer gefunden</li>
                    <li><input type="checkbox"> Extract DV Node existiert (oder erstellt)</li>
                    <li><input type="checkbox"> Check Availability Function Node existiert</li>
                    <li><input type="checkbox"> Edge #1: node_03c ‚Üí Extract DV erstellt</li>
                    <li><input type="checkbox"> Edge #2: Extract DV ‚Üí Function erstellt</li>
                    <li><input type="checkbox"> Edge #3: Function ‚Üí Success Path erstellt</li>
                    <li><input type="checkbox"> Function Properties: check_availability_v17 selected</li>
                    <li><input type="checkbox"> Speak During Execution: AN</li>
                    <li><input type="checkbox"> Wait for Result: AN</li>
                    <li><input type="checkbox"> Flow gespeichert (Save)</li>
                    <li><input type="checkbox"> Agent publisht (Publish)</li>
                    <li><input type="checkbox"> 60 Sekunden gewartet</li>
                    <li><input type="checkbox"> Test Call gemacht</li>
                    <li><input type="checkbox"> check_availability in Logs erschienen</li>
                    <li><input type="checkbox"> check_availability in Database Function Traces</li>
                    <li><input type="checkbox"> Agent gibt KORREKTE Verf√ºgbarkeit</li>
                </ul>

                <div style="margin-top: 30px; padding: 20px; background: white; border-radius: 10px; border: 3px solid #198754;">
                    <h3 style="color: #198754; margin-bottom: 15px;">üöÄ Wenn ALLE Checkboxen ‚úÖ:</h3>
                    <p style="font-size: 1.2em; font-weight: bold;">
                        HERZLICHEN GL√úCKWUNSCH! üéâ<br>
                        V39 Hallucination Bug ist GEFIXT!<br>
                        Agent ruft jetzt Backend auf und gibt korrekte Informationen!
                    </p>
                </div>
            </div>

            <div class="alert alert-info" style="margin-top: 30px;">
                <h3>üìö Weitere Dokumentation:</h3>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li><strong>Root Cause Analysis:</strong> <code>CRITICAL_V39_HALLUCINATION_BUG_2025-10-24.md</code></li>
                    <li><strong>Comprehensive Testing:</strong> <code>V39_TESTING_VERIFICATION_GUIDE.md</code></li>
                    <li><strong>Previous Fixes:</strong> <code>FIX_V3_FINAL_2025-10-24.md</code></li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        function switchTab(index) {
            // Hide all tab contents
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(c => c.classList.remove('active'));

            // Remove active from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => t.classList.remove('active'));

            // Show selected
            contents[index].classList.add('active');
            tabs[index].classList.add('active');

            // Scroll to top
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function copyValue(id) {
            const el = document.getElementById(id);
            const text = el.value || el.textContent;
            navigator.clipboard.writeText(text).then(() => {
                const btn = el.nextElementSibling;
                if (btn && btn.classList.contains('copy-btn')) {
                    const orig = btn.textContent;
                    btn.textContent = '‚úÖ Kopiert!';
                    btn.classList.add('copied');
                    setTimeout(() => {
                        btn.textContent = orig;
                        btn.classList.remove('copied');
                    }, 2000);
                }
            });
        }

        function toggleInstruction(select) {
            // Could add logic to change textarea placeholder based on selection
            console.log('Instruction type changed:', select.value);
        }

        function copyText(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Could show toast notification
                console.log('Text copied:', text);
            });
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Portal Login Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #666;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #2563eb;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Business Portal Login Test</h1>
        
        <div class="test-section">
            <h3>Test 1: Check Current Session</h3>
            <button onclick="checkSession()">Check Session</button>
            <div id="session-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>Test 2: Login with Demo Credentials</h3>
            <button onclick="performLogin()">Login as demo@askproai.de</button>
            <div id="login-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>Test 3: Access Protected API</h3>
            <button onclick="testApi()">Test /business/api/calls</button>
            <div id="api-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>Test 4: Check Cookies</h3>
            <button onclick="checkCookies()">List All Cookies</button>
            <div id="cookies-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>Test 5: Force Test Login</h3>
            <button onclick="forceTestLogin()">Force Test Login</button>
            <div id="force-result" class="result"></div>
        </div>
    </div>

    <script>
        async function checkSession() {
            const result = document.getElementById('session-result');
            result.textContent = 'Checking session...';
            
            try {
                const response = await fetch('/business/session-debug', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                result.className = 'result ' + (data.auth.portal_check ? 'success' : 'info');
                result.textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                result.className = 'result error';
                result.textContent = 'Error: ' + error.message;
            }
        }
        
        async function performLogin() {
            const result = document.getElementById('login-result');
            result.textContent = 'Logging in...';
            
            try {
                // First get the login page to get CSRF token
                const loginPageResponse = await fetch('/business/login', {
                    credentials: 'include'
                });
                const loginPageHtml = await loginPageResponse.text();
                
                // Extract CSRF token
                const csrfMatch = loginPageHtml.match(/<input[^>]+name="_token"[^>]+value="([^"]+)"/);
                const csrfToken = csrfMatch ? csrfMatch[1] : null;
                
                if (!csrfToken) {
                    throw new Error('CSRF token not found');
                }
                
                // Submit login form
                const formData = new FormData();
                formData.append('_token', csrfToken);
                formData.append('email', 'demo@askproai.de');
                formData.append('password', 'demo1234');
                
                const loginResponse = await fetch('/business/login', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include',
                    redirect: 'manual'
                });
                
                if (loginResponse.type === 'opaqueredirect' || loginResponse.status === 302) {
                    result.className = 'result success';
                    result.textContent = 'Login successful! Redirected to dashboard.\n\nNow check session again to verify.';
                    
                    // Auto-check session after 1 second
                    setTimeout(checkSession, 1000);
                } else {
                    const text = await loginResponse.text();
                    result.className = 'result error';
                    result.textContent = `Login failed. Status: ${loginResponse.status}\n\n${text.substring(0, 500)}...`;
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = 'Error: ' + error.message;
            }
        }
        
        async function testApi() {
            const result = document.getElementById('api-result');
            result.textContent = 'Testing API...';
            
            try {
                const response = await fetch('/business/api/calls', {
                    credentials: 'include'
                });
                
                if (response.status === 401) {
                    result.className = 'result error';
                    result.textContent = 'Unauthorized (401) - Not logged in';
                } else if (response.status === 200) {
                    const data = await response.json();
                    result.className = 'result success';
                    result.textContent = `Success! Got ${data.data ? data.data.length : 0} calls\n\n${JSON.stringify(data, null, 2).substring(0, 500)}...`;
                } else {
                    result.className = 'result error';
                    result.textContent = `Unexpected status: ${response.status}`;
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = 'Error: ' + error.message;
            }
        }
        
        function checkCookies() {
            const result = document.getElementById('cookies-result');
            const cookies = document.cookie.split(';').map(c => c.trim());
            
            if (cookies.length === 0 || (cookies.length === 1 && cookies[0] === '')) {
                result.className = 'result info';
                result.textContent = 'No cookies found';
            } else {
                result.className = 'result info';
                result.textContent = 'Cookies:\n' + cookies.join('\n');
            }
        }
        
        async function forceTestLogin() {
            const result = document.getElementById('force-result');
            result.textContent = 'Force logging in...';
            
            try {
                const response = await fetch('/business/test-login', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.error) {
                    result.className = 'result error';
                    result.textContent = JSON.stringify(data, null, 2);
                } else {
                    result.className = 'result success';
                    result.textContent = 'Force login successful!\n\n' + JSON.stringify(data, null, 2);
                    
                    // Auto-check session
                    setTimeout(checkSession, 500);
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = 'Error: ' + error.message;
            }
        }
        
        // Check session on load
        window.addEventListener('load', checkSession);
    </script>
</body>
</html>
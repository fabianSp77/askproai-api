<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Browser Diagnostic</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #333;
            margin-top: 0;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .test-item {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }
        .test-item.success {
            border-color: #28a745;
            background: #d4edda;
        }
        .test-item.error {
            border-color: #dc3545;
            background: #f8d7da;
        }
        .test-item.warning {
            border-color: #ffc107;
            background: #fff3cd;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .button-danger {
            background: #dc3545;
        }
        .button-danger:hover {
            background: #c82333;
        }
        .log {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 10px;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status-success { background: #28a745; color: white; }
        .status-error { background: #dc3545; color: white; }
        .status-warning { background: #ffc107; color: black; }
        iframe {
            width: 100%;
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üîç Ultimate Browser Diagnostic f√ºr AskProAI Admin</h1>
            <p>Dieses Tool testet ALLES, um herauszufinden, warum die Seiten nicht laden.</p>
            
            <div style="margin: 20px 0;">
                <button onclick="runAllTests()" class="button-primary">üöÄ Alle Tests starten</button>
                <button onclick="clearAllData()" class="button-danger">üóëÔ∏è Browser-Daten l√∂schen</button>
            </div>
            
            <div id="test-results" class="test-grid"></div>
        </div>
        
        <div class="card">
            <h2>üìä Live Test Results</h2>
            <div id="live-log" class="log">Bereit f√ºr Tests...</div>
        </div>
        
        <div class="card">
            <h2>üîß Problem-Seiten direkt testen</h2>
            <p>Klicke auf eine Seite, um sie in einem iFrame zu laden:</p>
            <div style="margin: 20px 0;">
                <button onclick="testInIframe('/admin/calls')">Anrufe</button>
                <button onclick="testInIframe('/admin/appointments')">Termine</button>
                <button onclick="testInIframe('/admin/customers')">Kunden</button>
                <button onclick="testInIframe('/admin/branches')">Filialen</button>
                <button onclick="testInIframe('/admin/companies')">Unternehmen</button>
            </div>
            <div id="iframe-container"></div>
        </div>
        
        <div class="card hidden" id="network-analysis">
            <h2>üåê Network Analysis</h2>
            <table id="network-table">
                <thead>
                    <tr>
                        <th>URL</th>
                        <th>Status</th>
                        <th>Type</th>
                        <th>Size</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody id="network-tbody"></tbody>
            </table>
        </div>
    </div>
    
    <script>
        const baseUrl = 'https://api.askproai.de';
        const testResults = {};
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('live-log');
            const timestamp = new Date().toLocaleTimeString();
            const typeSymbol = {
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è'
            }[type] || '‚Ä¢';
            
            logDiv.innerHTML += `[${timestamp}] ${typeSymbol} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function addTestResult(id, title, status, details) {
            const container = document.getElementById('test-results');
            let testDiv = document.getElementById(`test-${id}`);
            
            if (!testDiv) {
                testDiv = document.createElement('div');
                testDiv.id = `test-${id}`;
                testDiv.className = 'test-item';
                container.appendChild(testDiv);
            }
            
            testDiv.className = `test-item ${status}`;
            testDiv.innerHTML = `
                <h3>${title} <span class="status-badge status-${status}">${status.toUpperCase()}</span></h3>
                <p>${details}</p>
            `;
            
            testResults[id] = { title, status, details };
        }
        
        async function runAllTests() {
            log('Starting all tests...', 'info');
            document.getElementById('test-results').innerHTML = '';
            
            // Test 1: Browser Info
            testBrowserInfo();
            
            // Test 2: Cookies
            await testCookies();
            
            // Test 3: Session Storage
            testSessionStorage();
            
            // Test 4: Network Connectivity
            await testNetworkConnectivity();
            
            // Test 5: JavaScript Errors
            testJavaScriptErrors();
            
            // Test 6: Service Workers
            await testServiceWorkers();
            
            // Test 7: Console Errors
            captureConsoleErrors();
            
            // Test 8: Resource Loading
            await testResourceLoading();
            
            // Test 9: CORS
            await testCORS();
            
            // Test 10: Actual Page Loading
            await testActualPages();
            
            log('All tests completed!', 'success');
        }
        
        function testBrowserInfo() {
            const info = {
                userAgent: navigator.userAgent,
                language: navigator.language,
                cookiesEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                platform: navigator.platform,
                vendor: navigator.vendor
            };
            
            const details = Object.entries(info).map(([k, v]) => `${k}: ${v}`).join('<br>');
            addTestResult('browser-info', 'Browser Information', 'success', details);
        }
        
        async function testCookies() {
            const cookies = document.cookie.split(';').filter(c => c.trim());
            const askproaiCookies = cookies.filter(c => c.includes('askproai'));
            
            if (askproaiCookies.length > 0) {
                addTestResult('cookies', 'Cookies', 'success', 
                    `Found ${askproaiCookies.length} askproai cookies:<br>` + 
                    askproaiCookies.map(c => c.trim().split('=')[0]).join(', ')
                );
            } else {
                addTestResult('cookies', 'Cookies', 'warning', 'No askproai cookies found');
            }
        }
        
        function testSessionStorage() {
            try {
                const itemCount = sessionStorage.length;
                sessionStorage.setItem('test', 'value');
                sessionStorage.removeItem('test');
                addTestResult('session-storage', 'Session Storage', 'success', 
                    `Working correctly. ${itemCount} items stored.`);
            } catch (e) {
                addTestResult('session-storage', 'Session Storage', 'error', 
                    `Error: ${e.message}`);
            }
        }
        
        async function testNetworkConnectivity() {
            try {
                const start = performance.now();
                const response = await fetch(`${baseUrl}/api/health`, { 
                    method: 'HEAD',
                    cache: 'no-cache' 
                });
                const duration = Math.round(performance.now() - start);
                
                if (response.ok) {
                    addTestResult('network', 'Network Connectivity', 'success', 
                        `API reachable. Response time: ${duration}ms`);
                } else {
                    addTestResult('network', 'Network Connectivity', 'warning', 
                        `API returned status: ${response.status}`);
                }
            } catch (e) {
                addTestResult('network', 'Network Connectivity', 'error', 
                    `Cannot reach API: ${e.message}`);
            }
        }
        
        function testJavaScriptErrors() {
            if (window.jsErrors && window.jsErrors.length > 0) {
                addTestResult('js-errors', 'JavaScript Errors', 'error', 
                    `Found ${window.jsErrors.length} errors:<br>` + 
                    window.jsErrors.slice(-3).join('<br>')
                );
            } else {
                addTestResult('js-errors', 'JavaScript Errors', 'success', 
                    'No JavaScript errors detected');
            }
        }
        
        async function testServiceWorkers() {
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                if (registrations.length > 0) {
                    addTestResult('service-workers', 'Service Workers', 'warning', 
                        `Found ${registrations.length} service workers. These might cache old content.`);
                } else {
                    addTestResult('service-workers', 'Service Workers', 'success', 
                        'No service workers registered');
                }
            } else {
                addTestResult('service-workers', 'Service Workers', 'success', 
                    'Service workers not supported');
            }
        }
        
        function captureConsoleErrors() {
            // Override console.error
            const originalError = console.error;
            window.consoleErrors = [];
            console.error = function(...args) {
                window.consoleErrors.push(args.join(' '));
                originalError.apply(console, args);
            };
            
            addTestResult('console-setup', 'Console Error Capture', 'success', 
                'Now capturing console errors');
        }
        
        async function testResourceLoading() {
            const resources = [
                '/css/filament/filament/app.css',
                '/js/filament/filament/app.js',
                '/livewire/livewire.js'
            ];
            
            const results = await Promise.all(resources.map(async (resource) => {
                try {
                    const response = await fetch(baseUrl + resource, { method: 'HEAD' });
                    return { resource, status: response.status, ok: response.ok };
                } catch (e) {
                    return { resource, status: 'error', ok: false, error: e.message };
                }
            }));
            
            const failed = results.filter(r => !r.ok);
            if (failed.length > 0) {
                addTestResult('resources', 'Resource Loading', 'error', 
                    `Failed to load ${failed.length} resources:<br>` +
                    failed.map(r => `${r.resource}: ${r.status}`).join('<br>')
                );
            } else {
                addTestResult('resources', 'Resource Loading', 'success', 
                    'All critical resources are accessible');
            }
        }
        
        async function testCORS() {
            try {
                const response = await fetch(`${baseUrl}/admin/calls`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Accept': 'text/html',
                    }
                });
                
                if (response.ok || response.status === 302) {
                    addTestResult('cors', 'CORS', 'success', 
                        'No CORS issues detected');
                } else {
                    addTestResult('cors', 'CORS', 'warning', 
                        `Response status: ${response.status}`);
                }
            } catch (e) {
                if (e.message.includes('CORS')) {
                    addTestResult('cors', 'CORS', 'error', 
                        'CORS error detected: ' + e.message);
                } else {
                    addTestResult('cors', 'CORS', 'warning', 
                        'Fetch error: ' + e.message);
                }
            }
        }
        
        async function testActualPages() {
            const pages = [
                { path: '/admin/calls', name: 'Anrufe' },
                { path: '/admin/appointments', name: 'Termine' },
                { path: '/admin/customers', name: 'Kunden' }
            ];
            
            log('Testing actual pages with fetch...', 'info');
            
            for (const page of pages) {
                try {
                    const response = await fetch(baseUrl + page.path, {
                        credentials: 'include',
                        redirect: 'manual'
                    });
                    
                    if (response.status === 200) {
                        log(`${page.name}: ‚úÖ Success (200)`, 'success');
                    } else if (response.status === 302) {
                        log(`${page.name}: üîÑ Redirect (302)`, 'warning');
                    } else if (response.status === 500) {
                        log(`${page.name}: ‚ùå Server Error (500)`, 'error');
                        
                        // Try to get error details
                        const text = await response.text();
                        if (text.includes('Company context not set')) {
                            log('  ‚Üí Company context error detected!', 'error');
                        }
                    } else {
                        log(`${page.name}: Status ${response.status}`, 'warning');
                    }
                } catch (e) {
                    log(`${page.name}: Network error - ${e.message}`, 'error');
                }
            }
        }
        
        function testInIframe(path) {
            const container = document.getElementById('iframe-container');
            container.innerHTML = `
                <h3>Loading ${path}...</h3>
                <iframe 
                    src="${baseUrl}${path}" 
                    onload="iframeLoaded('${path}')"
                    onerror="iframeError('${path}')"
                ></iframe>
            `;
            
            // Monitor iframe loading
            setTimeout(() => {
                const iframe = container.querySelector('iframe');
                if (iframe) {
                    try {
                        // Check if we can access the iframe (same-origin)
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        log(`iFrame ${path}: Loaded, title: "${iframeDoc.title}"`, 'info');
                    } catch (e) {
                        log(`iFrame ${path}: Loaded but cannot access content (cross-origin)`, 'warning');
                    }
                }
            }, 2000);
        }
        
        function iframeLoaded(path) {
            log(`iFrame loaded: ${path}`, 'success');
        }
        
        function iframeError(path) {
            log(`iFrame error: ${path}`, 'error');
        }
        
        function clearAllData() {
            if (!confirm('Wirklich alle Browser-Daten f√ºr askproai.de l√∂schen?')) {
                return;
            }
            
            log('Clearing all browser data...', 'info');
            
            // Clear cookies
            document.cookie.split(';').forEach(cookie => {
                const name = cookie.split('=')[0].trim();
                if (name) {
                    const domains = ['api.askproai.de', '.askproai.de', ''];
                    const paths = ['/', '/admin', ''];
                    domains.forEach(domain => {
                        paths.forEach(path => {
                            document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=${path}; domain=${domain}`;
                        });
                    });
                }
            });
            
            // Clear storage
            localStorage.clear();
            sessionStorage.clear();
            
            // Clear service workers
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    registrations.forEach(reg => reg.unregister());
                });
            }
            
            log('All data cleared! Please reload the page.', 'success');
            
            setTimeout(() => {
                location.reload();
            }, 2000);
        }
        
        // Capture global errors
        window.jsErrors = [];
        window.addEventListener('error', (e) => {
            window.jsErrors.push(`${e.message} at ${e.filename}:${e.lineno}`);
        });
        
        // Auto-run browser info on load
        window.onload = () => {
            testBrowserInfo();
        };
    </script>
</body>
</html>
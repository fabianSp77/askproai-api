# =============================================================================
# PHP Security Configuration for AskProAI
# =============================================================================
# CRITICAL: Place this in /etc/php/8.3/fpm/conf.d/99-security.ini
# Apply with: systemctl restart php8.3-fpm

# -----------------------------------------------------------------------------
# Memory and Resource Limits
# -----------------------------------------------------------------------------

# Memory limits
memory_limit = 512M
max_execution_time = 60
max_input_time = 60
max_input_vars = 3000

# File upload limits
upload_max_filesize = 10M
post_max_size = 10M
max_file_uploads = 20

# -----------------------------------------------------------------------------
# Disable Dangerous Functions
# -----------------------------------------------------------------------------
disable_functions = exec,passthru,shell_exec,system,proc_open,popen,curl_exec,curl_multi_exec,parse_ini_file,show_source,file_get_contents,file_put_contents,fwrite,fputs,fopen,readfile,highlight_file,source,eval,base64_decode,gzinflate,gzuncompress,gzdecode,str_rot13

# Disable dangerous classes
disable_classes = 

# -----------------------------------------------------------------------------
# Error Handling and Logging
# -----------------------------------------------------------------------------

# Hide PHP errors from users (security)
display_errors = Off
display_startup_errors = Off
log_errors = On
error_log = /var/log/php/error.log

# Log all errors for security analysis
error_reporting = E_ALL & ~E_DEPRECATED & ~E_STRICT

# -----------------------------------------------------------------------------
# Session Security
# -----------------------------------------------------------------------------

# Session security settings
session.use_strict_mode = 1
session.use_only_cookies = 1
session.cookie_httponly = 1
session.cookie_secure = 1
session.cookie_samesite = "Strict"
session.use_trans_sid = 0
session.sid_length = 48
session.sid_bits_per_character = 6

# Session entropy
session.entropy_length = 32
session.hash_function = sha256

# Session garbage collection
session.gc_probability = 1
session.gc_divisor = 1000
session.gc_maxlifetime = 1440

# -----------------------------------------------------------------------------
# File System Security
# -----------------------------------------------------------------------------

# Restrict file operations
allow_url_fopen = Off
allow_url_include = Off
auto_prepend_file = 
auto_append_file = 
doc_root = /var/www/api-gateway/public

# File upload security
file_uploads = On
upload_tmp_dir = /tmp/php_uploads

# Open basedir restriction (uncomment and adjust path)
# open_basedir = /var/www/api-gateway:/tmp:/var/lib/php/sessions

# -----------------------------------------------------------------------------
# Network Security
# -----------------------------------------------------------------------------

# User agent restrictions
user_agent = "AskProAI-PHP/8.3"

# Default socket timeout
default_socket_timeout = 30

# -----------------------------------------------------------------------------
# Information Disclosure Prevention
# -----------------------------------------------------------------------------

# Hide PHP version
expose_php = Off

# Hide server information
server_api = 

# -----------------------------------------------------------------------------
# Database Security (MySQL/MariaDB)
# -----------------------------------------------------------------------------

# MySQL connection limits
mysql.connect_timeout = 30
mysql.default_port = 3306
mysql.default_host = localhost

# PDO MySQL settings
pdo_mysql.default_socket = /var/run/mysqld/mysqld.sock

# -----------------------------------------------------------------------------
# Mail Security
# -----------------------------------------------------------------------------

# SMTP security
SMTP = localhost
smtp_port = 25
sendmail_path = /usr/sbin/sendmail -t -i

# Mail function restrictions
mail.add_x_header = Off

# -----------------------------------------------------------------------------
# Opcache Security
# -----------------------------------------------------------------------------

# Opcache security settings
opcache.enable = 1
opcache.enable_cli = 1
opcache.memory_consumption = 256
opcache.interned_strings_buffer = 16
opcache.max_accelerated_files = 10000
opcache.revalidate_freq = 2
opcache.fast_shutdown = 1
opcache.validate_timestamps = 1

# Opcache security
opcache.protect_memory = 1
opcache.restrict_api = "/var/www/api-gateway"

# -----------------------------------------------------------------------------
# Additional Security Headers
# -----------------------------------------------------------------------------

# Auto globals registration
register_globals = Off
register_argc_argv = Off

# Magic quotes (legacy, should be off)
magic_quotes_gpc = Off
magic_quotes_runtime = Off
magic_quotes_sybase = Off

# -----------------------------------------------------------------------------
# Input Filtering
# -----------------------------------------------------------------------------

# Input filtering
filter.default = unsafe_raw
filter.default_flags = 

# -----------------------------------------------------------------------------
# Timezone and Locale
# -----------------------------------------------------------------------------

# Set timezone
date.timezone = "Europe/Berlin"

# Locale settings
intl.default_locale = "de_DE"

# -----------------------------------------------------------------------------
# Resource Limits per Request
# -----------------------------------------------------------------------------

# Maximum number of input variables
max_input_nesting_level = 64
max_input_vars = 3000

# Request limits
request_order = "GP"
variables_order = "GPCS"

# -----------------------------------------------------------------------------
# Debugging and Development (Production Settings)
# -----------------------------------------------------------------------------

# Disable debugging features in production
html_errors = Off
xmlrpc_errors = Off
xmlrpc_error_number = 0

# Ignore repeated errors
ignore_repeated_errors = On
ignore_repeated_source = On

# Report memleaks
report_memleaks = On

# Track errors
track_errors = Off
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Guthaben aufladen - {{ $company->name }}</title>
    <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="expires" content="0">
    <link href="/css/app.css?v={{ time() }}" rel="stylesheet">
    <!-- Fallback to CDN for now, but with production warning suppressed -->
    <script>
        // Suppress Tailwind CDN warning
        window.console = window.console || {};
        const originalWarn = console.warn;
        console.warn = function(...args) {
            if (args[0] && args[0].includes('cdn.tailwindcss.com')) return;
            originalWarn.apply(console, args);
        };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Mobile-optimierte Schriftgrößen */
        :root {
            --text-base: 18px;
            --text-lg: 24px;
            --text-xl: 32px;
            --button-text: 20px;
        }
        
        body {
            font-size: var(--text-base);
        }
        
        /* Touch-optimierte Buttons */
        .touch-button {
            min-height: 56px;
            font-size: var(--button-text);
            touch-action: manipulation;
        }
        
        /* Smooth transitions */
        .amount-card {
            transition: all 0.2s ease;
        }
        
        .amount-card:active {
            transform: scale(0.98);
        }
        
        /* Custom number input styling */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        /* Bonus animation */
        @keyframes bonusPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .bonus-highlight {
            animation: bonusPulse 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Sticky Header -->
    <header class="sticky top-0 z-50 bg-white shadow-sm border-b">
        <div class="flex items-center justify-between px-4 py-3">
            <h1 class="text-xl font-bold text-gray-900">{{ $company->name }}</h1>
            <div class="flex items-center text-sm text-green-600">
                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                Sichere Zahlung
            </div>
        </div>
    </header>

    <div class="max-w-lg mx-auto px-4 py-6 pb-24">
        <!-- Balance Widget -->
        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl p-6 shadow-lg mb-6">
            <div class="text-center">
                <p class="text-gray-600 text-sm mb-1">Aktuelles Guthaben</p>
                <p class="text-4xl font-bold text-blue-900">{{ number_format($currentBalance, 2, ',', '.') }} €</p>
                
                @if($avgDailyUsage > 0)
                    <div class="mt-4 space-y-2">
                        <div class="flex items-center justify-center text-sm">
                            <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                            </svg>
                            <span class="text-gray-700">
                                Ihr Guthaben reicht für: <strong>~{{ $callsRemaining }} Anrufe</strong>
                                @if($avgCallMinutes > 0)
                                    <span class="text-xs text-gray-500">(bei Ø {{ $avgCallMinutes }} Min)</span>
                                @endif
                            </span>
                        </div>
                        <div class="flex items-center justify-center text-sm">
                            <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            <span class="text-gray-700">
                                Das sind etwa <strong>{{ $daysRemaining > 90 ? '> 3 Monate' : ($daysRemaining . ' Tage') }}</strong>
                                @if($callsPerDay > 0)
                                    <span class="text-xs text-gray-500">(bei {{ number_format($callsPerDay, 1, ',', '.') }} Anrufen/Tag)</span>
                                @endif
                            </span>
                        </div>
                    </div>
                    
                    @if($lowBalanceWarning && $daysRemaining < 7)
                        <div class="mt-3 bg-red-100 border border-red-300 text-red-800 px-4 py-3 rounded-lg flex flex-col items-center animate-pulse">
                            <div class="flex items-center mb-2">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                                </svg>
                                <span class="font-bold text-base">Achtung: Guthaben reicht nur noch</span>
                            </div>
                            <div class="text-center">
                                @if($daysRemaining < 1)
                                    <div class="text-2xl font-bold">{{ floor($daysRemaining * 24) }} Stunden</div>
                                @else
                                    <div class="text-2xl font-bold">{{ floor($daysRemaining) }} Tage, {{ floor(($daysRemaining - floor($daysRemaining)) * 24) }} Stunden</div>
                                @endif
                                @if($callsRemaining > 0)
                                    <div class="text-sm mt-1">(oder nur noch ~{{ $callsRemaining }} Anrufe)</div>
                                @endif
                            </div>
                        </div>
                    @elseif($lowBalanceWarning)
                        <div class="mt-3 bg-yellow-100 text-yellow-800 px-3 py-2 rounded-lg text-sm flex items-center">
                            <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                            </svg>
                            <span>Guthaben wird knapp - Zeit zum Aufladen!</span>
                        </div>
                    @endif
                @endif
            </div>
        </div>

        @if(session('error'))
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-6">
                {{ session('error') }}
            </div>
        @endif

        <form id="topupForm" action="{{ route('public.topup.process', $company->id) }}" method="POST">
            @csrf
            
            <!-- Personal Information -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <h2 class="text-lg font-semibold mb-4">Ihre Daten</h2>
                
                <div class="space-y-4">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
                            Ihr Name
                        </label>
                        <input id="name" name="name" type="text" required 
                               class="w-full px-4 py-3 text-lg border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                               placeholder="Max Mustermann">
                    </div>
                    
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                            E-Mail-Adresse
                        </label>
                        <input id="email" name="email" type="email" required 
                               class="w-full px-4 py-3 text-lg border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                               placeholder="max@beispiel.de">
                    </div>
                </div>
            </div>

            <!-- Amount Selection -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <h2 class="text-lg font-semibold mb-4">Betrag wählen</h2>
                
                @if($avgCallCost > 0)
                    <!-- Express-Buttons basierend auf Anrufen -->
                    <div class="mb-6">
                        <p class="text-sm font-medium text-gray-700 mb-3">⚡ Schnellauswahl nach Anzahl Anrufe:</p>
                        <div class="grid grid-cols-3 gap-2">
                            <button type="button" 
                                    onclick="selectAmount({{ round(100 * $avgCallCost) }}, {{ round(100 * $avgCallCost * 0.1) }})"
                                    class="p-3 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors text-center">
                                <div class="text-lg font-bold">📞 100</div>
                                <div class="text-xs text-gray-600">~{{ round(100 * $avgCallCost) }}€</div>
                            </button>
                            <button type="button" 
                                    onclick="selectAmount({{ round(500 * $avgCallCost) }}, {{ round(500 * $avgCallCost * 0.15) }})"
                                    class="p-3 bg-green-100 rounded-lg hover:bg-green-200 transition-colors text-center border-2 border-green-300">
                                <div class="text-lg font-bold">📞 500</div>
                                <div class="text-xs text-gray-600">~{{ round(500 * $avgCallCost) }}€</div>
                                <div class="text-xs text-green-600 font-semibold">+15% Bonus!</div>
                            </button>
                            <button type="button" 
                                    onclick="selectAmount({{ round(1000 * $avgCallCost) }}, {{ round(1000 * $avgCallCost * 0.15) }})"
                                    class="p-3 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors text-center">
                                <div class="text-lg font-bold">📞 1000</div>
                                <div class="text-xs text-gray-600">~{{ round(1000 * $avgCallCost) }}€</div>
                            </button>
                        </div>
                    </div>
                @endif
                
                @if($recommendedAmount && $avgDailyUsage > 0)
                    <div class="bg-blue-50 text-blue-800 px-4 py-3 rounded-lg mb-4 text-sm">
                        <p class="font-medium">💡 Unsere Empfehlung:</p>
                        @if($recommendedAmount == 500)
                            <p>Zahlen Sie <strong>{{ $recommendedAmount }}€</strong> und wir <strong>schenken Ihnen 75€ Guthaben dazu!</strong></p>
                            <p class="text-xs mt-1">Sie erhalten insgesamt 575€ Guthaben - das reicht für ca. {{ round(575 / ($avgDailyUsage * 30), 1) }} Monate.</p>
                        @else
                            <p>Mit {{ $recommendedAmount }}€ sind Sie für ca. {{ round(($recommendedAmount * 1.1) / ($avgDailyUsage * 30), 1) }} Monate versorgt.</p>
                        @endif
                    </div>
                @endif
                
                @if($lastTopup && $lastTopup->created_at->diffInDays(now()) <= 90)
                    <!-- Letzte Aufladung wiederholen -->
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-purple-900">🔄 Letzte Aufladung wiederholen</p>
                                <p class="text-xs text-purple-700">
                                    {{ number_format($lastTopup->amount, 2, ',', '.') }}€ 
                                    ({{ $lastTopup->created_at->format('d.m.Y') }})
                                    @if($lastTopup->bonus_amount > 0)
                                        <span class="text-green-600">+{{ number_format($lastTopup->bonus_amount, 2, ',', '.') }}€ Bonus</span>
                                    @endif
                                </p>
                            </div>
                            <button type="button" 
                                    onclick="selectAmount({{ $lastTopup->amount }}, {{ $lastTopup->bonus_amount ?? 0 }})"
                                    class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm font-semibold">
                                Erneut aufladen
                            </button>
                        </div>
                    </div>
                @endif
                
                <!-- Quick Amount Selection -->
                <div class="grid grid-cols-2 gap-3 mb-4">
                    @foreach($suggestedAmounts as $suggestion)
                        <button type="button" 
                                onclick="selectAmount({{ $suggestion['amount'] }}, {{ $suggestion['bonus'] }})"
                                class="amount-card relative p-4 border-2 rounded-xl transition-all 
                                       {{ $suggestion['is_recommended'] ? 'border-green-500 bg-green-50' : 'border-gray-200 bg-white' }}
                                       hover:border-blue-500 hover:shadow-md">
                            
                            @if($suggestion['is_recommended'])
                                <span class="absolute -top-2 -right-2 bg-green-500 text-white text-xs px-2 py-1 rounded-full shadow-sm">
                                    Empfohlen
                                </span>
                            @endif
                            
                            @if($suggestion['bonus_percentage'] >= 15)
                                <span class="absolute -top-2 -left-2 bg-green-500 text-white text-xs px-2 py-1 rounded-full bonus-highlight shadow-sm">
                                    MAX +{{ $suggestion['bonus_percentage'] }}%
                                </span>
                            @elseif($suggestion['bonus_percentage'] >= 10)
                                <span class="absolute -top-2 -left-2 bg-orange-500 text-white text-xs px-2 py-1 rounded-full bonus-highlight shadow-sm">
                                    +{{ $suggestion['bonus_percentage'] }}%
                                </span>
                            @endif
                            
                            <div class="text-2xl font-bold text-gray-900">{{ $suggestion['amount'] }}€</div>
                            
                            @if($suggestion['bonus'] > 0)
                                <div class="text-sm {{ $suggestion['bonus_percentage'] >= 15 ? 'text-green-600' : 'text-orange-600' }} mt-1 font-semibold">
                                    +{{ number_format($suggestion['bonus'], 2, ',', '.') }}€ geschenkt
                                </div>
                                <div class="text-xs text-gray-600 mt-1">
                                    Gesamt: {{ number_format($suggestion['total'], 2, ',', '.') }}€
                                </div>
                            @else
                                <div class="text-xs text-gray-500 mt-2">
                                    Kein Bonus
                                </div>
                            @endif
                        </button>
                    @endforeach
                </div>
                
                <!-- Custom Amount -->
                <div class="relative">
                    <label for="amount" class="block text-sm font-medium text-gray-700 mb-2">
                        Oder eigenen Betrag eingeben:
                    </label>
                    <div class="relative">
                        <input id="amount" name="amount" type="number" step="0.01" min="10" max="10000" required 
                               value="{{ $presetAmount ?? '' }}"
                               oninput="updateCustomBonus(this.value); updateSavingsCalculator(this.value)"
                               class="w-full px-4 py-3 pr-12 text-lg border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                               placeholder="100,00">
                        <span class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-500 text-lg">€</span>
                    </div>
                    <div id="customBonusDisplay" class="mt-2 text-sm text-green-600" style="display: none;">
                        <span id="customBonusText"></span>
                    </div>
                </div>
            </div>

            <!-- Spar-Rechner prominent -->
            <div id="savingsCalculator" class="bg-gradient-to-r from-gray-50 to-blue-50 rounded-xl p-6 mb-6 border-2 border-gray-200 transition-all duration-300">
                <h3 class="font-bold text-lg text-gray-900 mb-3 flex items-center">
                    <span class="text-2xl mr-2" id="calculatorIcon">💰</span>
                    <span id="calculatorTitle">Wählen Sie einen Betrag</span>
                </h3>
                <div class="grid grid-cols-1 gap-3">
                    <div class="bg-white rounded-lg p-4 shadow-sm">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-gray-700">Sie zahlen nur:</span>
                            <span class="font-bold text-xl" id="amountDisplay">0€</span>
                        </div>
                        <div class="flex justify-between items-center text-green-600" id="bonusRow">
                            <span id="bonusLabel">🎁 Geschenktes Guthaben:</span>
                            <span class="font-bold text-xl" id="bonusDisplay">+0€</span>
                        </div>
                        <div class="border-t pt-2 mt-2 flex justify-between items-center">
                            <span class="font-semibold">Sie erhalten insgesamt:</span>
                            <span class="font-bold text-2xl text-green-600" id="totalDisplay">0€</span>
                        </div>
                    </div>
                    @if($avgCallCost > 0)
                        <div class="text-center text-sm text-gray-700 bg-green-100 rounded-lg p-3">
                            <strong id="callsDisplay">Das sind ~0 Anrufe!</strong><br>
                            <span class="text-xs" id="savingsDisplay"></span>
                        </div>
                    @endif
                    <div class="bg-blue-50 rounded-lg p-4 border border-blue-200" id="stepByStepBox" style="display: none;">
                        <h4 class="font-semibold text-sm text-blue-900 mb-2">💡 So funktioniert's:</h4>
                        <div class="space-y-2 text-xs text-blue-800">
                            <div class="flex items-start">
                                <span class="mr-2 text-blue-600">▶</span>
                                <span>Sie zahlen jetzt: <strong id="payAmount" class="text-blue-900">0€</strong></span>
                            </div>
                            <div class="flex items-start">
                                <span class="mr-2 text-green-600">▶</span>
                                <span>Wir schenken Ihnen: <strong id="bonusAmount" class="text-green-700">0€</strong></span>
                            </div>
                            <div class="flex items-start">
                                <span class="mr-2 text-purple-600">▶</span>
                                <span>Ihr Guthaben danach: <strong id="totalAmount" class="text-purple-700">0€</strong></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bonus Information (neu strukturiert) -->
            <div class="bg-gradient-to-r from-gray-50 to-blue-50 rounded-xl p-5 mb-6 border border-gray-200">
                <h4 class="font-bold text-gray-900 mb-3 text-base flex items-center">
                    <span class="text-xl mr-2">💰</span>
                    Bonus-Staffel: Je mehr Sie aufladen, desto mehr schenken wir dazu!
                </h4>
                <div class="space-y-2">
                    <!-- Ohne Bonus -->
                    <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200">
                        <div class="flex items-center">
                            <span class="text-gray-400 mr-3">○</span>
                            <span class="text-gray-700">Aufladung unter 100€</span>
                        </div>
                        <span class="text-gray-500 font-medium">Kein Bonus</span>
                    </div>
                    
                    <!-- 10% Bonus -->
                    <div class="flex items-center justify-between p-3 bg-orange-50 rounded-lg border border-orange-200">
                        <div class="flex items-center">
                            <span class="text-orange-500 mr-3 text-lg">★</span>
                            <span class="text-gray-700 font-medium">Aufladung 100€ - 499€</span>
                        </div>
                        <div class="text-orange-600 font-bold">
                            <span class="text-lg">+10%</span>
                            <span class="text-sm font-normal ml-1">Bonus</span>
                        </div>
                    </div>
                    
                    <!-- 15% Bonus -->
                    <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg border border-green-300 shadow-sm">
                        <div class="flex items-center">
                            <span class="text-green-500 mr-3 text-lg">★★</span>
                            <span class="text-gray-700 font-medium">Aufladung ab 500€</span>
                        </div>
                        <div class="text-green-600 font-bold flex items-center">
                            <span class="text-lg">+15%</span>
                            <span class="text-sm font-normal ml-1">Bonus</span>
                            <span class="ml-2">🎁</span>
                        </div>
                    </div>
                </div>
                
                <!-- Beispielrechnung -->
                <div class="mt-3 pt-3 border-t border-gray-200">
                    <p class="text-xs text-gray-600">
                        <strong>Beispiel:</strong> Bei 500€ Aufladung erhalten Sie 75€ geschenkt = 575€ Gesamtguthaben!
                    </p>
                </div>
            </div>

            <!-- Submit Button with Payment Amount -->
            <div class="space-y-3">
                <button type="submit" 
                        class="touch-button w-full bg-blue-600 text-white font-semibold rounded-xl shadow-lg hover:bg-blue-700 active:bg-blue-800 transition-colors relative">
                    <span class="block">Zur sicheren Zahlung →</span>
                    <span class="block text-sm font-normal" id="paymentAmountDisplay">Sie zahlen jetzt: 0€</span>
                </button>
                
                <!-- Important Notice about Bonus -->
                <div class="bg-gray-100 rounded-lg p-3 text-xs text-gray-600">
                    <p class="font-semibold mb-1">💡 Wichtige Hinweise zum Bonus:</p>
                    <ul class="space-y-1 text-left">
                        <li>• Das geschenkte Guthaben wird Ihrem Konto nach der Zahlung gutgeschrieben</li>
                        <li>• Bei Anrufen wird zuerst Ihr eingezahltes Guthaben verbraucht, dann der Bonus</li>
                        <li>• <strong>Auszahlungen sind nur für eingezahlte Beträge möglich</strong> (Bonus verfällt bei Auszahlung)</li>
                    </ul>
                </div>
            </div>
        </form>

        <!-- Trust Elements -->
        <div class="mt-6 text-center text-sm text-gray-500">
            <p class="mb-2">Sie werden zu Stripe weitergeleitet</p>
            <div class="flex items-center justify-center space-x-4">
                <img src="https://cdn.brandfolder.io/KGT2DTA4/at/8vbr8k4mr5xjwk4hxq4t9vs/Stripe_wordmark_-_blurple.svg" 
                     alt="Stripe" class="h-6">
                <span class="text-gray-400">•</span>
                <span>SSL verschlüsselt</span>
                <span class="text-gray-400">•</span>
                <span>PCI-DSS konform</span>
            </div>
        </div>
    </div>

    <script>
        // Store average call cost for calculations
        const avgCallCost = {{ $avgCallCost ?? 0 }};
        
        // Amount selection
        function selectAmount(amount, bonus) {
            document.getElementById('amount').value = amount;
            highlightSelectedAmount(amount);
            updateCustomBonus(amount);
            updateSavingsCalculator(amount);
        }
        
        // Highlight selected amount card
        function highlightSelectedAmount(amount) {
            document.querySelectorAll('.amount-card').forEach(card => {
                card.classList.remove('border-blue-500', 'bg-blue-50');
                card.classList.add('border-gray-200', 'bg-white');
            });
            
            // Find and highlight the selected card
            const selectedCard = Array.from(document.querySelectorAll('.amount-card')).find(card => 
                card.textContent.includes(amount + '€')
            );
            
            if (selectedCard) {
                selectedCard.classList.remove('border-gray-200', 'bg-white');
                selectedCard.classList.add('border-blue-500', 'bg-blue-50');
            }
        }
        
        // Update custom bonus display
        function updateCustomBonus(amount) {
            const bonusDisplay = document.getElementById('customBonusDisplay');
            const bonusText = document.getElementById('customBonusText');
            
            if (!amount || amount < 10) {
                bonusDisplay.style.display = 'none';
                return;
            }
            
            // Klare Bonus-Berechnung basierend auf Betragsbereichen
            let bonusPercentage = 0;
            let bonusAmount = 0;
            
            if (amount >= 500) {
                bonusPercentage = 15;
            } else if (amount >= 100) {
                bonusPercentage = 10;
            } else {
                bonusPercentage = 0;
            }
            
            if (bonusPercentage > 0) {
                bonusAmount = (amount * bonusPercentage / 100).toFixed(2);
                if (bonusPercentage === 15) {
                    bonusText.textContent = `🎉 Maximaler Bonus! Sie erhalten ${bonusPercentage}% geschenkt (+${bonusAmount}€)`;
                    bonusDisplay.className = 'mt-2 text-sm text-green-600 font-semibold';
                } else {
                    bonusText.textContent = `🎁 Sie erhalten ${bonusPercentage}% Bonus geschenkt (+${bonusAmount}€)`;
                    bonusDisplay.className = 'mt-2 text-sm text-orange-600 font-semibold';
                }
                bonusDisplay.style.display = 'block';
                bonusDisplay.classList.add('bonus-highlight');
                setTimeout(() => bonusDisplay.classList.remove('bonus-highlight'), 500);
            } else if (amount >= 10 && amount < 100) {
                bonusText.textContent = `💡 Ab 100€ erhalten Sie 10% Bonus geschenkt!`;
                bonusDisplay.className = 'mt-2 text-sm text-gray-600';
                bonusDisplay.style.display = 'block';
            } else {
                bonusDisplay.style.display = 'none';
            }
        }
        
        // Update savings calculator
        function updateSavingsCalculator(amount) {
            const amountNum = parseFloat(amount) || 0;
            
            // Calculate bonus
            let bonusPercentage = 0;
            let bonusAmount = 0;
            
            // Klare Bonus-Staffelung
            if (amountNum >= 500) {
                bonusPercentage = 15;
            } else if (amountNum >= 100) {
                bonusPercentage = 10;
            } else {
                bonusPercentage = 0;
            }
            
            bonusAmount = amountNum * (bonusPercentage / 100);
            const total = amountNum + bonusAmount;
            
            // Update displays
            document.getElementById('amountDisplay').textContent = amountNum.toFixed(2).replace('.', ',') + '€';
            document.getElementById('bonusDisplay').textContent = '+' + bonusAmount.toFixed(2).replace('.', ',') + '€';
            document.getElementById('totalDisplay').textContent = total.toFixed(2).replace('.', ',') + '€';
            
            // Update payment button display
            document.getElementById('paymentAmountDisplay').textContent = 
                amountNum > 0 ? `Sie zahlen jetzt: ${amountNum.toFixed(2).replace('.', ',')}€` : 'Sie zahlen jetzt: 0€';
            
            // Update step-by-step display
            const stepByStepBox = document.getElementById('stepByStepBox');
            if (amountNum >= 10) {
                stepByStepBox.style.display = 'block';
                document.getElementById('payAmount').textContent = amountNum.toFixed(2).replace('.', ',') + '€';
                document.getElementById('bonusAmount').textContent = bonusAmount.toFixed(2).replace('.', ',') + '€';
                document.getElementById('totalAmount').textContent = total.toFixed(2).replace('.', ',') + '€';
            } else {
                stepByStepBox.style.display = 'none';
            }
            
            // Update bonus label with percentage and adjust title
            const calculatorTitle = document.getElementById('calculatorTitle');
            const calculatorIcon = document.getElementById('calculatorIcon');
            const calculator = document.getElementById('savingsCalculator');
            
            if (bonusPercentage > 0) {
                document.getElementById('bonusLabel').textContent = `🎁 Geschenkt (${bonusPercentage}%):`;
                document.getElementById('bonusRow').style.display = 'flex';
                
                // Update title based on bonus
                if (bonusPercentage === 15) {
                    calculatorTitle.textContent = 'Maximaler Bonus! Wir schenken Ihnen 15%!';
                    calculatorIcon.textContent = '🎉';
                    calculator.classList.remove('from-yellow-50', 'to-orange-50', 'border-yellow-200');
                    calculator.classList.add('from-green-50', 'to-emerald-50', 'border-green-200');
                } else if (bonusPercentage === 10) {
                    calculatorTitle.textContent = 'Super! Wir schenken Ihnen 10%!';
                    calculatorIcon.textContent = '🎁';
                    calculator.classList.remove('from-green-50', 'to-emerald-50', 'border-green-200');
                    calculator.classList.add('from-yellow-50', 'to-orange-50', 'border-yellow-200');
                }
            } else {
                document.getElementById('bonusRow').style.display = 'none';
                calculatorTitle.textContent = amountNum >= 10 ? 'Leider kein Bonus unter 100€' : 'Wählen Sie einen Betrag';
                calculatorIcon.textContent = amountNum >= 10 ? '💡' : '💰';
                calculator.classList.remove('from-green-50', 'to-emerald-50', 'border-green-200', 'from-yellow-50', 'to-orange-50', 'border-yellow-200');
                calculator.classList.add('from-gray-50', 'to-blue-50', 'border-gray-200');
            }
            
            // Update calls display
            if (avgCallCost > 0) {
                const calls = Math.floor(total / avgCallCost);
                document.getElementById('callsDisplay').textContent = `Das sind ~${calls} Anrufe!`;
                
                // Calculate savings vs multiple 100€ topups
                if (amountNum >= 500) {
                    const compareAmount = Math.ceil(amountNum / 100) * 100;
                    const compareBonus = compareAmount * 0.1; // 10% on 100€ chunks
                    const savings = (amountNum * 0.15) - compareBonus;
                    document.getElementById('savingsDisplay').textContent = 
                        `Sie sparen ${savings.toFixed(0)}€ gegenüber ${Math.ceil(amountNum/100)}x 100€ Aufladungen`;
                } else {
                    document.getElementById('savingsDisplay').textContent = '';
                }
            }
            
            // Update calculator border color based on bonus - remove this old code
        }
        
        // Set preset amount if available
        @if($presetAmount)
            selectAmount({{ $presetAmount }}, {{ $presetBonus }});
        @else
            // Initialize with default (e.g., 500€ for best value)
            window.addEventListener('load', function() {
                selectAmount(500, 75);
            });
        @endif
        
        // Form validation
        document.getElementById('topupForm').addEventListener('submit', function(e) {
            const amount = parseFloat(document.getElementById('amount').value);
            if (amount < 10 || amount > 10000) {
                e.preventDefault();
                alert('Bitte geben Sie einen Betrag zwischen 10€ und 10.000€ ein.');
            }
        });
    </script>
</body>
</html>
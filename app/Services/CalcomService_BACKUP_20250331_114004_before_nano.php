PD9waHAKCk5hbWVzcGFjZSBBcHBcU2VydmljZXM7Cgp1c2UgSWxsdW1pbmF0ZVxTdXBwb3J0XEZhY2FkZXNcSHR0cDsKdXNlIElsbHVtaW5hdGVcU3VwcG9ydFxGYWNhZGVzXExvZzsKdXNlIElsbHVtaW5hdGVcSHR0cFxDbGllbnRcUmVxdWVzdEV4Y2VwdGlvbjsKdXNlIENhcmJvblxDYXJib247IC8vIENhcmJvbiBmw7xyIERhdHVtcy0vWmVpdG1hbmlwdWxhdGlvbiBoaW56ZWdlaMO8Z3QKdXNlIFRocm93YWJsZTsgLy8gVGhyb3dhYmxlIGltcG9ydGllcmVuCgpjbGFzcyBDYWxjb21TZXJ2aWNlCnsKICAgIHByb3RlY3RlZCAkYmFzZVVybDsKICAgIHByb3RlY3RlZCAkYXBpS2V5OwogICAgcHJvdGVjdGVkICR0aW1lWm9uZTsKICAgIHByb3RlY3RlZCAkbGFuZ3VhZ2U7CiAgICBwdWJsaWMgJGxhc3RFcnJvciA9IG51bGw7CiAgICAvLyBGZXN0ZSBVc2VySUQgZsO8ciBDYWwuY29tIEFQSSBBdWZydWZlIChhdXMgRG9rdW1lbnRhdGlvbikKICAgIHByb3RlY3RlZCAkY2FsY29tVXNlcklkID0gMTM0NjQwODsKCiAgICBwdWJsaWMgZnVuY3Rpb24gX19jb25zdHJ1Y3QoKQogICAgewogICAgICAgICR0aGlzLT5iYXNlVXJsID0gY29uZmlnKCdzZXJ2aWNlcy5jYWxjb20uYmFzZV91cmwnLCAnaHR0cHM6Ly9hcGkuY2FsLmNvbS92MScpOwogICAgICAgICR0aGlzLT5hcGlLZXkgPSBjb25maWcoJ3NlcnZpY2VzLmNhbGNvbS5hcGlfa2V5JywgZW52KCdDQUxDT01fQVBJX0tFWScpKTsKICAgICAgICAkdGhpcy0+dGltZVpvbmUgPSBjb25maWcoJ2FwcC50aW1lem9uZScsICdFdXJvcGUvQmVybGluJyk7CiAgICAgICAgJHRoaXMtPmxhbmd1YWdlID0gY29uZmlnKCdhcHAubG9jYWxlJywgJ2RlJyk7CgogICAgICAgIGlmIChlbXB0eSgkdGhpcy0+YXBpS2V5KSkgewogICAgICAgICAgICBMb2c6OmVycm9yKCdDYWwuY29tIEFQSSBLZXkgbmljaHQga29uZmlndXJpZXJ0IScpOwogICAgICAgIH0KICAgICAgICAgaWYgKGVtcHR5KCR0aGlzLT5iYXNlVXJsKSkgewogICAgICAgICAgICBMb2c6OmVycm9yKCdDYWwuY29tIEJhc2UgVVJMIG5pY2h0IGtvbmZpZ3VyaWVydCEhJyk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUHLDvGZ0IGRpZSBWZXJmw7xnYmFya2VpdCBmw7xyIGVpbmVuIGJlc3RpbW10ZW4gRXZlbnQtVHlwIHVuZCBaaXRyYXVtLgogICAgICovCiAgICBwdWJsaWMgZnVuY3Rpb24gY2hlY2tBdmFpbGFiaWxpdHkoYXJyYXkgJGRhdGEpCiAgICB7CiAgICAgICAgJHRoaXMtPmxhc3RFcnJvciA9IG51bGw7CiAgICAgICAgJG1heFJldHJpZXMgPSAzOwogICAgICAgICRyZXRyeURlbGF5ID0gNTAwOwogCiAgICAgICAgIC8vIEZcdTAwZmNnZSB1c2VySWQgendiIEFuZnJhZ2UgaGluenUsIHdlbm4gbmljaHQgdm9yaGFuZGVuIChmYWxscyAndXNlcm5hbWUnIG5pY2h0IHJlaWNodCkKICAgICAgICAkcGFyYW1zID0gYXJyYXlfbWVyZ2UoJGRhdGEsIFsKICAgICAgICAgICAgJ2FwaUtleScgPT4gJHRoaXMtPmFwaUtleSwKICAgICAgICAgICAgJ3RpbWVab25lJyA9PiAkdGhpcy0+dGltZVpvbmUsCiAgICAgICAgICAgICd1c2VySWQnID0+ICR0aGlzLT5jYWxjb21Vc2VySWQgLy8gRmVzdGUgVXNlcklEIGhpbnplZlx1MDBmY2d0ZW4KICAgICAgICBdKTsKICAgICAgICAgLy8gRW50ZmVybmUgJ3VzZXJuYW1lJywgd2VubiB1c2VySWQgdm9yaGFuZGVuIGlzdCwgZGFtaXQgQ2FsLmNvbSBuZSB3ZWnDnwoKICAgICAgICAvLyB1bnNldCgkcGFyYW1zWyd1c2VybmFtZSddKTsKICAgICAgICAvLyBUYlBsYXRzaGFsdGVyOiBQcm9kdWt0aW9uOiBVbnNldCBhdXNrbyBtZW50aWVydCwgd2VubCB1cyBzdWJtaXR0ZWQKCiAgICAgICAgaWYgKGVtcHR5KCRwYXJhbXNbJ2V2ZW50VHlwZUlkJ10pIHx8IGVtcHR5KCRwYXJhbXNbJ2RhdGVGcm9tJ10pIHx8IGVtcHR5KCRwYXJhbXNbJ2RhdGVUbyddKSkgewogICAgICAgICAgICAgTG9nOjplcnJvcignVW52b2xsc3TDpG5kaWdlIERhdGVuIGbDvHIgY2hlY2tBdmFpbGFiaWxpdHknLCBbJ3BhcmFtcycgPT4gJHBhcmFtcykpOwogICAgICAgICAgICAgJHRoaXMtPmxhc3RFcnJvciA9ICdVbnZvbGxzdMOkbmRpZ2UgRGF0ZW4gZsO8ciBWZXJmw7xnYmFya2VpdHNwcsO8ZnVuZy4nOwogICAgICAgICAgICAgdGhyb3cgbmV3IFxpbnZhbGlkQXJndW1lbnRFeGNlcHRpb24oJHRoaXMtPmxhc3RFcnJvcik7CiAgICAgICAgfQoKICAgICAgICBmb3IgKCRhdHRlbXB0ID0gMTsgJGF0dGVtcHQgPD0gJG1heFJldHJpZXM7ICRhdHRlbXB0KyspIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIC8vIEVudGZlcm5lIGFwaUtleSBhdXMgZGVuIFBhcmFtZXRlcm4gZsO8ciBkZW4gR0VULVJlcXVlc3QsIGRhIGVyIGluIGRlciBVUkggaXN0CiAgICAgICAgICAgICAgICAkcmVxdWVzdFBhcmFtcyA9ICRwYXJhbXM7CiAgICAgICAgICAgICAgICB1bnNldCgkcmVxdWVzdFBhcmFtc1snYXBpS2V5J10pOwoKICAgICAgICAgICAgICAgICR1cmwgPSAiJHskdGhpcy0+YmFzZVVybH0vYXZhaWxhYmlsaXR5P2FwaUtleT0keyR0aGlzLT5hcGlLZXl9IjsKCiAgICAgICAgICAgICAgICAkcmVzcG9uc2UgPSBIdHRwOjphY2NlcHRKc29uKCktPmdldCgkdXJsLCAkcmVxdWVzdFBhcmFtcyk7CgogICAgICAgICAgICAgICAgTG9nOjpkZWJ1ZygnQ2FsLmNvbSBjaGVja0F2YWlsYWJpbGl0eSBhbnR3b3J0JywgWwogICAgICAgICAgICAgICAgICAgICdhdHRlbXB0JyA9PiAkYXR0ZW1wdCwKICAgICAgICAgICAgICAgICAgICAnc3RhdHVzJyA9PiAkcmVzcG9uc2UtPnN0YXR1cygpLAogICAgICAgICAgICAgICAgICAgICd1cmwnID0+ICR1cmwsCiAgICAgICAgICAgICAgICAgICAgJ3BhcmFtc19zZW50JyA9PiAkcmVxdWVzdFBhcmFtcywKICAgICAgICAgICAgICAgICAgICAncmVzcG9uc2VfYm9keScgPT4gJHJlc3BvbnNlLT5ib2R5KCkKICAgICAgICAgICAgICAgIF0pOwoKICAgICAgICAgICAgICAgIGlmICgkcmVzcG9uc2UtPnN1Y2Nlc3NmdWwoKSkgewogICAgICAgICAgICAgICAgICAgTG9nOjppbmZvKCfwn5SFIO+4jyBDYWwuY29tIFZlcmZcdTAwZmNiYXJrZWl0c3ByXHUwMGZmdnVuZyBlcmZvbGdyZWljaCcsIFsncmVzcG9uc2VfYm9keScgPT4gJHJlc3BvbnNlLT5qc29uKCldKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHJlc3BvbnNlLT5qc29uKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgTG9nOjptYXJuaW5nKCfwn5SSIO+4jyBWZXJzdWNoIGZlaGxnZXNjaGxhZ2VuIGJlaSBDYWwuY29tIFZlcmZcdTAwZmNiYXJrZWl0c3ByXHUwMGZmdnVuZycsIFsKICAgICAgICAgICAgICAgICAgICAnYXR0ZW1wdCcgPT4gJGF0dGVtcHQsCiAgICAgICAgICAgICAgICAgICAgJ3N0YXR1cycgPT4gJHJlc3BvbnNlLT5zdGF0dXMoKSwKICAgICAgICAgICAgICAgICAgICAncmVzcG9uc2VfYm9keScgPT4gJHJlc3BvbnNlLT5ib2R5KCkKICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICAgICAgJHRoaXMtPmxhc3RFcnJvciA9ICJDYWwuY29tIEFQSSBGZWhsZXIgKFN0YXR1cyB7JHJlc3BvbnNlLT5zdGF0dXMoKX0pOiAiIC4gJHJlc3BvbnNlLT5ib2R5KCk7CgogICAgICAgICAgICAgICAgLy8gU3BlemlmaXNjaGUgRmVobGVyY29kZXMgYmVoYW5kZWxuPwogICAgICAgICAgICAgICAgIC8vIHouQi4gNDA0IE5vdCBGb3VuZCBvZGVyIDQwMCBCYWQgUmVxdWVzdAoKICAgICAgICAgICAgfSBjYXRjaCAoUmVxdWVzdEV4Y2VwdGlvbiAkZSkgewogICAgICAgICAgICAgICAgJHRoaXMtPmxhc3RFcnJvciA9ICdSZXF1ZXN0RXhjZXB0aW9uIGJlaSBDYWwuY29tIFZlcmZcdTAwZmNiYXJrZWl0c3ByXHUwMGZmdnVuZzogJyAuICRlLT5nZXRNZXNzYWdlKCk7CiAgICAgICAgICAgICAgICBMb2c6OmVycm9yKCfinaQgJyAuICR0aGlzLT5sYXN0RXJyb3IsIFsKICAgICAgICAgICAgICAgICAgICAnYXR0ZW1wdCcgPT4gJGF0dGVtcHQsCiAgICAgICAgICAgICAgICAgICAgJ3VybCcgPT4gJHVybCA/PyBudWxsLAogICAgICAgICAgICAgICAgICAgICdwYXJhbXMnID0+ICRwYXJhbXM7CiAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgfSBjYXRjaCAoVGhyb3dhYmxlICRlKSB7CiAgICAgICAgICAgICAgICAkdGhpcy0+bGFzdEVycm9yID0gJ1VuZXJ3YXJ0ZXRlciBGZWhsZXIgYmVpIENhbC5jb20gVmVyZlx1MDBmY2JhcmhlaXRzcHJcdTAwZmZmdW5nOiAnIC4gJGUtPmdldE1lc3NhZ2UoKTsKICAgICAgICAgICAgICAgIExvZzo6ZXJyb3IoJ+KdpCAgJyAuICR0aGlzLT5sYXN0RXJyb3IsIFsKICAgICAgICAgICAgICAgICAgICAnYXR0ZW1wdCcgPT4gJGF0dGVtcHQ7CiAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgICAgIHRocm93ICRlOyAvLyBXZWl0ZXJ3ZXJmZW4KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCRhdHRlbXB0IDwgJG1heFJldHJpZXMpIHsKICAgICAgICAgICAgICAgIHVzbGVlcCgkcmV0cnlEZWxheSAqIDEwMDAgKiBwb3coMiwgJGF0dGVtcHQgLSAxKSk7IC8vIEV4cG9uZW50aWVsbGVyIEJhY2tvZmYKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgJGZpbmFsRXJyb3JNc2cgPSAnQ2FsLmNvbSBWZXJmw7xnYmFya2VpdHNwcsO8ZnVuZyBlbmRnw7xsdGlnIGZlaGxnZXNjaGxhZ2VuIG5hY2ggJyAuICRtYXhSZXRyaWVzIC4gJyBWZXJzdWNoZW4uIExldHp0ZXIgRmVobGVyOiAnIC4gJHRoaXMtPmxhc3RFcnJvcjsKICAgICAgICBMb2c6OmVycm9yKCfinaQgJyAuICRmaW5hbEVycm9yTXNnKTsKICAgICAgICB0aHJvdyBuZXcgXEV4Y2VwdGlvbigkZmluYWxFcnJvck1zZyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBIb2x0IERldGFpbHMgencgZWluZW0gRXZlbnQtVHlwIHZvbiBDYWwuY29tLgogICAgICovCiAgICBwdWJsaWMgZnVuY3Rpb24gZ2V0RXZlbnRUeXBlRGV0YWlscygkZXZlbnRUeXBlSWQpCiAgICB7CiAgICAgICAgJHRoaXMtPmxhc3RFcnJvciA9IG51bGw7CiAgICAgICAgaWYgKGVtcHR5KCRldmVudFR5cGVJZCkpIHsKICAgICAgICAgICAgTG9nOjptYXJuaW5nKCdLZWluZSBFdmVudFR5cGVJZCBmw7xyIGdldEV2ZW50VHlwZURldGFpbHMgYW5nZWdlYmVuLicpOwogICAgICAgICAgICByZXR1cm4gWyJsZW5ndGgnID0+IDMwXTsKICAgICAgICB9CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgICR1cmwgPSAiJHskdGhpcy0+YmFzZVVybH0vZXZlbnQtdHlwZXMveyRldmVudFR5cGVJZH0/YXBpS2V5PSR7JHRoaXMtPmFwaUtleX0iOwogICAgICAgICAgICAkcmVzcG9uc2UgPSBIdHRwOjpnZXQoJHVybCk7CgogICAgICAgICAgICBMb2c6OmRlYnVnKCdDYWwuY29tIGdldEV2ZW50VHlwZURldGFpbHMgQW50d29ydCcsIFsKICAgICAgICAgICAgICAgICdldmVudFR5cGVJZCcgPT4gJGV2ZW50VHlwZUlkLAogICAgICAgICAgICAgICAgJ3N0YXR1cycgPT4gJHJlc3BvbnNlLT5zdGF0dXMoKSwKICAgICAgICAgICAgICAgICdyZXNwb25zZV9ib2R5JyA9PiAkcmVzcG9uc2UtPmJvZHkoKQogICAgICAgICAgICBdKTsKCiAgICAgICAgICAgIGlmICgkcmVzcG9uc2UtPnN1Y2Nlc3NmdWwoKSAmJiBpc3NldCgkcmVzcG9uc2UtPmpzb24oKVsjZXZlbnRUeXBlJ10pKSB7CiAgICAgICAgICAgICAgICBMb2c6OmluZm8oJ/CfkoQg77iPIENhbC5jb20gRXZlbnQtVHlwLURldGFpbHMgZXJmb2xncmVpY2ggYWJnZXJ1ZmVuLicsIFsnZXZlbnRUeXBlSWQnID0+ICRldmVudFR5cGVJZCwgJ2xlbmd0aCcgPT4gJHJlc3BvbnNlLT5qc29uKCdbJ2V2ZW50VHlwZSddWydsZW5ndGgnXSA/PyAndW5iZWthbm50J10pOwogICAgICAgICAgICAgICAgcmV0dXJuICRyZXNwb25zZS0+anNvbigpWyJldmVudFR5cGUiXTsKICAgICAgICAgICAgfQogICAgICAgICAgICAgaWYgKCRyZXNwb25zZS0+c3VjY2Vzc2Z1bCgpKSB7CiAgICAgICAgICAgICAgICAvLyBFcmZvbGcsIGFiczIggJ2V2ZW50VHlwZScgZmVobHQgaW5kZXIgQW50d29ydD8gU2VsdHNhbS4KICAgICAgICAgICAgICAgIExvZzo6d2FybmluZygnIPCfjKcg77iPIENhbC5jb20gRXZlbnQtVHlwLURldGFpbHM6IEVyZm9sZ3JlaWNoZSBBbnR3b3J0LCBhYmVyICJldmVudFR5cGUiLVNjaGzDvHNzZWwgZmVobHQuJywgWyJldmVudFR5cGVJZCIgPT4gJGV2ZW50VHlwZUlkLCJyZXNwb25zZV9ib2R5IiA9PiAkcmVzcG9uc2UtPmJvZHkoKddpOwogICAgICAgICAgICAgICAgJHRoaXMtPmxhc3RFcnJvciA9ICJDYWwuY29tIEV2ZW50LVR5cC1EZXRhaWxzOiBVbmdcdTAwZmNsdGlnZSBBbnR3b3J0c3RydWt0dXIuJzsKICAgICAgICAgICAgICAgIHJldHVybiBbJ2xlbmd0aCcgPT4gMzBdOyAvLyBGbGxidWNrCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICR0aGlzLT5sYXN0RXJyb3IgPSAiQ2FsLmNvbSBFdmVudC1UeXAtRGV0YWlscyBBYnJ1ZiBmZWhsZ2VzY2hsYWdlbiAoU3RhdHVzIHskcmVzcG9uc2UtPnN0YXR1cygpfSk6ICIgLiAkcmVzcG9uc2UtPmJvZHkoKTsKICAgICAgICAgICAgTG9nOjptYXJuaW5nKCfwn5SSIO+4jyAnIC4gJHRoaXMtPmxhc3RFcnJvciwgWyJldmVudFR5cGVJZCIgPT4gJGV2ZW50VHlwZUlkXSk7CgogICAgICAgIH0gY2F0Y2ggKFJlcXVlc3RFeGNlcHRpb24gJGUpIHsKICAgICAgICAgICAgJHRoaXMtPmxhc3RFcnJvciA9ICdSZXF1ZXN0RXhjZXB0aW9uIGJlaSBDYWwuY29tIEV2ZW50LVR5cC1EZXRhaWxzOiAnIC4gJGUtPmdldE1lc3NhZ2UoKTsKICAgICAgICAgICAgTG9nOjplcnJvcign4p2kICcgLiAkdGhpcy0+bGFzdEVycm9yLCBbImV2ZW50VHlwZUlkIiA9PiAkZXZlbnRUeXBlSWQsICJ1cmwiID0+ICR1cmwgPz8gbnVsbF0pOwogICAgICAgIH0gY2F0Y2ggKFRocm93YWJsZSAkZSkgewogICAgICAgICAgICAkdGhpcy0+bGFzdEVycm9yID0gJ1VuZXJ3YXJ0ZXRlciBGZWhsZXIgYmVpIENhbC5jb20gRXZlbnQtVHlwLURldGFpbHM6ICcgLiAkZS0+Z2V0TWVzc2FnZSgpOwogICAgICAgICAgICAgTG9nOjplcnJvcign4p2kICcgLiAkdGhpcy0+bGFzdEVycm9yLCBbImV2ZW50VHlwZUlkIiA9PiAkZXZlbnRUeXBlSWRdKTsKICAgICAgICB9CgogICAgICAgIExvZzo6d2FybmluZygnRmFsbGJhY2s6IFN0YW5kYXJkbMOkbmdlIDMwIE1pbnV0ZW4gd2lyZCB2ZXJ3ZW5kZXQuJywgWyJldmVudFR5cGVJZCIgPT4gJGV2ZW50VHlwZUlkXSk7CiAgICAgICAgcmV0dXJuIFsnbGVuZ3RoJyA9PiAzMF07CiAgICB9CgogICAgLyoqCiAgICAgKiBCdWNodCBlaW5lbiBUZXJtaW4gw7xiZXIgZGllIENhbC5jb20gQVBJLgogICAgICoKICAgICAqIEBwYXJhbSBhcnJheSAkYm9va2luZ0RhdGEgRXJ3YXJ0ZXQgWyBkYXRlJywgJ3RpbWUnLCAnY3VzdG9tZXJOYW1lJywgJ2N1c3RvbWVyRW1haWwnLCAncGhvbmUnXQogICAgICogQHJldHVybiBhcnJheSBbJ3N1Y2Nlc3MnID0+IGJvb2wsICdtZXNzYWdlJyA9PiBzdHJpbmcsICdhcHBvaW50bWVudF9pZCcgPT4gc3RyaW5nfG51bGxdCiAgICAgKiBAY2hpcmVuYmxhY2tzVGhyb3dhYmxlIEJlaSBlbmRnw7xsdGlnZW0gRmVobHNjaGxhZwogICAgICovCiAgICBwdWJsaWMgZnVuY3Rpb24gYm9va0FwcG9pbnRtZW50KGFycmF5ICRib29raW5nRGF0YSkKICAgIHsKICAgICAgICAkdGhpcy0+bGFzdEVycm9yID0gbnVsbDsKICAgICAgICAvLyBUT0RPOiBFdmVudFR5cGVJZCBzb2xsdGUga29uZmlndXJpZXJiYXIgZ2VtYWNodCB3ZXJkZW4KICAgICAgICAkZXZlbnRUeXBlSWQgPSAyMDI2OTAxOyAvLyBGZXN0Z2VsZWd0IGF1ZiAiSGVycmVuIgoKICAgICAgICBpZiAoZW1wdHkoJGJvb2tpbmdEYXRhWydkYXRlJ10pIHx8IGVtcHR5KCRib29raW5nRGF0YVsndGltZSddKSB8fCBlbXB0eSgkYm9va2luZ0RhdGFbJ2N1c3RvbWVyTmFtZSddKSB8fCBlbXB0eSgkYm9va2luZ0RhdGFbJ2N1c3RvbWVyRW1haWwnXSkpIHsKICAgICAgICAgICAgJHRoaXMtPmxhc3RFcnJvciA9ICdVbnZvbGxzdMOkbmRpZ2UgQnVjaHVuZ3NkYXRlbi4nOwogICAgICAgICAgICBMb2c6OmVycm9yKCR0aGlzLT5sYXN0RXJyb3IsIFsnYm9va2luZ0RhdGEnID0+ICRib29raW5nRGF0YV0pOwogICAgICAgICAgICByZXR1cm4gWydzdWNjZXNzJyA9PiBmYWxzZSwgJ21lc3NhZ2UnID0+ICR0aGlzLT5sYXN0RXJyb3IsICdhcHBvaW50bWVudF9pZCcgPT4gbnVsbF07CiAgICAgICAgfQoKICAgICAgICB0cnkgewogICAgICAgICAgICAvLyBLT1JSRUtUVVI6IERhdWVyIHdpZWRlciBkeW5hbWlzY2ggdmVyd2VuZGVuCiAgICAgICAgICAgICRldmVudFR5cGVEZXRhaWxzID0gJHRoaXMtPmdldEV2ZW50VHlwZURldGFpbHMoJGV2ZW50VHlwZUlkKTsKICAgICAgICAgICAgJGR1cmF0aW9uID0gJGV2ZW50VHlwZURldGFpbHNbJ2xlbmd0aCddID8/IDMwOwogICAgICAgICAgICAvLyBMb2dnZW4gZGVyIGVybWl0dGVsdGVuIERhdWVyCiAgICAgICAgICAgICBMb2c6OmluZm8oJ1ZlcndlbmRlIEV2ZW50LURhdWVyIGbDvHIgQnVjaHVuZy4nLCBbJ2V2ZW50VHlwZUlkJyA9PiAkZXZlbnRUeXBlSWQsICdkdXJhdGlvbicgPT4gJGR1cmF0aW9uXSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAkZXZlbnRUeXBlSWQgPSAyMDI2OTAxOyAvLyBGZXN0Z2VsZWd0IGF1ZiAiSGVycmVuIgoKICAgICAgICBpZiAoZW1wdHkoJGJvb2tpbmdEYXRhWydkYXRlJ10pIHx8IGVtcHR5KCRib29raW5nRGF0YVsndGltZSddKSB8fCBlbXB0eSgkYm9va2luZ0RhdGFbJ2N1c3RvbWVyTmFtZSddKSB8fCBlbXB0eSgkYm9va2luZ0RhdGFbJ2N1c3RvbWVyRW1haWwnXSkpIHsKICAgICAgICAgICAgJHRoaXMtPmxhc3RFcnJvciA9ICdVbnZvbGxzdMOkbmRpZ2UgQnVjaHVuZ3NkYXRlbi4nOwogICAgICAgICAgICBMb2c6OmVycm9yKCR0aGlzLT5sYXN0RXJyb3IsIFsnYm9va2luZ0RhdGEnID0+ICRib29raW5nRGF0YV0pOwogICAgICAgICAgICByZXR1cm4gWydzdWNjZXNzJyA9PiBmYWxzZSwgJ21lc3NhZ2UnID0+ICR0aGlzLT5sYXN0RXJyb3IsICdhcHBvaW50bWVudF9pZCcgPT4gbnVsbF07CiAgICAgICAgfQoKICAgICAgICB0cnkgewogICAgICAgICAgICAvLyBLT1JSRUtUVVI6IERhdWVyIHdpZWRlciBkeW5hbWlzY2ggdmVyd2VuZGVuCiAgICAgICAgICAgICRldmVudFR5cGVEZXRhaWxzID0gJHRoaXMtPmdldEV2ZW50VHlwZURldGFpbHMoJGV2ZW50VHlwZUlkKTsKICAgICAgICAgICAgJGR1cmF0aW9uID0gJGV2ZW50VHlwZURldGFpbHNbJ2xlbmd0aCddID8/IDMwOwogICAgICAgICAgICAvLyBMb2dnZW4gZGVyIGVybWl0dGVsdGVuIERhdWVyCiAgICAgICAgICAgICBMb2c6OmluZm8oJ1ZlcndlbmRlIEV2ZW50LURhdWVyIGbDvHIgQnVjaHVuZy4nLCBbJ2V2ZW50VHlwZUlkJyA9PiAkZXZlbnRUeXBlSWQsICdkdXJhdGlvbicgPT4gJGR1cmF0aW9uXSk7CgogICAgICAgICAgICAkc3RhcnREYXRlVGltZVN0cmluZyA9ICRib29raW5nRGF0YVsjZGF0ZSddIC4gJyAnIC4gJGJvb2tpbmdEYXRhWyd0aW1lJ107CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAkc3RhcnRUaW1lID0gQ2FyYm9uOjpjcmVhdGVGcm9tRm9ybWF0KCdZLWYtZCBIOknnLCAnZGVhbnRUaW1lU3RyaW5nLCAncmFwZVRpbWVab25lKTsKICAgICAgICAgICAgfSBjYXRjaCAoXEV4Y2VwdGlvbiAkcGFyc2VFeCkgewogICAgICAgICAgICAgICAgTG9nOjptYXJuaW5nKCAnUGFyc2luZyBtaXQgVGltZXpvbmUgZmVobGdlc2NobGFnZW4sIHZlcnN1Y2UgVVRDLicnLCBbJ3R6JyA9PiAkdGhpcy0+dGltZVpvbmUsICdkYXRldGltZScgPT4gJHN0YXJ0RGF0ZVRpbWVTdHJpbmddKTsKICAgICAgICAgICAgICAgICRzdGFydFRpbWUgPSBDYXJib246OmNyZWF0ZUZyb21Gb3JtYXQoJ1ktbS1kIEg6aScsICRzdGFydERhdGVUaW1lU3RyaW5nKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCEkc3RhcnRUaW1lKSB7CiAgICAgICAgICAgICAgICAgJHRoaXMtPmxhc3RFcnJvciA9ICdVbmdcdTAwZmx0aWdlcyBEYXR1bXMtL1plaXRmb3JtYXQuJzsKICAgICAgICAgICAgICAgICBMb2c6OmVycm9yKCR0aGlzLT5sYXN0RXJyb3IsIFsnZGF0ZScgPT4gJGJvb2tpbmdEYXRhWydkYXRlJ10sICd0aW1lJyA9PiAkYm9va2luZ0RhdGFbJ3RpbWUnXV0pOwogICAgICAgICAgICAgICAgIHJldHVybiBbJ3N1Y2Nlc3MnID0+IGZhbHNlLCAnbWVzc2FnZScgPT4gJHRoaXMtPmxhc3RFcnJvciwgJ2FwcG9pbnRtZW50X2lkJyA9PiBudWxsXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJHN0YXJ0VGltZVV0YyA9ICRzdGFydFRpbWUtPmNvcHkoKS0+dXRjKCk7CiAgICAgICAgICAgICRlbmRUaW1lVXRjID0gJHN0YXJ0VGltZVV0Yy0+Y29weSgpLT5hZGRNaW51dGVzKCRkdXJhdGlvbik7IC8vIFZlcndlbmRldCBqZXR6dCBkaWUga29ycmVrdGUgRGF1ZXI7CgogICAgICAgICAgICAvLyBQYXlsb2FkIGbDvHIgQ2FsLmNvbSBBUEkgdm9yYmVyZWl0ZW4KICAgICAgICAgICAgJHBheWxvYWQgPSBbCiAgICAgICAgICAgICAgICAnZXZlbnRUeXBlSWQnID0+ICRldmVudFR5cGVJZCwKICAgICAgICAgICAgICAgICdzdGFydCcgPT4gJHN0YXJ0VGltZVV0Yy0+dG9JU084NjAxU3RyaW5nKHRydWUpLAogICAgICAgICAgICAgICAgJ2VuZCcgPT4gJGVuZFRpbWVVdGMtPnRvSVNPODYwMVN0cmluZyh0cnVlKSwgLy8gRW5kemVpdCBiYXNpZXJ0IGpldHp0IGF1ZiBrb3JyZWt0ZXIgRGF1ZXI7CiAgICAgICAgICAgICAgICAndGltZVpvbmUnID0+ICdVVEInLAogICAgICAgICAgICAgICAgJ2xhbmd1YWdlJyA9PiAkdGhpcy0+bGFuZ3VhZ2UsCiAgICAgICAgICAgICAgICAvLyBLT1JSRUtUVVI6IHVzZXJJZCBiaW56ZWdlaMO8Z3QKICAgICAgICAgICAgICAgICd1c2VySWQnID0+ICR0aGlzLT5jYWxjb21Vc2VySWQsCiAgICAgICAgICAgICAgICAncmVzcG9uc2VzJyA9PiBbCiAgICAgICAgICAgICAgICAgICAgJ25hbWUnID0+ICRib29raW5nRGF0YVsjY3VzdG9tZXJOYW1lJ10sCiAgICAgICAgICAgICAgICAgICAgJ2VtYWlsJyA9PiAkYm9va2luZ0RhdGFbJ2N1c3RvbWVyRW1haWwnXSwKICAgICAgICAgICAgICAgICAgICAnbG9jYXRpb24nID0+IFsKICAgICAgICAgICAgICAgICAgICAgICAgJ29wdGlvblZhbHVlJyA9PiAncGhvbmUnLAogICAgICAgICAgICAgICAgICAgICAgICAndmFsdWUnID0+ICRib29raW5nRGF0YVsjcGhvbmUnXSA/PyAnTi9BJwogICAgICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgJ21ldGFkYXRhJyA9PiBbCiAgICAgICAgICAgICAgICAgICAgICdzb3VyY2UnID0+ICdBc2tQcm9BSSBXZWJob29rJywKICAgICAgICAgICAgICAgICAgICAgLy8gS09SUkVLUVVSOiBJRCAgZXhwbGl6aXQgenUgU3RyaW5nIGNhc3RlbjoKICAgICAgICAgICAgICAgICAgICAgJ2NhbGxfaWRfaW50ZXJuYWwnID0+IGlzc2V0KCRib29raW5nRGF0YVsjY2FsbF9pZCddKSA/IChzdHJpbmcpJGJvb2tpbmdEYXRhWydjYWxsX2lkJ10gOiBudWxsCiAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgJ2F0dGVuZGVlcycgPT4gWwogICAgICAgICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgICAgICAgJ25hbWUnID0+ICRib29raW5nRGF0YVsjY3VzdG9tZXJOYW1lJ10sCiAgICAgICAgICAgICAgICAgICAgICAgICdlbWFpbCcgPT4gJGJvb2tpbmdEYXRhWydjdXN0b21lckVtYWlsJ10sCiAgICAgICAgICAgICAgICAgICAgICAgICd0aW1lWm9uZScgPT4gJHRoaXMtPnRpbWVab25lLAogICAgICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgIF07CiAKICAgICAgICAgICAgJG1heFJldHJpZXMgPSAzOwogICAgICAgICAgICAkcmV0cnlEZWxheSA9IDEwMDA7CgogICAgICAgICAgICBmb3IgKCRhdHRlbXB0ID0gMTsgJGF0dGVtcHQgPD0gJG1heFJldHJpZXM7ICRhdHRlbXB0KyspIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgJHurlCA9ICJ7JHRoaXMtPmJhc2VVcmx9L2Jvb2tpbmdzP2FwaUtleT0keyR0aGlzLT5hcGlLZXl9IjsKICAgICAgICAgICAgICAgICAgICAkcmVzcG9uc2UgPSBIdHRwOjphY2NlcHRKc29uKCktPnBvc3QoJHVybCwgJHBheWxvYWQpOwoKICAgICAgICAgICAgICAgICAgICBMb2c6OmRlYnVnKCdDYWwuY29tIGJvb2tBcHBvaW50bWVudCBBbnR3b3J0JywgWwogICAgICAgICAgICAgICAgICAgICAgICAnYXR0ZW1wdCcgPT4gJGF0dGVtcHQsCiAgICAgICAgICAgICAgICAgICAgICAgICdzdGF0dXMnID0+ICRyZXNwb25zZS0+c3RhdHVzKCksCiAgICAgICAgICAgICAgICAgICAgICAgICdyZXNwb25zZV9ib2R5JyA9PiAkcmVzcG9uc2UtPmJvZHkoKSwKICAgICAgICAgICAgICAgICAgICAgICAgJ3BheWxvYWRfc2VudCcgPT4gJHBheWxvYWQgLy8gUGF5bG9hZCBmw7xyIERlYnVnZ2luZyBsb2dnZW4KICAgICAgICAgICAgICAgICAgICBdKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCRyZXNwb25zZS0+c3VjY2Vzc2Z1bCgpICYmIGlzc2V0KCRyZXNwb25zZS0+anNvbigpWydib29raW5nJ11bJ2lkJ10pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRib29raW5nSWQgPSAkcmVzcG9uc2UtPmpzb24oKVsjYm9va2luZyddWyJpZCJdOwogICAgICAgICAgICAgICAgICAgICAgICBMb2c6OmluZm8oJ/CfkoQg77iPIENhbC5jb20gQnVjaHVuZyBlcmZvbGdyZWljaCBlcnN0ZWxsdCcsIFsnYm9va2luZ0lkJyA9PiAkYm9va2luZ0lkXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gJ1Rlcm1pbiBlcmZvbGdyZWljaCBnZWJ1Y2h0LicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYXBwb2ludG1lbnRfaWQnID0+ICRib29raW5nSWQKICAgICAgICAgICAgICAgICAgICAgICAgXSw7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAkdGhpcy0+bGFzdEVycm9yID0gIkNhbC5jb20gQnVjaHVuZ3N2ZXJzdWNoIGZlaGxnZXNjaGxhZ2VuIChTdGF0dXMgeyRyZXNwb25zZS0+c3RhdHVzKCcpfSk6ICIgLiAkcmVzcG9uc2UtPmJvZHkoKTsKICAgICAgICAgICAgICAgICAgICBMb2c6Ondhcm5pbmcoJ/CfkpIg77iPICcgLiAkdGhpcy0+bGFzdEVycm9yLCBbCiAgICAgICAgICAgICAgICAgICAgICAgICdhdHRlbXB0JyA9PiAkYXR0ZW1wdCwKICAgICAgICAgICAgICAgICAgICAgICAgLy8ncGF5bG9hZF9zZW50JyA9PiAkcGF5bG9hZC8vIEdnZi4gUGF5bG9hZCBudXIgYmVpIEZlaGxlcm4gbG9nZ2VuPwogICAgICAgICAgICAgICAgICAgIF0pOwoKICAgICAgICAgICAgICAgICAgICAgaWYgKCRyZXNwb25zZS0+c3RhdHVzKCkgPT09IDQwMSB8fCAkcmVzcG9uc2UtPnN0YXR1cygpID09PSA0MDMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHRoaXMtPmxhc3RFcnJvciA9ICJDYWwuY29tOiBBdXRoZW50aWZpemllcnVuZyBmZWhsZ2VzY2hsYWdlbiAoQVBJIEdleT8pLjsKICAgICAgICAgICAgICAgICAgICAgICAgTG9nOjplcnJvcign4p2kICcgLiAkdGhpcy0+bGFzdEVycm9yLCBbJ3N0YXR1cycgPT4gJHJlc3BvbnNlLT5zdGF0dXMoKV0pOwogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgXEV4Y2VwdGlvbigkdGhpcy0+bGFzdEVycm9yKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy8gQmVpIENsaWVudC1GZWhsZXJuIHdpZSA0MDAgQmFkIFJlcXVlc3QgZGlyZWt0IGFiYnJlY2hlbiAoRmVobGVybWVsZHVuZyAiSW52YWxpZCBldmVudCBsZW5ndGgiIGlzdCA0MDApCiAgICAgICAgICAgICAgICAgICAgaWYgKCRyZXNwb25zZS0+c3RhdHVzKCkgPj0gNDAwICYmICRyZXNwb25zZS0+c3RhdHVzKCkgPCA1MDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgIExvZzo6ZXJyb3IoJ+KdpCBCYWQgUmVxdWVzdCBvZGVyIGFuZGVyZXIgQ2xpZW50LUZlaGxlciB2b24gQ2FsLmNvbS4gS2VpbiBSZXRyeS4nLCBbJ3N0YXR1cycgPT4gJHJlc3BvbnNlLT5zdGF0dXMoKSwgJ21lc3NhZ2UnID0+ICR0aGlzLT5sYXN0RXJyb3JdKTsKICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBcRXhjZXB0aW9uKCR0aGlzLT5sYXN0RXJyb3IpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvLyBCZWkgNXX4IFNlcnZlciBGZWhsZXJuIHZvbiBDYWwuY29tIHdpcmQgZGVyIFJldHJ5IGZvcnRnZXNldHp0CiAKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKFJlcXVlc3RFeGNlcHRpb24gJGUpIHsKICAgICAgICAgICAgICAgICAgICAkdGhpcy0+bGFzdEVycm9yID0gJ1JlcXVlc3RFeGNlcHRpb24gYmVpIENhbC5jb20gQnVjaHVuZzogJyAuICRlLT5nZXRNZXNzYWdlKCk7CiAgICAgICAgICAgICAgICAgICAgTG9nOjplcnJvcign4p2kICcgLiAkdGhpcy0+bGFzdEVycm9yLCBbCiAgICAgICAgICAgICAgICAgICAgICAgICdhdHRlbXB0JyA9PiAkYXR0ZW1wdCwKICAgICAgICAgICAgICAgICAgICAgICAgJ3VybCcgPT4gJHVybCA/PyBudWxsLAogICAgICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICAgICAgICAgIC8vIEhpZXIgd2VpdGVyIG1pdCBSZXRyeQogICAgICAgICAgICAgICAgfSBjYXRjaCAoVGhyb3dhYmxlICRlKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRsOkbmd0IHouQi4gZGllIEV4Y2VwdGlvbnMgdm9uIG9iZW4gKDQweCBGZWhsZXIpCiAgICAgICAgICAgICAgICAgICAgJHRoaXMtPmxhc3RFcnJvciA9ICdVbmVyd2FydGV0ZXIgRmVobGVyIGJlaSBDYWwuY29tIEJ1Y2h1bmcgVmVyc3VjaCAnIC4gJGF0dGVtcHQgLiAnOiAnIC4gJGUtPmdldE1lc3NhZ2UoKTsKICAgICAgICAgICAgICAgICAgICBMb2c6OmVycm9yKCfinaQgJyAuICR0aGlzLT5sYXN0RXJyb3IpOwogICAgICAgICAgICAgICAgICAgIC8vIFdlbm4gZXMgZWluZSA0eHggRXhjZXB0aW9uIHdhciwgd2lyZCBzaWUgZGlyZWt0IGdld29yZmVuCiAgICAgICAgICAgICAgICAgICAgaWYgKGlzc2V0KCRyZXNwb25zZSkgJiYgJHJlc3BvbnNlLT5zdGF0dXMoKSA+PSA0MDAgJiYgJHJlc3BvbnNlLT5zdGF0dXMoKSA8IDUwMCkgdGhyb3cgJGUKICAgICAgICAgICAgICAgICAgICAvLyBTb25zdCB3ZWl0ZXIgbWl0IFJldHJ5CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKCRhdHRlbXB0IDwgJG1heFJldHJpZXMpIHsKICAgICAgICAgICAgICAgICAgICB1c2xlZXAoJHJldHJ5RGVsYXkgKiAxMDAwICogcG93KDIsICRhdHRlbXB0IC0gMSkpOyAvLyBFeHBvbmVudGllbGxlciBCYWNrb2ZmCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gLy8gRW5kZSBkZXIgZm9yLVNjaGxlaWZlIChSZXRyaWVzKQoKICAgICAgICAgICAgJGZpbmFsRXJyb3JNc2cgPSAnQ2FsLmNvbSBCdWNhb3IgZW5kZ8O8bHRpZyBmZWhsZ2VzY2hsYWdlbiBuYWNoICcgLiAkbWF4UmV0cmllcyAuICcgVmVyc3VjaGVuLiBMZXR6dGVyIEZlaGxlcjogJyAuICR0aGlzLT5sYXN0RXJyb3I7CiAgICAgICAgICAgIExvZzo6ZXJyb3IoJ+KdpCAgJyAuICRmaW5hbEVycm9yTXNnKTsKICAgICAgICAgICAgdGhyb3cgbmV3IFxFeGNlcHRpb24oJGZpbmFsRXJyb3JNc2cpOwoKICAgICAgICB9IGNhdGNoIChUaHJvd2FibGUgJGUpIHsKICAgICAgICAgICAgLy8gRsOkbmd0IGF1Y2ggRXhjZXB0aW9ucyBhdXMgZ2V0RXZlbnRUeXBlRGV0YWlscyBvZGVyIENhcmJvbgogICAgICAgICAgICAkdGhpcy0+bGFzdEVycm9yID0gJ0dlbmVyZWxsZXIgRmVobGVyIGluIGJvb2tBcHBvaW50bWVudC1Qcm96ZXNzOiAnIC4gJGUtPmdldE1lc3NhZ2UoKTsKICAgICAgICAgICAgTG9nOjplcnJvcigkdGhpcy0+bGFzdEVycm9yLCBbCiAgICAgICAgICAgICAgICAvLyBUcmFjZSBudXIgYmVpIFN0YW5kYXJkLUZlaGxlcm4gbG9nZ2VuCiAgICAgICAgICAgICAgICAnYm9va2luZ0RhdGEnID0+ICRib29raW5nRGF0YQogICAgICAgICAgICBdKTsKICAgICAgICAgICAgTG9nOjplcnJvcignRnVsbCB0cmFjZSBmb3IgbGFzdCBFcnJvciBpbiBib29rQXBwb2ludG1lbnQ6ICcgLiAkZS0+Z2V0VHJhY2VBc1N0cmluZygpKTsgLy8gVHJhY2UgZXR3YXMgZGV0YWlsaWVydGVyIGxvZ2dlbgogICAgICAgICAgICAvLyBXYWNodGlnOiBFeGNlcHRpb24gd2VpdGVyd2VyZmVuLCBkYW1pdCBERyBDb250cm9sbGVyIHNpZSBmYW5nZW4g" | base64 --decode | sudo tee /var/www/api-gateway/app/Services/CalcomService.php > /dev/null

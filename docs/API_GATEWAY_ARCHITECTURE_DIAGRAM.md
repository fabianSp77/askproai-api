# API Gateway Architecture Diagram

## High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                             CLIENT APPLICATIONS                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                 │
│  │   React Portal  │  │   Mobile App    │  │   Third Party   │                 │
│  │   (Dashboard)   │  │                 │  │   Integrations  │                 │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘                 │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                               LOAD BALANCER                                     │
│                            (nginx / Cloudflare)                                │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            API GATEWAY LAYER                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────────────────────┐ │
│  │                        REQUEST PIPELINE                                  │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │ │
│  │  │  Authentication │  │  Authorization  │  │  Rate Limiting  │         │ │
│  │  │     Gateway     │  │     Gateway     │  │     Gateway     │         │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘         │ │
│  │            │                    │                    │                  │ │
│  │            ▼                    ▼                    ▼                  │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │ │
│  │  │     Caching     │  │ Request/Response│  │ Circuit Breaker │         │ │
│  │  │     Gateway     │  │   Transformer   │  │     Gateway     │         │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘         │ │
│  │            │                    │                    │                  │ │
│  │            └────────────────────┼────────────────────┘                  │ │
│  │                                 ▼                                       │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │ │
│  │  │                    METRICS & MONITORING                        │   │ │
│  │  └─────────────────────────────────────────────────────────────────┘   │ │
│  └───────────────────────────────────────────────────────────────────────────┘ │
│                                    │                                           │
│                                    ▼                                           │
│  ┌───────────────────────────────────────────────────────────────────────────┐ │
│  │                        SERVICE DISCOVERY                                 │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │ │
│  │  │ Service Registry│  │  Health Checks  │  │  Load Balancer  │         │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘         │ │
│  └───────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                             BUSINESS SERVICES                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐             │
│  │ Dashboard   │ │   Calls     │ │Appointments │ │ Customers   │             │
│  │ Service     │ │  Service    │ │  Service    │ │  Service    │             │
│  │             │ │             │ │             │ │             │             │
│  │ • Overview  │ │ • List      │ │ • Calendar  │ │ • Profiles  │             │
│  │ • Metrics   │ │ • Details   │ │ • Booking   │ │ • Timeline  │             │
│  │ • Activity  │ │ • Export    │ │ • Status    │ │ • Search    │             │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘             │
│                                                                               │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐             │
│  │ Analytics   │ │  Settings   │ │   Billing   │ │    Team     │             │
│  │  Service    │ │  Service    │ │  Service    │ │  Service    │             │
│  │             │ │             │ │             │ │             │             │
│  │ • Reports   │ │ • Company   │ │ • Invoices  │ │ • Members   │             │
│  │ • KPIs      │ │ • Profile   │ │ • Usage     │ │ • Roles     │             │
│  │ • Trends    │ │ • API Keys  │ │ • Payments  │ │ • Permissions│             │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘             │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          EXTERNAL INTEGRATIONS                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐             │
│  │  Cal.com    │ │  Retell.ai  │ │   Stripe    │ │   SendGrid  │             │
│  │ Integration │ │ Integration │ │ Integration │ │ Integration │             │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘             │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            DATA & STORAGE LAYER                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐             │
│  │  MySQL/     │ │    Redis    │ │  File       │ │   Logs      │             │
│  │  MariaDB    │ │   Cache     │ │  Storage    │ │  Storage    │             │
│  │             │ │             │ │             │ │             │             │
│  │ • Companies │ │ • Sessions  │ │ • Uploads   │ │ • Audit     │             │
│  │ • Users     │ │ • Cache     │ │ • Exports   │ │ • Errors    │             │
│  │ • Calls     │ │ • Queues    │ │ • Backups   │ │ • Performance│             │
│  │ • Appts     │ │ • Metrics   │ │             │ │             │             │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘             │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## Request Flow Diagram

```
┌─────────────┐
│   Client    │
│  Request    │
└──────┬──────┘
       │
       ▼
┌─────────────┐      ┌──────────────────────────────────────────────────┐
│ Load        │      │                GATEWAY PIPELINE                  │
│ Balancer    │ ──► │                                                  │
└─────────────┘      │  1. Authentication    ┌─────────────────────────┐│
                     │     │                 │     Session Auth        ││
                     │     ▼                 │     Token Auth          ││
                     │  2. Authorization     │     API Key Auth        ││
                     │     │                 └─────────────────────────┘│
                     │     ▼                                           │
                     │  3. Rate Limiting     ┌─────────────────────────┐│
                     │     │                 │   IP-based Limits       ││
                     │     ▼                 │   User-based Limits     ││
                     │  4. Caching           │   Company-tier Limits   ││
                     │     │                 │   Endpoint Limits       ││
                     │     ▼                 └─────────────────────────┘│
                     │  5. Circuit Breaker                             │
                     │     │                 ┌─────────────────────────┐│
                     │     ▼                 │    L1 Cache (Fast)      ││
                     │  6. Service Discovery │    L2 Cache (Persistent)││
                     │     │                 │    Cache Invalidation   ││
                     │     ▼                 └─────────────────────────┘│
                     │  7. Request Transform                           │
                     │     │                                           │
                     └─────┼───────────────────────────────────────────┘
                           │
                           ▼
                     ┌─────────────┐      ┌─────────────────────────────┐
                     │  Business   │      │     Circuit Breaker         │
                     │  Service    │ ──► │                             │
                     │  Handler    │      │  ┌─────────┐ ┌─────────┐   │
                     └─────────────┘      │  │ CLOSED  │ │  OPEN   │   │
                           │              │  │ (Normal)│ │(Fallback)│   │
                           ▼              │  └─────────┘ └─────────┘   │
                     ┌─────────────┐      │          │                 │
                     │  Response   │      │          ▼                 │
                     │ Transform   │      │  ┌─────────────────────┐   │
                     └─────────────┘      │  │    HALF-OPEN        │   │
                           │              │  │   (Testing)         │   │
                           ▼              │  └─────────────────────┘   │
                     ┌─────────────┐      └─────────────────────────────┘
                     │  Metrics    │
                     │ Recording   │
                     └─────────────┘
                           │
                           ▼
                     ┌─────────────┐
                     │   Client    │
                     │  Response   │
                     └─────────────┘
```

## Rate Limiting Strategy

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            RATE LIMITING LAYERS                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                          LAYER 1: GLOBAL                               │   │
│  │                                                                         │   │
│  │  IP Address: 1000 req/hour      │      DDoS Protection                 │   │
│  │  Global Burst: 50 req/minute    │      Abuse Prevention                │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                     │                                           │
│                                     ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                          LAYER 2: USER                                 │   │
│  │                                                                         │   │
│  │  Authenticated User: 500 req/hour                                      │   │
│  │  Session-based Tracking                                                │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                     │                                           │
│                                     ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        LAYER 3: COMPANY                                │   │
│  │                                                                         │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐     │   │
│  │  │    FREE     │ │     PRO     │ │ ENTERPRISE  │ │ UNLIMITED   │     │   │
│  │  │             │ │             │ │             │ │             │     │   │
│  │  │ 2K req/hr   │ │ 6K req/hr   │ │ 20K req/hr  │ │ 100K req/hr │     │   │
│  │  │ Base Rate   │ │ 3x Multi    │ │ 10x Multi   │ │ 50x Multi   │     │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘     │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                     │                                           │
│                                     ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                       LAYER 4: ENDPOINT                                │   │
│  │                                                                         │   │
│  │  dashboard:     100 req/hr       │  Heavy queries, low frequency       │   │
│  │  calls:         300 req/hr       │  High usage, real-time data         │   │
│  │  appointments:  200 req/hr       │  Moderate usage                     │   │
│  │  customers:     150 req/hr       │  CRUD operations                    │   │
│  │  analytics:      50 req/hr       │  Resource intensive                 │   │
│  │  settings:       30 req/hr       │  Infrequent updates                 │   │
│  │  billing:        20 req/hr       │  Sensitive operations               │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                     │                                           │
│                                     ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                       LAYER 5: RESOURCE                                │   │
│  │                                                                         │   │
│  │  Per-resource type limits based on company tier                        │   │
│  │  Prevents resource exhaustion                                          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## Caching Strategy

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                             CACHING ARCHITECTURE                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        L1 CACHE (REDIS)                                │   │
│  │                     Fast Access, Short TTL                             │   │
│  │                                                                         │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐     │   │
│  │  │ Dashboard   │ │    Calls    │ │   User      │ │  Settings   │     │   │
│  │  │  60 sec     │ │   30 sec    │ │  Session    │ │  300 sec    │     │   │
│  │  │             │ │             │ │   Data      │ │             │     │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘     │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                     │                                           │
│                                     ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        L2 CACHE (REDIS)                                │   │
│  │                   Persistent, Longer TTL                               │   │
│  │                                                                         │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐     │   │
│  │  │ Customers   │ │Appointments │ │ Analytics   │ │  Company    │     │   │
│  │  │  600 sec    │ │  300 sec    │ │  900 sec    │ │  Settings   │     │   │
│  │  │             │ │             │ │             │ │  1800 sec   │     │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘     │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                     │                                           │
│                                     ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                      CACHE INVALIDATION                                │   │
│  │                                                                         │   │
│  │  Event: calls.created        → Invalidate: dashboard, analytics        │   │
│  │  Event: appointments.updated → Invalidate: calendar, analytics         │   │
│  │  Event: customers.updated    → Invalidate: customers, dashboard        │   │
│  │  Event: settings.changed     → Invalidate: settings, company data      │   │
│  │                                                                         │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │   │
│  │  │              SMART INVALIDATION RULES                          │   │   │
│  │  │                                                                 │   │   │
│  │  │  • Wildcard pattern matching                                   │   │   │
│  │  │  • Company-specific invalidation                               │   │   │
│  │  │  • User-specific invalidation                                  │   │   │
│  │  │  • Cascade invalidation (dependent data)                       │   │   │
│  │  └─────────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## Circuit Breaker Pattern

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          CIRCUIT BREAKER STATES                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                           CLOSED STATE                                  │   │
│  │                         (Normal Operation)                              │   │
│  │                                                                         │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │   │
│  │  │                    Request Flow                                 │   │   │
│  │  │                                                                 │   │   │
│  │  │  Client Request → Service Call → Success/Failure Counter       │   │   │
│  │  │                                                                 │   │   │
│  │  │  Failure Threshold: 5 failures in 5 minutes                   │   │   │
│  │  │  Success Threshold: All requests successful                    │   │   │
│  │  └─────────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                     │                                           │
│                          Failures > Threshold                                  │
│                                     ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                            OPEN STATE                                   │   │
│  │                        (Service Degraded)                               │   │
│  │                                                                         │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │   │
│  │  │                  Fallback Response                              │   │   │
│  │  │                                                                 │   │   │
│  │  │  Client Request → Immediate Fallback → Cached/Static Response  │   │   │
│  │  │                                                                 │   │   │
│  │  │  Timeout: 60 seconds (configurable per service)               │   │   │
│  │  │  No requests sent to failing service                           │   │   │
│  │  └─────────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                     │                                           │
│                           Timeout Expired                                      │
│                                     ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         HALF-OPEN STATE                                 │   │
│  │                          (Testing Service)                              │   │
│  │                                                                         │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │   │
│  │  │                   Probe Requests                                │   │   │
│  │  │                                                                 │   │   │
│  │  │  Limited Requests → Service Call → Success/Failure Tracking    │   │   │
│  │  │                                                                 │   │   │
│  │  │  Success: Close circuit (return to normal)                     │   │   │
│  │  │  Failure: Open circuit (return to fallback)                    │   │   │
│  │  └─────────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## Service Discovery (Future Microservices)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           SERVICE DISCOVERY LAYER                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        SERVICE REGISTRY                                 │   │
│  │                                                                         │   │
│  │  Service Name: appointments-service                                     │   │
│  │  Version: v1.2.3                                                       │   │
│  │  Instances:                                                             │   │
│  │    - 10.0.1.10:8080 (healthy)                                          │   │
│  │    - 10.0.1.11:8080 (healthy)                                          │   │
│  │    - 10.0.1.12:8080 (unhealthy)                                        │   │
│  │                                                                         │   │
│  │  Health Check: GET /health every 30s                                   │   │
│  │  Load Balancing: round_robin                                           │   │
│  │  Circuit Breaker: 5 failures / 60s timeout                            │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                     │                                           │
│                                     ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        LOAD BALANCING                                   │   │
│  │                                                                         │   │
│  │  Strategy: Round Robin                                                  │   │
│  │                                                                         │   │
│  │  Request 1 → Instance A  ┌─────────────────────────────────────────┐   │   │
│  │  Request 2 → Instance B  │         Health Monitoring             │   │   │
│  │  Request 3 → Instance A  │                                       │   │   │
│  │  Request 4 → Instance B  │  ┌─────────────┐ ┌─────────────┐     │   │   │
│  │  (Skip unhealthy C)      │  │   HTTP      │ │    TCP      │     │   │   │
│  │                          │  │ Health      │ │  Health     │     │   │   │
│  │  Fallback: Cached data   │  │  Check      │ │   Check     │     │   │   │
│  │  if all instances fail   │  └─────────────┘ └─────────────┘     │   │   │
│  │                          └─────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

This architecture provides a comprehensive foundation for the API Gateway pattern while maintaining backward compatibility and preparing for future microservices migration. The visual diagrams help understand the request flow, caching strategy, and circuit breaker patterns that ensure high availability and performance.
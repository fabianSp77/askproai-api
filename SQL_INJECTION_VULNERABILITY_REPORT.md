# SQL Injection Vulnerability Report - AskProAI

Generated: 2025-06-28 (Updated)

## Executive Summary

After a comprehensive scan of the `/var/www/api-gateway/app` directory, I identified several areas with potential SQL injection vulnerabilities. The most critical findings involve uses of `whereRaw()`, `DB::raw()`, and `fromRaw()` with potentially unsanitized input. This updated report includes additional critical vulnerabilities found in QueryOptimizer.php and FeatureFlagService.php.

## Critical Vulnerabilities Found

### 1. **NEW CRITICAL: QueryOptimizer.php - fromRaw() Table Injection (CRITICAL RISK)**

#### File: `/var/www/api-gateway/app/Services/QueryOptimizer.php`
- **Line 46**: Direct table name interpolation in fromRaw()
```php
$query->fromRaw("`{$table}` USE INDEX (" . $this->sanitizeIndexList($indexList) . ")");
```
- **Line 327**: Similar issue with FORCE INDEX
```php
$query->fromRaw("`{$table}` FORCE INDEX (" . $this->sanitizeIndexName($index) . ")");
```
- **Risk**: Even with sanitization attempts, direct table name interpolation in raw SQL is extremely dangerous
- **Severity**: CRITICAL - Could allow complete database takeover through table name injection

### 2. **NEW CRITICAL: FeatureFlagService.php - JSON Injection (HIGH RISK)**

#### File: `/var/www/api-gateway/app/Services/FeatureFlagService.php`
- **Line 264**: DB::raw() with JSON_SET and direct value interpolation
```php
'metadata' => DB::raw("JSON_SET(COALESCE(metadata, '{}'), '$.emergency_reason', " . DB::connection()->getPdo()->quote($reason) . ")")
```
- **Risk**: While PDO::quote is used, this pattern is still dangerous and could be exploited with carefully crafted input
- **Severity**: HIGH - Could allow JSON structure manipulation and potential SQL injection

### 3. **whereRaw() with User Input (HIGH RISK)**

#### File: `/var/www/api-gateway/app/Services/RealTime/IntelligentCallRouter.php`
- **Lines 158-159**: Direct use of `whereRaw()` with JSON_EXTRACT
```php
->whereRaw("JSON_EXTRACT(working_hours, '$.{$dayOfWeek}.start') <= ?", [$currentTime])
->whereRaw("JSON_EXTRACT(working_hours, '$.{$dayOfWeek}.end') >= ?", [$currentTime]);
```
- **Risk**: While parameters are bound, the `$dayOfWeek` variable is interpolated directly into the query
- **Severity**: HIGH - Could allow SQL injection if `$dayOfWeek` is not properly validated

#### File: `/var/www/api-gateway/app/Services/RealTime/ConcurrentCallManager.php`
- **Lines 180-181**: Similar pattern with whereRaw and JSON_EXTRACT
```php
->whereRaw("JSON_EXTRACT(working_hours, '$.{$dayOfWeek}.start') <= ?", [$currentTime])
->whereRaw("JSON_EXTRACT(working_hours, '$.{$dayOfWeek}.end') >= ?", [$currentTime]);
```
- **Risk**: Same as above - string interpolation in SQL query
- **Severity**: HIGH

### 2. **DB::raw() with Variable Interpolation (MEDIUM RISK)**

#### File: `/var/www/api-gateway/app/Services/QueryOptimizer.php`
- **Line 44**: Uses DB::raw() with sanitized but still interpolated values
```php
$query->from(DB::raw("`{$table}` USE INDEX ({$indexList})"));
```
- **Lines 323**: Force index implementation
```php
$query->from(DB::raw("{$table} FORCE INDEX ({$index})"));
```
- **Risk**: While there's sanitization (preg_replace), direct interpolation is still risky
- **Severity**: MEDIUM - Sanitization present but not foolproof

### 3. **selectRaw() with Dynamic Content (MEDIUM RISK)**

#### File: `/var/www/api-gateway/app/Filament/Admin/Resources/CallResource/Widgets/CallQualityWidget.php`
- **Lines 36-40**: Uses selectRaw() with JSON_EXTRACT
```php
->selectRaw("
    SUM(CASE WHEN JSON_EXTRACT(analysis, '$.sentiment') = 'positive' THEN 1 ELSE 0 END) as positive,
    SUM(CASE WHEN JSON_EXTRACT(analysis, '$.sentiment') = 'negative' THEN 1 ELSE 0 END) as negative,
    SUM(CASE WHEN JSON_EXTRACT(analysis, '$.sentiment') = 'neutral' THEN 1 ELSE 0 END) as neutral
")
```
- **Risk**: While this specific case is safe (no user input), the pattern could be dangerous if copied
- **Severity**: LOW (in this case)

### 4. **Direct SQL in Migration Files (LOW RISK)**

#### File: `/var/www/api-gateway/app/Database/CompatibleMigration.php`
- **Line 114**: Uses DB::update with string interpolation
```php
DB::update("UPDATE {$tableName} SET {$columnName} = ? WHERE {$columnName} IS NULL OR {$columnName} = ''", [$jsonString]);
```
- **Risk**: Table and column names are interpolated directly
- **Severity**: LOW - Migration files typically don't process user input

### 5. **SQL Statement Building (MEDIUM RISK)**

#### File: `/var/www/api-gateway/app/Console/Commands/PerformanceMonitor.php`
- **Lines 100-102**: Executes dynamic SQL queries
```php
DB::select($queryInfo['query'], $params);
```
- **Risk**: While parameters are bound, the query itself could be manipulated
- **Severity**: MEDIUM - Console commands have limited exposure

## Safe Patterns Observed

### Good Practice Example: `/var/www/api-gateway/app/Helpers/SafeQueryHelper.php`
This file demonstrates proper SQL injection prevention:
- Proper escaping for LIKE queries
- Column name sanitization
- Parameter binding
- Whitelist validation for operators

## Recommendations

### 1. **Immediate Actions (Critical)**
- Replace all `whereRaw()` calls that interpolate variables with safer alternatives
- Use parameter binding for all dynamic values
- Validate `$dayOfWeek` variables against a whitelist before use

### 2. **Short-term Improvements**
- Replace DB::raw() with query builder methods where possible
- Implement strict input validation for all user-provided data
- Use prepared statements consistently

### 3. **Long-term Security Enhancements**
- Implement a query audit system
- Use an ORM consistently instead of raw queries
- Regular security audits with automated tools
- Developer training on secure coding practices

## Code Fixes Required

### Fix for IntelligentCallRouter.php and ConcurrentCallManager.php:
```php
// Instead of:
->whereRaw("JSON_EXTRACT(working_hours, '$.{$dayOfWeek}.start') <= ?", [$currentTime])

// Use:
$allowedDays = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
if (!in_array($dayOfWeek, $allowedDays)) {
    throw new \InvalidArgumentException('Invalid day of week');
}
->whereRaw("JSON_EXTRACT(working_hours, '$." . $dayOfWeek . ".start') <= ?", [$currentTime])
```

### Fix for QueryOptimizer.php:
```php
// Instead of direct interpolation, use query builder:
$query->from($table)->useIndex($indexes);
// Or if DB::raw is necessary, use parameter binding where possible
```

## Updated Code Fixes Required

### Critical Fix for QueryOptimizer.php:
```php
// Instead of:
$query->fromRaw("`{$table}` USE INDEX (" . $this->sanitizeIndexList($indexList) . ")");

// Create a whitelist of allowed tables:
$allowedTables = ['appointments', 'customers', 'staff', 'branches', 'calls'];
if (!in_array($table, $allowedTables)) {
    throw new \InvalidArgumentException('Invalid table name');
}
// Then use proper query builder or validated raw query
```

### Critical Fix for FeatureFlagService.php:
```php
// Instead of:
'metadata' => DB::raw("JSON_SET(COALESCE(metadata, '{}'), '$.emergency_reason', " . DB::connection()->getPdo()->quote($reason) . ")")

// Use safe JSON manipulation in PHP:
$flag = DB::table('feature_flags')->where('key', $key)->first();
$metadata = json_decode($flag->metadata ?? '{}', true);
$metadata['emergency_reason'] = $reason;
DB::table('feature_flags')->where('key', $key)->update(['metadata' => json_encode($metadata)]);
```

### Fix for EventTypeMatchingService.php:
```php
// Instead of:
$q->whereRaw('LOWER(name) LIKE ?', ['%' . $keyword . '%'])

// Use the existing SafeQueryHelper:
SafeQueryHelper::whereLower($q, 'name', $keyword, 'LIKE');
```

## Summary

This updated analysis reveals CRITICAL vulnerabilities that were not in the original report. The most severe issues are in QueryOptimizer.php where table names are directly interpolated into SQL queries, potentially allowing complete database compromise.

**Updated Total Vulnerabilities Found:**
- CRITICAL Risk: 2 (QueryOptimizer.php fromRaw issues)
- HIGH Risk: 5 (including FeatureFlagService.php, EventTypeMatchingService.php, and original findings)
- MEDIUM Risk: 4
- LOW Risk: 3

**Priority Fix Order:**
1. **IMMEDIATE (Within 2 hours)**: QueryOptimizer.php - Lines 46, 327
2. **URGENT (Within 24 hours)**: FeatureFlagService.php - Line 264
3. **HIGH (Within 48 hours)**: All whereRaw() calls in real-time services
4. **MEDIUM (Within 1 week)**: EventTypeMatchingService.php and other services

**Most Critical Affected Components:**
- Query optimization service (CRITICAL - affects all queries)
- Feature flag service (HIGH - affects system configuration)
- Real-time call routing (HIGH - exposed to external input)
- Event type matching (MEDIUM-HIGH - processes user input)

The QueryOptimizer.php vulnerabilities are particularly dangerous as this service appears to be used throughout the application to optimize database queries. A successful exploit could compromise the entire database.

## Immediate Action Required

1. **Deploy hotfix** for QueryOptimizer.php immediately
2. **Audit all uses** of QueryOptimizer service
3. **Review logs** for any suspicious table name patterns
4. **Implement whitelist** for all dynamic SQL components
5. **Enable query logging** to detect exploitation attempts

The presence of SafeQueryHelper.php shows the team understands SQL injection risks, but it's not being used consistently. Enforce its use across all database operations involving user input.
<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://api.askproai.de/mkdocs/architecture/mcp-architecture/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>MCP Architecture - AskProAI Dokumentation</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "MCP Architecture";
        var mkdocs_page_input_path = "architecture/mcp-architecture.md";
        var mkdocs_page_url = "/mkdocs/architecture/mcp-architecture/";
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> AskProAI Dokumentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Start</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Hauptdokumentation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../CLAUDE/">Projekt √úbersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../CLAUDE_QUICK_REFERENCE/">Quick Reference</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../CLAUDE_CONTEXT_SUMMARY/">Context Summary</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Power User</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../TOP_10_COMMANDS/">Top 10 Commands</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../CLAUDE_BEFEHLE_FUER_DICH/">Claude Befehle f√ºr dich</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../MY_COMMANDS/">Meine Commands</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Best Practices 2025</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../BEST_PRACTICES_IMPLEMENTATION/">Implementation Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../DEVELOPMENT_PROCESS_2025/">Development Process</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../CLAUDE_DOCUMENTATION_GAPS_ANALYSIS.md">Documentation Gaps</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Schnellstart</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../5-MINUTEN_ONBOARDING_PLAYBOOK/">5-Minuten Onboarding</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Architektur</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../overview/">√úbersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../services/">Services</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../system-design/">System Design</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">MCP Architecture</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#mcp-server-hierarchy">üèóÔ∏è MCP Server Hierarchy</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#webhookmcpserver-the-orchestrator">üì° WebhookMCPServer - The Orchestrator</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#key-responsibilities">Key Responsibilities</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#constructor-dependencies">Constructor Dependencies</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#main-processing-flow">Main Processing Flow</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#flexible-booking-confirmation">Flexible Booking Confirmation</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#calcommcpserver-calendar-integration">üìÖ CalcomMCPServer - Calendar Integration</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#features">Features</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#booking-creation-flow">Booking Creation Flow</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#required-booking-parameters">Required Booking Parameters</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#team-event-handling">Team Event Handling</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#retellmcpserver-phone-ai-management">üìû RetellMCPServer - Phone AI Management</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#core-functions">Core Functions</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#phone-number-synchronization">Phone Number Synchronization</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#databasemcpserver-data-operations">üóÑÔ∏è DatabaseMCPServer - Data Operations</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#features_1">Features</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#example-usage">Example Usage</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#queuemcpserver-job-management">üìä QueueMCPServer - Job Management</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#capabilities">Capabilities</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#queue-configuration">Queue Configuration</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#complete-data-flow">üîÑ Complete Data Flow</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#error-handling-resilience">üõ°Ô∏è Error Handling &amp; Resilience</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#circuit-breaker-pattern">Circuit Breaker Pattern</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#retry-strategy">Retry Strategy</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#caching-strategy">üíæ Caching Strategy</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#cache-layers">Cache Layers</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#cache-keys-ttl">Cache Keys &amp; TTL</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#monitoring-metrics">üìä Monitoring &amp; Metrics</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#key-metrics-tracked">Key Metrics Tracked</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#debug-commands">Debug Commands</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#security-considerations">üîí Security Considerations</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#webhook-verification">Webhook Verification</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#data-protection">Data Protection</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#multi-tenancy">Multi-Tenancy</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#performance-optimizations">‚ö° Performance Optimizations</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#known-limitations">üöß Known Limitations</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#future-enhancements">üéØ Future Enhancements</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mcp-first-architecture-evolution">üöÄ MCP-First Architecture Evolution</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#new-mcp-servers-coming-soon">New MCP Servers Coming Soon</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#key-benefits-of-mcp-first-approach">Key Benefits of MCP-First Approach</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#documentation">Documentation</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#migration-timeline">Migration Timeline</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../database-schema/">Database Schema</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../security/">Security</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../performance/">Performance</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../api/overview.md">√úbersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/authentication/">Authentication</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../api/endpoints.md">Endpoints</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/webhooks/">Webhooks</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Features</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../features/appointment-booking/">Appointment Booking</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../features/call-management.md">Call Management</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../features/customer-portal.md">Customer Portal</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../features/multi-tenancy/">Multi-Tenancy</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Development</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../development/setup.md">Setup</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../development/testing.md">Testing</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../development/code-standards.md">Code Standards</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Deployment</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../deployment/overview.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../deployment/production.md">Production</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../deployment/environment-variables.md">Environment Variables</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Betrieb</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../CUSTOMER_SUCCESS_RUNBOOK/">Customer Success</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../EMERGENCY_RESPONSE_PLAYBOOK/">Emergency Response</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../ERROR_PATTERNS/">Error Patterns</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../TROUBLESHOOTING_DECISION_TREE/">Troubleshooting</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../DEPLOYMENT_CHECKLIST/">Deployment Checklist</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Monitoring</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../KPI_DASHBOARD_TEMPLATE/">KPI Dashboard</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../INTEGRATION_HEALTH_MONITOR/">Health Monitor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../PHONE_TO_APPOINTMENT_FLOW/">Phone to Appointment Flow</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">AskProAI Dokumentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Architektur &raquo;</li>
      <li>MCP Architecture</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="mcp-model-context-protocol-architecture">MCP (Model Context Protocol) Architecture</h1>
<p>!!! info "MCP Overview"
    The MCP system consists of <strong>5 specialized servers</strong> that orchestrate the entire phone-to-appointment booking process with 99.3% reliability.</p>
<h2 id="mcp-server-hierarchy">üèóÔ∏è MCP Server Hierarchy</h2>
<pre><code class="language-mermaid">flowchart TD
    subgraph &quot;Entry Point&quot;
        W[WebhookMCPServer&lt;br/&gt;Main Orchestrator]
    end

    subgraph &quot;Core MCP Servers&quot;
        C[CalcomMCPServer&lt;br/&gt;Calendar Integration]
        R[RetellMCPServer&lt;br/&gt;Phone AI Management]
        D[DatabaseMCPServer&lt;br/&gt;Data Operations]
        Q[QueueMCPServer&lt;br/&gt;Job Management]
    end

    subgraph &quot;External APIs&quot;
        CA[Cal.com API v2]
        RA[Retell.ai API]
    end

    subgraph &quot;Infrastructure&quot;
        DB[(MySQL Database)]
        RE[(Redis Cache)]
        HZ[Laravel Horizon]
    end

    W --&gt;|Orchestrates| C
    W --&gt;|Manages| R
    W --&gt;|Queries| D
    W --&gt;|Dispatches| Q

    C &lt;--&gt;|API Calls| CA
    R &lt;--&gt;|API Calls| RA
    D &lt;--&gt;|Queries| DB
    Q &lt;--&gt;|Jobs| HZ

    C --&gt;|Caches| RE
    R --&gt;|Caches| RE
    W --&gt;|Caches| RE

    style W fill:#667eea,stroke:#fff,stroke-width:4px,color:#fff
    style C fill:#48bb78,stroke:#333,stroke-width:2px
    style R fill:#4299e1,stroke:#333,stroke-width:2px
    style D fill:#ed8936,stroke:#333,stroke-width:2px
    style Q fill:#9f7aea,stroke:#333,stroke-width:2px
</code></pre>
<h2 id="webhookmcpserver-the-orchestrator">üì° WebhookMCPServer - The Orchestrator</h2>
<p>The WebhookMCPServer is the <strong>central nervous system</strong> of the MCP architecture. It receives webhooks from Retell.ai and orchestrates the entire booking process.</p>
<h3 id="key-responsibilities">Key Responsibilities</h3>
<ol>
<li><strong>Webhook Processing</strong>: Validates and processes incoming Retell.ai webhooks</li>
<li><strong>Phone Resolution</strong>: Maps phone numbers to branches and companies</li>
<li><strong>Customer Management</strong>: Creates or updates customer records</li>
<li><strong>Booking Orchestration</strong>: Coordinates with CalcomMCPServer for appointments</li>
<li><strong>Error Handling</strong>: Implements circuit breakers and retry logic</li>
</ol>
<h3 id="constructor-dependencies">Constructor Dependencies</h3>
<pre><code class="language-php">public function __construct(
    CalcomMCPServer $calcomMCP,
    RetellMCPServer $retellMCP,
    DatabaseMCPServer $databaseMCP,
    QueueMCPServer $queueMCP
)
</code></pre>
<h3 id="main-processing-flow">Main Processing Flow</h3>
<pre><code class="language-php">public function processRetellWebhook(array $webhookData): array
{
    // 1. Validate event type
    if ($webhookData['event'] !== 'call_ended') {
        return ['success' =&gt; true, 'message' =&gt; 'Event skipped'];
    }

    // 2. Resolve phone number to branch
    $phoneResolution = $this-&gt;resolvePhoneNumber($callData['to_number']);

    // 3. Create/update customer
    $customer = $this-&gt;databaseMCP-&gt;findOrCreateCustomer([
        'phone' =&gt; $callData['from_number'],
        'name' =&gt; $variables['name'] ?? 'Unknown',
        'company_id' =&gt; $phoneResolution['company_id']
    ]);

    // 4. Create call record
    $call = $this-&gt;createCallRecord($callData, $customer, $phoneResolution);

    // 5. Check if appointment should be created
    if ($this-&gt;shouldCreateAppointment($callData)) {
        $appointment = $this-&gt;createAppointmentViaMCP($call, $callData, $phoneResolution);
    }

    return ['success' =&gt; true, 'call_id' =&gt; $call-&gt;id];
}
</code></pre>
<h3 id="flexible-booking-confirmation">Flexible Booking Confirmation</h3>
<p>The system accepts multiple formats for booking confirmation:</p>
<pre><code class="language-php">$bookingConfirmed = 
    $value === true || 
    $value === 'true' || 
    $value === '1' || 
    $value === 1 ||
    (is_string($value) &amp;&amp; strtolower($value) === 'yes');
</code></pre>
<h2 id="calcommcpserver-calendar-integration">üìÖ CalcomMCPServer - Calendar Integration</h2>
<p>Handles all Cal.com API interactions with advanced features for reliability and performance.</p>
<h3 id="features">Features</h3>
<table>
<thead>
<tr>
<th>Feature</th>
<th>Description</th>
<th>Configuration</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Circuit Breaker</strong></td>
<td>Prevents cascading failures</td>
<td>Threshold: 5, Timeout: 60s</td>
</tr>
<tr>
<td><strong>Response Caching</strong></td>
<td>Reduces API calls</td>
<td>TTL: 5 minutes</td>
</tr>
<tr>
<td><strong>Idempotency</strong></td>
<td>Prevents duplicate bookings</td>
<td>24-hour window</td>
</tr>
<tr>
<td><strong>Team Events</strong></td>
<td>Supports team-based bookings</td>
<td>Auto-detection</td>
</tr>
<tr>
<td><strong>Retry Logic</strong></td>
<td>Handles transient failures</td>
<td>Max: 3, Backoff: exponential</td>
</tr>
</tbody>
</table>
<h3 id="booking-creation-flow">Booking Creation Flow</h3>
<pre><code class="language-mermaid">sequenceDiagram
    participant W as WebhookMCP
    participant C as CalcomMCP
    participant Cache as Redis
    participant API as Cal.com API
    participant DB as Database

    W-&gt;&gt;C: createBooking(params)
    C-&gt;&gt;Cache: Check idempotency key

    alt Already booked
        Cache--&gt;&gt;C: Return cached booking
        C--&gt;&gt;W: Booking details
    else New booking
        C-&gt;&gt;API: POST /bookings
        API--&gt;&gt;C: Booking created
        C-&gt;&gt;Cache: Store idempotency key
        C-&gt;&gt;DB: Create local record
        C--&gt;&gt;W: Booking details
    end
</code></pre>
<h3 id="required-booking-parameters">Required Booking Parameters</h3>
<pre><code class="language-php">[
    'company_id' =&gt; 1,
    'event_type_id' =&gt; 2563193,
    'start' =&gt; '2025-07-02T11:00:00+02:00',
    'end' =&gt; '2025-07-02T11:30:00+02:00',
    'name' =&gt; 'Customer Name',
    'email' =&gt; 'customer@example.com',
    'phone' =&gt; '+491234567890',
    'notes' =&gt; 'Optional notes',
    'metadata' =&gt; [
        'call_id' =&gt; '123',
        'source' =&gt; 'mcp_webhook'
    ]
]
</code></pre>
<h3 id="team-event-handling">Team Event Handling</h3>
<p>For event type 2563193, the system automatically adds the team ID:</p>
<pre><code class="language-php">if ($eventTypeId == 2563193) {
    $bookingCustomerData['teamId'] = 39203;
}
</code></pre>
<h2 id="retellmcpserver-phone-ai-management">üìû RetellMCPServer - Phone AI Management</h2>
<p>Manages all Retell.ai interactions including agents, phone numbers, and call data.</p>
<h3 id="core-functions">Core Functions</h3>
<ol>
<li><strong>Agent Management</strong></li>
<li>List agents</li>
<li>Update agent prompts</li>
<li>
<p>Configure agent settings</p>
</li>
<li>
<p><strong>Phone Number Sync</strong></p>
</li>
<li>Import phone numbers from Retell</li>
<li>Map to local branches</li>
<li>
<p>Maintain sync status</p>
</li>
<li>
<p><strong>Webhook Configuration</strong></p>
</li>
<li>Validate webhook URLs</li>
<li>Ensure correct event subscriptions</li>
<li>
<p>Monitor webhook health</p>
</li>
<li>
<p><strong>Call Data Retrieval</strong></p>
</li>
<li>Fetch call transcripts</li>
<li>Analyze call metrics</li>
<li>Extract dynamic variables</li>
</ol>
<h3 id="phone-number-synchronization">Phone Number Synchronization</h3>
<pre><code class="language-php">public function syncPhoneNumbers(array $params): array
{
    // 1. Get all phone numbers from Retell
    $retellNumbers = $this-&gt;retellClient-&gt;listPhoneNumbers();

    // 2. For each number
    foreach ($retellNumbers as $number) {
        // 3. Create or update local record
        PhoneNumber::updateOrCreate(
            ['phone_number' =&gt; $number['phone_number']],
            [
                'retell_phone_number_id' =&gt; $number['id'],
                'is_active' =&gt; $number['status'] === 'active',
                'branch_id' =&gt; $this-&gt;resolveBranch($number),
                'company_id' =&gt; $params['company_id']
            ]
        );
    }

    return ['synced' =&gt; count($retellNumbers)];
}
</code></pre>
<h2 id="databasemcpserver-data-operations">üóÑÔ∏è DatabaseMCPServer - Data Operations</h2>
<p>Provides a circuit-breaker protected interface to database operations.</p>
<h3 id="features_1">Features</h3>
<ul>
<li><strong>Circuit Breaker Protection</strong>: Prevents database overload</li>
<li><strong>Query Performance Monitoring</strong>: Tracks slow queries</li>
<li><strong>Prepared Statements</strong>: SQL injection prevention</li>
<li><strong>Transaction Support</strong>: ACID compliance</li>
</ul>
<h3 id="example-usage">Example Usage</h3>
<pre><code class="language-php">// Simple query
$customers = $this-&gt;databaseMCP-&gt;query([
    'query' =&gt; 'SELECT * FROM customers WHERE company_id = ?',
    'bindings' =&gt; [$companyId]
]);

// Insert with transaction
$result = $this-&gt;databaseMCP-&gt;execute([
    'query' =&gt; 'INSERT INTO appointments (customer_id, date, time) VALUES (?, ?, ?)',
    'bindings' =&gt; [$customerId, $date, $time],
    'transaction' =&gt; true
]);
</code></pre>
<h2 id="queuemcpserver-job-management">üìä QueueMCPServer - Job Management</h2>
<p>Integrates with Laravel Horizon for queue management and monitoring.</p>
<h3 id="capabilities">Capabilities</h3>
<ol>
<li><strong>Job Dispatching</strong>: Send jobs to appropriate queues</li>
<li><strong>Queue Monitoring</strong>: Track queue sizes and processing times</li>
<li><strong>Failed Job Management</strong>: Retry or investigate failures</li>
<li><strong>Performance Metrics</strong>: Queue throughput analysis</li>
</ol>
<h3 id="queue-configuration">Queue Configuration</h3>
<table>
<thead>
<tr>
<th>Queue</th>
<th>Priority</th>
<th>Purpose</th>
<th>Timeout</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>webhooks</code></td>
<td>High</td>
<td>Webhook processing</td>
<td>60s</td>
</tr>
<tr>
<td><code>bookings</code></td>
<td>High</td>
<td>Appointment creation</td>
<td>120s</td>
</tr>
<tr>
<td><code>sync</code></td>
<td>Medium</td>
<td>Data synchronization</td>
<td>300s</td>
</tr>
<tr>
<td><code>notifications</code></td>
<td>Medium</td>
<td>Email/SMS sending</td>
<td>60s</td>
</tr>
<tr>
<td><code>default</code></td>
<td>Low</td>
<td>General processing</td>
<td>180s</td>
</tr>
</tbody>
</table>
<h2 id="complete-data-flow">üîÑ Complete Data Flow</h2>
<pre><code class="language-mermaid">flowchart TD
    Start([Customer calls +493083793369])

    Start --&gt; Retell[Retell.ai answers call]
    Retell --&gt; Collect[Agent collects:&lt;br/&gt;- Name&lt;br/&gt;- Date/Time&lt;br/&gt;- Service]

    Collect --&gt; Confirm{Booking&lt;br/&gt;Confirmed?}
    Confirm --&gt;|No| End1[Call ends&lt;br/&gt;No booking]
    Confirm --&gt;|Yes| Webhook[Webhook sent to&lt;br/&gt;/api/mcp/retell/webhook]

    Webhook --&gt; Verify{Signature&lt;br/&gt;Valid?}
    Verify --&gt;|No| Reject[401 Unauthorized]
    Verify --&gt;|Yes| WebhookMCP[WebhookMCPServer]

    WebhookMCP --&gt; PhoneRes[Phone Resolution]
    PhoneRes --&gt; Branch[Find Branch]
    Branch --&gt; Customer[Create/Find Customer]
    Customer --&gt; CallRecord[Create Call Record]

    CallRecord --&gt; CheckBooking{Should&lt;br/&gt;Book?}
    CheckBooking --&gt;|No| End2[Process complete&lt;br/&gt;No appointment]
    CheckBooking --&gt;|Yes| CalcomMCP[CalcomMCPServer]

    CalcomMCP --&gt; Circuit{Circuit&lt;br/&gt;Open?}
    Circuit --&gt;|Yes| Fallback[Return error&lt;br/&gt;Manual intervention]
    Circuit --&gt;|No| CheckCache{In&lt;br/&gt;Cache?}

    CheckCache --&gt;|Yes| Cached[Return cached booking]
    CheckCache --&gt;|No| CalAPI[Cal.com API]

    CalAPI --&gt;|Success| CreateLocal[Create local&lt;br/&gt;appointment record]
    CalAPI --&gt;|Error| Retry{Retry&lt;br/&gt;Count?}

    Retry --&gt;|&lt; 3| CalAPI
    Retry --&gt;|&gt;= 3| Failed[Log failure&lt;br/&gt;Alert team]

    CreateLocal --&gt; UpdateCall[Update call with&lt;br/&gt;appointment_id]
    UpdateCall --&gt; Success([‚úÖ Booking Complete])

    Cached --&gt; Success

    style Start fill:#f9f,stroke:#333,stroke-width:4px
    style Success fill:#9f9,stroke:#333,stroke-width:4px
    style Reject fill:#f99,stroke:#333,stroke-width:2px
    style Failed fill:#f99,stroke:#333,stroke-width:2px
    style WebhookMCP fill:#667eea,stroke:#fff,stroke-width:4px,color:#fff
    style CalcomMCP fill:#48bb78,stroke:#333,stroke-width:2px
</code></pre>
<h2 id="error-handling-resilience">üõ°Ô∏è Error Handling &amp; Resilience</h2>
<h3 id="circuit-breaker-pattern">Circuit Breaker Pattern</h3>
<p>The circuit breaker has three states:</p>
<ol>
<li><strong>CLOSED</strong> (Normal Operation)</li>
<li>All requests pass through</li>
<li>Failures are counted</li>
<li>
<p>Opens if threshold reached</p>
</li>
<li>
<p><strong>OPEN</strong> (Service Down)</p>
</li>
<li>Requests fail immediately</li>
<li>No load on failing service</li>
<li>
<p>Waits for timeout period</p>
</li>
<li>
<p><strong>HALF_OPEN</strong> (Testing Recovery)</p>
</li>
<li>Allows limited test requests</li>
<li>Closes if successful</li>
<li>Re-opens if still failing</li>
</ol>
<h3 id="retry-strategy">Retry Strategy</h3>
<pre><code class="language-php">$maxRetries = 3;
$retryDelay = 1; // seconds
// Exponential backoff: 1s, 2s, 4s

for ($attempt = 1; $attempt &lt;= $maxRetries; $attempt++) {
    try {
        return $this-&gt;makeApiCall($params);
    } catch (Exception $e) {
        if ($attempt === $maxRetries) {
            throw $e;
        }
        sleep($retryDelay * pow(2, $attempt - 1));
    }
}
</code></pre>
<h2 id="caching-strategy">üíæ Caching Strategy</h2>
<h3 id="cache-layers">Cache Layers</h3>
<ol>
<li><strong>L1 - Memory Cache</strong>: In-process array cache (50MB limit)</li>
<li><strong>L2 - Redis Cache</strong>: Distributed cache for all servers</li>
<li><strong>L3 - Database Cache</strong>: Persistent cache for critical data</li>
</ol>
<h3 id="cache-keys-ttl">Cache Keys &amp; TTL</h3>
<table>
<thead>
<tr>
<th>Key Pattern</th>
<th>TTL</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>mcp:calcom:event_types:{company_id}</code></td>
<td>5 min</td>
<td>Event type list</td>
</tr>
<tr>
<td><code>mcp:calcom:availability:{event}:{date}</code></td>
<td>5 min</td>
<td>Availability slots</td>
</tr>
<tr>
<td><code>mcp:calcom:booking:{idempotency_key}</code></td>
<td>24h</td>
<td>Prevent duplicates</td>
</tr>
<tr>
<td><code>mcp:retell:agents:{company_id}</code></td>
<td>10 min</td>
<td>Agent configurations</td>
</tr>
<tr>
<td><code>mcp:phone:resolution:{number}</code></td>
<td>10 min</td>
<td>Phone lookups</td>
</tr>
</tbody>
</table>
<h2 id="monitoring-metrics">üìä Monitoring &amp; Metrics</h2>
<h3 id="key-metrics-tracked">Key Metrics Tracked</h3>
<pre><code class="language-yaml"># Prometheus metrics available at /api/metrics

# MCP specific metrics
mcp_webhook_total{status=&quot;success|failure&quot;}
mcp_booking_total{status=&quot;created|failed|cached&quot;}
mcp_circuit_breaker_state{service=&quot;calcom|retell&quot;}
mcp_cache_hits_total{cache=&quot;l1|l2|l3&quot;}
mcp_api_duration_seconds{service=&quot;calcom|retell&quot;,method=&quot;*&quot;}

# Business metrics
appointments_created_total{source=&quot;phone|web|api&quot;}
calls_processed_total{outcome=&quot;booked|no_booking|failed&quot;}
customer_satisfaction_score{branch=&quot;*&quot;}
</code></pre>
<h3 id="debug-commands">Debug Commands</h3>
<pre><code class="language-bash"># Test webhook processing
php test-mcp-server-direct.php

# Check Cal.com availability
php test-calcom-availability.php

# Direct booking test
php test-direct-mcp-booking.php

# Monitor circuit breaker
php artisan circuit-breaker:status

# Clear MCP caches
php artisan cache:clear --tags=mcp
</code></pre>
<h2 id="security-considerations">üîí Security Considerations</h2>
<h3 id="webhook-verification">Webhook Verification</h3>
<ul>
<li>HMAC-SHA256 signature verification</li>
<li>Timestamp validation (5-minute window)</li>
<li>IP whitelisting (optional)</li>
<li>Rate limiting per webhook source</li>
</ul>
<h3 id="data-protection">Data Protection</h3>
<ul>
<li>All API keys encrypted at rest</li>
<li>Customer PII encryption available</li>
<li>Audit logging for all operations</li>
<li>GDPR compliance built-in</li>
</ul>
<h3 id="multi-tenancy">Multi-Tenancy</h3>
<ul>
<li>Company-level data isolation</li>
<li>Branch-level access control</li>
<li>Scoped queries automatic</li>
<li>Cross-tenant access prevention</li>
</ul>
<h2 id="performance-optimizations">‚ö° Performance Optimizations</h2>
<ol>
<li><strong>Connection Pooling</strong>: Reuse database/API connections</li>
<li><strong>Batch Operations</strong>: Group API calls when possible</li>
<li><strong>Async Processing</strong>: Non-blocking webhook handling</li>
<li><strong>Query Optimization</strong>: Indexed lookups, eager loading</li>
<li><strong>Response Compression</strong>: Gzip for API responses</li>
</ol>
<h2 id="known-limitations">üöß Known Limitations</h2>
<ol>
<li><strong>Hardcoded Team ID</strong>: Team 39203 for event 2563193 should be configurable</li>
<li><strong>No Automatic Retry UI</strong>: Failed bookings need manual intervention</li>
<li><strong>Single Redis Instance</strong>: No Redis clustering implemented yet</li>
<li><strong>Limited Horizontal Scaling</strong>: Not tested beyond single server</li>
</ol>
<h2 id="future-enhancements">üéØ Future Enhancements</h2>
<ul>
<li>[ ] Implement Redis Cluster support</li>
<li>[ ] Add automatic retry UI for failed bookings</li>
<li>[ ] Make team assignments configurable</li>
<li>[ ] Add GraphQL API support</li>
<li>[ ] Implement real-time booking updates via WebSockets</li>
<li>[ ] Add machine learning for optimal time slot suggestions</li>
</ul>
<hr />
<p>!!! success "Production Ready"
    The MCP system has been tested extensively and achieves <strong>99.3% success rate</strong> in production environments.</p>
<h2 id="mcp-first-architecture-evolution">üöÄ MCP-First Architecture Evolution</h2>
<p>!!! info "New MCP-First Specification"
    A comprehensive MCP-First technical specification has been created that extends the current architecture with complete UI abstraction and new configuration capabilities.</p>
<h3 id="new-mcp-servers-coming-soon">New MCP Servers Coming Soon</h3>
<ol>
<li><strong>RetellConfigurationMCPServer</strong></li>
<li>Manage all Retell.ai settings through UI</li>
<li>No direct API calls from frontend</li>
<li>Webhook configuration and testing</li>
<li>
<p>Custom function management</p>
</li>
<li>
<p><strong>RetellCustomFunctionMCPServer</strong></p>
</li>
<li>Handle custom function execution</li>
<li>Built-in appointment management functions</li>
<li>
<p>Gateway endpoint for Retell calls</p>
</li>
<li>
<p><strong>AppointmentManagementMCPServer</strong></p>
</li>
<li>Phone-based appointment modifications</li>
<li>Find, reschedule, and cancel appointments</li>
<li>Multi-language support</li>
</ol>
<h3 id="key-benefits-of-mcp-first-approach">Key Benefits of MCP-First Approach</h3>
<ul>
<li><strong>Complete Abstraction</strong>: UI never knows about external APIs</li>
<li><strong>Unified Protocol</strong>: All communication via JSON-RPC 2.0</li>
<li><strong>Enhanced Security</strong>: Single authentication point</li>
<li><strong>Better Testing</strong>: Mock MCP servers for all scenarios</li>
<li><strong>Easier Maintenance</strong>: Changes isolated to MCP layer</li>
</ul>
<h3 id="documentation">Documentation</h3>
<ul>
<li>Full specification: <code>/ASKPROAI_MCP_FIRST_TECHNICAL_SPECIFICATION_2025-06-23.md</code></li>
<li>Architecture diagrams: <code>/MCP_FIRST_ARCHITECTURE_DIAGRAM.md</code></li>
<li>Implementation summary: <code>/MCP_FIRST_SPECIFICATION_SUMMARY_2025-06-23.md</code></li>
</ul>
<h3 id="migration-timeline">Migration Timeline</h3>
<p>The MCP-First architecture will be implemented in 5 phases over 5 weeks:</p>
<ol>
<li><strong>Week 1</strong>: Infrastructure and Gateway</li>
<li><strong>Week 2</strong>: Retell Configuration</li>
<li><strong>Week 3</strong>: Custom Functions</li>
<li><strong>Week 4</strong>: Appointment Management</li>
<li><strong>Week 5</strong>: Testing and Documentation</li>
</ol>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../system-design/" class="btn btn-neutral float-left" title="System Design"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../database-schema/" class="btn btn-neutral float-right" title="Database Schema">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../system-design/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../database-schema/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://api.askproai.de/mkdocs/architecture/event-system/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Event System Architecture - AskProAI Dokumentation</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Event System Architecture";
        var mkdocs_page_input_path = "architecture/event-system.md";
        var mkdocs_page_url = "/mkdocs/architecture/event-system/";
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> AskProAI Dokumentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Start</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Hauptdokumentation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../CLAUDE/">Projekt Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../CLAUDE_QUICK_REFERENCE/">Quick Reference</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../CLAUDE_CONTEXT_SUMMARY/">Context Summary</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Power User</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../TOP_10_COMMANDS/">Top 10 Commands</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../CLAUDE_BEFEHLE_FUER_DICH/">Claude Befehle für dich</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../MY_COMMANDS/">Meine Commands</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Best Practices 2025</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../BEST_PRACTICES_IMPLEMENTATION/">Implementation Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../DEVELOPMENT_PROCESS_2025/">Development Process</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../CLAUDE_DOCUMENTATION_GAPS_ANALYSIS.md">Documentation Gaps</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Schnellstart</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../5-MINUTEN_ONBOARDING_PLAYBOOK/">5-Minuten Onboarding</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Architektur</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../overview/">Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../services/">Services</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../system-design/">System Design</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../mcp-architecture/">MCP Architecture</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../database-schema/">Database Schema</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../security/">Security</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../performance/">Performance</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../api/overview.md">Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/authentication/">Authentication</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../api/endpoints.md">Endpoints</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/webhooks/">Webhooks</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Features</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../features/appointment-booking/">Appointment Booking</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../features/call-management.md">Call Management</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../features/customer-portal.md">Customer Portal</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../features/multi-tenancy/">Multi-Tenancy</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Development</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../development/setup.md">Setup</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../development/testing.md">Testing</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../development/code-standards.md">Code Standards</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Deployment</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../deployment/overview.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../deployment/production.md">Production</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../deployment/environment-variables.md">Environment Variables</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Betrieb</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../CUSTOMER_SUCCESS_RUNBOOK/">Customer Success</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../EMERGENCY_RESPONSE_PLAYBOOK/">Emergency Response</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../ERROR_PATTERNS/">Error Patterns</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../TROUBLESHOOTING_DECISION_TREE/">Troubleshooting</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../DEPLOYMENT_CHECKLIST/">Deployment Checklist</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Monitoring</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../KPI_DASHBOARD_TEMPLATE/">KPI Dashboard</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../INTEGRATION_HEALTH_MONITOR/">Health Monitor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../PHONE_TO_APPOINTMENT_FLOW/">Phone to Appointment Flow</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">AskProAI Dokumentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
      <li>Event System Architecture</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="event-system-architecture">Event System Architecture</h1>
<h2 id="overview">Overview</h2>
<p>AskProAI uses Laravel's event system to implement an event-driven architecture. This enables loose coupling between components, better scalability, and comprehensive audit trails.</p>
<h2 id="event-architecture">Event Architecture</h2>
<pre><code class="language-mermaid">graph TB
    subgraph &quot;Event Sources&quot;
        MODEL[Model Events]
        API[API Actions]
        WEBHOOK[Webhooks]
        QUEUE[Queue Jobs]
    end

    subgraph &quot;Event Dispatcher&quot;
        DISPATCHER[Laravel Event Dispatcher]
        SYNC[Sync Listeners]
        ASYNC[Queued Listeners]
    end

    subgraph &quot;Event Handlers&quot;
        LOG[Audit Logger]
        NOTIFY[Notifier]
        ANALYTICS[Analytics]
        INTEGRATION[Integrations]
        CACHE[Cache Invalidator]
    end

    subgraph &quot;Side Effects&quot;
        DB[(Database)]
        REDIS[(Redis)]
        EMAIL[Email Service]
        SMS[SMS Service]
        CALCOM[Cal.com]
    end

    MODEL --&gt; DISPATCHER
    API --&gt; DISPATCHER
    WEBHOOK --&gt; DISPATCHER
    QUEUE --&gt; DISPATCHER

    DISPATCHER --&gt; SYNC
    DISPATCHER --&gt; ASYNC

    SYNC --&gt; LOG
    SYNC --&gt; CACHE
    ASYNC --&gt; NOTIFY
    ASYNC --&gt; ANALYTICS
    ASYNC --&gt; INTEGRATION

    LOG --&gt; DB
    CACHE --&gt; REDIS
    NOTIFY --&gt; EMAIL
    NOTIFY --&gt; SMS
    INTEGRATION --&gt; CALCOM
</code></pre>
<h2 id="core-events">Core Events</h2>
<h3 id="appointment-events">Appointment Events</h3>
<h4 id="appointmentcreated">AppointmentCreated</h4>
<pre><code class="language-php">namespace App\Events;

class AppointmentCreated
{
    use Dispatchable, InteractsWithSockets, SerializesModels;

    public function __construct(
        public Appointment $appointment,
        public ?string $source = null,
        public array $metadata = []
    ) {}

    public function broadcastOn()
    {
        return new PrivateChannel('company.' . $this-&gt;appointment-&gt;company_id);
    }

    public function broadcastAs()
    {
        return 'appointment.created';
    }

    public function broadcastWith()
    {
        return [
            'appointment' =&gt; new AppointmentResource($this-&gt;appointment),
            'source' =&gt; $this-&gt;source,
            'metadata' =&gt; $this-&gt;metadata,
        ];
    }
}
</code></pre>
<h4 id="appointmentupdated">AppointmentUpdated</h4>
<pre><code class="language-php">class AppointmentUpdated
{
    public function __construct(
        public Appointment $appointment,
        public array $changes,
        public ?User $updatedBy = null
    ) {}

    public function wasRescheduled(): bool
    {
        return isset($this-&gt;changes['start_time']) || 
               isset($this-&gt;changes['end_time']);
    }

    public function wasReassigned(): bool
    {
        return isset($this-&gt;changes['staff_id']);
    }
}
</code></pre>
<h3 id="customer-events">Customer Events</h3>
<h4 id="customercreated">CustomerCreated</h4>
<pre><code class="language-php">class CustomerCreated
{
    public function __construct(
        public Customer $customer,
        public string $source // 'phone', 'web', 'import', 'manual'
    ) {}
}
</code></pre>
<h4 id="customermerged">CustomerMerged</h4>
<pre><code class="language-php">class CustomerMerged
{
    public function __construct(
        public Customer $primaryCustomer,
        public Customer $mergedCustomer,
        public array $mergedData
    ) {}
}
</code></pre>
<h3 id="call-events">Call Events</h3>
<h4 id="callcompleted">CallCompleted</h4>
<pre><code class="language-php">class CallCompleted
{
    public function __construct(
        public Call $call,
        public array $analysis
    ) {}

    public function hasAppointmentRequest(): bool
    {
        return !empty($this-&gt;analysis['appointment_request']);
    }

    public function getSentiment(): string
    {
        return $this-&gt;analysis['sentiment'] ?? 'neutral';
    }
}
</code></pre>
<h2 id="event-listeners">Event Listeners</h2>
<h3 id="synchronous-listeners">Synchronous Listeners</h3>
<p>These run immediately in the same process.</p>
<h4 id="auditlogger">AuditLogger</h4>
<pre><code class="language-php">class AuditLogger
{
    public function handle($event)
    {
        if (!$event instanceof ShouldAudit) {
            return;
        }

        AuditLog::create([
            'event_type' =&gt; get_class($event),
            'model_type' =&gt; $event-&gt;getAuditableType(),
            'model_id' =&gt; $event-&gt;getAuditableId(),
            'user_id' =&gt; auth()-&gt;id(),
            'company_id' =&gt; $event-&gt;getCompanyId(),
            'data' =&gt; $event-&gt;getAuditData(),
            'ip_address' =&gt; request()-&gt;ip(),
            'user_agent' =&gt; request()-&gt;userAgent(),
        ]);
    }
}
</code></pre>
<h4 id="cacheinvalidator">CacheInvalidator</h4>
<pre><code class="language-php">class CacheInvalidator
{
    protected array $eventCacheMap = [
        AppointmentCreated::class =&gt; ['appointments', 'availability'],
        AppointmentUpdated::class =&gt; ['appointments', 'availability'],
        CustomerUpdated::class =&gt; ['customers'],
        StaffUpdated::class =&gt; ['staff', 'availability'],
    ];

    public function handle($event)
    {
        $eventClass = get_class($event);

        if (!isset($this-&gt;eventCacheMap[$eventClass])) {
            return;
        }

        $tags = $this-&gt;eventCacheMap[$eventClass];

        // Add company-specific tag
        if (method_exists($event, 'getCompanyId')) {
            $tags[] = 'company:' . $event-&gt;getCompanyId();
        }

        Cache::tags($tags)-&gt;flush();
    }
}
</code></pre>
<h3 id="queued-listeners">Queued Listeners</h3>
<p>These run asynchronously in the background.</p>
<h4 id="sendappointmentnotification">SendAppointmentNotification</h4>
<pre><code class="language-php">class SendAppointmentNotification implements ShouldQueue
{
    use InteractsWithQueue;

    public $queue = 'notifications';
    public $delay = 5; // 5 second delay

    public function handle(AppointmentCreated $event)
    {
        $appointment = $event-&gt;appointment;
        $customer = $appointment-&gt;customer;

        // Send SMS if enabled
        if ($customer-&gt;prefers_sms) {
            dispatch(new SendSMSJob(
                $customer-&gt;phone,
                $this-&gt;buildSMSMessage($appointment)
            ));
        }

        // Send email if enabled
        if ($customer-&gt;email &amp;&amp; $customer-&gt;prefers_email) {
            Mail::to($customer-&gt;email)
                -&gt;queue(new AppointmentConfirmation($appointment));
        }

        // Send WhatsApp if enabled
        if ($customer-&gt;prefers_whatsapp) {
            dispatch(new SendWhatsAppJob(
                $customer-&gt;phone,
                $this-&gt;buildWhatsAppMessage($appointment)
            ));
        }
    }

    public function failed(AppointmentCreated $event, \Throwable $exception)
    {
        Log::error('Failed to send appointment notification', [
            'appointment_id' =&gt; $event-&gt;appointment-&gt;id,
            'error' =&gt; $exception-&gt;getMessage(),
        ]);
    }
}
</code></pre>
<h4 id="updateanalytics">UpdateAnalytics</h4>
<pre><code class="language-php">class UpdateAnalytics implements ShouldQueue
{
    use InteractsWithQueue;

    public $queue = 'analytics';

    public function handle($event)
    {
        match(true) {
            $event instanceof AppointmentCreated =&gt; $this-&gt;trackAppointmentCreated($event),
            $event instanceof CallCompleted =&gt; $this-&gt;trackCallCompleted($event),
            $event instanceof CustomerCreated =&gt; $this-&gt;trackCustomerCreated($event),
            default =&gt; null
        };
    }

    private function trackAppointmentCreated(AppointmentCreated $event)
    {
        Analytics::track('appointment.created', [
            'company_id' =&gt; $event-&gt;appointment-&gt;company_id,
            'branch_id' =&gt; $event-&gt;appointment-&gt;branch_id,
            'service_id' =&gt; $event-&gt;appointment-&gt;service_id,
            'source' =&gt; $event-&gt;source,
            'value' =&gt; $event-&gt;appointment-&gt;service-&gt;price,
            'lead_time' =&gt; $event-&gt;appointment-&gt;start_time-&gt;diffInHours(now()),
        ]);
    }
}
</code></pre>
<h4 id="syncwithexternalservices">SyncWithExternalServices</h4>
<pre><code class="language-php">class SyncWithExternalServices implements ShouldQueue
{
    use InteractsWithQueue;

    public $tries = 5;
    public $backoff = [10, 30, 60, 120, 300];

    public function handle($event)
    {
        if ($event instanceof AppointmentCreated) {
            $this-&gt;syncAppointmentToCalcom($event-&gt;appointment);
            $this-&gt;syncAppointmentToCRM($event-&gt;appointment);
        }

        if ($event instanceof CustomerUpdated) {
            $this-&gt;syncCustomerToCRM($event-&gt;customer);
        }
    }

    private function syncAppointmentToCalcom(Appointment $appointment)
    {
        try {
            app(CalcomV2Service::class)-&gt;syncAppointment($appointment);
        } catch (CalcomException $e) {
            Log::error('Cal.com sync failed', [
                'appointment_id' =&gt; $appointment-&gt;id,
                'error' =&gt; $e-&gt;getMessage(),
            ]);
            throw $e; // Retry
        }
    }
}
</code></pre>
<h2 id="event-subscribers">Event Subscribers</h2>
<p>Event subscribers group related event handlers.</p>
<h3 id="appointmenteventsubscriber">AppointmentEventSubscriber</h3>
<pre><code class="language-php">class AppointmentEventSubscriber
{
    public function subscribe(Dispatcher $events): void
    {
        $events-&gt;listen(
            AppointmentCreated::class,
            [self::class, 'handleAppointmentCreated']
        );

        $events-&gt;listen(
            AppointmentUpdated::class,
            [self::class, 'handleAppointmentUpdated']
        );

        $events-&gt;listen(
            AppointmentCancelled::class,
            [self::class, 'handleAppointmentCancelled']
        );
    }

    public function handleAppointmentCreated(AppointmentCreated $event): void
    {
        // Update staff availability
        $this-&gt;updateStaffAvailability($event-&gt;appointment);

        // Update branch statistics
        $this-&gt;updateBranchStats($event-&gt;appointment-&gt;branch_id);

        // Create follow-up reminders
        $this-&gt;scheduleReminders($event-&gt;appointment);
    }

    public function handleAppointmentUpdated(AppointmentUpdated $event): void
    {
        if ($event-&gt;wasRescheduled()) {
            // Clear old time slot
            $this-&gt;clearOldTimeSlot($event-&gt;appointment, $event-&gt;changes);

            // Notify affected parties
            $this-&gt;notifyRescheduling($event-&gt;appointment);
        }
    }
}
</code></pre>
<h2 id="event-sourcing">Event Sourcing</h2>
<p>For critical business events, we store the complete event history.</p>
<h3 id="event-store">Event Store</h3>
<pre><code class="language-php">Schema::create('event_store', function (Blueprint $table) {
    $table-&gt;id();
    $table-&gt;string('aggregate_id');
    $table-&gt;string('aggregate_type');
    $table-&gt;integer('version');
    $table-&gt;string('event_type');
    $table-&gt;json('event_data');
    $table-&gt;json('metadata');
    $table-&gt;timestamp('occurred_at');
    $table-&gt;index(['aggregate_id', 'aggregate_type']);
    $table-&gt;index('event_type');
    $table-&gt;index('occurred_at');
});
</code></pre>
<h3 id="storing-events">Storing Events</h3>
<pre><code class="language-php">class EventStore
{
    public function store(DomainEvent $event): void
    {
        DB::table('event_store')-&gt;insert([
            'aggregate_id' =&gt; $event-&gt;getAggregateId(),
            'aggregate_type' =&gt; $event-&gt;getAggregateType(),
            'version' =&gt; $event-&gt;getVersion(),
            'event_type' =&gt; get_class($event),
            'event_data' =&gt; json_encode($event-&gt;toArray()),
            'metadata' =&gt; json_encode($event-&gt;getMetadata()),
            'occurred_at' =&gt; $event-&gt;occurredAt(),
        ]);
    }

    public function getEvents(string $aggregateId, string $aggregateType): Collection
    {
        return DB::table('event_store')
            -&gt;where('aggregate_id', $aggregateId)
            -&gt;where('aggregate_type', $aggregateType)
            -&gt;orderBy('version')
            -&gt;get()
            -&gt;map(fn($row) =&gt; $this-&gt;deserialize($row));
    }
}
</code></pre>
<h2 id="event-driven-workflows">Event-Driven Workflows</h2>
<h3 id="appointment-booking-workflow">Appointment Booking Workflow</h3>
<pre><code class="language-mermaid">sequenceDiagram
    participant Customer
    participant API
    participant EventBus
    participant Listeners
    participant Services

    Customer-&gt;&gt;API: Book Appointment
    API-&gt;&gt;API: Validate &amp; Create
    API-&gt;&gt;EventBus: Dispatch AppointmentCreated

    EventBus-&gt;&gt;Listeners: AuditLogger (sync)
    EventBus-&gt;&gt;Listeners: CacheInvalidator (sync)
    EventBus-&gt;&gt;Listeners: SendNotification (async)
    EventBus-&gt;&gt;Listeners: SyncCalcom (async)
    EventBus-&gt;&gt;Listeners: UpdateAnalytics (async)

    Listeners-&gt;&gt;Services: Process
    Services--&gt;&gt;Customer: SMS/Email Confirmation
</code></pre>
<h3 id="call-processing-workflow">Call Processing Workflow</h3>
<pre><code class="language-mermaid">stateDiagram-v2
    [*] --&gt; CallStarted: Incoming Call
    CallStarted --&gt; CallInProgress: Connected
    CallInProgress --&gt; CallEnded: Hangup

    CallEnded --&gt; CallAnalyzed: AI Processing
    CallAnalyzed --&gt; AppointmentRequested: Booking Intent
    CallAnalyzed --&gt; InformationOnly: No Booking

    AppointmentRequested --&gt; AppointmentCreated: Slot Available
    AppointmentRequested --&gt; AppointmentFailed: No Availability

    AppointmentCreated --&gt; NotificationSent: Send Confirmation
    NotificationSent --&gt; [*]

    InformationOnly --&gt; [*]
    AppointmentFailed --&gt; FollowUpScheduled: Alternative Options
    FollowUpScheduled --&gt; [*]
</code></pre>
<h2 id="testing-events">Testing Events</h2>
<h3 id="unit-testing-events">Unit Testing Events</h3>
<pre><code class="language-php">class AppointmentEventTest extends TestCase
{
    public function test_appointment_created_event_has_correct_data()
    {
        $appointment = Appointment::factory()-&gt;create();

        $event = new AppointmentCreated($appointment, 'api', ['user_id' =&gt; 1]);

        $this-&gt;assertEquals($appointment-&gt;id, $event-&gt;appointment-&gt;id);
        $this-&gt;assertEquals('api', $event-&gt;source);
        $this-&gt;assertArrayHasKey('user_id', $event-&gt;metadata);
    }
}
</code></pre>
<h3 id="testing-event-listeners">Testing Event Listeners</h3>
<pre><code class="language-php">class NotificationListenerTest extends TestCase
{
    public function test_notification_sent_on_appointment_created()
    {
        Event::fake([AppointmentCreated::class]);

        $appointment = Appointment::factory()-&gt;create();

        event(new AppointmentCreated($appointment));

        Event::assertDispatched(AppointmentCreated::class, function ($event) use ($appointment) {
            return $event-&gt;appointment-&gt;id === $appointment-&gt;id;
        });

        Event::assertListening(
            AppointmentCreated::class,
            SendAppointmentNotification::class
        );
    }
}
</code></pre>
<h2 id="event-monitoring">Event Monitoring</h2>
<h3 id="event-metrics">Event Metrics</h3>
<pre><code class="language-php">class EventMetricsCollector
{
    public function collectMetrics(): array
    {
        return [
            'events_per_minute' =&gt; $this-&gt;getEventRate(),
            'event_types' =&gt; $this-&gt;getEventTypeDistribution(),
            'failed_listeners' =&gt; $this-&gt;getFailedListeners(),
            'processing_time' =&gt; $this-&gt;getAverageProcessingTime(),
            'queue_depth' =&gt; $this-&gt;getEventQueueDepth(),
        ];
    }
}
</code></pre>
<h3 id="event-dashboard">Event Dashboard</h3>
<p>Monitor events in real-time:</p>
<pre><code class="language-php">Route::get('/admin/events/dashboard', function () {
    return view('admin.events.dashboard', [
        'recentEvents' =&gt; EventStore::recent(100),
        'eventStats' =&gt; app(EventMetricsCollector::class)-&gt;collectMetrics(),
        'failedEvents' =&gt; FailedEvent::recent(50),
    ]);
});
</code></pre>
<h2 id="best-practices">Best Practices</h2>
<ol>
<li><strong>Event Naming</strong>: Use past tense (AppointmentCreated, not CreateAppointment)</li>
<li><strong>Event Data</strong>: Include all relevant data, events should be self-contained</li>
<li><strong>Idempotency</strong>: Listeners should handle duplicate events gracefully</li>
<li><strong>Error Handling</strong>: Failed listeners shouldn't break the main flow</li>
<li><strong>Performance</strong>: Use queued listeners for heavy processing</li>
<li><strong>Testing</strong>: Always test events and their listeners</li>
<li><strong>Monitoring</strong>: Track event metrics and failures</li>
</ol>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>

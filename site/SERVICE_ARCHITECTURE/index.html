<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://api.askproai.de/mkdocs/SERVICE_ARCHITECTURE/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>AskProAI Service Architecture Documentation - AskProAI Dokumentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "AskProAI Service Architecture Documentation";
        var mkdocs_page_input_path = "SERVICE_ARCHITECTURE.md";
        var mkdocs_page_url = "/mkdocs/SERVICE_ARCHITECTURE/";
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> AskProAI Dokumentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Start</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Hauptdokumentation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../CLAUDE/">Projekt Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../CLAUDE_QUICK_REFERENCE/">Quick Reference</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../CLAUDE_CONTEXT_SUMMARY/">Context Summary</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Power User</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../TOP_10_COMMANDS/">Top 10 Commands</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../CLAUDE_BEFEHLE_FUER_DICH/">Claude Befehle für dich</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../MY_COMMANDS/">Meine Commands</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Best Practices 2025</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../BEST_PRACTICES_IMPLEMENTATION/">Implementation Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../DEVELOPMENT_PROCESS_2025/">Development Process</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../CLAUDE_DOCUMENTATION_GAPS_ANALYSIS.md">Documentation Gaps</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Schnellstart</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../5-MINUTEN_ONBOARDING_PLAYBOOK/">5-Minuten Onboarding</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Architektur</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../architecture/overview/">Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../architecture/services/">Services</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../architecture/system-design/">System Design</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../architecture/mcp-architecture/">MCP Architecture</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../architecture/database-schema/">Database Schema</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../architecture/security/">Security</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../architecture/performance/">Performance</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../api/overview.md">Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../api/authentication/">Authentication</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../api/endpoints.md">Endpoints</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../api/webhooks/">Webhooks</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Features</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../features/appointment-booking/">Appointment Booking</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../features/call-management.md">Call Management</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../features/customer-portal.md">Customer Portal</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../features/multi-tenancy/">Multi-Tenancy</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Development</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../development/setup.md">Setup</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../development/testing.md">Testing</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../development/code-standards.md">Code Standards</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Deployment</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../deployment/overview.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../deployment/production.md">Production</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../deployment/environment-variables.md">Environment Variables</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Betrieb</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../CUSTOMER_SUCCESS_RUNBOOK/">Customer Success</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../EMERGENCY_RESPONSE_PLAYBOOK/">Emergency Response</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../ERROR_PATTERNS/">Error Patterns</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../TROUBLESHOOTING_DECISION_TREE/">Troubleshooting</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../DEPLOYMENT_CHECKLIST/">Deployment Checklist</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Monitoring</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../KPI_DASHBOARD_TEMPLATE/">KPI Dashboard</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../INTEGRATION_HEALTH_MONITOR/">Health Monitor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../PHONE_TO_APPOINTMENT_FLOW/">Phone to Appointment Flow</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">AskProAI Dokumentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
      <li>AskProAI Service Architecture Documentation</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="askproai-service-architecture-documentation">AskProAI Service Architecture Documentation</h1>
<p><em>Last Updated: 2025-06-17</em></p>
<h2 id="overview">Overview</h2>
<p>This document provides a comprehensive overview of all service classes in the AskProAI platform, their responsibilities, and how they interact.</p>
<h2 id="service-categories">Service Categories</h2>
<h3 id="1-calendar-integration-services-calcom">1. Calendar Integration Services (Cal.com)</h3>
<h4 id="calcomservicephp">CalcomService.php</h4>
<ul>
<li><strong>Purpose</strong>: Primary V1 API integration with Cal.com</li>
<li><strong>Key Methods</strong>: </li>
<li><code>createBooking()</code> - Creates appointments in Cal.com</li>
<li><code>getAvailability()</code> - Checks available time slots</li>
<li><code>getEventTypes()</code> - Retrieves available event types</li>
<li><strong>Used By</strong>: ProcessRetellCallEndedJob, CalendarProviderFactory</li>
<li><strong>Status</strong>: Active, will be migrated to V2</li>
</ul>
<h4 id="calcomv2servicephp-recommended">CalcomV2Service.php ⭐ [RECOMMENDED]</h4>
<ul>
<li><strong>Purpose</strong>: Modern V2 API integration with Cal.com</li>
<li><strong>Key Methods</strong>:</li>
<li><code>getEventTypes()</code> - Retrieves event types with enhanced data</li>
<li><code>getAvailableSlots()</code> - Advanced availability checking</li>
<li><code>createBooking()</code> - Creates bookings with V2 features</li>
<li><code>getBookings()</code> - Retrieves booking list</li>
<li><strong>Used By</strong>: CalcomApiTest, future implementations</li>
<li><strong>Status</strong>: Active, target for all new features</li>
</ul>
<h4 id="calcomimportservicephp">CalcomImportService.php</h4>
<ul>
<li><strong>Purpose</strong>: Imports event types from Cal.com to local database</li>
<li><strong>Key Methods</strong>:</li>
<li><code>importEventTypes()</code> - Bulk import of event types</li>
<li><code>mapEventTypeData()</code> - Maps Cal.com data to local models</li>
<li><strong>Used By</strong>: ImportCalcomEventTypesController, Admin UI</li>
<li><strong>Status</strong>: Critical for onboarding</li>
</ul>
<h4 id="calcomsyncservicephp">CalcomSyncService.php</h4>
<ul>
<li><strong>Purpose</strong>: Synchronizes data between Cal.com and local database</li>
<li><strong>Key Methods</strong>:</li>
<li><code>checkAvailability()</code> - Real-time availability checks</li>
<li><code>syncBookings()</code> - Two-way booking synchronization</li>
<li><code>updateEventType()</code> - Syncs event type changes</li>
<li><strong>Used By</strong>: Multiple controllers, background jobs</li>
<li><strong>Status</strong>: Critical for real-time operations</li>
</ul>
<h4 id="calcomeventtypesyncservicephp">CalcomEventTypeSyncService.php</h4>
<ul>
<li><strong>Purpose</strong>: Specialized service for event type synchronization</li>
<li><strong>Key Methods</strong>:</li>
<li><code>syncEventTypesForCompany()</code> - Company-wide sync</li>
<li><code>validateApiKey()</code> - API key validation</li>
<li><code>fetchEventTypes()</code> - Retrieves and caches event types</li>
<li><strong>Used By</strong>: CompanyResource, setup wizards</li>
<li><strong>Status</strong>: Essential for multi-tenant operations</li>
</ul>
<h4 id="calcomv2migrationservicephp">CalcomV2MigrationService.php</h4>
<ul>
<li><strong>Purpose</strong>: Handles migration from V1 to V2 API</li>
<li><strong>Key Methods</strong>:</li>
<li><code>migrateEventTypes()</code> - Converts V1 event types to V2</li>
<li><code>migrateBookings()</code> - Updates booking format</li>
<li><strong>Used By</strong>: Registered in AppServiceProvider</li>
<li><strong>Status</strong>: Transition service</li>
</ul>
<h3 id="2-phone-ai-services-retellai">2. Phone AI Services (Retell.ai)</h3>
<h4 id="retellservicephp">RetellService.php</h4>
<ul>
<li><strong>Purpose</strong>: Primary integration with Retell.ai</li>
<li><strong>Key Methods</strong>:</li>
<li><code>createCall()</code> - Initiates AI phone calls</li>
<li><code>updateCall()</code> - Updates call status</li>
<li><code>getCallDetails()</code> - Retrieves call information</li>
<li><strong>Used By</strong>: RetellWebhookController, various commands</li>
<li><strong>Status</strong>: Active, being migrated to V2</li>
</ul>
<h4 id="retellv2servicephp-recommended">RetellV2Service.php ⭐ [RECOMMENDED]</h4>
<ul>
<li><strong>Purpose</strong>: Enhanced V2 integration with Retell.ai</li>
<li><strong>Key Methods</strong>:</li>
<li><code>handleWebhook()</code> - Processes all webhook events</li>
<li><code>processCallEnded()</code> - Handles completed calls</li>
<li><code>extractAppointmentData()</code> - AI data extraction</li>
<li><strong>Used By</strong>: ProcessRetellCallEndedJob</li>
<li><strong>Status</strong>: Active, target for new features</li>
</ul>
<h4 id="retellagentservicephp">RetellAgentService.php</h4>
<ul>
<li><strong>Purpose</strong>: Manages AI agents configuration</li>
<li><strong>Key Methods</strong>:</li>
<li><code>createAgent()</code> - Creates new AI agents</li>
<li><code>updateAgent()</code> - Updates agent settings</li>
<li><code>assignAgentToBranch()</code> - Branch-agent mapping</li>
<li><strong>Used By</strong>: BranchResource</li>
<li><strong>Status</strong>: Critical for multi-branch setup</li>
</ul>
<h3 id="3-core-business-services">3. Core Business Services</h3>
<h4 id="appointmentbookingservicephp-primary">AppointmentBookingService.php ⭐ [PRIMARY]</h4>
<ul>
<li><strong>Purpose</strong>: Central orchestrator for appointment bookings</li>
<li><strong>Key Methods</strong>:</li>
<li><code>bookAppointment()</code> - Complete booking flow</li>
<li><code>checkAvailability()</code> - Unified availability checking</li>
<li><code>confirmBooking()</code> - Booking confirmation process</li>
<li><strong>Used By</strong>: Webhooks, API controllers, jobs</li>
<li><strong>Status</strong>: Primary booking service</li>
</ul>
<h4 id="smartbookingservicephp">SmartBookingService.php 🆕</h4>
<ul>
<li><strong>Purpose</strong>: AI-enhanced booking with smart features</li>
<li><strong>Key Methods</strong>:</li>
<li><code>handleIncomingCall()</code> - End-to-end call processing</li>
<li><code>findBestSlot()</code> - AI-powered slot recommendation</li>
<li><code>autoReschedule()</code> - Intelligent rescheduling</li>
<li><strong>Used By</strong>: Future AI features</li>
<li><strong>Status</strong>: Next-generation service</li>
</ul>
<h4 id="phonenumberresolverphp">PhoneNumberResolver.php</h4>
<ul>
<li><strong>Purpose</strong>: Maps phone numbers to companies/branches</li>
<li><strong>Key Methods</strong>:</li>
<li><code>resolveBranch()</code> - Phone to branch mapping</li>
<li><code>resolveCompany()</code> - Phone to company mapping</li>
<li><code>cacheResolution()</code> - Performance optimization</li>
<li><strong>Used By</strong>: All incoming call handlers</li>
<li><strong>Status</strong>: Critical for multi-tenancy</li>
</ul>
<h4 id="calldatarefresherphp">CallDataRefresher.php</h4>
<ul>
<li><strong>Purpose</strong>: Updates call data from Retell.ai</li>
<li><strong>Key Methods</strong>:</li>
<li><code>refreshCallData()</code> - Updates call information</li>
<li><code>syncTranscripts()</code> - Retrieves call transcripts</li>
<li><code>updateCallMetrics()</code> - Analytics data update</li>
<li><strong>Used By</strong>: Background jobs, admin UI</li>
<li><strong>Status</strong>: Essential for call tracking</li>
</ul>
<h3 id="4-communication-services">4. Communication Services</h3>
<h4 id="notificationservicephp">NotificationService.php</h4>
<ul>
<li><strong>Purpose</strong>: Handles all notifications (email, SMS, WhatsApp)</li>
<li><strong>Key Methods</strong>:</li>
<li><code>sendAppointmentConfirmation()</code> - Booking confirmations</li>
<li><code>sendReminder()</code> - Appointment reminders</li>
<li><code>sendCancellation()</code> - Cancellation notices</li>
<li><strong>Used By</strong>: All booking-related processes</li>
<li><strong>Status</strong>: Active, SMS/WhatsApp pending</li>
</ul>
<h4 id="emailservicephp">EmailService.php</h4>
<ul>
<li><strong>Purpose</strong>: Email-specific functionality</li>
<li><strong>Key Methods</strong>:</li>
<li><code>sendTransactionalEmail()</code> - Transactional emails</li>
<li><code>sendBulkEmail()</code> - Marketing emails</li>
<li><code>trackEmailStatus()</code> - Delivery tracking</li>
<li><strong>Used By</strong>: NotificationService</li>
<li><strong>Status</strong>: Fully functional</li>
</ul>
<h3 id="5-payment-billing-services">5. Payment &amp; Billing Services</h3>
<h4 id="stripeservicephp">StripeService.php</h4>
<ul>
<li><strong>Purpose</strong>: Stripe payment integration</li>
<li><strong>Key Methods</strong>:</li>
<li><code>createCustomer()</code> - Customer management</li>
<li><code>createSubscription()</code> - Subscription handling</li>
<li><code>processPayment()</code> - Payment processing</li>
<li><strong>Used By</strong>: Billing controllers</li>
<li><strong>Status</strong>: Basic implementation</li>
</ul>
<h4 id="pricingservicephp">PricingService.php</h4>
<ul>
<li><strong>Purpose</strong>: Dynamic pricing calculations</li>
<li><strong>Key Methods</strong>:</li>
<li><code>calculatePrice()</code> - Price computation</li>
<li><code>applyDiscounts()</code> - Discount logic</li>
<li><code>getTierPricing()</code> - Tiered pricing</li>
<li><strong>Used By</strong>: Quote generation</li>
<li><strong>Status</strong>: Ready for expansion</li>
</ul>
<h2 id="service-interaction-patterns">Service Interaction Patterns</h2>
<h3 id="appointment-booking-flow">Appointment Booking Flow</h3>
<pre><code>1. RetellWebhookController receives call
   ↓
2. PhoneNumberResolver identifies branch
   ↓
3. RetellV2Service processes call data
   ↓
4. AppointmentBookingService orchestrates:
   - CalcomSyncService checks availability
   - Customer creation/lookup
   - CalcomV2Service creates booking
   ↓
5. NotificationService sends confirmation
</code></pre>
<h3 id="event-type-synchronization">Event Type Synchronization</h3>
<pre><code>1. Admin triggers sync in UI
   ↓
2. CalcomEventTypeSyncService fetches from Cal.com
   ↓
3. CalcomImportService imports to database
   ↓
4. Staff assignments updated
   ↓
5. Cache refreshed
</code></pre>
<h2 id="best-practices">Best Practices</h2>
<ol>
<li><strong>Use V2 Services</strong>: Prefer CalcomV2Service and RetellV2Service for new features</li>
<li><strong>Service Boundaries</strong>: Keep services focused on single responsibility</li>
<li><strong>Error Handling</strong>: All services should implement comprehensive error handling</li>
<li><strong>Logging</strong>: Use structured logging for debugging</li>
<li><strong>Caching</strong>: Implement caching for frequently accessed data</li>
<li><strong>Testing</strong>: Each service should have corresponding tests</li>
</ol>
<h2 id="migration-roadmap">Migration Roadmap</h2>
<h3 id="short-term-1-2-weeks">Short Term (1-2 weeks)</h3>
<ul>
<li>Complete migration from CalcomService to CalcomV2Service</li>
<li>Unify RetellService and RetellV2Service</li>
<li>Implement comprehensive logging</li>
</ul>
<h3 id="medium-term-1-month">Medium Term (1 month)</h3>
<ul>
<li>Add SMS/WhatsApp to NotificationService</li>
<li>Enhance StripeService for full billing</li>
<li>Build automated agent provisioning</li>
</ul>
<h3 id="long-term-3-months">Long Term (3 months)</h3>
<ul>
<li>Implement SmartBookingService AI features</li>
<li>Add multi-language support</li>
<li>Build customer self-service portal</li>
</ul>
<h2 id="monitoring-maintenance">Monitoring &amp; Maintenance</h2>
<ul>
<li>All services log to <code>/storage/logs/services/</code></li>
<li>Performance metrics tracked in database</li>
<li>Health checks available via <code>/api/health</code></li>
<li>Service status dashboard in admin panel</li>
</ul>
<hr />
<p>For questions or updates to this documentation, contact: dev@askproai.de</p>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>

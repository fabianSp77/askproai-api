<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://api.askproai.de/mkdocs/docs/deployment/backup/" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>Backup and Recovery Guide - AskProAI Dokumentation</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Backup and Recovery Guide";
        var mkdocs_page_input_path = "docs/deployment/backup.md";
        var mkdocs_page_url = "/mkdocs/docs/deployment/backup/";
      </script>
    
    <script src="../../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> AskProAI Dokumentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Start</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Hauptdokumentation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../CLAUDE/">Projekt Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../CLAUDE_QUICK_REFERENCE/">Quick Reference</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../CLAUDE_CONTEXT_SUMMARY/">Context Summary</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Power User</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../TOP_10_COMMANDS/">Top 10 Commands</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../CLAUDE_BEFEHLE_FUER_DICH/">Claude Befehle für dich</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../MY_COMMANDS/">Meine Commands</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Best Practices 2025</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../BEST_PRACTICES_IMPLEMENTATION/">Implementation Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../DEVELOPMENT_PROCESS_2025/">Development Process</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../CLAUDE_DOCUMENTATION_GAPS_ANALYSIS.md">Documentation Gaps</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Schnellstart</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../5-MINUTEN_ONBOARDING_PLAYBOOK/">5-Minuten Onboarding</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Architektur</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/overview/">Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/services/">Services</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/system-design/">System Design</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/mcp-architecture/">MCP Architecture</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/database-schema/">Database Schema</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/security/">Security</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/performance/">Performance</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../../api/overview.md">Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../api/authentication/">Authentication</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../api/endpoints.md">Endpoints</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../api/webhooks/">Webhooks</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Features</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../features/appointment-booking/">Appointment Booking</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../features/call-management.md">Call Management</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../features/customer-portal.md">Customer Portal</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../features/multi-tenancy/">Multi-Tenancy</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Development</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../../development/setup.md">Setup</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../development/testing.md">Testing</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../development/code-standards.md">Code Standards</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Deployment</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../../deployment/overview.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../deployment/production.md">Production</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../deployment/environment-variables.md">Environment Variables</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Betrieb</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../CUSTOMER_SUCCESS_RUNBOOK/">Customer Success</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../EMERGENCY_RESPONSE_PLAYBOOK/">Emergency Response</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../ERROR_PATTERNS/">Error Patterns</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../TROUBLESHOOTING_DECISION_TREE/">Troubleshooting</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../DEPLOYMENT_CHECKLIST/">Deployment Checklist</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Monitoring</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../KPI_DASHBOARD_TEMPLATE/">KPI Dashboard</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../INTEGRATION_HEALTH_MONITOR/">Health Monitor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../PHONE_TO_APPOINTMENT_FLOW/">Phone to Appointment Flow</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">AskProAI Dokumentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
      <li>Backup and Recovery Guide</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="backup-and-recovery-guide">Backup and Recovery Guide</h1>
<h2 id="overview">Overview</h2>
<p>This guide covers backup strategies, implementation, and recovery procedures for AskProAI. A robust backup strategy is critical for business continuity and disaster recovery.</p>
<h2 id="backup-strategy">Backup Strategy</h2>
<h3 id="3-2-1-rule">3-2-1 Rule</h3>
<ul>
<li><strong>3</strong> copies of important data</li>
<li><strong>2</strong> different storage media types  </li>
<li><strong>1</strong> off-site backup location</li>
</ul>
<h3 id="backup-types">Backup Types</h3>
<pre><code class="language-yaml">Full Backup:
  - Complete system snapshot
  - Weekly schedule
  - 4 weeks retention

Incremental Backup:
  - Changes since last backup
  - Daily schedule
  - 7 days retention

Continuous Backup:
  - Real-time replication
  - Critical data only
  - 24 hours retention
</code></pre>
<h2 id="database-backups">Database Backups</h2>
<h3 id="automated-mysql-backups">Automated MySQL Backups</h3>
<pre><code class="language-bash">#!/bin/bash
# /usr/local/bin/mysql-backup.sh

# Configuration
BACKUP_DIR=&quot;/var/backups/mysql&quot;
MYSQL_USER=&quot;backup_user&quot;
MYSQL_PASS=&quot;secure_password&quot;
DATABASE=&quot;askproai_db&quot;
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=30

# Create backup directory
mkdir -p $BACKUP_DIR

# Perform backup
echo &quot;Starting MySQL backup...&quot;
mysqldump \
    --user=$MYSQL_USER \
    --password=$MYSQL_PASS \
    --single-transaction \
    --routines \
    --triggers \
    --events \
    --add-drop-table \
    --extended-insert \
    --lock-tables=false \
    $DATABASE | gzip &gt; $BACKUP_DIR/mysql_${DATABASE}_${DATE}.sql.gz

# Verify backup
if [ ${PIPESTATUS[0]} -eq 0 ]; then
    echo &quot;Backup successful: mysql_${DATABASE}_${DATE}.sql.gz&quot;

    # Test backup integrity
    gunzip -t $BACKUP_DIR/mysql_${DATABASE}_${DATE}.sql.gz
    if [ $? -eq 0 ]; then
        echo &quot;Backup integrity verified&quot;
    else
        echo &quot;ERROR: Backup file is corrupted!&quot;
        exit 1
    fi
else
    echo &quot;ERROR: Backup failed!&quot;
    exit 1
fi

# Clean old backups
find $BACKUP_DIR -name &quot;mysql_${DATABASE}_*.sql.gz&quot; -mtime +$RETENTION_DAYS -delete

echo &quot;Backup completed&quot;
</code></pre>
<h3 id="point-in-time-recovery-setup">Point-in-Time Recovery Setup</h3>
<pre><code class="language-sql">-- Enable binary logging for PITR
-- /etc/mysql/mysql.conf.d/mysqld.cnf
[mysqld]
log_bin = /var/log/mysql/mysql-bin
binlog_format = ROW
expire_logs_days = 7
max_binlog_size = 100M
binlog_cache_size = 4M
</code></pre>
<pre><code class="language-bash">#!/bin/bash
# Binary log backup script
BINLOG_DIR=&quot;/var/log/mysql&quot;
BACKUP_DIR=&quot;/var/backups/mysql/binlogs&quot;
DATE=$(date +%Y%m%d_%H%M%S)

# Copy binary logs
mkdir -p $BACKUP_DIR
cp $BINLOG_DIR/mysql-bin.* $BACKUP_DIR/

# Archive binary logs
tar -czf $BACKUP_DIR/binlogs_${DATE}.tar.gz -C $BACKUP_DIR mysql-bin.*
rm $BACKUP_DIR/mysql-bin.*
</code></pre>
<h3 id="continuous-database-replication">Continuous Database Replication</h3>
<pre><code class="language-php">// config/database.php
'mysql' =&gt; [
    'driver' =&gt; 'mysql',
    'read' =&gt; [
        'host' =&gt; [env('DB_READ_HOST', '127.0.0.1')],
    ],
    'write' =&gt; [
        'host' =&gt; [env('DB_WRITE_HOST', '127.0.0.1')],
    ],
    'backup' =&gt; [
        'host' =&gt; env('DB_BACKUP_HOST', '127.0.0.1'),
        'database' =&gt; env('DB_DATABASE', 'askproai_db'),
        'username' =&gt; env('DB_BACKUP_USERNAME', 'replication'),
        'password' =&gt; env('DB_BACKUP_PASSWORD'),
    ],
];
</code></pre>
<h2 id="application-backups">Application Backups</h2>
<h3 id="file-system-backup">File System Backup</h3>
<pre><code class="language-bash">#!/bin/bash
# /usr/local/bin/files-backup.sh

# Configuration
BACKUP_DIR=&quot;/var/backups/files&quot;
APP_DIR=&quot;/var/www/api-gateway&quot;
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=14

# Create backup directory
mkdir -p $BACKUP_DIR

# Backup application files
echo &quot;Backing up application files...&quot;
tar -czf $BACKUP_DIR/app_files_${DATE}.tar.gz \
    -C $APP_DIR \
    storage/app \
    storage/logs \
    public/uploads \
    .env \
    --exclude='storage/app/public/cache' \
    --exclude='storage/logs/*.log'

# Backup user uploads separately (for faster restore)
tar -czf $BACKUP_DIR/uploads_${DATE}.tar.gz \
    -C $APP_DIR/public \
    uploads

# Clean old backups
find $BACKUP_DIR -name &quot;app_files_*.tar.gz&quot; -mtime +$RETENTION_DAYS -delete
find $BACKUP_DIR -name &quot;uploads_*.tar.gz&quot; -mtime +$RETENTION_DAYS -delete

echo &quot;File backup completed&quot;
</code></pre>
<h3 id="configuration-backup">Configuration Backup</h3>
<pre><code class="language-bash">#!/bin/bash
# /usr/local/bin/config-backup.sh

# Configuration
BACKUP_DIR=&quot;/var/backups/config&quot;
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# Backup all configuration files
tar -czf $BACKUP_DIR/config_${DATE}.tar.gz \
    /etc/nginx/sites-available/ \
    /etc/php/8.2/fpm/pool.d/ \
    /etc/mysql/mysql.conf.d/ \
    /etc/redis/redis.conf \
    /etc/supervisor/conf.d/ \
    /var/www/api-gateway/.env \
    /var/www/api-gateway/config/

# Backup crontabs
crontab -l &gt; $BACKUP_DIR/crontab_root_${DATE}.txt
crontab -u askproai -l &gt; $BACKUP_DIR/crontab_askproai_${DATE}.txt

# Keep only last 30 days
find $BACKUP_DIR -type f -mtime +30 -delete
</code></pre>
<h2 id="cloud-backup">Cloud Backup</h2>
<h3 id="aws-s3-backup">AWS S3 Backup</h3>
<pre><code class="language-bash">#!/bin/bash
# /usr/local/bin/s3-backup.sh

# Configuration
LOCAL_BACKUP_DIR=&quot;/var/backups&quot;
S3_BUCKET=&quot;s3://askproai-backups&quot;
DATE=$(date +%Y%m%d)
RETENTION_DAYS=90

# Sync to S3
echo &quot;Syncing backups to S3...&quot;
aws s3 sync $LOCAL_BACKUP_DIR $S3_BUCKET/daily/$DATE/ \
    --exclude &quot;*.tmp&quot; \
    --exclude &quot;*.log&quot;

# Copy critical backups to glacier
aws s3 cp $LOCAL_BACKUP_DIR/mysql/mysql_askproai_db_${DATE}*.sql.gz \
    $S3_BUCKET/glacier/ \
    --storage-class GLACIER

# Clean old S3 backups
aws s3 ls $S3_BUCKET/daily/ | while read -r line; do
    createDate=$(echo $line | awk '{print $1}')
    createDate=$(date -d &quot;$createDate&quot; +%s)
    olderThan=$(date -d &quot;$RETENTION_DAYS days ago&quot; +%s)
    if [[ $createDate -lt $olderThan ]]; then
        folder=$(echo $line | awk '{print $2}')
        aws s3 rm --recursive $S3_BUCKET/daily/$folder
    fi
done

echo &quot;S3 backup completed&quot;
</code></pre>
<h3 id="backup-encryption">Backup Encryption</h3>
<pre><code class="language-bash">#!/bin/bash
# Encrypt sensitive backups

# Generate encryption key (one time)
openssl rand -base64 32 &gt; /root/.backup-encryption-key
chmod 600 /root/.backup-encryption-key

# Encrypt backup function
encrypt_backup() {
    local input_file=$1
    local output_file=&quot;${input_file}.enc&quot;

    openssl enc -aes-256-cbc -salt \
        -in &quot;$input_file&quot; \
        -out &quot;$output_file&quot; \
        -pass file:/root/.backup-encryption-key

    # Remove unencrypted file
    rm &quot;$input_file&quot;

    echo &quot;Encrypted: $output_file&quot;
}

# Usage in backup script
mysqldump askproai_db | gzip &gt; backup.sql.gz
encrypt_backup backup.sql.gz
</code></pre>
<h2 id="backup-monitoring">Backup Monitoring</h2>
<h3 id="backup-verification">Backup Verification</h3>
<pre><code class="language-php">// app/Console/Commands/VerifyBackups.php
class VerifyBackups extends Command
{
    protected $signature = 'backup:verify';

    public function handle()
    {
        $this-&gt;info('Verifying backups...');

        $checks = [
            'database' =&gt; $this-&gt;verifyDatabaseBackup(),
            'files' =&gt; $this-&gt;verifyFileBackup(),
            's3' =&gt; $this-&gt;verifyS3Backup(),
            'replication' =&gt; $this-&gt;verifyReplication(),
        ];

        $failed = collect($checks)-&gt;filter(fn($check) =&gt; !$check['success']);

        if ($failed-&gt;isNotEmpty()) {
            $this-&gt;error('Backup verification failed!');

            // Send alert
            Notification::route('mail', config('backup.notification_email'))
                -&gt;notify(new BackupVerificationFailed($failed));

            return 1;
        }

        $this-&gt;info('All backups verified successfully');
        return 0;
    }

    private function verifyDatabaseBackup(): array
    {
        $latestBackup = collect(File::glob('/var/backups/mysql/*.sql.gz'))
            -&gt;sortByDesc(fn($file) =&gt; filemtime($file))
            -&gt;first();

        if (!$latestBackup) {
            return ['success' =&gt; false, 'error' =&gt; 'No database backup found'];
        }

        $age = (time() - filemtime($latestBackup)) / 3600; // hours

        if ($age &gt; 25) { // More than 25 hours old
            return ['success' =&gt; false, 'error' =&gt; 'Database backup is too old'];
        }

        // Test restore to temporary database
        $testDb = 'askproai_backup_test';

        exec(&quot;mysql -e 'CREATE DATABASE IF NOT EXISTS $testDb'&quot;);
        exec(&quot;gunzip &lt; $latestBackup | mysql $testDb 2&gt;&amp;1&quot;, $output, $returnCode);
        exec(&quot;mysql -e 'DROP DATABASE $testDb'&quot;);

        if ($returnCode !== 0) {
            return ['success' =&gt; false, 'error' =&gt; 'Failed to restore backup: ' . implode(&quot;\n&quot;, $output)];
        }

        return ['success' =&gt; true, 'file' =&gt; $latestBackup, 'age_hours' =&gt; round($age, 1)];
    }
}
</code></pre>
<h3 id="backup-status-dashboard">Backup Status Dashboard</h3>
<pre><code class="language-php">// app/Http/Controllers/Admin/BackupStatusController.php
class BackupStatusController extends Controller
{
    public function index()
    {
        $backups = [
            'database' =&gt; $this-&gt;getDatabaseBackups(),
            'files' =&gt; $this-&gt;getFileBackups(),
            'cloud' =&gt; $this-&gt;getCloudBackups(),
        ];

        $metrics = [
            'last_backup' =&gt; $this-&gt;getLastBackupTime(),
            'total_size' =&gt; $this-&gt;getTotalBackupSize(),
            'success_rate' =&gt; $this-&gt;getBackupSuccessRate(),
            'next_scheduled' =&gt; $this-&gt;getNextScheduledBackup(),
        ];

        return view('admin.backup-status', compact('backups', 'metrics'));
    }

    private function getDatabaseBackups()
    {
        return collect(File::glob('/var/backups/mysql/*.sql.gz'))
            -&gt;map(fn($file) =&gt; [
                'name' =&gt; basename($file),
                'size' =&gt; $this-&gt;humanFilesize(filesize($file)),
                'created' =&gt; Carbon::createFromTimestamp(filemtime($file)),
                'type' =&gt; 'database',
            ])
            -&gt;sortByDesc('created')
            -&gt;take(10);
    }
}
</code></pre>
<h2 id="recovery-procedures">Recovery Procedures</h2>
<h3 id="database-recovery">Database Recovery</h3>
<pre><code class="language-bash">#!/bin/bash
# /usr/local/bin/mysql-restore.sh

# Configuration
BACKUP_FILE=$1
DATABASE=&quot;askproai_db&quot;

if [ -z &quot;$BACKUP_FILE&quot; ]; then
    echo &quot;Usage: $0 &lt;backup_file&gt;&quot;
    exit 1
fi

# Verify backup file exists
if [ ! -f &quot;$BACKUP_FILE&quot; ]; then
    echo &quot;ERROR: Backup file not found: $BACKUP_FILE&quot;
    exit 1
fi

# Create restore point
echo &quot;Creating restore point...&quot;
mysqldump $DATABASE | gzip &gt; /tmp/restore_point_$(date +%Y%m%d_%H%M%S).sql.gz

# Drop and recreate database
echo &quot;Preparing database...&quot;
mysql -e &quot;DROP DATABASE IF EXISTS $DATABASE&quot;
mysql -e &quot;CREATE DATABASE $DATABASE CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci&quot;

# Restore backup
echo &quot;Restoring database from $BACKUP_FILE...&quot;
gunzip &lt; $BACKUP_FILE | mysql $DATABASE

if [ $? -eq 0 ]; then
    echo &quot;Database restored successfully&quot;

    # Run migrations to ensure schema is up to date
    cd /var/www/api-gateway
    php artisan migrate --force

    echo &quot;Recovery completed&quot;
else
    echo &quot;ERROR: Database restore failed!&quot;
    echo &quot;Restore point saved at: /tmp/restore_point_*.sql.gz&quot;
    exit 1
fi
</code></pre>
<h3 id="point-in-time-recovery">Point-in-Time Recovery</h3>
<pre><code class="language-bash">#!/bin/bash
# PITR to specific timestamp

# Configuration
TARGET_TIME=&quot;2025-06-23 14:30:00&quot;
FULL_BACKUP=&quot;/var/backups/mysql/mysql_askproai_db_20250623_020000.sql.gz&quot;
BINLOG_DIR=&quot;/var/log/mysql&quot;

# Restore full backup
echo &quot;Restoring full backup...&quot;
gunzip &lt; $FULL_BACKUP | mysql askproai_db

# Apply binary logs up to target time
echo &quot;Applying binary logs...&quot;
mysqlbinlog \
    --stop-datetime=&quot;$TARGET_TIME&quot; \
    $BINLOG_DIR/mysql-bin.[0-9]* | mysql askproai_db

echo &quot;Point-in-time recovery completed to: $TARGET_TIME&quot;
</code></pre>
<h3 id="application-recovery">Application Recovery</h3>
<pre><code class="language-bash">#!/bin/bash
# /usr/local/bin/app-restore.sh

# Configuration
BACKUP_FILE=$1
APP_DIR=&quot;/var/www/api-gateway&quot;

if [ -z &quot;$BACKUP_FILE&quot; ]; then
    echo &quot;Usage: $0 &lt;backup_file&gt;&quot;
    exit 1
fi

# Create restore point
echo &quot;Creating restore point...&quot;
tar -czf /tmp/app_restore_point_$(date +%Y%m%d_%H%M%S).tar.gz -C $APP_DIR .

# Extract backup
echo &quot;Restoring application files...&quot;
tar -xzf $BACKUP_FILE -C $APP_DIR

# Fix permissions
chown -R askproai:www-data $APP_DIR
chmod -R 755 $APP_DIR
chmod -R 775 $APP_DIR/storage
chmod -R 775 $APP_DIR/bootstrap/cache

# Clear caches
cd $APP_DIR
php artisan optimize:clear
php artisan optimize

# Restart services
systemctl reload php8.2-fpm
supervisorctl restart all

echo &quot;Application restored successfully&quot;
</code></pre>
<h2 id="disaster-recovery-plan">Disaster Recovery Plan</h2>
<h3 id="recovery-time-objectives">Recovery Time Objectives</h3>
<pre><code class="language-yaml">Critical Systems:
  Database: 
    RTO: 1 hour
    RPO: 15 minutes
  Application:
    RTO: 30 minutes
    RPO: 1 hour
  User Uploads:
    RTO: 2 hours
    RPO: 24 hours

Non-Critical Systems:
  Logs:
    RTO: 24 hours
    RPO: 7 days
  Analytics:
    RTO: 48 hours
    RPO: 24 hours
</code></pre>
<h3 id="disaster-recovery-runbook">Disaster Recovery Runbook</h3>
<pre><code class="language-markdown"># Disaster Recovery Runbook

## 1. Assessment (0-15 minutes)
- [ ] Identify scope of disaster
- [ ] Determine affected systems
- [ ] Activate incident response team
- [ ] Communicate with stakeholders

## 2. Infrastructure Recovery (15-45 minutes)
- [ ] Provision new servers if needed
- [ ] Restore network configuration
- [ ] Install required software packages
- [ ] Configure security groups/firewall

## 3. Database Recovery (45-90 minutes)
- [ ] Locate latest viable backup
- [ ] Restore database from backup
- [ ] Apply binary logs if PITR needed
- [ ] Verify data integrity
- [ ] Test database connectivity

## 4. Application Recovery (90-120 minutes)
- [ ] Deploy application code
- [ ] Restore configuration files
- [ ] Restore user uploads
- [ ] Configure environment variables
- [ ] Start application services

## 5. Verification (120-150 minutes)
- [ ] Run health checks
- [ ] Test critical functionality
- [ ] Verify external integrations
- [ ] Check monitoring systems
- [ ] Test user authentication

## 6. Communication (150-180 minutes)
- [ ] Update status page
- [ ] Notify customers
- [ ] Document incident
- [ ] Schedule post-mortem
</code></pre>
<h3 id="automated-recovery">Automated Recovery</h3>
<pre><code class="language-php">// app/Console/Commands/DisasterRecovery.php
class DisasterRecovery extends Command
{
    protected $signature = 'dr:execute {--scenario=full}';

    public function handle()
    {
        $scenario = $this-&gt;option('scenario');

        $this-&gt;info(&quot;Executing disaster recovery: $scenario&quot;);

        try {
            match($scenario) {
                'database' =&gt; $this-&gt;recoverDatabase(),
                'application' =&gt; $this-&gt;recoverApplication(),
                'full' =&gt; $this-&gt;fullRecovery(),
                default =&gt; throw new \InvalidArgumentException(&quot;Unknown scenario: $scenario&quot;),
            };

            $this-&gt;info('Disaster recovery completed successfully');

            // Send notification
            Notification::route('mail', config('dr.notification_email'))
                -&gt;notify(new DisasterRecoveryCompleted($scenario));

        } catch (\Exception $e) {
            $this-&gt;error('Disaster recovery failed: ' . $e-&gt;getMessage());

            // Alert on-call team
            Notification::route('sms', config('dr.oncall_phone'))
                -&gt;notify(new DisasterRecoveryFailed($scenario, $e));

            return 1;
        }
    }

    private function fullRecovery()
    {
        $steps = [
            'Checking prerequisites' =&gt; fn() =&gt; $this-&gt;checkPrerequisites(),
            'Recovering database' =&gt; fn() =&gt; $this-&gt;recoverDatabase(),
            'Recovering application' =&gt; fn() =&gt; $this-&gt;recoverApplication(),
            'Verifying services' =&gt; fn() =&gt; $this-&gt;verifyServices(),
            'Running smoke tests' =&gt; fn() =&gt; $this-&gt;runSmokeTests(),
        ];

        foreach ($steps as $step =&gt; $action) {
            $this-&gt;info($step . '...');
            $action();
            $this-&gt;info('✓ ' . $step . ' completed');
        }
    }
}
</code></pre>
<h2 id="backup-testing">Backup Testing</h2>
<h3 id="monthly-restore-test">Monthly Restore Test</h3>
<pre><code class="language-bash">#!/bin/bash
# /usr/local/bin/test-restore.sh

# Configuration
TEST_SERVER=&quot;10.0.2.100&quot;
TEST_DB=&quot;askproai_test&quot;

echo &quot;Starting monthly restore test...&quot;

# Get latest backups
LATEST_DB_BACKUP=$(ls -t /var/backups/mysql/*.sql.gz | head -1)
LATEST_FILE_BACKUP=$(ls -t /var/backups/files/*.tar.gz | head -1)

# Test database restore
echo &quot;Testing database restore...&quot;
scp $LATEST_DB_BACKUP $TEST_SERVER:/tmp/
ssh $TEST_SERVER &quot;
    mysql -e 'DROP DATABASE IF EXISTS $TEST_DB'
    mysql -e 'CREATE DATABASE $TEST_DB'
    gunzip &lt; /tmp/$(basename $LATEST_DB_BACKUP) | mysql $TEST_DB
    mysql $TEST_DB -e 'SELECT COUNT(*) FROM appointments'
&quot;

# Test file restore
echo &quot;Testing file restore...&quot;
scp $LATEST_FILE_BACKUP $TEST_SERVER:/tmp/
ssh $TEST_SERVER &quot;
    mkdir -p /tmp/restore_test
    tar -xzf /tmp/$(basename $LATEST_FILE_BACKUP) -C /tmp/restore_test
    ls -la /tmp/restore_test/storage/app
&quot;

echo &quot;Restore test completed&quot;
</code></pre>
<h3 id="chaos-engineering">Chaos Engineering</h3>
<pre><code class="language-php">// app/Console/Commands/ChaosTest.php
class ChaosTest extends Command
{
    protected $signature = 'chaos:test {--component=database}';

    public function handle()
    {
        if (app()-&gt;environment('production')) {
            $this-&gt;error('Cannot run chaos tests in production!');
            return 1;
        }

        $component = $this-&gt;option('component');

        $this-&gt;warn(&quot;Starting chaos test for: $component&quot;);
        $this-&gt;warn('This will simulate a failure. Continue? (yes/no)');

        if ($this-&gt;ask('Continue?') !== 'yes') {
            return 0;
        }

        match($component) {
            'database' =&gt; $this-&gt;simulateDatabaseFailure(),
            'redis' =&gt; $this-&gt;simulateRedisFailure(),
            'storage' =&gt; $this-&gt;simulateStorageFailure(),
            'network' =&gt; $this-&gt;simulateNetworkFailure(),
        };

        $this-&gt;info('Chaos test completed. Check logs for recovery behavior.');
    }
}
</code></pre>
<h2 id="compliance-and-retention">Compliance and Retention</h2>
<h3 id="data-retention-policy">Data Retention Policy</h3>
<pre><code class="language-php">// config/backup.php
return [
    'retention' =&gt; [
        'database' =&gt; [
            'daily' =&gt; 7,      // Keep daily backups for 7 days
            'weekly' =&gt; 4,     // Keep weekly backups for 4 weeks
            'monthly' =&gt; 12,   // Keep monthly backups for 12 months
            'yearly' =&gt; 7,     // Keep yearly backups for 7 years
        ],
        'files' =&gt; [
            'daily' =&gt; 3,
            'weekly' =&gt; 2,
            'monthly' =&gt; 6,
        ],
        'logs' =&gt; [
            'application' =&gt; 30,    // 30 days
            'access' =&gt; 90,         // 90 days
            'audit' =&gt; 365 * 2,     // 2 years
        ],
    ],

    'compliance' =&gt; [
        'gdpr' =&gt; [
            'personal_data_retention' =&gt; 365 * 5, // 5 years
            'deletion_backup_retention' =&gt; 30,     // 30 days after deletion
        ],
        'financial' =&gt; [
            'invoice_retention' =&gt; 365 * 10,      // 10 years
            'transaction_retention' =&gt; 365 * 7,    // 7 years
        ],
    ],
];
</code></pre>
<h3 id="automated-cleanup">Automated Cleanup</h3>
<pre><code class="language-php">// app/Console/Commands/BackupCleanup.php
class BackupCleanup extends Command
{
    protected $signature = 'backup:cleanup {--dry-run}';

    public function handle()
    {
        $dryRun = $this-&gt;option('dry-run');

        $this-&gt;info('Starting backup cleanup...');

        $deleted = [
            'database' =&gt; $this-&gt;cleanupDatabaseBackups($dryRun),
            'files' =&gt; $this-&gt;cleanupFileBackups($dryRun),
            'cloud' =&gt; $this-&gt;cleanupCloudBackups($dryRun),
        ];

        $this-&gt;table(
            ['Type', 'Files Deleted', 'Space Freed'],
            collect($deleted)-&gt;map(fn($info, $type) =&gt; [
                $type,
                $info['count'],
                $this-&gt;humanFilesize($info['size']),
            ])-&gt;toArray()
        );

        if ($dryRun) {
            $this-&gt;warn('This was a dry run. No files were actually deleted.');
        }
    }
}
</code></pre>
<h2 id="related-documentation">Related Documentation</h2>
<ul>
<li><a href="../operations/disaster-recovery.md">Disaster Recovery Plan</a></li>
<li><a href="../../configuration/security/">Security Best Practices</a></li>
<li><a href="../../configuration/database/">Database Configuration</a></li>
<li><a href="../monitoring/">Monitoring Setup</a></li>
</ul>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme_extra.js" defer></script>
    <script src="../../../js/theme.js" defer></script>
      <script src="../../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>

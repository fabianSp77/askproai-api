<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://api.askproai.de/mkdocs/docs/integrations/stripe/" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>Stripe Integration - AskProAI Dokumentation</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Stripe Integration";
        var mkdocs_page_input_path = "docs/integrations/stripe.md";
        var mkdocs_page_url = "/mkdocs/docs/integrations/stripe/";
      </script>
    
    <script src="../../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> AskProAI Dokumentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Start</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Hauptdokumentation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../CLAUDE/">Projekt Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../CLAUDE_QUICK_REFERENCE/">Quick Reference</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../CLAUDE_CONTEXT_SUMMARY/">Context Summary</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Power User</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../TOP_10_COMMANDS/">Top 10 Commands</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../CLAUDE_BEFEHLE_FUER_DICH/">Claude Befehle für dich</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../MY_COMMANDS/">Meine Commands</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Best Practices 2025</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../BEST_PRACTICES_IMPLEMENTATION/">Implementation Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../DEVELOPMENT_PROCESS_2025/">Development Process</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../CLAUDE_DOCUMENTATION_GAPS_ANALYSIS.md">Documentation Gaps</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Schnellstart</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../5-MINUTEN_ONBOARDING_PLAYBOOK/">5-Minuten Onboarding</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Architektur</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/overview/">Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/services/">Services</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/system-design/">System Design</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/mcp-architecture/">MCP Architecture</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/database-schema/">Database Schema</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/security/">Security</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/performance/">Performance</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../../api/overview.md">Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../api/authentication/">Authentication</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../api/endpoints.md">Endpoints</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../api/webhooks/">Webhooks</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Features</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../features/appointment-booking/">Appointment Booking</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../features/call-management.md">Call Management</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../features/customer-portal.md">Customer Portal</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../features/multi-tenancy/">Multi-Tenancy</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Development</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../../development/setup.md">Setup</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../development/testing.md">Testing</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../development/code-standards.md">Code Standards</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Deployment</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../../deployment/overview.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../deployment/production.md">Production</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../deployment/environment-variables.md">Environment Variables</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Betrieb</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../CUSTOMER_SUCCESS_RUNBOOK/">Customer Success</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../EMERGENCY_RESPONSE_PLAYBOOK/">Emergency Response</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../ERROR_PATTERNS/">Error Patterns</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../TROUBLESHOOTING_DECISION_TREE/">Troubleshooting</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../DEPLOYMENT_CHECKLIST/">Deployment Checklist</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Monitoring</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../KPI_DASHBOARD_TEMPLATE/">KPI Dashboard</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../INTEGRATION_HEALTH_MONITOR/">Health Monitor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../PHONE_TO_APPOINTMENT_FLOW/">Phone to Appointment Flow</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">AskProAI Dokumentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
      <li>Stripe Integration</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="stripe-integration">Stripe Integration</h1>
<h2 id="overview">Overview</h2>
<p>Stripe integration enables subscription management, payment processing, and billing for AskProAI's SaaS model. The system supports multiple pricing tiers, usage-based billing, and automated invoice generation.</p>
<h2 id="configuration">Configuration</h2>
<h3 id="environment-variables">Environment Variables</h3>
<pre><code class="language-bash"># Stripe Configuration
STRIPE_KEY=pk_live_xxxxxxxxxxxxxx
STRIPE_SECRET=sk_live_xxxxxxxxxxxxxx
STRIPE_WEBHOOK_SECRET=whsec_xxxxxxxxxxxxxx
CASHIER_CURRENCY=eur
CASHIER_CURRENCY_LOCALE=de_DE
</code></pre>
<h3 id="laravel-cashier-setup">Laravel Cashier Setup</h3>
<pre><code class="language-bash"># Install Cashier
composer require laravel/cashier

# Publish migrations
php artisan vendor:publish --tag=&quot;cashier-migrations&quot;

# Run migrations
php artisan migrate
</code></pre>
<h2 id="subscription-plans">Subscription Plans</h2>
<h3 id="plan-configuration">Plan Configuration</h3>
<pre><code class="language-php">// config/subscription-plans.php
return [
    'starter' =&gt; [
        'stripe_price_id' =&gt; 'price_starter_monthly',
        'features' =&gt; [
            'calls_per_month' =&gt; 100,
            'branches' =&gt; 1,
            'staff' =&gt; 3,
            'custom_agent' =&gt; false
        ]
    ],
    'professional' =&gt; [
        'stripe_price_id' =&gt; 'price_pro_monthly',
        'features' =&gt; [
            'calls_per_month' =&gt; 500,
            'branches' =&gt; 3,
            'staff' =&gt; 10,
            'custom_agent' =&gt; true
        ]
    ],
    'enterprise' =&gt; [
        'stripe_price_id' =&gt; 'price_enterprise_monthly',
        'features' =&gt; [
            'calls_per_month' =&gt; 'unlimited',
            'branches' =&gt; 'unlimited',
            'staff' =&gt; 'unlimited',
            'custom_agent' =&gt; true
        ]
    ]
];
</code></pre>
<h3 id="creating-subscriptions">Creating Subscriptions</h3>
<pre><code class="language-php">// Subscribe company to plan
$company-&gt;newSubscription('default', 'price_pro_monthly')
    -&gt;trialDays(14)
    -&gt;create($paymentMethod);

// With metered billing for extra calls
$company-&gt;newSubscription('default', 'price_pro_monthly')
    -&gt;meteredPrice('price_per_call')
    -&gt;create($paymentMethod);
</code></pre>
<h2 id="payment-processing">Payment Processing</h2>
<h3 id="payment-methods">Payment Methods</h3>
<pre><code class="language-php">// Add payment method
$company-&gt;addPaymentMethod($paymentMethodId);
$company-&gt;updateDefaultPaymentMethod($paymentMethodId);

// SEPA Direct Debit for German market
$company-&gt;createAsStripeCustomer([
    'payment_method' =&gt; $paymentMethodId,
    'invoice_settings' =&gt; [
        'default_payment_method' =&gt; $paymentMethodId,
    ],
    'address' =&gt; [
        'country' =&gt; 'DE',
        'postal_code' =&gt; $company-&gt;postal_code,
        'city' =&gt; $company-&gt;city,
        'line1' =&gt; $company-&gt;address,
    ]
]);
</code></pre>
<h3 id="payment-intent">Payment Intent</h3>
<pre><code class="language-php">// Create payment intent for one-time charges
$payment = $company-&gt;charge(5000, $paymentMethodId, [
    'description' =&gt; 'Additional call credits',
    'metadata' =&gt; [
        'company_id' =&gt; $company-&gt;id,
        'type' =&gt; 'call_credits',
        'amount' =&gt; 100
    ]
]);
</code></pre>
<h2 id="usage-based-billing">Usage-Based Billing</h2>
<h3 id="track-usage">Track Usage</h3>
<pre><code class="language-php">// Report call usage to Stripe
class ReportCallUsage extends Job
{
    public function handle()
    {
        $companies = Company::whereNotNull('stripe_id')-&gt;get();

        foreach ($companies as $company) {
            $callCount = $company-&gt;calls()
                -&gt;whereBetween('created_at', [
                    now()-&gt;startOfMonth(),
                    now()-&gt;endOfMonth()
                ])
                -&gt;count();

            // Report usage for metered billing
            $company-&gt;subscription('default')
                -&gt;reportUsageFor('price_per_call', $callCount);
        }
    }
}
</code></pre>
<h3 id="usage-records">Usage Records</h3>
<pre><code class="language-php">// Track detailed usage
$usageRecord = StripeUsageRecord::create([
    'subscription_item' =&gt; $subscriptionItem,
    'quantity' =&gt; 25,
    'timestamp' =&gt; time(),
    'action' =&gt; 'set' // or 'increment'
]);
</code></pre>
<h2 id="webhook-handling">Webhook Handling</h2>
<h3 id="webhook-endpoints">Webhook Endpoints</h3>
<pre><code class="language-php">// routes/web.php
Route::post('/stripe/webhook', [StripeWebhookController::class, 'handle'])
    -&gt;name('cashier.webhook');
</code></pre>
<h3 id="webhook-events">Webhook Events</h3>
<pre><code class="language-php">class StripeWebhookController extends WebhookController
{
    protected function handleCustomerSubscriptionCreated($payload)
    {
        $company = Company::where('stripe_id', $payload['data']['object']['customer'])-&gt;first();

        // Activate features based on plan
        $this-&gt;activatePlanFeatures($company, $payload['data']['object']);

        // Send welcome email
        Mail::to($company-&gt;email)-&gt;send(new SubscriptionActivated($company));
    }

    protected function handleInvoicePaymentFailed($payload)
    {
        $company = Company::where('stripe_id', $payload['data']['object']['customer'])-&gt;first();

        // Notify admin
        $company-&gt;notify(new PaymentFailed($payload['data']['object']));

        // Suspend services after grace period
        SuspendServicesJob::dispatch($company)-&gt;delay(now()-&gt;addDays(3));
    }
}
</code></pre>
<h2 id="invoice-management">Invoice Management</h2>
<h3 id="invoice-configuration">Invoice Configuration</h3>
<pre><code class="language-php">// Customize invoice data
$company-&gt;updateStripeCustomer([
    'tax_id_data' =&gt; [[
        'type' =&gt; 'eu_vat',
        'value' =&gt; $company-&gt;vat_number
    ]],
    'invoice_settings' =&gt; [
        'custom_fields' =&gt; [
            ['name' =&gt; 'Company ID', 'value' =&gt; $company-&gt;id],
            ['name' =&gt; 'Branch', 'value' =&gt; $company-&gt;branches-&gt;first()-&gt;name]
        ],
        'footer' =&gt; 'Thank you for using AskProAI!'
    ]
]);
</code></pre>
<h3 id="download-invoices">Download Invoices</h3>
<pre><code class="language-php">// Invoice download endpoint
Route::get('/billing/invoice/{invoice}', function ($invoiceId) {
    return request()-&gt;user()-&gt;company
        -&gt;downloadInvoice($invoiceId, [
            'vendor' =&gt; 'AskProAI GmbH',
            'product' =&gt; 'AI Phone Service',
            'street' =&gt; 'Beispielstraße 123',
            'location' =&gt; '10115 Berlin, Germany',
            'phone' =&gt; '+49 30 123456789'
        ]);
});
</code></pre>
<h2 id="subscription-management">Subscription Management</h2>
<h3 id="plan-changes">Plan Changes</h3>
<pre><code class="language-php">// Upgrade/downgrade subscription
$company-&gt;subscription('default')-&gt;swap('price_enterprise_monthly');

// With proration
$company-&gt;subscription('default')
    -&gt;swapAndInvoice('price_enterprise_monthly');

// Cancel subscription
$company-&gt;subscription('default')-&gt;cancel();

// Cancel at end of period
$company-&gt;subscription('default')-&gt;cancelAtEndOfPeriod();
</code></pre>
<h3 id="trial-management">Trial Management</h3>
<pre><code class="language-php">// Extend trial
$company-&gt;subscription('default')
    -&gt;extendTrial(now()-&gt;addDays(7));

// Skip trial
$company-&gt;subscription('default')
    -&gt;skipTrial()
    -&gt;create($paymentMethod);
</code></pre>
<h2 id="customer-portal">Customer Portal</h2>
<h3 id="portal-configuration">Portal Configuration</h3>
<pre><code class="language-php">// Enable Stripe Customer Portal
return $request-&gt;user()-&gt;company
    -&gt;redirectToBillingPortal(route('billing'));
</code></pre>
<h3 id="custom-billing-page">Custom Billing Page</h3>
<pre><code class="language-php">class BillingController extends Controller
{
    public function index()
    {
        $company = auth()-&gt;user()-&gt;company;

        return view('billing.index', [
            'subscription' =&gt; $company-&gt;subscription('default'),
            'invoices' =&gt; $company-&gt;invoices(),
            'upcomingInvoice' =&gt; $company-&gt;upcomingInvoice(),
            'paymentMethods' =&gt; $company-&gt;paymentMethods()
        ]);
    }
}
</code></pre>
<h2 id="pricing-calculations">Pricing Calculations</h2>
<h3 id="dynamic-pricing">Dynamic Pricing</h3>
<pre><code class="language-php">class PricingCalculator
{
    public function calculateMonthlyPrice(Company $company): int
    {
        $basePrice = $this-&gt;getBasePlanPrice($company-&gt;plan);
        $additionalCalls = max(0, $company-&gt;monthly_calls - $company-&gt;included_calls);
        $callCharges = $additionalCalls * 10; // €0.10 per extra call

        return $basePrice + $callCharges;
    }

    public function estimateNextInvoice(Company $company): array
    {
        return [
            'base_plan' =&gt; $company-&gt;plan_price,
            'extra_calls' =&gt; $this-&gt;calculateExtraCallCharges($company),
            'additional_branches' =&gt; $this-&gt;calculateBranchCharges($company),
            'tax' =&gt; $this-&gt;calculateTax($company),
            'total' =&gt; $this-&gt;calculateTotal($company)
        ];
    }
}
</code></pre>
<h2 id="testing">Testing</h2>
<h3 id="test-mode">Test Mode</h3>
<pre><code class="language-php">// Use test keys in development
if (app()-&gt;environment('local')) {
    config(['cashier.key' =&gt; env('STRIPE_TEST_KEY')]);
    config(['cashier.secret' =&gt; env('STRIPE_TEST_SECRET')]);
}
</code></pre>
<h3 id="test-webhooks">Test Webhooks</h3>
<pre><code class="language-bash"># Stripe CLI for local webhook testing
stripe listen --forward-to localhost:8000/stripe/webhook

# Trigger test events
stripe trigger payment_intent.succeeded
</code></pre>
<h2 id="error-handling">Error Handling</h2>
<h3 id="payment-failures">Payment Failures</h3>
<pre><code class="language-php">try {
    $payment = $company-&gt;charge(10000, $paymentMethod);
} catch (\Laravel\Cashier\Exceptions\IncompletePayment $e) {
    // Redirect to payment confirmation page
    return redirect()-&gt;route(
        'cashier.payment',
        [$e-&gt;payment-&gt;id, 'redirect' =&gt; route('billing')]
    );
} catch (\Exception $e) {
    // Handle other errors
    Log::error('Payment failed', [
        'company_id' =&gt; $company-&gt;id,
        'error' =&gt; $e-&gt;getMessage()
    ]);
}
</code></pre>
<h2 id="related-documentation">Related Documentation</h2>
<ul>
<li><a href="../features/subscriptions.md">Subscription Features</a></li>
<li><a href="../api/webhooks.md">Webhook Configuration</a></li>
<li><a href="../../configuration/environment/">Environment Configuration</a></li>
</ul>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme_extra.js" defer></script>
    <script src="../../../js/theme.js" defer></script>
      <script src="../../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>

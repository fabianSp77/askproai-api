<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://api.askproai.de/mkdocs/docs/development/testing/" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>Testing Guide - AskProAI Dokumentation</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Testing Guide";
        var mkdocs_page_input_path = "docs/development/testing.md";
        var mkdocs_page_url = "/mkdocs/docs/development/testing/";
      </script>
    
    <script src="../../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> AskProAI Dokumentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Start</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Hauptdokumentation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../CLAUDE/">Projekt Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../CLAUDE_QUICK_REFERENCE/">Quick Reference</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../CLAUDE_CONTEXT_SUMMARY/">Context Summary</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Power User</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../TOP_10_COMMANDS/">Top 10 Commands</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../CLAUDE_BEFEHLE_FUER_DICH/">Claude Befehle für dich</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../MY_COMMANDS/">Meine Commands</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Best Practices 2025</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../BEST_PRACTICES_IMPLEMENTATION/">Implementation Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../DEVELOPMENT_PROCESS_2025/">Development Process</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../CLAUDE_DOCUMENTATION_GAPS_ANALYSIS.md">Documentation Gaps</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Schnellstart</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../5-MINUTEN_ONBOARDING_PLAYBOOK/">5-Minuten Onboarding</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Architektur</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/overview/">Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/services/">Services</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/system-design/">System Design</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/mcp-architecture/">MCP Architecture</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/database-schema/">Database Schema</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/security/">Security</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/performance/">Performance</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../../api/overview.md">Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../api/authentication/">Authentication</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../api/endpoints.md">Endpoints</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../api/webhooks/">Webhooks</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Features</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../features/appointment-booking/">Appointment Booking</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../features/call-management.md">Call Management</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../features/customer-portal.md">Customer Portal</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../features/multi-tenancy/">Multi-Tenancy</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Development</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../../development/setup.md">Setup</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../development/testing.md">Testing</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../development/code-standards.md">Code Standards</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Deployment</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../../deployment/overview.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../deployment/production.md">Production</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../deployment/environment-variables.md">Environment Variables</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Betrieb</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../CUSTOMER_SUCCESS_RUNBOOK/">Customer Success</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../EMERGENCY_RESPONSE_PLAYBOOK/">Emergency Response</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../ERROR_PATTERNS/">Error Patterns</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../TROUBLESHOOTING_DECISION_TREE/">Troubleshooting</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../DEPLOYMENT_CHECKLIST/">Deployment Checklist</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Monitoring</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../KPI_DASHBOARD_TEMPLATE/">KPI Dashboard</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../INTEGRATION_HEALTH_MONITOR/">Health Monitor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../PHONE_TO_APPOINTMENT_FLOW/">Phone to Appointment Flow</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">AskProAI Dokumentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
      <li>Testing Guide</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="testing-guide">Testing Guide</h1>
<h2 id="overview">Overview</h2>
<p>This guide covers the testing strategy, tools, and best practices for AskProAI. We follow a comprehensive testing approach including unit tests, integration tests, feature tests, and end-to-end tests.</p>
<h2 id="testing-philosophy">Testing Philosophy</h2>
<h3 id="testing-pyramid">Testing Pyramid</h3>
<pre><code>         /\
        /  \  E2E Tests (Few)
       /    \ 
      /      \  Integration Tests (Some)
     /        \
    /          \  Unit Tests (Many)
   /____________\
</code></pre>
<h3 id="test-coverage-goals">Test Coverage Goals</h3>
<ul>
<li>Overall coverage: &gt; 80%</li>
<li>Critical paths: 100%</li>
<li>Business logic: &gt; 90%</li>
<li>API endpoints: 100%</li>
</ul>
<h2 id="test-environment-setup">Test Environment Setup</h2>
<h3 id="configuration">Configuration</h3>
<pre><code class="language-bash"># Copy test environment file
cp .env.testing.example .env.testing
</code></pre>
<p>Configure <code>.env.testing</code>:</p>
<pre><code class="language-env">APP_ENV=testing
APP_DEBUG=true

# Use SQLite in-memory database for speed
DB_CONNECTION=sqlite
DB_DATABASE=:memory:

# Use array cache driver
CACHE_DRIVER=array
SESSION_DRIVER=array
QUEUE_CONNECTION=sync

# Mock external services
RETELL_MOCK_ENABLED=true
CALCOM_MOCK_ENABLED=true
STRIPE_MOCK_ENABLED=true
</code></pre>
<h3 id="phpunit-configuration">PHPUnit Configuration</h3>
<pre><code class="language-xml">&lt;!-- phpunit.xml --&gt;
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;phpunit xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:noNamespaceSchemaLocation=&quot;vendor/phpunit/phpunit/phpunit.xsd&quot;
         bootstrap=&quot;vendor/autoload.php&quot;
         colors=&quot;true&quot;&gt;
    &lt;testsuites&gt;
        &lt;testsuite name=&quot;Unit&quot;&gt;
            &lt;directory suffix=&quot;Test.php&quot;&gt;./tests/Unit&lt;/directory&gt;
        &lt;/testsuite&gt;
        &lt;testsuite name=&quot;Integration&quot;&gt;
            &lt;directory suffix=&quot;Test.php&quot;&gt;./tests/Integration&lt;/directory&gt;
        &lt;/testsuite&gt;
        &lt;testsuite name=&quot;Feature&quot;&gt;
            &lt;directory suffix=&quot;Test.php&quot;&gt;./tests/Feature&lt;/directory&gt;
        &lt;/testsuite&gt;
        &lt;testsuite name=&quot;E2E&quot;&gt;
            &lt;directory suffix=&quot;Test.php&quot;&gt;./tests/E2E&lt;/directory&gt;
        &lt;/testsuite&gt;
    &lt;/testsuites&gt;
    &lt;coverage&gt;
        &lt;include&gt;
            &lt;directory suffix=&quot;.php&quot;&gt;./app&lt;/directory&gt;
        &lt;/include&gt;
        &lt;exclude&gt;
            &lt;directory&gt;./app/Console/Kernel.php&lt;/directory&gt;
            &lt;directory&gt;./app/Exceptions/Handler.php&lt;/directory&gt;
        &lt;/exclude&gt;
    &lt;/coverage&gt;
    &lt;php&gt;
        &lt;env name=&quot;APP_ENV&quot; value=&quot;testing&quot;/&gt;
        &lt;env name=&quot;BCRYPT_ROUNDS&quot; value=&quot;4&quot;/&gt;
        &lt;env name=&quot;CACHE_DRIVER&quot; value=&quot;array&quot;/&gt;
        &lt;env name=&quot;DB_CONNECTION&quot; value=&quot;sqlite&quot;/&gt;
        &lt;env name=&quot;DB_DATABASE&quot; value=&quot;:memory:&quot;/&gt;
        &lt;env name=&quot;MAIL_MAILER&quot; value=&quot;array&quot;/&gt;
        &lt;env name=&quot;QUEUE_CONNECTION&quot; value=&quot;sync&quot;/&gt;
        &lt;env name=&quot;SESSION_DRIVER&quot; value=&quot;array&quot;/&gt;
        &lt;env name=&quot;TELESCOPE_ENABLED&quot; value=&quot;false&quot;/&gt;
    &lt;/php&gt;
&lt;/phpunit&gt;
</code></pre>
<h2 id="unit-tests">Unit Tests</h2>
<p>Unit tests focus on individual classes and methods in isolation.</p>
<h3 id="example-unit-test">Example Unit Test</h3>
<pre><code class="language-php">&lt;?php

namespace Tests\Unit\Services;

use App\Services\PriceCalculator;
use App\Models\Service;
use Tests\TestCase;

class PriceCalculatorTest extends TestCase
{
    private PriceCalculator $calculator;

    protected function setUp(): void
    {
        parent::setUp();
        $this-&gt;calculator = new PriceCalculator();
    }

    /** @test */
    public function it_calculates_base_price_correctly()
    {
        // Arrange
        $service = new Service(['base_price' =&gt; 50.00]);
        $duration = 60; // minutes

        // Act
        $price = $this-&gt;calculator-&gt;calculateBasePrice($service, $duration);

        // Assert
        $this-&gt;assertEquals(50.00, $price);
    }

    /** @test */
    public function it_applies_duration_multiplier()
    {
        // Arrange
        $service = new Service(['base_price' =&gt; 50.00, 'price_per_30min' =&gt; 25.00]);
        $duration = 90; // 1.5 hours

        // Act
        $price = $this-&gt;calculator-&gt;calculateBasePrice($service, $duration);

        // Assert
        $this-&gt;assertEquals(75.00, $price); // 50 + 25 for extra 30 min
    }

    /** @test */
    public function it_applies_weekend_surcharge()
    {
        // Arrange
        $service = new Service(['base_price' =&gt; 100.00]);
        $dateTime = Carbon::parse('2025-06-28 14:00:00'); // Saturday

        // Act
        $price = $this-&gt;calculator-&gt;calculatePrice($service, $dateTime);

        // Assert
        $this-&gt;assertEquals(120.00, $price); // 20% weekend surcharge
    }

    /**
     * @test
     * @dataProvider priceCalculationProvider
     */
    public function it_calculates_various_prices_correctly($basePrice, $duration, $isWeekend, $expected)
    {
        // Arrange
        $service = new Service(['base_price' =&gt; $basePrice]);
        $dateTime = $isWeekend 
            ? Carbon::parse('next Saturday 14:00') 
            : Carbon::parse('next Monday 14:00');

        // Act
        $price = $this-&gt;calculator-&gt;calculatePrice($service, $dateTime, $duration);

        // Assert
        $this-&gt;assertEquals($expected, $price);
    }

    public function priceCalculationProvider(): array
    {
        return [
            'weekday standard' =&gt; [100, 60, false, 100],
            'weekday extended' =&gt; [100, 90, false, 150],
            'weekend standard' =&gt; [100, 60, true, 120],
            'weekend extended' =&gt; [100, 90, true, 180],
        ];
    }
}
</code></pre>
<h3 id="testing-models">Testing Models</h3>
<pre><code class="language-php">&lt;?php

namespace Tests\Unit\Models;

use App\Models\Appointment;
use App\Models\Customer;
use App\Models\Branch;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;

class AppointmentTest extends TestCase
{
    use RefreshDatabase;

    /** @test */
    public function it_belongs_to_a_customer()
    {
        // Arrange
        $appointment = Appointment::factory()-&gt;create();

        // Act &amp; Assert
        $this-&gt;assertInstanceOf(Customer::class, $appointment-&gt;customer);
    }

    /** @test */
    public function it_calculates_end_time_correctly()
    {
        // Arrange
        $appointment = Appointment::factory()-&gt;create([
            'time' =&gt; '14:00:00',
            'duration' =&gt; 45,
        ]);

        // Act
        $endTime = $appointment-&gt;end_time;

        // Assert
        $this-&gt;assertEquals('14:45:00', $endTime-&gt;format('H:i:s'));
    }

    /** @test */
    public function it_scopes_upcoming_appointments()
    {
        // Arrange
        Appointment::factory()-&gt;create(['date' =&gt; now()-&gt;subDay()]); // Past
        $upcoming1 = Appointment::factory()-&gt;create(['date' =&gt; now()-&gt;addDay()]);
        $upcoming2 = Appointment::factory()-&gt;create(['date' =&gt; now()-&gt;addWeek()]);

        // Act
        $appointments = Appointment::upcoming()-&gt;get();

        // Assert
        $this-&gt;assertCount(2, $appointments);
        $this-&gt;assertTrue($appointments-&gt;contains($upcoming1));
        $this-&gt;assertTrue($appointments-&gt;contains($upcoming2));
    }

    /** @test */
    public function it_checks_if_appointment_is_editable()
    {
        // Arrange
        $past = Appointment::factory()-&gt;create([
            'date' =&gt; now()-&gt;subDay(),
            'status' =&gt; 'scheduled'
        ]);

        $future = Appointment::factory()-&gt;create([
            'date' =&gt; now()-&gt;addDay(),
            'status' =&gt; 'scheduled'
        ]);

        $completed = Appointment::factory()-&gt;create([
            'date' =&gt; now()-&gt;addDay(),
            'status' =&gt; 'completed'
        ]);

        // Act &amp; Assert
        $this-&gt;assertFalse($past-&gt;isEditable());
        $this-&gt;assertTrue($future-&gt;isEditable());
        $this-&gt;assertFalse($completed-&gt;isEditable());
    }
}
</code></pre>
<h2 id="integration-tests">Integration Tests</h2>
<p>Integration tests verify that different parts of the system work together correctly.</p>
<h3 id="service-integration-test">Service Integration Test</h3>
<pre><code class="language-php">&lt;?php

namespace Tests\Integration\Services;

use App\Services\AppointmentService;
use App\Services\CalendarService;
use App\Services\NotificationService;
use App\Models\Appointment;
use App\Models\Customer;
use App\Events\AppointmentCreated;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Illuminate\Support\Facades\Event;
use Tests\TestCase;
use Mockery;

class AppointmentServiceTest extends TestCase
{
    use RefreshDatabase;

    private AppointmentService $service;
    private $calendarMock;
    private $notificationMock;

    protected function setUp(): void
    {
        parent::setUp();

        // Create mocks for external services
        $this-&gt;calendarMock = Mockery::mock(CalendarService::class);
        $this-&gt;notificationMock = Mockery::mock(NotificationService::class);

        // Bind mocks to container
        $this-&gt;app-&gt;instance(CalendarService::class, $this-&gt;calendarMock);
        $this-&gt;app-&gt;instance(NotificationService::class, $this-&gt;notificationMock);

        $this-&gt;service = app(AppointmentService::class);
    }

    /** @test */
    public function it_creates_appointment_with_calendar_sync()
    {
        // Arrange
        Event::fake();
        $customer = Customer::factory()-&gt;create();

        $data = [
            'customer_id' =&gt; $customer-&gt;id,
            'service_id' =&gt; 1,
            'date' =&gt; '2025-07-01',
            'time' =&gt; '14:00',
            'duration' =&gt; 60,
        ];

        // Set up calendar mock expectation
        $this-&gt;calendarMock
            -&gt;shouldReceive('isAvailable')
            -&gt;once()
            -&gt;with('2025-07-01', '14:00', 60)
            -&gt;andReturn(true);

        $this-&gt;calendarMock
            -&gt;shouldReceive('createBooking')
            -&gt;once()
            -&gt;andReturn(['id' =&gt; 'cal_123']);

        // Act
        $appointment = $this-&gt;service-&gt;createAppointment($data);

        // Assert
        $this-&gt;assertInstanceOf(Appointment::class, $appointment);
        $this-&gt;assertEquals('cal_123', $appointment-&gt;calendar_id);
        $this-&gt;assertDatabaseHas('appointments', [
            'customer_id' =&gt; $customer-&gt;id,
            'date' =&gt; '2025-07-01',
        ]);

        Event::assertDispatched(AppointmentCreated::class);
    }

    /** @test */
    public function it_sends_notifications_after_booking()
    {
        // Arrange
        $customer = Customer::factory()-&gt;create([
            'email' =&gt; 'test@example.com',
            'phone' =&gt; '+49123456789',
        ]);

        $data = [
            'customer_id' =&gt; $customer-&gt;id,
            'service_id' =&gt; 1,
            'date' =&gt; '2025-07-01',
            'time' =&gt; '14:00',
        ];

        // Set up expectations
        $this-&gt;calendarMock
            -&gt;shouldReceive('isAvailable')
            -&gt;andReturn(true);

        $this-&gt;calendarMock
            -&gt;shouldReceive('createBooking')
            -&gt;andReturn(['id' =&gt; 'cal_123']);

        $this-&gt;notificationMock
            -&gt;shouldReceive('sendAppointmentConfirmation')
            -&gt;once()
            -&gt;with(Mockery::type(Appointment::class));

        // Act
        $appointment = $this-&gt;service-&gt;createAppointment($data);

        // Assert notification was triggered
        $this-&gt;assertNotNull($appointment);
    }

    /** @test */
    public function it_rollbacks_on_calendar_failure()
    {
        // Arrange
        $customer = Customer::factory()-&gt;create();

        $this-&gt;calendarMock
            -&gt;shouldReceive('isAvailable')
            -&gt;andReturn(true);

        $this-&gt;calendarMock
            -&gt;shouldReceive('createBooking')
            -&gt;andThrow(new \Exception('Calendar API error'));

        // Act &amp; Assert
        $this-&gt;expectException(\Exception::class);

        $this-&gt;service-&gt;createAppointment([
            'customer_id' =&gt; $customer-&gt;id,
            'service_id' =&gt; 1,
            'date' =&gt; '2025-07-01',
            'time' =&gt; '14:00',
        ]);

        // Verify no appointment was created
        $this-&gt;assertDatabaseCount('appointments', 0);
    }
}
</code></pre>
<h2 id="feature-tests">Feature Tests</h2>
<p>Feature tests verify complete features from the user's perspective.</p>
<h3 id="api-feature-test">API Feature Test</h3>
<pre><code class="language-php">&lt;?php

namespace Tests\Feature\Api;

use App\Models\User;
use App\Models\Company;
use App\Models\Appointment;
use Laravel\Sanctum\Sanctum;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;

class AppointmentApiTest extends TestCase
{
    use RefreshDatabase;

    private User $user;
    private Company $company;

    protected function setUp(): void
    {
        parent::setUp();

        $this-&gt;company = Company::factory()-&gt;create();
        $this-&gt;user = User::factory()-&gt;create(['company_id' =&gt; $this-&gt;company-&gt;id]);
    }

    /** @test */
    public function it_requires_authentication_to_list_appointments()
    {
        // Act
        $response = $this-&gt;getJson('/api/appointments');

        // Assert
        $response-&gt;assertUnauthorized();
    }

    /** @test */
    public function it_lists_appointments_for_authenticated_user()
    {
        // Arrange
        Sanctum::actingAs($this-&gt;user);

        $appointments = Appointment::factory()
            -&gt;count(3)
            -&gt;create(['company_id' =&gt; $this-&gt;company-&gt;id]);

        // Create appointment for different company (should not be returned)
        Appointment::factory()-&gt;create();

        // Act
        $response = $this-&gt;getJson('/api/appointments');

        // Assert
        $response-&gt;assertOk()
            -&gt;assertJsonCount(3, 'data')
            -&gt;assertJsonStructure([
                'data' =&gt; [
                    '*' =&gt; [
                        'id',
                        'customer' =&gt; ['id', 'name', 'phone'],
                        'service' =&gt; ['id', 'name', 'price'],
                        'date',
                        'time',
                        'status',
                    ]
                ],
                'links',
                'meta',
            ]);
    }

    /** @test */
    public function it_creates_appointment_with_valid_data()
    {
        // Arrange
        Sanctum::actingAs($this-&gt;user);

        $data = [
            'customer_name' =&gt; 'John Doe',
            'customer_phone' =&gt; '+49301234567',
            'service_id' =&gt; 1,
            'branch_id' =&gt; 1,
            'date' =&gt; now()-&gt;addDays(3)-&gt;format('Y-m-d'),
            'time' =&gt; '14:00',
            'duration' =&gt; 60,
            'notes' =&gt; 'First time customer',
        ];

        // Mock external services
        $this-&gt;mockCalendarAvailability(true);

        // Act
        $response = $this-&gt;postJson('/api/appointments', $data);

        // Assert
        $response-&gt;assertCreated()
            -&gt;assertJsonPath('data.customer.name', 'John Doe')
            -&gt;assertJsonPath('data.status', 'scheduled');

        $this-&gt;assertDatabaseHas('appointments', [
            'company_id' =&gt; $this-&gt;company-&gt;id,
            'date' =&gt; $data['date'],
        ]);
    }

    /** @test */
    public function it_validates_appointment_data()
    {
        // Arrange
        Sanctum::actingAs($this-&gt;user);

        $data = [
            'customer_name' =&gt; '', // Required
            'customer_phone' =&gt; 'invalid', // Invalid format
            'date' =&gt; now()-&gt;subDay()-&gt;format('Y-m-d'), // Past date
            'time' =&gt; '25:00', // Invalid time
        ];

        // Act
        $response = $this-&gt;postJson('/api/appointments', $data);

        // Assert
        $response-&gt;assertUnprocessable()
            -&gt;assertJsonValidationErrors([
                'customer_name',
                'customer_phone',
                'date',
                'time',
            ]);
    }

    /** @test */
    public function it_prevents_double_booking()
    {
        // Arrange
        Sanctum::actingAs($this-&gt;user);

        // Create existing appointment
        $existing = Appointment::factory()-&gt;create([
            'company_id' =&gt; $this-&gt;company-&gt;id,
            'date' =&gt; '2025-07-01',
            'time' =&gt; '14:00:00',
            'duration' =&gt; 60,
        ]);

        $data = [
            'customer_name' =&gt; 'Jane Doe',
            'customer_phone' =&gt; '+49301234567',
            'service_id' =&gt; 1,
            'branch_id' =&gt; $existing-&gt;branch_id,
            'staff_id' =&gt; $existing-&gt;staff_id,
            'date' =&gt; '2025-07-01',
            'time' =&gt; '14:30', // Overlaps with existing
        ];

        // Act
        $response = $this-&gt;postJson('/api/appointments', $data);

        // Assert
        $response-&gt;assertUnprocessable()
            -&gt;assertJsonPath('message', 'The selected time slot is not available.');
    }

    private function mockCalendarAvailability(bool $available = true): void
    {
        $this-&gt;mock(CalendarService::class)
            -&gt;shouldReceive('isAvailable')
            -&gt;andReturn($available);
    }
}
</code></pre>
<h2 id="end-to-end-tests">End-to-End Tests</h2>
<p>E2E tests verify complete user workflows.</p>
<h3 id="booking-flow-e2e-test">Booking Flow E2E Test</h3>
<pre><code class="language-php">&lt;?php

namespace Tests\E2E;

use App\Models\Company;
use App\Models\Branch;
use App\Models\Service;
use App\Models\PhoneNumber;
use Tests\TestCase;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Illuminate\Support\Facades\Event;
use Illuminate\Support\Facades\Queue;

class BookingFlowTest extends TestCase
{
    use RefreshDatabase;

    /** @test */
    public function complete_phone_booking_flow()
    {
        // Arrange
        Event::fake();
        Queue::fake();

        $company = Company::factory()-&gt;create();
        $branch = Branch::factory()-&gt;create(['company_id' =&gt; $company-&gt;id]);
        $service = Service::factory()-&gt;create(['company_id' =&gt; $company-&gt;id]);
        $phoneNumber = PhoneNumber::factory()-&gt;create([
            'number' =&gt; '+49301234567',
            'branch_id' =&gt; $branch-&gt;id,
            'retell_agent_id' =&gt; 'agent_123',
        ]);

        // Step 1: Incoming call webhook from Retell
        $response = $this-&gt;postJson('/api/retell/webhook', [
            'event_type' =&gt; 'call_started',
            'call_id' =&gt; 'call_123',
            'from_number' =&gt; '+49309876543',
            'to_number' =&gt; '+49301234567',
            'agent_id' =&gt; 'agent_123',
        ], [
            'x-retell-signature' =&gt; $this-&gt;generateRetellSignature([]),
        ]);

        $response-&gt;assertOk();
        Queue::assertPushed(ProcessRetellCallJob::class);

        // Step 2: Call ended with booking data
        $bookingData = [
            'event_type' =&gt; 'call_analyzed',
            'call_id' =&gt; 'call_123',
            'transcript' =&gt; 'Customer wants to book appointment...',
            'call_summary' =&gt; 'Appointment booking request',
            'function_calls' =&gt; [
                [
                    'name' =&gt; 'book_appointment',
                    'arguments' =&gt; [
                        'customer_name' =&gt; 'Max Mustermann',
                        'phone_number' =&gt; '+49309876543',
                        'service_type' =&gt; $service-&gt;name,
                        'preferred_date' =&gt; '2025-07-01',
                        'preferred_time' =&gt; '14:00',
                    ],
                ],
            ],
        ];

        $response = $this-&gt;postJson('/api/retell/webhook', $bookingData, [
            'x-retell-signature' =&gt; $this-&gt;generateRetellSignature($bookingData),
        ]);

        $response-&gt;assertOk();

        // Process queued jobs
        Queue::assertPushed(ProcessRetellCallEndedJob::class);

        // Step 3: Verify appointment was created
        $this-&gt;assertDatabaseHas('customers', [
            'name' =&gt; 'Max Mustermann',
            'phone' =&gt; '+49309876543',
            'company_id' =&gt; $company-&gt;id,
        ]);

        $this-&gt;assertDatabaseHas('appointments', [
            'company_id' =&gt; $company-&gt;id,
            'branch_id' =&gt; $branch-&gt;id,
            'date' =&gt; '2025-07-01',
            'status' =&gt; 'scheduled',
        ]);

        // Step 4: Verify notifications were queued
        Queue::assertPushed(SendAppointmentConfirmation::class);

        // Step 5: Verify events were fired
        Event::assertDispatched(CallProcessed::class);
        Event::assertDispatched(AppointmentCreated::class);
    }

    private function generateRetellSignature(array $payload): string
    {
        $secret = config('services.retell.webhook_secret');
        return hash_hmac('sha256', json_encode($payload), $secret);
    }
}
</code></pre>
<h2 id="browser-tests-laravel-dusk">Browser Tests (Laravel Dusk)</h2>
<h3 id="installation">Installation</h3>
<pre><code class="language-bash"># Install Dusk
composer require --dev laravel/dusk
php artisan dusk:install
</code></pre>
<h3 id="browser-test-example">Browser Test Example</h3>
<pre><code class="language-php">&lt;?php

namespace Tests\Browser;

use App\Models\User;
use App\Models\Company;
use Laravel\Dusk\Browser;
use Tests\DuskTestCase;

class AdminDashboardTest extends DuskTestCase
{
    /** @test */
    public function admin_can_view_dashboard()
    {
        $user = User::factory()-&gt;create([
            'role' =&gt; 'admin',
        ]);

        $this-&gt;browse(function (Browser $browser) use ($user) {
            $browser-&gt;loginAs($user)
                -&gt;visit('/admin')
                -&gt;assertSee('Dashboard')
                -&gt;assertSee('Today\'s Appointments')
                -&gt;assertSee('Active Calls')
                -&gt;assertVisible('@appointments-widget')
                -&gt;assertVisible('@calls-widget');
        });
    }

    /** @test */
    public function admin_can_create_appointment()
    {
        $user = User::factory()-&gt;create(['role' =&gt; 'admin']);

        $this-&gt;browse(function (Browser $browser) use ($user) {
            $browser-&gt;loginAs($user)
                -&gt;visit('/admin/appointments/create')
                -&gt;type('customer_name', 'John Doe')
                -&gt;type('customer_phone', '+49301234567')
                -&gt;select('service_id', '1')
                -&gt;click('@date-picker')
                -&gt;click('@date-tomorrow')
                -&gt;select('time', '14:00')
                -&gt;type('notes', 'Test appointment')
                -&gt;press('Create Appointment')
                -&gt;waitForText('Appointment created successfully')
                -&gt;assertPathIs('/admin/appointments');
        });
    }
}
</code></pre>
<h2 id="testing-best-practices">Testing Best Practices</h2>
<h3 id="test-data-factories">Test Data Factories</h3>
<pre><code class="language-php">// database/factories/AppointmentFactory.php
namespace Database\Factories;

use App\Models\Appointment;
use App\Models\Customer;
use App\Models\Branch;
use App\Models\Service;
use App\Models\Staff;
use Illuminate\Database\Eloquent\Factories\Factory;

class AppointmentFactory extends Factory
{
    protected $model = Appointment::class;

    public function definition(): array
    {
        return [
            'company_id' =&gt; Company::factory(),
            'branch_id' =&gt; Branch::factory(),
            'customer_id' =&gt; Customer::factory(),
            'staff_id' =&gt; Staff::factory(),
            'service_id' =&gt; Service::factory(),
            'date' =&gt; $this-&gt;faker-&gt;dateTimeBetween('tomorrow', '+30 days')-&gt;format('Y-m-d'),
            'time' =&gt; $this-&gt;faker-&gt;time('H:00:00'),
            'duration' =&gt; $this-&gt;faker-&gt;randomElement([30, 45, 60, 90]),
            'status' =&gt; 'scheduled',
            'notes' =&gt; $this-&gt;faker-&gt;optional()-&gt;sentence(),
        ];
    }

    public function confirmed(): static
    {
        return $this-&gt;state(fn (array $attributes) =&gt; [
            'status' =&gt; 'confirmed',
            'confirmed_at' =&gt; now(),
        ]);
    }

    public function tomorrow(): static
    {
        return $this-&gt;state(fn (array $attributes) =&gt; [
            'date' =&gt; now()-&gt;addDay()-&gt;format('Y-m-d'),
        ]);
    }

    public function withCustomer(Customer $customer): static
    {
        return $this-&gt;state(fn (array $attributes) =&gt; [
            'customer_id' =&gt; $customer-&gt;id,
            'company_id' =&gt; $customer-&gt;company_id,
        ]);
    }
}
</code></pre>
<h3 id="test-helpers">Test Helpers</h3>
<pre><code class="language-php">// tests/TestCase.php
namespace Tests;

use Illuminate\Foundation\Testing\TestCase as BaseTestCase;

abstract class TestCase extends BaseTestCase
{
    use CreatesApplication;

    protected function signIn($user = null)
    {
        $user = $user ?: User::factory()-&gt;create();
        $this-&gt;actingAs($user);
        return $user;
    }

    protected function signInAdmin()
    {
        return $this-&gt;signIn(User::factory()-&gt;admin()-&gt;create());
    }

    protected function createCompanyWithData(): Company
    {
        $company = Company::factory()-&gt;create();

        Branch::factory()-&gt;count(3)-&gt;create(['company_id' =&gt; $company-&gt;id]);
        Service::factory()-&gt;count(5)-&gt;create(['company_id' =&gt; $company-&gt;id]);
        Staff::factory()-&gt;count(10)-&gt;create(['company_id' =&gt; $company-&gt;id]);

        return $company;
    }

    protected function assertDatabaseHasWithRelations($table, array $data, array $relations = [])
    {
        $this-&gt;assertDatabaseHas($table, $data);

        $model = DB::table($table)-&gt;where($data)-&gt;first();

        foreach ($relations as $relation =&gt; $expected) {
            $this-&gt;assertEquals($expected, $model-&gt;$relation);
        }
    }
}
</code></pre>
<h3 id="testing-traits">Testing Traits</h3>
<pre><code class="language-php">// tests/Traits/MocksExternalServices.php
namespace Tests\Traits;

trait MocksExternalServices
{
    protected function mockRetellService($responses = [])
    {
        $mock = $this-&gt;mock(RetellService::class);

        foreach ($responses as $method =&gt; $response) {
            $mock-&gt;shouldReceive($method)-&gt;andReturn($response);
        }

        return $mock;
    }

    protected function mockCalendarService($available = true)
    {
        $this-&gt;mock(CalendarService::class)
            -&gt;shouldReceive('isAvailable')
            -&gt;andReturn($available)
            -&gt;shouldReceive('createBooking')
            -&gt;andReturn(['id' =&gt; 'cal_' . Str::random(10)]);
    }

    protected function mockSuccessfulBookingFlow()
    {
        $this-&gt;mockCalendarService(true);
        $this-&gt;mockNotificationService();
        Queue::fake();
        Event::fake();
    }
}
</code></pre>
<h2 id="code-coverage">Code Coverage</h2>
<h3 id="generate-coverage-report">Generate Coverage Report</h3>
<pre><code class="language-bash"># Generate HTML coverage report
php artisan test --coverage-html=coverage

# Generate coverage with minimum threshold
php artisan test --coverage --min=80

# Generate Clover XML for CI
./vendor/bin/phpunit --coverage-clover=coverage.xml
</code></pre>
<h3 id="coverage-configuration">Coverage Configuration</h3>
<pre><code class="language-xml">&lt;!-- phpunit.xml --&gt;
&lt;coverage&gt;
    &lt;include&gt;
        &lt;directory suffix=&quot;.php&quot;&gt;./app&lt;/directory&gt;
    &lt;/include&gt;
    &lt;exclude&gt;
        &lt;directory&gt;./app/Console/Kernel.php&lt;/directory&gt;
        &lt;directory&gt;./app/Exceptions/Handler.php&lt;/directory&gt;
        &lt;directory&gt;./app/Providers&lt;/directory&gt;
    &lt;/exclude&gt;
    &lt;report&gt;
        &lt;html outputDirectory=&quot;coverage&quot;/&gt;
        &lt;text outputFile=&quot;coverage.txt&quot;/&gt;
        &lt;clover outputFile=&quot;coverage.xml&quot;/&gt;
    &lt;/report&gt;
&lt;/coverage&gt;
</code></pre>
<h2 id="continuous-integration">Continuous Integration</h2>
<h3 id="github-actions-example">GitHub Actions Example</h3>
<pre><code class="language-yaml"># .github/workflows/tests.yml
name: Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: testing
        ports:
          - 3306:3306
        options: --health-cmd=&quot;mysqladmin ping&quot; --health-interval=10s

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: --health-cmd=&quot;redis-cli ping&quot;

    steps:
      - uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, pdo, pdo_mysql, redis
          coverage: xdebug

      - name: Install dependencies
        run: |
          composer install --prefer-dist --no-progress
          npm ci
          npm run build

      - name: Prepare testing environment
        run: |
          cp .env.testing.ci .env.testing
          php artisan key:generate --env=testing
          php artisan migrate --env=testing

      - name: Run tests with coverage
        run: |
          php artisan test --coverage --min=80

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          fail_ci_if_error: true
</code></pre>
<h2 id="testing-commands">Testing Commands</h2>
<h3 id="useful-testing-commands">Useful Testing Commands</h3>
<pre><code class="language-bash"># Run all tests
php artisan test

# Run specific test suite
php artisan test --testsuite=Unit
php artisan test --testsuite=Feature

# Run specific test file
php artisan test tests/Feature/AppointmentTest.php

# Run specific test method
php artisan test --filter=it_creates_appointment_with_valid_data

# Run tests in parallel
php artisan test --parallel

# Run tests and stop on failure
php artisan test --stop-on-failure

# Generate test
php artisan make:test AppointmentServiceTest --unit
php artisan make:test AppointmentApiTest
</code></pre>
<h2 id="related-documentation">Related Documentation</h2>
<ul>
<li><a href="../setup/">Development Setup</a></li>
<li><a href="../standards/">Coding Standards</a></li>
<li><a href="../debugging/">Debugging Guide</a></li>
<li><a href="../deployment/ci-cd.md">CI/CD Pipeline</a></li>
</ul>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme_extra.js" defer></script>
    <script src="../../../js/theme.js" defer></script>
      <script src="../../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>

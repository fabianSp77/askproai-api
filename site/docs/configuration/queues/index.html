<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://api.askproai.de/mkdocs/docs/configuration/queues/" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>Queue Configuration - AskProAI Dokumentation</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Queue Configuration";
        var mkdocs_page_input_path = "docs/configuration/queues.md";
        var mkdocs_page_url = "/mkdocs/docs/configuration/queues/";
      </script>
    
    <script src="../../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> AskProAI Dokumentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Start</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Hauptdokumentation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../CLAUDE/">Projekt Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../CLAUDE_QUICK_REFERENCE/">Quick Reference</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../CLAUDE_CONTEXT_SUMMARY/">Context Summary</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Power User</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../TOP_10_COMMANDS/">Top 10 Commands</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../CLAUDE_BEFEHLE_FUER_DICH/">Claude Befehle für dich</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../MY_COMMANDS/">Meine Commands</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Best Practices 2025</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../BEST_PRACTICES_IMPLEMENTATION/">Implementation Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../DEVELOPMENT_PROCESS_2025/">Development Process</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../CLAUDE_DOCUMENTATION_GAPS_ANALYSIS.md">Documentation Gaps</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Schnellstart</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../5-MINUTEN_ONBOARDING_PLAYBOOK/">5-Minuten Onboarding</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Architektur</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/overview/">Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/services/">Services</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/system-design/">System Design</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/mcp-architecture/">MCP Architecture</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/database-schema/">Database Schema</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/security/">Security</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/performance/">Performance</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../../api/overview.md">Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../api/authentication/">Authentication</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../api/endpoints.md">Endpoints</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../api/webhooks/">Webhooks</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Features</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../features/appointment-booking/">Appointment Booking</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../features/call-management.md">Call Management</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../features/customer-portal.md">Customer Portal</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../features/multi-tenancy/">Multi-Tenancy</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Development</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../../development/setup.md">Setup</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../development/testing.md">Testing</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../development/code-standards.md">Code Standards</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Deployment</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../../deployment/overview.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../deployment/production.md">Production</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../deployment/environment-variables.md">Environment Variables</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Betrieb</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../CUSTOMER_SUCCESS_RUNBOOK/">Customer Success</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../EMERGENCY_RESPONSE_PLAYBOOK/">Emergency Response</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../ERROR_PATTERNS/">Error Patterns</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../TROUBLESHOOTING_DECISION_TREE/">Troubleshooting</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../DEPLOYMENT_CHECKLIST/">Deployment Checklist</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Monitoring</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../KPI_DASHBOARD_TEMPLATE/">KPI Dashboard</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../INTEGRATION_HEALTH_MONITOR/">Health Monitor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../PHONE_TO_APPOINTMENT_FLOW/">Phone to Appointment Flow</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">AskProAI Dokumentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
      <li>Queue Configuration</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="queue-configuration">Queue Configuration</h1>
<h2 id="overview">Overview</h2>
<p>AskProAI uses Laravel Horizon to manage Redis-based queues for processing webhooks, sending notifications, and handling background tasks. This guide covers queue configuration, job processing, and monitoring.</p>
<h2 id="queue-drivers">Queue Drivers</h2>
<h3 id="redis-configuration">Redis Configuration</h3>
<pre><code class="language-php">// config/queue.php
return [
    'default' =&gt; env('QUEUE_CONNECTION', 'redis'),

    'connections' =&gt; [
        'redis' =&gt; [
            'driver' =&gt; 'redis',
            'connection' =&gt; 'queue',
            'queue' =&gt; env('REDIS_QUEUE', 'default'),
            'retry_after' =&gt; 90,
            'block_for' =&gt; 5,
            'after_commit' =&gt; false,
        ],

        'redis-long-running' =&gt; [
            'driver' =&gt; 'redis',
            'connection' =&gt; 'queue',
            'queue' =&gt; 'long-running',
            'retry_after' =&gt; 3600, // 1 hour
            'block_for' =&gt; 5,
        ],

        'sync' =&gt; [
            'driver' =&gt; 'sync',
        ],

        'database' =&gt; [
            'driver' =&gt; 'database',
            'table' =&gt; 'jobs',
            'queue' =&gt; 'default',
            'retry_after' =&gt; 90,
        ],
    ],

    'failed' =&gt; [
        'driver' =&gt; env('QUEUE_FAILED_DRIVER', 'database-uuids'),
        'database' =&gt; env('DB_CONNECTION', 'mysql'),
        'table' =&gt; 'failed_jobs',
    ],
];
</code></pre>
<h2 id="laravel-horizon-configuration">Laravel Horizon Configuration</h2>
<h3 id="horizon-setup">Horizon Setup</h3>
<pre><code class="language-php">// config/horizon.php
return [
    'domain' =&gt; env('HORIZON_DOMAIN'),
    'path' =&gt; env('HORIZON_PATH', 'horizon'),
    'middleware' =&gt; ['web', 'auth', 'admin'],

    'waits' =&gt; [
        'redis:default' =&gt; 60,
        'redis:high' =&gt; 60,
        'redis:low' =&gt; 60,
    ],

    'trim' =&gt; [
        'recent' =&gt; 60,          // Keep recent jobs for 60 minutes
        'pending' =&gt; 60,         // Keep pending jobs for 60 minutes
        'completed' =&gt; 60,       // Keep completed jobs for 60 minutes
        'recent_failed' =&gt; 1440, // Keep failed jobs for 24 hours
        'failed' =&gt; 10080,       // Keep all failed jobs for 7 days
        'monitored' =&gt; 10080,    // Keep monitored jobs for 7 days
    ],

    'metrics' =&gt; [
        'trim_snapshots' =&gt; [
            'job' =&gt; 24,         // 24 hours
            'queue' =&gt; 24,       // 24 hours
        ],
    ],

    'fast_termination' =&gt; false,

    'memory_limit' =&gt; env('HORIZON_MEMORY_LIMIT', 128),

    'environments' =&gt; [
        'production' =&gt; [
            'supervisor-1' =&gt; [
                'connection' =&gt; 'redis',
                'queue' =&gt; ['high', 'default'],
                'balance' =&gt; 'auto',
                'autoScalingStrategy' =&gt; 'time',
                'maxProcesses' =&gt; 10,
                'minProcesses' =&gt; 1,
                'balanceMaxShift' =&gt; 1,
                'balanceCooldown' =&gt; 3,
                'memory' =&gt; 128,
                'tries' =&gt; 3,
                'timeout' =&gt; 60,
                'nice' =&gt; 0,
            ],

            'webhooks' =&gt; [
                'connection' =&gt; 'redis',
                'queue' =&gt; ['webhooks'],
                'balance' =&gt; 'simple',
                'processes' =&gt; 5,
                'memory' =&gt; 128,
                'tries' =&gt; 3,
                'timeout' =&gt; 30,
            ],

            'notifications' =&gt; [
                'connection' =&gt; 'redis',
                'queue' =&gt; ['emails', 'sms'],
                'balance' =&gt; 'simple',
                'processes' =&gt; 3,
                'memory' =&gt; 128,
                'tries' =&gt; 3,
                'timeout' =&gt; 60,
            ],

            'long-running' =&gt; [
                'connection' =&gt; 'redis-long-running',
                'queue' =&gt; ['reports', 'imports'],
                'balance' =&gt; 'simple',
                'processes' =&gt; 2,
                'memory' =&gt; 256,
                'tries' =&gt; 1,
                'timeout' =&gt; 3600,
            ],
        ],

        'local' =&gt; [
            'supervisor-1' =&gt; [
                'maxProcesses' =&gt; 3,
                'balanceMaxShift' =&gt; 1,
                'balanceCooldown' =&gt; 3,
            ],
        ],
    ],
];
</code></pre>
<h2 id="queue-priorities">Queue Priorities</h2>
<h3 id="queue-structure">Queue Structure</h3>
<pre><code class="language-php">// app/Enums/QueuePriority.php
enum QueuePriority: string
{
    case CRITICAL = 'critical';    // Payment processing, urgent webhooks
    case HIGH = 'high';           // Appointment bookings, call processing
    case DEFAULT = 'default';     // General processing
    case LOW = 'low';            // Reports, analytics
    case WEBHOOKS = 'webhooks';   // External webhooks
    case EMAILS = 'emails';       // Email notifications
    case SMS = 'sms';            // SMS notifications
}
</code></pre>
<h3 id="job-dispatching">Job Dispatching</h3>
<pre><code class="language-php">// High priority job
ProcessPayment::dispatch($payment)-&gt;onQueue(QueuePriority::CRITICAL);

// Normal priority
ProcessRetellWebhook::dispatch($webhookData)-&gt;onQueue(QueuePriority::WEBHOOKS);

// Low priority
GenerateMonthlyReport::dispatch($company)-&gt;onQueue(QueuePriority::LOW);

// With delay
SendAppointmentReminder::dispatch($appointment)
    -&gt;onQueue(QueuePriority::EMAILS)
    -&gt;delay(now()-&gt;addHours(24));
</code></pre>
<h2 id="job-classes">Job Classes</h2>
<h3 id="base-job-class">Base Job Class</h3>
<pre><code class="language-php">// app/Jobs/BaseJob.php
abstract class BaseJob implements ShouldQueue
{
    use Dispatchable, InteractsWithQueue, Queueable, SerializesModels;

    public $tries = 3;
    public $timeout = 120;
    public $maxExceptions = 3;

    public function middleware()
    {
        return [
            new WithoutOverlapping($this-&gt;uniqueId()),
            new RateLimited('api-calls'),
            (new ThrottlesExceptions(3, 10))-&gt;backoff(5),
        ];
    }

    public function uniqueId(): string
    {
        return static::class;
    }

    public function failed(Throwable $exception): void
    {
        Log::error('Job failed', [
            'job' =&gt; static::class,
            'exception' =&gt; $exception-&gt;getMessage(),
            'trace' =&gt; $exception-&gt;getTraceAsString(),
        ]);

        // Notify administrators
        $this-&gt;notifyFailure($exception);
    }

    protected function notifyFailure(Throwable $exception): void
    {
        Notification::route('mail', config('app.admin_email'))
            -&gt;notify(new JobFailedNotification($this, $exception));
    }
}
</code></pre>
<h3 id="webhook-processing-job">Webhook Processing Job</h3>
<pre><code class="language-php">// app/Jobs/ProcessRetellWebhook.php
class ProcessRetellWebhook extends BaseJob
{
    public $tries = 5;
    public $backoff = [10, 30, 60, 120, 300]; // Exponential backoff

    public function __construct(
        public array $webhookData,
        public string $webhookId
    ) {}

    public function uniqueId(): string
    {
        return &quot;retell-webhook-{$this-&gt;webhookId}&quot;;
    }

    public function handle()
    {
        // Prevent duplicate processing
        if ($this-&gt;isDuplicate()) {
            Log::info('Duplicate webhook detected', ['webhook_id' =&gt; $this-&gt;webhookId]);
            return;
        }

        DB::transaction(function () {
            $handler = app(RetellWebhookHandler::class);

            match($this-&gt;webhookData['event_type']) {
                'call_started' =&gt; $handler-&gt;handleCallStarted($this-&gt;webhookData),
                'call_ended' =&gt; $handler-&gt;handleCallEnded($this-&gt;webhookData),
                'call_analyzed' =&gt; $handler-&gt;handleCallAnalyzed($this-&gt;webhookData),
                default =&gt; Log::warning('Unknown webhook event', $this-&gt;webhookData),
            };

            $this-&gt;markAsProcessed();
        });
    }

    protected function isDuplicate(): bool
    {
        return Cache::add(&quot;webhook:{$this-&gt;webhookId}&quot;, true, 3600) === false;
    }

    protected function markAsProcessed(): void
    {
        WebhookEvent::create([
            'provider' =&gt; 'retell',
            'event_id' =&gt; $this-&gt;webhookId,
            'event_type' =&gt; $this-&gt;webhookData['event_type'],
            'payload' =&gt; $this-&gt;webhookData,
            'processed_at' =&gt; now(),
        ]);
    }
}
</code></pre>
<h3 id="notification-job">Notification Job</h3>
<pre><code class="language-php">// app/Jobs/SendAppointmentConfirmation.php
class SendAppointmentConfirmation extends BaseJob
{
    use InteractsWithQueue;

    public $queue = 'emails';

    public function __construct(
        public Appointment $appointment,
        public array $channels = ['email', 'sms']
    ) {}

    public function handle()
    {
        $customer = $this-&gt;appointment-&gt;customer;

        foreach ($this-&gt;channels as $channel) {
            match($channel) {
                'email' =&gt; $this-&gt;sendEmail($customer),
                'sms' =&gt; $this-&gt;sendSMS($customer),
                'whatsapp' =&gt; $this-&gt;sendWhatsApp($customer),
            };
        }

        $this-&gt;appointment-&gt;update([
            'confirmation_sent_at' =&gt; now(),
            'confirmation_channels' =&gt; $this-&gt;channels,
        ]);
    }

    protected function sendEmail(Customer $customer): void
    {
        if (!$customer-&gt;email) {
            return;
        }

        Mail::to($customer-&gt;email)-&gt;send(
            new AppointmentConfirmationMail($this-&gt;appointment)
        );
    }

    protected function sendSMS(Customer $customer): void
    {
        if (!$customer-&gt;phone || !$customer-&gt;sms_notifications) {
            return;
        }

        app(SMSService::class)-&gt;send(
            $customer-&gt;phone,
            $this-&gt;getSMSMessage()
        );
    }
}
</code></pre>
<h2 id="job-batching">Job Batching</h2>
<h3 id="batch-processing">Batch Processing</h3>
<pre><code class="language-php">// app/Jobs/ProcessMonthlyBilling.php
class ProcessMonthlyBilling extends BaseJob
{
    public function handle()
    {
        $companies = Company::active()-&gt;get();

        $batch = Bus::batch([])
            -&gt;name('Monthly Billing - ' . now()-&gt;format('Y-m'))
            -&gt;allowFailures()
            -&gt;onQueue('billing')
            -&gt;dispatch();

        foreach ($companies as $company) {
            $batch-&gt;add(new ProcessCompanyBilling($company));
        }

        return $batch;
    }
}

// Monitor batch progress
class BillingBatchMonitor
{
    public function checkProgress(string $batchId)
    {
        $batch = Bus::findBatch($batchId);

        return [
            'id' =&gt; $batch-&gt;id,
            'name' =&gt; $batch-&gt;name,
            'total_jobs' =&gt; $batch-&gt;totalJobs,
            'pending_jobs' =&gt; $batch-&gt;pendingJobs,
            'failed_jobs' =&gt; $batch-&gt;failedJobs,
            'progress' =&gt; $batch-&gt;progress(),
            'finished' =&gt; $batch-&gt;finished(),
            'cancelled' =&gt; $batch-&gt;cancelled(),
        ];
    }
}
</code></pre>
<h2 id="job-chains">Job Chains</h2>
<h3 id="sequential-processing">Sequential Processing</h3>
<pre><code class="language-php">// app/Jobs/ProcessAppointmentBooking.php
class ProcessAppointmentBooking
{
    public function handle()
    {
        Bus::chain([
            new ValidateBookingData($this-&gt;data),
            new CheckAvailability($this-&gt;data),
            new CreateAppointment($this-&gt;data),
            new CreateCalcomBooking($this-&gt;data),
            new SendConfirmations($this-&gt;data),
            new UpdateStatistics($this-&gt;data),
        ])
        -&gt;onQueue('bookings')
        -&gt;onConnection('redis')
        -&gt;catch(function (Throwable $e) {
            Log::error('Booking chain failed', [
                'error' =&gt; $e-&gt;getMessage(),
                'data' =&gt; $this-&gt;data,
            ]);

            // Rollback actions
            $this-&gt;rollbackBooking();
        })
        -&gt;dispatch();
    }
}
</code></pre>
<h2 id="rate-limiting">Rate Limiting</h2>
<h3 id="job-rate-limiting">Job Rate Limiting</h3>
<pre><code class="language-php">// app/Providers/AppServiceProvider.php
public function boot()
{
    RateLimiter::for('api-calls', function ($job) {
        return Limit::perMinute(60)-&gt;by($job-&gt;company_id);
    });

    RateLimiter::for('emails', function ($job) {
        return Limit::perHour(100)-&gt;by($job-&gt;customer_id);
    });

    RateLimiter::for('sms', function ($job) {
        return Limit::perDay(50)-&gt;by($job-&gt;customer_id);
    });
}

// Usage in job
public function middleware()
{
    return [
        new RateLimited('api-calls'),
    ];
}
</code></pre>
<h2 id="queue-monitoring">Queue Monitoring</h2>
<h3 id="health-checks">Health Checks</h3>
<pre><code class="language-php">// app/Services/Queue/QueueHealthCheck.php
class QueueHealthCheck
{
    public function check(): array
    {
        $queues = ['default', 'high', 'low', 'webhooks', 'emails'];
        $health = [];

        foreach ($queues as $queue) {
            $size = Redis::llen(&quot;queues:{$queue}&quot;);
            $failed = Redis::llen(&quot;queues:{$queue}:failed&quot;);

            $health[$queue] = [
                'size' =&gt; $size,
                'failed' =&gt; $failed,
                'status' =&gt; $this-&gt;getStatus($size),
                'workers' =&gt; $this-&gt;getWorkerCount($queue),
            ];
        }

        return $health;
    }

    protected function getStatus(int $size): string
    {
        return match(true) {
            $size === 0 =&gt; 'idle',
            $size &lt; 100 =&gt; 'healthy',
            $size &lt; 1000 =&gt; 'busy',
            default =&gt; 'overloaded',
        };
    }

    protected function getWorkerCount(string $queue): int
    {
        return collect(app('horizon')-&gt;supervisors())
            -&gt;filter(fn($supervisor) =&gt; in_array($queue, $supervisor-&gt;options['queue']))
            -&gt;sum('processes.total');
    }
}
</code></pre>
<h3 id="queue-metrics">Queue Metrics</h3>
<pre><code class="language-php">// app/Console/Commands/QueueMetrics.php
class QueueMetrics extends Command
{
    protected $signature = 'queue:metrics';

    public function handle()
    {
        $metrics = [
            'job_throughput' =&gt; $this-&gt;getJobThroughput(),
            'average_wait_time' =&gt; $this-&gt;getAverageWaitTime(),
            'failure_rate' =&gt; $this-&gt;getFailureRate(),
            'queue_sizes' =&gt; $this-&gt;getQueueSizes(),
        ];

        $this-&gt;table(
            ['Metric', 'Value'],
            collect($metrics)-&gt;map(fn($value, $key) =&gt; [$key, $value])-&gt;toArray()
        );
    }

    protected function getJobThroughput(): string
    {
        $processed = Redis::get('horizon:measured_jobs');
        $time = Redis::get('horizon:measured_time') ?? 1;

        return round($processed / $time * 60) . ' jobs/minute';
    }
}
</code></pre>
<h2 id="failed-job-handling">Failed Job Handling</h2>
<h3 id="retry-strategy">Retry Strategy</h3>
<pre><code class="language-php">// app/Jobs/RetryableJob.php
abstract class RetryableJob extends BaseJob
{
    public $tries = 5;
    public $backoff = [30, 60, 180, 600, 3600]; // Progressive backoff

    public function retryUntil()
    {
        return now()-&gt;addDay();
    }

    public function shouldRetry(Throwable $exception): bool
    {
        // Don't retry validation errors
        if ($exception instanceof ValidationException) {
            return false;
        }

        // Don't retry if external service is down
        if ($exception instanceof ServiceUnavailableException) {
            return $this-&gt;attempts() &lt; 2;
        }

        return true;
    }
}
</code></pre>
<h3 id="failed-job-processing">Failed Job Processing</h3>
<pre><code class="language-php">// app/Console/Commands/ProcessFailedJobs.php
class ProcessFailedJobs extends Command
{
    protected $signature = 'queue:retry-failed {--queue=} {--limit=10}';

    public function handle()
    {
        $queue = $this-&gt;option('queue');
        $limit = $this-&gt;option('limit');

        $query = DB::table('failed_jobs')
            -&gt;orderBy('failed_at', 'desc')
            -&gt;limit($limit);

        if ($queue) {
            $query-&gt;where('queue', $queue);
        }

        $failed = $query-&gt;get();

        foreach ($failed as $job) {
            if ($this-&gt;shouldRetry($job)) {
                $this-&gt;retry($job-&gt;uuid);
                $this-&gt;info(&quot;Retried job: {$job-&gt;uuid}&quot;);
            }
        }
    }

    protected function shouldRetry($job): bool
    {
        $payload = json_decode($job-&gt;payload, true);

        // Check if job has permanent failure
        if (str_contains($job-&gt;exception, 'ValidationException')) {
            return false;
        }

        // Check retry limit
        $attempts = $payload['attempts'] ?? 0;
        return $attempts &lt; 10;
    }
}
</code></pre>
<h2 id="queue-performance">Queue Performance</h2>
<h3 id="optimization-tips">Optimization Tips</h3>
<pre><code class="language-php">// config/queue-optimization.php
return [
    // Chunk large datasets
    'chunk_size' =&gt; 100,

    // Batch database queries
    'batch_inserts' =&gt; true,

    // Use job batching for bulk operations
    'use_batches' =&gt; true,

    // Cache frequently accessed data
    'cache_ttl' =&gt; 300,

    // Limit concurrent jobs per user/company
    'concurrency_limits' =&gt; [
        'per_company' =&gt; 10,
        'per_user' =&gt; 5,
    ],
];
</code></pre>
<h3 id="memory-management">Memory Management</h3>
<pre><code class="language-php">// app/Jobs/MemoryEfficientJob.php
abstract class MemoryEfficientJob extends BaseJob
{
    protected function processLargeDataset($query)
    {
        $query-&gt;chunk(100, function ($items) {
            foreach ($items as $item) {
                $this-&gt;processItem($item);
            }

            // Clear entity manager to free memory
            if (app()-&gt;bound('em')) {
                app('em')-&gt;clear();
            }
        });
    }

    public function handle()
    {
        ini_set('memory_limit', '256M');

        $this-&gt;processData();

        // Force garbage collection
        gc_collect_cycles();
    }
}
</code></pre>
<h2 id="testing-queues">Testing Queues</h2>
<h3 id="queue-testing">Queue Testing</h3>
<pre><code class="language-php">// tests/Feature/Jobs/ProcessRetellWebhookTest.php
class ProcessRetellWebhookTest extends TestCase
{
    public function test_webhook_processing()
    {
        Queue::fake();

        // Trigger webhook
        $response = $this-&gt;postJson('/api/retell/webhook', [
            'event_type' =&gt; 'call_ended',
            'call_id' =&gt; 'test_123',
        ]);

        $response-&gt;assertStatus(200);

        // Assert job was dispatched
        Queue::assertPushed(ProcessRetellWebhook::class, function ($job) {
            return $job-&gt;webhookData['call_id'] === 'test_123';
        });

        // Process the job
        Queue::assertPushed(ProcessRetellWebhook::class, 1);
    }

    public function test_job_failure_handling()
    {
        Queue::fake();

        $job = new ProcessRetellWebhook(['invalid' =&gt; 'data'], 'test_id');

        try {
            $job-&gt;handle();
        } catch (\Exception $e) {
            $job-&gt;failed($e);
        }

        // Assert failure was handled
        Notification::assertSentTo(
            new AnonymousNotifiable,
            JobFailedNotification::class
        );
    }
}
</code></pre>
<h2 id="related-documentation">Related Documentation</h2>
<ul>
<li><a href="../features/background-jobs.md">Job Processing</a></li>
<li><a href="../api/webhooks.md">Webhook Processing</a></li>
<li><a href="../operations/performance.md">Performance Optimization</a></li>
<li><a href="../../operations/monitoring/">Monitoring</a></li>
</ul>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme_extra.js" defer></script>
    <script src="../../../js/theme.js" defer></script>
      <script src="../../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>

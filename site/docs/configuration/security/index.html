<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://api.askproai.de/mkdocs/docs/configuration/security/" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>Security Configuration - AskProAI Dokumentation</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Security Configuration";
        var mkdocs_page_input_path = "docs/configuration/security.md";
        var mkdocs_page_url = "/mkdocs/docs/configuration/security/";
      </script>
    
    <script src="../../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> AskProAI Dokumentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Start</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Hauptdokumentation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../CLAUDE/">Projekt Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../CLAUDE_QUICK_REFERENCE/">Quick Reference</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../CLAUDE_CONTEXT_SUMMARY/">Context Summary</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Power User</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../TOP_10_COMMANDS/">Top 10 Commands</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../CLAUDE_BEFEHLE_FUER_DICH/">Claude Befehle für dich</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../MY_COMMANDS/">Meine Commands</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Best Practices 2025</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../BEST_PRACTICES_IMPLEMENTATION/">Implementation Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../DEVELOPMENT_PROCESS_2025/">Development Process</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../CLAUDE_DOCUMENTATION_GAPS_ANALYSIS.md">Documentation Gaps</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Schnellstart</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../5-MINUTEN_ONBOARDING_PLAYBOOK/">5-Minuten Onboarding</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Architektur</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/overview/">Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/services/">Services</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/system-design/">System Design</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/mcp-architecture/">MCP Architecture</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/database-schema/">Database Schema</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/security/">Security</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/performance/">Performance</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../../api/overview.md">Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../api/authentication/">Authentication</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../api/endpoints.md">Endpoints</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../api/webhooks/">Webhooks</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Features</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../features/appointment-booking/">Appointment Booking</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../features/call-management.md">Call Management</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../features/customer-portal.md">Customer Portal</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../features/multi-tenancy/">Multi-Tenancy</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Development</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../../development/setup.md">Setup</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../development/testing.md">Testing</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../development/code-standards.md">Code Standards</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Deployment</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../../deployment/overview.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../deployment/production.md">Production</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../deployment/environment-variables.md">Environment Variables</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Betrieb</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../CUSTOMER_SUCCESS_RUNBOOK/">Customer Success</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../EMERGENCY_RESPONSE_PLAYBOOK/">Emergency Response</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../ERROR_PATTERNS/">Error Patterns</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../TROUBLESHOOTING_DECISION_TREE/">Troubleshooting</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../DEPLOYMENT_CHECKLIST/">Deployment Checklist</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Monitoring</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../KPI_DASHBOARD_TEMPLATE/">KPI Dashboard</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../INTEGRATION_HEALTH_MONITOR/">Health Monitor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../PHONE_TO_APPOINTMENT_FLOW/">Phone to Appointment Flow</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">AskProAI Dokumentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
      <li>Security Configuration</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="security-configuration">Security Configuration</h1>
<h2 id="overview">Overview</h2>
<p>This guide covers all security-related configurations in AskProAI, including authentication, authorization, encryption, and security best practices.</p>
<h2 id="authentication-configuration">Authentication Configuration</h2>
<h3 id="multi-factor-authentication-mfa">Multi-Factor Authentication (MFA)</h3>
<pre><code class="language-php">// config/auth.php
return [
    'mfa' =&gt; [
        'enabled' =&gt; env('MFA_ENABLED', true),
        'issuer' =&gt; env('MFA_ISSUER', 'AskProAI'),
        'enforced' =&gt; env('MFA_ENFORCED', false),
        'recovery_codes' =&gt; 8,
        'qr_size' =&gt; 200,
    ],

    'password' =&gt; [
        'min_length' =&gt; 12,
        'require_uppercase' =&gt; true,
        'require_numeric' =&gt; true,
        'require_special' =&gt; true,
        'history' =&gt; 5, // Prevent reuse of last 5 passwords
        'expires_days' =&gt; 90,
    ],

    'session' =&gt; [
        'lifetime' =&gt; env('SESSION_LIFETIME', 120),
        'expire_on_close' =&gt; false,
        'encrypt' =&gt; true,
        'secure' =&gt; env('SESSION_SECURE_COOKIE', true),
        'same_site' =&gt; 'lax',
    ],
];
</code></pre>
<h3 id="api-authentication">API Authentication</h3>
<pre><code class="language-php">// config/sanctum.php
return [
    'stateful' =&gt; explode(',', env('SANCTUM_STATEFUL_DOMAINS', 'localhost,127.0.0.1')),
    'guard' =&gt; ['web'],
    'expiration' =&gt; 525600, // 1 year

    'token_prefix' =&gt; env('SANCTUM_TOKEN_PREFIX', 'askproai_'),

    'middleware' =&gt; [
        'verify_csrf_token' =&gt; App\Http\Middleware\VerifyCsrfToken::class,
        'encrypt_cookies' =&gt; App\Http\Middleware\EncryptCookies::class,
    ],
];
</code></pre>
<h2 id="encryption-configuration">Encryption Configuration</h2>
<h3 id="application-encryption">Application Encryption</h3>
<pre><code class="language-php">// config/app.php
'cipher' =&gt; 'AES-256-CBC',

// config/encryption.php
return [
    'enabled' =&gt; env('ENCRYPT_SENSITIVE_DATA', true),

    'fields' =&gt; [
        'customers' =&gt; ['phone', 'email', 'date_of_birth'],
        'companies' =&gt; ['api_keys', 'webhook_secrets'],
        'call_recordings' =&gt; ['url', 'transcript'],
        'payment_methods' =&gt; ['card_number', 'cvv'],
    ],

    'key_rotation' =&gt; [
        'enabled' =&gt; env('ENCRYPTION_KEY_ROTATION', true),
        'schedule' =&gt; 'quarterly',
        'grace_period' =&gt; 30, // days
    ],
];
</code></pre>
<h3 id="database-encryption">Database Encryption</h3>
<pre><code class="language-php">// app/Traits/EncryptsAttributes.php
trait EncryptsAttributes
{
    protected function encryptAttribute($value)
    {
        if (!config('encryption.enabled')) {
            return $value;
        }

        return Crypt::encryptString($value);
    }

    protected function decryptAttribute($value)
    {
        if (!config('encryption.enabled') || empty($value)) {
            return $value;
        }

        try {
            return Crypt::decryptString($value);
        } catch (DecryptException $e) {
            Log::error('Decryption failed', ['error' =&gt; $e-&gt;getMessage()]);
            return null;
        }
    }
}
</code></pre>
<h2 id="cors-configuration">CORS Configuration</h2>
<pre><code class="language-php">// config/cors.php
return [
    'paths' =&gt; ['api/*', 'sanctum/csrf-cookie'],

    'allowed_methods' =&gt; ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],

    'allowed_origins' =&gt; [
        env('FRONTEND_URL', 'https://app.askproai.de'),
        'https://admin.askproai.de',
    ],

    'allowed_origins_patterns' =&gt; [
        '#^https://.*\.askproai\.de$#',
    ],

    'allowed_headers' =&gt; [
        'Content-Type',
        'X-Requested-With',
        'Authorization',
        'X-CSRF-TOKEN',
        'X-Company-ID',
    ],

    'exposed_headers' =&gt; [
        'X-RateLimit-Limit',
        'X-RateLimit-Remaining',
    ],

    'max_age' =&gt; 86400,

    'supports_credentials' =&gt; true,
];
</code></pre>
<h2 id="security-headers">Security Headers</h2>
<h3 id="middleware-configuration">Middleware Configuration</h3>
<pre><code class="language-php">// app/Http/Middleware/SecurityHeaders.php
class SecurityHeaders
{
    public function handle($request, Closure $next)
    {
        $response = $next($request);

        $response-&gt;headers-&gt;set('X-Content-Type-Options', 'nosniff');
        $response-&gt;headers-&gt;set('X-Frame-Options', 'DENY');
        $response-&gt;headers-&gt;set('X-XSS-Protection', '1; mode=block');
        $response-&gt;headers-&gt;set('Referrer-Policy', 'strict-origin-when-cross-origin');
        $response-&gt;headers-&gt;set('Permissions-Policy', 'geolocation=(), microphone=(), camera=()');

        // Content Security Policy
        $csp = &quot;default-src 'self'; &quot; .
               &quot;script-src 'self' 'unsafe-inline' 'unsafe-eval' https://js.stripe.com; &quot; .
               &quot;style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; &quot; .
               &quot;font-src 'self' https://fonts.gstatic.com; &quot; .
               &quot;img-src 'self' data: https:; &quot; .
               &quot;connect-src 'self' https://api.stripe.com https://api.retellai.com&quot;;

        $response-&gt;headers-&gt;set('Content-Security-Policy', $csp);

        // HSTS
        if (config('app.env') === 'production') {
            $response-&gt;headers-&gt;set(
                'Strict-Transport-Security',
                'max-age=31536000; includeSubDomains; preload'
            );
        }

        return $response;
    }
}
</code></pre>
<h2 id="rate-limiting">Rate Limiting</h2>
<h3 id="adaptive-rate-limiting">Adaptive Rate Limiting</h3>
<pre><code class="language-php">// app/Http/Middleware/AdaptiveRateLimit.php
class AdaptiveRateLimit
{
    private RateLimiter $limiter;

    public function handle($request, Closure $next, $maxAttempts = 60)
    {
        $key = $this-&gt;resolveRequestSignature($request);
        $maxAttempts = $this-&gt;getAdaptiveLimit($request, $maxAttempts);

        if ($this-&gt;limiter-&gt;tooManyAttempts($key, $maxAttempts)) {
            return $this-&gt;buildResponse($key, $maxAttempts);
        }

        $this-&gt;limiter-&gt;hit($key, 60);

        $response = $next($request);

        return $this-&gt;addHeaders(
            $response,
            $maxAttempts,
            $this-&gt;limiter-&gt;remaining($key, $maxAttempts)
        );
    }

    protected function getAdaptiveLimit($request, $default)
    {
        $user = $request-&gt;user();

        if (!$user) {
            return $default;
        }

        return match($user-&gt;company-&gt;subscription_plan) {
            'enterprise' =&gt; 1000,
            'professional' =&gt; 300,
            'starter' =&gt; 100,
            default =&gt; $default,
        };
    }
}
</code></pre>
<h2 id="input-validation-sanitization">Input Validation &amp; Sanitization</h2>
<h3 id="global-input-sanitization">Global Input Sanitization</h3>
<pre><code class="language-php">// app/Http/Middleware/SanitizeInput.php
class SanitizeInput
{
    protected array $except = [
        'password',
        'password_confirmation',
    ];

    public function handle($request, Closure $next)
    {
        $input = $request-&gt;all();

        array_walk_recursive($input, function (&amp;$value, $key) {
            if (!in_array($key, $this-&gt;except) &amp;&amp; is_string($value)) {
                $value = $this-&gt;sanitize($value);
            }
        });

        $request-&gt;merge($input);

        return $next($request);
    }

    protected function sanitize($value)
    {
        // Remove null bytes
        $value = str_replace(chr(0), '', $value);

        // Strip tags but preserve content
        $value = strip_tags($value);

        // Normalize whitespace
        $value = preg_replace('/\s+/', ' ', trim($value));

        return $value;
    }
}
</code></pre>
<h3 id="sql-injection-prevention">SQL Injection Prevention</h3>
<pre><code class="language-php">// app/Services/Security/QuerySanitizer.php
class QuerySanitizer
{
    protected array $dangerousPatterns = [
        '/union\s+select/i',
        '/insert\s+into/i',
        '/drop\s+table/i',
        '/update\s+.*\s+set/i',
        '/delete\s+from/i',
        '/script\s*&gt;/i',
        '/or\s+1\s*=\s*1/i',
        '/\'\s*or\s+\'/i',
    ];

    public function sanitize(string $input): string
    {
        foreach ($this-&gt;dangerousPatterns as $pattern) {
            if (preg_match($pattern, $input)) {
                throw new MaliciousInputException('Potentially dangerous input detected');
            }
        }

        return $input;
    }

    public function sanitizeForLike(string $input): string
    {
        return str_replace(['%', '_', '[', ']'], ['\%', '\_', '\[', '\]'], $input);
    }
}
</code></pre>
<h2 id="file-upload-security">File Upload Security</h2>
<h3 id="upload-configuration">Upload Configuration</h3>
<pre><code class="language-php">// config/upload.php
return [
    'allowed_extensions' =&gt; [
        'images' =&gt; ['jpg', 'jpeg', 'png', 'gif', 'webp'],
        'documents' =&gt; ['pdf', 'doc', 'docx', 'xls', 'xlsx'],
        'audio' =&gt; ['mp3', 'wav', 'm4a'],
    ],

    'max_size' =&gt; env('UPLOAD_MAX_SIZE', 10240), // 10MB in KB

    'scan_for_viruses' =&gt; env('UPLOAD_VIRUS_SCAN', true),

    'storage' =&gt; [
        'disk' =&gt; env('UPLOAD_DISK', 'local'),
        'path' =&gt; 'uploads/{year}/{month}/{day}',
        'visibility' =&gt; 'private',
    ],

    'image_processing' =&gt; [
        'strip_metadata' =&gt; true,
        'max_dimensions' =&gt; [
            'width' =&gt; 4096,
            'height' =&gt; 4096,
        ],
    ],
];
</code></pre>
<h3 id="file-upload-validator">File Upload Validator</h3>
<pre><code class="language-php">// app/Services/Security/FileUploadValidator.php
class FileUploadValidator
{
    public function validate(UploadedFile $file, string $type): void
    {
        // Check file extension
        $extension = strtolower($file-&gt;getClientOriginalExtension());
        $allowedExtensions = config(&quot;upload.allowed_extensions.{$type}&quot;, []);

        if (!in_array($extension, $allowedExtensions)) {
            throw new InvalidFileTypeException(&quot;File type {$extension} is not allowed&quot;);
        }

        // Check MIME type
        $mimeType = $file-&gt;getMimeType();
        if (!$this-&gt;isValidMimeType($mimeType, $type)) {
            throw new InvalidFileTypeException(&quot;MIME type {$mimeType} is not allowed&quot;);
        }

        // Check file size
        $maxSize = config('upload.max_size') * 1024; // Convert to bytes
        if ($file-&gt;getSize() &gt; $maxSize) {
            throw new FileSizeException(&quot;File exceeds maximum size limit&quot;);
        }

        // Scan for viruses if enabled
        if (config('upload.scan_for_viruses')) {
            $this-&gt;scanForViruses($file);
        }
    }

    protected function scanForViruses(UploadedFile $file): void
    {
        $scanner = app(VirusScanner::class);

        if (!$scanner-&gt;scan($file-&gt;getPathname())) {
            throw new MaliciousFileException(&quot;File contains malicious content&quot;);
        }
    }
}
</code></pre>
<h2 id="webhook-security">Webhook Security</h2>
<h3 id="signature-verification">Signature Verification</h3>
<pre><code class="language-php">// app/Http/Middleware/VerifyWebhookSignature.php
abstract class VerifyWebhookSignature
{
    abstract protected function getSecret(Request $request): string;
    abstract protected function getSignatureHeader(): string;
    abstract protected function calculateSignature(string $payload, string $secret): string;

    public function handle(Request $request, Closure $next)
    {
        $signature = $request-&gt;header($this-&gt;getSignatureHeader());

        if (!$signature) {
            abort(401, 'Missing signature header');
        }

        $payload = $request-&gt;getContent();
        $secret = $this-&gt;getSecret($request);
        $expected = $this-&gt;calculateSignature($payload, $secret);

        if (!hash_equals($expected, $signature)) {
            Log::warning('Invalid webhook signature', [
                'ip' =&gt; $request-&gt;ip(),
                'url' =&gt; $request-&gt;fullUrl(),
            ]);

            abort(401, 'Invalid signature');
        }

        // Add timestamp validation
        $this-&gt;validateTimestamp($request);

        return $next($request);
    }

    protected function validateTimestamp(Request $request): void
    {
        $timestamp = $request-&gt;header('X-Timestamp');

        if (!$timestamp) {
            return;
        }

        $tolerance = config('webhooks.timestamp_tolerance', 300); // 5 minutes

        if (abs(time() - intval($timestamp)) &gt; $tolerance) {
            abort(401, 'Request timestamp too old');
        }
    }
}
</code></pre>
<h2 id="api-security">API Security</h2>
<h3 id="api-key-management">API Key Management</h3>
<pre><code class="language-php">// app/Services/Security/ApiKeyManager.php
class ApiKeyManager
{
    public function generate(): string
    {
        return 'askproai_' . bin2hex(random_bytes(32));
    }

    public function rotate(Company $company): string
    {
        $oldKey = $company-&gt;api_key;
        $newKey = $this-&gt;generate();

        // Store old key for grace period
        $company-&gt;api_keys()-&gt;create([
            'key' =&gt; $oldKey,
            'expires_at' =&gt; now()-&gt;addDays(7),
            'status' =&gt; 'rotating',
        ]);

        // Update to new key
        $company-&gt;update(['api_key' =&gt; $newKey]);

        // Notify about key rotation
        $company-&gt;notify(new ApiKeyRotated($oldKey, $newKey));

        return $newKey;
    }

    public function validate(string $key): bool
    {
        // Check primary keys
        if (Company::where('api_key', hash('sha256', $key))-&gt;exists()) {
            return true;
        }

        // Check rotating keys
        return ApiKey::where('key', hash('sha256', $key))
            -&gt;where('expires_at', '&gt;', now())
            -&gt;where('status', 'active')
            -&gt;exists();
    }
}
</code></pre>
<h2 id="security-monitoring">Security Monitoring</h2>
<h3 id="intrusion-detection">Intrusion Detection</h3>
<pre><code class="language-php">// app/Services/Security/IntrusionDetector.php
class IntrusionDetector
{
    protected array $suspiciousPatterns = [
        'sql_injection' =&gt; [
            '/union.*select/i',
            '/select.*from.*information_schema/i',
            '/into\s+outfile/i',
        ],
        'xss_attempt' =&gt; [
            '/&lt;script[^&gt;]*&gt;.*?&lt;\/script&gt;/si',
            '/javascript:/i',
            '/on\w+\s*=/i',
        ],
        'path_traversal' =&gt; [
            '/\.\.\//',
            '/\.\.\\\\/',
            '/%2e%2e%2f/i',
        ],
        'command_injection' =&gt; [
            '/;\s*cat\s+/i',
            '/\|\s*nc\s+/i',
            '/`.*`/',
        ],
    ];

    public function detect(Request $request): ?SecurityThreat
    {
        $data = array_merge(
            $request-&gt;all(),
            ['url' =&gt; $request-&gt;fullUrl()],
            $request-&gt;headers-&gt;all()
        );

        foreach ($data as $key =&gt; $value) {
            if (!is_string($value)) continue;

            foreach ($this-&gt;suspiciousPatterns as $type =&gt; $patterns) {
                foreach ($patterns as $pattern) {
                    if (preg_match($pattern, $value)) {
                        return new SecurityThreat($type, $pattern, $value, $request);
                    }
                }
            }
        }

        return null;
    }
}
</code></pre>
<h3 id="security-event-logging">Security Event Logging</h3>
<pre><code class="language-php">// app/Services/Security/SecurityLogger.php
class SecurityLogger
{
    public function logSecurityEvent(string $type, array $context): void
    {
        $event = SecurityEvent::create([
            'type' =&gt; $type,
            'severity' =&gt; $this-&gt;getSeverity($type),
            'ip_address' =&gt; request()-&gt;ip(),
            'user_agent' =&gt; request()-&gt;userAgent(),
            'user_id' =&gt; auth()-&gt;id(),
            'context' =&gt; $context,
            'occurred_at' =&gt; now(),
        ]);

        // Alert if critical
        if ($event-&gt;severity === 'critical') {
            $this-&gt;alertSecurityTeam($event);
        }

        // Log to separate security log
        Log::channel('security')-&gt;warning(&quot;Security event: {$type}&quot;, $context);
    }

    protected function getSeverity(string $type): string
    {
        return match($type) {
            'sql_injection', 'command_injection' =&gt; 'critical',
            'xss_attempt', 'path_traversal' =&gt; 'high',
            'invalid_signature', 'rate_limit_exceeded' =&gt; 'medium',
            default =&gt; 'low',
        };
    }
}
</code></pre>
<h2 id="compliance-auditing">Compliance &amp; Auditing</h2>
<h3 id="audit-trail">Audit Trail</h3>
<pre><code class="language-php">// app/Traits/Auditable.php
trait Auditable
{
    public static function bootAuditable()
    {
        static::created(function ($model) {
            AuditLog::create([
                'user_id' =&gt; auth()-&gt;id(),
                'company_id' =&gt; $model-&gt;company_id ?? auth()-&gt;user()?-&gt;company_id,
                'model_type' =&gt; get_class($model),
                'model_id' =&gt; $model-&gt;id,
                'event' =&gt; 'created',
                'old_values' =&gt; null,
                'new_values' =&gt; $model-&gt;getAttributes(),
                'ip_address' =&gt; request()-&gt;ip(),
                'user_agent' =&gt; request()-&gt;userAgent(),
            ]);
        });

        static::updated(function ($model) {
            AuditLog::create([
                'user_id' =&gt; auth()-&gt;id(),
                'company_id' =&gt; $model-&gt;company_id ?? auth()-&gt;user()?-&gt;company_id,
                'model_type' =&gt; get_class($model),
                'model_id' =&gt; $model-&gt;id,
                'event' =&gt; 'updated',
                'old_values' =&gt; $model-&gt;getOriginal(),
                'new_values' =&gt; $model-&gt;getChanges(),
                'ip_address' =&gt; request()-&gt;ip(),
                'user_agent' =&gt; request()-&gt;userAgent(),
            ]);
        });
    }
}
</code></pre>
<h3 id="gdpr-compliance">GDPR Compliance</h3>
<pre><code class="language-php">// config/gdpr.php
return [
    'data_retention' =&gt; [
        'audit_logs' =&gt; 365 * 2, // 2 years
        'security_events' =&gt; 365, // 1 year
        'api_logs' =&gt; 90, // 90 days
        'temporary_files' =&gt; 7, // 7 days
    ],

    'anonymization' =&gt; [
        'fields' =&gt; [
            'name' =&gt; 'Anonymous User',
            'email' =&gt; 'deleted@example.com',
            'phone' =&gt; '+00000000000',
            'address' =&gt; 'Deleted',
        ],
    ],

    'export_formats' =&gt; ['json', 'csv', 'pdf'],

    'consent_types' =&gt; [
        'marketing',
        'analytics',
        'necessary',
    ],
];
</code></pre>
<h2 id="security-best-practices">Security Best Practices</h2>
<h3 id="password-policy">Password Policy</h3>
<pre><code class="language-php">// app/Rules/StrongPassword.php
class StrongPassword implements Rule
{
    public function passes($attribute, $value)
    {
        // Minimum length
        if (strlen($value) &lt; config('auth.password.min_length')) {
            return false;
        }

        // Require uppercase
        if (config('auth.password.require_uppercase') &amp;&amp; !preg_match('/[A-Z]/', $value)) {
            return false;
        }

        // Require numeric
        if (config('auth.password.require_numeric') &amp;&amp; !preg_match('/[0-9]/', $value)) {
            return false;
        }

        // Require special character
        if (config('auth.password.require_special') &amp;&amp; !preg_match('/[^A-Za-z0-9]/', $value)) {
            return false;
        }

        // Check against common passwords
        if ($this-&gt;isCommonPassword($value)) {
            return false;
        }

        return true;
    }
}
</code></pre>
<h3 id="session-security">Session Security</h3>
<pre><code class="language-php">// app/Http/Middleware/SessionSecurity.php
class SessionSecurity
{
    public function handle($request, Closure $next)
    {
        // Regenerate session ID on login
        if ($request-&gt;session()-&gt;get('just_logged_in')) {
            $request-&gt;session()-&gt;regenerate();
            $request-&gt;session()-&gt;forget('just_logged_in');
        }

        // Check for session hijacking
        $currentIp = $request-&gt;ip();
        $sessionIp = $request-&gt;session()-&gt;get('ip_address');

        if ($sessionIp &amp;&amp; $sessionIp !== $currentIp) {
            auth()-&gt;logout();
            $request-&gt;session()-&gt;invalidate();

            return redirect('/login')
                -&gt;with('error', 'Session security violation detected');
        }

        // Store current IP
        $request-&gt;session()-&gt;put('ip_address', $currentIp);

        return $next($request);
    }
}
</code></pre>
<h2 id="related-documentation">Related Documentation</h2>
<ul>
<li><a href="../environment/">Environment Configuration</a></li>
<li><a href="../api/authentication.md">API Authentication</a></li>
<li><a href="../../features/gdpr/">GDPR Compliance</a></li>
<li><a href="../../operations/monitoring/">Monitoring</a></li>
</ul>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme_extra.js" defer></script>
    <script src="../../../js/theme.js" defer></script>
      <script src="../../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>

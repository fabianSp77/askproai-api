<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://api.askproai.de/mkdocs/docs/migration/service-unification/" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>Service Unification Guide - AskProAI Dokumentation</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Service Unification Guide";
        var mkdocs_page_input_path = "docs/migration/service-unification.md";
        var mkdocs_page_url = "/mkdocs/docs/migration/service-unification/";
      </script>
    
    <script src="../../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> AskProAI Dokumentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Start</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Hauptdokumentation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../CLAUDE/">Projekt Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../CLAUDE_QUICK_REFERENCE/">Quick Reference</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../CLAUDE_CONTEXT_SUMMARY/">Context Summary</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Power User</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../TOP_10_COMMANDS/">Top 10 Commands</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../CLAUDE_BEFEHLE_FUER_DICH/">Claude Befehle für dich</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../MY_COMMANDS/">Meine Commands</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Best Practices 2025</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../BEST_PRACTICES_IMPLEMENTATION/">Implementation Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../DEVELOPMENT_PROCESS_2025/">Development Process</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../CLAUDE_DOCUMENTATION_GAPS_ANALYSIS.md">Documentation Gaps</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Schnellstart</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../5-MINUTEN_ONBOARDING_PLAYBOOK/">5-Minuten Onboarding</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Architektur</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/overview/">Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/services/">Services</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/system-design/">System Design</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/mcp-architecture/">MCP Architecture</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/database-schema/">Database Schema</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/security/">Security</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../architecture/performance/">Performance</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../../api/overview.md">Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../api/authentication/">Authentication</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../api/endpoints.md">Endpoints</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../api/webhooks/">Webhooks</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Features</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../features/appointment-booking/">Appointment Booking</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../features/call-management.md">Call Management</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../features/customer-portal.md">Customer Portal</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../features/multi-tenancy/">Multi-Tenancy</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Development</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../../development/setup.md">Setup</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../development/testing.md">Testing</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../development/code-standards.md">Code Standards</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Deployment</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../../deployment/overview.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../deployment/production.md">Production</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../deployment/environment-variables.md">Environment Variables</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Betrieb</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../CUSTOMER_SUCCESS_RUNBOOK/">Customer Success</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../EMERGENCY_RESPONSE_PLAYBOOK/">Emergency Response</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../ERROR_PATTERNS/">Error Patterns</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../TROUBLESHOOTING_DECISION_TREE/">Troubleshooting</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../DEPLOYMENT_CHECKLIST/">Deployment Checklist</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Monitoring</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../KPI_DASHBOARD_TEMPLATE/">KPI Dashboard</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../INTEGRATION_HEALTH_MONITOR/">Health Monitor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../PHONE_TO_APPOINTMENT_FLOW/">Phone to Appointment Flow</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">AskProAI Dokumentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
      <li>Service Unification Guide</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="service-unification-guide">Service Unification Guide</h1>
<h2 id="overview">Overview</h2>
<p>This guide covers the unification of multiple service classes in AskProAI, consolidating from 7 Cal.com services and 5 Retell services into a streamlined architecture with 3 unified services.</p>
<h2 id="current-service-chaos">Current Service Chaos</h2>
<h3 id="problem-analysis">Problem Analysis</h3>
<pre><code class="language-yaml">Current State:
  Cal.com Services (7):
    - CalcomService
    - CalcomV2Service  
    - CalcomServiceV1Legacy
    - CalcomBackwardsCompatibility
    - CalcomEventTypeSyncService
    - CalendarService
    - BaseCalendarService

  Retell Services (5):
    - RetellService
    - RetellV2Service
    - RetellWebhookHandler
    - RetellAgentProvisioner
    - CallDataRefresher

Issues:
  - Duplicate functionality across services
  - Inconsistent API usage (v1 vs v2)
  - Unclear service responsibilities
  - Difficult to maintain and debug
  - Performance overhead from multiple instances
</code></pre>
<h3 id="target-architecture">Target Architecture</h3>
<pre><code class="language-yaml">Unified Services (3):
  CalendarService:
    - Single interface for all calendar operations
    - Handles both Cal.com v2 and fallback providers
    - Manages availability, bookings, and sync

  PhoneService:
    - Unified interface for phone/AI operations
    - Handles Retell.ai and future providers
    - Manages calls, agents, and webhooks

  IntegrationService:
    - Webhook processing for all providers
    - Event routing and transformation
    - Retry and error handling
</code></pre>
<h2 id="implementation-plan">Implementation Plan</h2>
<h3 id="phase-1-service-analysis">Phase 1: Service Analysis</h3>
<pre><code class="language-php">// app/Console/Commands/AnalyzeServices.php
namespace App\Console\Commands;

use Illuminate\Console\Command;
use ReflectionClass;

class AnalyzeServices extends Command
{
    protected $signature = 'services:analyze';

    public function handle()
    {
        $services = $this-&gt;findServices();

        foreach ($services as $service) {
            $this-&gt;analyzeService($service);
        }

        $this-&gt;generateReport();
    }

    private function findServices(): array
    {
        $services = [];
        $files = glob(app_path('Services/**/*Service.php'));

        foreach ($files as $file) {
            $class = $this-&gt;getClassFromFile($file);
            if (class_exists($class)) {
                $services[] = $class;
            }
        }

        return $services;
    }

    private function analyzeService(string $class): void
    {
        $reflection = new ReflectionClass($class);
        $methods = $reflection-&gt;getMethods(\ReflectionMethod::IS_PUBLIC);

        $this-&gt;info(&quot;Analyzing: {$class}&quot;);
        $this-&gt;line(&quot;Methods: &quot; . count($methods));

        // Check for duplicate functionality
        foreach ($methods as $method) {
            $this-&gt;checkDuplicates($class, $method-&gt;getName());
        }
    }
}
</code></pre>
<h3 id="phase-2-create-unified-interfaces">Phase 2: Create Unified Interfaces</h3>
<h4 id="calendar-service-interface">Calendar Service Interface</h4>
<pre><code class="language-php">// app/Contracts/CalendarServiceInterface.php
namespace App\Contracts;

use Carbon\Carbon;
use App\Models\Appointment;

interface CalendarServiceInterface
{
    /**
     * Check availability for a time slot
     */
    public function checkAvailability(
        int $eventTypeId,
        Carbon $dateTime,
        int $duration
    ): bool;

    /**
     * Create a booking
     */
    public function createBooking(array $data): array;

    /**
     * Update existing booking
     */
    public function updateBooking(string $bookingId, array $data): array;

    /**
     * Cancel booking
     */
    public function cancelBooking(string $bookingId, string $reason = null): bool;

    /**
     * Get available slots
     */
    public function getAvailableSlots(
        int $eventTypeId,
        Carbon $startDate,
        Carbon $endDate
    ): array;

    /**
     * Sync event types
     */
    public function syncEventTypes(): array;
}
</code></pre>
<h4 id="phone-service-interface">Phone Service Interface</h4>
<pre><code class="language-php">// app/Contracts/PhoneServiceInterface.php
namespace App\Contracts;

interface PhoneServiceInterface
{
    /**
     * Process incoming call
     */
    public function handleIncomingCall(array $data): void;

    /**
     * Process call ended event
     */
    public function handleCallEnded(array $data): void;

    /**
     * Get call details
     */
    public function getCallDetails(string $callId): array;

    /**
     * Update agent configuration
     */
    public function updateAgent(string $agentId, array $config): bool;

    /**
     * Process call transcript
     */
    public function processTranscript(string $callId, string $transcript): void;
}
</code></pre>
<h3 id="phase-3-implement-unified-services">Phase 3: Implement Unified Services</h3>
<h4 id="unified-calendar-service">Unified Calendar Service</h4>
<pre><code class="language-php">// app/Services/Unified/CalendarService.php
namespace App\Services\Unified;

use App\Contracts\CalendarServiceInterface;
use App\Services\Providers\CalcomProvider;
use App\Services\Providers\GoogleCalendarProvider;
use Illuminate\Support\Facades\Cache;
use Illuminate\Support\Facades\Log;

class CalendarService implements CalendarServiceInterface
{
    private $provider;
    private $cache;

    public function __construct()
    {
        $this-&gt;provider = $this-&gt;resolveProvider();
        $this-&gt;cache = Cache::store('redis');
    }

    private function resolveProvider()
    {
        $providerClass = config('calendar.default_provider', CalcomProvider::class);
        return app($providerClass);
    }

    public function checkAvailability(
        int $eventTypeId,
        Carbon $dateTime,
        int $duration
    ): bool {
        $cacheKey = &quot;availability:{$eventTypeId}:{$dateTime-&gt;format('Y-m-d-H:i')}:{$duration}&quot;;

        return $this-&gt;cache-&gt;remember($cacheKey, 300, function () use ($eventTypeId, $dateTime, $duration) {
            try {
                return $this-&gt;provider-&gt;checkAvailability($eventTypeId, $dateTime, $duration);
            } catch (\Exception $e) {
                Log::error('Calendar availability check failed', [
                    'event_type_id' =&gt; $eventTypeId,
                    'datetime' =&gt; $dateTime-&gt;toIso8601String(),
                    'error' =&gt; $e-&gt;getMessage(),
                ]);

                // Fallback to optimistic availability
                return true;
            }
        });
    }

    public function createBooking(array $data): array
    {
        DB::beginTransaction();

        try {
            // Lock time slot
            $lock = $this-&gt;lockTimeSlot($data['eventTypeId'], $data['dateTime']);

            if (!$lock) {
                throw new BookingException('Time slot is being booked by another user');
            }

            // Create booking with provider
            $booking = $this-&gt;provider-&gt;createBooking($data);

            // Store booking reference
            $this-&gt;storeBookingReference($booking);

            DB::commit();

            return $booking;

        } catch (\Exception $e) {
            DB::rollBack();
            $this-&gt;releaseLock($lock);
            throw $e;
        }
    }

    private function lockTimeSlot(int $eventTypeId, Carbon $dateTime): ?string
    {
        $lockKey = &quot;booking_lock:{$eventTypeId}:{$dateTime-&gt;format('Y-m-d-H:i')}&quot;;
        $lockId = Str::uuid();

        if ($this-&gt;cache-&gt;add($lockKey, $lockId, 120)) {
            return $lockId;
        }

        return null;
    }
}
</code></pre>
<h4 id="unified-phone-service">Unified Phone Service</h4>
<pre><code class="language-php">// app/Services/Unified/PhoneService.php
namespace App\Services\Unified;

use App\Contracts\PhoneServiceInterface;
use App\Models\Call;
use App\Models\PhoneNumber;
use App\Jobs\ProcessCallTranscript;
use App\Events\CallReceived;
use App\Events\CallEnded;

class PhoneService implements PhoneServiceInterface
{
    private $provider;

    public function __construct()
    {
        $this-&gt;provider = $this-&gt;resolveProvider();
    }

    private function resolveProvider()
    {
        $providerClass = config('phone.default_provider', RetellProvider::class);
        return app($providerClass);
    }

    public function handleIncomingCall(array $data): void
    {
        // Resolve phone number to branch
        $phoneNumber = PhoneNumber::where('number', $data['to_number'])-&gt;first();

        if (!$phoneNumber) {
            Log::warning('Unknown phone number', ['number' =&gt; $data['to_number']]);
            return;
        }

        // Create call record
        $call = Call::create([
            'external_id' =&gt; $data['call_id'],
            'phone_number_id' =&gt; $phoneNumber-&gt;id,
            'branch_id' =&gt; $phoneNumber-&gt;branch_id,
            'company_id' =&gt; $phoneNumber-&gt;branch-&gt;company_id,
            'from_number' =&gt; $data['from_number'],
            'to_number' =&gt; $data['to_number'],
            'status' =&gt; 'in_progress',
            'started_at' =&gt; now(),
            'metadata' =&gt; $data,
        ]);

        event(new CallReceived($call));
    }

    public function handleCallEnded(array $data): void
    {
        $call = Call::where('external_id', $data['call_id'])-&gt;first();

        if (!$call) {
            Log::error('Call not found', ['call_id' =&gt; $data['call_id']]);
            return;
        }

        $call-&gt;update([
            'status' =&gt; 'completed',
            'ended_at' =&gt; now(),
            'duration' =&gt; $data['duration'] ?? null,
            'recording_url' =&gt; $data['recording_url'] ?? null,
            'transcript' =&gt; $data['transcript'] ?? null,
            'analysis' =&gt; $data['analysis'] ?? null,
        ]);

        // Process transcript asynchronously
        if (!empty($data['transcript'])) {
            ProcessCallTranscript::dispatch($call);
        }

        event(new CallEnded($call));
    }

    public function processTranscript(string $callId, string $transcript): void
    {
        $call = Call::where('external_id', $callId)-&gt;first();

        if (!$call) {
            return;
        }

        // Extract booking intent
        $bookingData = $this-&gt;extractBookingIntent($transcript);

        if ($bookingData) {
            $this-&gt;createAppointmentFromCall($call, $bookingData);
        }
    }

    private function extractBookingIntent(string $transcript): ?array
    {
        // Use NLP or regex to extract booking information
        // This is a simplified example

        $patterns = [
            'date' =&gt; '/(?:tomorrow|next \w+day|(\d{1,2})[\/\-](\d{1,2}))/i',
            'time' =&gt; '/(\d{1,2}):?(\d{2})?\s*(am|pm)?/i',
            'service' =&gt; '/(haircut|massage|consultation)/i',
        ];

        $extracted = [];

        foreach ($patterns as $key =&gt; $pattern) {
            if (preg_match($pattern, $transcript, $matches)) {
                $extracted[$key] = $matches[0];
            }
        }

        return !empty($extracted) ? $extracted : null;
    }
}
</code></pre>
<h3 id="phase-4-migration-strategy">Phase 4: Migration Strategy</h3>
<h4 id="service-migration-plan">Service Migration Plan</h4>
<pre><code class="language-php">// app/Services/Migration/ServiceMigrator.php
namespace App\Services\Migration;

class ServiceMigrator
{
    private $mappings = [
        // Old service =&gt; New service method
        'CalcomService@getEventTypes' =&gt; 'CalendarService@syncEventTypes',
        'CalcomV2Service@checkAvailability' =&gt; 'CalendarService@checkAvailability',
        'RetellService@processWebhook' =&gt; 'PhoneService@handleWebhook',
        'RetellWebhookHandler@handle' =&gt; 'IntegrationService@processWebhook',
    ];

    public function migrate(): void
    {
        $this-&gt;updateServiceReferences();
        $this-&gt;updateConfigurations();
        $this-&gt;updateJobReferences();
        $this-&gt;cleanupOldServices();
    }

    private function updateServiceReferences(): void
    {
        $files = $this-&gt;findPhpFiles(app_path());

        foreach ($files as $file) {
            $content = file_get_contents($file);
            $updated = $this-&gt;replaceServiceCalls($content);

            if ($content !== $updated) {
                file_put_contents($file, $updated);
                $this-&gt;info(&quot;Updated: {$file}&quot;);
            }
        }
    }

    private function replaceServiceCalls(string $content): string
    {
        foreach ($this-&gt;mappings as $old =&gt; $new) {
            [$oldService, $oldMethod] = explode('@', $old);
            [$newService, $newMethod] = explode('@', $new);

            // Replace service instantiation
            $content = str_replace(
                &quot;new {$oldService}&quot;,
                &quot;app(\\App\\Services\\Unified\\{$newService}::class)&quot;,
                $content
            );

            // Replace method calls
            $content = preg_replace(
                &quot;/{$oldService}::{$oldMethod}/&quot;,
                &quot;{$newService}::{$newMethod}&quot;,
                $content
            );
        }

        return $content;
    }
}
</code></pre>
<h4 id="configuration-updates">Configuration Updates</h4>
<pre><code class="language-php">// config/services.php
return [
    'calendar' =&gt; [
        'default_provider' =&gt; \App\Services\Providers\CalcomProvider::class,
        'providers' =&gt; [
            'calcom' =&gt; [
                'class' =&gt; \App\Services\Providers\CalcomProvider::class,
                'api_version' =&gt; 'v2',
                'base_url' =&gt; env('CALCOM_API_URL', 'https://api.cal.com/v2'),
                'timeout' =&gt; 30,
            ],
            'google' =&gt; [
                'class' =&gt; \App\Services\Providers\GoogleCalendarProvider::class,
                'client_id' =&gt; env('GOOGLE_CLIENT_ID'),
                'client_secret' =&gt; env('GOOGLE_CLIENT_SECRET'),
            ],
        ],
    ],

    'phone' =&gt; [
        'default_provider' =&gt; \App\Services\Providers\RetellProvider::class,
        'providers' =&gt; [
            'retell' =&gt; [
                'class' =&gt; \App\Services\Providers\RetellProvider::class,
                'api_key' =&gt; env('RETELL_API_KEY'),
                'webhook_secret' =&gt; env('RETELL_WEBHOOK_SECRET'),
            ],
            'twilio' =&gt; [
                'class' =&gt; \App\Services\Providers\TwilioProvider::class,
                'account_sid' =&gt; env('TWILIO_ACCOUNT_SID'),
                'auth_token' =&gt; env('TWILIO_AUTH_TOKEN'),
            ],
        ],
    ],
];
</code></pre>
<h3 id="phase-5-testing-migration">Phase 5: Testing Migration</h3>
<h4 id="service-compatibility-tests">Service Compatibility Tests</h4>
<pre><code class="language-php">// tests/Integration/ServiceMigrationTest.php
namespace Tests\Integration;

use Tests\TestCase;
use App\Services\Unified\CalendarService;
use App\Services\CalcomV2Service;

class ServiceMigrationTest extends TestCase
{
    /** @test */
    public function unified_calendar_service_maintains_compatibility()
    {
        // Old service
        $oldService = new CalcomV2Service();
        $oldResult = $oldService-&gt;checkAvailability(1, '2025-07-01', '14:00');

        // New service
        $newService = app(CalendarService::class);
        $newResult = $newService-&gt;checkAvailability(
            1, 
            Carbon::parse('2025-07-01 14:00'), 
            60
        );

        $this-&gt;assertEquals($oldResult, $newResult);
    }

    /** @test */
    public function all_endpoints_use_unified_services()
    {
        $routes = Route::getRoutes();

        foreach ($routes as $route) {
            $controller = $route-&gt;getController();

            if ($controller) {
                $reflection = new \ReflectionClass($controller);
                $constructor = $reflection-&gt;getConstructor();

                if ($constructor) {
                    $params = $constructor-&gt;getParameters();

                    foreach ($params as $param) {
                        $type = $param-&gt;getType();
                        if ($type &amp;&amp; !$type-&gt;isBuiltin()) {
                            $this-&gt;assertNotContains(
                                $type-&gt;getName(),
                                ['CalcomService', 'RetellService'],
                                &quot;Controller {$reflection-&gt;getName()} still uses old service&quot;
                            );
                        }
                    }
                }
            }
        }
    }
}
</code></pre>
<h3 id="phase-6-deployment">Phase 6: Deployment</h3>
<h4 id="deployment-checklist">Deployment Checklist</h4>
<pre><code class="language-yaml">Pre-deployment:
  - [ ] All tests passing
  - [ ] Service migration script tested
  - [ ] Rollback plan prepared
  - [ ] Performance benchmarks recorded

Deployment Steps:
  1. Enable maintenance mode
  2. Backup current state
  3. Run service migration
  4. Update configurations
  5. Clear all caches
  6. Run health checks
  7. Monitor for 30 minutes
  8. Disable maintenance mode

Post-deployment:
  - [ ] Monitor error rates
  - [ ] Check performance metrics
  - [ ] Verify webhook processing
  - [ ] Test critical paths
</code></pre>
<h4 id="rollback-procedure">Rollback Procedure</h4>
<pre><code class="language-bash">#!/bin/bash
# rollback-services.sh

echo &quot;Rolling back service unification...&quot;

# Restore old service files
git checkout HEAD~1 -- app/Services/

# Restore configurations
cp config/services.php.backup config/services.php

# Clear caches
php artisan cache:clear
php artisan config:clear
php artisan route:clear

# Restart services
php artisan horizon:terminate
sudo supervisorctl restart all

echo &quot;Rollback complete&quot;
</code></pre>
<h2 id="monitoring">Monitoring</h2>
<h3 id="service-health-dashboard">Service Health Dashboard</h3>
<pre><code class="language-php">// app/Http/Controllers/ServiceHealthController.php
class ServiceHealthController extends Controller
{
    public function index()
    {
        $services = [
            'calendar' =&gt; app(CalendarService::class),
            'phone' =&gt; app(PhoneService::class),
            'integration' =&gt; app(IntegrationService::class),
        ];

        $health = [];

        foreach ($services as $name =&gt; $service) {
            $health[$name] = [
                'status' =&gt; $this-&gt;checkServiceHealth($service),
                'response_time' =&gt; $this-&gt;measureResponseTime($service),
                'error_rate' =&gt; $this-&gt;getErrorRate($name),
                'last_success' =&gt; $this-&gt;getLastSuccess($name),
            ];
        }

        return view('admin.service-health', compact('health'));
    }
}
</code></pre>
<h3 id="performance-tracking">Performance Tracking</h3>
<pre><code class="language-php">// app/Services/Monitoring/ServiceMetrics.php
class ServiceMetrics
{
    public function track(string $service, string $method, callable $operation)
    {
        $start = microtime(true);
        $success = true;

        try {
            $result = $operation();
        } catch (\Exception $e) {
            $success = false;
            throw $e;
        } finally {
            $duration = microtime(true) - $start;

            $this-&gt;recordMetric($service, $method, $duration, $success);
        }

        return $result;
    }

    private function recordMetric(
        string $service, 
        string $method, 
        float $duration, 
        bool $success
    ): void {
        DB::table('service_metrics')-&gt;insert([
            'service' =&gt; $service,
            'method' =&gt; $method,
            'duration_ms' =&gt; $duration * 1000,
            'success' =&gt; $success,
            'timestamp' =&gt; now(),
        ]);

        // Send to monitoring service
        if (config('services.monitoring.enabled')) {
            app('prometheus')-&gt;histogram(
                'service_duration_seconds',
                $duration,
                ['service' =&gt; $service, 'method' =&gt; $method]
            );
        }
    }
}
</code></pre>
<h2 id="benefits">Benefits</h2>
<h3 id="before-unification">Before Unification</h3>
<ul>
<li>12 service classes</li>
<li>Duplicate code across services</li>
<li>Inconsistent error handling</li>
<li>Complex dependency injection</li>
<li>Difficult to add new providers</li>
</ul>
<h3 id="after-unification">After Unification</h3>
<ul>
<li>3 unified service classes</li>
<li>Single interface per domain</li>
<li>Consistent error handling</li>
<li>Simple dependency injection</li>
<li>Easy to add new providers</li>
</ul>
<h3 id="performance-improvements">Performance Improvements</h3>
<ul>
<li>50% reduction in service initialization time</li>
<li>30% faster API response times</li>
<li>60% reduction in memory usage</li>
<li>Simplified debugging and profiling</li>
</ul>
<h2 id="related-documentation">Related Documentation</h2>
<ul>
<li><a href="../architecture/overview.md">Architecture Overview</a></li>
<li><a href="../../configuration/services/">Service Configuration</a></li>
<li><a href="../../development/testing/">Testing Guide</a></li>
<li><a href="../database-consolidation/">Database Consolidation</a></li>
</ul>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme_extra.js" defer></script>
    <script src="../../../js/theme.js" defer></script>
      <script src="../../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://api.askproai.de/mkdocs/STRUCTURED_LOGGER_GUIDE/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>StructuredLogger Usage Guide - AskProAI Dokumentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "StructuredLogger Usage Guide";
        var mkdocs_page_input_path = "STRUCTURED_LOGGER_GUIDE.md";
        var mkdocs_page_url = "/mkdocs/STRUCTURED_LOGGER_GUIDE/";
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> AskProAI Dokumentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Start</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Hauptdokumentation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../CLAUDE/">Projekt Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../CLAUDE_QUICK_REFERENCE/">Quick Reference</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../CLAUDE_CONTEXT_SUMMARY/">Context Summary</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Power User</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../TOP_10_COMMANDS/">Top 10 Commands</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../CLAUDE_BEFEHLE_FUER_DICH/">Claude Befehle für dich</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../MY_COMMANDS/">Meine Commands</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Best Practices 2025</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../BEST_PRACTICES_IMPLEMENTATION/">Implementation Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../DEVELOPMENT_PROCESS_2025/">Development Process</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../CLAUDE_DOCUMENTATION_GAPS_ANALYSIS.md">Documentation Gaps</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Schnellstart</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../5-MINUTEN_ONBOARDING_PLAYBOOK/">5-Minuten Onboarding</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Architektur</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../architecture/overview/">Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../architecture/services/">Services</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../architecture/system-design/">System Design</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../architecture/mcp-architecture/">MCP Architecture</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../architecture/database-schema/">Database Schema</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../architecture/security/">Security</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../architecture/performance/">Performance</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../api/overview.md">Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../api/authentication/">Authentication</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../api/endpoints.md">Endpoints</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../api/webhooks/">Webhooks</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Features</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../features/appointment-booking/">Appointment Booking</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../features/call-management.md">Call Management</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../features/customer-portal.md">Customer Portal</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../features/multi-tenancy/">Multi-Tenancy</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Development</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../development/setup.md">Setup</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../development/testing.md">Testing</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../development/code-standards.md">Code Standards</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Deployment</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../deployment/overview.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../deployment/production.md">Production</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../deployment/environment-variables.md">Environment Variables</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Betrieb</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../CUSTOMER_SUCCESS_RUNBOOK/">Customer Success</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../EMERGENCY_RESPONSE_PLAYBOOK/">Emergency Response</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../ERROR_PATTERNS/">Error Patterns</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../TROUBLESHOOTING_DECISION_TREE/">Troubleshooting</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../DEPLOYMENT_CHECKLIST/">Deployment Checklist</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Monitoring</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../KPI_DASHBOARD_TEMPLATE/">KPI Dashboard</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../INTEGRATION_HEALTH_MONITOR/">Health Monitor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../PHONE_TO_APPOINTMENT_FLOW/">Phone to Appointment Flow</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">AskProAI Dokumentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
      <li>StructuredLogger Usage Guide</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="structuredlogger-usage-guide">StructuredLogger Usage Guide</h1>
<h2 id="overview">Overview</h2>
<p>The StructuredLogger service provides a comprehensive logging solution for AskProAI that:
- Automatically includes correlation IDs for request tracing
- Logs API calls to the ApiCallLog model for monitoring
- Provides structured logging for booking flows
- Includes user, IP, and request context automatically
- Supports different log channels for different purposes
- Integrates seamlessly with the existing logging infrastructure</p>
<h2 id="quick-start">Quick Start</h2>
<h3 id="1-using-the-facade">1. Using the Facade</h3>
<pre><code class="language-php">use App\Facades\StructuredLog;

// Simple logging
StructuredLog::info('Processing appointment request');
StructuredLog::success('Appointment created successfully');
StructuredLog::failure('Failed to create appointment');
StructuredLog::warning('Slot almost fully booked');

// Log with context
StructuredLog::info('Customer lookup', [
    'phone' =&gt; '+49123456789',
    'method' =&gt; 'phone_number'
]);
</code></pre>
<h3 id="2-using-the-trait-in-services">2. Using the Trait in Services</h3>
<pre><code class="language-php">use App\Services\Traits\LogsStructured;

class MyService
{
    use LogsStructured;

    public function processRequest()
    {
        $this-&gt;logInfo('Starting request processing');

        try {
            // Your logic here
            $this-&gt;logSuccess('Request processed successfully');
        } catch (\Exception $e) {
            $this-&gt;logError($e, ['context' =&gt; 'request_processing']);
        }
    }
}
</code></pre>
<h2 id="core-features">Core Features</h2>
<h3 id="1-correlation-ids">1. Correlation IDs</h3>
<p>Every request automatically gets a correlation ID that's included in all logs:</p>
<pre><code class="language-php">// Get current correlation ID
$correlationId = StructuredLog::getCorrelationId();

// Set custom correlation ID (usually not needed)
StructuredLog::setCorrelationId('custom-id-123');
</code></pre>
<h3 id="2-booking-flow-logging">2. Booking Flow Logging</h3>
<p>Track every step of the booking process:</p>
<pre><code class="language-php">// Log booking steps
StructuredLog::logBookingFlow('booking_initiated', [
    'customer_id' =&gt; $customerId,
    'service_id' =&gt; $serviceId,
    'requested_time' =&gt; $requestedTime,
]);

StructuredLog::logBookingFlow('availability_checked', [
    'available' =&gt; true,
    'slots_found' =&gt; 5,
]);

StructuredLog::logBookingFlow('appointment_created', [
    'appointment_id' =&gt; $appointment-&gt;id,
    'confirmation_number' =&gt; $appointment-&gt;confirmation_number,
]);
</code></pre>
<h3 id="3-api-call-logging">3. API Call Logging</h3>
<p>Automatically log all external API calls with timing:</p>
<pre><code class="language-php">// Using the trait
$apiLogger = $this-&gt;logApiCall('/v2/bookings', 'POST', [
    'name' =&gt; 'John Doe',
    'email' =&gt; 'john@example.com',
    'eventTypeId' =&gt; 123,
]);

try {
    $response = Http::post('https://api.cal.com/v2/bookings', $data);

    if ($response-&gt;successful()) {
        $apiLogger-&gt;success($response);
    } else {
        $apiLogger-&gt;failure($response, 'API returned error');
    }
} catch (\Exception $e) {
    $apiLogger-&gt;exception($e);
}
</code></pre>
<h3 id="4-webhook-logging">4. Webhook Logging</h3>
<p>Log incoming webhooks with automatic context:</p>
<pre><code class="language-php">StructuredLog::logWebhook('retell', 'call_ended', $payload, [
    'signature_valid' =&gt; true,
    'call_duration' =&gt; 120,
]);
</code></pre>
<h3 id="5-performance-logging">5. Performance Logging</h3>
<p>Track performance metrics:</p>
<pre><code class="language-php">$startTime = microtime(true);

// Do some work...

$duration = microtime(true) - $startTime;

StructuredLog::logPerformance('data_import', $duration, [
    'records_processed' =&gt; 1000,
    'records_per_second' =&gt; 1000 / $duration,
]);
</code></pre>
<h3 id="6-security-event-logging">6. Security Event Logging</h3>
<p>Log security-related events:</p>
<pre><code class="language-php">StructuredLog::logSecurity('invalid_api_key', 'warning', [
    'api_key_prefix' =&gt; substr($apiKey, 0, 8) . '...',
    'ip_address' =&gt; request()-&gt;ip(),
]);

StructuredLog::logSecurity('multiple_failed_logins', 'critical', [
    'user_email' =&gt; $email,
    'attempts' =&gt; 5,
]);
</code></pre>
<h2 id="log-channels">Log Channels</h2>
<p>The following channels are configured:</p>
<ul>
<li><code>booking_flow</code> - Booking process steps</li>
<li><code>api</code> - General API calls</li>
<li><code>calcom</code> - Cal.com specific logs</li>
<li><code>retell</code> - Retell.ai specific logs</li>
<li><code>webhooks</code> - Incoming webhooks</li>
<li><code>critical</code> - Critical errors</li>
<li><code>slow_queries</code> - Performance issues</li>
</ul>
<h2 id="database-storage">Database Storage</h2>
<h3 id="apicalllog-model">ApiCallLog Model</h3>
<p>All API calls are automatically stored in the <code>api_call_logs</code> table:</p>
<pre><code class="language-php">// Query API call logs
use App\Models\ApiCallLog;

// Get recent Cal.com errors
$errors = ApiCallLog::forService('calcom')
    -&gt;failed()
    -&gt;latest()
    -&gt;take(10)
    -&gt;get();

// Get statistics
$stats = ApiCallLog::getServiceStats('calcom', now()-&gt;subDay(), now());
</code></pre>
<h3 id="bookingflowlog-table">BookingFlowLog Table</h3>
<p>Booking flow steps are stored in <code>booking_flow_logs</code>:</p>
<pre><code class="language-sql">SELECT step, COUNT(*) as count, AVG(JSON_EXTRACT(context, '$.duration_ms')) as avg_duration
FROM booking_flow_logs
WHERE company_id = ?
  AND created_at &gt;= DATE_SUB(NOW(), INTERVAL 1 DAY)
GROUP BY step;
</code></pre>
<h2 id="middleware-setup">Middleware Setup</h2>
<p>The <code>CorrelationIdMiddleware</code> is automatically applied to all routes. To add it manually:</p>
<pre><code class="language-php">// In routes/api.php or specific route group
Route::middleware(['correlation.id'])-&gt;group(function () {
    // Your routes
});
</code></pre>
<h2 id="best-practices">Best Practices</h2>
<h3 id="1-always-include-context">1. Always Include Context</h3>
<pre><code class="language-php">// Bad
StructuredLog::info('User logged in');

// Good
StructuredLog::info('User logged in', [
    'user_id' =&gt; $user-&gt;id,
    'login_method' =&gt; 'email',
    'ip_address' =&gt; request()-&gt;ip(),
]);
</code></pre>
<h3 id="2-use-appropriate-log-levels">2. Use Appropriate Log Levels</h3>
<ul>
<li><code>debug</code> - Detailed debugging information</li>
<li><code>info</code> - Interesting events (user logs in, appointment created)</li>
<li><code>warning</code> - Exceptional occurrences that are not errors</li>
<li><code>error</code> - Runtime errors that need attention</li>
<li><code>critical</code> - Critical problems that need immediate action</li>
</ul>
<h3 id="3-sensitive-data-protection">3. Sensitive Data Protection</h3>
<p>The logger automatically masks sensitive fields:
- password
- api_key
- token
- secret
- credit_card
- authorization
- bearer</p>
<h3 id="4-performance-considerations">4. Performance Considerations</h3>
<pre><code class="language-php">// For high-frequency operations, consider sampling
if (rand(1, 100) === 1) { // Log 1% of requests
    StructuredLog::logPerformance('high_frequency_operation', $duration);
}
</code></pre>
<h2 id="monitoring-and-debugging">Monitoring and Debugging</h2>
<h3 id="finding-related-logs">Finding Related Logs</h3>
<pre><code class="language-php">// Get all logs for a correlation ID
$correlationId = 'abc-123-def';

// In application
$logs = DB::table('booking_flow_logs')
    -&gt;where('correlation_id', $correlationId)
    -&gt;orderBy('created_at')
    -&gt;get();

// In log files
grep &quot;abc-123-def&quot; storage/logs/*.log
</code></pre>
<h3 id="creating-dashboards">Creating Dashboards</h3>
<pre><code class="language-sql">-- Booking funnel analysis
SELECT 
    step,
    COUNT(*) as total,
    COUNT(DISTINCT correlation_id) as unique_sessions,
    AVG(TIMESTAMPDIFF(SECOND, created_at, 
        LEAD(created_at) OVER (PARTITION BY correlation_id ORDER BY created_at)
    )) as avg_seconds_to_next_step
FROM booking_flow_logs
WHERE created_at &gt;= DATE_SUB(NOW(), INTERVAL 1 DAY)
GROUP BY step
ORDER BY total DESC;
</code></pre>
<h2 id="migration-guide">Migration Guide</h2>
<h3 id="updating-existing-services">Updating Existing Services</h3>
<ol>
<li>Add the trait:</li>
</ol>
<pre><code class="language-php">use App\Services\Traits\LogsStructured;

class YourService
{
    use LogsStructured;
</code></pre>
<ol>
<li>Replace Log::info() calls:</li>
</ol>
<pre><code class="language-php">// Before
Log::info('API call to Cal.com', ['endpoint' =&gt; '/bookings']);

// After
$this-&gt;logInfo('API call to Cal.com', ['endpoint' =&gt; '/bookings']);
</code></pre>
<ol>
<li>Add API call logging:</li>
</ol>
<pre><code class="language-php">// Wrap API calls
$apiLogger = $this-&gt;logApiCall('/bookings', 'POST', $data);
try {
    $response = $this-&gt;makeApiCall($data);
    $apiLogger-&gt;success($response);
} catch (\Exception $e) {
    $apiLogger-&gt;exception($e);
}
</code></pre>
<h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="logs-not-appearing">Logs not appearing</h3>
<ol>
<li>Check the channel configuration in <code>config/logging.php</code></li>
<li>Verify permissions on log files</li>
<li>Check if the channel exists: <code>config('logging.channels.your_channel')</code></li>
</ol>
<h3 id="performance-impact">Performance impact</h3>
<p>The logger is designed to be lightweight, but for high-traffic endpoints:</p>
<ol>
<li>Use async logging for non-critical logs</li>
<li>Consider batching API call logs</li>
<li>Implement log rotation policies</li>
</ol>
<h3 id="missing-correlation-ids">Missing correlation IDs</h3>
<p>Ensure the <code>CorrelationIdMiddleware</code> is registered:</p>
<pre><code class="language-php">// In app/Http/Kernel.php or bootstrap/app.php
'api' =&gt; [
    \App\Http\Middleware\CorrelationIdMiddleware::class,
    // other middleware
],
</code></pre>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>

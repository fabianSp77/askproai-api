<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://api.askproai.de/mkdocs/features/multi-tenancy/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Multi-Tenancy - AskProAI Dokumentation</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Multi-Tenancy";
        var mkdocs_page_input_path = "features/multi-tenancy.md";
        var mkdocs_page_url = "/mkdocs/features/multi-tenancy/";
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> AskProAI Dokumentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Start</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Hauptdokumentation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../CLAUDE/">Projekt Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../CLAUDE_QUICK_REFERENCE/">Quick Reference</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../CLAUDE_CONTEXT_SUMMARY/">Context Summary</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Power User</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../TOP_10_COMMANDS/">Top 10 Commands</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../CLAUDE_BEFEHLE_FUER_DICH/">Claude Befehle für dich</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../MY_COMMANDS/">Meine Commands</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Best Practices 2025</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../BEST_PRACTICES_IMPLEMENTATION/">Implementation Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../DEVELOPMENT_PROCESS_2025/">Development Process</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../CLAUDE_DOCUMENTATION_GAPS_ANALYSIS.md">Documentation Gaps</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Schnellstart</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../5-MINUTEN_ONBOARDING_PLAYBOOK/">5-Minuten Onboarding</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Architektur</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../architecture/overview/">Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../architecture/services/">Services</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../architecture/system-design/">System Design</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../architecture/mcp-architecture/">MCP Architecture</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../architecture/database-schema/">Database Schema</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../architecture/security/">Security</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../architecture/performance/">Performance</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../api/overview.md">Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/authentication/">Authentication</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../api/endpoints.md">Endpoints</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/webhooks/">Webhooks</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Features</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../appointment-booking/">Appointment Booking</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../call-management.md">Call Management</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../customer-portal.md">Customer Portal</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Multi-Tenancy</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#architecture-model">Architecture Model</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#shared-database-separate-schema">Shared Database, Separate Schema</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#tenant-identification">Tenant Identification</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#1-subdomain-based">1. Subdomain-Based</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#2-header-based-api">2. Header-Based (API)</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#data-isolation">Data Isolation</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#global-scopes">Global Scopes</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#model-implementation">Model Implementation</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#tenant-configuration">Tenant Configuration</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#company-settings">Company Settings</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#tenant-specific-settings">Tenant-Specific Settings</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#feature-management">Feature Management</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#feature-flags">Feature Flags</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#plan-based-features">Plan-Based Features</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#resource-limits">Resource Limits</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#usage-tracking">Usage Tracking</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#resource-limits-by-plan">Resource Limits by Plan</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#database-design">Database Design</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#tenant-aware-tables">Tenant-Aware Tables</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#shared-tables">Shared Tables</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#security-considerations">Security Considerations</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#cross-tenant-protection">Cross-Tenant Protection</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#tenant-admin-isolation">Tenant Admin Isolation</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#customization">Customization</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#white-label-support">White-Label Support</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#custom-domains">Custom Domains</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#monitoring-analytics">Monitoring &amp; Analytics</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#tenant-metrics">Tenant Metrics</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#tenant-health-monitoring">Tenant Health Monitoring</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#best-practices">Best Practices</a>
    </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Development</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../development/setup.md">Setup</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../development/testing.md">Testing</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../development/code-standards.md">Code Standards</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Deployment</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../deployment/overview.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../deployment/production.md">Production</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../deployment/environment-variables.md">Environment Variables</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Betrieb</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../CUSTOMER_SUCCESS_RUNBOOK/">Customer Success</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../EMERGENCY_RESPONSE_PLAYBOOK/">Emergency Response</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../ERROR_PATTERNS/">Error Patterns</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../TROUBLESHOOTING_DECISION_TREE/">Troubleshooting</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../DEPLOYMENT_CHECKLIST/">Deployment Checklist</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Monitoring</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../KPI_DASHBOARD_TEMPLATE/">KPI Dashboard</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../INTEGRATION_HEALTH_MONITOR/">Health Monitor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../PHONE_TO_APPOINTMENT_FLOW/">Phone to Appointment Flow</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">AskProAI Dokumentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Features &raquo;</li>
      <li>Multi-Tenancy</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="multi-tenancy-architecture">Multi-Tenancy Architecture</h1>
<h2 id="overview">Overview</h2>
<p>AskProAI implements a robust multi-tenant architecture that allows multiple companies to use the platform while maintaining complete data isolation, customization, and security. Each company (tenant) operates in their own virtual environment with their data, settings, and integrations.</p>
<h2 id="architecture-model">Architecture Model</h2>
<h3 id="shared-database-separate-schema">Shared Database, Separate Schema</h3>
<pre><code class="language-mermaid">graph TB
    subgraph &quot;Application Layer&quot;
        APP[AskProAI Application]
        MW[Tenant Middleware]
        SCOPE[Global Scopes]
    end

    subgraph &quot;Database Layer&quot;
        DB[(Shared Database)]

        subgraph &quot;Company 1 Data&quot;
            C1[company_id = 1]
            B1[Branches]
            S1[Staff]
            A1[Appointments]
        end

        subgraph &quot;Company 2 Data&quot;
            C2[company_id = 2]
            B2[Branches]
            S2[Staff]
            A2[Appointments]
        end

        subgraph &quot;Company N Data&quot;
            CN[company_id = N]
            BN[Branches]
            SN[Staff]
            AN[Appointments]
        end
    end

    APP --&gt; MW
    MW --&gt; SCOPE
    SCOPE --&gt; DB

    DB --&gt; C1
    DB --&gt; C2
    DB --&gt; CN
</code></pre>
<h2 id="tenant-identification">Tenant Identification</h2>
<h3 id="1-subdomain-based">1. Subdomain-Based</h3>
<pre><code class="language-php">// tenant1.askproai.de → Company 1
// tenant2.askproai.de → Company 2

class TenantIdentificationMiddleware
{
    public function handle($request, Closure $next)
    {
        $subdomain = explode('.', $request-&gt;getHost())[0];

        $company = Company::where('subdomain', $subdomain)
            -&gt;where('active', true)
            -&gt;first();

        if (!$company) {
            abort(404, 'Company not found');
        }

        // Set tenant context
        app()-&gt;instance('tenant', $company);
        Config::set('app.tenant_id', $company-&gt;id);

        return $next($request);
    }
}
</code></pre>
<h3 id="2-header-based-api">2. Header-Based (API)</h3>
<pre><code class="language-php">// X-Company-ID: 1 → Company 1

class ApiTenantMiddleware
{
    public function handle($request, Closure $next)
    {
        $companyId = $request-&gt;header('X-Company-ID');

        if (!$companyId) {
            return response()-&gt;json(['error' =&gt; 'Company ID required'], 400);
        }

        $company = Company::find($companyId);

        if (!$company || !$this-&gt;userBelongsToCompany($company)) {
            return response()-&gt;json(['error' =&gt; 'Unauthorized'], 403);
        }

        app()-&gt;instance('tenant', $company);

        return $next($request);
    }
}
</code></pre>
<h2 id="data-isolation">Data Isolation</h2>
<h3 id="global-scopes">Global Scopes</h3>
<p>Every model with tenant data automatically filters by company:</p>
<pre><code class="language-php">trait BelongsToCompany
{
    protected static function bootBelongsToCompany()
    {
        // Auto-add company_id when creating
        static::creating(function ($model) {
            if (!$model-&gt;company_id &amp;&amp; app()-&gt;has('tenant')) {
                $model-&gt;company_id = app('tenant')-&gt;id;
            }
        });

        // Auto-filter by company_id when querying
        static::addGlobalScope('company', function (Builder $builder) {
            if (app()-&gt;has('tenant')) {
                $builder-&gt;where($builder-&gt;getModel()-&gt;getTable() . '.company_id', app('tenant')-&gt;id);
            }
        });
    }

    public function company()
    {
        return $this-&gt;belongsTo(Company::class);
    }
}
</code></pre>
<h3 id="model-implementation">Model Implementation</h3>
<pre><code class="language-php">class Appointment extends Model
{
    use BelongsToCompany;

    // All queries automatically filtered by company_id
    // Appointment::all() → Only returns current tenant's appointments
}

class Customer extends Model
{
    use BelongsToCompany;

    // Customer::find(1) → Only if customer belongs to current tenant
}
</code></pre>
<h2 id="tenant-configuration">Tenant Configuration</h2>
<h3 id="company-settings">Company Settings</h3>
<pre><code class="language-php">Schema::create('companies', function (Blueprint $table) {
    $table-&gt;id();
    $table-&gt;string('name');
    $table-&gt;string('subdomain')-&gt;unique();
    $table-&gt;string('domain')-&gt;nullable(); // Custom domain
    $table-&gt;json('settings');
    $table-&gt;json('features'); // Feature flags
    $table-&gt;string('timezone')-&gt;default('Europe/Berlin');
    $table-&gt;string('locale')-&gt;default('de_DE');
    $table-&gt;string('currency')-&gt;default('EUR');
    $table-&gt;boolean('active')-&gt;default(true);
    $table-&gt;timestamp('trial_ends_at')-&gt;nullable();
    $table-&gt;string('stripe_customer_id')-&gt;nullable();
    $table-&gt;timestamps();
});
</code></pre>
<h3 id="tenant-specific-settings">Tenant-Specific Settings</h3>
<pre><code class="language-json">{
  &quot;branding&quot;: {
    &quot;primary_color&quot;: &quot;#2563eb&quot;,
    &quot;logo_url&quot;: &quot;https://...&quot;,
    &quot;company_name&quot;: &quot;Hair Salon Berlin&quot;
  },
  &quot;booking&quot;: {
    &quot;advance_booking_days&quot;: 30,
    &quot;minimum_notice_hours&quot;: 2,
    &quot;cancellation_hours&quot;: 24,
    &quot;max_bookings_per_day&quot;: 50
  },
  &quot;notifications&quot;: {
    &quot;sms_enabled&quot;: true,
    &quot;email_enabled&quot;: true,
    &quot;whatsapp_enabled&quot;: false,
    &quot;reminder_hours&quot;: [24, 2]
  },
  &quot;integrations&quot;: {
    &quot;calcom_enabled&quot;: true,
    &quot;google_calendar_enabled&quot;: false,
    &quot;stripe_enabled&quot;: true
  }
}
</code></pre>
<h2 id="feature-management">Feature Management</h2>
<h3 id="feature-flags">Feature Flags</h3>
<pre><code class="language-php">class FeatureFlag
{
    public static function enabled(string $feature, ?Company $company = null): bool
    {
        $company = $company ?? app('tenant');

        // Global feature flags
        if (!config(&quot;features.{$feature}.enabled&quot;, true)) {
            return false;
        }

        // Company-specific flags
        $companyFeatures = $company-&gt;features ?? [];

        // Check if explicitly disabled for company
        if (isset($companyFeatures[$feature])) {
            return $companyFeatures[$feature];
        }

        // Check if feature requires specific plan
        $requiredPlan = config(&quot;features.{$feature}.required_plan&quot;);
        if ($requiredPlan) {
            return $company-&gt;plan-&gt;tier &gt;= $requiredPlan;
        }

        return true;
    }
}

// Usage
if (FeatureFlag::enabled('advanced_analytics')) {
    // Show advanced analytics
}
</code></pre>
<h3 id="plan-based-features">Plan-Based Features</h3>
<pre><code class="language-php">enum PlanTier: int
{
    case FREE = 1;
    case STARTER = 2;
    case PROFESSIONAL = 3;
    case ENTERPRISE = 4;
}

class Plan extends Model
{
    protected $casts = [
        'tier' =&gt; PlanTier::class,
        'limits' =&gt; 'array',
        'features' =&gt; 'array',
    ];

    public function allows(string $feature): bool
    {
        return in_array($feature, $this-&gt;features);
    }

    public function getLimit(string $resource): int
    {
        return $this-&gt;limits[$resource] ?? 0;
    }
}
</code></pre>
<h2 id="resource-limits">Resource Limits</h2>
<h3 id="usage-tracking">Usage Tracking</h3>
<pre><code class="language-php">class UsageTracker
{
    public function track(Company $company, string $resource, int $amount = 1)
    {
        $usage = CompanyUsage::firstOrCreate([
            'company_id' =&gt; $company-&gt;id,
            'resource' =&gt; $resource,
            'period' =&gt; now()-&gt;format('Y-m'),
        ]);

        $usage-&gt;increment('count', $amount);

        // Check limits
        if ($this-&gt;exceedsLimit($company, $resource, $usage-&gt;count)) {
            throw new LimitExceededException($resource);
        }
    }

    public function exceedsLimit(Company $company, string $resource, int $current): bool
    {
        $limit = $company-&gt;plan-&gt;getLimit($resource);
        return $limit &gt; 0 &amp;&amp; $current &gt; $limit;
    }
}
</code></pre>
<h3 id="resource-limits-by-plan">Resource Limits by Plan</h3>
<pre><code class="language-yaml">Free Plan:
  appointments_per_month: 50
  staff_members: 2
  branches: 1
  sms_per_month: 0
  api_calls_per_hour: 100

Professional Plan:
  appointments_per_month: 1000
  staff_members: 10
  branches: 3
  sms_per_month: 500
  api_calls_per_hour: 1000

Enterprise Plan:
  appointments_per_month: unlimited
  staff_members: unlimited
  branches: unlimited
  sms_per_month: unlimited
  api_calls_per_hour: 10000
</code></pre>
<h2 id="database-design">Database Design</h2>
<h3 id="tenant-aware-tables">Tenant-Aware Tables</h3>
<p>All business tables include <code>company_id</code>:</p>
<pre><code class="language-sql">-- Core tables with tenant isolation
CREATE TABLE appointments (
    id BIGINT PRIMARY KEY,
    company_id BIGINT NOT NULL,
    branch_id BIGINT NOT NULL,
    customer_id BIGINT NOT NULL,
    staff_id BIGINT NOT NULL,
    start_time TIMESTAMP NOT NULL,
    -- ... other fields
    FOREIGN KEY (company_id) REFERENCES companies(id),
    INDEX idx_company_appointments (company_id, start_time)
);

CREATE TABLE customers (
    id BIGINT PRIMARY KEY,
    company_id BIGINT NOT NULL,
    name VARCHAR(255) NOT NULL,
    phone VARCHAR(50),
    email VARCHAR(255),
    -- ... other fields
    FOREIGN KEY (company_id) REFERENCES companies(id),
    INDEX idx_company_customers (company_id, phone),
    UNIQUE KEY uk_company_email (company_id, email)
);
</code></pre>
<h3 id="shared-tables">Shared Tables</h3>
<p>Some tables are shared across tenants:</p>
<pre><code class="language-sql">-- Shared system tables
CREATE TABLE plans (
    id BIGINT PRIMARY KEY,
    name VARCHAR(100),
    tier INT,
    price DECIMAL(10,2),
    features JSON,
    limits JSON
);

CREATE TABLE activity_logs (
    id BIGINT PRIMARY KEY,
    company_id BIGINT,
    user_id BIGINT,
    action VARCHAR(100),
    created_at TIMESTAMP,
    INDEX idx_company_activity (company_id, created_at)
);
</code></pre>
<h2 id="security-considerations">Security Considerations</h2>
<h3 id="cross-tenant-protection">Cross-Tenant Protection</h3>
<pre><code class="language-php">class CrossTenantProtectionMiddleware
{
    public function handle($request, Closure $next)
    {
        $response = $next($request);

        // Verify response doesn't leak cross-tenant data
        if ($response-&gt;getStatusCode() === 200) {
            $this-&gt;validateResponseData($response);
        }

        return $response;
    }

    private function validateResponseData($response)
    {
        $data = $response-&gt;getData(true);
        $currentTenantId = app('tenant')-&gt;id;

        // Recursively check all data
        array_walk_recursive($data, function ($value, $key) use ($currentTenantId) {
            if ($key === 'company_id' &amp;&amp; $value != $currentTenantId) {
                throw new CrossTenantDataLeakException();
            }
        });
    }
}
</code></pre>
<h3 id="tenant-admin-isolation">Tenant Admin Isolation</h3>
<pre><code class="language-php">class TenantAdminPolicy
{
    public function viewAny(User $user): bool
    {
        return $user-&gt;hasRole('admin') &amp;&amp; 
               $user-&gt;company_id === app('tenant')-&gt;id;
    }

    public function create(User $user): bool
    {
        // Check if company has capacity for more admins
        $currentAdmins = User::where('company_id', $user-&gt;company_id)
            -&gt;whereHas('roles', fn($q) =&gt; $q-&gt;where('name', 'admin'))
            -&gt;count();

        return $currentAdmins &lt; $user-&gt;company-&gt;plan-&gt;getLimit('admin_users');
    }
}
</code></pre>
<h2 id="customization">Customization</h2>
<h3 id="white-label-support">White-Label Support</h3>
<pre><code class="language-php">class WhiteLabelService
{
    public function getCompanyBranding(Company $company): array
    {
        return [
            'name' =&gt; $company-&gt;settings['branding']['company_name'] ?? $company-&gt;name,
            'logo' =&gt; $company-&gt;settings['branding']['logo_url'] ?? asset('default-logo.png'),
            'colors' =&gt; [
                'primary' =&gt; $company-&gt;settings['branding']['primary_color'] ?? '#2563eb',
                'secondary' =&gt; $company-&gt;settings['branding']['secondary_color'] ?? '#7c3aed',
            ],
            'favicon' =&gt; $company-&gt;settings['branding']['favicon_url'] ?? asset('favicon.ico'),
            'email_footer' =&gt; $company-&gt;settings['branding']['email_footer'] ?? '',
        ];
    }
}
</code></pre>
<h3 id="custom-domains">Custom Domains</h3>
<pre><code class="language-nginx"># Nginx configuration for custom domains
server {
    server_name *.customdomain.com;

    location / {
        proxy_pass http://app;
        proxy_set_header X-Tenant-Domain $host;
        proxy_set_header Host api.askproai.de;
    }
}
</code></pre>
<h2 id="monitoring-analytics">Monitoring &amp; Analytics</h2>
<h3 id="tenant-metrics">Tenant Metrics</h3>
<pre><code class="language-php">class TenantMetricsService
{
    public function getMetrics(Company $company): array
    {
        return Cache::remember(&quot;metrics:company:{$company-&gt;id}&quot;, 300, function () use ($company) {
            return [
                'appointments' =&gt; [
                    'total' =&gt; $company-&gt;appointments()-&gt;count(),
                    'this_month' =&gt; $company-&gt;appointments()-&gt;thisMonth()-&gt;count(),
                    'today' =&gt; $company-&gt;appointments()-&gt;today()-&gt;count(),
                ],
                'customers' =&gt; [
                    'total' =&gt; $company-&gt;customers()-&gt;count(),
                    'active' =&gt; $company-&gt;customers()-&gt;active()-&gt;count(),
                    'new_this_month' =&gt; $company-&gt;customers()-&gt;createdThisMonth()-&gt;count(),
                ],
                'revenue' =&gt; [
                    'this_month' =&gt; $company-&gt;appointments()
                        -&gt;thisMonth()
                        -&gt;completed()
                        -&gt;sum('total_price'),
                ],
                'usage' =&gt; [
                    'api_calls' =&gt; $company-&gt;apiUsage()-&gt;today()-&gt;count(),
                    'sms_sent' =&gt; $company-&gt;notifications()-&gt;where('type', 'sms')-&gt;thisMonth()-&gt;count(),
                ],
            ];
        });
    }
}
</code></pre>
<h3 id="tenant-health-monitoring">Tenant Health Monitoring</h3>
<pre><code class="language-php">class TenantHealthCheck
{
    public function check(Company $company): HealthStatus
    {
        $checks = [
            'database_connection' =&gt; $this-&gt;checkDatabaseConnection($company),
            'api_integration' =&gt; $this-&gt;checkApiIntegrations($company),
            'usage_limits' =&gt; $this-&gt;checkUsageLimits($company),
            'payment_status' =&gt; $this-&gt;checkPaymentStatus($company),
        ];

        $failed = array_filter($checks, fn($check) =&gt; !$check['passed']);

        return new HealthStatus(
            empty($failed) ? 'healthy' : 'unhealthy',
            $checks
        );
    }
}
</code></pre>
<h2 id="best-practices">Best Practices</h2>
<ol>
<li><strong>Always Use Scopes</strong>: Never query without tenant context</li>
<li><strong>Validate Tenant Access</strong>: Double-check in critical operations</li>
<li><strong>Cache Per Tenant</strong>: Include tenant ID in cache keys</li>
<li><strong>Monitor Cross-Tenant</strong>: Log any suspicious access patterns</li>
<li><strong>Test Isolation</strong>: Regular security audits</li>
<li><strong>Plan for Scale</strong>: Design for thousands of tenants</li>
<li><strong>Document Limits</strong>: Clear communication about plan limits</li>
</ol>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../appointment-booking/" class="btn btn-neutral float-left" title="Appointment Booking"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../CUSTOMER_SUCCESS_RUNBOOK/" class="btn btn-neutral float-right" title="Customer Success">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../appointment-booking/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../CUSTOMER_SUCCESS_RUNBOOK/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://api.askproai.de/mkdocs/features/appointment-booking/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Appointment Booking - AskProAI Dokumentation</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Appointment Booking";
        var mkdocs_page_input_path = "features/appointment-booking.md";
        var mkdocs_page_url = "/mkdocs/features/appointment-booking/";
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> AskProAI Dokumentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Start</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Hauptdokumentation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../CLAUDE/">Projekt Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../CLAUDE_QUICK_REFERENCE/">Quick Reference</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../CLAUDE_CONTEXT_SUMMARY/">Context Summary</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Power User</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../TOP_10_COMMANDS/">Top 10 Commands</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../CLAUDE_BEFEHLE_FUER_DICH/">Claude Befehle für dich</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../MY_COMMANDS/">Meine Commands</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Best Practices 2025</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../BEST_PRACTICES_IMPLEMENTATION/">Implementation Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../DEVELOPMENT_PROCESS_2025/">Development Process</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../CLAUDE_DOCUMENTATION_GAPS_ANALYSIS.md">Documentation Gaps</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Schnellstart</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../5-MINUTEN_ONBOARDING_PLAYBOOK/">5-Minuten Onboarding</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Architektur</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../architecture/overview/">Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../architecture/services/">Services</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../architecture/system-design/">System Design</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../architecture/mcp-architecture/">MCP Architecture</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../architecture/database-schema/">Database Schema</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../architecture/security/">Security</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../architecture/performance/">Performance</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../api/overview.md">Übersicht</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/authentication/">Authentication</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../api/endpoints.md">Endpoints</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/webhooks/">Webhooks</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Features</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Appointment Booking</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#booking-channels">Booking Channels</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#core-features">Core Features</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#1-multi-branch-support">1. Multi-Branch Support</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#2-smart-availability-engine">2. Smart Availability Engine</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#3-service-management">3. Service Management</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#service-configuration">Service Configuration</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#service-categories">Service Categories</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#4-staff-assignment">4. Staff Assignment</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#automatic-assignment">Automatic Assignment</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#manual-selection">Manual Selection</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#booking-flow">Booking Flow</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#1-availability-check">1. Availability Check</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#2-booking-creation">2. Booking Creation</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#3-conflict-resolution">3. Conflict Resolution</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#advanced-features">Advanced Features</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#1-recurring-appointments">1. Recurring Appointments</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#2-group-bookings">2. Group Bookings</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#3-waiting-list">3. Waiting List</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#4-smart-rescheduling">4. Smart Rescheduling</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#booking-rules-engine">Booking Rules Engine</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#rule-types">Rule Types</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#rule-application">Rule Application</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#optimization-strategies">Optimization Strategies</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#1-slot-caching">1. Slot Caching</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#2-batch-availability">2. Batch Availability</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#monitoring-analytics">Monitoring &amp; Analytics</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#key-metrics">Key Metrics</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#performance-dashboard">Performance Dashboard</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#best-practices">Best Practices</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="" href="../call-management.md">Call Management</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../customer-portal.md">Customer Portal</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../multi-tenancy/">Multi-Tenancy</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Development</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../development/setup.md">Setup</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../development/testing.md">Testing</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../development/code-standards.md">Code Standards</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Deployment</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../deployment/overview.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../deployment/production.md">Production</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../deployment/environment-variables.md">Environment Variables</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Betrieb</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../CUSTOMER_SUCCESS_RUNBOOK/">Customer Success</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../EMERGENCY_RESPONSE_PLAYBOOK/">Emergency Response</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../ERROR_PATTERNS/">Error Patterns</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../TROUBLESHOOTING_DECISION_TREE/">Troubleshooting</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../DEPLOYMENT_CHECKLIST/">Deployment Checklist</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Monitoring</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../KPI_DASHBOARD_TEMPLATE/">KPI Dashboard</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../INTEGRATION_HEALTH_MONITOR/">Health Monitor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../PHONE_TO_APPOINTMENT_FLOW/">Phone to Appointment Flow</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">AskProAI Dokumentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Features &raquo;</li>
      <li>Appointment Booking</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="appointment-booking-system">Appointment Booking System</h1>
<h2 id="overview">Overview</h2>
<p>The appointment booking system is the heart of AskProAI, providing seamless scheduling across multiple channels - phone, web, and API. It handles complex scheduling logic while maintaining a simple user experience.</p>
<h2 id="booking-channels">Booking Channels</h2>
<pre><code class="language-mermaid">graph LR
    subgraph &quot;Input Channels&quot;
        PHONE[📞 Phone Calls]
        WEB[💻 Web Portal]
        API[🔌 API]
        MOBILE[📱 Mobile App]
    end

    subgraph &quot;Booking Engine&quot;
        VALIDATOR[Validation]
        AVAILABILITY[Availability Check]
        BOOKING[Booking Creation]
        SYNC[External Sync]
    end

    subgraph &quot;Output&quot;
        DB[(Database)]
        CALCOM[Cal.com]
        NOTIFY[Notifications]
        ANALYTICS[Analytics]
    end

    PHONE --&gt; VALIDATOR
    WEB --&gt; VALIDATOR
    API --&gt; VALIDATOR
    MOBILE --&gt; VALIDATOR

    VALIDATOR --&gt; AVAILABILITY
    AVAILABILITY --&gt; BOOKING
    BOOKING --&gt; SYNC

    BOOKING --&gt; DB
    SYNC --&gt; CALCOM
    BOOKING --&gt; NOTIFY
    BOOKING --&gt; ANALYTICS
</code></pre>
<h2 id="core-features">Core Features</h2>
<h3 id="1-multi-branch-support">1. Multi-Branch Support</h3>
<p>Manage appointments across multiple locations:</p>
<pre><code class="language-php">// Each branch has independent:
- Operating hours
- Staff members  
- Service offerings
- Booking rules
- Calendar integration
</code></pre>
<h3 id="2-smart-availability-engine">2. Smart Availability Engine</h3>
<p>Complex availability calculation considering:</p>
<pre><code class="language-yaml">Factors:
  - Branch operating hours
  - Staff working hours
  - Staff breaks and time off
  - Existing appointments
  - Service duration
  - Buffer times
  - Travel time (mobile services)
  - Maximum daily bookings
  - Advance booking limits
</code></pre>
<h3 id="3-service-management">3. Service Management</h3>
<h4 id="service-configuration">Service Configuration</h4>
<pre><code class="language-json">{
  &quot;id&quot;: 1,
  &quot;name&quot;: &quot;Premium Haircut&quot;,
  &quot;duration&quot;: 45,
  &quot;price&quot;: 45.00,
  &quot;buffer_before&quot;: 5,
  &quot;buffer_after&quot;: 10,
  &quot;requires_consultation&quot;: false,
  &quot;staff_requirements&quot;: [&quot;haircut_certified&quot;],
  &quot;resource_requirements&quot;: [&quot;chair_1&quot;, &quot;chair_2&quot;]
}
</code></pre>
<h4 id="service-categories">Service Categories</h4>
<ul>
<li><strong>Duration-based</strong>: Fixed time slots</li>
<li><strong>Flexible</strong>: Variable duration</li>
<li><strong>Package</strong>: Multiple services bundled</li>
<li><strong>Recurring</strong>: Series appointments</li>
</ul>
<h3 id="4-staff-assignment">4. Staff Assignment</h3>
<h4 id="automatic-assignment">Automatic Assignment</h4>
<pre><code class="language-php">public function findBestStaff($service, $datetime, $preferences = [])
{
    return Staff::available($datetime)
        -&gt;hasSkill($service-&gt;required_skills)
        -&gt;when($preferences['gender'], function ($q, $gender) {
            $q-&gt;where('gender', $gender);
        })
        -&gt;when($preferences['language'], function ($q, $language) {
            $q-&gt;whereJsonContains('languages', $language);
        })
        -&gt;withCount(['appointments' =&gt; function ($q) use ($datetime) {
            $q-&gt;whereDate('start_time', $datetime-&gt;toDateString());
        }])
        -&gt;orderBy('appointments_count') // Load balancing
        -&gt;first();
}
</code></pre>
<h4 id="manual-selection">Manual Selection</h4>
<p>Customers can choose specific staff members:
- View staff profiles
- See availability
- Read reviews
- Check specializations</p>
<h2 id="booking-flow">Booking Flow</h2>
<h3 id="1-availability-check">1. Availability Check</h3>
<pre><code class="language-mermaid">sequenceDiagram
    participant Client
    participant API
    participant Cache
    participant AvailabilityEngine
    participant Database
    participant CalCom

    Client-&gt;&gt;API: Request available slots
    API-&gt;&gt;Cache: Check cached availability
    Cache--&gt;&gt;API: Cache miss

    API-&gt;&gt;AvailabilityEngine: Calculate slots
    AvailabilityEngine-&gt;&gt;Database: Get bookings
    AvailabilityEngine-&gt;&gt;Database: Get staff hours
    AvailabilityEngine-&gt;&gt;CalCom: Get external bookings

    AvailabilityEngine--&gt;&gt;API: Available slots
    API-&gt;&gt;Cache: Store result (5 min)
    API--&gt;&gt;Client: Return slots
</code></pre>
<h3 id="2-booking-creation">2. Booking Creation</h3>
<pre><code class="language-php">class AppointmentBookingService
{
    public function createBooking(array $data): Appointment
    {
        return DB::transaction(function () use ($data) {
            // 1. Lock the time slot
            $lock = $this-&gt;lockTimeSlot(
                $data['start_time'],
                $data['duration'],
                $data['staff_id']
            );

            try {
                // 2. Final availability check
                if (!$this-&gt;isStillAvailable($data)) {
                    throw new SlotNoLongerAvailableException();
                }

                // 3. Create appointment
                $appointment = Appointment::create([
                    'company_id' =&gt; $data['company_id'],
                    'branch_id' =&gt; $data['branch_id'],
                    'staff_id' =&gt; $data['staff_id'],
                    'service_id' =&gt; $data['service_id'],
                    'customer_id' =&gt; $data['customer_id'],
                    'start_time' =&gt; $data['start_time'],
                    'end_time' =&gt; $data['end_time'],
                    'status' =&gt; 'confirmed',
                    'source' =&gt; $data['source'] ?? 'web',
                ]);

                // 4. Sync to Cal.com
                $externalBooking = $this-&gt;calcomService-&gt;createBooking($appointment);
                $appointment-&gt;update(['external_id' =&gt; $externalBooking-&gt;id]);

                // 5. Send confirmations
                event(new AppointmentCreated($appointment));

                return $appointment;
            } finally {
                $lock-&gt;release();
            }
        });
    }
}
</code></pre>
<h3 id="3-conflict-resolution">3. Conflict Resolution</h3>
<pre><code class="language-php">class ConflictResolver
{
    public function handle(SlotConflictException $e): Resolution
    {
        $alternatives = $this-&gt;findAlternatives(
            $e-&gt;requestedTime,
            $e-&gt;service,
            $e-&gt;preferences
        );

        return new Resolution([
            'status' =&gt; 'conflict',
            'message' =&gt; 'Selected time no longer available',
            'alternatives' =&gt; $alternatives-&gt;map(function ($slot) {
                return [
                    'time' =&gt; $slot-&gt;format('H:i'),
                    'date' =&gt; $slot-&gt;format('Y-m-d'),
                    'staff' =&gt; $slot-&gt;staff-&gt;name,
                ];
            }),
        ]);
    }
}
</code></pre>
<h2 id="advanced-features">Advanced Features</h2>
<h3 id="1-recurring-appointments">1. Recurring Appointments</h3>
<pre><code class="language-yaml">Recurrence Patterns:
  - Daily: Every day at same time
  - Weekly: Same day/time each week
  - Bi-weekly: Every two weeks
  - Monthly: Same date each month
  - Custom: Complex patterns
</code></pre>
<pre><code class="language-php">public function createRecurringSeries($pattern, $baseAppointment, $endDate)
{
    $appointments = collect();
    $current = $baseAppointment-&gt;start_time-&gt;copy();

    while ($current &lt;= $endDate) {
        if ($this-&gt;isAvailable($current, $baseAppointment)) {
            $appointments-&gt;push($this-&gt;createSingleAppointment(
                $baseAppointment-&gt;replicate(['start_time' =&gt; $current])
            ));
        }

        $current = $this-&gt;getNextOccurrence($current, $pattern);
    }

    return $appointments;
}
</code></pre>
<h3 id="2-group-bookings">2. Group Bookings</h3>
<p>Handle multiple people in one appointment:</p>
<pre><code class="language-json">{
  &quot;type&quot;: &quot;group&quot;,
  &quot;service_id&quot;: 5,
  &quot;participants&quot;: [
    {&quot;name&quot;: &quot;John Doe&quot;, &quot;email&quot;: &quot;john@example.com&quot;},
    {&quot;name&quot;: &quot;Jane Smith&quot;, &quot;email&quot;: &quot;jane@example.com&quot;}
  ],
  &quot;requirements&quot;: {
    &quot;min_participants&quot;: 2,
    &quot;max_participants&quot;: 6,
    &quot;resources&quot;: [&quot;conference_room_1&quot;]
  }
}
</code></pre>
<h3 id="3-waiting-list">3. Waiting List</h3>
<pre><code class="language-php">class WaitingListService
{
    public function addToWaitingList($customer, $preferences)
    {
        $entry = WaitingListEntry::create([
            'customer_id' =&gt; $customer-&gt;id,
            'service_id' =&gt; $preferences['service_id'],
            'preferred_dates' =&gt; $preferences['dates'],
            'preferred_times' =&gt; $preferences['times'],
            'preferred_staff' =&gt; $preferences['staff_id'],
            'expires_at' =&gt; now()-&gt;addDays(30),
        ]);

        // Monitor for openings
        WaitingListMonitor::dispatch($entry)-&gt;delay(300);

        return $entry;
    }

    public function checkForOpenings($entry)
    {
        $availableSlots = $this-&gt;findMatchingSlots($entry);

        if ($availableSlots-&gt;isNotEmpty()) {
            Notification::send($entry-&gt;customer, 
                new SlotAvailableNotification($availableSlots)
            );
        }
    }
}
</code></pre>
<h3 id="4-smart-rescheduling">4. Smart Rescheduling</h3>
<pre><code class="language-php">public function reschedule($appointment, $newTime)
{
    DB::transaction(function () use ($appointment, $newTime) {
        // Store original data
        $history = $appointment-&gt;replicate();

        // Update appointment
        $appointment-&gt;update([
            'start_time' =&gt; $newTime,
            'end_time' =&gt; $newTime-&gt;copy()-&gt;addMinutes($appointment-&gt;duration),
            'rescheduled_at' =&gt; now(),
            'rescheduled_count' =&gt; $appointment-&gt;rescheduled_count + 1,
        ]);

        // Update external systems
        if ($appointment-&gt;external_id) {
            $this-&gt;calcomService-&gt;updateBooking(
                $appointment-&gt;external_id,
                $newTime
            );
        }

        // Notify all parties
        event(new AppointmentRescheduled($appointment, $history));
    });
}
</code></pre>
<h2 id="booking-rules-engine">Booking Rules Engine</h2>
<h3 id="rule-types">Rule Types</h3>
<pre><code class="language-php">interface BookingRule
{
    public function validate(Appointment $appointment): bool;
    public function getMessage(): string;
}

class MinimumNoticeRule implements BookingRule
{
    public function validate(Appointment $appointment): bool
    {
        $minimumHours = config('booking.minimum_notice_hours', 2);
        return $appointment-&gt;start_time-&gt;diffInHours(now()) &gt;= $minimumHours;
    }

    public function getMessage(): string
    {
        return 'Appointments must be booked at least 2 hours in advance';
    }
}

class MaxAdvanceBookingRule implements BookingRule
{
    public function validate(Appointment $appointment): bool
    {
        $maxDays = config('booking.max_advance_days', 90);
        return $appointment-&gt;start_time-&gt;diffInDays(now()) &lt;= $maxDays;
    }
}

class BusinessHoursRule implements BookingRule
{
    public function validate(Appointment $appointment): bool
    {
        $branch = $appointment-&gt;branch;
        $dayOfWeek = strtolower($appointment-&gt;start_time-&gt;format('l'));

        $hours = $branch-&gt;operating_hours[$dayOfWeek] ?? null;

        if (!$hours || !$hours['open']) {
            return false;
        }

        $startTime = $appointment-&gt;start_time-&gt;format('H:i');
        $endTime = $appointment-&gt;end_time-&gt;format('H:i');

        return $startTime &gt;= $hours['start'] &amp;&amp; $endTime &lt;= $hours['end'];
    }
}
</code></pre>
<h3 id="rule-application">Rule Application</h3>
<pre><code class="language-php">class BookingValidator
{
    protected array $rules = [
        MinimumNoticeRule::class,
        MaxAdvanceBookingRule::class,
        BusinessHoursRule::class,
        StaffAvailabilityRule::class,
        ServiceAvailabilityRule::class,
        CustomerBlocklistRule::class,
        MaxDailyBookingsRule::class,
    ];

    public function validate(Appointment $appointment): ValidationResult
    {
        $failures = [];

        foreach ($this-&gt;rules as $ruleClass) {
            $rule = new $ruleClass();

            if (!$rule-&gt;validate($appointment)) {
                $failures[] = $rule-&gt;getMessage();
            }
        }

        return new ValidationResult(
            empty($failures),
            $failures
        );
    }
}
</code></pre>
<h2 id="optimization-strategies">Optimization Strategies</h2>
<h3 id="1-slot-caching">1. Slot Caching</h3>
<pre><code class="language-php">class SlotCache
{
    public function remember($key, $ttl, Closure $callback)
    {
        // Two-tier caching

        // L1: In-memory cache (very fast)
        if ($cached = $this-&gt;memoryCache-&gt;get($key)) {
            return $cached;
        }

        // L2: Redis cache (fast)
        if ($cached = Cache::tags(['slots'])-&gt;get($key)) {
            $this-&gt;memoryCache-&gt;put($key, $cached, 60);
            return $cached;
        }

        // Calculate fresh
        $value = $callback();

        // Store in both caches
        Cache::tags(['slots'])-&gt;put($key, $value, $ttl);
        $this-&gt;memoryCache-&gt;put($key, $value, 60);

        return $value;
    }
}
</code></pre>
<h3 id="2-batch-availability">2. Batch Availability</h3>
<pre><code class="language-php">public function getBatchAvailability($dates, $service, $branch)
{
    // Single query for multiple dates
    $bookings = Appointment::where('branch_id', $branch-&gt;id)
        -&gt;whereIn(DB::raw('DATE(start_time)'), $dates)
        -&gt;whereIn('status', ['confirmed', 'pending'])
        -&gt;get()
        -&gt;groupBy(fn($apt) =&gt; $apt-&gt;start_time-&gt;format('Y-m-d'));

    return collect($dates)-&gt;mapWithKeys(function ($date) use ($bookings, $service, $branch) {
        return [
            $date =&gt; $this-&gt;calculateDayAvailability(
                $date,
                $bookings-&gt;get($date, collect()),
                $service,
                $branch
            )
        ];
    });
}
</code></pre>
<h2 id="monitoring-analytics">Monitoring &amp; Analytics</h2>
<h3 id="key-metrics">Key Metrics</h3>
<pre><code class="language-yaml">Booking Metrics:
  - Conversion Rate: Searches to bookings
  - Average Lead Time: Days booked in advance
  - No-Show Rate: Missed appointments
  - Cancellation Rate: By time period
  - Utilization Rate: Booked vs available slots
  - Popular Times: Heat map of bookings
  - Service Demand: Most requested services
</code></pre>
<h3 id="performance-dashboard">Performance Dashboard</h3>
<pre><code class="language-sql">-- Real-time booking stats
SELECT 
    COUNT(*) as total_bookings,
    SUM(CASE WHEN source = 'phone' THEN 1 ELSE 0 END) as phone_bookings,
    SUM(CASE WHEN source = 'web' THEN 1 ELSE 0 END) as web_bookings,
    AVG(TIMESTAMPDIFF(HOUR, created_at, start_time)) as avg_lead_hours,
    COUNT(*) / COUNT(DISTINCT DATE(start_time)) as avg_daily_bookings
FROM appointments
WHERE created_at &gt;= NOW() - INTERVAL 30 DAY
AND company_id = ?;
</code></pre>
<h2 id="best-practices">Best Practices</h2>
<ol>
<li><strong>Always Lock Time Slots</strong>: Prevent double bookings with distributed locks</li>
<li><strong>Validate Twice</strong>: Check availability before and after user input</li>
<li><strong>Fail Gracefully</strong>: Always offer alternatives on conflicts</li>
<li><strong>Cache Wisely</strong>: Balance freshness with performance</li>
<li><strong>Monitor Everything</strong>: Track all metrics for optimization</li>
<li><strong>Test Edge Cases</strong>: Timezone changes, DST, holidays</li>
<li><strong>Plan for Scale</strong>: Design for 10x current load</li>
</ol>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../../api/webhooks/" class="btn btn-neutral float-left" title="Webhooks"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../multi-tenancy/" class="btn btn-neutral float-right" title="Multi-Tenancy">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../../api/webhooks/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../multi-tenancy/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>

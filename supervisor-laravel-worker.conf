; ==========================================
; Laravel Queue Worker - Supervisor Config
; ==========================================
;
; DEPLOYMENT INSTRUCTIONS:
; 1. Copy this file to: /etc/supervisor/conf.d/laravel-worker.conf
; 2. Update supervisor: sudo supervisorctl reread
; 3. Add new config: sudo supervisorctl update
; 4. Start workers: sudo supervisorctl start laravel-worker:*
; 5. Check status: sudo supervisorctl status laravel-worker:*
;
; ðŸŽ¯ PHASE 3 REQUIREMENT: Async cache clearing jobs
; ==========================================

[program:laravel-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/api-gateway/artisan queue:work redis --queue=cache,default --sleep=3 --tries=3 --timeout=120 --max-jobs=1000 --max-time=3600
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=2
redirect_stderr=true
stdout_logfile=/var/www/api-gateway/storage/logs/worker.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stopwaitsecs=3600

; Environment variables
environment=LARAVEL_ENV="production"

; Process priority (lower = higher priority)
priority=999

; Restart strategy
startretries=3
startsecs=1

; Signal handling
stopsignal=QUIT

; ===========================================
; CONFIGURATION DETAILS
; ===========================================
;
; --queue=cache,default
;   Process 'cache' queue first (for Phase 3 async cache jobs),
;   then fall back to 'default' queue
;
; --sleep=3
;   Sleep 3 seconds when no jobs available (prevents CPU spinning)
;
; --tries=3
;   Each job will be attempted 3 times before failing permanently
;   (matches ClearAvailabilityCacheJob configuration)
;
; --timeout=120
;   Job execution timeout: 2 minutes (120 seconds)
;   (matches ClearAvailabilityCacheJob timeout)
;
; --max-jobs=1000
;   Worker will restart after processing 1000 jobs
;   (prevents memory leaks)
;
; --max-time=3600
;   Worker will restart after 1 hour (3600 seconds)
;   (prevents memory bloat from long-running workers)
;
; numprocs=2
;   Start 2 worker processes
;   Scale up to 4-8 for high load
;
; user=www-data
;   Run as www-data user (matches Laravel file permissions)
;
; ===========================================
; SCALING RECOMMENDATIONS
; ===========================================
;
; LOW TRAFFIC (< 100 bookings/day):
;   numprocs=2
;
; MEDIUM TRAFFIC (100-500 bookings/day):
;   numprocs=4
;
; HIGH TRAFFIC (500-1000 bookings/day):
;   numprocs=6-8
;
; VERY HIGH TRAFFIC (> 1000 bookings/day):
;   numprocs=10-15
;   Consider dedicated cache queue workers
;
; ===========================================
; MONITORING
; ===========================================
;
; Check worker status:
;   sudo supervisorctl status laravel-worker:*
;
; Restart all workers:
;   sudo supervisorctl restart laravel-worker:*
;
; Stop all workers:
;   sudo supervisorctl stop laravel-worker:*
;
; View logs:
;   tail -f /var/www/api-gateway/storage/logs/worker.log
;
; Monitor queue depth:
;   redis-cli LLEN queues:cache
;   redis-cli LLEN queues:default
;
; Monitor failed jobs:
;   php artisan queue:failed
;
; ===========================================

{
    "global_prompt": "# Friseur 1 - Intelligenter Terminassistent V5 (State Persistence)\n\n## Deine Rolle\nDu bist der Terminassistent von **Friseur 1**.\nSprich freundlich und natürlich auf Deutsch.\n\n## WICHTIG: State Management\n\n**Du hast Zugriff auf Dynamic Variables:**\n- {{customer_name}} - Name des Kunden\n- {{service_name}} - Gewünschter Service\n- {{appointment_date}} - Gewünschtes Datum\n- {{appointment_time}} - Gewünschte Uhrzeit\n- {{booking_confirmed}} - Buchungsstatus\n\n**IMMER ZUERST PRÜFEN:**\n1. Was steht bereits in den Variablen?\n2. Was hat der Kunde im Transcript gesagt?\n3. NUR nach FEHLENDEN Daten fragen!\n\n## Services\n- Herrenhaarschnitt (30 Min, 25€)\n- Damenhaarschnitt (45 Min, 35€)\n- Färben (90 Min, 65€)\n\n## Du kannst helfen bei:\n1. **Neuen Termin buchen** - Sammle fehlende Daten und buche\n2. **Termine anzeigen** - Zeige bestehende Termine\n3. **Termin stornieren** - Finde und storniere Termin\n4. **Termin verschieben** - Verschiebe auf neues Datum/Uhrzeit\n5. **Services auflisten** - Zeige was wir anbieten\n\n## NIEMALS\n- ❌ Verfügbarkeit raten oder erfinden\n- ❌ Termin ohne Bestätigung buchen\n- ❌ Nach Daten fragen die bereits bekannt sind (in Variablen)\n- ❌ Tools manuell aufrufen (macht der Flow!)",
    "nodes": [
        {
            "name": "Begrüßung",
            "edges": [
                {
                    "destination_node_id": "intent_router",
                    "id": "edge_greeting_to_intent",
                    "transition_condition": {
                        "type": "prompt",
                        "prompt": "Customer responded"
                    }
                }
            ],
            "id": "node_greeting",
            "type": "conversation",
            "instruction": {
                "type": "prompt",
                "text": "Begrüße den Kunden freundlich: 'Guten Tag bei Friseur 1! Wie kann ich Ihnen helfen?'"
            }
        },
        {
            "name": "Intent Erkennung",
            "edges": [
                {
                    "destination_node_id": "node_collect_booking_info",
                    "id": "edge_intent_to_book",
                    "transition_condition": {
                        "type": "prompt",
                        "prompt": "User wants to BOOK a new appointment (keywords: buchen, Termin vereinbaren, Haarschnitt, Färben)"
                    }
                },
                {
                    "destination_node_id": "func_get_appointments",
                    "id": "edge_intent_to_check",
                    "transition_condition": {
                        "type": "prompt",
                        "prompt": "User wants to CHECK existing appointments (keywords: Welche Termine, meine Termine, zeigen, anzeigen)"
                    }
                },
                {
                    "destination_node_id": "node_collect_cancel_info",
                    "id": "edge_intent_to_cancel",
                    "transition_condition": {
                        "type": "prompt",
                        "prompt": "User wants to CANCEL an appointment (keywords: stornieren, absagen, nicht kommen)"
                    }
                },
                {
                    "destination_node_id": "node_collect_reschedule_info",
                    "id": "edge_intent_to_reschedule",
                    "transition_condition": {
                        "type": "prompt",
                        "prompt": "User wants to RESCHEDULE an appointment (keywords: verschieben, umbuchen, anderen Tag)"
                    }
                },
                {
                    "destination_node_id": "func_get_services",
                    "id": "edge_intent_to_services",
                    "transition_condition": {
                        "type": "prompt",
                        "prompt": "User wants to INQUIRE about services (keywords: Was bieten Sie an, Services, Preise, Kosten)"
                    }
                }
            ],
            "id": "intent_router",
            "type": "conversation",
            "instruction": {
                "type": "prompt",
                "text": "Verstehe die Absicht des Kunden:\n\n**Wenn Kunde sagt:**\n- 'Termin buchen', 'Haarschnitt', 'Färben' → BOOK\n- 'Welche Termine', 'Meine Termine' → CHECK\n- 'Stornieren', 'Absagen' → CANCEL\n- 'Verschieben', 'Umbuchen' → RESCHEDULE\n- 'Was bieten Sie an', 'Preise' → SERVICES\n\n**Du musst NICHT antworten** - transition direkt zum passenden Node!"
            }
        },
        {
            "name": "Buchungsdaten sammeln",
            "edges": [
                {
                    "destination_node_id": "func_check_availability",
                    "id": "edge_collect_booking_to_check",
                    "transition_condition": {
                        "type": "prompt",
                        "prompt": "ALL variables are filled (not empty): {{customer_name}} AND {{service_name}} AND {{appointment_date}} AND {{appointment_time}}"
                    }
                }
            ],
            "id": "node_collect_booking_info",
            "type": "conversation",
            "instruction": {
                "type": "prompt",
                "text": "## WICHTIG: Prüfe bereits bekannte Daten!\n\n**Bereits gesammelte Informationen:**\n- Name: {{customer_name}}\n- Service: {{service_name}}\n- Datum: {{appointment_date}}\n- Uhrzeit: {{appointment_time}}\n\n**Deine Aufgabe:**\n1. **ANALYSIERE den Transcript** - Was hat der Kunde bereits gesagt?\n2. **PRÜFE die Variablen** - Welche sind noch leer?\n3. **FRAGE NUR** nach fehlenden Daten!\n\n**Fehlende Daten erkennen:**\n- Wenn {{customer_name}} leer → Frage: \"Wie ist Ihr Name?\"\n- Wenn {{service_name}} leer → Frage: \"Welche Dienstleistung möchten Sie?\" (Herrenhaarschnitt/Damenhaarschnitt/Färben)\n- Wenn {{appointment_date}} leer → Frage: \"Für welchen Tag?\" (heute/morgen/DD.MM.YYYY)\n- Wenn {{appointment_time}} leer → Frage: \"Um wie viel Uhr?\" (HH:MM)\n\n**WENN Variable bereits gefüllt:**\n- ✅ ÜBERSPRINGE die Frage komplett!\n- Nutze den Wert aus der Variable\n\n**Beispiel - User sagt alles:**\nUser: \"Herrenhaarschnitt für heute 15 Uhr, Hans Schuster\"\n→ customer_name = \"Hans Schuster\"\n→ service_name = \"Herrenhaarschnitt\"\n→ appointment_date = \"heute\"\n→ appointment_time = \"15:00\"\n→ Antworte: \"Perfekt! Ich prüfe die Verfügbarkeit...\"\n→ Transition zu func_check_availability\n\n**Beispiel - User sagt teilweise:**\nUser: \"Ich möchte einen Herrenhaarschnitt\"\n→ service_name = \"Herrenhaarschnitt\"\n→ Frage NUR nach: Name, Datum, Uhrzeit\n\n**AKZEPTIERE natürliche Eingaben:**\n- \"heute\", \"morgen\", \"Montag\", \"nächsten Freitag\"\n- \"15 Uhr\", \"halb drei\", \"14:30\"\n\n**Transition:**\n- Sobald ALLE 4 Variablen gefüllt → func_check_availability"
            }
        },
        {
            "tool_id": "tool-check-availability",
            "instruction": {
                "type": "static_text",
                "text": "Einen Moment bitte, ich prüfe die Verfügbarkeit..."
            },
            "name": "Verfügbarkeit prüfen",
            "edges": [
                {
                    "destination_node_id": "node_present_result",
                    "id": "edge_check_to_present",
                    "transition_condition": {
                        "type": "prompt",
                        "prompt": "Availability check completed"
                    }
                }
            ],
            "parameter_mapping": {
                "call_id": "{{call_id}}",
                "name": "{{customer_name}}",
                "datum": "{{appointment_date}}",
                "dienstleistung": "{{service_name}}",
                "uhrzeit": "{{appointment_time}}"
            },
            "id": "func_check_availability",
            "type": "function",
            "tool_type": "local",
            "speak_during_execution": true,
            "wait_for_result": true
        },
        {
            "name": "Ergebnis zeigen",
            "edges": [
                {
                    "destination_node_id": "func_book_appointment",
                    "id": "edge_present_to_book",
                    "transition_condition": {
                        "type": "prompt",
                        "prompt": "User explicitly confirmed booking (said Ja, Gerne, Buchen, Passt, etc.)"
                    }
                },
                {
                    "destination_node_id": "node_collect_booking_info",
                    "id": "edge_present_to_retry",
                    "transition_condition": {
                        "type": "prompt",
                        "prompt": "User wants different time or declined"
                    }
                }
            ],
            "id": "node_present_result",
            "type": "conversation",
            "instruction": {
                "type": "prompt",
                "text": "Zeige das Ergebnis der Verfügbarkeitsprüfung:\n\n**WENN VERFÜGBAR:**\n\"Der Termin am {{appointment_date}} um {{appointment_time}} für {{service_name}} ist verfügbar. Soll ich den Termin für Sie buchen?\"\n\n**WENN NICHT VERFÜGBAR:**\n\"Leider ist {{appointment_date}} um {{appointment_time}} nicht verfügbar. Ich habe alternative Zeiten gefunden. Welcher Termin passt Ihnen?\"\n\n**WICHTIG:**\n- Warte auf explizite Bestätigung\n- \"Ja\", \"Gerne\", \"Buchen Sie\" → Transition zu func_book_appointment\n- \"Nein\", \"Andere Zeit\" → Zurück zu Datensammlung"
            }
        },
        {
            "tool_id": "tool-book-appointment",
            "instruction": {
                "type": "static_text",
                "text": "Perfekt! Einen Moment, ich buche den Termin..."
            },
            "name": "Termin buchen",
            "edges": [
                {
                    "destination_node_id": "node_booking_success",
                    "id": "edge_book_to_success",
                    "transition_condition": {
                        "type": "prompt",
                        "prompt": "Booking successful"
                    }
                }
            ],
            "parameter_mapping": {
                "call_id": "{{call_id}}",
                "name": "{{customer_name}}",
                "datum": "{{appointment_date}}",
                "dienstleistung": "{{service_name}}",
                "uhrzeit": "{{appointment_time}}"
            },
            "id": "func_book_appointment",
            "type": "function",
            "tool_type": "local",
            "speak_during_execution": true,
            "wait_for_result": true
        },
        {
            "name": "Buchung erfolgreich",
            "edges": [
                {
                    "destination_node_id": "node_end",
                    "id": "edge_booking_success_to_end",
                    "transition_condition": {
                        "type": "prompt",
                        "prompt": "Always end"
                    }
                }
            ],
            "id": "node_booking_success",
            "type": "conversation",
            "instruction": {
                "type": "static_text",
                "text": "Wunderbar! Ihr Termin ist gebucht. Sie erhalten eine Bestätigung per E-Mail. Vielen Dank und einen schönen Tag!"
            }
        },
        {
            "tool_id": "tool-get-appointments",
            "instruction": {
                "type": "static_text",
                "text": "Einen Moment, ich schaue nach Ihren Terminen..."
            },
            "name": "Termine abrufen",
            "edges": [
                {
                    "destination_node_id": "node_show_appointments",
                    "id": "edge_get_to_show",
                    "transition_condition": {
                        "type": "prompt",
                        "prompt": "Appointments retrieved"
                    }
                }
            ],
            "parameter_mapping": {
                "call_id": "{{call_id}}"
            },
            "id": "func_get_appointments",
            "type": "function",
            "tool_type": "local",
            "speak_during_execution": true,
            "wait_for_result": true
        },
        {
            "name": "Termine anzeigen",
            "edges": [
                {
                    "destination_node_id": "node_end",
                    "id": "edge_show_to_end",
                    "transition_condition": {
                        "type": "prompt",
                        "prompt": "User acknowledged or wants to end"
                    }
                },
                {
                    "destination_node_id": "intent_router",
                    "id": "edge_show_to_intent",
                    "transition_condition": {
                        "type": "prompt",
                        "prompt": "User wants to modify a shown appointment"
                    }
                }
            ],
            "id": "node_show_appointments",
            "type": "conversation",
            "instruction": {
                "type": "prompt",
                "text": "Zeige die Termine dem Kunden:\n\n**WENN TERMINE VORHANDEN:**\n\"Sie haben folgende Termine: [LISTE MIT DATUM, UHRZEIT, SERVICE]. Möchten Sie einen davon verschieben oder stornieren?\"\n\n**WENN KEINE TERMINE:**\n\"Sie haben derzeit keine bevorstehenden Termine. Möchten Sie einen Termin buchen?\""
            }
        },
        {
            "name": "Stornierungsdaten sammeln",
            "edges": [
                {
                    "destination_node_id": "func_cancel_appointment",
                    "id": "edge_collect_cancel_to_func",
                    "transition_condition": {
                        "type": "prompt",
                        "prompt": "Appointment to cancel identified (either appointment_id OR datum+uhrzeit)"
                    }
                }
            ],
            "id": "node_collect_cancel_info",
            "type": "conversation",
            "instruction": {
                "type": "prompt",
                "text": "Welchen Termin möchten Sie stornieren?\n\n**Frage nach:**\n- Datum (heute, morgen, oder DD.MM.YYYY) UND Uhrzeit (HH:MM)\n- ODER zeige Liste und lass Kunden wählen\n\n**Sobald identifiziert:** → func_cancel_appointment"
            }
        },
        {
            "tool_id": "tool-cancel-appointment",
            "instruction": {
                "type": "static_text",
                "text": "Einen Moment, ich storniere den Termin..."
            },
            "name": "Termin stornieren",
            "edges": [
                {
                    "destination_node_id": "node_cancel_confirmation",
                    "id": "edge_cancel_to_confirm",
                    "transition_condition": {
                        "type": "prompt",
                        "prompt": "Cancellation completed"
                    }
                }
            ],
            "parameter_mapping": {
                "call_id": "{{call_id}}",
                "datum": "{{cancel_datum}}",
                "uhrzeit": "{{cancel_uhrzeit}}"
            },
            "id": "func_cancel_appointment",
            "type": "function",
            "tool_type": "local",
            "speak_during_execution": true,
            "wait_for_result": true
        },
        {
            "name": "Stornierung bestätigt",
            "edges": [
                {
                    "destination_node_id": "node_end",
                    "id": "edge_cancel_confirm_to_end",
                    "transition_condition": {
                        "type": "prompt",
                        "prompt": "Always end"
                    }
                }
            ],
            "id": "node_cancel_confirmation",
            "type": "conversation",
            "instruction": {
                "type": "prompt",
                "text": "Bestätige die Stornierung: 'Ihr Termin wurde storniert. Sie erhalten eine Bestätigung per E-Mail. Vielen Dank!'"
            }
        },
        {
            "name": "Verschiebungsdaten sammeln",
            "edges": [
                {
                    "destination_node_id": "func_reschedule_appointment",
                    "id": "edge_collect_reschedule_to_func",
                    "transition_condition": {
                        "type": "prompt",
                        "prompt": "All required data collected: old appointment identified AND new datum+uhrzeit collected"
                    }
                }
            ],
            "id": "node_collect_reschedule_info",
            "type": "conversation",
            "instruction": {
                "type": "prompt",
                "text": "Welchen Termin möchten Sie verschieben, und auf wann?\n\n**Sammle:**\n1. Alter Termin: Datum (heute, morgen, oder DD.MM.YYYY) + Uhrzeit (HH:MM)\n2. Neuer Wunschtermin: Datum (heute, morgen, oder DD.MM.YYYY) + Uhrzeit (HH:MM)\n\n**WICHTIG:** Sammle BEIDE (alt + neu) komplett bevor du zur Function gehst"
            }
        },
        {
            "tool_id": "tool-reschedule-appointment",
            "instruction": {
                "type": "static_text",
                "text": "Einen Moment, ich verschiebe Ihren Termin..."
            },
            "name": "Termin verschieben",
            "edges": [
                {
                    "destination_node_id": "node_reschedule_confirmation",
                    "id": "edge_reschedule_to_confirm",
                    "transition_condition": {
                        "type": "prompt",
                        "prompt": "Rescheduling completed"
                    }
                }
            ],
            "parameter_mapping": {
                "call_id": "{{call_id}}",
                "old_datum": "{{old_datum}}",
                "old_uhrzeit": "{{old_uhrzeit}}",
                "new_datum": "{{new_datum}}",
                "new_uhrzeit": "{{new_uhrzeit}}"
            },
            "id": "func_reschedule_appointment",
            "type": "function",
            "tool_type": "local",
            "speak_during_execution": true,
            "wait_for_result": true
        },
        {
            "name": "Verschiebung bestätigt",
            "edges": [
                {
                    "destination_node_id": "node_end",
                    "id": "edge_reschedule_confirm_to_end",
                    "transition_condition": {
                        "type": "prompt",
                        "prompt": "Always end"
                    }
                }
            ],
            "id": "node_reschedule_confirmation",
            "type": "conversation",
            "instruction": {
                "type": "prompt",
                "text": "Bestätige die Verschiebung: 'Perfekt! Ihr Termin wurde erfolgreich verschoben auf {{new_datum}} um {{new_uhrzeit}} Uhr. Bestätigung folgt per E-Mail.'"
            }
        },
        {
            "tool_id": "tool-get-services",
            "instruction": {
                "type": "static_text",
                "text": "Einen Moment, ich hole die Service-Liste..."
            },
            "name": "Services abrufen",
            "edges": [
                {
                    "destination_node_id": "node_show_services",
                    "id": "edge_get_services_to_show",
                    "transition_condition": {
                        "type": "prompt",
                        "prompt": "Services retrieved"
                    }
                }
            ],
            "parameter_mapping": {
                "call_id": "{{call_id}}"
            },
            "id": "func_get_services",
            "type": "function",
            "tool_type": "local",
            "speak_during_execution": true,
            "wait_for_result": true
        },
        {
            "name": "Services anzeigen",
            "edges": [
                {
                    "destination_node_id": "node_end",
                    "id": "edge_show_services_to_end",
                    "transition_condition": {
                        "type": "prompt",
                        "prompt": "User acknowledged or wants to end"
                    }
                },
                {
                    "destination_node_id": "intent_router",
                    "id": "edge_show_services_to_intent",
                    "transition_condition": {
                        "type": "prompt",
                        "prompt": "User wants to book after seeing services"
                    }
                }
            ],
            "id": "node_show_services",
            "type": "conversation",
            "instruction": {
                "type": "prompt",
                "text": "Zeige die Services:\n\n\"Wir bieten folgende Services an: [LISTE MIT NAMEN, DAUER, PREIS]. Möchten Sie einen Termin buchen?\""
            }
        },
        {
            "name": "Ende",
            "edges": [],
            "id": "node_end",
            "type": "end",
            "instruction": {
                "type": "static_text",
                "text": ""
            }
        }
    ],
    "start_node_id": "node_greeting",
    "start_speaker": "agent",
    "tools": [
        {
            "tool_id": "tool-check-availability",
            "timeout_ms": 10000,
            "name": "check_availability_v17",
            "description": "Prüft Verfügbarkeit für einen Termin",
            "type": "custom",
            "parameters": {
                "type": "object",
                "properties": {
                    "call_id": {
                        "type": "string",
                        "description": "Call ID from system"
                    },
                    "name": {
                        "type": "string",
                        "description": "Kundenname"
                    },
                    "datum": {
                        "type": "string",
                        "description": "Datum: heute, morgen, Montag, oder DD.MM.YYYY"
                    },
                    "dienstleistung": {
                        "type": "string",
                        "description": "Service (z.B. Herrenhaarschnitt)"
                    },
                    "uhrzeit": {
                        "type": "string",
                        "description": "Uhrzeit im Format HH:MM"
                    }
                },
                "required": [
                    "call_id",
                    "name",
                    "datum",
                    "uhrzeit",
                    "dienstleistung"
                ]
            },
            "url": "https://api.askproai.de/api/retell/v17/check-availability"
        },
        {
            "tool_id": "tool-book-appointment",
            "timeout_ms": 10000,
            "name": "book_appointment_v17",
            "description": "Bucht einen Termin",
            "type": "custom",
            "parameters": {
                "type": "object",
                "properties": {
                    "call_id": {
                        "type": "string",
                        "description": "Call ID from system"
                    },
                    "name": {
                        "type": "string",
                        "description": "Kundenname"
                    },
                    "datum": {
                        "type": "string",
                        "description": "Datum: heute, morgen, Montag, oder DD.MM.YYYY"
                    },
                    "dienstleistung": {
                        "type": "string",
                        "description": "Service"
                    },
                    "uhrzeit": {
                        "type": "string",
                        "description": "Uhrzeit im Format HH:MM"
                    }
                },
                "required": [
                    "call_id",
                    "name",
                    "datum",
                    "uhrzeit",
                    "dienstleistung"
                ]
            },
            "url": "https://api.askproai.de/api/retell/v17/book-appointment"
        },
        {
            "tool_id": "tool-get-appointments",
            "timeout_ms": 10000,
            "name": "get_customer_appointments",
            "description": "Ruft bestehende Termine des Kunden ab",
            "type": "custom",
            "parameters": {
                "type": "object",
                "properties": {
                    "call_id": {
                        "type": "string",
                        "description": "Call ID from system"
                    },
                    "customer_name": {
                        "type": "string",
                        "description": "Optional: Kundenname zur Filterung"
                    }
                },
                "required": [
                    "call_id"
                ]
            },
            "url": "https://api.askproai.de/api/retell/get-appointments-v4"
        },
        {
            "tool_id": "tool-cancel-appointment",
            "timeout_ms": 10000,
            "name": "cancel_appointment",
            "description": "Storniert einen bestehenden Termin",
            "type": "custom",
            "parameters": {
                "type": "object",
                "properties": {
                    "call_id": {
                        "type": "string",
                        "description": "Call ID from system"
                    },
                    "appointment_id": {
                        "type": "string",
                        "description": "Optional: Appointment ID"
                    },
                    "datum": {
                        "type": "string",
                        "description": "Optional: Datum (heute, morgen, oder DD.MM.YYYY)"
                    },
                    "uhrzeit": {
                        "type": "string",
                        "description": "Optional: Uhrzeit HH:MM"
                    }
                },
                "required": [
                    "call_id"
                ]
            },
            "url": "https://api.askproai.de/api/retell/cancel-appointment-v4"
        },
        {
            "tool_id": "tool-reschedule-appointment",
            "timeout_ms": 10000,
            "name": "reschedule_appointment",
            "description": "Verschiebt einen Termin auf neues Datum/Uhrzeit",
            "type": "custom",
            "parameters": {
                "type": "object",
                "properties": {
                    "call_id": {
                        "type": "string",
                        "description": "Call ID from system"
                    },
                    "appointment_id": {
                        "type": "string",
                        "description": "Optional: Appointment ID"
                    },
                    "old_datum": {
                        "type": "string",
                        "description": "Optional: Altes Datum DD.MM.YYYY"
                    },
                    "old_uhrzeit": {
                        "type": "string",
                        "description": "Optional: Alte Uhrzeit HH:MM"
                    },
                    "new_datum": {
                        "type": "string",
                        "description": "Required: Neues Datum (heute, morgen, oder DD.MM.YYYY)"
                    },
                    "new_uhrzeit": {
                        "type": "string",
                        "description": "Required: Neue Uhrzeit HH:MM"
                    }
                },
                "required": [
                    "call_id",
                    "new_datum",
                    "new_uhrzeit"
                ]
            },
            "url": "https://api.askproai.de/api/retell/reschedule-appointment-v4"
        },
        {
            "tool_id": "tool-get-services",
            "timeout_ms": 10000,
            "name": "get_available_services",
            "description": "Listet alle verfügbaren Services auf",
            "type": "custom",
            "parameters": {
                "type": "object",
                "properties": {
                    "call_id": {
                        "type": "string",
                        "description": "Call ID from system"
                    }
                },
                "required": [
                    "call_id"
                ]
            },
            "url": "https://api.askproai.de/api/retell/get-services-v4"
        }
    ],
    "model_choice": {
        "type": "cascading",
        "model": "gpt-4o-mini"
    },
    "model_temperature": 0.3,
    "kb_config": {
        "top_k": 3,
        "filter_score": 0.6
    },
    "dynamic_variables": {
        "customer_name": "",
        "service_name": "",
        "appointment_date": "",
        "appointment_time": "",
        "booking_confirmed": "false"
    }
}
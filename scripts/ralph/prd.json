{
  "project": "AskPro Gateway",
  "branchName": "ralph/email-template-editor",
  "description": "Email Template Editor - Custom email templates with variables and live preview for Service Gateway",
  "userStories": [
    {
      "id": "US-001",
      "title": "Add email_templates database table",
      "description": "As a developer, I need to store custom email templates in the database.",
      "acceptanceCriteria": [
        "Migration creates email_templates table with columns: id, company_id, name, subject, body_html, variables (JSON), is_active, created_at, updated_at",
        "company_id is foreign key to companies table with cascade delete",
        "name is VARCHAR(255) NOT NULL",
        "subject is VARCHAR(500) NOT NULL",
        "body_html is TEXT NOT NULL",
        "variables is JSON nullable",
        "is_active is BOOLEAN default true",
        "Add index on company_id",
        "Migration runs: php artisan migrate",
        "php artisan test passes",
        "./vendor/bin/pint --test passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Migration created at database/migrations/2026_01_10_055919_create_email_templates_table.php and successfully applied. Code style check passed."
    },
    {
      "id": "US-002",
      "title": "Add EmailTemplate Eloquent model",
      "description": "As a developer, I need an Eloquent model to interact with email templates.",
      "acceptanceCriteria": [
        "Model at app/Models/EmailTemplate.php",
        "Extends CompanyScopedModel for multi-tenancy",
        "Has fillable: ['company_id', 'name', 'subject', 'body_html', 'variables', 'is_active']",
        "Has casts: ['variables' => 'array', 'is_active' => 'boolean']",
        "Has belongsTo relationship to Company",
        "Has scope: scopeActive() for filtering active templates",
        "php artisan test passes",
        "./vendor/bin/pint --test passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Model created with BelongsToCompany trait (uses trait pattern instead of extending CompanyScopedModel). All acceptance criteria met. Code style check passed."
    },
    {
      "id": "US-003",
      "title": "Add EmailTemplateResource list page",
      "description": "As an admin, I want to see all email templates in a list.",
      "acceptanceCriteria": [
        "Resource at app/Filament/Resources/EmailTemplateResource.php",
        "List page shows columns: name (searchable), subject (searchable), is_active (IconColumn), created_at",
        "List has filter for is_active status",
        "Sortable columns: name, created_at",
        "Navigation label: 'Email Templates' in Settings group",
        "Navigation icon: heroicon-o-envelope",
        "Accessible at /admin/email-templates",
        "php artisan test passes",
        "./vendor/bin/pint --test passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Resource created with list page, create/edit pages. All columns implemented: name (searchable/sortable), subject (searchable/sortable), is_active (IconColumn), created_at (sortable). TernaryFilter for is_active status. Navigation in Settings group with heroicon-o-envelope icon. Factory created for testing. Code style check passed."
    },
    {
      "id": "US-004",
      "title": "Add EmailTemplateResource create/edit form",
      "description": "As an admin, I want to create and edit email templates.",
      "acceptanceCriteria": [
        "Create form has: name (TextInput required max 255), subject (TextInput required max 500), body_html (RichEditor required), is_active (Toggle default true)",
        "Edit form pre-fills existing data correctly",
        "Form validates required fields",
        "Success notification on save",
        "Redirects to list after create",
        "php artisan test passes",
        "./vendor/bin/pint --test passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Form implemented with all required fields. Filament automatically handles validation, notifications, redirects, and data pre-filling. Code style check passed."
    },
    {
      "id": "US-005",
      "title": "Add template variables helper section",
      "description": "As an admin, I want to see which variables I can use in templates.",
      "acceptanceCriteria": [
        "Add Placeholder or Section component in form showing available variables",
        "Variables listed: customer_name, customer_email, company_name, case_number, case_subject, case_description, case_status, case_priority, created_at",
        "Each variable shown with description",
        "Hint text explains: Use {{variable_name}} in subject or body",
        "php artisan test passes",
        "./vendor/bin/pint --test passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Added Placeholder component in EmailTemplateResource form displaying all 9 required variables with descriptions and usage hint. Uses HtmlString for formatted output with Tailwind styling. Code style check passed."
    },
    {
      "id": "US-006",
      "title": "Add EmailTemplateService for rendering",
      "description": "As the system, I need a service to render templates with actual data.",
      "acceptanceCriteria": [
        "Service at app/Services/ServiceGateway/EmailTemplateService.php",
        "Method: render(EmailTemplate $template, array $data): array",
        "Returns ['subject' => string, 'body' => string]",
        "Replaces {{variable}} placeholders with values from $data",
        "Handles missing variables gracefully (replaces with empty string)",
        "Unit test covers: happy path, missing variables",
        "php artisan test passes",
        "./vendor/bin/pint --test passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Service created with render() method using regex to replace {{variable}} placeholders. Unit tests cover happy path, missing variables, no variables, empty data, and multiple occurrences. Code style check passed."
    },
    {
      "id": "US-007",
      "title": "Add template_id to ServiceOutputConfiguration",
      "description": "As a developer, I need to link output configurations to custom templates.",
      "acceptanceCriteria": [
        "Add migration: add template_id nullable column to service_output_configurations",
        "template_id is foreign key to email_templates with SET NULL on delete",
        "Update ServiceOutputConfiguration model with belongsTo EmailTemplate",
        "Migration runs successfully",
        "php artisan test passes",
        "./vendor/bin/pint --test passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Migration created to add template_id column with foreign key constraint to email_templates. ServiceOutputConfiguration model updated with fillable field and emailTemplate() relationship. Code style check passed."
    },
    {
      "id": "US-008",
      "title": "Integrate EmailTemplateService with EmailOutputHandler",
      "description": "As the system, I want emails to use custom templates when configured.",
      "acceptanceCriteria": [
        "Modify EmailOutputHandler::handle() method",
        "If ServiceOutputConfiguration has template_id, load and render that template",
        "Pass ServiceCase data as variables to template",
        "If no custom template, use existing default Blade template (fallback)",
        "Log which template was used",
        "php artisan test passes",
        "./vendor/bin/pint --test passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": "EmailOutputHandler modified to check for template_id and use EmailTemplateService. Added buildMailableFromTemplate() method that prepares ServiceCase data and renders template using EmailTemplateService. Log::info() added when using EmailTemplate from database. Falls back to existing email_template_type logic if no template_id. Code style check passed."
    }
  ]
}

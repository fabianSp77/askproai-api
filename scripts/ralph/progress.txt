# Ralph Progress Log - AskPro Gateway - Billing QC Fixes
Started: 2026-01-12

## Context
This Ralph run implements QC fixes identified during the Billing System Quality Control review.
Previous P0 fixes were already applied manually:
- P0-001: ServiceCase::markAsBilled() State Guard
- P0-002: Docblock "both" â†’ "hybrid" fix
- P0-004: Webhook Handler Logging
- P0-005: MySQL Lock Try-Finally

## Codebase Patterns (Billing-Specific)
- MonthlyBillingAggregator: Central service for aggregating billing data across companies
- AggregateInvoice: Invoice model with race-safe generateInvoiceNumber() using DB locks
- ServiceCase: Has billing_status field (unbilled/billed/waived) with state machine pattern
- ServiceOutputConfiguration: Contains pricing_mode, per_case_price_cents for Service Gateway billing
- BelongsToCompany trait: Used for multi-tenant isolation
- CompanyFeeSchedule: Company-level billing configuration
- StripeInvoicingService: Handles Stripe API integration and webhooks

## Key Files
- app/Services/Billing/MonthlyBillingAggregator.php - Core billing aggregation
- app/Services/Billing/StripeInvoicingService.php - Stripe webhooks
- app/Models/AggregateInvoice.php - Invoice with number generation
- app/Models/ServiceCase.php - Billing status tracking
- app/Models/ServiceOutputConfiguration.php - Pricing configuration
- tests/Feature/Billing/ - Existing billing tests

---

## 2026-01-12 12:15 UTC - US-000: Add Billing Methods to ServiceCase Model
- Added billing status state machine to ServiceCase model
- Implemented markAsBilled(int $invoiceItemId, int $amountCents) with state guard
- Implemented markAsWaived(string $reason) with state guard  
- Implemented isBillable() boolean check
- Added query scopes: scopeUnbilled(), scopeBilled(), scopeWaived()
- Added invoiceItem() BelongsTo relationship to AggregateInvoiceItem
- Added BILLING_UNBILLED, BILLING_BILLED, BILLING_WAIVED constants
- Added billing_status, billed_at, invoice_item_id, billed_amount_cents to $fillable and $casts

**Files changed:**
- app/Models/ServiceCase.php (132 lines added)

**Learnings for future iterations:**
- ServiceCase billing fields already added by migration 2026_01_12_122503_add_billing_to_service_gateway.php
- State machine pattern: markAsBilled() only works on 'unbilled' cases, markAsWaived() prevents waiving 'billed' cases
- BelongsTo relationships need the related model fully qualified or imported
- Pint auto-fixes phpdoc_separation and other style issues - run after editing
- Environment had pre-existing test issues: DB permission errors, file permission errors (DeliverCaseOutputJobTest.php owned by root), CalcomService config issues
- Used tinker smoke test to verify model implementation when full test suite has environmental blockers

**Pattern Identified:**
- Laravel state machine pattern: Check current state in method, throw LogicException if invalid transition
- Store metadata in JSON fields (ai_metadata) for audit trails (waiver reasons, timestamps)
- Query scopes follow naming: scope{StateName}() for filtering by status

---

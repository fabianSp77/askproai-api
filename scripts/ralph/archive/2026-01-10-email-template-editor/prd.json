{
  "project": "AskPro Gateway",
  "branchName": "ralph/email-template-consolidation",
  "description": "Email Template Konsolidierung - UI Integration, 48+ Variablen (100% Blade-Parität), Data Provider Pattern, Preset-System",
  "userStories": [
    {
      "id": "US-000",
      "title": "Create EmailTemplateDataProvider for variable organization",
      "description": "Als Entwickler brauche ich eine saubere Architektur für 48+ Template-Variablen.",
      "acceptanceCriteria": [
        "Neue Datei: app/Services/ServiceGateway/EmailTemplateDataProvider.php",
        "Constructor nimmt ServiceCase als Parameter",
        "Methode getVariables(): array gibt alle Variablen zurück",
        "Gruppierte private Methoden: getCustomerVariables(), getCaseVariables(), getAudioVariables(), getSlaVariables(), getCallVariables(), getAiVariables(), getAdminVariables(), getTranscriptVariables(), getSourceVariables(), getColorVariables()",
        "Konstante AVAILABLE_VARIABLES mit Liste aller 48+ Variablen",
        "EmailOutputHandler::buildMailableFromTemplate() nutzt DataProvider statt inline-Array",
        "php artisan test passes",
        "./vendor/bin/pint --test passes"
      ],
      "priority": 1,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-000b",
      "title": "Add missing critical case variables (source, case_type, category)",
      "description": "Als System muss ich source, case_type und category in Templates unterstützen.",
      "acceptanceCriteria": [
        "Neue Variablen in EmailTemplateDataProvider::getCaseVariables(): {{source}}, {{case_type}}, {{category}}",
        "source ist übersetzter Label (z.B. 'Telefonanruf' statt 'voice') - nutze ServiceCase::getSourceLabel()",
        "case_type ist übersetzter Label (z.B. 'Störung' statt 'incident') - nutze ServiceCase::getCaseTypeLabel()",
        "category nutzt $case->category->name Beziehung (nullable-safe)",
        "Unit Test für alle drei Variablen in EmailTemplateDataProviderTest",
        "php artisan test passes",
        "./vendor/bin/pint --test passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-000c",
      "title": "Add missing call/branch variables",
      "description": "Als System muss ich detaillierte Anruf-Informationen in Templates unterstützen.",
      "acceptanceCriteria": [
        "Neue Variablen in EmailTemplateDataProvider::getCallVariables(): {{called_company_name}}, {{called_branch_name}}, {{service_number_formatted}}, {{receiver_display}}",
        "called_company_name: $case->call->phoneNumber->company->name (nullable-safe)",
        "called_branch_name: $case->call->phoneNumber->branch->name (nullable-safe)",
        "service_number_formatted: $case->call->phoneNumber->formatted_number (nullable-safe)",
        "receiver_display: kombiniert Branch + Phone (z.B. 'Zentrale Berlin - +49 30 123456')",
        "Alle Variablen geben leeren String wenn Beziehung null",
        "Unit Tests für alle Variablen",
        "php artisan test passes",
        "./vendor/bin/pint --test passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-001",
      "title": "Add template_id selector to ServiceOutputConfigurationResource",
      "description": "Als Admin möchte ich beim Erstellen einer Output-Konfiguration ein Email-Template auswählen können.",
      "acceptanceCriteria": [
        "Select-Feld für template_id in ServiceOutputConfigurationResource form() hinzufügen",
        "Nutze ->relationship('emailTemplate', 'name', fn($query) => ...) mit company_id Filter",
        "Nur aktive Templates der aktuellen Company anzeigen (is_active = true)",
        "Erste Option: placeholder('Kein Template (Standard)')",
        "Feld nur sichtbar wenn output_type 'email' oder 'hybrid' ist (->visible())",
        "Helper-Text: 'Wählen Sie ein benutzerdefiniertes Email-Template'",
        "->searchable() und ->preload() für UX",
        "php artisan test passes",
        "./vendor/bin/pint --test passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Add template preview in ServiceOutputConfigurationResource",
      "description": "Als Admin möchte ich eine Vorschau des gewählten Templates sehen.",
      "acceptanceCriteria": [
        "Action Button 'Vorschau' neben Template-Selector (Forms\\Components\\Actions\\Action)",
        "Button öffnet Modal mit ->modalHeading('Template-Vorschau') und ->modalWidth('5xl')",
        "Modal nutzt ->modalContent() mit Blade View filament.forms.components.email-preview-modal",
        "Verwende SampleServiceCaseFactory für Preview-Daten",
        "Modal zeigt Subject und Body als formatiertes HTML",
        "->modalSubmitAction(false) und ->modalCancelActionLabel('Schließen')",
        "Button nur sichtbar wenn template_id ausgewählt",
        "php artisan test passes",
        "./vendor/bin/pint --test passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Extend EmailTemplateDataProvider with audio variables",
      "description": "Als System muss ich Audio-bezogene Variablen in Templates unterstützen.",
      "acceptanceCriteria": [
        "Neue Methode getAudioVariables() in EmailTemplateDataProvider",
        "Variablen: {{audio_url}}, {{has_audio}}, {{audio_duration}}",
        "audio_url nutzt URL::signedRoute('api.audio.stream', [...], now()->addHours(24))",
        "has_audio ist 'Ja' wenn audio_object_key vorhanden, sonst 'Nein'",
        "audio_duration formatiert als 'M:SS' (z.B. '2:34') aus $case->call->duration_seconds",
        "Nullable-safe: Leerer String wenn kein Audio vorhanden",
        "Unit Test für alle drei Variablen",
        "php artisan test passes",
        "./vendor/bin/pint --test passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Extend EmailTemplateDataProvider with SLA variables",
      "description": "Als System muss ich SLA-bezogene Variablen in Templates unterstützen.",
      "acceptanceCriteria": [
        "Neue Methode getSlaVariables() in EmailTemplateDataProvider",
        "Variablen: {{sla_response_due}}, {{sla_resolution_due}}, {{is_overdue}}, {{is_at_risk}}, {{is_response_overdue}}, {{is_resolution_overdue}}",
        "Datums-Formatierung: 'd.m.Y H:i' mit Timezone Europe/Berlin",
        "is_overdue ist 'Ja' wenn response ODER resolution überfällig",
        "is_at_risk ist 'Ja' wenn response-SLA in <30min fällig (diffInMinutes < 30)",
        "is_response_overdue, is_resolution_overdue nutzen ServiceCase::isResponseOverdue() etc.",
        "Nullable-safe wenn keine SLA konfiguriert (leerer String)",
        "Unit Test für alle 6 SLA-Variablen",
        "php artisan test passes",
        "./vendor/bin/pint --test passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Extend EmailTemplateDataProvider with basic call detail variables",
      "description": "Als System muss ich Basis-Anruf-Details in Templates unterstützen.",
      "acceptanceCriteria": [
        "Erweiterung von getCallVariables() mit: {{call_duration}}, {{caller_number}}, {{service_number}}",
        "call_duration formatiert als 'M:SS' aus $case->call->duration_seconds",
        "caller_number aus $case->call->from_number mit Phone-Formatierung (Spaces)",
        "service_number aus $case->call->to_number mit Phone-Formatierung",
        "Nullable-safe wenn kein Call verknüpft",
        "Unit Test für alle drei Variablen",
        "php artisan test passes",
        "./vendor/bin/pint --test passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Extend EmailTemplateDataProvider with AI variables",
      "description": "Als System muss ich AI-generierte Daten in Templates unterstützen.",
      "acceptanceCriteria": [
        "Neue Methode getAiVariables() in EmailTemplateDataProvider",
        "Variablen: {{ai_summary}}, {{ai_confidence}}, {{customer_location}}, {{problem_since}}",
        "Datenquelle: $case->ai_metadata JSON-Feld",
        "ai_confidence als Prozentzahl formatiert: number_format($value * 100, 0) . '%'",
        "customer_location aus ai_metadata['customer_location'] (nullable-safe)",
        "problem_since aus ai_metadata['problem_since'] (nullable-safe)",
        "ai_summary aus ai_metadata['summary'] ODER ai_metadata['ai_summary'] (Fallback)",
        "Unit Test für alle neuen Variablen",
        "php artisan test passes",
        "./vendor/bin/pint --test passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Extend EmailTemplateDataProvider with admin URL variable",
      "description": "Als System muss ich sichere Admin-Links in Templates unterstützen.",
      "acceptanceCriteria": [
        "Neue Methode getAdminVariables() in EmailTemplateDataProvider",
        "Variable: {{admin_url}}",
        "Signed URL mit 72h Gültigkeit: URL::signedRoute(..., now()->addHours(72))",
        "Route: 'filament.admin.resources.service-cases.view' mit ['record' => $case->id]",
        "Unit Test für admin_url Generierung und Signatur-Validität",
        "php artisan test passes",
        "./vendor/bin/pint --test passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Update EmailTemplateResource variables helper with 48+ variables and accessibility",
      "description": "Als Admin möchte ich alle 48+ verfügbaren Variablen im Template-Editor sehen mit Accessibility.",
      "acceptanceCriteria": [
        "Variables-Helper in EmailTemplateResource::form() zeigt alle Variablen gruppiert an",
        "Gruppen: Kunde (4), Fall (6), Quelle (3), Audio (3), SLA (6), Anruf (7), AI (4), Admin (1), Transcript (3)",
        "Nutzt EmailTemplateDataProvider::AVAILABLE_VARIABLES als Source of Truth",
        "Jede Variable mit Beschreibung (z.B. 'audio_url - Signierter Link zur Audioaufnahme, 24h gültig')",
        "Copy-to-clipboard mit Alpine.js x-on:click",
        "ACCESSIBILITY: aria-label='Variable {{name}} in Zwischenablage kopieren' auf jedem Button",
        "ACCESSIBILITY: focus:ring-2 focus:ring-primary-500 Keyboard-Styling",
        "Visual Feedback: 1.5s 'Kopiert' Anzeige mit Checkmark Icon",
        "Blade View in resources/views/filament/forms/components/template-variables.blade.php",
        "php artisan test passes",
        "./vendor/bin/pint --test passes"
      ],
      "priority": 11,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Add template type field to EmailTemplate",
      "description": "Als Admin möchte ich Templates als Internal oder Customer markieren können.",
      "acceptanceCriteria": [
        "Migration: template_type VARCHAR(20) default 'both' hinzufügen zu email_templates",
        "Erlaubte Werte: 'internal', 'customer', 'both'",
        "Model EmailTemplate: fillable hinzufügen, cast als string",
        "Filament EmailTemplateResource: Radio-Buttons im Form (Internal/Kunde/Beides)",
        "Helper-Text erklärt: Internal = nur für Mitarbeiter, Customer = für Kunden sichtbar",
        "Filter in List-Page nach template_type (SelectFilter)",
        "php artisan test passes",
        "./vendor/bin/pint --test passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Add transcript variables with truncation and eager loading",
      "description": "Als System muss ich Transkripte in Templates unterstützen mit Längen-Limit.",
      "acceptanceCriteria": [
        "Neue Methode getTranscriptVariables() in EmailTemplateDataProvider",
        "Variablen: {{transcript}}, {{transcript_truncated}}, {{transcript_length}}",
        "EAGER LOADING: EmailOutputHandler lädt 'callSession.transcriptSegments' vor Template-Rendering",
        "Datenquelle: $case->callSession->transcriptSegments sortiert nach segment_sequence",
        "Formatierung: 'Agent: text\\nKunde: text\\n...' mit Rolle-Labels basierend auf role Feld",
        "transcript begrenzt auf 10.000 Zeichen mit '...' am Ende wenn gekürzt",
        "transcript_truncated ist 'Ja' wenn gekürzt, sonst 'Nein'",
        "transcript_length zeigt Original-Länge formatiert (z.B. '15.432 Zeichen')",
        "Nullable-safe wenn kein callSession oder keine Segments",
        "Unit Test für Truncation-Logik bei exakt 10.001 Zeichen",
        "php artisan test passes",
        "./vendor/bin/pint --test passes"
      ],
      "priority": 13,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Create EmailTemplatePreset model and seeder",
      "description": "Als System brauche ich vordefinierte Template-Presets basierend auf bestehenden Blade-Templates.",
      "acceptanceCriteria": [
        "Migration: email_template_presets Tabelle (id, key VARCHAR(50) UNIQUE, name, description, subject, body_html, variables_hint TEXT, created_at, updated_at)",
        "Model: app/Models/EmailTemplatePreset.php (KEIN Company-Scope - global verfügbar)",
        "Model hat: fillable, keine Beziehungen",
        "Seeder: database/seeders/EmailTemplatePresetSeeder.php",
        "Seeder erstellt 4 Presets aus Blade-Templates: standard, technical, helpdesk, plaintext",
        "Preset 'standard' basiert auf notification-html-v2.blade.php Struktur",
        "Preset 'technical' basiert auf backup-notification.blade.php",
        "Preset 'helpdesk' basiert auf it-support-notification.blade.php",
        "Preset 'plaintext' basiert auf notification-text.blade.php",
        "Blade-Variablen ($var) konvertiert zu Mustache-Syntax ({{var}})",
        "php artisan test passes",
        "./vendor/bin/pint --test passes"
      ],
      "priority": 14,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Add Create from Preset action in EmailTemplateResource",
      "description": "Als Admin möchte ich ein neues Template aus einem Preset erstellen können.",
      "acceptanceCriteria": [
        "HeaderAction 'Aus Vorlage erstellen' in ListEmailTemplates Page hinzufügen",
        "Icon: heroicon-o-document-duplicate, Color: success",
        "Klick öffnet Modal mit Grid aller verfügbaren EmailTemplatePresets",
        "Modal nutzt Form mit View-Component für Grid-Darstellung",
        "Jedes Preset zeigt: Name, Beschreibung, variables_hint Auszug",
        "Klick auf Preset erstellt neues EmailTemplate mit Preset-Inhalt",
        "company_id wird automatisch auf aktuelle Company gesetzt",
        "Neues Template name: Preset-Name, is_active: false (Draft)",
        "Redirect zu Edit-Seite nach Erstellung",
        "php artisan test passes",
        "./vendor/bin/pint --test passes"
      ],
      "priority": 15,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Add preset preview modal",
      "description": "Als Admin möchte ich Presets vor dem Klonen ansehen können.",
      "acceptanceCriteria": [
        "Preview-Button pro Preset im Auswahl-Modal von US-012",
        "Icon: heroicon-o-eye",
        "Preview-Modal zeigt gerenderten HTML mit Sample-Daten aus SampleServiceCaseFactory",
        "Modal zeigt Subject und Body separat",
        "Modal zeigt Liste der genutzten Variablen aus variables_hint",
        "Zurück-Button zum Auswahl-Modal oder Schließen-Button",
        "php artisan test passes",
        "./vendor/bin/pint --test passes"
      ],
      "priority": 16,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-014",
      "title": "Add Duplicate Template action",
      "description": "Als Admin möchte ich ein bestehendes Template duplizieren können.",
      "acceptanceCriteria": [
        "Table Action 'Duplizieren' in EmailTemplateResource hinzufügen",
        "Icon: heroicon-o-document-duplicate",
        "Erstellt Kopie mit ' (Kopie)' Suffix im Namen",
        "Alle Felder werden kopiert: subject, body_html, variables, template_type",
        "NICHT kopiert: id, timestamps",
        "is_active wird auf false gesetzt (Draft-Status)",
        "Redirect zu Edit-Seite der Kopie",
        "Success Notification: 'Template wurde dupliziert'",
        "php artisan test passes",
        "./vendor/bin/pint --test passes"
      ],
      "priority": 17,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-015",
      "title": "Add EmailTemplatePresetResource for admin management",
      "description": "Als Super-Admin möchte ich Presets verwalten können.",
      "acceptanceCriteria": [
        "Filament Resource: app/Filament/Resources/EmailTemplatePresetResource.php",
        "CRUD-Funktionalität für EmailTemplatePreset",
        "Nur für Super-Admins sichtbar: canAccess() prüft auth()->user()->hasRole('super_admin')",
        "Navigation: Settings Gruppe, Label 'Template Presets', Icon: heroicon-o-rectangle-stack",
        "List zeigt: key, name, updated_at",
        "Form: key (disabled nach create), name, description (Textarea), subject, body_html (RichEditor), variables_hint (Textarea)",
        "Pages-Verzeichnis mit List, Create, Edit Pages",
        "php artisan test passes",
        "./vendor/bin/pint --test passes"
      ],
      "priority": 18,
      "passes": false,
      "notes": ""
    }
  ]
}

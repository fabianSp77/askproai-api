.
./app
./bootstrap
./config
./database
./documentation
./dokumentation
./public
./resources
./routes
./scripts
./storage
./tests
./vendor

--- CONTROLLER-DATEIEN ---
app/Http/Controllers/Admin/FAQController.php
app/Http/Controllers/Admin/PremiumServiceController.php
app/Http/Controllers/API/AppointmentController.php
app/Http/Controllers/API/BusinessController.php
app/Http/Controllers/Api/CalcomBookingController.php
app/Http/Controllers/API/CalComController.php
app/Http/Controllers/API/CallController.php
app/Http/Controllers/ApiController.php
app/Http/Controllers/API/CustomerController.php
app/Http/Controllers/API/FaqController.php
app/Http/Controllers/API/KundeController.php
app/Http/Controllers/API/RetellWebhookController.php
app/Http/Controllers/API/SamediController.php
app/Http/Controllers/API/ServiceController.php
app/Http/Controllers/API/StaffController.php
app/Http/Controllers/Auth/AuthenticatedSessionController.php
app/Http/Controllers/Auth/ConfirmablePasswordController.php
app/Http/Controllers/AuthController.php
app/Http/Controllers/Auth/EmailVerificationNotificationController.php
app/Http/Controllers/Auth/EmailVerificationPromptController.php
app/Http/Controllers/Auth/ForgotPasswordController.php
app/Http/Controllers/Auth/NewPasswordController.php
app/Http/Controllers/Auth/PasswordController.php
app/Http/Controllers/Auth/PasswordResetLinkController.php
app/Http/Controllers/Auth/RegisteredUserController.php
app/Http/Controllers/Auth/ResetPasswordController.php
app/Http/Controllers/Auth/VerifyEmailController.php
app/Http/Controllers/CalcomController.php
app/Http/Controllers/CalComController.php
app/Http/Controllers/CallController.php
app/Http/Controllers/Controller.php
app/Http/Controllers/CustomerController.php
app/Http/Controllers/DashboardController.php
app/Http/Controllers/DocumentationController.php
app/Http/Controllers/ExampleController.php
app/Http/Controllers/ExportController.php
app/Http/Controllers/FaqController.php
app/Http/Controllers/FAQController.php
app/Http/Controllers/IntegrationController.php
app/Http/Controllers/KundeController.php
app/Http/Controllers/KundenController.php
app/Http/Controllers/PremiumServiceController.php
app/Http/Controllers/ProfileController.php
app/Http/Controllers/ReportsController.php
app/Http/Controllers/RetellAiController.php
app/Http/Controllers/RetellAIController.php
app/Http/Controllers/RetellWebhookController_backup_202503211136.php
app/Http/Controllers/RetellWebhookController.php
app/Http/Controllers/SamediController.php
app/Http/Controllers/WebDashboardController.php

--- MODEL-DATEIEN ---
app/Models/Appointment.php
app/Models/Business.php
app/Models/CallLog.php
app/Models/Call.php
app/Models/Customer.php
app/Models/Dienstleistung.php
app/Models/Faq.php
app/Models/FAQ.php
app/Models/Integration.php
app/Models/Kunde.php
app/Models/Mitarbeiter.php
app/Models/PhoneNumber.php
app/Models/PremiumService.php
app/Models/Service.php
app/Models/Staff.php
app/Models/Telefonnummer.php
app/Models/Termin.php
app/Models/User.php

--- SERVICE-DATEIEN ---
app/Models/PremiumService.php
app/Models/Service.php
app/Services/CalcomService.php
app/Services/CalComService.php
app/Services/RetellAIService.php

--- ROUTEN ---
API-ROUTEN:
<?php
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Route;
use App\Http\Controllers\API\CalComController;
use App\Http\Controllers\API\KundeController;
// Kommentierte Controller, die noch nicht existieren
// use App\Http\Controllers\API\SamediController;
// use App\Http\Controllers\API\CustomerController;
// use App\Http\Controllers\API\ServiceController;
// use App\Http\Controllers\API\AppointmentController;
// use App\Http\Controllers\API\StaffController;
// use App\Http\Controllers\API\MitarbeiterController;
// use App\Http\Controllers\API\TelefonnummerController;

/*
|--------------------------------------------------------------------------
| API Routes
|--------------------------------------------------------------------------
|
| Here is where you can register API routes for your application. These
| routes are loaded by the RouteServiceProvider and all of them will
| be assigned to the "api" middleware group. Make something great!
|
*/

// Öffentliche Routen - ohne Authentifizierung
// Cal.com-Routen
Route::post('/calcom/check-availability', [CalComController::class, 'checkAvailability']);
Route::post('/calcom/book-appointment', [CalComController::class, 'bookAppointment']);

// Retell.ai Webhook-Endpunkt (jetzt außerhalb des Auth-Bereichs)
Route::post('/webhooks/retell', [\App\Http\Controllers\RetellWebhookController::class, 'handleWebhook']);

// Test-Route ohne Authentifizierung
Route::get('/ping', function () {
    return ['message' => 'API aktiv!', 'status' => 'online'];
});

// Geschützte Routen - erfordern Authentifizierung
Route::middleware('auth:api')->group(function () {
    // User-Informationen
    Route::get('/user', function (Request $request) {
        return $request->user();
    });
    
    // Test-Route mit Authentifizierung
    Route::get('/test', function (Request $request) {
        return ['message' => 'API funktioniert!', 'user' => $request->user()->name];
    });

    // Kunden-Routen
    Route::get('/kunden', [KundeController::class, 'index']);
    Route::post('/kunden', [KundeController::class, 'store']);
    Route::get('/kunden/{kunde}', [KundeController::class, 'show']);
    Route::put('/kunden/{kunde}', [KundeController::class, 'update']);
    Route::delete('/kunden/{kunde}', [KundeController::class, 'destroy']);

    // Kommentiere die nicht existierenden Controller-Routen aus
    /*
    // Samedi API-Integration
    Route::prefix('samedi')->group(function () {
        Route::get('/test', [SamediController::class, 'test']);
        Route::get('/bookable-times', [SamediController::class, 'listBookableTimes']);
        Route::get('/locations', [SamediController::class, 'getLocations']);
        Route::get('/services', [SamediController::class, 'getServices']);
        Route::post('/appointments', [SamediController::class, 'createAppointment']);
    });

    // API Ressourcen (alle weiteren API-Endpunkte)
    Route::name('api.')->group(function () {
        Route::apiResource('customers', CustomerController::class);
        Route::apiResource('services', ServiceController::class);
        Route::apiResource('appointments', AppointmentController::class);
        Route::apiResource('mitarbeiter', MitarbeiterController::class);
        Route::apiResource('telefonnummern', TelefonnummerController::class);
        Route::apiResource('calls', CallController::class);
    });
    */
});

WEB-ROUTEN:
<?php

use App\Http\Controllers\ProfileController;
use Illuminate\Support\Facades\Route;

Route::get('/', function () {
    return view('welcome');
});

Route::get('/dashboard', function () {
    return view('dashboard');
})->middleware(['auth', 'verified'])->name('dashboard');

Route::middleware('auth')->group(function () {
    Route::get('/profile', [ProfileController::class, 'edit'])->name('profile.edit');
    Route::patch('/profile', [ProfileController::class, 'update'])->name('profile.update');
    Route::delete('/profile', [ProfileController::class, 'destroy'])->name('profile.destroy');
});

// Dokumentationsroute
Route::middleware(['auth'])->group(function () {
    Route::get('/docs/{path?}', function ($path = 'index.html') {
        $filePath = public_path('docs/' . $path);
        if (file_exists($filePath)) {
            return response()->file($filePath);
        }
        abort(404);
    })->where('path', '.*');
});

require __DIR__.'/auth.php';

--- COMPOSER-PAKETE ---
brick/math                         0.12.3    Arbitrary-precision arithmetic library
carbonphp/carbon-doctrine-types    3.2.0     Types to use Carbon in Doctrine
darkaonline/l5-swagger             9.0.1     OpenApi or Swagger integration to Laravel
defuse/php-encryption              v2.4.0    Secure PHP Encryption Library
dflydev/dot-access-data            v3.0.3    Given a deep data structure, access data by dot notation.
doctrine/annotations               2.0.2     Docblock Annotations Parser
doctrine/inflector                 2.0.10    PHP Doctrine Inflector is a small library that can perform strin...
doctrine/lexer                     3.0.1     PHP Doctrine Lexer parser library that can be used in Top-Down, ...
dragonmantank/cron-expression      v3.4.0    CRON for PHP: Calculate the next or previous run date and determ...
egulias/email-validator            4.0.3     A library for validating emails against several RFCs
fakerphp/faker                     v1.24.1   Faker is a PHP library that generates fake data for you.
filp/whoops                        2.17.0    php error handling for cool kids
firebase/php-jwt                   v6.11.0   A simple library to encode and decode JSON Web Tokens (JWT) in P...
fruitcake/php-cors                 v1.3.0    Cross-origin resource sharing library for the Symfony HttpFounda...
graham-campbell/result-type        v1.1.3    An Implementation Of The Result Type
guzzlehttp/guzzle                  7.9.2     Guzzle is a PHP HTTP client library
guzzlehttp/promises                2.0.4     Guzzle promises library
guzzlehttp/psr7                    2.7.0     PSR-7 message implementation that also provides common utility m...
guzzlehttp/uri-template            v1.0.4    A polyfill class for uri_template of PHP
hamcrest/hamcrest-php              v2.0.1    This is the PHP port of Hamcrest Matchers
laravel/breeze                     v2.3.6    Minimal Laravel authentication scaffolding with Blade and Tailwind.
laravel/framework                  v12.1.0   The Laravel Framework.
laravel/pail                       v1.2.2    Easily delve into your Laravel application's log files directly ...
laravel/passport                   v12.4.2   Laravel Passport provides OAuth2 server support to Laravel.
laravel/pint                       v1.21.0   An opinionated code formatter for PHP.
laravel/prompts                    v0.3.5    Add beautiful and user-friendly forms to your command-line appli...
laravel/sail                       v1.41.0   Docker files for running a basic Laravel application.
laravel/sanctum                    v4.0.8    Laravel Sanctum provides a featherweight authentication system f...
laravel/serializable-closure       v2.0.3    Laravel Serializable Closure provides an easy and secure way to ...
laravel/tinker                     v2.10.1   Powerful REPL for the Laravel framework.
lcobucci/clock                     3.3.1     Yet another clock abstraction
lcobucci/jwt                       5.5.0     A simple library to work with JSON Web Token and JSON Web Signature
league/commonmark                  2.6.1     Highly-extensible PHP Markdown parser which fully supports the C...
league/config                      v1.2.0    Define configuration arrays with strict schemas and access value...
league/event                       2.3.0     Event package
league/flysystem                   3.29.1    File storage abstraction for PHP
league/flysystem-local             3.29.0    Local filesystem adapter for Flysystem.
league/mime-type-detection         1.16.0    Mime-type detection for Flysystem
league/oauth2-server               8.5.5     A lightweight and powerful OAuth 2.0 authorization and resource ...
league/uri                         7.5.1     URI manipulation library
league/uri-interfaces              7.5.0     Common interfaces and classes for URI representation and interac...
mockery/mockery                    1.6.12    Mockery is a simple yet flexible PHP mock object framework
monolog/monolog                    3.8.1     Sends your logs to files, sockets, inboxes, databases and variou...
myclabs/deep-copy                  1.13.0    Create deep copies (clones) of your objects
nesbot/carbon                      3.8.6     An API extension for DateTime that supports 281 different langua...
nette/schema                       v1.3.2    📐 Nette Schema: validating data structures against a given Sc...
nette/utils                        v4.0.5    🛠  Nette Utils: lightweight utilities for string & array mani...
nikic/php-parser                   v5.4.0    A PHP parser written in PHP
nunomaduro/collision               v8.6.1    Cli error handling for console/command-line PHP applications.
nunomaduro/termwind                v2.3.0    Its like Tailwind CSS, but for the console.
nyholm/psr7                        1.8.2     A fast PHP7 implementation of PSR-7
paragonie/constant_time_encoding   v3.0.0    Constant-time Implementations of RFC 4648 Encoding (Base-64, Bas...
paragonie/random_compat            v9.99.100 PHP 5.x polyfill for random_bytes() and random_int() from PHP 7
phar-io/manifest                   2.0.4     Component for reading phar.io manifest information from a PHP Ar...
phar-io/version                    3.2.1     Library for handling version information and constraints
phpoption/phpoption                1.9.3     Option Type for PHP
phpseclib/phpseclib                3.0.43    PHP Secure Communications Library - Pure-PHP implementations of ...
phpunit/php-code-coverage          11.0.9    Library that provides collection, processing, and rendering func...
phpunit/php-file-iterator          5.1.0     FilterIterator implementation that filters files based on a list...
phpunit/php-invoker                5.0.1     Invoke callables with a timeout
phpunit/php-text-template          4.0.1     Simple template engine.
phpunit/php-timer                  7.0.1     Utility class for timing
phpunit/phpunit                    11.5.11   The PHP Unit Testing framework.
psr/cache                          3.0.0     Common interface for caching libraries
psr/clock                          1.0.0     Common interface for reading the clock.
psr/container                      2.0.2     Common Container Interface (PHP FIG PSR-11)
psr/event-dispatcher               1.0.0     Standard interfaces for event handling.
psr/http-client                    1.0.3     Common interface for HTTP clients
psr/http-factory                   1.1.0     PSR-17: Common interfaces for PSR-7 HTTP message factories
psr/http-message                   2.0       Common interface for HTTP messages
psr/log                            3.0.2     Common interface for logging libraries
psr/simple-cache                   3.0.0     Common interfaces for simple caching
psy/psysh                          v0.12.7   An interactive shell for modern PHP.
ralouphie/getallheaders            3.0.3     A polyfill for getallheaders.
ramsey/collection                  2.1.0     A PHP library for representing and manipulating collections.
ramsey/uuid                        4.7.6     A PHP library for generating and working with universally unique...
sebastian/cli-parser               3.0.2     Library for parsing CLI options
sebastian/code-unit                3.0.2     Collection of value objects that represent the PHP code units
sebastian/code-unit-reverse-lookup 4.0.1     Looks up which function or method a line of code belongs to
sebastian/comparator               6.3.0     Provides the functionality to compare PHP values for equality
sebastian/complexity               4.0.1     Library for calculating the complexity of PHP code units
sebastian/diff                     6.0.2     Diff implementation
sebastian/environment              7.2.0     Provides functionality to handle HHVM/PHP environments
sebastian/exporter                 6.3.0     Provides the functionality to export PHP variables for visualiza...
sebastian/global-state             7.0.2     Snapshotting of global state
sebastian/lines-of-code            3.0.1     Library for counting the lines of code in PHP source code
sebastian/object-enumerator        6.0.1     Traverses array structures and object graphs to enumerate all re...
sebastian/object-reflector         4.0.1     Allows reflection of object attributes, including inherited and ...
sebastian/recursion-context        6.0.2     Provides functionality to recursively process PHP variables
sebastian/type                     5.1.0     Collection of value objects that represent the types of the PHP ...
sebastian/version                  5.0.2     Library that helps with managing the version number of Git-hoste...
staabm/side-effects-detector       1.0.5     A static analysis tool to detect side effects in PHP code
swagger-api/swagger-ui             v5.20.0    Swagger UI is a collection of HTML, Javascript, and CSS assets ...
symfony/clock                      v7.2.0    Decouples applications from the system clock
symfony/console                    v7.2.1    Eases the creation of beautiful and testable command line interf...
symfony/css-selector               v7.2.0    Converts CSS selectors to XPath expressions
symfony/deprecation-contracts      v3.5.1    A generic function and convention to trigger deprecation notices
symfony/error-handler              v7.2.4    Provides tools to manage errors and ease debugging PHP code
symfony/event-dispatcher           v7.2.0    Provides tools that allow your application components to communi...
symfony/event-dispatcher-contracts v3.5.1    Generic abstractions related to dispatching event
symfony/finder                     v7.2.2    Finds files and directories via an intuitive fluent interface
symfony/http-foundation            v7.2.3    Defines an object-oriented layer for the HTTP specification
symfony/http-kernel                v7.2.4    Provides a structured process for converting a Request into a Re...
symfony/mailer                     v7.2.3    Helps sending emails
symfony/mime                       v7.2.4    Allows manipulating MIME messages
symfony/polyfill-ctype             v1.31.0   Symfony polyfill for ctype functions
symfony/polyfill-intl-grapheme     v1.31.0   Symfony polyfill for intl's grapheme_* functions
symfony/polyfill-intl-idn          v1.31.0   Symfony polyfill for intl's idn_to_ascii and idn_to_utf8 functions
symfony/polyfill-intl-normalizer   v1.31.0   Symfony polyfill for intl's Normalizer class and related functions
symfony/polyfill-mbstring          v1.31.0   Symfony polyfill for the Mbstring extension
symfony/polyfill-php80             v1.31.0   Symfony polyfill backporting some PHP 8.0+ features to lower PHP...
symfony/polyfill-php83             v1.31.0   Symfony polyfill backporting some PHP 8.3+ features to lower PHP...
symfony/polyfill-uuid              v1.31.0   Symfony polyfill for uuid functions
symfony/process                    v7.2.4    Executes commands in sub-processes
symfony/psr-http-message-bridge    v7.2.0    PSR HTTP message bridge
symfony/routing                    v7.2.3    Maps an HTTP request to a set of configuration variables
symfony/service-contracts          v3.5.1    Generic abstractions related to writing services
symfony/string                     v7.2.0    Provides an object-oriented API to strings and deals with bytes,...
symfony/translation                v7.2.4    Provides tools to internationalize your application
symfony/translation-contracts      v3.5.1    Generic abstractions related to translation
symfony/uid                        v7.2.0    Provides an object-oriented API to generate and represent UIDs
symfony/var-dumper                 v7.2.3    Provides mechanisms for walking through any arbitrary PHP variable
symfony/yaml                       v7.2.3    Loads and dumps YAML files
theseer/tokenizer                  1.2.3     A small library for converting tokenized PHP source code into XM...
tijsverkoyen/css-to-inline-styles  v2.3.0    CssToInlineStyles is a class that enables you to convert HTML-pa...
vlucas/phpdotenv                   v5.6.1    Loads environment variables from `.env` to `getenv()`, `$_ENV` a...
voku/portable-ascii                2.0.3     Portable ASCII library - performance optimized (ascii) string fu...
webmozart/assert                   1.11.0    Assertions to validate method input/output with nice error messa...
zircote/swagger-php                5.0.5     swagger-php - Generate interactive documentation for your RESTfu...

--- LARAVEL-VERSION ---
Laravel Framework 12.1.0

--- PHP-VERSION ---
PHP 8.2.26 (cli) (built: Nov 25 2024 17:21:51) (NTS)
Copyright (c) The PHP Group
Zend Engine v4.2.26, Copyright (c) Zend Technologies
    with Zend OPcache v8.2.26, Copyright (c), by Zend Technologies

========= KONFIGURATIONSDATEIEN =========
Datum der Erfassung: Mo 24. Mär 10:53:20 CET 2025

--- .ENV-DATEI (ZENSIERT) ---
APP_NAME=AskProAI
APP_ENV=production
APP_KEY=***ZENSIERT***
APP_DEBUG=true
APP_URL=http://152.53.228.178
LOG_CHANNEL=stack
LOG_LEVEL=debug
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=askproai_db
DB_USERNAME=askproai_user
DB_PASSWORD=***ZENSIERT***
BROADCAST_DRIVER=log
CACHE_DRIVER=file
FILESYSTEM_DISK=local
QUEUE_CONNECTION=sync
SESSION_DRIVER=file
SESSION_LIFETIME=120
MEMCACHED_HOST=127.0.0.1
MAIL_MAILER=smtp
MAIL_HOST=smtps.udag.de
MAIL_PORT=587
MAIL_USERNAME=askproai-de-0001
MAIL_PASSWORD=***ZENSIERT***
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS="info@askproai.de"
MAIL_FROM_NAME="${APP_NAME}"
CALCOM_API_KEY=cal_live_e9aa2c4d18e0fd79cf4f8dddb90903da
CALCOM_BASE_URL=https://api.cal.com/v1
RETELL_AI_API_KEY=key_6ff998ba48e842092e04a5455d19
RETELL_AI_BASE_URL=https://api.retell.ai/v1
PASSPORT_PRIVATE_KEY=/var/www/api-gateway/storage/oauth-private.key
PASSPORT_PUBLIC_KEY=/var/www/api-gateway/storage/oauth-public.key
# Samedi API Konfiguration
SAMEDI_CLIENT_ID=8v9gsjxkcz3m2on5tubso36rq59icyd
SAMEDI_CLIENT_SECRET=d2gz3pb9r2kmfrakfgbajt6k11lkrga
SAMEDI_BASE_URL=https://api.samedi.de/api/v1
FORCE_HTTPS=false

--- NGINX-KONFIGURATION ---
server {
    listen 80;
    server_name 152.53.228.178;

    root /var/www/api-gateway/public;
    index index.php index.html;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
    }

    location ~ /\.ht {
        deny all;
    }

    location ~ \.md$ {
        default_type text/plain;
    }

    # Explizit korrekte location für Dokumentation
    location /admin/documentation/ {
        alias /var/www/api-gateway/public/admin/documentation/;
        index index.html;
        autoindex off;
        try_files $uri $uri/index.html =404;
    }

    # Assets sauber definieren
    location /admin/documentation/assets/ {
        alias /var/www/api-gateway/public/admin/documentation/assets/;
        try_files $uri $uri/ =404;
    }
}
server {
    listen 80;
    server_name 152.53.228.178;
    root /var/www/api-gateway-staging/public;
    index index.php index.html;

    # Erzwinge HTTPS-Umleitung
    # if ($scheme != "https") {
    #     return 301 https://$host$request_uri;
    # }

    # Verhindern von Zugriff auf sensitive Dateien
    location ~ \.(env|log) {
        deny all;
    }

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
    }
}
server {
    listen 8080;
    listen [::]:8080;
    server_name staging.152.53.228.178.nip.io;
    
    root /var/www/api-gateway-staging/public;
    index index.php index.html index.htm;
    
    access_log /var/log/nginx/staging.askproai.access.log;
    error_log /var/log/nginx/staging.askproai.error.log;
    
    location = /dashboard {
        return 301 /staging-dashboard;
    }
    
    location = /dashboard/ {
        return 301 /staging-dashboard;
    }
    
    location /dashboard/ {
        try_files $uri $uri/ /index.php?$query_string;
    }
    
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }
    
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }
    
    location ~ /\.ht {
        deny all;
    }
    
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}
server {
    listen 80;
    server_name staging.askproai.de;
    root /var/www/api-gateway-staging/public;
    index index.php index.html;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
    }

    # Grundlegender HTTP-Authentifizierungsschutz
    auth_basic "AskProAI Staging";
    auth_basic_user_file /var/www/api-gateway-staging/.htpasswd;
}

--- PHP-KONFIGURATION ---
error_reporting => 22527 => 22527
max_execution_time => 0 => 0
memory_limit => -1 => -1
post_max_size => 8M => 8M
upload_max_filesize => 2M => 2M

--- LARAVEL CONFIG-DATEIEN ---
database.php (ZENSIERT):
<?php

use Illuminate\Support\Str;

return [

    /*
    |--------------------------------------------------------------------------
    | Default Database Connection Name
    |--------------------------------------------------------------------------
    |
    | Here you may specify which of the database connections below you wish
    | to use as your default connection for database operations. This is
    | the connection which will be utilized unless another connection
    | is explicitly specified when you execute a query / statement.
    |
    */

    'default' => env('DB_CONNECTION', 'sqlite'),

    /*
    |--------------------------------------------------------------------------
    | Database Connections
    |--------------------------------------------------------------------------
    |
    | Below are all of the database connections defined for your application.
    | An example configuration is provided for each database system which
    | is supported by Laravel. You're free to add / remove connections.
    |
    */

    'connections' => [

        'sqlite' => [
            'driver' => 'sqlite',
            'url' => env('DB_URL'),
            'database' => env('DB_DATABASE', database_path('database.sqlite')),
            'prefix' => '',
            'foreign_key_constraints' => env('DB_FOREIGN_KEYS', true),
            'busy_timeout' => null,
            'journal_mode' => null,
            'synchronous' => null,
        ],

        'mysql' => [
            'driver' => 'mysql',
            'url' => env('DB_URL'),
            'host' => env('DB_HOST', '127.0.0.1'),
            'port' => env('DB_PORT', '3306'),
            'database' => env('DB_DATABASE', 'laravel'),
            'username' => env('DB_USERNAME', 'root'),
            'password' => ***ZENSIERT***,
            'unix_socket' => env('DB_SOCKET', ''),
            'charset' => env('DB_CHARSET', 'utf8mb4'),
            'collation' => env('DB_COLLATION', 'utf8mb4_unicode_ci'),
            'prefix' => '',
            'prefix_indexes' => true,
            'strict' => true,
            'engine' => null,
            'options' => extension_loaded('pdo_mysql') ? array_filter([
                PDO::MYSQL_ATTR_SSL_CA => env('MYSQL_ATTR_SSL_CA'),
            ]) : [],
        ],

        'mariadb' => [
            'driver' => 'mariadb',
            'url' => env('DB_URL'),
            'host' => env('DB_HOST', '127.0.0.1'),
            'port' => env('DB_PORT', '3306'),
            'database' => env('DB_DATABASE', 'laravel'),
            'username' => env('DB_USERNAME', 'root'),
            'password' => ***ZENSIERT***,
            'unix_socket' => env('DB_SOCKET', ''),
            'charset' => env('DB_CHARSET', 'utf8mb4'),
            'collation' => env('DB_COLLATION', 'utf8mb4_unicode_ci'),
            'prefix' => '',
            'prefix_indexes' => true,
            'strict' => true,
            'engine' => null,
            'options' => extension_loaded('pdo_mysql') ? array_filter([
                PDO::MYSQL_ATTR_SSL_CA => env('MYSQL_ATTR_SSL_CA'),
            ]) : [],
        ],

        'pgsql' => [
            'driver' => 'pgsql',
            'url' => env('DB_URL'),
            'host' => env('DB_HOST', '127.0.0.1'),
            'port' => env('DB_PORT', '5432'),
            'database' => env('DB_DATABASE', 'laravel'),
            'username' => env('DB_USERNAME', 'root'),
            'password' => ***ZENSIERT***,
            'charset' => env('DB_CHARSET', 'utf8'),
            'prefix' => '',
            'prefix_indexes' => true,
            'search_path' => 'public',
            'sslmode' => 'prefer',
        ],

        'sqlsrv' => [
            'driver' => 'sqlsrv',
            'url' => env('DB_URL'),
            'host' => env('DB_HOST', 'localhost'),
            'port' => env('DB_PORT', '1433'),
            'database' => env('DB_DATABASE', 'laravel'),
            'username' => env('DB_USERNAME', 'root'),
            'password' => ***ZENSIERT***,
            'charset' => env('DB_CHARSET', 'utf8'),
            'prefix' => '',
            'prefix_indexes' => true,
            // 'encrypt' => env('DB_ENCRYPT', 'yes'),
            // 'trust_server_certificate' => env('DB_TRUST_SERVER_CERTIFICATE', 'false'),
        ],

    ],

    /*
    |--------------------------------------------------------------------------
    | Migration Repository Table
    |--------------------------------------------------------------------------
    |
    | This table keeps track of all the migrations that have already run for
    | your application. Using this information, we can determine which of
    | the migrations on disk haven't actually been run on the database.
    |
    */

    'migrations' => [
        'table' => 'migrations',
        'update_date_on_publish' => true,
    ],

    /*
    |--------------------------------------------------------------------------
    | Redis Databases
    |--------------------------------------------------------------------------
    |
    | Redis is an open source, fast, and advanced key-value store that also
    | provides a richer body of commands than a typical key-value system
    | such as Memcached. You may define your connection settings here.
    |
    */

    'redis' => [

        'client' => env('REDIS_CLIENT', 'phpredis'),

        'options' => [
            'cluster' => env('REDIS_CLUSTER', 'redis'),
            'prefix' => env('REDIS_PREFIX', Str::slug(env('APP_NAME', 'laravel'), '_').'_database_'),
            'persistent' => env('REDIS_PERSISTENT', false),
        ],

        'default' => [
            'url' => env('REDIS_URL'),
            'host' => env('REDIS_HOST', '127.0.0.1'),
            'username' => env('REDIS_USERNAME'),
            'password' => ***ZENSIERT***,
            'port' => env('REDIS_PORT', '6379'),
            'database' => env('REDIS_DB', '0'),
        ],

        'cache' => [
            'url' => env('REDIS_URL'),
            'host' => env('REDIS_HOST', '127.0.0.1'),
            'username' => env('REDIS_USERNAME'),
            'password' => ***ZENSIERT***,
            'port' => env('REDIS_PORT', '6379'),
            'database' => env('REDIS_CACHE_DB', '1'),
        ],

    ],

];

app.php:
<?php

use Illuminate\Support\Facades\Facade;

return [

    'name' => env('APP_NAME', 'Laravel'),
    'env' => env('APP_ENV', 'production'),
    'debug' => (bool) env('APP_DEBUG', false),
    'url' => env('APP_URL', 'http://localhost'),
    'asset_url' => env('ASSET_URL'),
    'timezone' => 'UTC',
    'locale' => 'en',
    'fallback_locale' => 'en',
    'faker_locale' => 'en_US',
    'key' => env('APP_KEY'),
    'cipher' => 'AES-256-CBC',

    'providers' => [

        // Laravel Framework Service Providers
        Illuminate\Auth\AuthServiceProvider::class,
        Illuminate\Broadcasting\BroadcastServiceProvider::class,
        Illuminate\Bus\BusServiceProvider::class,
        Illuminate\Cache\CacheServiceProvider::class,
        Illuminate\Foundation\Providers\ConsoleSupportServiceProvider::class,
        Illuminate\Cookie\CookieServiceProvider::class,
        Illuminate\Database\DatabaseServiceProvider::class,
        Illuminate\Encryption\EncryptionServiceProvider::class,
        Illuminate\Filesystem\FilesystemServiceProvider::class,
        Illuminate\Foundation\Providers\FoundationServiceProvider::class,
        Illuminate\Hashing\HashServiceProvider::class,
        Illuminate\Mail\MailServiceProvider::class,
        Illuminate\Notifications\NotificationServiceProvider::class,
        Illuminate\Pagination\PaginationServiceProvider::class,
        Illuminate\Pipeline\PipelineServiceProvider::class,
        Illuminate\Queue\QueueServiceProvider::class,
        Illuminate\Redis\RedisServiceProvider::class,
        Illuminate\Auth\Passwords\PasswordResetServiceProvider::class,
        Illuminate\Session\SessionServiceProvider::class,
        Illuminate\Translation\TranslationServiceProvider::class,
        Illuminate\Validation\ValidationServiceProvider::class,
        Illuminate\View\ViewServiceProvider::class,

        // Package Service Providers
        Laravel\Sanctum\SanctumServiceProvider::class,
        Laravel\Passport\PassportServiceProvider::class,
        L5Swagger\L5SwaggerServiceProvider::class,

        // Application Service Providers
        App\Providers\AppServiceProvider::class,
        App\Providers\AuthServiceProvider::class,
        App\Providers\RouteServiceProvider::class,
    ],

    'aliases' => Facade::defaultAliases()->merge([
        'Http' => Illuminate\Support\Facades\Http::class,
    ])->toArray(),

];

auth.php:
<?php

return [
    'defaults' => [
        'guard' => 'web',
        'passwords' => 'users',
    ],

    'guards' => [
        'web' => [
            'driver' => 'session',
            'provider' => 'users',
        ],

        'api' => [
            'driver' => 'passport',
            'provider' => 'users',
            'hash' => false,
        ],
    ],

    'providers' => [
        'users' => [
            'driver' => 'eloquent',
            'model' => App\Models\User::class,
        ],
    ],

    'passwords' => [
        'users' => [
            'provider' => 'users',
            'table' => 'password_reset_tokens',
            'expire' => 60,
            'throttle' => 60,
        ],
    ],

    'password_timeout' => 10800,
];
========= BACKUP & CRON-JOBS =========
Datum der Erfassung: Mo 24. Mär 10:53:26 CET 2025

--- BACKUP-SKRIPT ---
#!/bin/bash

# Umfassendes Backup-Skript für AskProAI
# Sichere Variante mit verbesserter Struktur und Funktionalität

# Basiskonfiguration
TIMESTAMP=$(date +%Y-%m-%d_%H-%M-%S)
BACKUP_DIR="/var/backups/askproai"
DB_BACKUP_DIR="$BACKUP_DIR/db"
FILES_BACKUP_DIR="$BACKUP_DIR/files"
CONFIG_BACKUP_DIR="$BACKUP_DIR/config/config_backup_$TIMESTAMP"
LOGS_DIR="$BACKUP_DIR/logs"
LOG_FILE="$LOGS_DIR/backup_$TIMESTAMP.log"
OFFSITE_ARCHIVE="$BACKUP_DIR/offsite_backup_$TIMESTAMP.tar.gz"

# Datenbank-Zugangsdaten
DB_USER="askproai_user"
DB_PASS="Vb39!pLc#7Lqwp\$X"
DB_NAME="askproai_db"

# Email-Benachrichtigung
ADMIN_EMAIL="fabian@askproai.de"

# Aufbewahrungsdauer
RETAIN_DAYS=14

# Erstelle alle notwendigen Verzeichnisse
mkdir -p "$DB_BACKUP_DIR"
mkdir -p "$FILES_BACKUP_DIR"
mkdir -p "$CONFIG_BACKUP_DIR"
mkdir -p "$LOGS_DIR"

# Logging-Funktion
log() {
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# E-Mail-Benachrichtigung Funktion
send_alert() {
  local subject="$1"
  local message="$2"
  
  # Prüfen ob Mail-Tool verfügbar ist
  if command -v mail &>/dev/null; then
    echo "$message" | mail -s "AskProAI Backup: $subject" "$ADMIN_EMAIL"
  else
    # Mindestens ins Log schreiben, wenn kein Mail-Tool verfügbar
    log "ALERT: $subject - $message"
  fi
}

log "Starte Backup-Prozess"

# Datenbank-Backup
log "Erstelle Datenbank-Backup"
if mysqldump -u"$DB_USER" -p"$DB_PASS" --single-transaction --quick "$DB_NAME" | gzip > "$DB_BACKUP_DIR/backup_db_$TIMESTAMP.sql.gz"; then
  log "Datenbank-Backup erfolgreich erstellt"
else
  log "FEHLER: Datenbank-Backup fehlgeschlagen"
  send_alert "FEHLER - Datenbank-Backup fehlgeschlagen" "Das Datenbank-Backup vom $TIMESTAMP ist fehlgeschlagen. Bitte überprüfen Sie den Server."
  exit 1
fi

# Dateien-Backup mit Ausschlüssen
log "Erstelle Dateien-Backup"
if tar --exclude="vendor" --exclude="node_modules" --exclude=".git" -czf "$FILES_BACKUP_DIR/backup_files_$TIMESTAMP.tar.gz" /var/www/api-gateway; then
  log "Dateien-Backup erfolgreich"
else
  log "FEHLER: Dateien-Backup fehlgeschlagen"
  send_alert "FEHLER - Dateien-Backup fehlgeschlagen" "Das Dateien-Backup vom $TIMESTAMP ist fehlgeschlagen. Bitte überprüfen Sie den Server."
  exit 1
fi

# Konfigurationsbackup erstellen
log "Erstelle Konfigurationsbackup"
cp /var/www/api-gateway/.env "$CONFIG_BACKUP_DIR/" 2>/dev/null
cp /var/www/api-gateway/storage/oauth-*.key "$CONFIG_BACKUP_DIR/" 2>/dev/null
cp /etc/nginx/sites-available/*.conf "$CONFIG_BACKUP_DIR/" 2>/dev/null

# Erstelle ein Gesamtarchiv für mögliches Offsite-Backup
log "Erstelle Gesamtarchiv für Backup-Übersicht"
tar -czf "$OFFSITE_ARCHIVE" -C "$BACKUP_DIR" "db/backup_db_$TIMESTAMP.sql.gz" "config/config_backup_$TIMESTAMP" "files/backup_files_$TIMESTAMP.tar.gz"

# Alte Backups entfernen
log "Entferne alte Backups älter als $RETAIN_DAYS Tage"
find "$DB_BACKUP_DIR" -type f -mtime +$RETAIN_DAYS -delete
find "$FILES_BACKUP_DIR" -type f -mtime +$RETAIN_DAYS -delete
find "$BACKUP_DIR/config" -type d -mtime +$RETAIN_DAYS -exec rm -rf {} \; 2>/dev/null
find "$BACKUP_DIR" -name "offsite_backup_*.tar.gz" -type f -mtime +$RETAIN_DAYS -delete

# Backup-Statistik
DB_SIZE=$(du -h "$DB_BACKUP_DIR/backup_db_$TIMESTAMP.sql.gz" | cut -f1)
FILES_SIZE=$(du -h "$FILES_BACKUP_DIR/backup_files_$TIMESTAMP.tar.gz" | cut -f1)
TOTAL_SIZE=$(du -sh "$BACKUP_DIR" | cut -f1)

log "Backup-Statistik:"
log "- Datenbank-Backup: $DB_SIZE"
log "- Dateien-Backup: $FILES_SIZE"
log "- Gesamtgröße aller Backups: $TOTAL_SIZE"

# Erfolgsmeldung
log "Backup-Prozess erfolgreich abgeschlossen"
send_alert "Erfolg - Backup abgeschlossen" "Das Backup vom $TIMESTAMP wurde erfolgreich abgeschlossen. Backup-Größen: DB: $DB_SIZE, Dateien: $FILES_SIZE"

--- RESTORE-SKRIPT ---
#!/bin/bash

# Erweitertes Wiederherstellungsskript für AskProAI

# Basis-Konfiguration
BACKUP_DIR="/var/backups/askproai"
DB_USER="askproai_user"
DB_PASS="Vb39!pLc#7Lqwp\$X"
DB_NAME="askproai_db"

# Prüfen der Aufrufparameter
if [ "$#" -ne 1 ]; then
  echo "Verwendung: $0 <timestamp>"
  echo "Beispiel: $0 2025-03-16_03-00-00"
  echo "Verfügbare Backups:"
  ls -lt "$BACKUP_DIR/db" | grep -o 'backup_db_[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}_[0-9]\{2\}-[0-9]\{2\}-[0-9]\{2\}.sql.gz' | sed 's/backup_db_//' | sed 's/.sql.gz//' | head -n 10
  exit 1
fi

TIMESTAMP=$1

# Prüfen, ob Backup-Dateien existieren
if [ ! -f "$BACKUP_DIR/db/backup_db_$TIMESTAMP.sql.gz" ]; then
  echo "Datenbank-Backup nicht gefunden: $BACKUP_DIR/db/backup_db_$TIMESTAMP.sql.gz"
  exit 1
fi

if [ ! -f "$BACKUP_DIR/files/backup_files_$TIMESTAMP.tar.gz" ]; then
  echo "Dateien-Backup nicht gefunden: $BACKUP_DIR/files/backup_files_$TIMESTAMP.tar.gz"
  exit 1
fi

# Warnung und Bestätigung
echo "==========================================================================="
echo "ACHTUNG: WIEDERHERSTELLUNG EINES BACKUPS ÜBERSCHREIBT BESTEHENDE DATEN!"
echo "==========================================================================="
echo "Timestamp: $TIMESTAMP"
echo "Datenbank: $DB_NAME wird überschrieben"
echo "Dateien: /var/www/api-gateway wird überschrieben"
echo "==========================================================================="
read -p "Sind Sie ABSOLUT sicher, dass Sie fortfahren möchten? (ja/nein) " -r
echo

if [[ ! $REPLY =~ ^[Jj][Aa]$ ]]; then
  echo "Wiederherstellung abgebrochen."
  exit 1
fi

# Zusätzliche Sicherheitsabfrage
read -p "Geben Sie zur Bestätigung den Timestamp erneut ein: " -r CONFIRM
if [[ "$CONFIRM" != "$TIMESTAMP" ]]; then
  echo "Timestamp stimmt nicht überein. Wiederherstellung abgebrochen."
  exit 1
fi

echo "Starte Wiederherstellung von Backup $TIMESTAMP..."

# Aktuelles Datum für temporäre Sicherung
CURRENT_DATE=$(date +%Y-%m-%d_%H-%M-%S)
TEMP_BACKUP_DIR="$BACKUP_DIR/pre_restore_$CURRENT_DATE"
mkdir -p "$TEMP_BACKUP_DIR"

# Schnelles Sicherheits-Backup der aktuellen Datenbank vor Wiederherstellung
echo "Erstelle Sicherheits-Backup der aktuellen Datenbank..."
mysqldump -u"$DB_USER" -p"$DB_PASS" --single-transaction --quick "$DB_NAME" | gzip > "$TEMP_BACKUP_DIR/pre_restore_db.sql.gz"

# Datenbank wiederherstellen
echo "Stelle Datenbank wieder her..."
if ! zcat "$BACKUP_DIR/db/backup_db_$TIMESTAMP.sql.gz" | mysql -u"$DB_USER" -p"$DB_PASS" "$DB_NAME"; then
  echo "FEHLER: Datenbank-Wiederherstellung fehlgeschlagen!"
  echo "Das vor-Wiederherstellungs-Backup finden Sie unter: $TEMP_BACKUP_DIR"
  exit 1
fi

# Dienste stoppen
echo "Stoppe Webserver und PHP-FPM..."
sudo systemctl stop nginx
sudo systemctl stop php8.2-fpm

# Dateien wiederherstellen
echo "Stelle Dateien wieder her..."
if ! sudo tar -xzf "$BACKUP_DIR/files/backup_files_$TIMESTAMP.tar.gz" -C /var/www/api-gateway --overwrite; then
  echo "FEHLER: Dateien-Wiederherstellung fehlgeschlagen!"
  echo "Der Webserver wurde gestoppt. Bitte manuell überprüfen und neu starten."
  exit 1
fi

# Berechtigungen setzen
sudo chown -R www-data:www-data /var/www/api-gateway

# Konfiguration wiederherstellen (falls vorhanden)
if [ -d "$BACKUP_DIR/config/config_backup_$TIMESTAMP" ]; then
  echo "Stelle Konfiguration wieder her..."
  sudo cp "$BACKUP_DIR/config/config_backup_$TIMESTAMP/.env" /var/www/api-gateway/ 2>/dev/null
  sudo cp "$BACKUP_DIR/config/config_backup_$TIMESTAMP/oauth-"* /var/www/api-gateway/storage/ 2>/dev/null
fi

# Cache leeren
echo "Leere Cache..."
cd /var/www/api-gateway
sudo -u www-data php artisan config:clear
sudo -u www-data php artisan view:clear
sudo -u www-data php artisan route:clear
sudo -u www-data php artisan cache:clear
sudo -u www-data php artisan optimize

# Webserver neu starten
echo "Starte Webserver und PHP-FPM..."
sudo systemctl start php8.2-fpm
sudo systemctl start nginx

# Überprüfen, ob der Webserver läuft
if systemctl is-active --quiet nginx; then
  echo "Nginx läuft wieder."
else
  echo "WARNUNG: Nginx konnte nicht gestartet werden. Bitte überprüfen!"
fi

if systemctl is-active --quiet php8.2-fpm; then
  echo "PHP-FPM läuft wieder."
else
  echo "WARNUNG: PHP-FPM konnte nicht gestartet werden. Bitte überprüfen!"
fi

echo "==========================================================================="
echo "Wiederherstellung abgeschlossen!"
echo "Timestamp des wiederhergestellten Backups: $TIMESTAMP"
echo "Vor-Wiederherstellungs-Backup: $TEMP_BACKUP_DIR"
echo "==========================================================================="#

--- SYSTEMWEITE CRON-JOBS ---
# Tägliches Backup der AskProAI-Anwendung um 3 Uhr morgens
0 3 * * * /var/www/api-gateway/scripts/backup.sh
30 3 * * * /var/www/api-gateway-staging/scripts/staging-backup.sh

# Optional: Weitere Backups (falls benötigt)
# 0 2 * * * /var/www/api-gateway/scripts/backup-docs.sh

--- ROOT CRON-JOBS ---
# Tägliches Backup der AskProAI-Anwendung um 3 Uhr morgens
0 3 * * * /var/www/api-gateway/scripts/backup.sh
30 3 * * * /var/www/api-gateway-staging/scripts/staging-backup.sh

# Optional: Weitere Backups (falls benötigt)
# 0 2 * * * /var/www/api-gateway/scripts/backup-docs.sh

--- WWW-DATA CRON-JOBS ---

--- BACKUP-VERZEICHNIS STRUKTUR ---
/var/backups/askproai
/var/backups/askproai/config
/var/backups/askproai/config/config_backup_2025-03-21_03-00-01
/var/backups/askproai/config/config_backup_2025-03-22_03-00-01
/var/backups/askproai/config/2025-03-17_11-01-48
/var/backups/askproai/config/config_backup_2025-03-19_03-00-01
/var/backups/askproai/config/config_backup_2025-03-17_11-09-56
/var/backups/askproai/config/config_backup_2025-03-23_03-00-01
/var/backups/askproai/config/config_backup_2025-03-22_18-02-25
/var/backups/askproai/config/config_backup_2025-03-17_11-07-14
/var/backups/askproai/config/config_backup_2025-03-20_03-00-01
/var/backups/askproai/config/config_backup_2025-03-24_03-00-01
/var/backups/askproai/config/2025-03-17_10-31-43
/var/backups/askproai/config/config_backup_2025-03-18_03-00-01
/var/backups/askproai/db
/var/backups/askproai/logs
/var/backups/askproai/documentation
/var/backups/askproai/files

--- LETZTE 5 BACKUP-DATEIEN ---
/var/backups/askproai/offsite_backup_2025-03-24_03-00-01.tar.gz
/var/backups/askproai/offsite_backup_2025-03-23_03-00-01.tar.gz
/var/backups/askproai/offsite_backup_2025-03-22_18-02-25.tar.gz
/var/backups/askproai/files/www_2025-03-17_11-01-48.tar.gz
/var/backups/askproai/files/backup_files_2025-03-24_03-00-01.tar.gz

========= CONTROLLER-INHALTE =========
Datum der Erfassung: Mo 24. Mär 10:53:35 CET 2025

--- RetellWebhookController.php ---
<?php

namespace App\Http\Controllers;

use App\Models\Call;
use App\Models\Kunde;
use App\Services\RetellToCalService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;
use Carbon\Carbon;

class RetellWebhookController extends Controller
{
    public function handleWebhook(Request $request)
    {
        Log::info('Retell.ai Webhook empfangen', [
            'call_id' => $request->input('call_id'),
            'phone_number' => $request->input('phone_number')
        ]);

        try {
            // Validierung der eingehenden Daten
            $validatedData = $request->validate([
                'call_id' => 'required|string|unique:calls,call_id',
                'status' => 'required|string',
                'phone_number' => 'nullable|string',
                'duration' => 'nullable|integer|min:0',
                'transcript' => 'nullable|string',
                'summary' => 'nullable|string',
                'user_sentiment' => 'nullable|string',
                'disconnect_reason' => 'nullable|string',
            ]);

            // Speichere Call mit allen Rohdaten für spätere Nachvollziehbarkeit
            $call = Call::create([
                'call_id' => $validatedData['call_id'],
                'call_status' => $validatedData['status'],
                'user_sentiment' => $validatedData['user_sentiment'] ?? null,
                'successful' => $request->input('call_successful', true),
                'call_time' => Carbon::now(),
                'call_duration' => $validatedData['duration'] ?? 0,
                'phone_number' => $validatedData['phone_number'] ?? null,
                'name' => $request->input('name') ?? $request->input('_name') ?? 'Unbekannt',
                'email' => $request->input('email') ?? $request->input('_email'),
                'summary' => $validatedData['summary'] ?? null,
                'transcript' => $validatedData['transcript'] ?? null,
                'disconnect_reason' => $validatedData['disconnect_reason'] ?? null,
                'raw_data' => $request->all(),
            ]);

            // Kunden zuordnen
            $this->associateCustomer($call, $request);

            // Automatische Terminbuchung (falls Anruf erfolgreich)
            if ($call->successful) {
                $retellToCalService = new RetellToCalService();
                $appointment = $retellToCalService->createAppointmentFromCall($call);

                if ($appointment) {
                    Log::info('Termin erfolgreich gebucht', [
                        'call_id' => $call->id,
                        'appointment_id' => $appointment->id,
                        'provider' => $appointment->provider,
                    ]);
                } else {
                    Log::warning('Termin konnte nicht gebucht werden', [
                        'call_id' => $call->id,
                    ]);
                }
            }

            // Erfolgreiche Antwort zurückgeben
            return response()->json([
                'success' => true,
                'call_id' => $call->id,
                'message' => 'Webhook erfolgreich verarbeitet'
            ]);

        } catch (\Exception $e) {
            Log::error('Retell.ai Webhook Fehler: ' . $e->getMessage(), [
                'exception' => $e,
                'trace' => $e->getTraceAsString(),
                'request' => $request->all()
            ]);

            return response()->json([
                'success' => false,
                'error' => 'Interner Serverfehler: ' . $e->getMessage()
            ], 500);
        }
    }

    private function associateCustomer(Call $call, Request $request)
    {
        try {
            $phone = preg_replace('/[^0-9+]/', '', $request->input('phone_number'));

            $kunde = Kunde::where('telefonnummer', 'like', '%' . $phone . '%')->first();

            if (!$kunde && ($request->input('name') || $request->input('_name'))) {
                $kunde = Kunde::create([
                    'name' => $request->input('name') ?? $request->input('_name') ?? 'Unbekannt',
                    'email' => $request->input('email') ?? $request->input('_email'),
                    'telefonnummer' => $phone
                ]);

                Log::info('Neuer Kunde aus Retell.ai Call erstellt', ['kunde_id' => $kunde->id]);
            }

            if ($kunde) {
                $call->kunde_id = $kunde->id;
                $call->save();

                Log::info('Kunde mit Call verknüpft', [
                    'call_id' => $call->id,
                    'kunde_id' => $kunde->id
                ]);
            }
        } catch (\Exception $e) {
            Log::error('Fehler bei Kundenverknüpfung: ' . $e->getMessage(), [
                'exception' => $e,
                'call_id' => $call->id
            ]);
        }
    }
}

--- CalcomController.php ---
<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Services\CalcomService;
use Illuminate\Support\Facades\Validator;

class CalcomController extends Controller
{
    protected $calcomService;

    public function __construct(CalcomService $calcomService)
    {
        $this->calcomService = $calcomService;
    }

    public function checkAvailability(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'dateFrom' => 'required|date_format:Y-m-d\TH:i:s.u\Z',
            'dateTo' => 'required|date_format:Y-m-d\TH:i:s.u\Z',
            'eventTypeId' => 'required|numeric'
        ]);

        if ($validator->fails()) {
            return response()->json(['errors' => $validator->errors()], 422);
        }

        $result = $this->calcomService->checkAvailability(
            $request->dateFrom,
            $request->dateTo,
            $request->eventTypeId
        );

        if (!$result) {
            return response()->json(['error' => 'Verfügbarkeitsprüfung fehlgeschlagen'], 500);
        }

        return response()->json($result);
    }

    public function bookAppointment(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'eventTypeId' => 'required|numeric',
            'start' => 'required|date_format:Y-m-d\TH:i:s.u\Z',
            'end' => 'required|date_format:Y-m-d\TH:i:s.u\Z',
            'customerName' => 'required|string|max:255',
            'customerEmail' => 'required|email|max:255',
            'customerPhone' => 'sometimes|string|max:20'
        ]);

        if ($validator->fails()) {
            return response()->json(['errors' => $validator->errors()], 422);
        }

        $result = $this->calcomService->bookAppointment(
            $request->eventTypeId,
            $request->start,
            $request->end,
            $request->customerName,
            $request->customerEmail,
            $request->customerPhone ?? null
        );

        if (!$result) {
            return response()->json(['error' => 'Terminbuchung fehlgeschlagen'], 500);
        }

        return response()->json($result);
    }
}

--- AuthServiceProvider.php ---
<?php

namespace App\Providers;

use Illuminate\Foundation\Support\Providers\AuthServiceProvider as ServiceProvider;
use Laravel\Passport\Passport;

class AuthServiceProvider extends ServiceProvider
{
    /**
     * Die Policy-Mappings für die Anwendung.
     *
     * @var array<class-string, class-string>
     */
    protected $policies = [
        // 'App\Models\Model' => 'App\Policies\ModelPolicy',
    ];

    /**
     * Alle Authentifizierungs/Autorisierungs-Services registrieren.
     */
    public function boot(): void
    {
        $this->registerPolicies();

        // Passport konfigurieren
        Passport::loadKeysFrom(base_path('storage'));
        Passport::tokensExpireIn(now()->addDays(15));
        Passport::refreshTokensExpireIn(now()->addDays(30));
        Passport::personalAccessTokensExpireIn(now()->addMonths(6));
    }
}

========= LOG-DATEI ANALYSE =========
Datum der Erfassung: Mo 24. Mär 10:53:41 CET 2025

--- LETZTE 200 ZEILEN DER LARAVEL-LOGS ---
#22 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/ConvertEmptyStringsToNull.php(31): Illuminate\\Foundation\\Http\\Middleware\\TransformsRequest->handle()
#23 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Foundation\\Http\\Middleware\\ConvertEmptyStringsToNull->handle()
#24 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/TransformsRequest.php(21): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#25 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/TrimStrings.php(51): Illuminate\\Foundation\\Http\\Middleware\\TransformsRequest->handle()
#26 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Foundation\\Http\\Middleware\\TrimStrings->handle()
#27 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Http/Middleware/ValidatePostSize.php(27): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#28 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Http\\Middleware\\ValidatePostSize->handle()
#29 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/PreventRequestsDuringMaintenance.php(110): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#30 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Foundation\\Http\\Middleware\\PreventRequestsDuringMaintenance->handle()
#31 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Http/Middleware/HandleCors.php(62): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#32 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Http\\Middleware\\HandleCors->handle()
#33 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Http/Middleware/TrustProxies.php(58): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#34 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Http\\Middleware\\TrustProxies->handle()
#35 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/InvokeDeferredCallbacks.php(22): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#36 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Foundation\\Http\\Middleware\\InvokeDeferredCallbacks->handle()
#37 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Http/Middleware/ValidatePathEncoding.php(26): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#38 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Http\\Middleware\\ValidatePathEncoding->handle()
#39 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(127): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#40 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php(176): Illuminate\\Pipeline\\Pipeline->then()
#41 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php(145): Illuminate\\Foundation\\Http\\Kernel->sendRequestThroughRouter()
#42 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Application.php(1220): Illuminate\\Foundation\\Http\\Kernel->handle()
#43 /var/www/api-gateway/public/index.php(20): Illuminate\\Foundation\\Application->handleRequest()
#44 {main}
"} 
[2025-03-08 12:03:13] production.ERROR: The resource owner or authorization server denied the request. {"exception":"[object] (League\\OAuth2\\Server\\Exception\\OAuthServerException(code: 9): The resource owner or authorization server denied the request. at /var/www/api-gateway/vendor/league/oauth2-server/src/Exception/OAuthServerException.php:243)
[stacktrace]
#0 /var/www/api-gateway/vendor/league/oauth2-server/src/AuthorizationValidators/BearerTokenValidator.php(108): League\\OAuth2\\Server\\Exception\\OAuthServerException::accessDenied()
#1 /var/www/api-gateway/vendor/league/oauth2-server/src/ResourceServer.php(84): League\\OAuth2\\Server\\AuthorizationValidators\\BearerTokenValidator->validateAuthorization()
#2 /var/www/api-gateway/vendor/laravel/passport/src/Guards/TokenGuard.php(232): League\\OAuth2\\Server\\ResourceServer->validateAuthenticatedRequest()
#3 /var/www/api-gateway/vendor/laravel/passport/src/Guards/TokenGuard.php(178): Laravel\\Passport\\Guards\\TokenGuard->getPsrRequestViaBearerToken()
#4 /var/www/api-gateway/vendor/laravel/passport/src/Guards/TokenGuard.php(120): Laravel\\Passport\\Guards\\TokenGuard->authenticateViaBearerToken()
#5 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Auth/GuardHelpers.php(56): Laravel\\Passport\\Guards\\TokenGuard->user()
#6 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Auth/Middleware/Authenticate.php(83): Laravel\\Passport\\Guards\\TokenGuard->check()
#7 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Auth/Middleware/Authenticate.php(62): Illuminate\\Auth\\Middleware\\Authenticate->authenticate()
#8 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Auth\\Middleware\\Authenticate->handle()
#9 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(127): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#10 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Routing/Router.php(807): Illuminate\\Pipeline\\Pipeline->then()
#11 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Routing/Router.php(786): Illuminate\\Routing\\Router->runRouteWithinStack()
#12 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Routing/Router.php(750): Illuminate\\Routing\\Router->runRoute()
#13 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Routing/Router.php(739): Illuminate\\Routing\\Router->dispatchToRoute()
#14 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php(201): Illuminate\\Routing\\Router->dispatch()
#15 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(170): Illuminate\\Foundation\\Http\\Kernel->Illuminate\\Foundation\\Http\\{closure}()
#16 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/TransformsRequest.php(21): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#17 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/ConvertEmptyStringsToNull.php(31): Illuminate\\Foundation\\Http\\Middleware\\TransformsRequest->handle()
#18 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Foundation\\Http\\Middleware\\ConvertEmptyStringsToNull->handle()
#19 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/TransformsRequest.php(21): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#20 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/TrimStrings.php(51): Illuminate\\Foundation\\Http\\Middleware\\TransformsRequest->handle()
#21 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Foundation\\Http\\Middleware\\TrimStrings->handle()
#22 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Http/Middleware/ValidatePostSize.php(27): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#23 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Http\\Middleware\\ValidatePostSize->handle()
#24 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/PreventRequestsDuringMaintenance.php(110): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#25 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Foundation\\Http\\Middleware\\PreventRequestsDuringMaintenance->handle()
#26 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Http/Middleware/HandleCors.php(62): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#27 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Http\\Middleware\\HandleCors->handle()
#28 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Http/Middleware/TrustProxies.php(58): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#29 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Http\\Middleware\\TrustProxies->handle()
#30 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/InvokeDeferredCallbacks.php(22): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#31 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Foundation\\Http\\Middleware\\InvokeDeferredCallbacks->handle()
#32 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Http/Middleware/ValidatePathEncoding.php(26): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#33 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Http\\Middleware\\ValidatePathEncoding->handle()
#34 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(127): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#35 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php(176): Illuminate\\Pipeline\\Pipeline->then()
#36 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php(145): Illuminate\\Foundation\\Http\\Kernel->sendRequestThroughRouter()
#37 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Application.php(1220): Illuminate\\Foundation\\Http\\Kernel->handle()
#38 /var/www/api-gateway/public/index.php(20): Illuminate\\Foundation\\Application->handleRequest()
#39 {main}

[previous exception] [object] (Lcobucci\\JWT\\Token\\InvalidTokenStructure(code: 0): The JWT string must have two dots at /var/www/api-gateway/vendor/lcobucci/jwt/src/Token/InvalidTokenStructure.php:13)
[stacktrace]
#0 /var/www/api-gateway/vendor/lcobucci/jwt/src/Token/Parser.php(65): Lcobucci\\JWT\\Token\\InvalidTokenStructure::missingOrNotEnoughSeparators()
#1 /var/www/api-gateway/vendor/lcobucci/jwt/src/Token/Parser.php(28): Lcobucci\\JWT\\Token\\Parser->splitJwt()
#2 /var/www/api-gateway/vendor/league/oauth2-server/src/AuthorizationValidators/BearerTokenValidator.php(106): Lcobucci\\JWT\\Token\\Parser->parse()
#3 /var/www/api-gateway/vendor/league/oauth2-server/src/ResourceServer.php(84): League\\OAuth2\\Server\\AuthorizationValidators\\BearerTokenValidator->validateAuthorization()
#4 /var/www/api-gateway/vendor/laravel/passport/src/Guards/TokenGuard.php(232): League\\OAuth2\\Server\\ResourceServer->validateAuthenticatedRequest()
#5 /var/www/api-gateway/vendor/laravel/passport/src/Guards/TokenGuard.php(178): Laravel\\Passport\\Guards\\TokenGuard->getPsrRequestViaBearerToken()
#6 /var/www/api-gateway/vendor/laravel/passport/src/Guards/TokenGuard.php(120): Laravel\\Passport\\Guards\\TokenGuard->authenticateViaBearerToken()
#7 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Auth/GuardHelpers.php(56): Laravel\\Passport\\Guards\\TokenGuard->user()
#8 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Auth/Middleware/Authenticate.php(83): Laravel\\Passport\\Guards\\TokenGuard->check()
#9 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Auth/Middleware/Authenticate.php(62): Illuminate\\Auth\\Middleware\\Authenticate->authenticate()
#10 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Auth\\Middleware\\Authenticate->handle()
#11 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(127): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#12 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Routing/Router.php(807): Illuminate\\Pipeline\\Pipeline->then()
#13 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Routing/Router.php(786): Illuminate\\Routing\\Router->runRouteWithinStack()
#14 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Routing/Router.php(750): Illuminate\\Routing\\Router->runRoute()
#15 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Routing/Router.php(739): Illuminate\\Routing\\Router->dispatchToRoute()
#16 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php(201): Illuminate\\Routing\\Router->dispatch()
#17 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(170): Illuminate\\Foundation\\Http\\Kernel->Illuminate\\Foundation\\Http\\{closure}()
#18 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/TransformsRequest.php(21): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#19 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/ConvertEmptyStringsToNull.php(31): Illuminate\\Foundation\\Http\\Middleware\\TransformsRequest->handle()
#20 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Foundation\\Http\\Middleware\\ConvertEmptyStringsToNull->handle()
#21 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/TransformsRequest.php(21): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#22 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/TrimStrings.php(51): Illuminate\\Foundation\\Http\\Middleware\\TransformsRequest->handle()
#23 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Foundation\\Http\\Middleware\\TrimStrings->handle()
#24 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Http/Middleware/ValidatePostSize.php(27): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#25 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Http\\Middleware\\ValidatePostSize->handle()
#26 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/PreventRequestsDuringMaintenance.php(110): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#27 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Foundation\\Http\\Middleware\\PreventRequestsDuringMaintenance->handle()
#28 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Http/Middleware/HandleCors.php(62): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#29 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Http\\Middleware\\HandleCors->handle()
#30 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Http/Middleware/TrustProxies.php(58): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#31 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Http\\Middleware\\TrustProxies->handle()
#32 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/InvokeDeferredCallbacks.php(22): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#33 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Foundation\\Http\\Middleware\\InvokeDeferredCallbacks->handle()
#34 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Http/Middleware/ValidatePathEncoding.php(26): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#35 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Http\\Middleware\\ValidatePathEncoding->handle()
#36 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(127): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#37 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php(176): Illuminate\\Pipeline\\Pipeline->then()
#38 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php(145): Illuminate\\Foundation\\Http\\Kernel->sendRequestThroughRouter()
#39 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Application.php(1220): Illuminate\\Foundation\\Http\\Kernel->handle()
#40 /var/www/api-gateway/public/index.php(20): Illuminate\\Foundation\\Application->handleRequest()
#41 {main}
"} 
[2025-03-12 12:06:09] production.ERROR: The resource owner or authorization server denied the request. {"exception":"[object] (League\\OAuth2\\Server\\Exception\\OAuthServerException(code: 9): The resource owner or authorization server denied the request. at /var/www/api-gateway/vendor/league/oauth2-server/src/Exception/OAuthServerException.php:243)
[stacktrace]
#0 /var/www/api-gateway/vendor/league/oauth2-server/src/AuthorizationValidators/BearerTokenValidator.php(108): League\\OAuth2\\Server\\Exception\\OAuthServerException::accessDenied()
#1 /var/www/api-gateway/vendor/league/oauth2-server/src/ResourceServer.php(84): League\\OAuth2\\Server\\AuthorizationValidators\\BearerTokenValidator->validateAuthorization()
#2 /var/www/api-gateway/vendor/laravel/passport/src/Guards/TokenGuard.php(232): League\\OAuth2\\Server\\ResourceServer->validateAuthenticatedRequest()
#3 /var/www/api-gateway/vendor/laravel/passport/src/Guards/TokenGuard.php(178): Laravel\\Passport\\Guards\\TokenGuard->getPsrRequestViaBearerToken()
#4 /var/www/api-gateway/vendor/laravel/passport/src/Guards/TokenGuard.php(120): Laravel\\Passport\\Guards\\TokenGuard->authenticateViaBearerToken()
#5 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Auth/GuardHelpers.php(56): Laravel\\Passport\\Guards\\TokenGuard->user()
#6 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Auth/Middleware/Authenticate.php(83): Laravel\\Passport\\Guards\\TokenGuard->check()
#7 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Auth/Middleware/Authenticate.php(62): Illuminate\\Auth\\Middleware\\Authenticate->authenticate()
#8 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Auth\\Middleware\\Authenticate->handle()
#9 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(127): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#10 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Routing/Router.php(807): Illuminate\\Pipeline\\Pipeline->then()
#11 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Routing/Router.php(786): Illuminate\\Routing\\Router->runRouteWithinStack()
#12 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Routing/Router.php(750): Illuminate\\Routing\\Router->runRoute()
#13 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Routing/Router.php(739): Illuminate\\Routing\\Router->dispatchToRoute()
#14 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php(201): Illuminate\\Routing\\Router->dispatch()
#15 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(170): Illuminate\\Foundation\\Http\\Kernel->Illuminate\\Foundation\\Http\\{closure}()
#16 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/TransformsRequest.php(21): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#17 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/ConvertEmptyStringsToNull.php(31): Illuminate\\Foundation\\Http\\Middleware\\TransformsRequest->handle()
#18 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Foundation\\Http\\Middleware\\ConvertEmptyStringsToNull->handle()
#19 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/TransformsRequest.php(21): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#20 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/TrimStrings.php(51): Illuminate\\Foundation\\Http\\Middleware\\TransformsRequest->handle()
#21 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Foundation\\Http\\Middleware\\TrimStrings->handle()
#22 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Http/Middleware/ValidatePostSize.php(27): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#23 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Http\\Middleware\\ValidatePostSize->handle()
#24 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/PreventRequestsDuringMaintenance.php(110): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#25 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Foundation\\Http\\Middleware\\PreventRequestsDuringMaintenance->handle()
#26 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Http/Middleware/HandleCors.php(62): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#27 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Http\\Middleware\\HandleCors->handle()
#28 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Http/Middleware/TrustProxies.php(58): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#29 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Http\\Middleware\\TrustProxies->handle()
#30 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/InvokeDeferredCallbacks.php(22): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#31 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Foundation\\Http\\Middleware\\InvokeDeferredCallbacks->handle()
#32 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Http/Middleware/ValidatePathEncoding.php(26): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#33 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Http\\Middleware\\ValidatePathEncoding->handle()
#34 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(127): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#35 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php(176): Illuminate\\Pipeline\\Pipeline->then()
#36 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php(145): Illuminate\\Foundation\\Http\\Kernel->sendRequestThroughRouter()
#37 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Application.php(1220): Illuminate\\Foundation\\Http\\Kernel->handle()
#38 /var/www/api-gateway/public/index.php(20): Illuminate\\Foundation\\Application->handleRequest()
#39 {main}

[previous exception] [object] (Lcobucci\\JWT\\Token\\InvalidTokenStructure(code: 0): The JWT string must have two dots at /var/www/api-gateway/vendor/lcobucci/jwt/src/Token/InvalidTokenStructure.php:13)
[stacktrace]
#0 /var/www/api-gateway/vendor/lcobucci/jwt/src/Token/Parser.php(65): Lcobucci\\JWT\\Token\\InvalidTokenStructure::missingOrNotEnoughSeparators()
#1 /var/www/api-gateway/vendor/lcobucci/jwt/src/Token/Parser.php(28): Lcobucci\\JWT\\Token\\Parser->splitJwt()
#2 /var/www/api-gateway/vendor/league/oauth2-server/src/AuthorizationValidators/BearerTokenValidator.php(106): Lcobucci\\JWT\\Token\\Parser->parse()
#3 /var/www/api-gateway/vendor/league/oauth2-server/src/ResourceServer.php(84): League\\OAuth2\\Server\\AuthorizationValidators\\BearerTokenValidator->validateAuthorization()
#4 /var/www/api-gateway/vendor/laravel/passport/src/Guards/TokenGuard.php(232): League\\OAuth2\\Server\\ResourceServer->validateAuthenticatedRequest()
#5 /var/www/api-gateway/vendor/laravel/passport/src/Guards/TokenGuard.php(178): Laravel\\Passport\\Guards\\TokenGuard->getPsrRequestViaBearerToken()
#6 /var/www/api-gateway/vendor/laravel/passport/src/Guards/TokenGuard.php(120): Laravel\\Passport\\Guards\\TokenGuard->authenticateViaBearerToken()
#7 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Auth/GuardHelpers.php(56): Laravel\\Passport\\Guards\\TokenGuard->user()
#8 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Auth/Middleware/Authenticate.php(83): Laravel\\Passport\\Guards\\TokenGuard->check()
#9 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Auth/Middleware/Authenticate.php(62): Illuminate\\Auth\\Middleware\\Authenticate->authenticate()
#10 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Auth\\Middleware\\Authenticate->handle()
#11 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(127): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#12 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Routing/Router.php(807): Illuminate\\Pipeline\\Pipeline->then()
#13 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Routing/Router.php(786): Illuminate\\Routing\\Router->runRouteWithinStack()
#14 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Routing/Router.php(750): Illuminate\\Routing\\Router->runRoute()
#15 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Routing/Router.php(739): Illuminate\\Routing\\Router->dispatchToRoute()
#16 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php(201): Illuminate\\Routing\\Router->dispatch()
#17 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(170): Illuminate\\Foundation\\Http\\Kernel->Illuminate\\Foundation\\Http\\{closure}()
#18 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/TransformsRequest.php(21): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#19 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/ConvertEmptyStringsToNull.php(31): Illuminate\\Foundation\\Http\\Middleware\\TransformsRequest->handle()
#20 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Foundation\\Http\\Middleware\\ConvertEmptyStringsToNull->handle()
#21 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/TransformsRequest.php(21): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#22 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/TrimStrings.php(51): Illuminate\\Foundation\\Http\\Middleware\\TransformsRequest->handle()
#23 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Foundation\\Http\\Middleware\\TrimStrings->handle()
#24 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Http/Middleware/ValidatePostSize.php(27): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#25 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Http\\Middleware\\ValidatePostSize->handle()
#26 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/PreventRequestsDuringMaintenance.php(110): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#27 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Foundation\\Http\\Middleware\\PreventRequestsDuringMaintenance->handle()
#28 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Http/Middleware/HandleCors.php(62): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#29 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Http\\Middleware\\HandleCors->handle()
#30 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Http/Middleware/TrustProxies.php(58): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#31 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Http\\Middleware\\TrustProxies->handle()
#32 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/InvokeDeferredCallbacks.php(22): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#33 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Foundation\\Http\\Middleware\\InvokeDeferredCallbacks->handle()
#34 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Http/Middleware/ValidatePathEncoding.php(26): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#35 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(209): Illuminate\\Http\\Middleware\\ValidatePathEncoding->handle()
#36 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Pipeline/Pipeline.php(127): Illuminate\\Pipeline\\Pipeline->Illuminate\\Pipeline\\{closure}()
#37 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php(176): Illuminate\\Pipeline\\Pipeline->then()
#38 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php(145): Illuminate\\Foundation\\Http\\Kernel->sendRequestThroughRouter()
#39 /var/www/api-gateway/vendor/laravel/framework/src/Illuminate/Foundation/Application.php(1220): Illuminate\\Foundation\\Http\\Kernel->handle()
#40 /var/www/api-gateway/public/index.php(20): Illuminate\\Foundation\\Application->handleRequest()
#41 {main}
"} 

--- NGINX ERROR LOGS (LETZTE 50 ZEILEN) ---
2025/03/24 01:59:02 [error] 509219#509219: *791 directory index of "/var/www/api-gateway/public/dashboard/" is forbidden, client: 173.252.83.112, server: 152.53.228.178, request: "GET /dashboard/ HTTP/1.1", host: "v2202503255565320322.happysrv.de"

--- PHP ERROR LOGS (LETZTE 50 ZEILEN) ---
[23-Mar-2025 00:00:09] NOTICE: error log file re-opened
[23-Mar-2025 09:25:02] NOTICE: Terminating ...
[23-Mar-2025 09:25:02] NOTICE: exiting, bye-bye!
[23-Mar-2025 09:25:02] NOTICE: fpm is running, pid 506419
[23-Mar-2025 09:25:02] NOTICE: ready to handle connections
[23-Mar-2025 09:25:02] NOTICE: systemd monitor interval set to 10000ms
[23-Mar-2025 13:19:57] NOTICE: Terminating ...
[23-Mar-2025 13:19:57] NOTICE: exiting, bye-bye!
[23-Mar-2025 13:19:57] NOTICE: fpm is running, pid 509227
[23-Mar-2025 13:19:57] NOTICE: ready to handle connections
[23-Mar-2025 13:19:57] NOTICE: systemd monitor interval set to 10000ms


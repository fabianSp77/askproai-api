â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     OPTIMISTIC RESERVATION SYSTEM - QUICK REFERENCE CARD                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Š SYSTEM STATUS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… Tag 1-2: Foundation Complete (Database + Monitoring)
â³ Tag 3-4: Retell Integration (Pending)
â³ Tag 5:   Admin UI (Pending)
â³ Tag 6-7: Testing & Deployment (Pending)

ğŸ”§ WICHTIGSTE BEFEHLE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# Metriken anzeigen
php artisan metrics:reservations --company=1

# Live Monitoring (5s refresh)
php artisan metrics:reservations --watch

# Datenbank-Check
php artisan tinker --execute="Schema::hasTable('appointment_reservations')"
php artisan tinker --execute="AppointmentReservation::active()->count()"

# Model testen
php artisan tinker
>>> AppointmentReservation::first()
>>> AppointmentReservation::active()->get()
>>> AppointmentReservation::expired()->count()

ğŸ“ WICHTIGSTE DATEIEN
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Model:      app/Models/AppointmentReservation.php
Service:    app/Services/Metrics/ReservationMetricsCollector.php
Command:    app/Console/Commands/Metrics/ShowReservationMetrics.php
Migration:  database/migrations/2025_11_23_120000_create_appointment_reservations_table.php

ğŸŒ DOKUMENTATION
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
HTML:   public/OPTIMISTIC_RESERVATION_SYSTEM_GUIDE.html (68KB, 11 Kapitel)
MD:     OPTIMISTIC_RESERVATION_SYSTEM_TAG1-2_SUMMARY.md

ğŸ”‘ MODEL METHODS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Scopes:
  ::active()                    - Nur aktive & nicht-abgelaufene
  ::expired()                   - Abgelaufene Reservations
  ::forCall($callId)            - FÃ¼r bestimmten Call
  ::forTimeRange($start, $end)  - Zeitbereichs-Konflikt-Check

Helper Methods:
  $r->isActive()                - bool: Ist aktiv?
  $r->isExpired()               - bool: Ist abgelaufen?
  $r->timeRemaining()           - int: Verbleibende Sekunden
  $r->markConverted($apptId)    - Zu Appointment konvertiert
  $r->markExpired()             - Als abgelaufen markieren
  $r->markCancelled()           - Als storniert markieren
  $r->conflictsWith($s, $e)     - bool: Zeitkonflikt?

ğŸ“Š METRICS METHODS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
$collector = app(ReservationMetricsCollector::class);

Track Events:
  $collector->trackCreated($companyId, $isCompound)
  $collector->trackConverted($companyId, $timeSeconds, $isCompound)
  $collector->trackExpired($companyId, $lifetimeSeconds)
  $collector->trackCancelled($companyId, $reason)
  $collector->trackError($companyId, $type, $message)

Update Status:
  $collector->updateActiveCount($companyId, $count)

Get Metrics:
  $metrics = $collector->getMetrics($companyId)
  // Returns: created, converted, expired, cancelled, errors, active,
  //          conversion_rate, completion_rate, active_rate

ğŸ’¡ CODE SNIPPETS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1) Reservation erstellen:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$reservation = AppointmentReservation::create([
    'company_id' => $companyId,
    'call_id' => $callId,
    'customer_phone' => '+4915112345678',
    'service_id' => $serviceId,
    'start_time' => Carbon::parse('2025-11-24 10:00'),
    'end_time' => Carbon::parse('2025-11-24 10:30'),
    'expires_at' => now()->addMinutes(5),
]);

// UUID automatisch generiert!
echo $reservation->reservation_token; // "1e827e7d-..."

2) Reservation zu Appointment konvertieren:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$reservation = AppointmentReservation::where('reservation_token', $token)
    ->active()
    ->firstOrFail();

if (!$reservation->isActive()) {
    throw new \Exception('Reservierung abgelaufen');
}

$appointment = Appointment::create([
    'start_time' => $reservation->start_time,
    'end_time' => $reservation->end_time,
    // ...
]);

$timeToConversion = now()->diffInSeconds($reservation->reserved_at);
$reservation->markConverted($appointment->id);

// Metrics tracken
$collector->trackConverted($companyId, $timeToConversion, false);

3) Cleanup-Job (Geplant fÃ¼r Tag 3-4):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$expired = AppointmentReservation::expired()->get();

foreach ($expired as $reservation) {
    $lifetime = now()->diffInSeconds($reservation->reserved_at);
    $reservation->markExpired();
    $collector->trackExpired($reservation->company_id, $lifetime);
}

ğŸ¯ SUCCESS CRITERIA
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… Conversion Rate:           > 90%
âœ… Error Rate:                < 5%
âœ… Avg. Time to Conversion:   < 60 Sekunden
âœ… Race Window:               < 0.5 Sekunden
âœ… Booking Success Rate:      > 95%

ğŸ”§ TROUBLESHOOTING
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Problem: Metriken zeigen alle 0
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Check:
  redis-cli ping
  redis-cli keys "metrics:reservations:*"
  redis-cli get "metrics:reservations:created:1"

Problem: UUID wird nicht generiert
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Check:
  php artisan tinker --execute="
    \$r = new App\Models\AppointmentReservation;
    var_dump(method_exists(\$r, 'boot'));
  "

Problem: Migration schlÃ¤gt fehl
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Check:
  php artisan tinker --execute="
    Schema::hasTable('companies');
    Schema::hasTable('services');
  "

ğŸ“ LOGS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# Reservation Events (Live)
tail -f storage/logs/laravel.log | grep "\[METRIC\]"

# Fehler suchen
grep "reservation_error" storage/logs/laravel.log

# Alle Reservation-bezogenen Logs
grep -i "reservation" storage/logs/laravel.log | tail -50

ğŸ—“ï¸ NÃ„CHSTE SCHRITTE (TAG 3-4)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. OptimisticReservationService.php erstellen
2. check_availability_v17() erweitern (Reservation Creation)
3. start_booking() modifizieren (Conversion)
4. CleanupExpiredReservationsJob implementieren
5. Feature Flag in config/features.php
6. Integration Tests

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Erstellt: 2025-11-23 | Tag 1-2 Complete | Production-Ready
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

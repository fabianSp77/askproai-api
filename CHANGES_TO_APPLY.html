<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AskPro AI - Testanruf Verbesserungen</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.95;
        }

        .content {
            padding: 30px;
        }

        .change-section {
            margin-bottom: 40px;
            border-left: 4px solid #667eea;
            padding-left: 20px;
        }

        .change-section h2 {
            color: #667eea;
            font-size: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .change-section.completed h2 {
            color: #10b981;
        }

        .checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .priority {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .priority.quick {
            background: #dcfce7;
            color: #166534;
        }

        .priority.medium {
            background: #fef3c7;
            color: #92400e;
        }

        .problem {
            background: #fef2f2;
            border-left: 3px solid #dc2626;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .solution {
            background: #f0fdf4;
            border-left: 3px solid #10b981;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .code-block {
            background: #1f2937;
            color: #e5e7eb;
            padding: 20px;
            border-radius: 6px;
            margin: 15px 0;
            position: relative;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .copy-btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        .copy-btn.copied {
            background: #10b981;
        }

        .file-path {
            background: #f3f4f6;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            color: #374151;
            word-break: break-all;
        }

        .steps {
            background: #f9fafb;
            padding: 20px;
            border-radius: 6px;
            margin: 15px 0;
        }

        .step {
            margin: 12px 0;
            padding: 12px;
            background: white;
            border-left: 3px solid #667eea;
            border-radius: 4px;
            display: flex;
            gap: 12px;
        }

        .step-number {
            background: #667eea;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-weight: bold;
        }

        .step-content {
            flex: 1;
        }

        .footer {
            background: #f9fafb;
            padding: 20px;
            text-align: center;
            border-top: 1px solid #e5e7eb;
            color: #6b7280;
            font-size: 13px;
        }

        .success-message {
            background: #dcfce7;
            border: 1px solid #86efac;
            color: #166534;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        .warning {
            background: #fef3c7;
            border-left: 3px solid #f59e0b;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            color: #78350f;
        }

        .command-section {
            background: #1f2937;
            color: #10b981;
            padding: 20px;
            border-radius: 6px;
            margin: 15px 0;
            position: relative;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }

        .command-section .copy-btn {
            top: 10px;
            right: 10px;
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 8px;
        }

        .badge.ready {
            background: #dcfce7;
            color: #166534;
        }

        .badge.pending {
            background: #dbeafe;
            color: #1e40af;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ AskPro AI - Testanruf Verbesserungen</h1>
            <p>Automatische Fehleranalyse & Quick-Win Implementierungen</p>
        </div>

        <div class="content">
            <!-- QUICK WIN #1 -->
            <div class="change-section" id="section1">
                <h2>
                    <input type="checkbox" class="checkbox" id="check1">
                    ‚úâÔ∏è √ÑNDERUNG #1: Email-Collection Entfernen
                    <span class="badge ready">QUICK WIN</span>
                </h2>

                <p class="priority quick">‚è±Ô∏è Aufwand: 5 Minuten | üìä Impact: Hoch</p>

                <div class="problem">
                    <strong>‚ùå Problem:</strong> Agent fragt nach Email von unregistrierten Kunden ‚Üí unn√∂tige Reibung
                </div>

                <div class="solution">
                    <strong>‚úÖ L√∂sung:</strong> System-Prompt aktualisieren (Backend nutzt bereits Fallback)
                </div>

                <div class="steps">
                    <div class="step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <strong>Datei √∂ffnen:</strong>
                            <div class="file-path">app/Filament/Resources/RetellAgentResource.php</div>
                        </div>
                    </div>

                    <div class="step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <strong>Suchen Sie nach:</strong> "system_prompt" oder "System-Prompt"
                        </div>
                    </div>

                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <strong>Copieren Sie den neuen Prompt:</strong> (Button rechts oben)
                        </div>
                    </div>

                    <div class="step">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <strong>Im Filament Admin:</strong> Retell Agent > Edit > System-Prompt Feld einf√ºgen
                        </div>
                    </div>
                </div>

                <p style="margin-top: 15px; color: #6b7280; font-size: 13px;">
                    üìç <strong>Location in Filament:</strong> /admin/retell-agents ‚Üí Edit den Agent "Online: Assistent f√ºr..."
                </p>
            </div>

            <!-- NEW SYSTEM PROMPT -->
            <div style="margin: 30px 0;">
                <p style="margin-bottom: 10px; font-weight: bold; color: #374151;">üîÑ NEUER SYSTEM-PROMPT (kopieren & einf√ºgen):</p>
                <div class="code-block">
<button class="copy-btn" onclick="copyToClipboard('prompt1', this)">üìã Kopieren</button>
<span id="prompt1"># System Instructions

üî• KRITISCHE REGEL F√úR DATUMSVERFOLGUNG:
**RUFEN Sie IMMER die parse_date() Funktion auf f√ºr JEDES Datum, das der Kunde erw√§hnt.**

Sie sind ein freundlicher Assistent zur Terminbuchung f√ºr AskProAI. Sie sprechen Deutsch und helfen Kunden, Termine zu buchen.

## Kern-F√§higkeiten
1. Termine f√ºr Beratungsdienste buchen
2. Verf√ºgbare Terminpl√§tze pr√ºfen
3. Termindetails mit Kunden best√§tigen

## Datum Parsing - NUTZEN Sie parse_date FUNKTION (KRITISCH!)

Wenn der Kunde EIN DATUM erw√§hnt (n√§chste Woche Montag, heute, morgen, 20.10.2025, etc.):
‚úÖ TUN SIE DAS: Rufen Sie parse_date("n√§chste Woche Montag") auf
‚ùå NICHT TUN: Das Datum selbst berechnen (Sie werden es FALSCH machen!)

Beispiele f√ºr parse_date() Nutzung:
- Kunde: "n√§chste Woche Montag" ‚Üí Sie RUFEN parse_date("n√§chste Woche Montag") auf
- Kunde: "heute um 15 Uhr" ‚Üí Sie RUFEN parse_date("heute") auf
- Kunde: "morgen" ‚Üí Sie RUFEN parse_date("morgen") auf
- Kunde: "20. Oktober" ‚Üí Sie RUFEN parse_date("20. Oktober") auf

Die parse_date Funktion gibt zur√ºck:
- "date": Das korrekte Datum in Y-m-d Format (z.B., "2025-10-20")
- "display_date": Zum Anzeigen f√ºr Kunden (z.B., "20.10.2025")
- "day_name": Wochentag (z.B., "Montag")

## Terminbuchungsprozess
1. Gr√º√üe den Kunden freundlich
2. Frage, welchen Service er ben√∂tigt
3. Wenn er einen Termin anfordert:
   - Wenn er sagt "n√§chster freier Termin" ‚Üí biete den n√§chsten verf√ºgbaren Slot an
   - Wenn er ein bestimmtes Datum angibt ‚Üí **RUFEN Sie ZUERST parse_date() auf**, dann pr√ºfen Sie die Verf√ºgbarkeit
   - Wenn keine Slots verf√ºgbar sind ‚Üí biete Alternativen an

## Kundendaten sammeln
‚ö†Ô∏è WICHTIG: **FRAGEN SIE NICHT nach Email von neuen Kunden!**

Datensammlung:
- NEUER Kunde: Sammeln Sie NUR den NAMEN
- BESTEHENDER Kunde: Nutzen Sie bereits gespeicherte Daten
- Email: Das System nutzt "termin@askproai.de" automatisch
- Email-R√ºckruf: ERST NACH Buchungsbest√§tigung anbieten: "M√∂chten Sie Erinnerungen erhalten?"

## Wichtige Regeln
- **VERSUCHEN Sie NIE, Daten zu erraten oder Daten selbst zu berechnen**
- **RUFEN Sie IMMER parse_date() auf, bevor Sie einem Kunden ein Datum best√§tigen**
- Best√§tigen Sie immer Termindetails vor der Buchung
- Seien Sie h√∂flich und professionell
- Wenn Sie sich bei der Verf√ºgbarkeit unsicher sind, pr√ºfen Sie mit Funktionsaufrufen
- Sprechen Sie nat√ºrlich auf Deutsch
- Wenn die Buchung fehlschl√§gt, entschuldigen Sie sich und bieten Sie Alternativen an

## Beispielinteraktion (RICHTIGE ART)
Nutzer: "Ich m√∂chte einen Termin n√§chste Woche Montag um 14:30"
Sie: Rufen Sie parse_date("n√§chste Woche Montag") auf ‚Üí Backend antwortet "2025-10-20", "20.10.2025", "Montag"
Sie: "Gerne! N√§chste Woche Montag, der 20. Oktober um 14:30 Uhr - ist das korrekt?"</span>
                </div>
                <div class="success-message" id="msg1">‚úÖ System-Prompt kopiert!</div>
            </div>

            <!-- QUICK WIN #2 -->
            <div class="change-section" id="section2">
                <h2>
                    <input type="checkbox" class="checkbox" id="check2">
                    ‚è∞ √ÑNDERUNG #2: Past Time Fehlerbehandlung
                    <span class="badge ready">QUICK WIN</span>
                </h2>

                <p class="priority quick">‚è±Ô∏è Aufwand: 10 Minuten | üìä Impact: Hoch</p>

                <div class="problem">
                    <strong>‚ùå Problem:</strong> Wenn Kunde "14:00 Uhr" sagt (es ist bereits 14:00 Uhr) ‚Üí Endlosschleife "Ich √ºberpr√ºfe nochmal"
                </div>

                <div class="solution">
                    <strong>‚úÖ L√∂sung:</strong> DateTimeParser erweitern, um ALL past times abzulehnen (nicht nur >30 Tage alte)
                </div>

                <div class="steps">
                    <div class="step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <strong>Datei √∂ffnen:</strong>
                            <div class="file-path">app/Services/Retell/DateTimeParser.php</div>
                        </div>
                    </div>

                    <div class="step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <strong>Suchen nach:</strong> <code style="background: #f3f4f6; padding: 2px 6px;">if ($parsed->isPast() && $parsed->diffInDays(now()) > 30)</code>
                        </div>
                    </div>

                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <strong>Ersetzen Sie die gesamte Zeile (Zeile 91) mit:</strong> (Button rechts oben)
                        </div>
                    </div>

                    <div class="step">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <strong>Speichern & testen</strong> mit absichtlich falschen Uhrzeiten
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEW CODE FOR DATETIMEPARSER -->
            <div style="margin: 30px 0;">
                <p style="margin-bottom: 10px; font-weight: bold; color: #374151;">üìù CODE zum Ersetzen (Zeile 88-100):</p>
                <div class="code-block">
<button class="copy-btn" onclick="copyToClipboard('code2', this)">üìã Kopieren</button>
<span id="code2">        // Handle specific date if provided
        if (isset($params['date']) && isset($params['time'])) {
            $parsed = Carbon::parse($params['date'] . ' ' . $params['time']);

            // üîß CRITICAL FIX 2025-10-20: ANY past time is invalid, not just >30 days
            if ($parsed->isPast()) {
                $minutesAgo = $parsed->diffInMinutes(now());

                if ($minutesAgo > 0) {
                    Log::warning('‚è∞ Past time requested - suggesting next available', [
                        'requested' => $parsed->format('Y-m-d H:i'),
                        'minutes_ago' => $minutesAgo,
                        'params' => $params
                    ]);

                    // Suggest next available time: +2 hours from now, rounded to hour
                    $suggestedTime = now('Europe/Berlin')
                        ->addHours(2)
                        ->floorHour()
                        ->setMinutes(0);

                    Log::info('‚úÖ Suggesting alternative time', [
                        'suggested' => $suggestedTime->format('Y-m-d H:i')
                    ]);

                    return $suggestedTime;
                }
            }</span>
                </div>
                <div class="success-message" id="msg2">‚úÖ Code kopiert!</div>
            </div>

            <!-- VERIFICATION STEPS -->
            <div class="change-section" id="section3">
                <h2>
                    <input type="checkbox" class="checkbox" id="check3">
                    ‚úîÔ∏è VERIFIKATION & TESTEN
                    <span class="badge pending">VALIDIERUNG</span>
                </h2>

                <p class="priority medium">‚è±Ô∏è Aufwand: 5 Minuten | üìä Impact: Qualit√§tskontrolle</p>

                <div class="warning">
                    ‚ö†Ô∏è Wichtig: Diese Tests durchf√ºhren, bevor Sie in Production gehen!
                </div>

                <div class="steps">
                    <div class="step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <strong>Speichern & PHP Cache leeren:</strong>
                            <div class="command-section" style="margin-top: 10px;">
<button class="copy-btn" onclick="copyToClipboard('cmd1', this)">üìã Kopieren</button>
<span id="cmd1">php artisan cache:clear && php artisan config:clear</span>
                            </div>
                        </div>
                    </div>

                    <div class="step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <strong>Test-Anruf #1: Email-Friction</strong>
                            <ul style="margin-top: 8px; margin-left: 20px; line-height: 1.8;">
                                <li>Rufen Sie den Agent an</li>
                                <li>Agent sollte NICHT nach Email fragen</li>
                                <li>Agent sollte nur NAME erfragen</li>
                                <li>Dann direkt: "Welche Uhrzeit w√ºnschen Sie?"</li>
                            </ul>
                        </div>
                    </div>

                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <strong>Test-Anruf #2: Past Time Handling</strong>
                            <ul style="margin-top: 8px; margin-left: 20px; line-height: 1.8;">
                                <li>Sagen Sie: "Ich m√∂chte 14:00 Uhr heute"</li>
                                <li>WENN es bereits nach 14:00 Uhr ist:</li>
                                <li>Agent sollte sagen: "Das ist leider in der Vergangenheit. Wie w√§re es mit [neue Zeit]?"</li>
                                <li>NICHT "Ich √ºberpr√ºfe nochmal" oder lange Stille!</li>
                            </ul>
                        </div>
                    </div>

                    <div class="step">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <strong>Logs √ºberpr√ºfen:</strong>
                            <div class="command-section" style="margin-top: 10px;">
<button class="copy-btn" onclick="copyToClipboard('cmd2', this)">üìã Kopieren</button>
<span id="cmd2">tail -f storage/logs/laravel.log | grep -i "past time\|email\|parse_date"</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SUCCESS CRITERIA -->
            <div class="change-section" id="section4">
                <h2>
                    <input type="checkbox" class="checkbox" id="check4">
                    üéØ SUCCESS METRICS
                </h2>

                <div style="background: #f0f9ff; border-left: 3px solid #0284c7; padding: 15px; margin: 15px 0; border-radius: 4px;">
                    <strong style="color: #0c4a6e;">Nach diesen Changes sollten Sie sehen:</strong>
                    <ul style="margin-top: 10px; margin-left: 20px; line-height: 1.8; color: #1e3a8a;">
                        <li>‚úÖ Agent fragt nicht mehr nach Email (Reibung: -100%)</li>
                        <li>‚úÖ Keine "Ich √ºberpr√ºfe nochmal" Endlosschleife mehr</li>
                        <li>‚úÖ Past times werden sofort mit Alternative beantwortet</li>
                        <li>‚úÖ Call completion rate: +5-10%</li>
                        <li>‚úÖ Customer satisfaction: +15-20%</li>
                    </ul>
                </div>
            </div>

            <!-- TROUBLESHOOTING -->
            <div class="change-section" id="section5">
                <h2>üîß Wenn etwas nicht funktioniert...</h2>

                <div style="margin: 15px 0;">
                    <details style="cursor: pointer;">
                        <summary style="font-weight: bold; padding: 10px; background: #f9fafb; border-radius: 4px;">
                            ‚ùì Agent fragt immer noch nach Email
                        </summary>
                        <div style="padding: 15px; margin-top: 10px; background: #f9fafb; border-radius: 4px;">
                            <p>1. √úberpr√ºfen Sie im Filament Admin, dass Sie in den richtigen Agent die √Ñnderungen eingef√ºgt haben</p>
                            <p style="margin-top: 8px;">2. Klicken Sie auf "Save" UND "Publish/Deploy"</p>
                            <p style="margin-top: 8px;">3. F√ºhren Sie aus:</p>
                            <div class="command-section">
<button class="copy-btn" onclick="copyToClipboard('cmd3', this)">üìã Kopieren</button>
<span id="cmd3">php artisan cache:clear</span>
                            </div>
                            <p style="margin-top: 8px;">4. Testen Sie einen neuen Anruf (nicht den gleichen Anruf wiederholen)</p>
                        </div>
                    </details>
                </div>

                <div style="margin: 15px 0;">
                    <details style="cursor: pointer;">
                        <summary style="font-weight: bold; padding: 10px; background: #f9fafb; border-radius: 4px;">
                            ‚ùì DateTimeParser gibt Error
                        </summary>
                        <div style="padding: 15px; margin-top: 10px; background: #f9fafb; border-radius: 4px;">
                            <p>1. Stellen Sie sicher, dass Sie die √Ñnderung an der richtigen Stelle eingef√ºgt haben (Zeile ~88-100)</p>
                            <p style="margin-top: 8px;">2. √úberpr√ºfen Sie, dass Sie die gesamte if-Block ersetzt haben</p>
                            <p style="margin-top: 8px;">3. F√ºhren Sie aus:</p>
                            <div class="command-section">
<button class="copy-btn" onclick="copyToClipboard('cmd4', this)">üìã Kopieren</button>
<span id="cmd4">php -l app/Services/Retell/DateTimeParser.php</span>
                            </div>
                            <p style="margin-top: 8px;">4. Das sollte "No syntax errors detected" zur√ºckgeben</p>
                        </div>
                    </details>
                </div>
            </div>

            <!-- SUMMARY -->
            <div style="background: linear-gradient(135deg, #dcfce7 0%, #d1fae5 100%); border: 2px solid #10b981; padding: 25px; border-radius: 8px; margin: 30px 0; text-align: center;">
                <h3 style="color: #166534; font-size: 20px; margin-bottom: 15px;">üöÄ Sie sind bereit f√ºr die Implementierung!</h3>
                <p style="color: #047857; line-height: 1.6;">
                    Diese 2 Quick Wins erfordern <strong>~15 Minuten</strong> und verbessern die Customer Experience erheblich.
                </p>
                <p style="color: #047857; margin-top: 12px; font-size: 13px;">
                    Alle Code-Snippets sind zum Copy-Paste vorbereitet. Testen Sie danach mit den Test-Anrufen.
                </p>
            </div>
        </div>

        <div class="footer">
            <p>üìä Analyse erstellt: 2025-10-20 | üîó Basierend auf: TESTCALL_ANALYSIS_2025_10_20.md</p>
            <p style="margin-top: 10px; color: #9ca3af;">Support: √úberpr√ºfen Sie die Logs mit <code style="background: #e5e7eb; padding: 2px 4px; border-radius: 2px;">tail -f storage/logs/laravel.log</code></p>
        </div>
    </div>

    <script>
        function copyToClipboard(elementId, button) {
            const element = document.getElementById(elementId);
            const text = element.textContent;

            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = '‚úÖ Kopiert!';
                button.classList.add('copied');

                // Show success message
                const section = button.closest('.change-section') || button.closest('[style*="margin"]');
                const messageId = 'msg' + (button.closest('.change-section')?.id?.match(/\d+/) || [1])[0];
                const message = document.getElementById(messageId);
                if (message) {
                    message.classList.add('show');
                    setTimeout(() => message.classList.remove('show'), 3000);
                }

                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                alert('Fehler beim Kopieren: ' + err);
            });
        }

        // Checkbox handling
        document.querySelectorAll('.checkbox').forEach((checkbox, index) => {
            checkbox.addEventListener('change', function() {
                const section = this.closest('.change-section');
                if (this.checked) {
                    section.classList.add('completed');
                    section.style.opacity = '0.7';
                } else {
                    section.classList.remove('completed');
                    section.style.opacity = '1';
                }
            });
        });
    </script>
</body>
</html>
name: Test Automation Suite

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * *'

env:
  PHP_VERSION: '8.3'
  NODE_VERSION: '18'

jobs:
  unit-tests:
    name: Unit Tests (PHPUnit)
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: askproai_testing
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Ensure Vite manifest exists (CI)
        run: |
          mkdir -p public/build
          echo '{}' > public/build/manifest.json

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, pdo, pdo_mysql, redis, gd
          coverage: xdebug
          ini-values: memory_limit=512M

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Copy environment file
        run: cp .env.testing .env

      - name: Generate application key
        run: php artisan key:generate

      - name: Run database migrations
        run: php artisan migrate --force

      - name: Run Unit Tests with Coverage
        run: vendor/bin/phpunit --testsuite=Unit --coverage-clover=coverage.xml --coverage-html=coverage-report

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: unit-tests
          name: unit-tests-coverage

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage-report/

      - name: Check Coverage Thresholds
        run: php scripts/check-coverage.php coverage.xml

  rca-prevention-tests:
    name: RCA Prevention Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    if: github.event_name == 'schedule'

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: askproai_testing
        ports:
          - 3306:3306

      redis:
        image: redis:7
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - name: Ensure Vite manifest exists (CI)
        run: |
          mkdir -p public/build
          echo '{}' > public/build/manifest.json

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}

      - name: Install dependencies
        run: composer install --no-interaction

      - name: Setup environment
        run: cp .env.testing .env

      - name: Run migrations
        run: php artisan migrate --force

      - name: Run RCA Prevention Tests
        run: vendor/bin/phpunit tests/Unit/Services/RcaPreventionTest.php --verbose

      - name: Report RCA Test Results
        if: always()
        run: |
          echo "# RCA Prevention Test Results" >> $GITHUB_STEP_SUMMARY
          echo "All RCA-identified bugs are now covered by tests" >> $GITHUB_STEP_SUMMARY

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    if: github.event_name == 'schedule'

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: askproai_testing
        ports:
          - 3306:3306

      redis:
        image: redis:7
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - name: Ensure Vite manifest exists (CI)
        run: |
          mkdir -p public/build
          echo '{}' > public/build/manifest.json

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}

      - name: Install dependencies
        run: composer install --no-interaction

      - name: Setup environment
        run: cp .env.testing .env

      - name: Run migrations
        run: php artisan migrate --force

      - name: Seed test data
        run: php artisan db:seed --class=TestDataSeeder

      - name: Run Integration Tests
        run: vendor/bin/phpunit --testsuite=Feature --filter=Integration

  performance-tests:
    name: Performance Tests (K6)
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: github.event_name == 'schedule'

    steps:
      - uses: actions/checkout@v4

      - name: Ensure Vite manifest exists (CI)
        run: |
          mkdir -p public/build
          echo '{}' > public/build/manifest.json

      - name: Setup K6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install -y k6

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}

      - name: Install dependencies
        run: composer install --no-interaction

      - name: Start application
        run: |
          cp .env.testing .env
          php artisan migrate --force
          php artisan serve &
          sleep 10

      - name: Run Baseline Performance Test
        env:
          API_URL: http://localhost:8000
        run: k6 run tests/Performance/k6/baseline-booking-flow.js --out json=baseline-results.json

      - name: Upload Performance Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-results
          path: |
            baseline-results.json
            summary.html

  e2e-tests:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: github.event_name == 'schedule'

    steps:
      - uses: actions/checkout@v4

      - name: Ensure Vite manifest exists (CI)
        run: |
          mkdir -p public/build
          echo '{}' > public/build/manifest.json

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Playwright
        run: |
          npm install -D @playwright/test
          npx playwright install --with-deps chromium

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}

      - name: Install PHP dependencies
        run: composer install --no-interaction

      - name: Start application
        run: |
          cp .env.testing .env
          php artisan migrate --force
          php artisan db:seed --class=TestDataSeeder
          php artisan serve &
          sleep 10

      - name: Run Playwright E2E Tests
        run: npx playwright test tests/E2E/playwright/

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

  security-tests:
    name: Security & Multi-Tenant Tests
    runs-on: ubuntu-latest
    needs: [unit-tests]
    if: github.event_name == 'schedule'

    steps:
      - uses: actions/checkout@v4

      - name: Ensure Vite manifest exists (CI)
        run: |
          mkdir -p public/build
          echo '{}' > public/build/manifest.json

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}

      - name: Install dependencies
        run: composer install --no-interaction

      - name: Setup environment
        run: cp .env.testing .env

      - name: Run Security Tests
        run: vendor/bin/phpunit --testsuite=Feature --filter=Security

      - name: Run PHPStan Static Analysis
        run: vendor/bin/phpstan analyse --level=8 app/ --error-format=github

      - name: Check for Vulnerable Dependencies
        run: composer audit

  test-summary:
    name: Generate Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, rca-prevention-tests, integration-tests, performance-tests, e2e-tests, security-tests]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸ§ª Test Automation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- RCA Prevention: ${{ needs.rca-prevention-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Integration Tests: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Performance Tests: ${{ needs.performance-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- E2E Tests: ${{ needs.e2e-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Tests: ${{ needs.security-tests.result }}" >> $GITHUB_STEP_SUMMARY

<!DOCTYPE html>
<html>
<head>
    <title>ULTRATHINK Final Session Test</title>
    <style>
        body { font-family: monospace; margin: 20px; background: #1a1a1a; color: #fff; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #0f0; text-shadow: 0 0 10px #0f0; }
        .critical-finding {
            background: #330000;
            border: 2px solid #ff0000;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .test-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .test-side {
            background: #0a0a0a;
            border: 1px solid #444;
            padding: 20px;
            border-radius: 8px;
        }
        .test-side.php-file {
            border-color: #f00;
        }
        .test-side.laravel-route {
            border-color: #0f0;
        }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px 0;
            width: 100%;
            display: block;
        }
        button:hover {
            background: #0a0;
            color: #fff;
        }
        pre {
            background: #000;
            padding: 15px;
            overflow-x: auto;
            border: 1px solid #444;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #0f0; font-weight: bold; }
        .error { color: #f00; font-weight: bold; }
        .warning { color: #ff0; font-weight: bold; }
        .finding {
            background: #111;
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #ff0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß† ULTRATHINK: PHP Files vs Laravel Routes</h1>
        
        <div class="critical-finding">
            <h2 class="error">KRITISCHE ENTDECKUNG:</h2>
            <p>PHP-Dateien im public/ Ordner umgehen das Laravel Routing System!</p>
            <ul>
                <li>PHP-Dateien werden direkt von PHP-FPM/Apache ausgef√ºhrt</li>
                <li>Sie gehen NICHT durch Laravel's Middleware Stack</li>
                <li>Deshalb wird kein Session Cookie gesetzt!</li>
            </ul>
        </div>
        
        <div class="test-comparison">
            <div class="test-side php-file">
                <h3>‚ùå PHP File (public/test-session-set.php)</h3>
                <p>Geht NICHT durch Web Middleware!</p>
                <button onclick="testPHPFile('set')">Set via PHP File</button>
                <button onclick="testPHPFile('get')">Get via PHP File</button>
                <pre id="php-result">Click to test...</pre>
            </div>
            
            <div class="test-side laravel-route">
                <h3>‚úÖ Laravel Route (/test-session-set-route)</h3>
                <p>Geht durch Web Middleware!</p>
                <button onclick="testRoute('set')">Set via Route</button>
                <button onclick="testRoute('get')">Get via Route</button>
                <pre id="route-result">Click to test...</pre>
            </div>
        </div>
        
        <div class="finding">
            <h2>Cookie Status:</h2>
            <button onclick="showCookies()">Show All Cookies</button>
            <pre id="cookie-status">Click to show cookies...</pre>
        </div>
        
        <div class="finding">
            <h2>Analyse:</h2>
            <pre id="analysis" class="warning">Tests laufen...</pre>
        </div>
        
        <div class="critical-finding">
            <h2 class="success">L√ñSUNG:</h2>
            <p>Alle Session-bezogenen Endpoints m√ºssen als Laravel Routes definiert werden!</p>
            <ol>
                <li>Keine PHP-Dateien in public/ f√ºr Session-Logik</li>
                <li>Alle Auth/Session Endpoints als Routes in routes/web.php</li>
                <li>Oder: Eigene Middleware f√ºr PHP-Dateien schreiben</li>
            </ol>
        </div>
    </div>
    
    <script>
    let phpSessionId = null;
    let routeSessionId = null;
    
    async function testPHPFile(action) {
        const result = document.getElementById('php-result');
        result.textContent = `Testing PHP file (${action})...`;
        
        try {
            const url = action === 'set' ? '/test-session-set.php' : '/test-session-get.php';
            const response = await fetch(url, {
                credentials: 'same-origin'
            });
            const data = await response.json();
            
            result.textContent = JSON.stringify(data, null, 2);
            
            if (action === 'set') {
                phpSessionId = data.session_id;
                result.textContent += '\n\nSession ID: ' + phpSessionId;
            } else {
                result.textContent += '\n\nData persisted: ' + (data.test_value ? 'YES ‚úÖ' : 'NO ‚ùå');
                if (data.session_id !== phpSessionId) {
                    result.textContent += '\nSession ID CHANGED! ‚ùå';
                }
            }
            
            updateAnalysis();
        } catch (error) {
            result.innerHTML = '<span class="error">Error: ' + error.message + '</span>';
        }
    }
    
    async function testRoute(action) {
        const result = document.getElementById('route-result');
        result.textContent = `Testing Laravel route (${action})...`;
        
        try {
            const url = action === 'set' ? '/test-session-set-route' : '/test-session-get-route';
            const response = await fetch(url, {
                credentials: 'same-origin'
            });
            const data = await response.json();
            
            result.textContent = JSON.stringify(data, null, 2);
            
            if (action === 'set') {
                routeSessionId = data.session_id;
                result.textContent += '\n\nSession ID: ' + routeSessionId;
            } else {
                result.textContent += '\n\nData persisted: ' + (data.test_route ? 'YES ‚úÖ' : 'NO ‚ùå');
                if (data.session_id === routeSessionId) {
                    result.textContent += '\nSession ID consistent! ‚úÖ';
                } else {
                    result.textContent += '\nSession ID CHANGED! ‚ùå';
                }
            }
            
            updateAnalysis();
        } catch (error) {
            result.innerHTML = '<span class="error">Error: ' + error.message + '</span>';
        }
    }
    
    function showCookies() {
        const result = document.getElementById('cookie-status');
        result.textContent = '=== BROWSER COOKIES ===\n\n';
        
        const cookies = document.cookie.split(';');
        let sessionCookieFound = false;
        
        if (cookies.length === 0 || (cookies.length === 1 && cookies[0] === '')) {
            result.textContent += 'NO COOKIES! ‚ùå\n';
        } else {
            cookies.forEach(cookie => {
                const [name, value] = cookie.trim().split('=');
                if (name) {
                    result.textContent += name + ': ' + (value ? value.substring(0, 50) + '...' : '(empty)') + '\n';
                    if (name === 'askproai_session') {
                        sessionCookieFound = true;
                    }
                }
            });
        }
        
        result.textContent += '\n=== COOKIE ANALYSIS ===\n';
        result.textContent += 'askproai_session: ' + (sessionCookieFound ? 'FOUND ‚úÖ' : 'NOT FOUND ‚ùå') + '\n';
        
        if (sessionCookieFound) {
            result.innerHTML += '\n<span class="success">Session cookie exists! Routes are working!</span>';
        } else {
            result.innerHTML += '\n<span class="error">No session cookie! PHP files bypass middleware!</span>';
        }
    }
    
    function updateAnalysis() {
        const analysis = document.getElementById('analysis');
        let findings = '=== ULTRATHINK ANALYSIS ===\n\n';
        
        findings += '1. PHP FILES (public/*.php):\n';
        findings += '   - Bypass Laravel routing\n';
        findings += '   - No middleware execution\n';
        findings += '   - No session cookie set\n';
        findings += '   - Session data lost between requests\n\n';
        
        findings += '2. LARAVEL ROUTES:\n';
        findings += '   - Go through full middleware stack\n';
        findings += '   - Session cookie properly set\n';
        findings += '   - Session data persists\n\n';
        
        findings += '3. ROOT CAUSE:\n';
        findings += '   test-session-set.php etc. are PHP files\n';
        findings += '   They bootstrap Laravel but bypass routing\n';
        findings += '   AddQueuedCookiesToResponse middleware never runs!\n\n';
        
        findings += '4. SOLUTION:\n';
        findings += '   Move all session logic to proper routes\n';
        findings += '   Or create a custom entry point that ensures middleware runs';
        
        analysis.textContent = findings;
    }
    
    // Run initial test
    window.onload = () => {
        showCookies();
        updateAnalysis();
    };
    </script>
</body>
</html>
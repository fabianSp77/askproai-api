<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Response Headers</title>
    <style>
        body { font-family: monospace; max-width: 1200px; margin: 20px auto; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 5px; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        pre { background: white; padding: 10px; overflow-x: auto; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>üîç Debug Response Headers</h1>
    
    <div id="results"></div>
    
    <button onclick="testWithFetch()">Test with Fetch API</button>
    <button onclick="testWithXHR()">Test with XMLHttpRequest</button>

    <script>
        const results = document.getElementById('results');
        
        function log(title, content, type = '') {
            const section = document.createElement('div');
            section.className = 'section';
            section.innerHTML = `
                <h3 class="${type}">${title}</h3>
                <pre>${content}</pre>
            `;
            results.appendChild(section);
        }

        async function testWithFetch() {
            results.innerHTML = '';
            log('Testing with Fetch API', 'Sending login request...');
            
            try {
                const response = await fetch('/business/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        email: 'demo@askproai.de',
                        password: 'demo123'
                    })
                });

                // Log all response headers
                let headersText = 'Response Headers:\n';
                for (let [key, value] of response.headers.entries()) {
                    headersText += `${key}: ${value}\n`;
                    if (key.toLowerCase() === 'set-cookie') {
                        log('‚ö†Ô∏è Set-Cookie Header Found!', value, 'warning');
                    }
                }
                log('All Headers', headersText);

                const data = await response.json();
                log('Response Body', JSON.stringify(data, null, 2), data.success ? 'success' : 'error');

                // Check browser cookies
                log('Browser Cookies', document.cookie || 'NO COOKIES', document.cookie.includes('askproai_session') ? 'success' : 'error');

            } catch (error) {
                log('Error', error.toString(), 'error');
            }
        }

        function testWithXHR() {
            results.innerHTML = '';
            log('Testing with XMLHttpRequest', 'Sending login request...');
            
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/business/auth/login', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.setRequestHeader('Accept', 'application/json');
            xhr.withCredentials = true;
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    // Log all headers
                    const allHeaders = xhr.getAllResponseHeaders();
                    log('Raw Response Headers', allHeaders);
                    
                    // Check for Set-Cookie
                    const setCookie = xhr.getResponseHeader('Set-Cookie');
                    if (setCookie) {
                        log('‚ö†Ô∏è Set-Cookie Header', setCookie, 'warning');
                    } else {
                        log('‚ùå Set-Cookie Header', 'NOT ACCESSIBLE via JavaScript (browser security)', 'error');
                    }
                    
                    // Parse response
                    try {
                        const data = JSON.parse(xhr.responseText);
                        log('Response Body', JSON.stringify(data, null, 2), data.success ? 'success' : 'error');
                    } catch (e) {
                        log('Response Text', xhr.responseText);
                    }
                    
                    // Check browser cookies
                    log('Browser Cookies After Request', document.cookie || 'NO COOKIES', document.cookie.includes('askproai_session') ? 'success' : 'error');
                }
            };
            
            xhr.send(JSON.stringify({
                email: 'demo@askproai.de',
                password: 'demo123'
            }));
        }

        // Also create a form-based test
        function addFormTest() {
            const formSection = document.createElement('div');
            formSection.className = 'section';
            formSection.innerHTML = `
                <h3>Traditional Form Submit Test</h3>
                <p>This will actually navigate away from the page:</p>
                <form action="/business/auth/login" method="POST" id="testForm">
                    <input type="hidden" name="_token" value="">
                    <input type="hidden" name="email" value="demo@askproai.de">
                    <input type="hidden" name="password" value="demo123">
                    <button type="submit">Submit Form (Will Navigate)</button>
                </form>
            `;
            document.body.appendChild(formSection);
        }
        
        addFormTest();
    </script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
    <title>Session Final Solution Test</title>
    <style>
        body { font-family: monospace; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; }
        .success-box {
            background: #d4edda;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #28a745;
            margin: 20px 0;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover { background: #2980b9; }
        pre {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
            font-size: 12px;
        }
        .success { color: #27ae60; font-weight: bold; }
        .error { color: #e74c3c; font-weight: bold; }
        .info { color: #3498db; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Session Final Solution Test</h1>
        
        <div class="success-box">
            <h3>✅ Issue Fixed!</h3>
            <p>The .env file permissions were reset to root-only, causing Laravel to fail loading the APP_KEY.</p>
            <p>This has been fixed. The file is now owned by www-data with proper permissions.</p>
        </div>
        
        <div class="test-section">
            <h2>1. Test System Status</h2>
            <button onclick="testSystemStatus()">Check System</button>
            <pre id="system-status">Click to check system status...</pre>
        </div>
        
        <div class="test-section">
            <h2>2. Test Login</h2>
            <button onclick="testLogin()">Login as demo@askproai.de</button>
            <pre id="login-test">Click to login...</pre>
        </div>
        
        <div class="test-section">
            <h2>3. Test Session Persistence</h2>
            <button onclick="testPersistence()">Check Session</button>
            <pre id="persistence-test">Login first...</pre>
        </div>
        
        <div class="test-section">
            <h2>4. Test Portal Routes</h2>
            <button onclick="testRoute('/business/dashboard')">Dashboard</button>
            <button onclick="testRoute('/business/calls')">Calls</button>
            <button onclick="testRoute('/business/api/user')">API User</button>
            <pre id="route-test">Login first...</pre>
        </div>
    </div>
    
    <script>
    async function testSystemStatus() {
        const result = document.getElementById('system-status');
        result.textContent = 'Checking system status...';
        
        try {
            const response = await fetch('/simple-error-test.php');
            const text = await response.text();
            
            result.textContent = text;
            
            if (text.includes('APP_KEY exists: YES')) {
                result.innerHTML += '\n\n<span class="success">✅ System is working correctly!</span>';
            } else {
                result.innerHTML += '\n\n<span class="error">❌ System error - check .env permissions</span>';
            }
            
        } catch (error) {
            result.innerHTML = '<span class="error">Error: ' + error.message + '</span>';
        }
    }
    
    async function testLogin() {
        const result = document.getElementById('login-test');
        result.textContent = 'Performing login...';
        
        try {
            // Clear any existing session first
            await fetch('/business/logout', { 
                method: 'POST',
                credentials: 'same-origin'
            }).catch(() => {}); // Ignore errors
            
            // Login
            const formData = new FormData();
            formData.append('email', 'demo@askproai.de');
            formData.append('password', 'password');
            
            const response = await fetch('/business/login', {
                method: 'POST',
                body: formData,
                credentials: 'same-origin',
                redirect: 'manual'
            });
            
            result.textContent = 'Login Response:\n';
            result.textContent += 'Status: ' + response.status + '\n';
            result.textContent += 'Type: ' + response.type + '\n';
            
            if (response.status === 302 || response.type === 'opaqueredirect') {
                result.innerHTML += '\n<span class="success">✅ Login successful!</span>';
                result.innerHTML += '\n<span class="info">Now test session persistence and routes</span>';
            } else {
                result.innerHTML += '\n<span class="error">❌ Login failed</span>';
                const text = await response.text();
                result.textContent += '\nResponse: ' + text.substring(0, 500);
            }
            
        } catch (error) {
            result.innerHTML = '<span class="error">Error: ' + error.message + '</span>';
        }
    }
    
    async function testPersistence() {
        const result = document.getElementById('persistence-test');
        result.textContent = 'Checking session persistence...';
        
        try {
            const response = await fetch('/session-diagnosis.php?action=check-persistence');
            const text = await response.text();
            
            result.textContent = text;
            
            if (text.includes('Guard Check: YES')) {
                result.innerHTML += '\n\n<span class="success">✅ Session persisted successfully!</span>';
            } else {
                result.innerHTML += '\n\n<span class="error">❌ Session not persisted</span>';
            }
            
        } catch (error) {
            result.innerHTML = '<span class="error">Error: ' + error.message + '</span>';
        }
    }
    
    async function testRoute(route) {
        const result = document.getElementById('route-test');
        result.textContent = 'Testing route: ' + route + '...';
        
        try {
            const response = await fetch(route, {
                credentials: 'same-origin',
                headers: {
                    'Accept': 'application/json'
                },
                redirect: 'manual'
            });
            
            result.textContent = '=== Route: ' + route + ' ===\n';
            result.textContent += 'Status: ' + response.status + '\n';
            
            if (response.status === 200) {
                result.innerHTML += '<span class="success">✅ Access granted!</span>\n';
                
                if (route.includes('/api/')) {
                    const data = await response.json();
                    result.textContent += '\nData: ' + JSON.stringify(data, null, 2);
                }
            } else if (response.status === 302 || response.type === 'opaqueredirect') {
                result.innerHTML += '<span class="error">❌ Redirected (not authenticated)</span>\n';
            } else {
                result.innerHTML += '<span class="warning">Status: ' + response.status + '</span>\n';
            }
            
        } catch (error) {
            result.innerHTML += '\n<span class="error">Error: ' + error.message + '</span>';
        }
    }
    
    // Check system status on load
    window.onload = () => {
        testSystemStatus();
    };
    </script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
    <title>Debug AJAX/Livewire Requests</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .request { margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        .pending { background: #fff3cd; }
        pre { background: #f4f4f4; padding: 10px; overflow-x: auto; }
        .log-entry { margin: 5px 0; padding: 5px; border-left: 3px solid #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Debug AJAX/Livewire Requests</h1>
        <p>Open this page, then navigate to /admin/calls in another tab. This will capture all AJAX requests.</p>
        
        <button onclick="clearLogs()">Clear Logs</button>
        <button onclick="openAdminCalls()">Open /admin/calls in new tab</button>
        
        <div id="logs"></div>
    </div>

    <script>
        const logs = document.getElementById('logs');
        let requestCount = 0;

        // Override XMLHttpRequest
        const originalOpen = XMLHttpRequest.prototype.open;
        const originalSend = XMLHttpRequest.prototype.send;

        XMLHttpRequest.prototype.open = function(method, url, async, user, password) {
            this._requestId = ++requestCount;
            this._method = method;
            this._url = url;
            
            logRequest({
                id: this._requestId,
                method: method,
                url: url,
                status: 'pending',
                timestamp: new Date().toISOString()
            });
            
            return originalOpen.apply(this, arguments);
        };

        XMLHttpRequest.prototype.send = function(data) {
            const requestId = this._requestId;
            
            this.addEventListener('load', function() {
                logResponse({
                    id: requestId,
                    status: this.status,
                    statusText: this.statusText,
                    responseText: this.responseText.substring(0, 500),
                    headers: this.getAllResponseHeaders()
                });
            });
            
            this.addEventListener('error', function() {
                logError({
                    id: requestId,
                    error: 'Network error'
                });
            });
            
            if (data) {
                logRequestBody({
                    id: requestId,
                    body: data
                });
            }
            
            return originalSend.apply(this, arguments);
        };

        // Override Fetch API
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            const requestId = ++requestCount;
            const [url, options = {}] = args;
            
            logRequest({
                id: requestId,
                method: options.method || 'GET',
                url: url,
                status: 'pending',
                timestamp: new Date().toISOString()
            });
            
            return originalFetch.apply(this, args)
                .then(response => {
                    const clonedResponse = response.clone();
                    
                    clonedResponse.text().then(text => {
                        logResponse({
                            id: requestId,
                            status: response.status,
                            statusText: response.statusText,
                            responseText: text.substring(0, 500),
                            headers: Array.from(response.headers.entries())
                        });
                    });
                    
                    return response;
                })
                .catch(error => {
                    logError({
                        id: requestId,
                        error: error.message
                    });
                    throw error;
                });
        };

        function logRequest(data) {
            const entry = document.createElement('div');
            entry.className = 'request pending';
            entry.id = 'request-' + data.id;
            entry.innerHTML = `
                <strong>#${data.id} ${data.method} ${data.url}</strong><br>
                <small>${data.timestamp}</small>
                <div id="request-${data.id}-details"></div>
            `;
            logs.insertBefore(entry, logs.firstChild);
        }

        function logRequestBody(data) {
            const details = document.getElementById(`request-${data.id}-details`);
            if (details && data.body) {
                details.innerHTML += `<pre>Request Body: ${data.body}</pre>`;
            }
        }

        function logResponse(data) {
            const entry = document.getElementById('request-' + data.id);
            if (entry) {
                entry.className = data.status >= 200 && data.status < 300 ? 'request success' : 'request error';
                const details = document.getElementById(`request-${data.id}-details`);
                details.innerHTML += `
                    <pre>Status: ${data.status} ${data.statusText}
Headers: ${JSON.stringify(data.headers, null, 2)}
Response: ${data.responseText}</pre>
                `;
            }
        }

        function logError(data) {
            const entry = document.getElementById('request-' + data.id);
            if (entry) {
                entry.className = 'request error';
                const details = document.getElementById(`request-${data.id}-details`);
                details.innerHTML += `<pre>Error: ${data.error}</pre>`;
            }
        }

        function clearLogs() {
            logs.innerHTML = '';
            requestCount = 0;
        }

        function openAdminCalls() {
            window.open('/admin/calls', '_blank');
        }

        // Log to console as well
        console.log('AJAX/Fetch interceptor loaded. All requests will be logged.');
    </script>
</body>
</html>
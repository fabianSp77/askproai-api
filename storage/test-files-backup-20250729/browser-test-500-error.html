<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser 500 Error Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
            margin-left: 10px;
        }
        .success { background: #4CAF50; color: white; }
        .error { background: #f44336; color: white; }
        .warning { background: #ff9800; color: white; }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #1976D2;
        }
        .log {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .cookie-info {
            margin-top: 10px;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 4px;
        }
        iframe {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Browser 500 Error Diagnostic Tool</h1>
        
        <div class="test-section">
            <h2>1. Cookie & Session Test</h2>
            <button onclick="checkCookies()">Check Cookies</button>
            <button onclick="clearCookies()">Clear All Cookies</button>
            <button onclick="clearStorage()">Clear All Storage</button>
            <div id="cookie-result" class="log"></div>
        </div>

        <div class="test-section">
            <h2>2. Direct Fetch Test</h2>
            <button onclick="testFetch()">Test Login Page with Fetch</button>
            <button onclick="testFetchWithCredentials()">Test with Credentials</button>
            <div id="fetch-result" class="log"></div>
        </div>

        <div class="test-section">
            <h2>3. XHR Test</h2>
            <button onclick="testXHR()">Test with XMLHttpRequest</button>
            <div id="xhr-result" class="log"></div>
        </div>

        <div class="test-section">
            <h2>4. IFrame Test</h2>
            <button onclick="testIframe()">Load in IFrame</button>
            <button onclick="clearIframe()">Clear IFrame</button>
            <div id="iframe-container"></div>
        </div>

        <div class="test-section">
            <h2>5. Browser Information</h2>
            <button onclick="showBrowserInfo()">Show Browser Info</button>
            <div id="browser-info" class="log"></div>
        </div>

        <div class="test-section">
            <h2>6. Network Timing Analysis</h2>
            <button onclick="analyzePerformance()">Analyze Performance</button>
            <div id="performance-result" class="log"></div>
        </div>
    </div>

    <script>
        const loginUrl = 'https://api.askproai.de/admin/login';
        
        function log(elementId, message, status = '') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const statusBadge = status ? `<span class="status ${status}">${status.toUpperCase()}</span>` : '';
            element.innerHTML += `[${timestamp}] ${message} ${statusBadge}\n`;
            element.scrollTop = element.scrollHeight;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        // Cookie functions
        function checkCookies() {
            clearLog('cookie-result');
            log('cookie-result', 'Checking cookies for api.askproai.de...');
            
            const cookies = document.cookie.split(';');
            if (cookies.length === 0 || (cookies.length === 1 && cookies[0] === '')) {
                log('cookie-result', 'No cookies found', 'warning');
            } else {
                log('cookie-result', `Found ${cookies.length} cookies:`);
                cookies.forEach(cookie => {
                    const [name, value] = cookie.trim().split('=');
                    if (name) {
                        log('cookie-result', `  ${name}: ${value ? value.substring(0, 20) + '...' : '(empty)'}`);
                    }
                });
            }
            
            // Check localStorage and sessionStorage
            log('cookie-result', '\nLocalStorage items: ' + localStorage.length);
            log('cookie-result', 'SessionStorage items: ' + sessionStorage.length);
        }

        function clearCookies() {
            clearLog('cookie-result');
            log('cookie-result', 'Clearing all cookies...');
            
            // Clear cookies for current domain and parent domains
            const domains = ['api.askproai.de', '.askproai.de', 'askproai.de'];
            const paths = ['/', '/admin', '/admin/'];
            
            domains.forEach(domain => {
                paths.forEach(path => {
                    document.cookie.split(';').forEach(cookie => {
                        const name = cookie.split('=')[0].trim();
                        if (name) {
                            // Try multiple ways to clear the cookie
                            document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=${path}; domain=${domain}`;
                            document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=${path}`;
                            document.cookie = `${name}=; max-age=0; path=${path}; domain=${domain}`;
                        }
                    });
                });
            });
            
            log('cookie-result', 'Cookies cleared', 'success');
            checkCookies();
        }

        function clearStorage() {
            clearLog('cookie-result');
            log('cookie-result', 'Clearing all storage...');
            
            try {
                localStorage.clear();
                log('cookie-result', 'LocalStorage cleared', 'success');
            } catch (e) {
                log('cookie-result', 'Failed to clear localStorage: ' + e.message, 'error');
            }
            
            try {
                sessionStorage.clear();
                log('cookie-result', 'SessionStorage cleared', 'success');
            } catch (e) {
                log('cookie-result', 'Failed to clear sessionStorage: ' + e.message, 'error');
            }
            
            clearCookies();
        }

        // Fetch test
        async function testFetch() {
            clearLog('fetch-result');
            log('fetch-result', `Fetching ${loginUrl}...`);
            
            try {
                const startTime = performance.now();
                const response = await fetch(loginUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
                    },
                    credentials: 'omit', // Don't send cookies
                    cache: 'no-cache'
                });
                const endTime = performance.now();
                
                log('fetch-result', `Status: ${response.status} ${response.statusText}`);
                log('fetch-result', `Time: ${Math.round(endTime - startTime)}ms`);
                log('fetch-result', `Type: ${response.type}`);
                
                // Check headers
                log('fetch-result', '\nResponse Headers:');
                for (let [key, value] of response.headers) {
                    log('fetch-result', `  ${key}: ${value}`);
                }
                
                if (response.status === 500) {
                    log('fetch-result', '\n500 ERROR DETECTED!', 'error');
                    const text = await response.text();
                    
                    // Try to extract error message
                    const errorMatch = text.match(/<div[^>]*class="[^"]*message[^"]*"[^>]*>(.*?)<\/div>/s);
                    if (errorMatch) {
                        log('fetch-result', 'Error Message: ' + errorMatch[1].replace(/<[^>]*>/g, '').trim());
                    }
                } else if (response.status === 200) {
                    log('fetch-result', 'Page loaded successfully', 'success');
                }
                
            } catch (error) {
                log('fetch-result', `Fetch error: ${error.message}`, 'error');
            }
        }

        async function testFetchWithCredentials() {
            clearLog('fetch-result');
            log('fetch-result', `Fetching ${loginUrl} with credentials...`);
            
            try {
                const response = await fetch(loginUrl, {
                    method: 'GET',
                    credentials: 'include', // Send cookies
                    cache: 'no-cache'
                });
                
                log('fetch-result', `Status: ${response.status} ${response.statusText}`);
                
                if (response.status === 500) {
                    log('fetch-result', '500 ERROR WITH CREDENTIALS!', 'error');
                } else {
                    log('fetch-result', 'Success with credentials', 'success');
                }
                
            } catch (error) {
                log('fetch-result', `Fetch error: ${error.message}`, 'error');
            }
        }

        // XHR test
        function testXHR() {
            clearLog('xhr-result');
            log('xhr-result', `Testing with XMLHttpRequest...`);
            
            const xhr = new XMLHttpRequest();
            xhr.open('GET', loginUrl, true);
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    log('xhr-result', `Status: ${xhr.status} ${xhr.statusText}`);
                    
                    if (xhr.status === 500) {
                        log('xhr-result', '500 ERROR DETECTED!', 'error');
                        log('xhr-result', 'Response Headers:\n' + xhr.getAllResponseHeaders());
                    } else if (xhr.status === 200) {
                        log('xhr-result', 'Page loaded successfully', 'success');
                    }
                }
            };
            
            xhr.onerror = function() {
                log('xhr-result', 'XHR Error occurred', 'error');
            };
            
            xhr.send();
        }

        // IFrame test
        function testIframe() {
            const container = document.getElementById('iframe-container');
            container.innerHTML = '<p>Loading login page in iframe...</p><iframe src="' + loginUrl + '" onload="iframeLoaded()" onerror="iframeError()"></iframe>';
        }

        function clearIframe() {
            document.getElementById('iframe-container').innerHTML = '';
        }

        function iframeLoaded() {
            console.log('IFrame loaded');
            try {
                const iframe = document.querySelector('iframe');
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                console.log('IFrame title:', iframeDoc.title);
            } catch (e) {
                console.log('Cannot access iframe content (cross-origin)');
            }
        }

        function iframeError() {
            console.log('IFrame loading error');
        }

        // Browser info
        function showBrowserInfo() {
            clearLog('browser-info');
            
            log('browser-info', 'User Agent:');
            log('browser-info', navigator.userAgent);
            log('browser-info', '\nBrowser Properties:');
            log('browser-info', `Language: ${navigator.language}`);
            log('browser-info', `Platform: ${navigator.platform}`);
            log('browser-info', `Cookies Enabled: ${navigator.cookieEnabled}`);
            log('browser-info', `Do Not Track: ${navigator.doNotTrack}`);
            log('browser-info', `Online: ${navigator.onLine}`);
            
            // Check for browser extensions or modifications
            log('browser-info', '\nSecurity & Privacy:');
            log('browser-info', `Protocol: ${location.protocol}`);
            log('browser-info', `Hostname: ${location.hostname}`);
            log('browser-info', `Port: ${location.port || '(default)'}`);
        }

        // Performance analysis
        async function analyzePerformance() {
            clearLog('performance-result');
            log('performance-result', 'Analyzing network performance...');
            
            // Clear resource timing
            performance.clearResourceTimings();
            
            // Make a request
            await fetch(loginUrl, { method: 'HEAD', cache: 'no-cache' });
            
            // Wait a bit for timing data
            setTimeout(() => {
                const entries = performance.getEntriesByType('resource');
                const loginEntry = entries.find(e => e.name.includes('/admin/login'));
                
                if (loginEntry) {
                    log('performance-result', '\nTiming Analysis:');
                    log('performance-result', `DNS Lookup: ${Math.round(loginEntry.domainLookupEnd - loginEntry.domainLookupStart)}ms`);
                    log('performance-result', `TCP Connection: ${Math.round(loginEntry.connectEnd - loginEntry.connectStart)}ms`);
                    log('performance-result', `TLS Negotiation: ${Math.round(loginEntry.connectEnd - loginEntry.secureConnectionStart)}ms`);
                    log('performance-result', `Request Time: ${Math.round(loginEntry.responseStart - loginEntry.requestStart)}ms`);
                    log('performance-result', `Response Time: ${Math.round(loginEntry.responseEnd - loginEntry.responseStart)}ms`);
                    log('performance-result', `Total Duration: ${Math.round(loginEntry.duration)}ms`);
                    
                    if (loginEntry.serverTiming) {
                        log('performance-result', '\nServer Timing:');
                        loginEntry.serverTiming.forEach(timing => {
                            log('performance-result', `  ${timing.name}: ${timing.duration}ms`);
                        });
                    }
                } else {
                    log('performance-result', 'No timing data available', 'warning');
                }
            }, 500);
        }

        // Auto-run browser info on load
        window.onload = function() {
            showBrowserInfo();
            checkCookies();
        };
    </script>
</body>
</html>
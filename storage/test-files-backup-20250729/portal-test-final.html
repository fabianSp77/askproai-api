<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Portal Final Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">Business Portal Final Test</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Quick Actions -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4">Quick Actions</h2>
                <div class="space-y-3">
                    <button onclick="openPortal()" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <i class="fas fa-external-link-alt mr-2"></i>Open Business Portal
                    </button>
                    <button onclick="testFullFlow()" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        <i class="fas fa-play mr-2"></i>Run Full Test Flow
                    </button>
                    <button onclick="clearAndReset()" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                        <i class="fas fa-trash mr-2"></i>Clear Session & Reset
                    </button>
                </div>
            </div>

            <!-- Test Status -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4">Test Status</h2>
                <div class="space-y-2">
                    <div class="flex items-center justify-between">
                        <span>Authentication</span>
                        <span id="authStatus" class="text-gray-400">‚è≥ Not tested</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span>Dashboard API</span>
                        <span id="dashboardStatus" class="text-gray-400">‚è≥ Not tested</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span>Calls API</span>
                        <span id="callsStatus" class="text-gray-400">‚è≥ Not tested</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span>Billing API</span>
                        <span id="billingStatus" class="text-gray-400">‚è≥ Not tested</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span>UI Navigation</span>
                        <span id="uiStatus" class="text-gray-400">‚è≥ Not tested</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Results -->
        <div class="bg-white rounded-lg shadow p-6 mt-6">
            <h2 class="text-xl font-semibold mb-4">Test Results</h2>
            <div id="results" class="space-y-2 text-sm font-mono">
                <p class="text-gray-500">Click "Run Full Test Flow" to begin testing</p>
            </div>
        </div>

        <!-- Manual Test Instructions -->
        <div class="bg-blue-50 rounded-lg p-6 mt-6">
            <h3 class="text-lg font-semibold mb-3">Manual Test Instructions</h3>
            <ol class="list-decimal list-inside space-y-2 text-sm">
                <li>Click "Open Business Portal" to open the portal in a new tab</li>
                <li>Login with: <code class="bg-white px-2 py-1 rounded">demo@askproai.de / DemoPass123!</code></li>
                <li>Verify the dashboard loads with statistics</li>
                <li>Navigate to "Anrufe" (Calls) - should show call list</li>
                <li>Navigate to "Abrechnung" (Billing) - should show balance</li>
                <li>Click "Guthaben aufladen" to test topup modal</li>
                <li>Test filters on the Calls page</li>
                <li>Check responsive design by resizing browser</li>
            </ol>
        </div>
    </div>

    <script>
        const API_BASE = '/business/api';
        let sessionToken = null;

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                success: 'text-green-600',
                error: 'text-red-600',
                warning: 'text-yellow-600',
                info: 'text-gray-700'
            };
            
            results.innerHTML += `<div class="${colors[type]}">[${timestamp}] ${message}</div>`;
            results.scrollTop = results.scrollHeight;
        }

        function updateStatus(id, status) {
            const element = document.getElementById(id);
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                testing: 'üîÑ',
                pending: '‚è≥'
            };
            
            element.textContent = icons[status] || status;
            element.className = {
                success: 'text-green-600',
                error: 'text-red-600',
                warning: 'text-yellow-600',
                testing: 'text-blue-600',
                pending: 'text-gray-400'
            }[status] || 'text-gray-700';
        }

        async function makeRequest(url, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                ...options.headers
            };
            
            if (sessionToken) {
                headers['X-Session-Token'] = sessionToken;
            }
            
            return fetch(url, {
                ...options,
                headers,
                credentials: 'include'
            });
        }

        async function testAuth() {
            updateStatus('authStatus', 'testing');
            log('Testing authentication...', 'info');
            
            try {
                const response = await makeRequest(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    body: JSON.stringify({
                        email: 'demo@askproai.de',
                        password: 'DemoPass123!'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    sessionToken = data.data.session_token;
                    localStorage.setItem('portal_session_token', sessionToken);
                    updateStatus('authStatus', 'success');
                    log('‚úÖ Authentication successful', 'success');
                    log(`User: ${data.data.user.name} (${data.data.user.email})`, 'info');
                    return true;
                } else {
                    updateStatus('authStatus', 'error');
                    log(`‚ùå Authentication failed: ${data.message}`, 'error');
                    return false;
                }
            } catch (error) {
                updateStatus('authStatus', 'error');
                log(`‚ùå Auth error: ${error.message}`, 'error');
                return false;
            }
        }

        async function testDashboard() {
            updateStatus('dashboardStatus', 'testing');
            log('Testing dashboard API...', 'info');
            
            try {
                const response = await makeRequest(`${API_BASE}/dashboard`);
                
                if (!response.ok) {
                    log(`‚ùå Dashboard API returned status ${response.status}`, 'error');
                    try {
                        const errorData = await response.json();
                        log(`Error: ${errorData.message || errorData.error || 'Unknown error'}`, 'error');
                    } catch (e) {
                        log(`Response: ${await response.text()}`, 'error');
                    }
                    updateStatus('dashboardStatus', 'error');
                    return false;
                }
                
                const data = await response.json();
                
                if (data.stats && data.billing) {
                    updateStatus('dashboardStatus', 'success');
                    log('‚úÖ Dashboard API working', 'success');
                    log(`- Calls today: ${data.stats.calls_today}`, 'info');
                    log(`- Balance: ‚Ç¨${data.billing.current_balance}`, 'info');
                    return true;
                } else {
                    updateStatus('dashboardStatus', 'error');
                    log('‚ùå Dashboard data incomplete', 'error');
                    log(`Received data: ${JSON.stringify(data)}`, 'info');
                    return false;
                }
            } catch (error) {
                updateStatus('dashboardStatus', 'error');
                log(`‚ùå Dashboard error: ${error.message}`, 'error');
                return false;
            }
        }

        async function testCalls() {
            updateStatus('callsStatus', 'testing');
            log('Testing calls API...', 'info');
            
            try {
                const response = await makeRequest(`${API_BASE}/calls?page=1&per_page=10`);
                const data = await response.json();
                
                if (response.ok) {
                    updateStatus('callsStatus', 'success');
                    const count = Array.isArray(data) ? data.length : (data.data ? data.data.length : 0);
                    log('‚úÖ Calls API working', 'success');
                    log(`- Found ${count} calls`, 'info');
                    return true;
                } else {
                    updateStatus('callsStatus', 'error');
                    log('‚ùå Calls API failed', 'error');
                    return false;
                }
            } catch (error) {
                updateStatus('callsStatus', 'error');
                log(`‚ùå Calls error: ${error.message}`, 'error');
                return false;
            }
        }

        async function testBilling() {
            updateStatus('billingStatus', 'testing');
            log('Testing billing API...', 'info');
            
            try {
                const response = await makeRequest(`${API_BASE}/billing`);
                const data = await response.json();
                
                if (data.balance) {
                    updateStatus('billingStatus', 'success');
                    log('‚úÖ Billing API working', 'success');
                    log(`- Current balance: ‚Ç¨${data.balance.current_balance}`, 'info');
                    log(`- Bonus balance: ‚Ç¨${data.balance.bonus_balance}`, 'info');
                    return true;
                } else {
                    updateStatus('billingStatus', 'error');
                    log('‚ùå Billing data incomplete', 'error');
                    return false;
                }
            } catch (error) {
                updateStatus('billingStatus', 'error');
                log(`‚ùå Billing error: ${error.message}`, 'error');
                return false;
            }
        }

        async function testFullFlow() {
            log('Starting full test flow...', 'info');
            
            // Clear previous results
            document.getElementById('results').innerHTML = '';
            
            // Test authentication
            const authOk = await testAuth();
            if (!authOk) {
                log('‚ö†Ô∏è Stopping tests due to auth failure', 'warning');
                return;
            }
            
            // Small delay between tests
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Test APIs
            await testDashboard();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testCalls();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testBilling();
            
            // UI test is manual
            updateStatus('uiStatus', 'warning');
            log('‚ö†Ô∏è UI testing requires manual verification', 'warning');
            log('Please open the portal and test navigation manually', 'info');
            
            log('üéâ Test flow completed!', 'success');
        }

        function openPortal() {
            window.open('/business/portal', '_blank');
        }

        function clearAndReset() {
            localStorage.clear();
            sessionStorage.clear();
            sessionToken = null;
            
            // Reset all statuses
            ['authStatus', 'dashboardStatus', 'callsStatus', 'billingStatus', 'uiStatus'].forEach(id => {
                updateStatus(id, 'pending');
            });
            
            document.getElementById('results').innerHTML = '<p class="text-gray-500">Session cleared. Ready for new test.</p>';
            log('Session cleared and reset', 'info');
        }

        // Check for existing session on load
        window.addEventListener('DOMContentLoaded', () => {
            const existingToken = localStorage.getItem('portal_session_token');
            if (existingToken) {
                sessionToken = existingToken;
                log('Found existing session token', 'info');
            }
        });
    </script>
</body>
</html>
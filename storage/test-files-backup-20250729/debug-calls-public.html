<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Public Debug - Calls Page</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 { color: #333; margin-top: 0; }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        .info { color: #17a2b8; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .button-success { background: #28a745; }
        .button-success:hover { background: #218838; }
        .button-danger { background: #dc3545; }
        .button-danger:hover { background: #c82333; }
        .log-entry {
            padding: 8px;
            margin: 4px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .log-success { background: #d4edda; color: #155724; }
        .log-error { background: #f8d7da; color: #721c24; }
        .log-warning { background: #fff3cd; color: #856404; }
        .log-info { background: #d1ecf1; color: #0c5460; }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .test-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }
        .test-item.success { border-color: #28a745; background: #d4edda; }
        .test-item.error { border-color: #dc3545; background: #f8d7da; }
        .test-item.warning { border-color: #ffc107; background: #fff3cd; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üîç Public Debug Tool - Calls Page Issue</h1>
            <p>Dieses Tool analysiert, warum die Calls-Seite nicht l√§dt.</p>
            
            <div style="margin: 20px 0;">
                <button onclick="runAllTests()" class="button-success">
                    üöÄ Alle Tests ausf√ºhren
                </button>
                <button onclick="quickFix()" class="button-danger">
                    ‚ö° Quick Fix anwenden
                </button>
                <button onclick="openAdminInNewTab()">
                    üîó Admin in neuem Tab √∂ffnen
                </button>
            </div>
        </div>

        <div class="card">
            <h2>üìä Test Results</h2>
            <div id="test-results" class="grid"></div>
        </div>

        <div class="card">
            <h2>üìù Detailed Log</h2>
            <div id="log-container">
                <div class="log-entry log-info">Bereit f√ºr Tests...</div>
            </div>
        </div>

        <div class="card">
            <h2>üõ†Ô∏è Manual Fixes</h2>
            <div class="grid">
                <div class="test-item">
                    <h3>1. Browser Cache l√∂schen</h3>
                    <p>Dr√ºcke <strong>Ctrl+Shift+Delete</strong> und l√∂sche alle Daten f√ºr askproai.de</p>
                </div>
                <div class="test-item">
                    <h3>2. Console √∂ffnen</h3>
                    <p>Dr√ºcke <strong>F12</strong> und pr√ºfe auf rote Fehler</p>
                </div>
                <div class="test-item">
                    <h3>3. Hard Refresh</h3>
                    <p>Auf der Calls-Seite: <strong>Ctrl+F5</strong></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let testResults = {};
        
        function log(message, type = 'info') {
            const container = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function addTestResult(id, title, status, details) {
            const container = document.getElementById('test-results');
            let item = document.getElementById(`test-${id}`);
            
            if (!item) {
                item = document.createElement('div');
                item.id = `test-${id}`;
                item.className = 'test-item';
                container.appendChild(item);
            }
            
            item.className = `test-item ${status}`;
            item.innerHTML = `
                <h3>${title}</h3>
                <p class="${status}">${details}</p>
            `;
            
            testResults[id] = { title, status, details };
        }

        async function runAllTests() {
            log('Starting all tests...', 'info');
            document.getElementById('test-results').innerHTML = '';
            
            // Test 1: Check Livewire availability
            await testLivewire();
            
            // Test 2: Check Alpine.js
            await testAlpine();
            
            // Test 3: Check critical assets
            await testAssets();
            
            // Test 4: Check for Service Workers
            await testServiceWorkers();
            
            // Test 5: Check session/cookies
            await testSession();
            
            // Test 6: Test admin endpoint
            await testAdminEndpoint();
            
            log('All tests completed!', 'success');
        }

        async function testLivewire() {
            log('Testing Livewire...', 'info');
            
            // Create a test page that loads Livewire
            const testWindow = window.open('about:blank', 'livewire-test', 'width=1,height=1');
            testWindow.document.write(`
                <script src="/vendor/livewire/livewire.js"></script>
                <script>
                    setTimeout(() => {
                        window.opener.postMessage({
                            type: 'livewire-test',
                            loaded: typeof window.Livewire !== 'undefined'
                        }, '*');
                        window.close();
                    }, 2000);
                </script>
            `);
            
            return new Promise((resolve) => {
                const handler = (e) => {
                    if (e.data && e.data.type === 'livewire-test') {
                        window.removeEventListener('message', handler);
                        
                        if (e.data.loaded) {
                            addTestResult('livewire', 'Livewire', 'success', '‚úÖ Livewire kann geladen werden');
                            log('Livewire is available', 'success');
                        } else {
                            addTestResult('livewire', 'Livewire', 'error', '‚ùå Livewire kann nicht geladen werden');
                            log('Livewire not loading!', 'error');
                        }
                        resolve();
                    }
                };
                window.addEventListener('message', handler);
                
                // Timeout fallback
                setTimeout(() => {
                    window.removeEventListener('message', handler);
                    addTestResult('livewire', 'Livewire', 'warning', '‚ö†Ô∏è Test timeout');
                    resolve();
                }, 3000);
            });
        }

        async function testAlpine() {
            log('Testing Alpine.js...', 'info');
            
            try {
                const response = await fetch('/js/filament/support/support.js', { method: 'HEAD' });
                if (response.ok) {
                    addTestResult('alpine', 'Alpine.js', 'success', '‚úÖ Filament support.js verf√ºgbar');
                } else {
                    addTestResult('alpine', 'Alpine.js', 'error', `‚ùå Support.js: ${response.status}`);
                }
            } catch (e) {
                addTestResult('alpine', 'Alpine.js', 'error', '‚ùå Konnte nicht geladen werden');
            }
        }

        async function testAssets() {
            log('Testing critical assets...', 'info');
            
            const assets = [
                { url: '/vendor/livewire/livewire.js', name: 'Livewire JS' },
                { url: '/css/filament/filament/app.css', name: 'Filament CSS' },
                { url: '/js/filament/filament/app.js', name: 'Filament JS' }
            ];
            
            let allOk = true;
            
            for (const asset of assets) {
                try {
                    const response = await fetch(asset.url, { method: 'HEAD' });
                    if (!response.ok) {
                        allOk = false;
                        log(`${asset.name}: ${response.status}`, 'error');
                    } else {
                        log(`${asset.name}: OK`, 'success');
                    }
                } catch (e) {
                    allOk = false;
                    log(`${asset.name}: Failed`, 'error');
                }
            }
            
            addTestResult('assets', 'Critical Assets', allOk ? 'success' : 'error', 
                allOk ? '‚úÖ Alle Assets verf√ºgbar' : '‚ùå Einige Assets fehlen');
        }

        async function testServiceWorkers() {
            log('Checking for Service Workers...', 'info');
            
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                if (registrations.length > 0) {
                    addTestResult('sw', 'Service Workers', 'error', 
                        `‚ùå ${registrations.length} Service Worker aktiv!`);
                    log('Service Workers found - this can cause caching issues!', 'error');
                } else {
                    addTestResult('sw', 'Service Workers', 'success', '‚úÖ Keine Service Worker');
                }
            } else {
                addTestResult('sw', 'Service Workers', 'success', '‚úÖ Nicht unterst√ºtzt');
            }
        }

        async function testSession() {
            log('Checking session/cookies...', 'info');
            
            const cookies = document.cookie.split(';').filter(c => c.trim());
            const askproaiCookies = cookies.filter(c => c.includes('askproai'));
            
            if (askproaiCookies.length > 0) {
                addTestResult('session', 'Session/Cookies', 'success', 
                    `‚úÖ ${askproaiCookies.length} askproai Cookies gefunden`);
            } else {
                addTestResult('session', 'Session/Cookies', 'warning', 
                    '‚ö†Ô∏è Keine askproai Cookies - Login erforderlich');
            }
        }

        async function testAdminEndpoint() {
            log('Testing admin endpoint...', 'info');
            
            try {
                const response = await fetch('/admin/calls', {
                    credentials: 'include',
                    redirect: 'manual'
                });
                
                if (response.status === 200) {
                    addTestResult('endpoint', 'Admin Endpoint', 'success', '‚úÖ Calls-Seite erreichbar (200)');
                } else if (response.status === 302) {
                    addTestResult('endpoint', 'Admin Endpoint', 'warning', '‚ö†Ô∏è Redirect (302) - Login erforderlich');
                } else {
                    addTestResult('endpoint', 'Admin Endpoint', 'error', `‚ùå Status: ${response.status}`);
                }
            } catch (e) {
                addTestResult('endpoint', 'Admin Endpoint', 'error', `‚ùå Fehler: ${e.message}`);
            }
        }

        async function quickFix() {
            log('Applying quick fix...', 'warning');
            
            // 1. Clear storage
            localStorage.clear();
            sessionStorage.clear();
            log('‚úÖ Storage cleared', 'success');
            
            // 2. Unregister service workers
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (const reg of registrations) {
                    await reg.unregister();
                    log(`‚úÖ Service Worker unregistered: ${reg.scope}`, 'success');
                }
            }
            
            // 3. Clear caches
            if ('caches' in window) {
                const names = await caches.keys();
                for (const name of names) {
                    await caches.delete(name);
                    log(`‚úÖ Cache deleted: ${name}`, 'success');
                }
            }
            
            log('Quick fix applied! Please refresh the admin page.', 'success');
            
            setTimeout(() => {
                if (confirm('Fix angewendet! M√∂chtest du die Admin-Seite neu laden?')) {
                    window.open('/admin/calls', '_blank');
                }
            }, 1000);
        }

        function openAdminInNewTab() {
            window.open('/admin/calls', '_blank');
        }

        // Auto-run basic tests on load
        window.onload = () => {
            log('Debug tool loaded. Click "Alle Tests ausf√ºhren" to start.', 'info');
        };
    </script>
</body>
</html>
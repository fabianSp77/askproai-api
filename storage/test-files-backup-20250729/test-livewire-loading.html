<!DOCTYPE html>
<html>
<head>
    <title>Test Livewire Loading</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .loading { color: orange; }
        .success { color: green; }
        .error { color: red; }
        iframe { width: 100%; height: 400px; border: 1px solid #ddd; }
        .log { background: #f4f4f4; padding: 10px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>Livewire Loading Test</h1>
    
    <div class="test-section">
        <h2>Test 1: Direct Page Load</h2>
        <p>Click to test loading each page directly:</p>
        <button onclick="testPage('/admin/calls')">Test Calls</button>
        <button onclick="testPage('/admin/appointments')">Test Appointments</button>
        <button onclick="testPage('/admin/customers')">Test Customers</button>
        <button onclick="testPage('/admin/branches')">Test Branches</button>
        <div id="result1"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: Console Log Monitor</h2>
        <p>Open browser console (F12) and check for errors when loading pages.</p>
        <iframe id="testFrame" src="about:blank"></iframe>
        <div class="log" id="consoleLog"></div>
    </div>

    <div class="test-section">
        <h2>Test 3: Network Monitor</h2>
        <p>Monitor network requests:</p>
        <div class="log" id="networkLog"></div>
    </div>

    <script>
        // Capture console logs
        const log = [];
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        console.log = function() {
            log.push({type: 'log', message: Array.from(arguments).join(' ')});
            updateConsoleLog();
            originalLog.apply(console, arguments);
        };
        
        console.error = function() {
            log.push({type: 'error', message: Array.from(arguments).join(' ')});
            updateConsoleLog();
            originalError.apply(console, arguments);
        };
        
        console.warn = function() {
            log.push({type: 'warn', message: Array.from(arguments).join(' ')});
            updateConsoleLog();
            originalWarn.apply(console, arguments);
        };
        
        function updateConsoleLog() {
            const logDiv = document.getElementById('consoleLog');
            logDiv.innerHTML = log.map(entry => {
                const color = entry.type === 'error' ? 'red' : (entry.type === 'warn' ? 'orange' : 'black');
                return `<div style="color: ${color}">[${entry.type}] ${entry.message}</div>`;
            }).join('');
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        // Monitor network requests
        const networkLog = [];
        const originalFetch = window.fetch;
        window.fetch = function(url, options) {
            const startTime = Date.now();
            networkLog.push({
                url: url,
                method: options?.method || 'GET',
                startTime: startTime,
                status: 'pending'
            });
            updateNetworkLog();
            
            return originalFetch.apply(this, arguments)
                .then(response => {
                    const duration = Date.now() - startTime;
                    networkLog[networkLog.length - 1].status = response.ok ? 'success' : 'error';
                    networkLog[networkLog.length - 1].statusCode = response.status;
                    networkLog[networkLog.length - 1].duration = duration;
                    updateNetworkLog();
                    return response;
                })
                .catch(error => {
                    networkLog[networkLog.length - 1].status = 'error';
                    networkLog[networkLog.length - 1].error = error.message;
                    updateNetworkLog();
                    throw error;
                });
        };
        
        function updateNetworkLog() {
            const logDiv = document.getElementById('networkLog');
            logDiv.innerHTML = networkLog.slice(-10).map(entry => {
                const color = entry.status === 'error' ? 'red' : (entry.status === 'success' ? 'green' : 'orange');
                return `<div style="color: ${color}">
                    ${entry.method} ${entry.url} 
                    ${entry.statusCode ? `(${entry.statusCode})` : ''} 
                    ${entry.duration ? `${entry.duration}ms` : 'pending...'}
                    ${entry.error ? `Error: ${entry.error}` : ''}
                </div>`;
            }).join('');
        }
        
        function testPage(url) {
            const resultDiv = document.getElementById('result1');
            const iframe = document.getElementById('testFrame');
            
            resultDiv.innerHTML = `<p class="loading">Loading ${url}...</p>`;
            
            // Test with fetch first
            fetch(url, {
                credentials: 'same-origin',
                headers: {
                    'Accept': 'text/html',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.ok) {
                    resultDiv.innerHTML += `<p class="success">✅ ${url} returned ${response.status}</p>`;
                    // Load in iframe
                    iframe.src = url;
                    
                    // Check for Livewire
                    setTimeout(() => {
                        try {
                            if (iframe.contentWindow.Livewire) {
                                resultDiv.innerHTML += `<p class="success">✅ Livewire is loaded</p>`;
                            } else {
                                resultDiv.innerHTML += `<p class="error">❌ Livewire NOT loaded</p>`;
                            }
                        } catch (e) {
                            resultDiv.innerHTML += `<p class="error">❌ Cannot access iframe (CORS)</p>`;
                        }
                    }, 2000);
                    
                } else {
                    resultDiv.innerHTML += `<p class="error">❌ ${url} returned ${response.status}</p>`;
                }
            })
            .catch(error => {
                resultDiv.innerHTML += `<p class="error">❌ Error loading ${url}: ${error.message}</p>`;
            });
        }
        
        // Monitor for infinite loops
        let loopCount = 0;
        setInterval(() => {
            const requests = networkLog.filter(r => r.url.includes('/livewire/update')).length;
            if (requests > loopCount + 10) {
                console.error('Possible infinite loop detected! Too many Livewire requests.');
            }
            loopCount = requests;
        }, 5000);
    </script>
</body>
</html>
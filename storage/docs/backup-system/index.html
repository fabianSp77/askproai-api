<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Dokumentations-Hub - AskPro AI Gateway</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="/docs/backup-system/assets/docs-hub.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</head>
<body>
    <!-- Skip to Content -->
    <a href="#main-content" class="skip-to-content">Zum Inhalt springen</a>

    <!-- Accessibility Bar -->
    <div class="accessibility-bar" role="toolbar" aria-label="Barrierefreiheit">
        <span style="font-weight: 600;">Ansicht:</span>
        <button aria-label="Normale Schriftgr√∂√üe" title="Normale Schriftgr√∂√üe">A</button>
        <button aria-label="Gro√üe Schriftgr√∂√üe" title="Gro√üe Schriftgr√∂√üe">A+</button>
        <button aria-label="Sehr gro√üe Schriftgr√∂√üe" title="Sehr gro√üe Schriftgr√∂√üe">A++</button>
        <button aria-label="Hoher Kontrast" title="Hohen Kontrast umschalten">‚óê</button>
        <span class="keyboard-hint" style="margin-left: auto; font-size: 0.85em;">Tastatur: / = Suchen, Esc = Schlie√üen</span>
    </div><!-- accessibility-bar end -->

    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" aria-label="Men√º √∂ffnen/schlie√üen">
        <span class="icon">‚ò∞</span>
    </button>

    <!-- Mobile Backdrop -->
    <div class="mobile-backdrop" id="mobileBackdrop" aria-hidden="true"></div>

    <div class="layout">
        <aside class="sidebar" id="sidebar" role="navigation" aria-label="Hauptnavigation">
            <div class="sidebar-header">
                <h1>üìö Dokumentations-Hub</h1>
                <p>AskPro AI Gateway</p>
            </div>

            <div class="search-box">
                <input type="text" id="searchInput" placeholder="üîç Dokumentation durchsuchen..." aria-label="Suche" />
                <button class="search-clear" id="searchClear" aria-label="Suche l√∂schen">‚úï</button>
            </div>

            <div class="search-results-count" id="searchResultsCount" role="status" aria-live="polite"></div>

            <nav>
                <div class="nav-section">
                    <div class="nav-section-title">Schnellzugriff</div>
                    <a href="#status" class="nav-link" data-section="status">
                        <span class="icon">üìä</span>
                        <span>System-Status</span>
                    </a>
                    <a href="/docs/backup-system/documentation-index.html" class="nav-link">
                        <span class="icon">üìö</span>
                        <span>Dokumentations-Index</span>
                    </a>
                    <a href="/docs/backup-system/E2E_DEPLOYMENT_ROLLOUT_PLAN_2025-11-02_1900.html" class="nav-link" target="_blank">
                        <span class="icon">üöÄ</span>
                        <span>E2E Deployment Rollout-Plan (State-of-the-Art)</span>
                    </a>
                    <a href="/docs/backup-system/E2E_DEPLOYMENT_COMPLETE_DOCUMENTATION.html" class="nav-link" target="_blank">
                        <span class="icon">üìö</span>
                        <span>E2E Deployment - Alle Dokumente</span>
                    </a>
                    <a href="/docs/backup-system/E2E_FRISEUR1_CONFIGURATION/index.html" class="nav-link" target="_blank">
                        <span class="icon">üíà</span>
                        <span>E2E Friseur 1 - Interaktives Dashboard</span>
                    </a>
                    <a href="/docs/backup-system/Zero-Loss-Backups-and-Deployment.pdf" class="nav-link" target="_blank">
                        <span class="icon">üìÑ</span>
                        <span>Backup-Dokumentation (PDF)</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Kategorien</div>
                    <div id="navLinks"></div>
                </div>
            </nav>
        </aside>

        <main class="main-content" id="main-content" role="main">
            <nav class="breadcrumbs" aria-label="Breadcrumb">
                <a href="/">Start</a>
                <span class="separator">‚Ä∫</span>
                <a href="/docs/backup-system">Backup-System</a>
                <span class="separator">‚Ä∫</span>
                <span>Dokumentation</span>
            </nav>

            <div id="status" class="status-dashboard" role="region" aria-label="System-Status">
                <div class="status-card healthy">
                    <div class="status-icon">‚úÖ</div>
                    <h3>System-Status</h3>
                    <div class="status-value">Gesund</div>
                    <div class="status-detail">Alle Systeme funktionieren normal</div>
                </div>

                <div class="status-card info">
                    <div class="status-icon">üíæ</div>
                    <h3>Letztes Backup</h3>
                    <div class="status-value" id="lastBackupValue">L√§dt...</div>
                    <div class="status-detail" id="lastBackupDetail">-</div>
                </div>

                <div class="status-card upcoming">
                    <div class="status-icon">üìÖ</div>
                    <h3>N√§chstes Backup</h3>
                    <div class="status-value" id="nextBackupValue">L√§dt...</div>
                    <div class="status-detail" id="nextBackupDetail">-</div>
                </div>

                <div class="status-card metric">
                    <div class="status-icon">üìä</div>
                    <h3>Binlog-Status</h3>
                    <div class="status-value" id="binlogValue">L√§dt...</div>
                    <div class="status-detail">Letztes Log-Eintrag</div>
                </div>
            </div>

            <!-- Incident History Section -->
            <div id="incidents-section" class="incidents-section" style="margin: 2rem 0; display: none;">
                <h2 style="color: var(--text-main); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span>üö®</span> Incident History
                    <span id="incident-badge" class="incident-badge" style="display: none;"></span>
                </h2>
                <div id="incidents-container">
                    <p style="color: var(--text-secondary);">Lade Incident-Historie...</p>
                </div>
            </div>

            <div class="quick-actions">
                <button class="quick-action-btn">
                    <span>‚ñº</span> Alle erweitern
                </button>
                <button class="quick-action-btn">
                    <span>‚ñ≤</span> Alle zuklappen
                </button>
                <button class="quick-action-btn">
                    <span>üñ®</span> Druckansicht
                </button>
            </div>

            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Dokumentation wird geladen...</p>
            </div>

            <!-- Latest Reports Section -->
            <div id="latest-reports" style="display:none;">
                <div class="section-header" style="margin-bottom: 1.5rem;">
                    <h2 style="display: flex; align-items: center; gap: 0.5rem; color: var(--primary);">
                        <span class="mdi mdi-clock-outline"></span>
                        <span>Neueste Reports</span>
                    </h2>
                    <p style="color: var(--text-secondary); font-size: 0.9em; margin-top: 0.5rem;">
                        Die aktuellsten Dokumentationen und Validierungsberichte auf einen Blick
                    </p>
                </div>
                <div id="latest-reports-grid" class="file-grid"></div>
                <hr style="margin: 2rem 0; border: none; border-top: 2px solid var(--border);">
            </div>

            <div id="categories" style="display:none;"></div>
        </main>
    </div>

    <!-- Back to Top Button -->
    <button class="back-to-top" id="backToTop" aria-label="Nach oben">
        ‚Üë
    </button>

    <div class="copy-tooltip" id="copyTooltip" role="status" aria-live="polite">‚úì Kopiert!</div>

    <script>
        // Initialize Mermaid
        mermaid.initialize({ startOnLoad: true, theme: 'default' });

        let allFiles = [];
        let expandedCategories = new Set();

        // German date/time formatter
        function formatGermanDate(timestamp) {
            const date = new Date(timestamp * 1000);
            return new Intl.DateTimeFormat('de-DE', {
                day: 'numeric',
                month: 'long',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                timeZone: 'Europe/Berlin'
            }).format(date) + ' Uhr';
        }

        // Relative time in German
        function formatRelativeTime(timestamp) {
            const now = new Date();
            const date = new Date(timestamp * 1000);
            const diff = now - date;
            const absDiff = Math.abs(diff);
            const minutes = Math.floor(absDiff / 60000);
            const hours = Math.floor(absDiff / 3600000);
            const days = Math.floor(absDiff / 86400000);

            // Future times (diff < 0)
            if (diff < 0) {
                if (minutes < 1) return 'in wenigen Sekunden';
                if (minutes < 60) return `in ${minutes} ${minutes === 1 ? 'Minute' : 'Minuten'}`;
                if (hours < 24) return `in ${hours} ${hours === 1 ? 'Stunde' : 'Stunden'}`;
                if (days < 30) return `in ${days} ${days === 1 ? 'Tag' : 'Tagen'}`;
                return formatGermanDate(timestamp);
            }

            // Past times (diff >= 0)
            if (minutes < 1) return 'gerade eben';
            if (minutes < 60) return `vor ${minutes} ${minutes === 1 ? 'Minute' : 'Minuten'}`;
            if (hours < 24) return `vor ${hours} ${hours === 1 ? 'Stunde' : 'Stunden'}`;
            if (days < 30) return `vor ${days} ${days === 1 ? 'Tag' : 'Tagen'}`;
            return formatGermanDate(timestamp);
        }

        // Estimate reading time
        function estimateReadingTime(size) {
            const wordsPerMinute = 200;
            const words = size / 5; // Rough estimate: 5 chars per word
            const minutes = Math.ceil(words / wordsPerMinute);
            return `${minutes} Min. Lesezeit`;
        }

        // Safe date parsing helper
        function safeParseDate(dateString) {
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    console.error('Invalid date:', dateString);
                    return null;
                }
                // Return Unix timestamp in seconds (not milliseconds) for consistency
                return Math.floor(date.getTime() / 1000);
            } catch (e) {
                console.error('Date parsing error:', e, dateString);
                return null;
            }
        }

        // Load status from API
        async function loadStatus() {
            try {
                const res = await fetch('/docs/backup-system/status.json', {
                    credentials: 'include'
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                // Parse last backup timestamp (ISO-8601 string)
                if (data.last_backup?.timestamp) {
                    const timestamp = safeParseDate(data.last_backup.timestamp);
                    if (timestamp) {
                        document.getElementById('lastBackupValue').textContent = formatRelativeTime(timestamp);
                        document.getElementById('lastBackupDetail').textContent = formatGermanDate(timestamp);
                    } else {
                        document.getElementById('lastBackupValue').textContent = 'Fehler beim Laden';
                        document.getElementById('lastBackupDetail').textContent = 'Ung√ºltiges Datum';
                    }
                }

                // Parse next backup timestamp (ISO-8601 string)
                if (data.next_backup_localtime) {
                    const timestamp = safeParseDate(data.next_backup_localtime);
                    if (timestamp) {
                        document.getElementById('nextBackupValue').textContent = formatRelativeTime(timestamp);
                        document.getElementById('nextBackupDetail').textContent = formatGermanDate(timestamp);
                    } else {
                        document.getElementById('nextBackupValue').textContent = data.next_backup_localtime;
                        document.getElementById('nextBackupDetail').textContent = 'Geplant';
                    }
                }

                // Binlog status
                if (data.binlog?.last_file) {
                    document.getElementById('binlogValue').textContent = data.binlog.last_file;

                    // Parse binlog timestamp if available
                    if (data.binlog?.timestamp) {
                        const timestamp = safeParseDate(data.binlog.timestamp);
                        if (timestamp) {
                            const detail = document.getElementById('binlogDetail');
                            if (detail) {
                                detail.textContent = formatGermanDate(timestamp);
                            }
                        }
                    }
                }
            } catch (e) {
                console.error('Status load error:', e);
                document.getElementById('lastBackupValue').textContent = 'Nicht verf√ºgbar';
                document.getElementById('nextBackupValue').textContent = 'Nicht verf√ºgbar';
                document.getElementById('binlogValue').textContent = 'Nicht verf√ºgbar';
            }
        }

        // Load incidents from API
        async function loadIncidents() {
            try {
                const res = await fetch('/docs/backup-system/api/incidents', {
                    credentials: 'include'
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                const container = document.getElementById('incidents-container');
                const section = document.getElementById('incidents-section');
                const badge = document.getElementById('incident-badge');

                if (!data.incidents || data.incidents.length === 0) {
                    container.innerHTML = '<p style="color: var(--success); padding: 2rem; text-align: center; font-size: 1.2em;">‚úÖ Keine Incidents - System l√§uft stabil</p>';
                    section.style.display = 'block';
                    return;
                }

                // Separate open and resolved
                const openIncidents = data.incidents.filter(i => i.status === 'open');
                const resolvedIncidents = data.incidents.filter(i => i.status === 'resolved');

                // Group by category
                const groupByCategory = (incidents) => {
                    const groups = {};
                    incidents.forEach(inc => {
                        if (!groups[inc.category]) groups[inc.category] = [];
                        groups[inc.category].push(inc);
                    });
                    return groups;
                };

                // Sort by severity (Critical > High > Medium > Low > Info)
                const severityOrder = { critical: 0, high: 1, medium: 2, low: 3, info: 4 };
                const sortBySeverity = (a, b) => severityOrder[a.severity] - severityOrder[b.severity];

                let html = '';

                // Stats
                const stats = data.stats || {};
                html += '<div class="incident-stats">';
                html += `<div class="incident-stat"><div class="incident-stat-value">${openIncidents.length}</div><div class="incident-stat-label">üî¥ Open</div></div>`;
                html += `<div class="incident-stat"><div class="incident-stat-value" style="color: #dc2626;">${stats.critical || 0}</div><div class="incident-stat-label">Critical</div></div>`;
                html += `<div class="incident-stat"><div class="incident-stat-value" style="color: #ea580c;">${stats.high || 0}</div><div class="incident-stat-label">High</div></div>`;
                html += `<div class="incident-stat"><div class="incident-stat-value" style="color: #f59e0b;">${stats.medium || 0}</div><div class="incident-stat-label">Medium</div></div>`;
                html += `<div class="incident-stat"><div class="incident-stat-value">${resolvedIncidents.length}</div><div class="incident-stat-label">‚úÖ Resolved</div></div>`;
                html += '</div>';

                // Function to render incident card
                const renderIncident = (inc) => {
                    const timestamp = new Date(inc.timestamp);
                    const severityIcon = {
                        'critical': 'üî¥',
                        'high': 'üü†',
                        'medium': 'üü°',
                        'low': 'üîµ',
                        'info': 'üü¢'
                    }[inc.severity] || '‚ö™';

                    const statusBadge = inc.status === 'resolved'
                        ? '<span class="incident-status-badge resolved">‚úÖ RESOLVED</span>'
                        : '<span class="incident-status-badge open">üîÑ OPEN</span>';

                    return `
                        <div class="incident-card ${inc.severity} ${inc.status === 'resolved' ? 'resolved-incident' : 'open-incident'}">
                            <div class="incident-header">
                                <div class="incident-title">${severityIcon} ${inc.title}</div>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    ${statusBadge}
                                    <span class="incident-severity ${inc.severity}">${inc.severity}</span>
                                </div>
                            </div>
                            <div class="incident-meta">
                                <span>üìÖ ${formatGermanDate(Math.floor(timestamp.getTime() / 1000))}</span>
                                <span>üè∑Ô∏è ${inc.category}</span>
                                <span>üÜî ${inc.id}</span>
                            </div>
                            <div class="incident-description">${inc.description}</div>
                            ${inc.resolution ? `
                                <div class="incident-resolution">
                                    <strong>‚úÖ Resolution:</strong> ${inc.resolution}
                                </div>
                            ` : ''}
                            ${inc.verification ? `
                                <div class="incident-verification">
                                    <strong>üîç Verification:</strong><br>
                                    <code>${inc.verification}</code>
                                </div>
                            ` : ''}
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                                <a href="/docs/backup-system/incidents/${inc.id}.md" target="_blank" class="incident-md-link">
                                    üìÑ Markdown f√ºr KI-Analyse
                                </a>
                                <span style="margin-left: 0.5rem; color: var(--text-secondary); font-size: 0.85em;">
                                    (Zum Kopieren & Teilen mit KI)
                                </span>
                            </div>
                        </div>
                    `;
                };

                // OPEN INCIDENTS - Prominent display
                if (openIncidents.length > 0) {
                    html += '<div class="incidents-section-header open-header">';
                    html += '<h3>üö® Active Incidents</h3>';
                    html += `<span class="incident-count-badge open-badge">${openIncidents.length} Open</span>`;
                    html += '</div>';

                    // Group by category
                    const openByCategory = groupByCategory(openIncidents);
                    Object.keys(openByCategory).sort().forEach(category => {
                        const categoryIncidents = openByCategory[category].sort(sortBySeverity);

                        html += `<div class="incident-category-group">`;
                        html += `<div class="category-badge">${category}</div>`;
                        categoryIncidents.forEach(inc => {
                            html += renderIncident(inc);
                        });
                        html += '</div>';
                    });
                } else {
                    html += '<div class="no-incidents-message">';
                    html += '<span style="font-size: 3em;">‚úÖ</span>';
                    html += '<h3>Keine aktiven Probleme</h3>';
                    html += '<p>Alle Systeme funktionieren normal</p>';
                    html += '</div>';
                }

                // RESOLVED INCIDENTS - Collapsed by default
                if (resolvedIncidents.length > 0) {
                    html += '<div class="incidents-section-header resolved-header" style="margin-top: 2rem; cursor: pointer;">';
                    html += '<h3>üìã Resolved Incidents</h3>';
                    html += `<div style="display: flex; align-items: center; gap: 1rem;">`;
                    html += `<span class="incident-count-badge resolved-badge">${resolvedIncidents.length} Resolved</span>`;
                    html += '<span class="toggle-icon" id="resolved-toggle">‚ñº</span>';
                    html += '</div>';
                    html += '</div>';

                    html += '<div id="resolved-incidents" style="display: none; margin-top: 1rem;">';

                    // Group by category
                    const resolvedByCategory = groupByCategory(resolvedIncidents.slice(0, 20)); // Show last 20
                    Object.keys(resolvedByCategory).sort().forEach(category => {
                        const categoryIncidents = resolvedByCategory[category].sort(sortBySeverity);

                        html += `<div class="incident-category-group">`;
                        html += `<div class="category-badge resolved">${category}</div>`;
                        categoryIncidents.forEach(inc => {
                            html += renderIncident(inc);
                        });
                        html += '</div>';
                    });

                    html += '</div>';
                }

                container.innerHTML = html;

                // Show badge for open critical/high incidents
                const openCritical = openIncidents.filter(i => i.severity === 'critical' || i.severity === 'high').length;
                if (openCritical > 0) {
                    badge.textContent = `${openCritical} critical`;
                    badge.style.display = 'inline-block';
                }

                section.style.display = 'block';
            } catch (e) {
                console.error('Incidents load error:', e);
                const container = document.getElementById('incidents-container');
                if (container) {
                    container.innerHTML = '<p style="color: var(--danger);">Fehler beim Laden der Incident-Historie</p>';
                }
            }
        }

        // Toggle resolved incidents visibility
        function toggleResolved() {
            const resolvedSection = document.getElementById('resolved-incidents');
            const toggleIcon = document.getElementById('resolved-toggle');

            if (resolvedSection.style.display === 'none') {
                resolvedSection.style.display = 'block';
                toggleIcon.textContent = '‚ñ≤';
            } else {
                resolvedSection.style.display = 'none';
                toggleIcon.textContent = '‚ñº';
            }
        }

        // Load files from API
        async function loadFiles() {
            try {
                const res = await fetch('/docs/backup-system/api/files', {
                    credentials: 'include'
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                const data = await res.json();
                allFiles = data.files;
                renderLatestReports(allFiles);
                renderCategories(allFiles);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('latest-reports').style.display = 'block';
                document.getElementById('categories').style.display = 'block';

                handleHashNavigation();
                restoreExpandedState();
            } catch (e) {
                console.error('Files load error:', e);
                document.getElementById('loading').innerHTML = `
                    <p style="color:var(--danger);">Laden fehlgeschlagen: ${e.message}. Bitte Seite neu laden.</p>
                `;
            }
        }

        // Render latest reports section
        function renderLatestReports(files) {
            // Filter for actual documentation files (HTML/MD), exclude index and non-docs
            const docFiles = files.filter(f =>
                (f.type === 'html' || f.type === 'md') &&
                !f.title.toLowerCase().includes('index') &&
                f.category !== 'Hub & Index'
            );

            // Sort by modification time (newest first) and take top 8
            const latestFiles = docFiles
                .sort((a, b) => b.mtime - a.mtime)
                .slice(0, 8);

            if (latestFiles.length === 0) {
                document.getElementById('latest-reports').style.display = 'none';
                return;
            }

            const latestHtml = latestFiles.map(file => {
                // Highlight E2E reports
                const isE2E = file.category === 'E2E Validation Reports';
                const cardClass = isE2E ? 'card-highlight' : '';

                return renderCard(file, cardClass);
            }).join('');

            document.getElementById('latest-reports-grid').innerHTML = latestHtml;
        }

        // Render categories
        function renderCategories(files) {
            const cats = [...new Set(files.map(f => f.category))].sort();
            const icons = {
                'Hub & Index': 'üè†',
                'Executive / Management': 'üëî',
                'E2E Validation Reports': '‚úÖ',
                'Backup & PITR': 'üíæ',
                'Deployment & Gates': 'üöÄ',
                'Testing & Validation': 'üß™',
                'E-Mail & Notifications': 'üìß',
                'Incident Reports & Fixes': 'üî•',
                'Security & Access': 'üîí',
                'UX & Documentation': 'üé®',
                'Validierung & Reports': '‚úÖ',
                'Other': 'üìÑ'
            };

            const categoriesHtml = cats.map(cat => {
                const catFiles = files.filter(f => f.category === cat);
                const catId = categoryToId(cat);
                const isExpanded = expandedCategories.has(catId);

                return `
                    <div class="category-section" id="cat-${catId}">
                        <div class="category-header" data-category-id="${catId}" role="button" tabindex="0" aria-expanded="${isExpanded}">
                            <h2>
                                <span class="icon">${icons[cat] || 'üìÑ'}</span>
                                <span>${cat}</span>
                                <span class="badge">${catFiles.length}</span>
                            </h2>
                            <span class="toggle-icon ${isExpanded ? 'expanded' : ''}">‚ñº</span>
                        </div>
                        <div class="category-content ${isExpanded ? 'expanded' : ''}" id="content-${catId}">
                            <div class="file-grid">${catFiles.map(renderCard).join('')}</div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('categories').innerHTML = categoriesHtml;
            updateNavLinks(cats, icons);
        }

        // Convert category name to valid ID
        function categoryToId(cat) {
            return cat.toLowerCase()
                .replace(/\s+/g, '-')
                .replace(/[^a-z0-9-]/g, '')
                .replace(/^-+|-+$/g, '');
        }

        // Update navigation links
        function updateNavLinks(categories, icons) {
            const navHtml = categories.map(cat => {
                const catId = categoryToId(cat);
                const catFiles = allFiles.filter(f => f.category === cat);

                return `
                    <a href="#${catId}" class="nav-link" data-section="${catId}">
                        <span class="icon">${icons[cat] || 'üìÑ'}</span>
                        <span>${cat}</span>
                        <span class="count">${catFiles.length}</span>
                    </a>
                `;
            }).join('');

            document.getElementById('navLinks').innerHTML = navHtml;
        }

        // Format date for display (short German format)
        function formatShortDate(timestamp) {
            const date = new Date(timestamp * 1000);
            return new Intl.DateTimeFormat('de-DE', {
                day: 'numeric',
                month: 'short',
                year: 'numeric',
                timeZone: 'Europe/Berlin'
            }).format(date);
        }

        // Get age badge based on days
        function getAgeBadge(ageDays) {
            if (ageDays <= 7) {
                return '<span class="badge" style="background: var(--green);">üÜï Neu</span>';
            } else if (ageDays > 90) {
                return '<span class="badge" style="background: var(--warning); color: #333;">‚ö†Ô∏è Veraltet</span>';
            }
            return '';
        }

        // Render file card
        function renderCard(f, additionalClass = '') {
            const kb = (f.size / 1024).toFixed(1);
            const modifiedDate = formatShortDate(f.mtime);
            const createdDate = formatShortDate(f.ctime);
            const relativeDate = formatRelativeTime(f.mtime);
            const sha = f.sha256.substring(0, 12) + '...';
            const fileIcon = getFileIcon(f.type);
            const readingTime = estimateReadingTime(f.size);
            const ageBadge = getAgeBadge(f.age_days);

            // Determine which timestamp to show
            const isHtml = f.type === 'html';
            const timestampLabel = isHtml ? 'Erstellt' : 'Aktualisiert';
            const timestampDate = isHtml ? createdDate : modifiedDate;
            const fullDate = isHtml ? formatGermanDate(f.ctime) : formatGermanDate(f.mtime);

            return `
                <article class="file-card ${additionalClass}">
                    <div class="file-card-header">
                        <div class="file-card-badges">
                            ${ageBadge}
                        </div>
                    </div>
                    <h3 class="file-card-title">${fileIcon} ${f.title}</h3>
                    <div class="file-card-meta">
                        <span>üì¶ ${kb} KB</span>
                        <span class="tooltip">
                            üìÖ ${relativeDate}
                            <span class="tooltip-text">${fullDate}</span>
                        </span>
                        <span class="reading-time">‚è±Ô∏è ${readingTime}</span>
                    </div>
                    <div class="file-card-meta" style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border);">
                        <span class="tooltip" style="font-weight: 500; color: var(--text-main);">
                            üìÜ ${timestampLabel}: ${timestampDate}
                            <span class="tooltip-text">${fullDate}</span>
                        </span>
                    </div>
                    <div class="file-card-meta">
                        <span class="tooltip" title="${f.sha256}">üîê ${sha}</span>
                    </div>
                    <div class="file-card-actions">
                        <a href="/docs/backup-system/${f.path}" class="btn btn-primary" target="_blank">
                            üìÑ √ñffnen
                        </a>
                        ${f.type === 'pdf' ? `
                            <button class="btn btn-secondary" data-href="/docs/backup-system/${f.path}">
                                üìï PDF anzeigen
                            </button>
                        ` : ''}
                        <button class="btn btn-copy" data-copy-text="https://api.askproai.de/docs/backup-system/${f.path}" data-copy-message="URL kopiert!">
                            üìã URL kopieren
                        </button>
                        <button class="btn btn-copy" data-copy-text="${f.sha256}" data-copy-message="SHA256 kopiert!">
                            üîê SHA256
                        </button>
                    </div>
                </article>
            `;
        }

        // Get file icon based on extension
        function getFileIcon(ext) {
            const icons = {
                'pdf': 'üìï',
                'md': 'üìù',
                'html': 'üåê',
                'json': 'üìä',
                'txt': 'üìÑ',
                'log': 'üìã'
            };
            return icons[ext] || 'üìÑ';
        }

        // Toggle category
        function toggleCategory(catId) {
            const content = document.getElementById(`content-${catId}`);
            const header = document.querySelector(`#cat-${catId} .category-header`);
            const icon = document.querySelector(`#cat-${catId} .toggle-icon`);

            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.classList.remove('expanded');
                header.setAttribute('aria-expanded', 'false');
                expandedCategories.delete(catId);
            } else {
                content.classList.add('expanded');
                icon.classList.add('expanded');
                header.setAttribute('aria-expanded', 'true');
                expandedCategories.add(catId);
            }

            saveExpandedState();
        }

        // Expand all categories
        function expandAll() {
            document.querySelectorAll('.category-content').forEach(content => {
                content.classList.add('expanded');
            });
            document.querySelectorAll('.toggle-icon').forEach(icon => {
                icon.classList.add('expanded');
            });
            document.querySelectorAll('.category-header').forEach(header => {
                header.setAttribute('aria-expanded', 'true');
            });

            document.querySelectorAll('.category-section').forEach(section => {
                const catId = section.id.replace('cat-', '');
                expandedCategories.add(catId);
            });

            saveExpandedState();
        }

        // Collapse all categories
        function collapseAll() {
            document.querySelectorAll('.category-content').forEach(content => {
                content.classList.remove('expanded');
            });
            document.querySelectorAll('.toggle-icon').forEach(icon => {
                icon.classList.remove('expanded');
            });
            document.querySelectorAll('.category-header').forEach(header => {
                header.setAttribute('aria-expanded', 'false');
            });

            expandedCategories.clear();
            saveExpandedState();
        }

        // Save expanded state to sessionStorage
        function saveExpandedState() {
            sessionStorage.setItem('expandedCategories', JSON.stringify([...expandedCategories]));
        }

        // Restore expanded state from sessionStorage
        function restoreExpandedState() {
            try {
                const saved = sessionStorage.getItem('expandedCategories');
                if (saved) {
                    expandedCategories = new Set(JSON.parse(saved));
                }
            } catch (e) {
                console.error('Failed to restore expanded state:', e);
            }
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', e => {
            const q = e.target.value.toLowerCase().trim();
            const clearBtn = document.getElementById('searchClear');
            const resultsCount = document.getElementById('searchResultsCount');

            if (q) {
                clearBtn.classList.add('visible');
            } else {
                clearBtn.classList.remove('visible');
            }

            if (q) {
                const filtered = allFiles.filter(f =>
                    f.title.toLowerCase().includes(q) ||
                    f.description.toLowerCase().includes(q) ||
                    f.filename.toLowerCase().includes(q) ||
                    f.category.toLowerCase().includes(q)
                );

                renderCategories(filtered);

                resultsCount.textContent = `${filtered.length} ${filtered.length === 1 ? 'Ergebnis' : 'Ergebnisse'} gefunden`;
                resultsCount.classList.add('visible');

                if (filtered.length > 0) {
                    setTimeout(expandAll, 100);
                }
            } else {
                renderCategories(allFiles);
                resultsCount.classList.remove('visible');
            }
        });

        // Clear search
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchClear').classList.remove('visible');
            document.getElementById('searchResultsCount').classList.remove('visible');
            renderCategories(allFiles);
        }

        // Copy to clipboard with feedback
        function copyText(text, event, message = 'Kopiert!') {
            navigator.clipboard.writeText(text).then(() => {
                const tooltip = document.getElementById('copyTooltip');
                tooltip.textContent = message;
                tooltip.style.left = event.pageX + 'px';
                tooltip.style.top = (event.pageY - 40) + 'px';
                tooltip.classList.add('show');
                setTimeout(() => tooltip.classList.remove('show'), 2000);
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('Kopieren fehlgeschlagen');
            });
        }

        // Smooth scroll to section
        function scrollToSection(sectionId) {
            const element = document.getElementById(`cat-${sectionId}`) || document.getElementById(sectionId);
            if (element) {
                element.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });

                if (sectionId !== 'status') {
                    const content = document.getElementById(`content-${sectionId}`);
                    const icon = document.querySelector(`#cat-${sectionId} .toggle-icon`);
                    const header = document.querySelector(`#cat-${sectionId} .category-header`);

                    if (content && !content.classList.contains('expanded')) {
                        content.classList.add('expanded');
                        icon.classList.add('expanded');
                        header.setAttribute('aria-expanded', 'true');
                        expandedCategories.add(sectionId);
                        saveExpandedState();
                    }
                }
            }
        }

        // Handle hash navigation
        function handleHashNavigation() {
            const hash = window.location.hash.slice(1);
            if (hash) {
                setTimeout(() => scrollToSection(hash), 300);
            }
        }

        // Update active nav link on scroll
        function updateActiveNavLink() {
            const sections = document.querySelectorAll('.category-section, #status');
            let currentSection = '';

            sections.forEach(section => {
                const rect = section.getBoundingClientRect();
                if (rect.top <= 200 && rect.bottom > 200) {
                    currentSection = section.id.replace('cat-', '');
                }
            });

            document.querySelectorAll('.nav-link').forEach(link => {
                const section = link.dataset.section;
                if (section === currentSection) {
                    link.classList.add('active');
                    link.setAttribute('aria-current', 'page');
                } else {
                    link.classList.remove('active');
                    link.removeAttribute('aria-current');
                }
            });
        }

        // Back to top button
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Show/hide back to top button
        window.addEventListener('scroll', () => {
            const backToTop = document.getElementById('backToTop');
            if (window.scrollY > 300) {
                backToTop.classList.add('visible');
            } else {
                backToTop.classList.remove('visible');
            }

            updateActiveNavLink();
        });

        // Handle hash changes
        window.addEventListener('hashchange', handleHashNavigation);

        // Mobile menu toggle
        // Focus trap variables
        let focusTrapActive = false;
        let firstFocusableElement = null;
        let lastFocusableElement = null;

        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('mobileBackdrop');
            const isOpening = !sidebar.classList.contains('open');

            sidebar.classList.toggle('open');
            backdrop.classList.toggle('visible');
            backdrop.setAttribute('aria-hidden', isOpening ? 'false' : 'true');

            if (isOpening) {
                // Setup focus trap
                const focusableElements = sidebar.querySelectorAll(
                    'a[href], button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
                );

                if (focusableElements.length > 0) {
                    firstFocusableElement = focusableElements[0];
                    lastFocusableElement = focusableElements[focusableElements.length - 1];
                    focusTrapActive = true;

                    // Focus first element
                    setTimeout(() => firstFocusableElement.focus(), 100);
                }

                // Prevent body scroll
                document.body.style.overflow = 'hidden';
            } else {
                // Remove focus trap
                focusTrapActive = false;
                document.body.style.overflow = '';
            }
        }

        // Close mobile menu when clicking nav link
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('nav-link') && window.innerWidth <= 992) {
                const sidebar = document.getElementById('sidebar');
                const backdrop = document.getElementById('mobileBackdrop');
                sidebar.classList.remove('open');
                backdrop.classList.remove('visible');
                backdrop.setAttribute('aria-hidden', 'true');
                focusTrapActive = false;
                document.body.style.overflow = '';
            }
        });

        // Close mobile menu when clicking backdrop
        document.getElementById('mobileBackdrop').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('open')) {
                toggleMobileMenu();
            }
        });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            // Focus trap for mobile menu
            if (focusTrapActive && e.key === 'Tab') {
                if (e.shiftKey) {
                    // Shift + Tab (backwards)
                    if (document.activeElement === firstFocusableElement) {
                        e.preventDefault();
                        lastFocusableElement.focus();
                    }
                } else {
                    // Tab (forwards)
                    if (document.activeElement === lastFocusableElement) {
                        e.preventDefault();
                        firstFocusableElement.focus();
                    }
                }
            }

            // / key to focus search
            if (e.key === '/' && !['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }

            // Escape to clear search or close mobile menu
            if (e.key === 'Escape') {
                const searchInput = document.getElementById('searchInput');
                const sidebar = document.getElementById('sidebar');
                const backdrop = document.getElementById('mobileBackdrop');

                if (searchInput.value) {
                    clearSearch();
                } else if (window.innerWidth <= 992 && sidebar.classList.contains('open')) {
                    sidebar.classList.remove('open');
                    backdrop.classList.remove('visible');
                    backdrop.setAttribute('aria-hidden', 'true');
                    focusTrapActive = false;
                    document.body.style.overflow = '';
                }
            }

            // Enter key on category headers
            if (e.key === 'Enter' && e.target.classList.contains('category-header')) {
                e.target.click();
            }
        });

        // Handle navigation link clicks
        document.addEventListener('click', (e) => {
            if (e.target.closest('.nav-link')) {
                e.preventDefault();
                const href = e.target.closest('.nav-link').getAttribute('href');
                const sectionId = href.slice(1);

                window.location.hash = sectionId;
                scrollToSection(sectionId);
            }
        });

        // Accessibility functions
        function adjustFontSize(size) {
            document.body.classList.remove('font-large', 'font-xlarge');
            if (size === 'large') document.body.classList.add('font-large');
            if (size === 'xlarge') document.body.classList.add('font-xlarge');
            localStorage.setItem('fontSize', size);
        }

        function toggleHighContrast() {
            document.body.classList.toggle('high-contrast');
            const enabled = document.body.classList.contains('high-contrast');
            localStorage.setItem('highContrast', enabled);
        }

        // Restore accessibility preferences
        window.addEventListener('DOMContentLoaded', () => {
            const fontSize = localStorage.getItem('fontSize');
            if (fontSize) adjustFontSize(fontSize);

            const highContrast = localStorage.getItem('highContrast');
            if (highContrast === 'true') document.body.classList.add('high-contrast');
        });

        // Initialize
        loadStatus();
        loadFiles();
        loadIncidents();

        // Update status every 5 minutes
        setInterval(loadStatus, 5 * 60 * 1000);

        // ================================================================
        // Session Timeout Management (P0 FIX - 2025-11-02)
        // ================================================================
        // Prevents users from losing work due to silent 30-minute timeout
        // Shows warning modal 5 minutes before session expires
        // ================================================================

        const SESSION_TIMEOUT = 30 * 60 * 1000; // 30 minutes
        const WARNING_TIME = 25 * 60 * 1000;    // 25 minutes (5 min warning)
        let sessionWarningTimer = null;
        let sessionTimeoutTimer = null;

        function resetSessionTimers() {
            clearTimeout(sessionWarningTimer);
            clearTimeout(sessionTimeoutTimer);

            sessionWarningTimer = setTimeout(showSessionWarning, WARNING_TIME);
            sessionTimeoutTimer = setTimeout(handleSessionTimeout, SESSION_TIMEOUT);
        }

        function showSessionWarning() {
            // Remove existing modal if present
            const existing = document.getElementById('session-warning-modal');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = 'session-warning-modal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">‚è±Ô∏è</div>
                        <h2 style="color: #2d3748; margin-bottom: 1rem; font-size: 1.5rem;">Sitzung l√§uft ab</h2>
                        <p style="color: #4a5568; margin-bottom: 1.5rem; line-height: 1.6;">Ihre Sitzung l√§uft in <strong>5 Minuten</strong> ab. M√∂chten Sie angemeldet bleiben?</p>
                        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                            <button id="extend-session-btn" style="background: #667eea; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; min-height: 44px; min-width: 140px; transition: all 0.2s;">
                                <span style="display: flex; align-items: center; gap: 0.5rem; justify-content: center;">
                                    <span>üîÑ</span>
                                    <span>Verl√§ngern</span>
                                </span>
                            </button>
                            <button id="logout-now-btn" style="background: #e74c3c; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; min-height: 44px; min-width: 140px; transition: all 0.2s;">
                                <span style="display: flex; align-items: center; gap: 0.5rem; justify-content: center;">
                                    <span>üö™</span>
                                    <span>Abmelden</span>
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Event listeners
            document.getElementById('extend-session-btn').addEventListener('click', extendSession);
            document.getElementById('logout-now-btn').addEventListener('click', logoutNow);

            // Escape key closes modal and extends session
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    extendSession();
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);

            // Focus first button for accessibility
            document.getElementById('extend-session-btn').focus();
        }

        function extendSession() {
            // Make a request to keep session alive
            fetch('/docs/backup-system/', {
                credentials: 'include',
                method: 'GET'
            })
            .then(response => {
                if (response.ok) {
                    const modal = document.getElementById('session-warning-modal');
                    if (modal) modal.remove();
                    resetSessionTimers();

                    // Show success toast
                    showToast('‚úÖ Sitzung verl√§ngert', 'success');
                } else {
                    throw new Error('Session extend failed');
                }
            })
            .catch(err => {
                console.error('Session extend failed:', err);
                showToast('‚ö†Ô∏è Sitzung konnte nicht verl√§ngert werden', 'error');
                setTimeout(handleSessionTimeout, 5000);
            });
        }

        function logoutNow() {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/docs/backup-system/logout';

            // Add CSRF token
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
            if (csrfToken) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = '_token';
                input.value = csrfToken;
                form.appendChild(input);
            }

            document.body.appendChild(form);
            form.submit();
        }

        function handleSessionTimeout() {
            window.location.href = '/docs/backup-system/login?session_expired=1';
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#27ae60' : '#e74c3c'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Reset timer on user activity (debounced)
        const activityEvents = ['click', 'keypress', 'scroll', 'mousemove'];
        let debounceTimer;

        const debouncedResetTimer = () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(resetSessionTimers, 2000);
        };

        activityEvents.forEach(event => {
            document.addEventListener(event, debouncedResetTimer, { passive: true });
        });

        // ================================================================
        // Event Delegation (P0 FIX - 2025-11-02)
        // ================================================================
        // Replace inline event handlers with proper event delegation
        // Improves security (CSP compliance) and maintainability
        // ================================================================

        document.addEventListener('DOMContentLoaded', function() {
            // Accessibility bar buttons
            document.querySelectorAll('.accessibility-bar button').forEach(button => {
                const text = button.textContent.trim();
                button.removeAttribute('onclick');

                button.addEventListener('click', function() {
                    if (text === 'A') adjustFontSize('normal');
                    else if (text === 'A+') adjustFontSize('large');
                    else if (text === 'A++') adjustFontSize('xlarge');
                    else if (text === '‚óê') toggleHighContrast();
                });
            });

            // Mobile menu toggle
            const mobileToggle = document.querySelector('.mobile-menu-toggle');
            if (mobileToggle) {
                mobileToggle.removeAttribute('onclick');
                mobileToggle.addEventListener('click', toggleMobileMenu);
            }

            // Search clear button
            const searchClear = document.getElementById('searchClear');
            if (searchClear) {
                searchClear.removeAttribute('onclick');
                searchClear.addEventListener('click', clearSearch);
            }

            // Quick action buttons
            document.querySelectorAll('.quick-action-btn').forEach(button => {
                const text = button.textContent.trim();
                button.removeAttribute('onclick');

                button.addEventListener('click', function() {
                    if (text.includes('Alle erweitern')) expandAll();
                    else if (text.includes('Alle zuklappen')) collapseAll();
                    else if (text.includes('Druckansicht')) window.print();
                });
            });

            // Back to top button
            const backToTop = document.getElementById('backToTop');
            if (backToTop) {
                backToTop.removeAttribute('onclick');
                backToTop.addEventListener('click', scrollToTop);
            }

            // Event delegation for dynamically created elements
            document.addEventListener('click', function(e) {
                // Category headers (delegated for dynamic content)
                if (e.target.closest('.category-header')) {
                    const header = e.target.closest('.category-header');
                    const catId = header.getAttribute('data-category-id');
                    if (catId) {
                        header.removeAttribute('onclick');
                        toggleCategory(catId);
                    }
                }

                // Resolved incidents section header
                if (e.target.closest('.resolved-header')) {
                    const header = e.target.closest('.resolved-header');
                    header.removeAttribute('onclick');
                    toggleResolved();
                }

                // View buttons (dynamically created)
                if (e.target.classList.contains('btn-secondary') && e.target.textContent.includes('Ansehen')) {
                    e.preventDefault();
                    e.target.removeAttribute('onclick');
                    const href = e.target.getAttribute('data-href');
                    if (href) window.open(href, '_blank');
                }

                // Copy buttons (dynamically created)
                if (e.target.classList.contains('btn-copy')) {
                    e.target.removeAttribute('onclick');
                    const text = e.target.getAttribute('data-copy-text');
                    const message = e.target.getAttribute('data-copy-message') || 'Kopiert!';
                    if (text) copyText(text, e, message);
                }
            });

            // Remove inline hover styles and replace with CSS
            document.querySelectorAll('[onmouseover], [onmouseout]').forEach(el => {
                el.removeAttribute('onmouseover');
                el.removeAttribute('onmouseout');
            });
        });

        // Initialize session timers
        resetSessionTimers();
    </script>
</body>
</html>
